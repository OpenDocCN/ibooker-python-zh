<html><head></head><body>
<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 7. Adopting Typechecking Practically" class="preface"><div class="preface" id="adoption">
<h1 class="calibre10" id="calibre_pb_0"><span class="calibre">Chapter 7. </span>Adopting Typechecking Practically</h1>


<p class="author1">Many developers dream of the days when they’ll finally work in a completely <em class="calibre6">green-field</em> project. <a data-type="indexterm" data-primary="typechecking" data-secondary="adopting practically" id="ix_typckad" class="calibre5"/><a data-type="indexterm" data-primary="green-field projects" id="idm45644746122952" class="calibre5"/>A green-field project is one that is brand-new, where you have a blank slate with your code’s architecture, design, and modularity. However, most projects soon become <em class="calibre6">brown-field</em>, or legacy code.<a data-type="indexterm" data-primary="brown-field projects" id="idm45644746121576" class="calibre5"/><a data-type="indexterm" data-primary="legacy code" id="idm45644746120840" class="calibre5"/> These projects have been around the block a bit; much of the architecture and design has been solidified. Making big, sweeping changes will impact real users. The term <em class="calibre6">brown-field</em> is often seen as derogatory, especially when it feels like you are slogging through a big ball of mud.</p>

<p class="author1">However, not all brown-field projects are a punishment to work in. Michael Feathers, author of <em class="calibre6">Working Effectively With Legacy Code</em> (Pearson), has this to say:</p>
<blockquote class="pcalibre2 calibre28 pcalibre1">
<p class="calibre29">In a well-maintained system, it might take a while to figure out how to make a change, but once you do, the change is usually easy and you feel much more comfortable with the system. In a legacy system, it can take a long time to figure out what to do, and the change is difficult also.<sup class="calibre11"><a data-type="noteref" id="idm45644746117528-marker" href="part0010_split_007.html#idm45644746117528" class="calibre5">1</a></sup></p></blockquote>

<p class="author1">Feathers defines legacy code as “code without tests.” I prefer an alternate definition: legacy code is simply code where you can no longer discuss the code with the developers who wrote it. In lieu of that communication, you rely on the codebase itself to describe its behavior. If the codebase clearly communicates its intentions, it is a well-maintained system that is easy to work in. It may take a little bit of time to understand it all, but once you do, you are able to add features and evolve the system. However, if that codebase is difficult to understand, you will face an uphill battle. That code becomes unmaintainable. This is why robustness is paramount. Writing robust code eases the transition from green-field to brown-field by making the code more maintainable.</p>

<p class="author1">Most of the type annotation strategies that I’ve shown in the first part of this book are easier to adopt when a project is new. Adopting these practices in a mature project is more challenging. It is not impossible, but the cost may be higher. This is the heart of engineering: making smart decisions about trade-offs.</p>






</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 7. Adopting Typechecking Practically" class="preface">
<div class="preface" id="adoption">
<section data-type="sect1" data-pdf-bookmark="Trade-offs" class="preface"><div class="preface" id="idm45644746114184">
<h1 class="calibre12" id="calibre_pb_1">Trade-offs</h1>

<p class="author1">Every decision you make involves a trade-off.<a data-type="indexterm" data-primary="typechecking" data-secondary="adopting practically" data-tertiary="trade-offs" id="idm45644746112488" class="calibre5"/> Lots of developers focus on the classic time versus space trade-off in algorithms. But there are plenty of other trade-offs, often involving intangible qualities.<a data-type="indexterm" data-primary="typecheckers" data-secondary="trade-offs with use of" id="idm45644746110936" class="calibre5"/> I’ve already covered the benefits of a typechecker quite extensively throughout this first part of the book:</p>

<ul class="printings">
<li class="calibre9">
<p class="author1">A typechecker increases communication and reduces the chances of bugs.</p>
</li>
<li class="calibre9">
<p class="author1">A typechecker provides a safety net for making changes and increases the robustness of your codebase.</p>
</li>
<li class="calibre9">
<p class="author1">A typechecker allows you to deliver functionality faster.</p>
</li>
</ul>

<p class="author1">But what are the costs? Adopting type annotations is not free, and they only get worse the larger your codebase is.<a data-type="indexterm" data-primary="cost-benefit analysis for adopting typechecking" id="idm45644746106072" class="calibre5"/><a data-type="indexterm" data-primary="type annotations" data-secondary="adopting, costs of" id="idm45644746105272" class="calibre5"/> These costs include:</p>

<ul class="printings">
<li class="calibre9">
<p class="author1">The need for buy-in. Depending on culture, it might take some time convincing an organization to adopt typechecking.</p>
</li>
<li class="calibre9">
<p class="author1">Once you have buy-in, there is an initial cost of adoption. Developers don’t start type annotating their code overnight, and it takes time before they grok it. They need to learn it and experiment before they are on board.</p>
</li>
<li class="calibre9">
<p class="author1">It takes time and effort to adopt tooling. You need centralized checking of some fashion, and developers need to familiarize themselves with running the tooling as part of their workflows.</p>
</li>
<li class="calibre9">
<p class="author1">It will take time to write type annotations in your codebase.</p>
</li>
<li class="calibre9">
<p class="author1">As type annotations are checked, developers will have to get used to the slowdown in fighting the typechecker. There is additional cognitive overload in thinking about types.</p>
</li>
</ul>

<p class="author1">Developer time is expensive, and it is easy to focus on what else those developers could be doing. Adopting type annotations is not free.  Worse, with a large enough codebase, these costs can easily dwarf the initial benefit you get from typechecking. The problem is fundamentally a chicken-and-egg conundrum. You won’t see benefits for annotating types until you have written enough types in your codebase. However, it is tough to get buy-in for writing types when the benefit isn’t there early on. You can model your value as such:</p>
<ul class="stafflist">
<li class="calibre7"><p class="author1">Value = (Total Benefits) − (Total Costs)</p></li>
</ul>

<p class="author1">Your benefits and costs will follow a curve; they are not linear functions. I’ve outlined the basic shapes of the curves in <a data-type="xref" href="part0010_split_001.html#cost_benefit_curves" class="calibre5">Figure 7-1</a>.</p>

<figure class="calibre36"><div id="cost_benefit_curves" class="figure">
<img src="../images/00012.gif" alt="Cost and benefit curves over time" class="calibre40"/>
<h6 class="calibre37"><span class="calibre">Figure 7-1. </span>Cost and benefit curves over time</h6>
</div></figure>

<p class="author1">I’ve purposely left off the range, because the scale will change depending on the size of your codebase, but the shapes remain the same. Your costs will start out high, but get easier as adoption increases. Your benefits will start off low, but as you annotate your codebase, you will see more value. You won’t see a return on investment until these two curves meet. To maximize value, you need to reach that intersection as early as possible.</p>
</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 7. Adopting Typechecking Practically" class="preface">
<div class="preface" id="adoption">
<section data-type="sect1" data-pdf-bookmark="Breaking Even Earlier" class="preface"><div class="preface" id="idm45644746113592">
<h1 class="calibre12" id="calibre_pb_2">Breaking Even Earlier</h1>

<p class="author1">To maximize the benefits of type annotations, you need to either get value earlier or decrease your costs earlier.<a data-type="indexterm" data-primary="typechecking" data-secondary="adopting practically" data-tertiary="breaking even earlier" id="ix_typckadBE" class="calibre5"/><a data-type="indexterm" data-primary="typechecking" data-secondary="adopting practically" data-tertiary="breaking even earlier" id="idm45644746089160" class="calibre5"/> The intersection of these two curves is a break-even point; this is where the amount of effort that you’re expending is paid back by the value you are receiving. You want to reach this point as fast as sustainably possible so that your type annotations have a positive impact. Here are some strategies to do that.</p>








</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 7. Adopting Typechecking Practically" class="preface">
<div class="preface" id="adoption">
<section data-type="sect1" data-pdf-bookmark="Breaking Even Earlier" class="preface">
<div class="preface" id="idm45644746113592">
<section data-type="sect2" data-pdf-bookmark="Find Your Pain Points" class="preface"><div class="preface" id="idm45644746087352">
<h2 class="calibre34" id="calibre_pb_3">Find Your Pain Points</h2>

<p class="author1">One of the best ways to produce value is to reduce the pain you are currently experiencing.<a data-type="indexterm" data-primary="pain points, finding and reducing with typechecking" id="idm45644746085768" class="calibre5"/> Ask yourself: where do I currently lose time in my process? Where do I lose money? Take a look at your test failures and customer bugs. These error cases incur real costs; you should be doing root cause analysis. If you find that a common root cause can be fixed by type annotations, you have a solid case for type annotation adoption.<a data-type="indexterm" data-primary="type annotations" data-secondary="adoption of, bug classes to look for" id="idm45644746084488" class="calibre5"/> Here are specific bug classes you need to keep an eye out for:</p>

<ul class="printings">
<li class="calibre9">
<p class="author1">Any error surrounding <code class="calibre17">None</code><a data-type="indexterm" data-primary="errors" data-secondary="surrounding None" id="idm45644746081880" class="calibre5"/><a data-type="indexterm" data-primary="None values" data-secondary="errors surrounding" id="idm45644746080904" class="calibre5"/></p>
</li>
<li class="calibre9">
<p class="author1">Invalid attribute access, such as trying to access variables of functions on the wrong type<a data-type="indexterm" data-primary="invalid attribute access" id="idm45644746079016" class="calibre5"/></p>
</li>
<li class="calibre9">
<p class="author1">Errors surrounding type conversions such as integers versus strings, bytes versus strings, or lists versus tuples<a data-type="indexterm" data-primary="errors" data-secondary="surrounding type conversions" id="idm45644746077336" class="calibre5"/><a data-type="indexterm" data-primary="type conversions" data-secondary="errors from" id="idm45644746076344" class="calibre5"/></p>
</li>
</ul>

<p class="author1">Also, talk to the people who have to work in the codebase itself. Root out the areas that are a constant source of confusion. If developers have trouble with certain parts of the codebase today, it’s likely that future developers will struggle too.</p>

<p class="author1">Don’t forget to talk to those who are invested in your codebase but maybe don’t directly work in it, such as your tech support, product management, and QA. They often have a unique perspective on painful areas of the codebase that might not be apparent when looking through the code. Try to put these costs into concrete terms, such as time or money. This will be invaluable in evaluating where type annotations will be of benefit.</p>
</div></section>













</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 7. Adopting Typechecking Practically" class="preface">
<div class="preface" id="adoption">
<section data-type="sect1" data-pdf-bookmark="Breaking Even Earlier" class="preface">
<div class="preface" id="idm45644746113592">
<section data-type="sect2" data-pdf-bookmark="Target Code Strategically" class="preface"><div class="preface" id="idm45644746073496">
<h2 class="calibre34" id="calibre_pb_4">Target Code Strategically</h2>

<p class="author1">You may want to focus on trying to receive value earlier. Type annotations do not appear overnight in a large codebase.<a data-type="indexterm" data-primary="type annotations" data-secondary="targeting code strategically for" id="idm45644746071896" class="calibre5"/> Instead, you will need to identify specific and strategic areas of code to target for type annotations. The beauty of type annotations is that they are completely optional. By typechecking just these areas, you very quickly see benefits without a huge up-front investment. Here are some strategies that you might employ to selectively type annotate your code.</p>










<section data-type="sect3" data-pdf-bookmark="Type annotate new code only" class="preface"><div class="preface" id="idm45644746070264">
<h3 class="calibre44">Type annotate new code only</h3>

<p class="author1">Consider leaving your current unannotated code the way it is and annotate code based <a data-type="indexterm" data-primary="type annotations" data-secondary="targeting code strategically for" data-tertiary="annotating only new code" id="idm45644746069000" class="calibre5"/>on these two rules:</p>

<ul class="printings">
<li class="calibre9">
<p class="author1">Annotate any new code that you write.</p>
</li>
<li class="calibre9">
<p class="author1">Annotate any old code that you change.</p>
</li>
</ul>

<p class="author1">Throughout time, you’ll build out your type annotations in all code except code that hasn’t been changed in a long time. Code that hasn’t been changing is relatively stable, and is probably not read too often. Type annotating it is not likely to gain you much benefit.</p>
</div></section>













<section data-type="sect3" data-pdf-bookmark="Type annotate from the bottom up" class="preface"><div class="preface" id="idm45644746064264">
<h3 class="calibre44">Type annotate from the bottom up</h3>

<p class="author1">Your codebase may depend on common areas of code.<a data-type="indexterm" data-primary="type annotations" data-secondary="targeting code strategically for" data-tertiary="annotating from bottom up" id="idm45644746062920" class="calibre5"/> These are your core libraries and utilities that serve as a foundation upon which everything else is built. Type annotating these parts of your codebase makes your benefit less about depth and more about breadth. Because so many other pieces sit atop this foundation, they will all reap the benefits of typechecking. New code will quite often depend on these utilities as well, so your new code will have an extra layer of protection.</p>
</div></section>













<section data-type="sect3" data-pdf-bookmark="Type annotate your moneymakers" class="preface"><div class="preface" id="idm45644746060760">
<h3 class="calibre44">Type annotate your moneymakers</h3>

<p class="author1">In some codebases, there is a clear separation between the core business logic and all the rest of the code that supports your business logic.<a data-type="indexterm" data-primary="type annotations" data-secondary="targeting code strategically for" data-tertiary="annotating your money makers" id="idm45644746059336" class="calibre5"/><a data-type="indexterm" data-primary="business logic" id="idm45644746058008" class="calibre5"/> Your <em class="calibre6">business logic</em> is the area of your system that is most responsible for delivering value. It might be the core reservation system for a travel agency, an ordering system in a restaurant, or a recommendation system for media services. All of the rest of the code (such as logging, messaging, database drivers, and user interface) exists to support your business logic. By type annotating your business logic, you are protecting a core part of your codebase. This code is often long-lived, making it an easy win for long-lasting value.</p>
</div></section>













<section data-type="sect3" data-pdf-bookmark="Type annotate the churners" class="preface"><div class="preface" id="idm45644746056008">
<h3 class="calibre44">Type annotate the churners</h3>

<p class="author1">Some parts of your codebase change way more often than the others.<a data-type="indexterm" data-primary="type annotations" data-secondary="targeting code strategically for" data-tertiary="annotating the churners" id="idm45644746054712" class="calibre5"/><a data-type="indexterm" data-primary="churners, type annotating" id="idm45644746053320" class="calibre5"/> Every time a piece of code changes, you run the risk of an incorrect assumption introducing a bug. The whole point of robust code is to lessen the chance of introducing errors, so what better place to protect than the code that changes the most often? Look for your code that has many different commits in version control, or analyze which files have the most lines of code changed over a time period. Also take a look at which files have the most committers; this is a great indication that this is an area where you can shore up type annotations for communication purposes.</p>
</div></section>













<section data-type="sect3" data-pdf-bookmark="Type annotate the complex" class="preface"><div class="preface" id="idm45644746051656">
<h3 class="calibre44">Type annotate the complex</h3>

<p class="author1">If you<a data-type="indexterm" data-primary="type annotations" data-secondary="targeting code strategically for" data-tertiary="annotating the complex" id="idm45644746050392" class="calibre5"/><a data-type="indexterm" data-primary="complexity" data-secondary="type annotating complex code" id="idm45644746049048" class="calibre5"/> come across some complex code, it will take some time to understand. After understanding that code, the best thing you can do is reduce the complexity for the next developer who reads the code. Refactoring the code, improving naming, and adding comments are all fantastic ways to improve comprehension, but consider also adding more type annotations. Type annotations will help developers understand what types are used, how to call functions, and how to deal with return values. Type annotations provide additional documentation for complex code.</p>
</div></section>



</div></section>













</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 7. Adopting Typechecking Practically" class="preface">
<div class="preface" id="adoption">
<section data-type="sect1" data-pdf-bookmark="Breaking Even Earlier" class="preface">
<div class="preface" id="idm45644746113592">
<section data-type="sect2" data-pdf-bookmark="Target Code Strategically" class="preface">
<div class="preface" id="idm45644746073496">
<section data-type="sect3" data-pdf-bookmark="Type annotate the complex" class="preface">
<div class="preface" id="idm45644746051656">
<div data-type="note" epub:type="note" class="calibre21"><h1 class="calibre38" id="calibre_pb_5">Discussion Topic</h1>
<p class="author1">Which of these strategies would benefit your codebase the most? Why does that strategy work best for you? What would the cost be to implement that strategy?</p>
</div>
</div></section>



</div></section>













</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 7. Adopting Typechecking Practically" class="preface">
<div class="preface" id="adoption">
<section data-type="sect1" data-pdf-bookmark="Breaking Even Earlier" class="preface">
<div class="preface" id="idm45644746113592">
<section data-type="sect2" data-pdf-bookmark="Lean on Your Tooling" class="preface"><div class="preface" id="idm45644746045576">
<h2 class="calibre34" id="calibre_pb_6">Lean on Your Tooling</h2>

<p class="author1">There are things that computers do well, and there are things that humans do well.<a data-type="indexterm" data-primary="type annotations" data-secondary="leaning on your tooling for" id="idm45644746043912" class="calibre5"/> This section is about the former. When trying to adopt type annotations, there are some fantastic things that automated tooling can assist with. First, let’s talk about the most common typechecker out there: mypy.</p>

<p class="author1">I’ve covered the configuration of mypy quite extensively in <a data-type="xref" href="part0009_split_000.html#typechecker" class="calibre5">Chapter 6</a>, but there are a few more options I’d like to delve into that will help you adopt typechecking.<a data-type="indexterm" data-primary="mypy typechecker" data-secondary="options to help in adopting typechecking" id="idm45644746041192" class="calibre5"/> One of the biggest problems you will run into is the sheer number of errors that mypy will report the first time you run it on a larger codebase.<a data-type="indexterm" data-primary="errors" data-secondary="mypy reporting of, configuring" id="idm45644746039864" class="calibre5"/> The biggest mistake you can make in this situation is to keep the hundreds (or thousands) of errors turned on and hope that developers whittle away at the errors over time.</p>

<p class="author1">These errors will not get fixed in any quick fashion. If these errors are always turned on, you will not see the benefits of a typechecker, because it will be nearly impossible to detect new errors. Any new issue will simply be lost in the noise of the multitude of other issues.</p>

<p class="author1">With mypy, you can tell the typechecker to ignore certain classes of errors or modules through configuration. Here’s a sample mypy file, which globally warns if <code class="calibre17">Any</code> types are returned, and sets config options on a per-module basis:</p>
<pre class="calibre35"># Global options:

[mypy]
python_version = 3.9
warn_return_any = True

# Per-module options:

[mypy-mycode.foo.*]
disallow_untyped_defs = True

[mypy-mycode.bar]
warn_return_any = False

[mypy-somelibrary]
ignore_missing_imports = True</pre>

<p class="author1">Using this format, you can pick and choose which errors your typechecker tracks. You can mask all of your existing errors, while focusing on fixing new errors. Be as specific as possible in defining which errors get ignored; you don’t want to mask new errors that show up in unrelated parts of the code.</p>

<p class="author1">To be even more specific, mypy will<a data-type="indexterm" data-primary="# type : ignore comments" data-primary-sortas="type : ignore" id="idm45644746035000" class="calibre5"/> ignore any line commented with <code class="calibre17"># type: ignore</code>.</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="c"># typechecks just fine</code>
<code class="n">a</code><code class="calibre17">:</code> <code class="nb">int</code> <code class="calibre17">=</code> <code class="s">"not an int"</code> <code class="c"># type: ignore</code></pre>
<div data-type="warning" epub:type="warning" class="calibre23"><h6 class="calibre24">Warning</h6>
<p class="author1"><code class="calibre17"># type: ignore</code> should not be an excuse to be lazy! When writing new code, don’t ignore type errors—fix them as you go.</p>
</div>

<p class="author1">Your first goal for adopting type annotations is to get a completely clean run of your typechecker. If there are errors, you either need to fix them with annotations (recommended) or accept that not all errors can be fixed soon and ignore them.</p>

<p class="author1">Over time, make sure the number of ignored sections of code decreases. You can track the number of lines containing <code class="calibre17"># type : ignore</code> or the number of configuration file sections that you are using; no matter what, strive to ignore as few sections as you can (within reasonable limits, of course—there is a law of diminishing returns).</p>

<p class="author1">I also recommend turning the <code class="calibre17">warn_unused_ignores</code> flag on in your mypy configuration, which will warn when an ignore directive is no longer required.</p>

<p class="author1">Now, none of this helps you get any closer to actually annotating your codebase; it just gives you a starting point. To help annotate your codebase with tooling, you will need something that can automatically insert annotations.</p>










<section data-type="sect3" data-pdf-bookmark="MonkeyType" class="preface"><div class="preface" id="idm45644746025704">
<h3 class="calibre44">MonkeyType</h3>

<p class="author1"><a href="https://github.com/Instagram/MonkeyType" class="calibre5">MonkeyType</a> is a tool that will automatically annotate your Python code.<a data-type="indexterm" data-primary="type annotations" data-secondary="adding with MonkeyType" id="ix_typanMT" class="calibre5"/><a data-type="indexterm" data-primary="MonkeyType" id="ix_MonTyp" class="calibre5"/> This is a great way to typecheck a large amount of code without a lot of effort.</p>

<p class="author1">First install MonkeyType with <code class="calibre17">pip</code>:</p>
<pre class="calibre35">pip install monkeytype</pre>

<p class="author1">Suppose your codebase controls an automatic chef with robotic arms that is capable of cooking perfect food every time. You want to program the chef with my family’s favorite recipe, Pasta with Italian Sausage:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="c"># Pasta with Sausage Automated Maker  </code><a class="calibre5" id="co_adopting_typechecking_practically_CO1-1" href="part0010_split_006.html#callout_adopting_typechecking_practically_CO1-1"><img src="../images/00002.gif" alt="1" class="calibre40"/></a><code class="calibre17">
</code><code class="n">italian_sausage</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="n">Ingredient</code><code class="calibre17">(</code><code class="s">'</code><code class="s">Italian Sausage</code><code class="s">'</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="mi">4</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="s">'</code><code class="s">links</code><code class="s">'</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="n">olive_oil</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="n">Ingredient</code><code class="calibre17">(</code><code class="s">'</code><code class="s">Olive Oil</code><code class="s">'</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="mi">1</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="s">'</code><code class="s">tablespoon</code><code class="s">'</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="n">plum_tomato</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="n">Ingredient</code><code class="calibre17">(</code><code class="s">'</code><code class="s">Plum Tomato</code><code class="s">'</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="mi">6</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="s">'</code><code class="s">'</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="n">garlic</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="n">Ingredient</code><code class="calibre17">(</code><code class="s">'</code><code class="s">Garlic</code><code class="s">'</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="mi">4</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="s">'</code><code class="s">cloves</code><code class="s">'</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="n">black_pepper</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="n">Ingredient</code><code class="calibre17">(</code><code class="s">'</code><code class="s">Black Pepper</code><code class="s">'</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="mi">2</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="s">'</code><code class="s">teaspoons</code><code class="s">'</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="n">basil</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="n">Ingredient</code><code class="calibre17">(</code><code class="s">'</code><code class="s">Basil Leaves</code><code class="s">'</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="mi">1</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="s">'</code><code class="s">cup</code><code class="s">'</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="n">pasta</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="n">Ingredient</code><code class="calibre17">(</code><code class="s">'</code><code class="s">Rigatoni</code><code class="s">'</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="mi">1</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="s">'</code><code class="s">pound</code><code class="s">'</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="n">salt</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="n">Ingredient</code><code class="calibre17">(</code><code class="s">'</code><code class="s">Salt</code><code class="s">'</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="mi">1</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="s">'</code><code class="s">tablespoon</code><code class="s">'</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="n">water</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="n">Ingredient</code><code class="calibre17">(</code><code class="s">'</code><code class="s">Water</code><code class="s">'</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="mi">6</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="s">'</code><code class="s">quarts</code><code class="s">'</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="n">cheese</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="n">Ingredient</code><code class="calibre17">(</code><code class="s">'</code><code class="s">Pecorino Romano</code><code class="s">'</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="mi">2</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="s">"</code><code class="s">ounces</code><code class="s">"</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="n">pasta_with_sausage</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="n">Recipe</code><code class="calibre17">(</code><code class="mi">6</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="calibre17">[</code><code class="n">italian_sausage</code><code class="calibre17">,</code><code class="calibre17">
</code><code class="calibre17">                                </code><code class="n">olive_oil</code><code class="calibre17">,</code><code class="calibre17">
</code><code class="calibre17">                                </code><code class="n">plum_tomato</code><code class="calibre17">,</code><code class="calibre17">
</code><code class="calibre17">                                </code><code class="n">garlic</code><code class="calibre17">,</code><code class="calibre17">
</code><code class="calibre17">                                </code><code class="n">black_pepper</code><code class="calibre17">,</code><code class="calibre17">
</code><code class="calibre17">                                </code><code class="n">pasta</code><code class="calibre17">,</code><code class="calibre17">
</code><code class="calibre17">                                </code><code class="n">salt</code><code class="calibre17">,</code><code class="calibre17">
</code><code class="calibre17">                                </code><code class="n">water</code><code class="calibre17">,</code><code class="calibre17">
</code><code class="calibre17">                                </code><code class="n">cheese</code><code class="calibre17">,</code><code class="calibre17">
</code><code class="calibre17">                                </code><code class="n">basil</code><code class="calibre17">]</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">
</code><code class="k">def</code><code class="calibre17"> </code><code class="nf">make_pasta_with_sausage</code><code class="calibre17">(</code><code class="n">servings</code><code class="calibre17">)</code><code class="calibre17">:</code><code class="calibre17"> </code><a class="calibre5" id="co_adopting_typechecking_practically_CO1-2" href="part0010_split_006.html#callout_adopting_typechecking_practically_CO1-2"><img src="../images/00005.gif" alt="2" class="calibre40"/></a><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">saut</code><code class="err">é</code><code class="n">_pan</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="n">Receptacle</code><code class="calibre17">(</code><code class="s">'</code><code class="s">Sauté Pan</code><code class="s">'</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">pasta_pot</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="n">Receptacle</code><code class="calibre17">(</code><code class="s">'</code><code class="s">Stock Pot</code><code class="s">'</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">adjusted_recipe</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="n">adjust_recipe</code><code class="calibre17">(</code><code class="n">pasta_with_sausage</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="n">servings</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="k">print</code><code class="calibre17">(</code><code class="s">"</code><code class="s">Prepping ingredients</code><code class="s">"</code><code class="calibre17">)</code><code class="calibre17"> </code><a class="calibre5" id="co_adopting_typechecking_practically_CO1-3" href="part0010_split_006.html#callout_adopting_typechecking_practically_CO1-3"><img src="../images/00006.gif" alt="3" class="calibre40"/></a><code class="calibre17">
</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">adjusted_tomatoes</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="n">adjusted_recipe</code><code class="calibre17">.</code><code class="n">get_ingredient</code><code class="calibre17">(</code><code class="s">'</code><code class="s">Plum Tomato</code><code class="s">'</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">adjusted_garlic</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="n">adjusted_recipe</code><code class="calibre17">.</code><code class="n">get_ingredient</code><code class="calibre17">(</code><code class="s">'</code><code class="s">Garlic</code><code class="s">'</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">adjusted_cheese</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="n">adjusted_recipe</code><code class="calibre17">.</code><code class="n">get_ingredient</code><code class="calibre17">(</code><code class="s">'</code><code class="s">Pecorino Romano</code><code class="s">'</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">adjusted_basil</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="n">adjusted_recipe</code><code class="calibre17">.</code><code class="n">get_ingredient</code><code class="calibre17">(</code><code class="s">'</code><code class="s">Basil Leaves</code><code class="s">'</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">garlic_and_tomatoes</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="n">recipe_maker</code><code class="calibre17">.</code><code class="n">dice</code><code class="calibre17">(</code><code class="n">adjusted_tomatoes</code><code class="calibre17">,</code><code class="calibre17">
</code><code class="calibre17">                                            </code><code class="n">adjusted_garlic</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">grated_cheese</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="n">recipe_maker</code><code class="calibre17">.</code><code class="n">grate</code><code class="calibre17">(</code><code class="n">adjusted_cheese</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">sliced_basil</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="n">recipe_maker</code><code class="calibre17">.</code><code class="n">chiffonade</code><code class="calibre17">(</code><code class="n">adjusted_basil</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="k">print</code><code class="calibre17">(</code><code class="s">"</code><code class="s">Cooking Pasta</code><code class="s">"</code><code class="calibre17">)</code><code class="calibre17"> </code><a class="calibre5" id="co_adopting_typechecking_practically_CO1-4" href="part0010_split_006.html#callout_adopting_typechecking_practically_CO1-4"><img src="../images/00007.gif" alt="4" class="calibre40"/></a><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">pasta_pot</code><code class="calibre17">.</code><code class="n">add</code><code class="calibre17">(</code><code class="n">adjusted_recipe</code><code class="calibre17">.</code><code class="n">get_ingredient</code><code class="calibre17">(</code><code class="s">'</code><code class="s">Water</code><code class="s">'</code><code class="calibre17">)</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">pasta_pot</code><code class="calibre17">.</code><code class="n">add</code><code class="calibre17">(</code><code class="n">adjusted_recipe</code><code class="calibre17">.</code><code class="n">get_ingredient</code><code class="calibre17">(</code><code class="s">'</code><code class="s">Salt</code><code class="s">'</code><code class="calibre17">)</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">recipe_maker</code><code class="calibre17">.</code><code class="n">put_receptacle_on_stovetop</code><code class="calibre17">(</code><code class="n">pasta_pot</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="n">heat_level</code><code class="calibre17">=</code><code class="mi">10</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">pasta_pot</code><code class="calibre17">.</code><code class="n">add</code><code class="calibre17">(</code><code class="n">adjusted_recipe</code><code class="calibre17">.</code><code class="n">get_ingredient</code><code class="calibre17">(</code><code class="s">'</code><code class="s">Rigatoni</code><code class="s">'</code><code class="calibre17">)</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">recipe_maker</code><code class="calibre17">.</code><code class="n">set_stir_mode</code><code class="calibre17">(</code><code class="n">pasta_pot</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="calibre17">(</code><code class="s">'</code><code class="s">every minute</code><code class="s">'</code><code class="calibre17">)</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="k">print</code><code class="calibre17">(</code><code class="s">"</code><code class="s">Cooking Sausage</code><code class="s">"</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">saut</code><code class="err">é</code><code class="n">_pan</code><code class="calibre17">.</code><code class="n">add</code><code class="calibre17">(</code><code class="n">adjusted_recipe</code><code class="calibre17">.</code><code class="n">get_ingredient</code><code class="calibre17">(</code><code class="s">'</code><code class="s">Olive Oil</code><code class="s">'</code><code class="calibre17">)</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">heat_level</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="n">recipe_maker</code><code class="calibre17">.</code><code class="n">HeatLevel</code><code class="calibre17">.</code><code class="n">MEDIUM</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">recipe_maker</code><code class="calibre17">.</code><code class="n">put_receptacle_on_stovetop</code><code class="calibre17">(</code><code class="n">saut</code><code class="err">é</code><code class="n">_pan</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="n">heat_level</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">saut</code><code class="err">é</code><code class="n">_pan</code><code class="calibre17">.</code><code class="n">add</code><code class="calibre17">(</code><code class="n">adjusted_recipe</code><code class="calibre17">.</code><code class="n">get_ingredient</code><code class="calibre17">(</code><code class="s">'</code><code class="s">Italian Sausage</code><code class="s">'</code><code class="calibre17">)</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">recipe_maker</code><code class="calibre17">.</code><code class="n">brown_on_all_sides</code><code class="calibre17">(</code><code class="s">'</code><code class="s">Italian Sausage</code><code class="s">'</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">cooked_sausage</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="n">saut</code><code class="err">é</code><code class="n">_pan</code><code class="calibre17">.</code><code class="n">remove_ingredients</code><code class="calibre17">(</code><code class="n">to_ignore</code><code class="calibre17">=</code><code class="calibre17">[</code><code class="s">'</code><code class="s">Olive Oil</code><code class="s">'</code><code class="calibre17">]</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">sliced_sausage</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="n">recipe_maker</code><code class="calibre17">.</code><code class="n">slice</code><code class="calibre17">(</code><code class="n">cooked_sausage</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="n">thickness_in_inches</code><code class="calibre17">=</code><code class="calibre17">.</code><code class="mi">25</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="k">print</code><code class="calibre17">(</code><code class="s">"</code><code class="s">Making Sauce</code><code class="s">"</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">saut</code><code class="err">é</code><code class="n">_pan</code><code class="calibre17">.</code><code class="n">add</code><code class="calibre17">(</code><code class="n">garlic_and_tomatoes</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">recipe_maker</code><code class="calibre17">.</code><code class="n">set_stir_mode</code><code class="calibre17">(</code><code class="n">saut</code><code class="err">é</code><code class="n">_pan</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="calibre17">(</code><code class="s">'</code><code class="s">every minute</code><code class="s">'</code><code class="calibre17">)</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="k">while</code><code class="calibre17"> </code><code class="n">recipe_maker</code><code class="calibre17">.</code><code class="n">is_not_cooked</code><code class="calibre17">(</code><code class="s">'</code><code class="s">Rigatoni</code><code class="s">'</code><code class="calibre17">)</code><code class="calibre17">:</code><code class="calibre17">
</code><code class="calibre17">        </code><code class="n">time</code><code class="calibre17">.</code><code class="n">sleep</code><code class="calibre17">(</code><code class="mi">30</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">cooked_pasta</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="n">pasta_pot</code><code class="calibre17">.</code><code class="n">remove_ingredients</code><code class="calibre17">(</code><code class="n">to_ignore</code><code class="calibre17">=</code><code class="calibre17">[</code><code class="s">'</code><code class="s">Water</code><code class="s">'</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="s">'</code><code class="s">Salt</code><code class="s">'</code><code class="calibre17">]</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">saut</code><code class="err">é</code><code class="n">_pan</code><code class="calibre17">.</code><code class="n">add</code><code class="calibre17">(</code><code class="n">sliced_sausage</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="k">while</code><code class="calibre17"> </code><code class="n">recipe_maker</code><code class="calibre17">.</code><code class="n">is_not_cooked</code><code class="calibre17">(</code><code class="s">'</code><code class="s">Italian Sausage</code><code class="s">'</code><code class="calibre17">)</code><code class="calibre17">:</code><code class="calibre17">
</code><code class="calibre17">        </code><code class="n">time</code><code class="calibre17">.</code><code class="n">sleep</code><code class="calibre17">(</code><code class="mi">30</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="k">print</code><code class="calibre17">(</code><code class="s">"</code><code class="s">Mixing ingredients together</code><code class="s">"</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">saut</code><code class="err">é</code><code class="n">_pan</code><code class="calibre17">.</code><code class="n">add</code><code class="calibre17">(</code><code class="n">sliced_basil</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">saut</code><code class="err">é</code><code class="n">_pan</code><code class="calibre17">.</code><code class="n">add</code><code class="calibre17">(</code><code class="n">cooked_pasta</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">recipe_maker</code><code class="calibre17">.</code><code class="n">set_stir_mode</code><code class="calibre17">(</code><code class="n">saut</code><code class="err">é</code><code class="n">_pan</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="s">"</code><code class="s">once</code><code class="s">"</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="k">print</code><code class="calibre17">(</code><code class="s">"</code><code class="s">Serving</code><code class="s">"</code><code class="calibre17">)</code><code class="calibre17"> </code><a class="calibre5" id="co_adopting_typechecking_practically_CO1-5" href="part0010_split_006.html#callout_adopting_typechecking_practically_CO1-5"><img src="../images/00008.gif" alt="5" class="calibre40"/></a><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">dishes</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="n">recipe_maker</code><code class="calibre17">.</code><code class="n">divide</code><code class="calibre17">(</code><code class="n">saut</code><code class="err">é</code><code class="n">_pan</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="n">servings</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">recipe_maker</code><code class="calibre17">.</code><code class="n">garnish</code><code class="calibre17">(</code><code class="n">dishes</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="n">grated_cheese</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="k">return</code><code class="calibre17"> </code><code class="n">dishes</code></pre>
<dl class="calibre13">
<dt class="calibre14"><a class="calibre5" id="callout_adopting_typechecking_practically_CO1-1" href="part0010_split_006.html#co_adopting_typechecking_practically_CO1-1"><img src="../images/00002.gif" alt="1" class="calibre40"/></a></dt>
<dd class="calibre41"><p class="calibre42">Definition of all ingredients</p></dd>
<dt class="calibre14"><a class="calibre5" id="callout_adopting_typechecking_practically_CO1-2" href="part0010_split_006.html#co_adopting_typechecking_practically_CO1-2"><img src="../images/00005.gif" alt="2" class="calibre40"/></a></dt>
<dd class="calibre41"><p class="calibre42">Function to make pasta with sausage</p></dd>
<dt class="calibre14"><a class="calibre5" id="callout_adopting_typechecking_practically_CO1-3" href="part0010_split_006.html#co_adopting_typechecking_practically_CO1-3"><img src="../images/00006.gif" alt="3" class="calibre40"/></a></dt>
<dd class="calibre41"><p class="calibre42">Prepping instructions</p></dd>
<dt class="calibre14"><a class="calibre5" id="callout_adopting_typechecking_practically_CO1-4" href="part0010_split_006.html#co_adopting_typechecking_practically_CO1-4"><img src="../images/00007.gif" alt="4" class="calibre40"/></a></dt>
<dd class="calibre41"><p class="calibre42">Cooking instructions</p></dd>
<dt class="calibre14"><a class="calibre5" id="callout_adopting_typechecking_practically_CO1-5" href="part0010_split_006.html#co_adopting_typechecking_practically_CO1-5"><img src="../images/00008.gif" alt="5" class="calibre40"/></a></dt>
<dd class="calibre41"><p class="calibre42">Serving instructions</p></dd>
</dl>

<p class="author1">I’ve left out a lot of the helper functions to save space, but this gives you an idea of what I’m trying to achieve. You can see the full example in the <a href="https://github.com/pviafore/RobustPython" class="calibre5">GitHub repo</a> that accompanies this book.<a data-type="indexterm" data-primary="GitHub repo for this book" id="idm45644745830648" class="calibre5"/></p>

<p class="author1">Throughout the entire example, I have zero type annotations. I don’t want to write all the type annotations by hand, so I’ll use MonkeyType. To help, I can generate <em class="calibre6">stub files</em> to create type annotations.<a data-type="indexterm" data-primary="stub files" id="idm45644743939128" class="calibre5"/> Stub files are files that just contain function <span class="calibre">signatures</span>.<a data-type="indexterm" data-primary="function signatures in stub files" id="idm45644743937640" class="calibre5"/></p>

<p class="author1">In order to generate the stub files, you have to run your code. This is an important detail; MonkeyType will only annotate code that you run first. You can run specific scripts like so:</p>
<pre class="calibre35">monkeytype run code_examples/chapter7/main.py</pre>

<p class="author1">This will generate a <code class="calibre17">SQLite</code> database that stores all the function calls made throughout the execution of that program. You should try to run as many parts of your system as you can in order to populate this database. Unit tests, integration tests, and test programs all contribute to populating the database.</p>
<div data-type="tip" class="calibre21"><h6 class="calibre22">Tip</h6>
<p class="author1">Because MonkeyType works by instrumenting your code using <code class="calibre17">sys.setprofile</code>, other instrumentation such as code coverage and profiling will not work at the same time. Any tool that uses instrumentation will need to be run separately.</p>
</div>

<p class="author1">Once you have run through as many paths of your code as you want, you can generate the stub files:</p>
<pre class="calibre35">monkeytype stub code_examples.chapter7.pasta_with_sausage</pre>

<p class="author1">This will output the stub file for this specific module:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="k">def</code> <code class="nf">adjust_recipe</code><code class="calibre17">(</code>
    <code class="n">recipe</code><code class="calibre17">:</code> <code class="n">Recipe</code><code class="calibre17">,</code>
    <code class="n">servings</code><code class="calibre17">:</code> <code class="nb">int</code>
<code class="calibre17">)</code> <code class="calibre17">-&gt;</code> <code class="n">Recipe</code><code class="calibre17">:</code> <code class="calibre17">...</code>


<code class="k">class</code> <code class="nc">Receptacle</code><code class="calibre17">:</code>
    <code class="k">def</code> <code class="calibre17">__init__</code><code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">,</code> <code class="n">name</code><code class="calibre17">:</code> <code class="nb">str</code><code class="calibre17">)</code> <code class="calibre17">-&gt;</code> <code class="nb">None</code><code class="calibre17">:</code> <code class="calibre17">...</code>
    <code class="k">def</code> <code class="nf">add</code><code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">,</code> <code class="n">ingredient</code><code class="calibre17">:</code> <code class="n">Ingredient</code><code class="calibre17">)</code> <code class="calibre17">-&gt;</code> <code class="nb">None</code><code class="calibre17">:</code> <code class="calibre17">...</code>


<code class="k">class</code> <code class="nc">Recipe</code><code class="calibre17">:</code>
    <code class="k">def</code> <code class="nf">clear_ingredients</code><code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">)</code> <code class="calibre17">-&gt;</code> <code class="nb">None</code><code class="calibre17">:</code> <code class="calibre17">...</code>
    <code class="k">def</code> <code class="nf">get_ingredient</code><code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">,</code> <code class="n">name</code><code class="calibre17">:</code> <code class="nb">str</code><code class="calibre17">)</code> <code class="calibre17">-&gt;</code> <code class="n">Ingredient</code><code class="calibre17">:</code> <code class="calibre17">...</code></pre>

<p class="author1">It won’t annotate everything, but it will certainly give you more than enough of a head start in your codebase. Once you are comfortable with the suggestions, you can apply them with <code class="calibre17">monkeytype apply &lt;module-name&gt;</code>. Once these annotations have been generated, search through the codebase for any use of <code class="calibre17">Union</code>. A <code class="calibre17">Union</code> tells you that more than one type has been passed to that function as part of the execution of your code.<a data-type="indexterm" data-primary="Union types" data-secondary="in function signatures" id="idm45644743907992" class="calibre5"/><a data-type="indexterm" data-primary="code smell" id="idm45644743905256" class="calibre5"/> This is a <em class="calibre6">code smell</em>, or something that looks a little funny, even if it’s not totally wrong (yet). In this case, the use of a <code class="calibre17">Union</code> may indicate unmaintainable code; your code is receiving different types and might not be equipped to handle them. If wrong types are passed as a parameter, that’s a likely sign that assumptions have been invalidated somewhere along the way.</p>

<p class="author1">To illustrate, the stubs for my <code class="calibre17">recipe_maker</code> contain a <code class="calibre17">Union</code> in one of my function signatures:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="k">def</code> <code class="nf">put_receptacle_on_stovetop</code><code class="calibre17">(</code>
    <code class="n">receptacle</code><code class="calibre17">:</code> <code class="n">Receptacle</code><code class="calibre17">,</code>
    <code class="n">heat_level</code><code class="calibre17">:</code> <code class="n">Union</code><code class="calibre17">[</code><code class="n">HeatLevel</code><code class="calibre17">,</code> <code class="nb">int</code><code class="calibre17">]</code>
<code class="calibre17">)</code> <code class="calibre17">-&gt;</code> <code class="nb">None</code><code class="calibre17">:</code> <code class="calibre17">...</code></pre>

<p class="author1">The parameter <code class="calibre17">heat_level</code> has taken a <code class="calibre17">HeatLevel</code> in some cases and an integer in other cases. Looking back at my recipe, I see the following lines of code:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="n">recipe_maker</code><code class="calibre17">.</code><code class="n">put_receptacle_on_stovetop</code><code class="calibre17">(</code><code class="n">pasta_pot</code><code class="calibre17">,</code> <code class="n">heat_level</code><code class="calibre17">=</code><code class="mi">10</code><code class="calibre17">)</code>
<code class="c"># ...</code>
<code class="n">heat_level</code> <code class="calibre17">=</code> <code class="n">recipe_maker</code><code class="calibre17">.</code><code class="n">HeatLevel</code><code class="calibre17">.</code><code class="n">MEDIUM</code>
<code class="n">recipe_maker</code><code class="calibre17">.</code><code class="n">put_receptacle_on_stovetop</code><code class="calibre17">(</code><code class="n">saut</code><code class="err">é</code><code class="n">_pan</code><code class="calibre17">,</code> <code class="n">heat_level</code><code class="calibre17">)</code></pre>

<p class="author1">Whether this is an error or not depends on the implementation of the function. In my case, I want to be consistent, so I would change the integer usage to <code class="calibre17">Enum</code> usage. For your codebase, you will need to determine what is acceptable and what is not.<a data-type="indexterm" data-primary="type annotations" data-secondary="adding with MonkeyType" data-startref="ix_typanMT" id="idm45644744619048" class="calibre5"/><a data-type="indexterm" data-primary="MonkeyType" data-startref="ix_MonTyp" id="idm45644744617928" class="calibre5"/></p>
</div></section>













<section data-type="sect3" data-pdf-bookmark="Pytype" class="preface"><div class="preface" id="idm45644746024760">
<h3 class="calibre44">Pytype</h3>

<p class="author1">One of the problems with MonkeyType is that it only annotates code it sees at runtime.<a data-type="indexterm" data-primary="Pytype" id="idm45644744615624" class="calibre5"/><a data-type="indexterm" data-primary="type annotations" data-secondary="adding with Pytype" id="idm45644744614920" class="calibre5"/> If there are branches of your code that are costly or unable to be run, MonkeyType will not help you that much. Fortunately, a tool exists to fill in this gap: <a href="https://github.com/google/pytype" class="calibre5">Pytype</a>, written by Google. Pytype adds type annotations through static analysis, which means it does not need to run your code to figure out types.</p>

<p class="author1">To run Pytype, install it with <code class="calibre17">pip</code>:</p>

<pre data-type="programlisting" class="calibre35">pip install pytype</pre>

<p class="author1">Then, run Pytype against your code folder (e.g., <em class="calibre6">code_examples/chapter7</em>):</p>

<pre data-type="programlisting" class="calibre35">pytype code_examples/chapter7</pre>

<p class="author1">This will generate a set of <em class="calibre6">.pyi</em> files in a <em class="calibre6">.pytype</em> folder. These are very similar to the stub files that MonkeyType created. They contain annotated function signatures and variables that you can then copy into your source files.</p>

<p class="author1">Pytype offers other intriguing benefits as well. Pytype is not just a type annotator; it is a full linter and typechecker. It has a different typechecking philosophy than other typecheckers such as mypy, Pyright, and Pyre.</p>

<p class="author1">Pytype will use inference to do its typechecking, which means it will typecheck your code even in the absence of type annotations. This is a great way to get the benefit of a typechecker without having to write types throughout your codebase.</p>

<p class="author1">Pytype is also a little more lenient on types changing in the middle of their lifetime. This is a boon for those who fully embrace Python’s dynamically typed nature. As long as code will work at runtime, Pytype is happy. For instance:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35">    <code class="c"># Run in Python 3.6</code>
    <code class="k">def</code> <code class="nf">get_pasta_dish_ingredients</code><code class="calibre17">(</code><code class="n">ingredients</code><code class="calibre17">:</code> <code class="nb">list</code><code class="calibre17">[</code><code class="n">Ingredient</code><code class="calibre17">]</code>
                                   <code class="calibre17">)</code> <code class="calibre17">-&gt;</code> <code class="nb">list</code><code class="calibre17">[</code><code class="nb">str</code><code class="calibre17">]:</code>
    <code class="n">names</code> <code class="calibre17">=</code> <code class="n">ingredients</code>
    <code class="c"># make sure there is water to boil the pasta in</code>
    <code class="k">if</code> <code class="n">does_not_contain_water</code><code class="calibre17">(</code><code class="n">ingredients</code><code class="calibre17">)</code>
        <code class="n">names</code><code class="calibre17">.</code><code class="n">append</code><code class="calibre17">(</code><code class="s">"water"</code><code class="calibre17">)</code>
    <code class="k">return</code> <code class="calibre17">[</code><code class="nb">str</code><code class="calibre17">(</code><code class="n">i</code><code class="calibre17">)</code> <code class="k">for</code> <code class="n">i</code> <code class="calibre19">in</code> <code class="n">names</code><code class="calibre17">]</code></pre>

<p class="author1">In this case, names will start off as a list of <code class="calibre17">Ingredients</code>. If water is not among the ingredients, I add the string “water” to the list. At this point, the list is heterogeneous; it contains both ingredients and strings. If you were to annotate names as a <code class="calibre17">list[Ingredient]</code>, mypy would error out in this case. I would typically throw a red flag here as well; heterogeneous collections are harder to reason about in the absence of good type annotations. However, the next line renders both mypy and my objections moot. Everything is getting converted to a string when returned, which fulfills the annotation of the expected return type. Pytype is intelligent enough to detect this and consider this code to have no issues.</p>

<p class="author1">Pytype’s leniency and approach to typechecking make it very forgiving for adopting into existing codebases. You don’t need any type annotations in order to see the value. This means you get all the benefits of a typechecker with very minimal work. High value, but low cost? Yes, please.</p>

<p class="author1">However, Pytype is a double-edged sword in this case. Make sure you don’t use Pytype as a crutch; you should still be writing type annotations. It becomes incredibly easy with Pytype to think that you don’t need type annotations at all. However, you should still write them for two reasons. Firstly, type annotations provide a documentation benefit, which helps your code’s readability. Secondly, Pytype will be able to make even more intelligent decisions if type annotations are present.<a data-type="indexterm" data-primary="typechecking" data-secondary="adopting practically" data-tertiary="breaking even earlier" data-startref="ix_typckadBE" id="idm45644744381256" class="calibre5"/></p>
</div></section>



</div></section>





</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 7. Adopting Typechecking Practically" class="preface">
<div class="preface" id="adoption">
<section data-type="sect1" data-pdf-bookmark="Closing Thoughts" class="preface"><div class="preface" id="idm45644746045112">
<h1 class="calibre12" id="calibre_pb_7">Closing Thoughts</h1>

<p class="author1">Type annotations are incredibly useful, but there is no denying their cost. The larger the codebase, the higher the cost will be for practically adopting type annotations. Every codebase is different; you need to evaluate the value and cost of type annotations for your specific scenario. If type annotations are too costly to adopt, consider three strategies to get past that hurdle:</p>
<dl class="calibre13">
<dt class="calibre14">Find pain points</dt>
<dd class="calibre15">
<p class="calibre16">If you can eliminate entire classes of pain points through type annotations, such as errors, broken tests, or unclear code, you will save time and money. You target the areas that hurt the most, and by lessening that pain you are making it easier for developers to deliver value over time (which is a sure sign of maintainable code).</p>
</dd>
<dt class="calibre14">Target code strategically</dt>
<dd class="calibre15">
<p class="calibre16">Pick your spots wisely. In a large codebase, it will be near impossible to annotate every meaningful part of your code. Instead, focus on smaller sections that would see a huge benefit.</p>
</dd>
<dt class="calibre14">Lean on your tooling</dt>
<dd class="calibre15">
<p class="calibre16">Use mypy to help you selectively ignore files (and make sure that you are ignoring fewer lines of code over time). Use type annotators such as MonkeyType and Pytype to quickly generate types throughout your code. Don’t discount Pytype as a typechecker either, as it can find bugs lurking in your code with minimal setup.</p>
</dd>
</dl>

<p class="author1">This wraps up <a data-type="xref" href="part0004.html#part_1" class="calibre5">Part I</a> of the book. It has focused exclusively on type annotations and typechecking. Feel free to mix and match the strategies and tools I’ve discussed. You don’t need to type annotate absolutely everything, as type annotations can constrain expressiveness if too strictly applied. But you should strive to clarify code and make it harder for bugs to crop up. You will find the balance over time, but you need to start thinking about types in Python and how you can express them to other developers. Remember, the goal is a maintainable codebase. People need to understand as much of your intentions as they can from the code alone.</p>

<p class="author1">In <a data-type="xref" href="part0011.html#part_2" class="calibre5">Part II</a>, I’m going to focus on creating your own types. You’ve seen a little of this with building your own collection types, but you can go so much further. You’ll learn about enumerations, data classes, and classes, and learn why you should pick one over the other. You’ll learn how to craft an API and subclass types and model your data. You’ll continue to build a vocabulary that improves readability in your <span class="calibre">codebase</span>.</p>
</div></section>







<div data-type="footnotes" class="calibre25"><p data-type="footnote" id="idm45644746117528" class="calibre26"><sup class="calibre27"><a href="part0010_split_000.html#idm45644746117528-marker" class="calibre5">1</a></sup> Michael C. Feathers. <em class="calibre6">Working Effectively with Legacy Code</em>. Upper Saddle River, NJ: Pearson, 2013.</p></div></div></section></body></html>