<html><head></head><body><section data-pdf-bookmark="Chapter 4. Remote Actors" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch04">
<h1><span class="label">Chapter 4. </span>Remote Actors</h1>


<p>In the <a data-primary="state management" data-see="remote actors" data-type="indexterm" id="idm45354785900672"/>previous chapter, you learned about Ray remote functions, which are useful for the parallel execution of stateless functions. But what if you need to maintain a state between invocations? Examples of such situations span from a simple counter to a neural network during training to a simulator environment.</p>

<p>One option for maintaining state in these situations is to return the state along with the result and pass it to the next call. Although technically this will work, this is not the best solution, because of the large amount of data that has to be passed around (especially as the size of the state starts to grow). Ray uses actors, which we will cover in this chapter, to manage state.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Much like Ray’s remote functions, all Ray actors are remote actors, even when running on the same machine.</p>
</div>

<p>In a nutshell,<a data-primary="remote actors" data-secondary="definition of" data-type="indexterm" id="idm45354785897472"/> an <em>actor</em> is a computer process with an address (handle). This means that an actor can also store things in memory, private to the actor process. Before delving into the details of implementing and scaling Ray actors, let’s take a look at the concepts behind them. Actors come from the actor model design pattern. Understanding the actor model is key to effectively managing state and concurrency.</p>






<section data-pdf-bookmark="Understanding the Actor Model" data-type="sect1"><div class="sect1" id="idm45354785895792">
<h1>Understanding the Actor Model</h1>

<p>The<a data-primary="remote actors" data-secondary="actor model" data-type="indexterm" id="remote-actor-model"/><a data-primary="actor model" data-type="indexterm" id="actor-model"/> <a href="https://oreil.ly/aTwGY">actor model</a> was introduced by Carl Hewitt in 1973 to deal with concurrent computation. The heart of this conceptual model is an actor, a universal primitive of concurrent computation with its state.</p>

<p>An actor has a simple job:</p>

<ul>
<li>
<p>Store data</p>
</li>
<li>
<p>Receive messages from other actors</p>
</li>
<li>
<p>Pass messages to other actors</p>
</li>
<li>
<p>Create additional child actors</p>
</li>
</ul>

<p>The data that an actor stores is private to the actor and isn’t visible from outside; it can be accessed and modified only by the actor itself. Changing the actor’s state requires sending messages to the actor that will modify the state. (Compare this to using method calls in object-oriented programming.)</p>

<p>To ensure an actor’s state consistency, actors process one request at a time. All actor method invocations are globally serialized for a given actor. To improve throughput, people often create a pool of actors (assuming they can shard or replicate the actor’s state).</p>

<p>The actor model is a good fit for many distributed system scenarios. Here are some typical use cases where the actor model can be advantageous:</p>

<ul>
<li>
<p>You need to deal with a large distributed state that is hard to synchronize between invocations.</p>
</li>
<li>
<p>You want to work with single-threaded objects that do not require significant interaction from external components.</p>
</li>
</ul>

<p>In both situations, you would implement the standalone parts of the work inside an actor. You can put each piece of independent state inside its own actor, and then any changes to the state come in through the actor. Most actor system implementations avoid concurrency issues by using only single-threaded actors.</p>

<p>Now that you know the general principles of the actor model, let’s take a closer look at Ray’s remote <a data-primary="remote actors" data-secondary="actor model" data-startref="remote-actor-model" data-type="indexterm" id="idm45354785142784"/><a data-primary="actor model" data-startref="actor-model" data-type="indexterm" id="idm45354785141536"/>actors.</p>
</div></section>






<section data-pdf-bookmark="Creating a Basic Ray Remote Actor" data-type="sect1"><div class="sect1" id="idm45354785140208">
<h1>Creating a Basic Ray Remote Actor</h1>

<p>Ray <a data-primary="remote actors" data-secondary="creating" data-type="indexterm" id="remote-actor-create"/>implements remote actors as stateful workers. When you create a new remote actor, Ray creates a new worker and schedules the actor’s methods on that worker.</p>

<p>A common example of an actor is a bank account. Let’s take a look at how to implement an account by using Ray remote actors. Creating a Ray remote actor is as simple as decorating a Python class with <a data-primary="@ray.remote" data-type="indexterm" id="idm45354785136400"/><a data-primary="decorators" data-secondary="@ray.remote" data-type="indexterm" id="idm45354785135696"/>the <code>@ray.remote</code> decorator (<a data-type="xref" href="#simple_remote_actor_creation">Example 4-1</a>).</p>
<div data-type="example" id="simple_remote_actor_creation">
<h5><span class="label">Example 4-1. </span><a href="https://oreil.ly/Dpskz">Implementing a Ray remote actor</a></h5>

<pre data-code-language="python" data-type="programlisting"><code class="nd">@ray</code><code class="o">.</code><code class="n">remote</code>
<code class="k">class</code> <code class="nc">Account</code><code class="p">:</code>
    <code class="k">def</code> <code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">balance</code><code class="p">:</code> <code class="nb">float</code><code class="p">,</code> <code class="n">minimal_balance</code><code class="p">:</code> <code class="nb">float</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">minimal</code> <code class="o">=</code> <code class="n">minimal_balance</code>
        <code class="k">if</code> <code class="n">balance</code> <code class="o">&lt;</code> <code class="n">minimal_balance</code><code class="p">:</code>
            <code class="k">raise</code> <code class="ne">Exception</code><code class="p">(</code><code class="s2">"Starting balance is less than minimal balance"</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">balance</code> <code class="o">=</code> <code class="n">balance</code>

    <code class="k">def</code> <code class="nf">balance</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">float</code><code class="p">:</code>
        <code class="k">return</code> <code class="bp">self</code><code class="o">.</code><code class="n">balance</code>

    <code class="k">def</code> <code class="nf">deposit</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">amount</code><code class="p">:</code> <code class="nb">float</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">float</code><code class="p">:</code>
        <code class="k">if</code> <code class="n">amount</code> <code class="o">&lt;</code> <code class="mi">0</code><code class="p">:</code>
            <code class="k">raise</code> <code class="ne">Exception</code><code class="p">(</code><code class="s2">"Cannot deposit negative amount"</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">balance</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">balance</code> <code class="o">+</code> <code class="n">amount</code>
        <code class="k">return</code> <code class="bp">self</code><code class="o">.</code><code class="n">balance</code>

    <code class="k">def</code> <code class="nf">withdraw</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">amount</code><code class="p">:</code> <code class="nb">float</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">float</code><code class="p">:</code>
        <code class="k">if</code> <code class="n">amount</code> <code class="o">&lt;</code> <code class="mi">0</code><code class="p">:</code>
            <code class="k">raise</code> <code class="ne">Exception</code><code class="p">(</code><code class="s2">"Cannot withdraw negative amount"</code><code class="p">)</code>
        <code class="n">balance</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">balance</code> <code class="o">-</code> <code class="n">amount</code>
        <code class="k">if</code> <code class="n">balance</code> <code class="o">&lt;</code> <code class="bp">self</code><code class="o">.</code><code class="n">minimal</code><code class="p">:</code>
            <code class="k">raise</code> <code class="ne">Exception</code><code class="p">(</code><code class="s2">"Withdrawal is not supported by current balance"</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">balance</code> <code class="o">=</code> <code class="n">balance</code>
        <code class="k">return</code> <code class="n">balance</code></pre></div>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45354785004192">
<h5>Throwing Exceptions in Ray Code</h5>
<p>In both <a data-primary="remote actors" data-secondary="throwing exceptions" data-type="indexterm" id="idm45354785003056"/><a data-primary="exceptions" data-secondary="throwing" data-type="indexterm" id="idm45354785002112"/><a data-primary="throwing exceptions" data-type="indexterm" id="idm45354785785984"/>Ray remote functions and actors, you can throw exceptions. This will cause a function/method throwing an exception to return immediately.</p>

<p>In the case of remote actors, after the exception is thrown, the actor will continue running normally. You can use normal Python exception processing to deal with exceptions in the method invoker code (see the following explanation).</p>
</div></aside>

<p>The <code>Account</code> actor class itself is fairly simple and has four methods:</p>
<dl>
<dt>The constructor</dt>
<dd>
<p>Creates an account based on the starting and minimum balance. It also makes sure that the current balance is larger than the minimal one and throws an exception otherwise.</p>
</dd>
<dt><code>balance</code></dt>
<dd>
<p>Returns the current balance of the account. Because an actor’s state is private to the actor, access to it is available only through the actor’s method.</p>
</dd>
<dt><code>deposit</code></dt>
<dd>
<p>Deposits an amount to the account and returns a new balance.</p>
</dd>
<dt><code>withdraw</code></dt>
<dd>
<p>Withdraws an amount from the account and returns a new balance. It also ensures that the remaining balance is greater than the predefined minimum balance and throws an exception otherwise.</p>
</dd>
</dl>

<p>Now that you have defined the class, you need to use <code>.remote</code> to create an instance of this actor (<a data-type="xref" href="#make_actor">Example 4-2</a>).</p>
<div data-type="example" id="make_actor">
<h5><span class="label">Example 4-2. </span><a href="https://oreil.ly/Dpskz">Creating an instance of your Ray remote actor</a></h5>

<pre data-code-language="python" data-type="programlisting"><code class="n">account_actor</code> <code class="o">=</code> <code class="n">Account</code><code class="o">.</code><code class="n">remote</code><code class="p">(</code><code class="n">balance</code> <code class="o">=</code> <code class="mf">100.</code><code class="p">,</code><code class="n">minimal_balance</code><code class="o">=</code><code class="mf">20.</code><code class="p">)</code></pre></div>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45354785724608">
<h5>Actor Lifecycle</h5>
<p>Actor lifetimes <a data-primary="remote actors" data-secondary="lifecycle of" data-type="indexterm" id="idm45354785748800"/><a data-primary="GCS (global control store)" data-secondary="actor lifecycle" data-type="indexterm" id="idm45354785747824"/>and metadata (e.g., IP address and port) are managed by GCS service, which is currently a single point of failure. We cover the GCS in more detail in the next chapter.</p>

<p>Each client of the actor may cache this metadata and use it to send tasks to the actor directly over gRPC without querying the GCS. When an actor is created in Python, the creating worker first synchronously registers the actor with the GCS. This ensures correctness in case the creating worker fails before the actor can be created. Once the GCS responds, the remainder of the actor creation process is asynchronous. The creating worker process queues locally a special task known as the <em>actor creation task</em>. This is similar to a normal nonactor task, except that its specified resources are acquired for the lifetime of the actor process. The creator asynchronously resolves the dependencies for the actor creation task and then sends it to the GCS service to be scheduled. Meanwhile, the Python call to create the actor immediately returns an <em>actor handle</em> that can be used even if the actor creation task has not yet been scheduled.</p>

<p>An actor’s method execution is similar to a remote task invocation: it is submitted directly to the actor process via gRPC, will not run until all <code>ObjectRef</code> dependencies have been resolved, and returns futures. Note that no resource allocation is required for an actor’s method invocation (it is performed during the actor’s creation), which makes them faster than remote function invocation.</p>
</div></aside>

<p>Here, <code>account_actor</code> represents an actor handle. These handles play an important role in the actor’s lifecycle. Actor processes are terminated automatically when the initial actor handle goes out of scope in Python (note that in this case, the actor’s state is lost).</p>
<div data-type="tip"><h6>Tip</h6>
<p>You can create multiple distinct actors from the same class. Each will have its own independent state.</p>
</div>

<p>As with an <code>ObjectRef</code>, you can pass an actor handle as a parameter to another actor or Ray remote function or Python code.</p>

<p>Note<a data-primary="@ray.remote" data-type="indexterm" id="idm45354785714992"/><a data-primary="decorators" data-secondary="@ray.remote" data-type="indexterm" id="idm45354785714256"/> that <a data-type="xref" href="#simple_remote_actor_creation">Example 4-1</a> uses the <code>@ray.remote</code> annotation to define an ordinary Python class as a Ray remote actor. Alternatively, instead of using an annotation, you can use <a data-type="xref" href="#make_actor_2">Example 4-3</a> to convert a Python class into a remote actor.</p>
<div class="example-margin-2" data-type="example" id="make_actor_2">
<h5><span class="label">Example 4-3. </span><a href="https://oreil.ly/Dpskz">Creating an instance of a Ray remote actor without the decorator</a></h5>

<pre data-code-language="python" data-type="programlisting"><code class="n">Account</code> <code class="o">=</code> <code class="n">ray</code><code class="o">.</code><code class="n">remote</code><code class="p">(</code><code class="n">Account</code><code class="p">)</code>
<code class="n">account_actor</code> <code class="o">=</code> <code class="n">Account</code><code class="o">.</code><code class="n">remote</code><code class="p">(</code><code class="n">balance</code> <code class="o">=</code> <code class="mf">100.</code><code class="p">,</code><code class="n">minimal_balance</code><code class="o">=</code><code class="mf">20.</code><code class="p">)</code></pre></div>

<p>Once you have a remote actor in place, you can invoke<a data-primary="remote actors" data-secondary="invoking" data-type="indexterm" id="idm45354785665248"/> it by using <a data-type="xref" href="#invoke_actor">Example 4-4</a>.</p>
<div data-type="example" id="invoke_actor">
<h5><span class="label">Example 4-4. </span><a href="https://oreil.ly/Dpskz">Invoking a remote actor</a></h5>

<pre data-code-language="python" data-type="programlisting"><code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s2">"Current balance </code><code class="si">{</code><code class="n">ray</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">account_actor</code><code class="o">.</code><code class="n">balance</code><code class="o">.</code><code class="n">remote</code><code class="p">())</code><code class="si">}</code><code class="s2">"</code><code class="p">)</code>
<code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s2">"New balance </code><code class="si">{</code><code class="n">ray</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">account_actor</code><code class="o">.</code><code class="n">withdraw</code><code class="o">.</code><code class="n">remote</code><code class="p">(</code><code class="mf">40.</code><code class="p">))</code><code class="si">}</code><code class="s2">"</code><code class="p">)</code>
<code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s2">"New balance </code><code class="si">{</code><code class="n">ray</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">account_actor</code><code class="o">.</code><code class="n">deposit</code><code class="o">.</code><code class="n">remote</code><code class="p">(</code><code class="mf">30.</code><code class="p">))</code><code class="si">}</code><code class="s2">"</code><code class="p">)</code></pre></div>
<div data-type="tip"><h6>Tip</h6>
<p>It’s important<a data-primary="remote actors" data-secondary="handling exceptions" data-type="indexterm" id="idm45354785505904"/><a data-primary="exceptions" data-secondary="handling" data-type="indexterm" id="idm45354785505024"/><a data-primary="handling" data-secondary="exceptions" data-type="indexterm" id="idm45354785504080"/> to handle exceptions, which in the example can occur in both the the deposit and withdrawal method’s code. To handle the exceptions, you should augment <a data-type="xref" href="#invoke_actor">Example 4-4</a> with <code>try</code>/<code>except</code> clauses:</p>

<pre data-code-language="python" data-type="programlisting"><code class="k">try</code><code class="p">:</code>
  <code class="n">result</code> <code class="o">=</code> <code class="n">ray</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">account_actor</code><code class="o">.</code><code class="n">withdraw</code><code class="o">.</code><code class="n">remote</code><code class="p">(</code><code class="o">-</code><code class="mf">40.</code><code class="p">))</code>
<code class="k">except</code> <code class="ne">Exception</code> <code class="k">as</code> <code class="n">e</code><code class="p">:</code>
  <code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s2">"Oops! \</code><code class="si">{</code><code class="n">e</code><code class="si">}</code><code class="s2"> occurred."</code><code class="p">)</code></pre>

<p>This ensures that the code will intercept all the exceptions thrown by the actor’s code and implement all the necessary actions.</p>
</div>

<p>You can also create named actors <a data-primary="named actors" data-secondary="creating" data-type="indexterm" id="idm45354785429024"/>by using <a data-type="xref" href="#make_named_actor">Example 4-5</a>.</p>
<div data-type="example" id="make_named_actor">
<h5><span class="label">Example 4-5. </span><a href="https://oreil.ly/Dpskz">Creating a named actor</a></h5>

<pre class="pagebreak-after" data-code-language="python" data-type="programlisting"><code class="n">account_actor</code> <code class="o">=</code> <code class="n">Account</code><code class="o">.</code><code class="n">options</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s1">'Account'</code><code class="p">)</code>\
    <code class="o">.</code><code class="n">remote</code><code class="p">(</code><code class="n">balance</code> <code class="o">=</code> <code class="mf">100.</code><code class="p">,</code><code class="n">minimal_balance</code><code class="o">=</code><code class="mf">20.</code><code class="p">)</code></pre></div>

<p>Once the actor has a name, you can use it to obtain the actor’s handle from any place in the code:</p>

<pre data-code-language="python" data-type="programlisting"><code class="n">ray</code><code class="o">.</code><code class="n">get_actor</code><code class="p">(</code><code class="s1">'Account'</code><code class="p">)</code></pre>

<p>As defined previously, the default actor’s lifecycle is linked to the actor’s handle being in scope.</p>

<p>An actor’s lifetime can be decoupled from its handle being in scope, allowing an actor to persist even after the driver process exits. You can create a detached actor <a data-primary="detached actors" data-secondary="creating" data-type="indexterm" id="idm45354785369456"/>by specifying the lifetime parameter as <code>detached</code> (<a data-type="xref" href="#make_detached_named_actor">Example 4-6</a>).</p>
<div data-type="example" id="make_detached_named_actor">
<h5><span class="label">Example 4-6. </span><a href="https://oreil.ly/Dpskz">Making a detached actor</a></h5>

<pre data-code-language="python" data-type="programlisting"><code class="n">account_actor</code> <code class="o">=</code> <code class="n">Account</code><code class="o">.</code><code class="n">options</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s1">'Account'</code><code class="p">,</code> <code class="n">lifetime</code><code class="o">=</code><code class="s1">'detached'</code><code class="p">)</code>\
    <code class="o">.</code><code class="n">remote</code><code class="p">(</code><code class="n">balance</code> <code class="o">=</code> <code class="mf">100.</code><code class="p">,</code><code class="n">minimal_balance</code><code class="o">=</code><code class="mf">20.</code><code class="p">)</code></pre></div>

<p>In theory, you can make an actor detached without specifying its name, but since <code>ray.get_actor</code> operates by name, detached actors make the most sense with a name. You should name your detached actors so you can access them, even after the actor’s handle is out of scope. The detached actor itself can own any other tasks and objects.</p>

<p>In addition, you can manually delete <a data-primary="remote actors" data-secondary="deleting" data-type="indexterm" id="idm45354785268704"/><a data-primary="deleting remote actors" data-type="indexterm" id="idm45354785267856"/>actors from inside an actor, using <code>ray.actor.exit_actor</code>, or by using an actor’s handle <code>ray.kill(account_actor)</code>. This can be useful if you know that you do not need specific actors anymore and want to reclaim the resources.</p>

<p>As shown here, creating a basic Ray actor and managing its lifecycle is fairly easy, but what happens if the Ray node on which the actor is running goes down for some reason?<sup><a data-type="noteref" href="ch04.html#idm45354785265712" id="idm45354785265712-marker">1</a></sup> The <code>@ray.remote</code> annotation <a data-primary="@ray.remote" data-type="indexterm" id="idm45354785264608"/><a data-primary="decorators" data-secondary="@ray.remote" data-type="indexterm" id="idm45354785263872"/>allows you to specify two <a href="https://oreil.ly/VAHBm">parameters</a> that control behavior in this case:</p>
<dl>
<dt><code>max_restarts</code></dt>
<dd>
<p>Specify the maximum number of times that the actor should be restarted when it dies unexpectedly. The minimum valid value is <code>0</code> (default), which indicates that the actor doesn’t need to be restarted. A value of <code>-1</code> indicates that an actor should be restarted indefinitely.</p>
</dd>
<dt><code>max_task_retries</code></dt>
<dd>
<p>Specifies the number of times to retry an actor’s task if the task fails because of a system error. If set to <code>-1</code>, the system will retry the failed task until the task succeeds, or the actor has reached its <code>max_restarts</code> limit. If set to <code>n &gt; 0</code>, the system will retry the failed task up to <em>n</em> times, after which the task will throw a <code>RayActorError</code> exception upon <a href="https://oreil.ly/li5RX"><code>ray.get</code></a>.</p>
</dd>
</dl>

<p>As further explained in the next chapter and in the <a href="https://oreil.ly/S64hX">Ray fault-tolerance documentation</a>, when an actor is restarted, Ray will re-create its state by rerunning its constructor. Therefore, if a state was changed during the actor’s execution, it will be lost. To preserve such a state, an actor has to implement its custom persistence.</p>

<p>In our example case, the actor’s state is lost on failure since we haven’t used actor persistence. This might be OK for some use cases but is not acceptable for others—​see also the <a href="https://oreil.ly/tezP2">Ray documentation on design patterns</a>. In the next section, you will learn how to programmatically implement custom actor <a data-primary="remote actors" data-secondary="creating" data-startref="remote-actor-create" data-type="indexterm" id="idm45354785252416"/>persistence.</p>
</div></section>






<section data-pdf-bookmark="Implementing the Actor’s Persistence" data-type="sect1"><div class="sect1" id="idm45354785139264">
<h1>Implementing the Actor’s Persistence</h1>

<p>In this<a data-primary="remote actors" data-secondary="implementing persistence" data-type="indexterm" id="remote-actor-persist"/><a data-primary="persistence, implementing in remote actors" data-type="indexterm" id="persist-remote-actor"/> implementation, the state is saved as a whole, which works well enough if the size of the state is relatively small and the state changes are relatively rare. Also, to keep our example simple, we use local disk persistence. In reality, for a distributed Ray case, you should consider using Network File System (NFS), Amazon Simple Storage Service (S3), or a database to enable access to the actor’s data from any node in the Ray cluster.</p>

<p>A persistent <code>Account</code> actor is presented in <a data-type="xref" href="#persistent_actor">Example 4-7</a>.<sup><a data-type="noteref" href="ch04.html#idm45354785245664" id="idm45354785245664-marker">2</a></sup></p>
<aside class="pagebreak-after" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45354785244976">
<h5>Actor’s Persistence with Event Sourcing</h5>
<p>Because the <a data-primary="event sourcing" data-type="indexterm" id="idm45354785243440"/>actor model defines an actor’s interactions through messages, another common approach to actor’s persistence used in many commercial implementations is <a href="https://oreil.ly/7LJDU">event sourcing</a>: persisting a state as a sequence of state-changing events. This approach is especially important when the size of the state is large and events are relatively small because it significantly decreases the amount of data saved for every actor’s invocation and consequently improves actors’ performance. This implementation can be arbitrarily complex and include various optimization techniques such as snapshotting.</p>
</div></aside>
<div class="example-margin-5 less_space" data-type="example" id="persistent_actor">
<h5><span class="label">Example 4-7. </span><a href="https://oreil.ly/qHSfR">Defining a persistent actor, using filesystem persistence</a></h5>

<pre data-code-language="python" data-type="programlisting"><code class="nd">@ray</code><code class="o">.</code><code class="n">remote</code>
<code class="k">class</code> <code class="nc">Account</code><code class="p">:</code>
    <code class="k">def</code> <code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">balance</code><code class="p">:</code> <code class="nb">float</code><code class="p">,</code> <code class="n">minimal_balance</code><code class="p">:</code> <code class="nb">float</code><code class="p">,</code> <code class="n">account_key</code><code class="p">:</code> <code class="nb">str</code><code class="p">,</code>
        <code class="n">basedir</code><code class="p">:</code> <code class="nb">str</code> <code class="o">=</code> <code class="s1">'.'</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">basedir</code> <code class="o">=</code> <code class="n">basedir</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">key</code> <code class="o">=</code> <code class="n">account_key</code>
        <code class="k">if</code> <code class="ow">not</code> <code class="bp">self</code><code class="o">.</code><code class="n">restorestate</code><code class="p">():</code>
            <code class="k">if</code> <code class="n">balance</code> <code class="o">&lt;</code> <code class="n">minimal_balance</code><code class="p">:</code>
                <code class="k">raise</code> <code class="ne">Exception</code><code class="p">(</code><code class="s2">"Starting balance is less than minimal balance"</code><code class="p">)</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">balance</code> <code class="o">=</code> <code class="n">balance</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">minimal</code> <code class="o">=</code> <code class="n">minimal_balance</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">storestate</code><code class="p">()</code>

    <code class="k">def</code> <code class="nf">balance</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">float</code><code class="p">:</code>
        <code class="k">return</code> <code class="bp">self</code><code class="o">.</code><code class="n">balance</code>

    <code class="k">def</code> <code class="nf">deposit</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">amount</code><code class="p">:</code> <code class="nb">float</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">float</code><code class="p">:</code>
        <code class="k">if</code> <code class="n">amount</code> <code class="o">&lt;</code> <code class="mi">0</code><code class="p">:</code>
            <code class="k">raise</code> <code class="ne">Exception</code><code class="p">(</code><code class="s2">"Cannot deposit negative amount"</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">balance</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">balance</code> <code class="o">+</code> <code class="n">amount</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">storestate</code><code class="p">()</code>
        <code class="k">return</code> <code class="bp">self</code><code class="o">.</code><code class="n">balance</code>

    <code class="k">def</code> <code class="nf">withdraw</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">amount</code><code class="p">:</code> <code class="nb">float</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">float</code><code class="p">:</code>
        <code class="k">if</code> <code class="n">amount</code> <code class="o">&lt;</code> <code class="mi">0</code><code class="p">:</code>
            <code class="k">raise</code> <code class="ne">Exception</code><code class="p">(</code><code class="s2">"Cannot withdraw negative amount"</code><code class="p">)</code>
        <code class="n">balance</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">balance</code> <code class="o">-</code> <code class="n">amount</code>
        <code class="k">if</code> <code class="n">balance</code> <code class="o">&lt;</code> <code class="bp">self</code><code class="o">.</code><code class="n">minimal</code><code class="p">:</code>
            <code class="k">raise</code> <code class="ne">Exception</code><code class="p">(</code><code class="s2">"Withdrawal is not supported by current balance"</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">balance</code> <code class="o">=</code> <code class="n">balance</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">storestate</code><code class="p">()</code>
        <code class="k">return</code> <code class="n">balance</code>

    <code class="k">def</code> <code class="nf">restorestate</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">bool</code><code class="p">:</code>
        <code class="k">if</code> <code class="n">exists</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">basedir</code> <code class="o">+</code> <code class="s1">'/'</code> <code class="o">+</code> <code class="bp">self</code><code class="o">.</code><code class="n">key</code><code class="p">):</code>
            <code class="k">with</code> <code class="nb">open</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">basedir</code> <code class="o">+</code> <code class="s1">'/'</code> <code class="o">+</code> <code class="bp">self</code><code class="o">.</code><code class="n">key</code><code class="p">,</code> <code class="s2">"rb"</code><code class="p">)</code> <code class="k">as</code> <code class="n">f</code><code class="p">:</code>
                <code class="nb">bytes</code> <code class="o">=</code> <code class="n">f</code><code class="o">.</code><code class="n">read</code><code class="p">()</code>
            <code class="n">state</code> <code class="o">=</code> <code class="n">ray</code><code class="o">.</code><code class="n">cloudpickle</code><code class="o">.</code><code class="n">loads</code><code class="p">(</code><code class="nb">bytes</code><code class="p">)</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">balance</code> <code class="o">=</code> <code class="n">state</code><code class="p">[</code><code class="s1">'balance'</code><code class="p">]</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">minimal</code> <code class="o">=</code> <code class="n">state</code><code class="p">[</code><code class="s1">'minimal'</code><code class="p">]</code>
            <code class="k">return</code> <code class="kc">True</code>
        <code class="k">else</code><code class="p">:</code>
            <code class="k">return</code> <code class="kc">False</code>

    <code class="k">def</code> <code class="nf">storestate</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="nb">bytes</code> <code class="o">=</code> <code class="n">ray</code><code class="o">.</code><code class="n">cloudpickle</code><code class="o">.</code><code class="n">dumps</code><code class="p">(</code>
            <code class="p">{</code><code class="s1">'balance'</code> <code class="p">:</code> <code class="bp">self</code><code class="o">.</code><code class="n">balance</code><code class="p">,</code> <code class="s1">'minimal'</code> <code class="p">:</code> <code class="bp">self</code><code class="o">.</code><code class="n">minimal</code><code class="p">})</code>
        <code class="k">with</code> <code class="nb">open</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">basedir</code> <code class="o">+</code> <code class="s1">'/'</code> <code class="o">+</code> <code class="bp">self</code><code class="o">.</code><code class="n">key</code><code class="p">,</code> <code class="s2">"wb"</code><code class="p">)</code> <code class="k">as</code> <code class="n">f</code><code class="p">:</code>
            <code class="n">f</code><code class="o">.</code><code class="n">write</code><code class="p">(</code><code class="nb">bytes</code><code class="p">)</code></pre></div>

<p>If we compare this implementation with the original in <a data-type="xref" href="#simple_remote_actor_creation">Example 4-1</a>, we will notice several important changes:</p>

<ul>
<li>
<p>Here the constructor has two additional parameters: <code>account_key</code> and <code>basedir</code>. The account key is a unique identifier for the account that is also used as the name of the persistence file. The <code>basedir</code> parameter indicates a base directory used for storing persistence files. When the constructor is invoked, we first check whether a persistent state for this account is saved, and if there is one, we ignore the passed-in balance and minimum balance and restore them from the persistence state.</p>
</li>
<li>
<p>Two additional methods are added to the class: <code>store_state</code> and <code>restore_state</code>. The <code>store_states</code> is a method that stores an actor state into a file. State information is represented as a dictionary with keys as names of the state elements and values as the state elements, values. We are using Ray’s implementation of cloud pickling to convert this dictionary to the byte string and then write this byte string to the file, defined by the account key and base directory. (<a data-type="xref" href="ch05.html#ch05">Chapter 5</a> provides a detailed discussion of cloud pickling.) The <code>restore_states</code> method restores the state from a file defined by an account key and base directory. The method reads a binary string from the file and uses Ray’s implementation of cloud pickling to convert it to the dictionary. Then it uses the content of the dictionary to populate the state.</p>
</li>
<li>
<p>Finally, both <code>deposit</code> and <code>withdraw</code> methods, which are changing the state, use the <code>store_state</code> method to update persistence.</p>
</li>
</ul>

<p>The implementation shown in <a data-type="xref" href="#persistent_actor">Example 4-7</a> works fine, but our account actor implementation now contains too much persistence-specific code and is tightly coupled to file persistence. A better solution is to separate persistence-specific code into a separate class.</p>

<p>We start by creating an abstract class defining methods that have to be implemented by any persistence class (<a data-type="xref" href="#persistent_actor_class_base">Example 4-8</a>).</p>
<div data-type="example" id="persistent_actor_class_base">
<h5><span class="label">Example 4-8. </span><a href="https://oreil.ly/sI7Me">Defining a base persistence class</a></h5>

<pre data-code-language="python" data-type="programlisting"><code class="k">class</code> <code class="nc">BasePersitence</code><code class="p">:</code>
    <code class="k">def</code> <code class="nf">exists</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">key</code><code class="p">:</code><code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">bool</code><code class="p">:</code>
        <code class="k">pass</code>
    <code class="k">def</code> <code class="nf">save</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">key</code><code class="p">:</code> <code class="nb">str</code><code class="p">,</code> <code class="n">data</code><code class="p">:</code> <code class="nb">dict</code><code class="p">):</code>
        <code class="k">pass</code>
    <code class="k">def</code> <code class="nf">restore</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">key</code><code class="p">:</code><code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">dict</code><code class="p">:</code>
        <code class="k">pass</code></pre></div>

<p>This class defines all the methods that have to be implemented by a concrete persistence implementation. With this in place, a file persistence class implementing base persistence can be defined as shown in <a data-type="xref" href="#persistent_actor_class_file">Example 4-9</a>.</p>
<div data-type="example" id="persistent_actor_class_file">
<h5><span class="label">Example 4-9. </span><a href="https://oreil.ly/sI7Me">Defining a file persistence class</a></h5>

<pre data-code-language="python" data-type="programlisting"><code class="k">class</code> <code class="nc">FilePersistence</code><code class="p">(</code><code class="n">BasePersitence</code><code class="p">):</code>
    <code class="k">def</code> <code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">basedir</code><code class="p">:</code> <code class="nb">str</code> <code class="o">=</code> <code class="s1">'.'</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">basedir</code> <code class="o">=</code> <code class="n">basedir</code>

    <code class="k">def</code> <code class="nf">exists</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">key</code><code class="p">:</code><code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">bool</code><code class="p">:</code>
        <code class="k">return</code> <code class="n">exists</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">basedir</code> <code class="o">+</code> <code class="s1">'/'</code> <code class="o">+</code> <code class="n">key</code><code class="p">)</code>

    <code class="k">def</code> <code class="nf">save</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">key</code><code class="p">:</code> <code class="nb">str</code><code class="p">,</code> <code class="n">data</code><code class="p">:</code> <code class="nb">dict</code><code class="p">):</code>
        <code class="nb">bytes</code> <code class="o">=</code> <code class="n">ray</code><code class="o">.</code><code class="n">cloudpickle</code><code class="o">.</code><code class="n">dumps</code><code class="p">(</code><code class="n">data</code><code class="p">)</code>
        <code class="k">with</code> <code class="nb">open</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">basedir</code> <code class="o">+</code> <code class="s1">'/'</code> <code class="o">+</code> <code class="n">key</code><code class="p">,</code> <code class="s2">"wb"</code><code class="p">)</code> <code class="k">as</code> <code class="n">f</code><code class="p">:</code>
            <code class="n">f</code><code class="o">.</code><code class="n">write</code><code class="p">(</code><code class="nb">bytes</code><code class="p">)</code>

    <code class="k">def</code> <code class="nf">restore</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">key</code><code class="p">:</code><code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">dict</code><code class="p">:</code>
        <code class="k">if</code> <code class="ow">not</code> <code class="bp">self</code><code class="o">.</code><code class="n">exists</code><code class="p">(</code><code class="n">key</code><code class="p">):</code>
            <code class="k">return</code> <code class="kc">None</code>
        <code class="k">else</code><code class="p">:</code>
            <code class="k">with</code> <code class="nb">open</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">basedir</code> <code class="o">+</code> <code class="s1">'/'</code> <code class="o">+</code> <code class="n">key</code><code class="p">,</code> <code class="s2">"rb"</code><code class="p">)</code> <code class="k">as</code> <code class="n">f</code><code class="p">:</code>
                <code class="nb">bytes</code> <code class="o">=</code> <code class="n">f</code><code class="o">.</code><code class="n">read</code><code class="p">()</code>
            <code class="k">return</code> <code class="n">ray</code><code class="o">.</code><code class="n">cloudpickle</code><code class="o">.</code><code class="n">loads</code><code class="p">(</code><code class="nb">bytes</code><code class="p">)</code></pre></div>

<p>This implementation factors out most of the persistence-specific code from our original implementation in <a data-type="xref" href="#persistent_actor">Example 4-7</a>. Now it is possible to simplify and generalize an account implementation; see <a data-type="xref" href="#persistent_actor_class_actor">Example 4-10</a>.</p>
<div class="example-margin-5" data-type="example" id="persistent_actor_class_actor">
<h5><span class="label">Example 4-10. </span><a href="https://oreil.ly/sI7Me">Implementing a persistent actor with pluggable persistence</a></h5>

<pre data-code-language="python" data-type="programlisting"><code class="nd">@ray</code><code class="o">.</code><code class="n">remote</code>
<code class="k">class</code> <code class="nc">Account</code><code class="p">:</code>
    <code class="k">def</code> <code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">balance</code><code class="p">:</code> <code class="nb">float</code><code class="p">,</code> <code class="n">minimal_balance</code><code class="p">:</code> <code class="nb">float</code><code class="p">,</code> <code class="n">account_key</code><code class="p">:</code> <code class="nb">str</code><code class="p">,</code>
                 <code class="n">persistence</code><code class="p">:</code> <code class="n">BasePersitence</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">persistence</code> <code class="o">=</code> <code class="n">persistence</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">key</code> <code class="o">=</code> <code class="n">account_key</code>
        <code class="k">if</code> <code class="ow">not</code> <code class="bp">self</code><code class="o">.</code><code class="n">restorestate</code><code class="p">():</code>
            <code class="k">if</code> <code class="n">balance</code> <code class="o">&lt;</code> <code class="n">minimal_balance</code><code class="p">:</code>
                <code class="k">raise</code> <code class="ne">Exception</code><code class="p">(</code><code class="s2">"Starting balance is less than minimal balance"</code><code class="p">)</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">balance</code> <code class="o">=</code> <code class="n">balance</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">minimal</code> <code class="o">=</code> <code class="n">minimal_balance</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">storestate</code><code class="p">()</code>

    <code class="k">def</code> <code class="nf">balance</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">float</code><code class="p">:</code>
        <code class="k">return</code> <code class="bp">self</code><code class="o">.</code><code class="n">balance</code>

    <code class="k">def</code> <code class="nf">deposit</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">amount</code><code class="p">:</code> <code class="nb">float</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">float</code><code class="p">:</code>
        <code class="k">if</code> <code class="n">amount</code> <code class="o">&lt;</code> <code class="mi">0</code><code class="p">:</code>
            <code class="k">raise</code> <code class="ne">Exception</code><code class="p">(</code><code class="s2">"Cannot deposit negative amount"</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">balance</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">balance</code> <code class="o">+</code> <code class="n">amount</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">storestate</code><code class="p">()</code>
        <code class="k">return</code> <code class="bp">self</code><code class="o">.</code><code class="n">balance</code>

    <code class="k">def</code> <code class="nf">withdraw</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">amount</code><code class="p">:</code> <code class="nb">float</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">float</code><code class="p">:</code>
        <code class="k">if</code> <code class="n">amount</code> <code class="o">&lt;</code> <code class="mi">0</code><code class="p">:</code>
            <code class="k">raise</code> <code class="ne">Exception</code><code class="p">(</code><code class="s2">"Cannot withdraw negative amount"</code><code class="p">)</code>
        <code class="n">balance</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">balance</code> <code class="o">-</code> <code class="n">amount</code>
        <code class="k">if</code> <code class="n">balance</code> <code class="o">&lt;</code> <code class="bp">self</code><code class="o">.</code><code class="n">minimal</code><code class="p">:</code>
            <code class="k">raise</code> <code class="ne">Exception</code><code class="p">(</code><code class="s2">"Withdrawal is not supported by current balance"</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">balance</code> <code class="o">=</code> <code class="n">balance</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">storestate</code><code class="p">()</code>
        <code class="k">return</code> <code class="n">balance</code>

    <code class="k">def</code> <code class="nf">restorestate</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">bool</code><code class="p">:</code>
        <code class="n">state</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">persistence</code><code class="o">.</code><code class="n">restore</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">key</code><code class="p">)</code>
        <code class="k">if</code> <code class="n">state</code> <code class="o">!=</code> <code class="kc">None</code><code class="p">:</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">balance</code> <code class="o">=</code> <code class="n">state</code><code class="p">[</code><code class="s1">'balance'</code><code class="p">]</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">minimal</code> <code class="o">=</code> <code class="n">state</code><code class="p">[</code><code class="s1">'minimal'</code><code class="p">]</code>
            <code class="k">return</code> <code class="kc">True</code>
        <code class="k">else</code><code class="p">:</code>
            <code class="k">return</code> <code class="kc">False</code>

    <code class="k">def</code> <code class="nf">storestate</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">persistence</code><code class="o">.</code><code class="n">save</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">key</code><code class="p">,</code>
                    <code class="p">{</code><code class="s1">'balance'</code> <code class="p">:</code> <code class="bp">self</code><code class="o">.</code><code class="n">balance</code><code class="p">,</code> <code class="s1">'minimal'</code> <code class="p">:</code> <code class="bp">self</code><code class="o">.</code><code class="n">minimal</code><code class="p">})</code></pre></div>

<p>Only the code changes from our original persistent actor implementation (<a data-type="xref" href="#persistent_actor">Example 4-7</a>) are shown here. Note that the constructor is now taking the <code>Base​Per⁠sis⁠tence</code> class, which allows for easily changing the persistence implementation without changing the actor’s code. Additionally, the <code>restore_state</code> and <code>savestate</code> methods are generalized to move all the persistence-specific code to the persistence class.</p>

<p>This implementation is flexible enough to support different persistence implementations, but if a persistence implementation requires permanent connections to a persistence source (for example, a database connection), it can become unscalable by simultaneously maintaining too many connections. In this case, we can implement persistence as an <a href="https://oreil.ly/gz7wp">additional actor</a>. But this requires scaling of this actor. Let’s take a look at the options that Ray provides for <a data-primary="remote actors" data-secondary="implementing persistence" data-startref="remote-actor-persist" data-type="indexterm" id="idm45354778611616"/><a data-primary="persistence, implementing in remote actors" data-startref="persist-remote-actor" data-type="indexterm" id="idm45354778610400"/>scaling actors.</p>
</div></section>






<section data-pdf-bookmark="Scaling Ray Remote Actors" data-type="sect1"><div class="sect1" id="idm45354785250816">
<h1>Scaling Ray Remote Actors</h1>

<p>The<a data-primary="remote actors" data-secondary="scaling" data-type="indexterm" id="remote-actor-scale"/><a data-primary="scaling" data-secondary="remote actors" data-type="indexterm" id="scale-remote-actor"/><a data-primary="horizontal scaling of remote actors" data-type="indexterm" id="horizontal-scale-remote-actor"/> original actor model described earlier in this chapter typically assumes that actors are lightweight (e.g., contain a single piece of state) and do not require scaling or parallelization. In Ray and similar systems (including Akka), actors are often used for coarser-grained implementations and can require scaling.<sup><a data-type="noteref" href="ch04.html#idm45354778437024" id="idm45354778437024-marker">3</a></sup></p>

<p>As with Ray remote functions, you can scale actors both <em>horizontally</em> (across processes/machines) with pools, or <em>vertically</em> (with more resources). <a data-type="xref" href="ch05.html#ray_resources">“Resources / Vertical Scaling”</a> covers how to request more resources, but for now, let’s focus on horizontal scaling.</p>

<p>You can add more processes for horizontal scaling with <a data-primary="actor pool, scaling with" data-type="indexterm" id="actor-pool-scale"/>Ray’s actor pool, provided by the <code>ray.util</code> module. This class is similar to a multiprocessing pool and lets you schedule your tasks over a fixed pool of actors.</p>

<p>The actor pool effectively uses a fixed set of actors as a single entity and manages which actor in the pool gets the next request. Note that actors in the pool are still individual actors and their state is not merged. So this scaling option works only when an actor’s state is created in the constructor and does not change during the actor’s execution.</p>

<p>Let’s take a look at how to use an actor’s pool to improve the scalability of our account class by adding an <a href="https://oreil.ly/hSXsd">actor’s pool</a> in <a data-type="xref" href="#persistent_actor_class_pool">Example 4-11</a>.</p>
<div class="example-margin-7" data-type="example" id="persistent_actor_class_pool">
<h5><span class="label">Example 4-11. </span><a href="https://oreil.ly/UsjXG">Using an actor’s pool for implementing persistence</a></h5>

<pre data-code-language="python" data-type="programlisting"><code class="n">pool</code> <code class="o">=</code> <code class="n">ActorPool</code><code class="p">([</code>
    <code class="n">FilePersistence</code><code class="o">.</code><code class="n">remote</code><code class="p">(),</code> <code class="n">FilePersistence</code><code class="o">.</code><code class="n">remote</code><code class="p">(),</code> <code class="n">FilePersistence</code><code class="o">.</code><code class="n">remote</code><code class="p">()])</code>

<code class="nd">@ray</code><code class="o">.</code><code class="n">remote</code>
<code class="k">class</code> <code class="nc">Account</code><code class="p">:</code>
    <code class="k">def</code> <code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">balance</code><code class="p">:</code> <code class="nb">float</code><code class="p">,</code> <code class="n">minimal_balance</code><code class="p">:</code> <code class="nb">float</code><code class="p">,</code>
            <code class="n">account_key</code><code class="p">:</code> <code class="nb">str</code><code class="p">,</code> <code class="n">persistence</code><code class="p">:</code> <code class="n">ActorPool</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">persistence</code> <code class="o">=</code> <code class="n">persistence</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">key</code> <code class="o">=</code> <code class="n">account_key</code>
        <code class="k">if</code> <code class="ow">not</code> <code class="bp">self</code><code class="o">.</code><code class="n">restorestate</code><code class="p">():</code>
            <code class="k">if</code> <code class="n">balance</code> <code class="o">&lt;</code> <code class="n">minimal_balance</code><code class="p">:</code>
                <code class="k">raise</code> <code class="ne">Exception</code><code class="p">(</code><code class="s2">"Starting balance is less than minimal balance"</code><code class="p">)</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">balance</code> <code class="o">=</code> <code class="n">balance</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">minimal</code> <code class="o">=</code> <code class="n">minimal_balance</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">storestate</code><code class="p">()</code>

    <code class="k">def</code> <code class="nf">balance</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">float</code><code class="p">:</code>
        <code class="k">return</code> <code class="bp">self</code><code class="o">.</code><code class="n">balance</code>

    <code class="k">def</code> <code class="nf">deposit</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">amount</code><code class="p">:</code> <code class="nb">float</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">float</code><code class="p">:</code>
        <code class="k">if</code> <code class="n">amount</code> <code class="o">&lt;</code> <code class="mi">0</code><code class="p">:</code>
            <code class="k">raise</code> <code class="ne">Exception</code><code class="p">(</code><code class="s2">"Cannot deposit negative amount"</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">balance</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">balance</code> <code class="o">+</code> <code class="n">amount</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">storestate</code><code class="p">()</code>
        <code class="k">return</code> <code class="bp">self</code><code class="o">.</code><code class="n">balance</code>

    <code class="k">def</code> <code class="nf">withdraw</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">amount</code><code class="p">:</code> <code class="nb">float</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">float</code><code class="p">:</code>
        <code class="k">if</code> <code class="n">amount</code> <code class="o">&lt;</code> <code class="mi">0</code><code class="p">:</code>
            <code class="k">raise</code> <code class="ne">Exception</code><code class="p">(</code><code class="s2">"Cannot withdraw negative amount"</code><code class="p">)</code>
        <code class="n">balance</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">balance</code> <code class="o">-</code> <code class="n">amount</code>
        <code class="k">if</code> <code class="n">balance</code> <code class="o">&lt;</code> <code class="bp">self</code><code class="o">.</code><code class="n">minimal</code><code class="p">:</code>
            <code class="k">raise</code> <code class="ne">Exception</code><code class="p">(</code><code class="s2">"Withdrawal is not supported by current balance"</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">balance</code> <code class="o">=</code> <code class="n">balance</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">storestate</code><code class="p">()</code>
        <code class="k">return</code> <code class="n">balance</code>

    <code class="k">def</code> <code class="nf">restorestate</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">bool</code><code class="p">:</code>
        <code class="k">while</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">persistence</code><code class="o">.</code><code class="n">has_next</code><code class="p">()):</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">persistence</code><code class="o">.</code><code class="n">get_next</code><code class="p">()</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">persistence</code><code class="o">.</code><code class="n">submit</code><code class="p">(</code><code class="k">lambda</code> <code class="n">a</code><code class="p">,</code> <code class="n">v</code><code class="p">:</code> <code class="n">a</code><code class="o">.</code><code class="n">restore</code><code class="o">.</code><code class="n">remote</code><code class="p">(</code><code class="n">v</code><code class="p">),</code> <code class="bp">self</code><code class="o">.</code><code class="n">key</code><code class="p">)</code>
        <code class="n">state</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">persistence</code><code class="o">.</code><code class="n">get_next</code><code class="p">()</code>
        <code class="k">if</code> <code class="n">state</code> <code class="o">!=</code> <code class="kc">None</code><code class="p">:</code>
            <code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s1">'Restoring state </code><code class="si">{</code><code class="n">state</code><code class="si">}</code><code class="s1">'</code><code class="p">)</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">balance</code> <code class="o">=</code> <code class="n">state</code><code class="p">[</code><code class="s1">'balance'</code><code class="p">]</code>
            <code class="bp">self</code><code class="o">.</code><code class="n">minimal</code> <code class="o">=</code> <code class="n">state</code><code class="p">[</code><code class="s1">'minimal'</code><code class="p">]</code>
            <code class="k">return</code> <code class="kc">True</code>
        <code class="k">else</code><code class="p">:</code>
            <code class="k">return</code> <code class="kc">False</code>

    <code class="k">def</code> <code class="nf">storestate</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">persistence</code><code class="o">.</code><code class="n">submit</code><code class="p">(</code>
            <code class="k">lambda</code> <code class="n">a</code><code class="p">,</code> <code class="n">v</code><code class="p">:</code> <code class="n">a</code><code class="o">.</code><code class="n">save</code><code class="o">.</code><code class="n">remote</code><code class="p">(</code><code class="n">v</code><code class="p">),</code>
            <code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">key</code><code class="p">,</code>
             <code class="p">{</code><code class="s1">'balance'</code> <code class="p">:</code> <code class="bp">self</code><code class="o">.</code><code class="n">balance</code><code class="p">,</code> <code class="s1">'minimal'</code> <code class="p">:</code> <code class="bp">self</code><code class="o">.</code><code class="n">minimal</code><code class="p">}))</code>


<code class="n">account_actor</code> <code class="o">=</code> <code class="n">Account</code><code class="o">.</code><code class="n">options</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s1">'Account'</code><code class="p">)</code><code class="o">.</code><code class="n">remote</code><code class="p">(</code>
    <code class="n">balance</code><code class="o">=</code><code class="mf">100.</code><code class="p">,</code><code class="n">minimal_balance</code><code class="o">=</code><code class="mf">20.</code><code class="p">,</code>
    <code class="n">account_key</code><code class="o">=</code><code class="s1">'1234567'</code><code class="p">,</code> <code class="n">persistence</code><code class="o">=</code><code class="n">pool</code><code class="p">)</code></pre></div>

<p>Only the code changes from our original implementation are shown here. The code starts by creating a pool of three identical file persistence actors, and then this pool is passed to an account implementation.</p>

<p class="pagebreak-after">The syntax of a pool-based execution is a lambda function that takes two parameters: an actor reference and a value to be submitted to the function. The limitation here is that the value is a single object. One of the solutions for functions with multiple parameters is to use a tuple that can contain an arbitrary number of components. The function itself is defined as a remote function on the required actor’s method.</p>

<p>An execution on the pool is asynchronous (it routes requests to one of the remote actors internally). This allows faster execution of the <code>store_state</code> method, which does not need the results from data storage. Here implementation is not waiting for the result’s state storage to complete; it just starts the execution. The <code>restore_state</code> method, on another hand, needs the result of pool invocation to proceed. A pool implementation internally manages the process of waiting for execution results to become ready and exposes this functionality through the <code>get_next</code> function (note that this is a blocking call). The pool’s implementation manages a queue of execution results (in the same order as the requests). Whenever we need to get a result from the pool, we therefore must first clear out the pool results queue to ensure that we get the right<a data-primary="actor pool, scaling with" data-startref="actor-pool-scale" data-type="indexterm" id="idm45354777914512"/> result.</p>

<p>In addition to the multiprocessing-based scaling provided by the actor’s pool, Ray supports scaling of the actor’s execution through concurrency. Ray offers two types of <a data-primary="concurrency, actor scaling with" data-type="indexterm" id="concurrency-actor-scale"/><a data-primary="threading" data-type="indexterm" id="threading"/><a data-primary="async execution" data-type="indexterm" id="async-execute"/>concurrency within an actor: threading and async execution.</p>

<p>When using concurrency inside actors, keep in mind that Python’s <a href="https://oreil.ly/l7Ytt">global interpreter lock (GIL)</a> will allow only one thread of Python code running at once. Pure Python will not provide true parallelism. On another hand, if you invoke NumPy, Cython, TensorFlow, or PyTorch code, these libraries will release the GIL when calling into C/C++ functions. By overlapping the time waiting for I/O or working in native libraries, both threading and async actor execution can achieve some parallelism.</p>

<p>The <a href="https://oreil.ly/PXo8G">asyncio library</a> can be thought of as cooperative multitasking: your code or library needs to explicitly signal that it is waiting on a result, and Python can go ahead and execute another task by explicitly switching execution context. asyncio works by having a single process running through an event loop and changing which task it is executing when a task yields/awaits. asyncio tends to have lower overhead than multithreaded execution and can be a little easier to reason about. Ray actors, but not remote functions, integrate with asyncio, allowing you to write asynchronous actor methods.</p>

<p>You should use threaded execution when your code spends a lot of time blocking but not yielding control by calling <code>await</code>. Threads are managed by the operating system deciding when to run which thread. Using threaded execution can involve fewer code changes, as you do not need to explicitly indicate where your code is yielding. This can also make threaded execution more difficult to reason about.</p>

<p>You need to be careful and selectively use locks when accessing or modifying objects with both threads and asyncio. In both approaches, your objects share the same memory. By using locks, you ensure that only one thread or task can access the specific memory. Locks have some overhead (which increases as more processes or threads are waiting on a lock). As a result, an actor’s concurrency is mostly applicable for use cases when a state is populated in a constructor and never changes.</p>

<p>To create an actor that uses asyncio, you need to define at least one async method. In this case, Ray will create an asyncio event loop for executing the actor’s methods. Submitting tasks to these actors is the same from the caller’s perspective as submitting tasks to a regular actor. The only difference is that when the task is run on the actor, it is posted to an asyncio event loop running in a background thread or thread pool instead of running directly on the main thread. (Note that using blocking <code>ray.get</code> or <code>ray.wait</code> calls inside an async actor method is not allowed, because they will block the execution of the event loop.)</p>

<p><a data-type="xref" href="#simple_async_actor">Example 4-12</a> presents an example of a simple async actor.</p>
<div data-type="example" id="simple_async_actor">
<h5><span class="label">Example 4-12. </span><a href="https://oreil.ly/q3WFs">Creating a simple async actor</a></h5>

<pre data-code-language="python" data-type="programlisting"><code class="nd">@ray</code><code class="o">.</code><code class="n">remote</code>
<code class="k">class</code> <code class="nc">AsyncActor</code><code class="p">:</code>
    <code class="k">async</code> <code class="k">def</code> <code class="nf">computation</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">num</code><code class="p">):</code>
        <code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s1">'Actor waiting for </code><code class="si">{</code><code class="n">num</code><code class="si">}</code><code class="s1"> sec'</code><code class="p">)</code>
        <code class="k">for</code> <code class="n">x</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">num</code><code class="p">):</code>
            <code class="k">await</code> <code class="n">asyncio</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
            <code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s1">'Actor slept for </code><code class="si">{</code><code class="n">x</code><code class="o">+</code><code class="mi">1</code><code class="si">}</code><code class="s1"> sec'</code><code class="p">)</code>
        <code class="k">return</code> <code class="n">num</code></pre></div>

<p>Because the method <code>computation</code> is defined as <code>async</code>, Ray will create an async actor. Note that unlike ordinary <code>async</code> methods, which require <code>await</code> to invoke them, using Ray async actors does not require any special invocation semantics. Additionally, Ray allows you to specify the max concurrency for the async actor’s execution during the actor’s creation:</p>

<pre data-code-language="python" data-type="programlisting"><code class="n">actor</code> <code class="o">=</code> <code class="n">AsyncActor</code><code class="o">.</code><code class="n">options</code><code class="p">(</code><code class="n">max_concurrency</code><code class="o">=</code><code class="mi">5</code><code class="p">)</code><code class="o">.</code><code class="n">remote</code><code class="p">()</code></pre>

<p>To create a threaded actor, you need to specify <code>max_concurrency</code> during actor creation (<a data-type="xref" href="#simple-threaded-actor">Example 4-13</a>).</p>
<div data-type="example" id="simple-threaded-actor">
<h5><span class="label">Example 4-13. </span><a href="https://oreil.ly/EjTM4">Creating a simple threaded actor</a></h5>

<pre data-code-language="python" data-type="programlisting"><code class="nd">@ray</code><code class="o">.</code><code class="n">remote</code>
<code class="k">class</code> <code class="nc">ThreadedActor</code><code class="p">:</code>
  <code class="k">def</code> <code class="nf">computation</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">num</code><code class="p">):</code>
    <code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s1">'Actor waiting for \</code><code class="si">{</code><code class="n">num</code><code class="si">}</code><code class="s1"> sec'</code><code class="p">)</code>
    <code class="k">for</code> <code class="n">x</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">num</code><code class="p">):</code>
      <code class="n">sleep</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
      <code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s1">'Actor slept for \</code><code class="si">{</code><code class="n">x</code><code class="o">+</code><code class="mi">1</code><code class="si">}</code><code class="s1"> sec'</code><code class="p">)</code>
    <code class="k">return</code> <code class="n">num</code>

<code class="n">actor</code> <code class="o">=</code> <code class="n">ThreadedActor</code><code class="o">.</code><code class="n">options</code><code class="p">(</code><code class="n">max_concurrency</code><code class="o">=</code><code class="mi">3</code><code class="p">)</code><code class="o">.</code><code class="n">remote</code><code class="p">()</code></pre></div>
<div data-type="tip"><h6>Tip</h6>
<p>Because both async and threaded actors are use <code>max_concurrency</code>, the type of actor created might be a little confusing. The thing to remember is that if <code>max_concurrency</code> is used, the actor can be either async or threaded. If at least one of the actor’s methods is async, the actor is async; otherwise, it is a<a data-primary="concurrency, actor scaling with" data-startref="concurrency-actor-scale" data-type="indexterm" id="idm45354777701648"/><a data-primary="threading" data-startref="threading" data-type="indexterm" id="idm45354777700768"/><a data-primary="async execution" data-startref="async-execute" data-type="indexterm" id="idm45354777699824"/> threaded one.</p>
</div>

<p>So, which scaling approach should we use for our implementation? <a href="https://oreil.ly/UF26H">“Multiprocessing vs. Threading vs. AsyncIO in Python”</a> by Lei Mao provides a good summary of features for various<a data-primary="remote actors" data-secondary="scaling" data-startref="remote-actor-scale" data-type="indexterm" id="idm45354777697520"/><a data-primary="scaling" data-secondary="remote actors" data-startref="scale-remote-actor" data-type="indexterm" id="idm45354777653104"/><a data-primary="horizontal scaling of remote actors" data-startref="horizontal-scale-remote-actor" data-type="indexterm" id="idm45354777652016"/> approaches (<a data-type="xref" href="#table-4-1">Table 4-1</a>).</p>
<table id="table-4-1">
<caption><span class="label">Table 4-1. </span>Comparing scaling approaches for actors</caption>
<thead>
<tr>
<th>Scaling approach</th>
<th>Feature</th>
<th>Usage criteria</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>Actor pool</p></td>
<td><p>Multiple processes, high CPU utilization</p></td>
<td><p>CPU bound</p></td>
</tr>
<tr>
<td><p>Async actor</p></td>
<td><p>Single process, single thread, cooperative multitasking, tasks cooperatively decide on switching</p></td>
<td><p>Slow I/O bound</p></td>
</tr>
<tr>
<td><p>Threaded actor</p></td>
<td><p>Single process, multiple threads, preemptive multitasking, OS decides on task switching</p></td>
<td><div>
<p>Fast I/O bound and nonasync libraries you do not control</p></div></td>
</tr>
</tbody>
</table>
</div></section>






<section data-pdf-bookmark="Ray Remote Actors Best Practices" data-type="sect1"><div class="sect1" id="idm45354778441600">
<h1>Ray Remote Actors Best Practices</h1>

<p>Because<a data-primary="remote actors" data-secondary="best practices" data-type="indexterm" id="idm45354777638576"/><a data-primary="best practices" data-secondary="remote actors" data-type="indexterm" id="idm45354777637568"/> Ray remote actors are effectively remote functions, all the Ray remote best practices described in the previous chapter are applicable. In addition, Ray has some actor-specific best practices.</p>

<p>As mentioned before, Ray offers support for actors’ fault tolerance. Specifically for actors, you can specify <code>max_restarts</code> to automatically enable restarting for Ray actors. When your actor or the node hosting that actor crashes, the actor will be automatically reconstructed. However, this doesn’t provide ways for you to restore application-level states in your actor. Consider actor persistence approaches, described in this chapter to ensure restoration of execution-level states as well.</p>

<p>If your applications have global variables that you have to change, do not change them in remote functions. Instead, use actors to encapsulate them and access them through the actor’s methods. This is because remote functions are running in different processes and do not share the same address space. As a result, these changes are not reflected across Ray driver and remote functions.</p>

<p>One of the common application use cases is the execution of the same remote function many times for different datasets. Using the remote functions directly can cause delays because of the creation of new processes for function. This approach can also overwhelm the Ray cluster with a large number of processes. A more controlled option is to use the actor’s pool. In this case, a pool provides a controlled set of workers that are readily available (with no process creation delay) for execution. As the pool is maintaining its requests queue, the programming model for this option is identical to starting independent remote functions but provides a better-controlled execution environment.</p>
</div></section>






<section data-pdf-bookmark="Conclusion" data-type="sect1"><div class="sect1" id="idm45354777634608">
<h1>Conclusion</h1>

<p>In this chapter, you learned how to use Ray remote actors to implement stateful execution in Ray. You learned about the actor model and how to implement Ray remote actors. Note that Ray internally heavily relies on using actors—for example, for <a href="https://oreil.ly/vYdTi">multinode synchronization</a>, streaming (see <a data-type="xref" href="ch06.html#ch06">Chapter 6</a>), and microservices implementation (see <a data-type="xref" href="ch07.html#ch07">Chapter 7</a>). It is also widely used for ML implementations; see, for example, use of actors for implementing a <a href="https://oreil.ly/q33OW">parameter server</a>.</p>

<p>You also learned how to improve an actor’s reliability by implementing an actor’s persistence and saw a simple example of persistence implementation.</p>

<p>Finally, you learned about the options that Ray provides for scaling actors, their implementation, and trade-offs.</p>

<p>In the next chapter, we will discuss additional Ray design details.</p>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="idm45354785265712"><sup><a href="ch04.html#idm45354785265712-marker">1</a></sup> Python exceptions are not considered system errors and will not trigger restarts. Instead, the exception will be saved as the result of the call, and the actor will continue to run as normal.</p><p data-type="footnote" id="idm45354785245664"><sup><a href="ch04.html#idm45354785245664-marker">2</a></sup> In this implementation, we are using filesystem persistence, but you can use the same approach with other types of persistence, such as S3 or databases.</p><p data-type="footnote" id="idm45354778437024"><sup><a href="ch04.html#idm45354778437024-marker">3</a></sup> A <em>coarse-grained</em> actor is a single actor that may contain multiple pieces of state. In contrast, in a fine-grained approach, each piece of state would be represented as a separate actor. This is similar to the concept of <a href="https://oreil.ly/WwBrd">coarse-grained locking</a>.</p></div></div></section></body></html>