<html><head></head><body><section data-pdf-bookmark="Chapter 18. Games" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch18">&#13;
<h1><span class="label">Chapter 18. </span>Games</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Preview" data-type="sect1"><div class="sect1" id="id171">&#13;
<h1>Preview</h1>&#13;
&#13;
<p><a data-primary="games" data-type="indexterm" id="icd100"/>Games cover a lot of ground, from simple&#13;
text to multiplayer 3D extravaganzas.&#13;
This chapter will demonstrate a simple game&#13;
and how the web endpoint can interact with the user&#13;
across multiple steps.&#13;
This process is different from the familiar one-shot&#13;
request-response web endpoints that you’ve seen so far.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Python Game Packages" data-type="sect1"><div class="sect1" id="id172">&#13;
<h1>Python Game Packages</h1>&#13;
&#13;
<p>If <a data-primary="games" data-secondary="game packages" data-type="indexterm" id="id1012"/>you<a data-primary="Python" data-secondary="game packages" data-type="indexterm" id="id1013"/> really want to get into Python for games,&#13;
here are some useful tools:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Text:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://adventurelib.readthedocs.io">Adventurelib</a><a data-primary="Adventurelib" data-type="indexterm" id="id1014"/></p>&#13;
</li>&#13;
</ul>&#13;
</li>&#13;
<li>&#13;
<p>Graphic:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://www.pygame.org">PyGame</a><a data-primary="PyGame" data-type="indexterm" id="id1015"/>, <a href="https://realpython.com/pygame-a-primer">primer</a><a data-primary="primer" data-type="indexterm" id="id1016"/></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://pyglet.org">pyglet</a><a data-primary="pyglet" data-type="indexterm" id="id1017"/></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://api.arcade.academy">Python Arcade</a><a data-primary="Python Arcade" data-type="indexterm" id="id1018"/></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://www.harfang3d.com">HARFANG</a><a data-primary="HARFANG" data-type="indexterm" id="id1019"/></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://docs.panda3d.org">Panda3D</a><a data-primary="Panda3D" data-type="indexterm" id="id1020"/></p>&#13;
</li>&#13;
</ul>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>But I’m not going to use any of these in this chapter.&#13;
The example code can get so large and complex that it&#13;
overshadows the goal of this book:&#13;
creating websites—APIs and traditional content—with FastAPI,&#13;
as simply as possible.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Splitting Game Logic" data-type="sect1"><div class="sect1" id="id173">&#13;
<h1>Splitting Game Logic</h1>&#13;
&#13;
<p>There are so many ways to write a game.&#13;
<a data-primary="games" data-secondary="splitting logic" data-type="indexterm" id="icd101"/>Who does what, and who keeps what <span class="keep-together">where—the</span> client or the server?&#13;
The web is stateless,&#13;
so each time the client calls the server,&#13;
the server is a total amnesiac&#13;
and swears it’s never seen this client before.&#13;
So we need to keep <em>state</em> somewhere:&#13;
data retained across game&#13;
steps to thread them all together.</p>&#13;
&#13;
<p>We could write a game completely in JavaScript on the client side,&#13;
and keep all the state there.&#13;
If you know JavaScript well, that’s a good solution,&#13;
but if you don’t&#13;
(a possibility, because you’re reading a Python book),&#13;
let’s give Python something to do too.</p>&#13;
&#13;
<p>At the other extreme,&#13;
we could write a server-heavy application:&#13;
generate some distinct id for this particular game&#13;
on an initial web call,&#13;
and pass that id with other data to the server&#13;
in subsequent game steps,&#13;
and maintain all that changing state in some server-side data store,&#13;
like a database.</p>&#13;
&#13;
<p>Finally, we could structure the game as&#13;
a sequence of client-server web endpoint calls, in a so-called&#13;
<a data-primary="single-page application (SPA)" data-type="indexterm" id="id1021"/><a data-primary="SPA (single-page application)" data-type="indexterm" id="id1022"/>single-page application (SPA).&#13;
Writing an SPA would typically have JavaScript making&#13;
Ajax calls to a server, and targeting the web responses to&#13;
refresh parts of the page instead of the&#13;
whole display.&#13;
The client JavaScript and HTML do some of the work,&#13;
and the server handles some of the logic and data.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Game Design" data-type="sect1"><div class="sect1" id="id230">&#13;
<h1>Game Design</h1>&#13;
&#13;
<p>First, what’s the game?&#13;
<a data-primary="games" data-secondary="example game" data-type="indexterm" id="icd102"/>We’ll build a simple <a href="https://oreil.ly/PuD-Y">Wordle-like game</a>,&#13;
but using only the names of the creatures&#13;
from the <em>cryptid.db</em> database.&#13;
This makes it quite a bit easier than Wordle,&#13;
especially if you cheat and look at <a data-type="xref" href="app02.html#app02">Appendix B</a>.</p>&#13;
&#13;
<p>We’ll use the final, balanced, design approach above:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Let’s use vanilla JavaScript in the client&#13;
instead of well-known JavaScript libraries&#13;
like React, Angular, or even jQuery.</p>&#13;
</li>&#13;
<li>&#13;
<p>A new FastAPI endpoint,  GET <code>/game</code>, initializes the game.&#13;
It gets a random creature’s name from our cryptid database,&#13;
and returns that, embedded as a hidden value&#13;
in a Jinja template file of HTML, CSS,&#13;
and JavaScript.</p>&#13;
</li>&#13;
<li>&#13;
<p>On the client, the newly returned&#13;
HTML and JavaScript display a Wordle-type&#13;
interface. A sequence of boxes appears, one for each letter in the&#13;
hidden creature name.</p>&#13;
</li>&#13;
<li>&#13;
<p>The player types a letter into each box,&#13;
then submits this guess and the hidden true name to the server.&#13;
This is in an AJAX call, using the JavaScript <code>fetch()</code> function.</p>&#13;
</li>&#13;
<li>&#13;
<p>A second new FastAPI endpoint, POST <code>/game</code>, takes this guess&#13;
and actual secret name and scores the guess against that name.&#13;
It returns the guess and score to the client.</p>&#13;
</li>&#13;
<li>&#13;
<p>The client displays the guess and score with appropriate&#13;
CSS colors in a newly generated table row:&#13;
green for a letter in the correct place,&#13;
yellow for a&#13;
letter in the name but another position,&#13;
and gray for a letter&#13;
not occurring in the hidden name.&#13;
The score is a string of single characters, which are used&#13;
as CSS class names to display the correct colors for&#13;
the guess’s letters.</p>&#13;
</li>&#13;
<li>&#13;
<p>If all the letters are green, then celebrate accordingly.&#13;
Otherwise, the client displays a new sequence of text input boxes&#13;
for the next guess, and repeats the steps 4 and later&#13;
until the name is guessed or you give up.&#13;
Most of the cryptid names are not household words, so check <a data-type="xref" href="app02.html#app02">Appendix B</a>&#13;
as needed.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>These rules are slightly different from official Wordle,&#13;
which allows only five-letter dictionary words&#13;
and a limit of six steps.</p>&#13;
&#13;
<p>Don’t get your hopes up.&#13;
Like most of the examples in this book,&#13;
the game logic and design are&#13;
minimal—just enough to get the pieces to work together.&#13;
You can impart much more style and grace,&#13;
given a working base.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Web Part One: Game Initialization" data-type="sect1"><div class="sect1" id="id318">&#13;
<h1>Web Part One: Game Initialization</h1>&#13;
&#13;
<p>We want two new web endpoints.&#13;
We’re using creature names, so we might think of&#13;
naming endpoints like GET <code>/creature/game</code> and POST <code>/creature/game</code>.&#13;
But that won’t work, because we already have similar endpoints&#13;
GET <code>/creature/{name}</code> and POST <code>/creature/{name}</code>, and FastAPI&#13;
will match those first.&#13;
So let’s make a new top-level routing namespace <code>/game</code>,&#13;
and place both new endpoints under it.</p>&#13;
&#13;
<p>The first endpoint in <a data-type="xref" href="#ex1801">Example 18-1</a> initializes the game.&#13;
It needs to get a random creature name from the database,&#13;
and return this with all the client code to implement the&#13;
multistep game logic.&#13;
For this, we’ll use a Jinja template&#13;
(which you saw in <a data-type="xref" href="ch16.html#ch16">Chapter 16</a>)&#13;
that contains HTML, CSS, and JavaScript.</p>&#13;
<div data-type="example" id="ex1801">&#13;
<h5><span class="label">Example 18-1. </span>Web game initialization (<span class="plain">web/game.py</span>)</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">pathlib</code> <code class="kn">import</code> <code class="n">Path</code>&#13;
&#13;
<code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">APIRouter</code><code class="p">,</code> <code class="n">Body</code><code class="p">,</code> <code class="n">Request</code>&#13;
<code class="kn">from</code> <code class="nn">fastapi.templating</code> <code class="kn">import</code> <code class="n">Jinja2Templates</code>&#13;
&#13;
<code class="kn">from</code> <code class="nn">service</code> <code class="kn">import</code> <code class="n">game</code> <code class="k">as</code> <code class="n">service</code>&#13;
&#13;
<code class="n">router</code> <code class="o">=</code> <code class="n">APIRouter</code><code class="p">(</code><code class="n">prefix</code> <code class="o">=</code> <code class="s2">"/game"</code><code class="p">)</code>&#13;
&#13;
<code class="c1"># Initial game request</code>&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">""</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">game_start</code><code class="p">(</code><code class="n">request</code><code class="p">:</code> <code class="n">Request</code><code class="p">):</code>&#13;
    <code class="n">name</code> <code class="o">=</code> <code class="n">service</code><code class="o">.</code><code class="n">get_word</code><code class="p">()</code>&#13;
    <code class="n">top</code> <code class="o">=</code> <code class="n">Path</code><code class="p">(</code><code class="vm">__file__</code><code class="p">)</code><code class="o">.</code><code class="n">resolve</code><code class="p">()</code><code class="o">.</code><code class="n">parents</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code> <code class="c1"># grandparent</code>&#13;
    <code class="n">templates</code> <code class="o">=</code> <code class="n">Jinja2Templates</code><code class="p">(</code><code class="n">directory</code><code class="o">=</code><code class="sa">f</code><code class="s2">"</code><code class="si">{</code><code class="n">top</code><code class="si">}</code><code class="s2">/template"</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">templates</code><code class="o">.</code><code class="n">TemplateResponse</code><code class="p">(</code><code class="s2">"game.html"</code><code class="p">,</code>&#13;
        <code class="p">{</code><code class="s2">"request"</code><code class="p">:</code> <code class="n">request</code><code class="p">,</code> <code class="s2">"word"</code><code class="p">:</code> <code class="n">name</code><code class="p">})</code>&#13;
&#13;
&#13;
<code class="c1"># Subsequent game requests</code>&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">""</code><code class="p">)</code>&#13;
<code class="k">async</code> <code class="k">def</code> <code class="nf">game_step</code><code class="p">(</code><code class="n">word</code><code class="p">:</code> <code class="nb">str</code> <code class="o">=</code> <code class="n">Body</code><code class="p">(),</code> <code class="n">guess</code><code class="p">:</code> <code class="nb">str</code> <code class="o">=</code> <code class="n">Body</code><code class="p">()):</code>&#13;
    <code class="n">score</code> <code class="o">=</code> <code class="n">service</code><code class="o">.</code><code class="n">get_score</code><code class="p">(</code><code class="n">word</code><code class="p">,</code> <code class="n">guess</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">score</code></pre></div>&#13;
&#13;
<p>FastAPI requires the <code>game_start()</code> path function to&#13;
have a <code>request</code> parameter,&#13;
and to pass it to the template as an argument.</p>&#13;
&#13;
<p>Next, in <a data-type="xref" href="#ex1802">Example 18-2</a>,&#13;
hook this <code>/game</code> subrouter into the main module that&#13;
has been overseeing the <code>/explorer</code> and <code>/creature</code> routes.</p>&#13;
<div data-type="example" id="ex1802">&#13;
<h5><span class="label">Example 18-2. </span>Add /game subroute (<span class="plain">web/main.py</span>)</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">FastAPI</code>&#13;
<code class="kn">from</code> <code class="nn">web</code> <code class="kn">import</code> <code class="n">creature</code><code class="p">,</code> <code class="n">explorer</code><code class="p">,</code> <code class="n">game</code>&#13;
&#13;
<code class="n">app</code> <code class="o">=</code> <code class="n">FastAPI</code><code class="p">()</code>&#13;
&#13;
<code class="n">app</code><code class="o">.</code><code class="n">include_router</code><code class="p">(</code><code class="n">explorer</code><code class="o">.</code><code class="n">router</code><code class="p">)</code>&#13;
<code class="n">app</code><code class="o">.</code><code class="n">include_router</code><code class="p">(</code><code class="n">creature</code><code class="o">.</code><code class="n">router</code><code class="p">)</code>&#13;
<code class="n">app</code><code class="o">.</code><code class="n">include_router</code><code class="p">(</code><code class="n">game</code><code class="o">.</code><code class="n">router</code><code class="p">)</code>&#13;
&#13;
<code class="k">if</code> <code class="vm">__name__</code> <code class="o">==</code> <code class="s2">"__main__"</code><code class="p">:</code>&#13;
    <code class="kn">import</code> <code class="nn">uvicorn</code>&#13;
    <code class="n">uvicorn</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="s2">"main:app"</code><code class="p">,</code>&#13;
        <code class="n">host</code><code class="o">=</code><code class="s2">"localhost"</code><code class="p">,</code> <code class="n">port</code><code class="o">=</code><code class="mi">8000</code><code class="p">,</code> <code class="n">reload</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Web Part Two: Game Steps" data-type="sect1"><div class="sect1" id="id319">&#13;
<h1>Web Part Two: Game Steps</h1>&#13;
&#13;
<p>The largest component of the client side template&#13;
(HTML, CSS, and JavaScript) can be seen in <a data-type="xref" href="#ex1803">Example 18-3</a>.</p>&#13;
<div data-type="example" id="ex1803">&#13;
<h5><span class="label">Example 18-3. </span>Working Jinja template file (<span class="plain">template/game.html</span>)</h5>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting"><code class="p">&lt;</code><code class="nt">head</code><code class="p">&gt;</code>&#13;
<code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code>&#13;
<code class="nt">html</code> <code class="o">*</code> <code class="p">{</code>&#13;
  <code class="k">font-size</code><code class="o">:</code> <code class="m">20pt</code><code class="p">;</code>&#13;
  <code class="k">font-family</code><code class="o">:</code> <code class="n">Courier</code><code class="o">,</code> <code class="nb">sans-serif</code><code class="p">;</code>&#13;
<code class="p">}</code>&#13;
<code class="nt">body</code> <code class="p">{</code>&#13;
  <code class="k">margin</code><code class="o">:</code> <code class="m">0</code> <code class="nb">auto</code><code class="p">;</code>&#13;
  <code class="k">max-width</code><code class="o">:</code> <code class="m">700px</code><code class="p">;</code>&#13;
<code class="p">}</code>&#13;
<code class="nt">input</code><code class="o">[</code><code class="nt">type</code><code class="o">=</code><code class="nt">text</code><code class="o">]</code> <code class="p">{</code>&#13;
  <code class="k">width</code><code class="o">:</code> <code class="m">30px</code><code class="p">;</code>&#13;
  <code class="k">margin</code><code class="o">:</code> <code class="m">1px</code><code class="p">;</code>&#13;
  <code class="k">padding</code><code class="o">:</code> <code class="m">0px</code><code class="p">;</code>&#13;
  <code class="k">border</code><code class="o">:</code> <code class="m">1px</code> <code class="nb">solid</code> <code class="nb">black</code><code class="p">;</code>&#13;
<code class="p">}</code>&#13;
<code class="nt">td</code><code class="o">,</code> <code class="nt">th</code> <code class="p">{</code>&#13;
  <code class="n">cell</code><code class="o">-</code><code class="n">spacing</code><code class="o">:</code> <code class="m">4pt</code><code class="p">;</code>&#13;
  <code class="n">cell</code><code class="o">-</code><code class="k">padding</code><code class="o">:</code> <code class="m">4pt</code><code class="p">;</code>&#13;
  <code class="k">border</code><code class="o">:</code> <code class="m">1px</code> <code class="nb">solid</code> <code class="nb">black</code><code class="p">;</code>&#13;
<code class="p">}</code>&#13;
<code class="nc">.H</code> <code class="p">{</code> <code class="k">background-color</code><code class="o">:</code> <code class="m">#00EE00</code><code class="p">;</code> <code class="p">}</code> <code class="c">/* hit (green) */</code>&#13;
<code class="nc">.C</code> <code class="p">{</code> <code class="k">background-color</code><code class="o">:</code> <code class="m">#EEEE00</code><code class="p">;</code> <code class="p">}</code> <code class="c">/* close (yellow) */</code>&#13;
<code class="nc">.M</code> <code class="p">{</code> <code class="k">background-color</code><code class="o">:</code> <code class="m">#EEEEEE</code><code class="p">;</code> <code class="p">}</code> <code class="c">/* miss (gray) */</code>&#13;
<code class="nt">&lt;/style&gt;</code>&#13;
<code class="p">&lt;/</code><code class="nt">head</code><code class="p">&gt;</code>&#13;
<code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>&#13;
<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code><code class="w"/>&#13;
<code class="kd">function</code><code class="w"> </code><code class="nx">show_score</code><code class="p">(</code><code class="nx">guess</code><code class="p">,</code><code class="w"> </code><code class="nx">score</code><code class="p">){</code><code class="w"/>&#13;
<code class="w">    </code><code class="kd">var</code><code class="w"> </code><code class="nx">table</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s2">"guesses"</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="kd">var</code><code class="w"> </code><code class="nx">row</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nx">table</code><code class="p">.</code><code class="nx">insertRow</code><code class="p">(</code><code class="nx">row</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="p">(</code><code class="kd">var</code><code class="w"> </code><code class="nx">i</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="mf">0</code><code class="p">;</code><code class="w"> </code><code class="nx">i</code><code class="w"> </code><code class="o">&lt;</code><code class="w"> </code><code class="nx">guess</code><code class="p">.</code><code class="nx">length</code><code class="p">;</code><code class="w"> </code><code class="nx">i</code><code class="o">++</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="kd">var</code><code class="w"> </code><code class="nx">cell</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nx">row</code><code class="p">.</code><code class="nx">insertCell</code><code class="p">(</code><code class="nx">i</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">        </code><code class="nx">cell</code><code class="p">.</code><code class="nx">innerHTML</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nx">guess</code><code class="p">[</code><code class="nx">i</code><code class="p">];</code><code class="w"/>&#13;
<code class="w">        </code><code class="nx">cell</code><code class="p">.</code><code class="nx">classList</code><code class="p">.</code><code class="nx">add</code><code class="p">(</code><code class="nx">score</code><code class="p">[</code><code class="nx">i</code><code class="p">]);</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="kd">var</code><code class="w"> </code><code class="nx">word</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s2">"word"</code><code class="p">).</code><code class="nx">value</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="p">(</code><code class="nx">guess</code><code class="p">.</code><code class="nx">toLowerCase</code><code class="p">()</code><code class="w"> </code><code class="o">==</code><code class="w"> </code><code class="nx">word</code><code class="p">.</code><code class="nx">toLowerCase</code><code class="p">())</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s2">"status"</code><code class="p">).</code><code class="nx">innerHTML</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"&amp;#x1F600"</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/>&#13;
&#13;
<code class="k">async</code><code class="w"> </code><code class="kd">function</code><code class="w"> </code><code class="nx">post_guess</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="kd">var</code><code class="w"> </code><code class="nx">word</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s2">"word"</code><code class="p">).</code><code class="nx">value</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">    </code><code class="kd">var</code><code class="w"> </code><code class="nx">vals</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">document</code><code class="p">.</code><code class="nx">getElementsByName</code><code class="p">(</code><code class="s2">"guess"</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">    </code><code class="kd">var</code><code class="w"> </code><code class="nx">guess</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">""</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="p">(</code><code class="kd">var</code><code class="w"> </code><code class="nx">i</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="mf">0</code><code class="p">;</code><code class="w"> </code><code class="nx">i</code><code class="w"> </code><code class="o">&lt;</code><code class="w"> </code><code class="nx">vals</code><code class="p">.</code><code class="nx">length</code><code class="p">;</code><code class="w"> </code><code class="nx">i</code><code class="o">++</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="nx">guess</code><code class="w"> </code><code class="o">+=</code><code class="w"> </code><code class="nx">vals</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">value</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="kd">var</code><code class="w"> </code><code class="nx">req</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="ow">new</code><code class="w"> </code><code class="nx">Request</code><code class="p">(</code><code class="s2">"http://localhost:8000/game"</code><code class="p">,</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="nx">method</code><code class="o">:</code><code class="w"> </code><code class="s2">"POST"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nx">headers</code><code class="o">:</code><code class="w"> </code><code class="p">{</code><code class="s2">"Content-Type"</code><code class="o">:</code><code class="w"> </code><code class="s2">"application/json"</code><code class="p">},</code><code class="w"/>&#13;
<code class="w">        </code><code class="nx">body</code><code class="o">:</code><code class="w"> </code><code class="nb">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">({</code><code class="s2">"guess"</code><code class="o">:</code><code class="w"> </code><code class="nx">guess</code><code class="p">,</code><code class="w"> </code><code class="s2">"word"</code><code class="o">:</code><code class="w"> </code><code class="nx">word</code><code class="p">})</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">     </code><code class="p">)</code><code class="w"/>&#13;
<code class="w">     </code><code class="nx">fetch</code><code class="p">(</code><code class="nx">req</code><code class="p">)</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">.</code><code class="nx">then</code><code class="p">((</code><code class="nx">resp</code><code class="p">)</code><code class="w"> </code><code class="p">=&gt;</code><code class="w"> </code><code class="nx">resp</code><code class="p">.</code><code class="nx">json</code><code class="p">())</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">.</code><code class="nx">then</code><code class="p">((</code><code class="nx">score</code><code class="p">)</code><code class="w"> </code><code class="p">=&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">            </code><code class="nx">show_score</code><code class="p">(</code><code class="nx">guess</code><code class="p">,</code><code class="w"> </code><code class="nx">score</code><code class="p">);</code><code class="w"/>&#13;
<code class="w">            </code><code class="k">for</code><code class="w"> </code><code class="p">(</code><code class="kd">var</code><code class="w"> </code><code class="nx">i</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="mf">0</code><code class="p">;</code><code class="w"> </code><code class="nx">i</code><code class="w"> </code><code class="o">&lt;</code><code class="w"> </code><code class="nx">vals</code><code class="p">.</code><code class="nx">length</code><code class="p">;</code><code class="w"> </code><code class="nx">i</code><code class="o">++</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">                </code><code class="nx">vals</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">value</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">""</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">            </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">         </code><code class="p">});</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/>&#13;
<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>&#13;
<code class="p">&lt;</code><code class="nt">h2</code><code class="p">&gt;</code>Cryptonamicon<code class="p">&lt;/</code><code class="nt">h2</code><code class="p">&gt;</code>&#13;
&#13;
<code class="p">&lt;</code><code class="nt">table</code> <code class="na">id</code><code class="o">=</code><code class="s">"guesses"</code><code class="p">&gt;</code>&#13;
<code class="p">&lt;/</code><code class="nt">table</code><code class="p">&gt;</code>&#13;
&#13;
<code class="p">&lt;</code><code class="nt">span</code> <code class="na">id</code><code class="o">=</code><code class="s">"status"</code><code class="p">&gt;&lt;/</code><code class="nt">span</code><code class="p">&gt;</code>&#13;
&#13;
<code class="p">&lt;</code><code class="nt">hr</code><code class="p">&gt;</code>&#13;
&#13;
<code class="p">&lt;</code><code class="nt">div</code><code class="p">&gt;</code>&#13;
{% for letter in word %}<code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">text</code> <code class="na">name</code><code class="o">=</code><code class="s">"guess"</code><code class="p">&gt;</code>{% endfor %}&#13;
<code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">hidden</code> <code class="na">id</code><code class="o">=</code><code class="s">"word"</code> <code class="na">value</code><code class="o">=</code><code class="s">"{{word}}"</code><code class="p">&gt;</code>&#13;
<code class="p">&lt;</code><code class="nt">br</code><code class="p">&gt;&lt;</code><code class="nt">br</code><code class="p">&gt;</code>&#13;
<code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">submit</code> <code class="na">onclick</code><code class="o">=</code><code class="s">"post_guess()"</code><code class="p">&gt;</code>&#13;
<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>&#13;
&#13;
<code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Service Part One: Initialization" data-type="sect1"><div class="sect1" id="id320">&#13;
<h1>Service Part One: Initialization</h1>&#13;
&#13;
<p><a data-type="xref" href="#ex1804">Example 18-4</a> shows the Service code to connect the Web layer’s&#13;
game start function to the Data layer’s provision of a random&#13;
creature name.</p>&#13;
<div data-type="example" id="ex1804">&#13;
<h5><span class="label">Example 18-4. </span>Calculate score (<span class="plain">service/game.py</span>)</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">data.game</code> <code class="k">as</code> <code class="nn">data</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">get_word</code><code class="p">()</code> <code class="o">-&gt;</code> <code class="nb">str</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">data</code><code class="o">.</code><code class="n">get_word</code><code class="p">()</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Service Part Two: Scoring" data-type="sect1"><div class="sect1" id="id321">&#13;
<h1>Service Part Two: Scoring</h1>&#13;
&#13;
<p>Add the code from <a data-type="xref" href="#ex1805">Example 18-5</a> (next) to that of <a data-type="xref" href="#ex1804">Example 18-4</a>.&#13;
The score is a string of single characters that indicate&#13;
whether the guessed letter matched in the correct position,&#13;
matched in another position,&#13;
or was a miss.&#13;
The guess and word are both converted to lowercase to&#13;
make matching case-insensitive.&#13;
If the guess is not the same length as the hidden word,&#13;
an empty string score is returned.</p>&#13;
<div data-type="example" id="ex1805">&#13;
<h5><span class="label">Example 18-5. </span>Calculate score (<span class="plain">service/game.py</span>)</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">collections</code> <code class="kn">import</code> <code class="n">Counter</code><code class="p">,</code> <code class="n">defaultdict</code>&#13;
&#13;
<code class="n">HIT</code> <code class="o">=</code> <code class="s2">"H"</code>&#13;
<code class="n">MISS</code> <code class="o">=</code> <code class="s2">"M"</code>&#13;
<code class="n">CLOSE</code> <code class="o">=</code> <code class="s2">"C"</code>  <code class="c1"># (letter is in the word, but at another position)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">get_score</code><code class="p">(</code><code class="n">actual</code><code class="p">:</code> <code class="nb">str</code><code class="p">,</code> <code class="n">guess</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">str</code><code class="p">:</code>&#13;
    <code class="n">length</code><code class="p">:</code> <code class="nb">int</code> <code class="o">=</code> <code class="nb">len</code><code class="p">(</code><code class="n">actual</code><code class="p">)</code>&#13;
    <code class="k">if</code> <code class="nb">len</code><code class="p">(</code><code class="n">guess</code><code class="p">)</code> <code class="o">!=</code> <code class="n">length</code><code class="p">:</code>&#13;
        <code class="k">return</code> <code class="n">ERROR</code>&#13;
    <code class="n">actual_counter</code> <code class="o">=</code> <code class="n">Counter</code><code class="p">(</code><code class="n">actual</code><code class="p">)</code> <code class="c1">#  {letter: count, ...}</code>&#13;
    <code class="n">guess_counter</code> <code class="o">=</code> <code class="n">defaultdict</code><code class="p">(</code><code class="nb">int</code><code class="p">)</code>&#13;
    <code class="n">result</code> <code class="o">=</code> <code class="p">[</code><code class="n">MISS</code><code class="p">]</code> <code class="o">*</code> <code class="n">length</code>&#13;
    <code class="k">for</code> <code class="n">pos</code><code class="p">,</code> <code class="n">letter</code> <code class="ow">in</code> <code class="nb">enumerate</code><code class="p">(</code><code class="n">guess</code><code class="p">):</code>&#13;
        <code class="k">if</code> <code class="n">letter</code> <code class="o">==</code> <code class="n">actual</code><code class="p">[</code><code class="n">pos</code><code class="p">]:</code>&#13;
            <code class="n">result</code><code class="p">[</code><code class="n">pos</code><code class="p">]</code> <code class="o">=</code> <code class="n">HIT</code>&#13;
            <code class="n">guess_counter</code><code class="p">[</code><code class="n">letter</code><code class="p">]</code> <code class="o">+=</code> <code class="mi">1</code>&#13;
    <code class="k">for</code> <code class="n">pos</code><code class="p">,</code> <code class="n">letter</code> <code class="ow">in</code> <code class="nb">enumerate</code><code class="p">(</code><code class="n">guess</code><code class="p">):</code>&#13;
        <code class="k">if</code> <code class="n">result</code><code class="p">[</code><code class="n">pos</code><code class="p">]</code> <code class="o">==</code> <code class="n">HIT</code><code class="p">:</code>&#13;
            <code class="k">continue</code>&#13;
        <code class="n">guess_counter</code><code class="p">[</code><code class="n">letter</code><code class="p">]</code> <code class="o">+=</code> <code class="mi">1</code>&#13;
        <code class="k">if</code> <code class="p">(</code><code class="n">letter</code> <code class="ow">in</code> <code class="n">actual</code> <code class="ow">and</code>&#13;
            <code class="n">guess_counter</code><code class="p">[</code><code class="n">letter</code><code class="p">]</code> <code class="o">&lt;=</code> <code class="n">actual_counter</code><code class="p">[</code><code class="n">letter</code><code class="p">]):</code>&#13;
            <code class="n">result</code><code class="p">[</code><code class="n">pos</code><code class="p">]</code> <code class="o">=</code> <code class="n">CLOSE</code>&#13;
    <code class="n">result</code> <code class="o">=</code> <code class="s1">''</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="n">result</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">result</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Test!" data-type="sect1"><div class="sect1" id="id322">&#13;
<h1>Test!</h1>&#13;
&#13;
<p><a data-type="xref" href="#ex1806">Example 18-6</a> contains some pytest exercises for the&#13;
service score calculation.&#13;
It uses pytest’s <code>parametrize</code> feature to pass in&#13;
a sequence of tests, rather than writing a loop&#13;
inside the test function itself.&#13;
Remember from <a data-type="xref" href="#ex1805">Example 18-5</a> that <code>H</code> is a direct hit,&#13;
<code>C</code> is close (wrong position), and <code>M</code> is a miss.</p>&#13;
<div data-type="example" id="ex1806">&#13;
<h5><span class="label">Example 18-6. </span>Test score calculation (<span class="plain">test/unit/service/test_game.py</span>)</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">pytest</code>&#13;
<code class="kn">from</code> <code class="nn">service</code> <code class="kn">import</code> <code class="n">game</code>&#13;
&#13;
<code class="n">word</code> <code class="o">=</code> <code class="s2">"bigfoot"</code>&#13;
<code class="n">guesses</code> <code class="o">=</code> <code class="p">[</code>&#13;
    <code class="p">(</code><code class="s2">"bigfoot"</code><code class="p">,</code> <code class="s2">"HHHHHHH"</code><code class="p">),</code>&#13;
    <code class="p">(</code><code class="s2">"abcdefg"</code><code class="p">,</code> <code class="s2">"MCMMMCC"</code><code class="p">),</code>&#13;
    <code class="p">(</code><code class="s2">"toofgib"</code><code class="p">,</code> <code class="s2">"CCCHCCC"</code><code class="p">),</code>&#13;
    <code class="p">(</code><code class="s2">"wronglength"</code><code class="p">,</code> <code class="s2">""</code><code class="p">),</code>&#13;
    <code class="p">(</code><code class="s2">""</code><code class="p">,</code> <code class="s2">""</code><code class="p">),</code>&#13;
    <code class="p">]</code>&#13;
&#13;
<code class="nd">@pytest</code><code class="o">.</code><code class="n">mark</code><code class="o">.</code><code class="n">parametrize</code><code class="p">(</code><code class="s2">"guess,score"</code><code class="p">,</code> <code class="n">guesses</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">test_match</code><code class="p">(</code><code class="n">guess</code><code class="p">,</code> <code class="n">score</code><code class="p">):</code>&#13;
    <code class="k">assert</code> <code class="n">game</code><code class="o">.</code><code class="n">get_score</code><code class="p">(</code><code class="n">word</code><code class="p">,</code> <code class="n">guess</code><code class="p">)</code> <code class="o">==</code> <code class="n">score</code></pre></div>&#13;
&#13;
<p>Run it:</p>&#13;
&#13;
<pre data-type="programlisting">$ <strong>pytest -q test_game.py</strong>&#13;
.....                                               [100%]&#13;
5 passed in 0.05s</pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Data: Initialization" data-type="sect1"><div class="sect1" id="id323">&#13;
<h1>Data: Initialization</h1>&#13;
&#13;
<p>We only need one function in the new <em>data/game.py</em> module, shown&#13;
in <a data-type="xref" href="#ex1807">Example 18-7</a>.</p>&#13;
<div data-type="example" id="ex1807">&#13;
<h5><span class="label">Example 18-7. </span>Get random creature name (<span class="plain">data/game.py</span>)</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">.init</code> <code class="kn">import</code> <code class="n">curs</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">get_word</code><code class="p">()</code> <code class="o">-&gt;</code> <code class="nb">str</code><code class="p">:</code>&#13;
    <code class="n">qry</code> <code class="o">=</code> <code class="s2">"select name from creature order by random() limit 1"</code>&#13;
    <code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">qry</code><code class="p">)</code>&#13;
    <code class="n">row</code> <code class="o">=</code> <code class="n">curs</code><code class="o">.</code><code class="n">fetchone</code><code class="p">()</code>&#13;
    <code class="k">if</code> <code class="n">row</code><code class="p">:</code>&#13;
        <code class="n">name</code> <code class="o">=</code> <code class="n">row</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code>&#13;
    <code class="k">else</code><code class="p">:</code>&#13;
        <code class="n">name</code> <code class="o">=</code> <code class="s2">"bigfoot"</code>&#13;
    <code class="k">return</code> <code class="n">name</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Let’s Play Cryptonamicon" data-type="sect1"><div class="sect1" id="id324">&#13;
<h1>Let’s Play Cryptonamicon</h1>&#13;
&#13;
<p>(Someone, please come up with a better name.)</p>&#13;
&#13;
<p>In your browser, go to <code>http://localhost:8000/game</code>.&#13;
You should see an initial display like this:</p>&#13;
&#13;
<figure><div class="figure">&#13;
<img alt="fapi 18in01" src="assets/fapi_18in01.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
&#13;
<p class="pagebreak-before">Let’s type a few letters and submit them as a guess to see what happens:</p>&#13;
&#13;
<figure><div class="figure">&#13;
<img alt="fapi 18in02" src="assets/fapi_18in02.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
&#13;
<p>The letters <em>b</em>, <em>f</em>, and <em>g</em> are yellow (if you’re not viewing this in color, you’ll have to take my word for it!), meaning they’re in the hidden name but in the wrong position:</p>&#13;
&#13;
<figure><div class="figure">&#13;
<img alt="fapi 18in03" src="assets/fapi_18in03.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
&#13;
<p>Let’s take a stab at the name, but flub the last letter. We see lots of green on the second line. Oh, so close!</p>&#13;
&#13;
<figure><div class="figure">&#13;
<img alt="fapi 18in04" src="assets/fapi_18in04.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
&#13;
<p>Let’s fix that last letter,&#13;
and just for fun, capitalize some of the letters to&#13;
ensure that we get case-insensitive matching. Submit that one now, and golly gee:</p>&#13;
&#13;
<figure><div class="figure">&#13;
<img alt="fapi 18in05" src="assets/fapi_18in05.png"/>&#13;
<h6/>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Review" data-type="sect1"><div class="sect1" id="id174">&#13;
<h1>Review</h1>&#13;
&#13;
<p>We used HTML, JavaScript, CSS,&#13;
and FastAPI to build a (very!) simple interactive&#13;
Wordle-style game.&#13;
This chapter demonstrated how to manage multiple threaded conversations between a web client and server, using JSON and Ajax<a data-primary="games" data-startref="icd100" data-type="indexterm" id="id1023"/>.<a data-primary="games" data-secondary="splitting logic" data-startref="icd101" data-type="indexterm" id="id1024"/><a data-primary="games" data-secondary="example game" data-startref="icd102" data-type="indexterm" id="id1025"/></p>&#13;
</div></section>&#13;
</div></section></body></html>