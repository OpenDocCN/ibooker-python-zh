<html><head></head><body><section data-pdf-bookmark="Chapter 18. Testing Your Website with Scrapers" data-type="chapter" epub:type="chapter"><div class="chapter" id="c-18">&#13;
<h1><span class="label">Chapter 18. </span>Testing Your Website with Scrapers</h1>&#13;
&#13;
<p>When working with web projects that have a large development stack, it’s often only the “back” of the stack that ever gets tested regularly. Most programming languages today (including Python) have some type of test framework, but website frontends are often left out of these automated tests, although they might be the only customer-facing part of the project.</p>&#13;
&#13;
<p>Part of the problem is that websites are often a mishmash of many markup languages and programming languages. You can write unit tests for sections of your JavaScript, but it’s useless if the HTML it’s interacting with has changed in such a way that the JavaScript doesn’t have the intended action on the page, even if it’s working correctly.</p>&#13;
&#13;
<p>The problem of frontend website testing has often been left as an afterthought or delegated to lower-level programmers armed with, at most, a checklist and a bug tracker. However, with just a little more up-front effort, you can replace this checklist with a series of unit tests and replace human eyes with a web scraper.</p>&#13;
&#13;
<p>Imagine: test-driven development for web development. Daily tests to make sure all parts of the web interface are functioning as expected. A suite of tests run every time someone adds a new website feature or changes the position of an element. This chapter covers the basics of testing and how to test all sorts of websites, from simple to complicated, with Python-based web scrapers.</p>&#13;
&#13;
<section data-pdf-bookmark="An Introduction to Testing" data-type="sect1"><div class="sect1" id="id253">&#13;
<h1 class="pagebreak-before less_space">An Introduction to Testing</h1>&#13;
&#13;
<p>If you’ve never written tests for your code before, there’s no better time to start than now. Having a suite of tests that can be run to ensure that your code performs as expected (at least, as far as you’ve written tests for) saves you time and worry and makes releasing new updates easy.</p>&#13;
&#13;
<section data-pdf-bookmark="What Are Unit Tests?" data-type="sect2"><div class="sect2" id="id115">&#13;
<h2>What Are Unit Tests?</h2>&#13;
&#13;
<p>The words <em>test</em> and <em>unit test</em> are often <a contenteditable="false" data-primary="testing" data-secondary="unit testing" data-seealso="unit testing" data-type="indexterm" id="tsutt"/><a contenteditable="false" data-primary="unit testing" data-type="indexterm" id="untttg"/>used interchangeably. Often, when programmers refer to “writing tests,” what they really mean is “writing unit tests.” On the other hand, when some programmers refer to writing unit tests, they’re really writing some other kind of test.</p>&#13;
&#13;
<p>Although definitions and practices tend to vary from company to company, a unit test generally has the following characteristics:</p>&#13;
&#13;
<ul>&#13;
	<li>&#13;
	<p>Each unit test tests one aspect of the functionality of a component. For example, it might ensure that the appropriate error message is thrown if a negative number of dollars is withdrawn from a bank account.</p>&#13;
&#13;
	<p>Often, unit tests are grouped together in the same class, based on the component they are testing. You might have the test for a negative dollar value being withdrawn from a bank account, followed by a unit test for the behavior of an overdrawn bank account.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Each unit test can be run completely independently, and any setup or teardown required for the unit test must be handled by the unit test itself. Similarly, unit tests must not interfere with the success or failure of other tests, and they must be able to run successfully in any order.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Each unit test usually contains at least one <em>assertion.</em> For example, a unit test might assert that the answer to 2 + 2 is 4. Occasionally, a unit test might contain only a failure state. For example, it might fail if an exception is thrown but pass by default if everything goes smoothly.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Unit tests are separated from the bulk of the code. Although they necessarily need to import and use the code they are testing, they are generally kept in separate classes and directories.</p>&#13;
	</li>&#13;
</ul>&#13;
&#13;
<p class="pagebreak-before">Although many other types of tests can be written—integration tests and validation tests, for example—this chapter primarily focuses on unit testing. Not only have unit tests become extremely popular with recent pushes toward test-driven development, but their length and flexibility make them easy to work with as examples, and Python has some built-in unit testing capabilities, as you’ll see in the <a contenteditable="false" data-primary="testing" data-secondary="unit testing" data-seealso="unit testing" data-startref="tsutt" data-type="indexterm" id="id878"/><a contenteditable="false" data-primary="unit testing" data-startref="untttg" data-type="indexterm" id="id879"/>next section.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Python unittest" data-type="sect1"><div class="sect1" id="id116">&#13;
<h1>Python unittest</h1>&#13;
&#13;
<p>Python’s unit-testing module, <code>unittest</code>, comes <a contenteditable="false" data-primary="testing" data-secondary="unit testing" data-tertiary="Python unittest" data-type="indexterm" id="ttgutt"/><a contenteditable="false" data-primary="unit testing" data-secondary="unittest (Python)" data-type="indexterm" id="utestest"/><a contenteditable="false" data-primary="unittest (Python)" data-type="indexterm" id="utnsti"/>packaged with all standard Python installations. Just import and extend <code>unittest.TestCase</code>, and it will:</p>&#13;
&#13;
<ul>&#13;
	<li>&#13;
	<p>Provide <code>setUp</code> and <code>tearDown</code> functions that run before and after each unit test</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Provide several types of “assert” statements to allow tests to pass or fail</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Run all functions that begin with <code>test_</code> as unit tests and ignore functions that are not prepended as tests</p>&#13;
	</li>&#13;
</ul>&#13;
&#13;
<p>The following provides a simple unit test for ensuring that 2 + 2 = 4, according to Python:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="kn">import</code> <code class="nn">unittest</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">TestAddition</code><code class="p">(</code><code class="n">unittest</code><code class="o">.</code><code class="n">TestCase</code><code class="p">):</code>&#13;
    <code class="k">def</code> <code class="nf">setUp</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
        <code class="nb">print</code><code class="p">(</code><code class="s1">'Setting up the test'</code><code class="p">)</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">tearDown</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
        <code class="nb">print</code><code class="p">(</code><code class="s1">'Tearing down the test'</code><code class="p">)</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">test_twoPlusTwo</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
        <code class="n">total</code> <code class="o">=</code> <code class="mi">2</code><code class="o">+</code><code class="mi">2</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">assertEqual</code><code class="p">(</code><code class="mi">4</code><code class="p">,</code> <code class="n">total</code><code class="p">);</code>&#13;
&#13;
<code class="k">if</code> <code class="vm">__name__</code> <code class="o">==</code> <code class="s1">'__main__'</code><code class="p">:</code>&#13;
    <code class="n">unittest</code><code class="o">.</code><code class="n">main</code><code class="p">()</code></pre>&#13;
&#13;
<p>Although <code>setUp</code> and <code>tearDown</code> don’t provide any useful functionality here, they are included for illustration purposes. Note that these functions are run before and after each individual test, not before and after all the tests in the class.</p>&#13;
&#13;
<p class="pagebreak-before">The output of the test function, when run from the command line, should look like this:</p>&#13;
&#13;
<pre data-code-language="text" data-type="programlisting">&#13;
Setting up the test&#13;
Tearing down the test&#13;
.&#13;
----------------------------------------------------------------------&#13;
Ran 1 test in 0.000s&#13;
&#13;
OK&#13;
</pre>&#13;
&#13;
<p>This indicates that the test ran successfully, and 2 + 2 does indeed equal 4.</p>&#13;
&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id880">&#13;
<h1>Running unittest in Jupyter Notebooks</h1>&#13;
&#13;
<p>The unit test scripts in this chapter are all kicked off with:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="k">if</code> <code class="vm">__name__</code> <code class="o">==</code> <code class="s1">'__main__'</code><code class="p">:</code>&#13;
    <code class="n">unittest</code><code class="o">.</code><code class="n">main</code><code class="p">()</code></pre>&#13;
&#13;
<p>The line if <code>__name__ == '__main__'</code> is true only if the line is executed directly in Python and not via an <code>import</code> statement. This allows you to run your unit test, using the <code>unittest.TestCase</code> class that it extends, directly from the command line.</p>&#13;
&#13;
<p>In a Jupyter notebook, things are a little bit different. The <code>argv</code> parameters created by Jupyter can cause <a contenteditable="false" data-primary="Jupyter" data-secondary="Notebooks" data-tertiary="unit testing" data-type="indexterm" id="id881"/><a contenteditable="false" data-primary="testing" data-secondary="unit testing" data-tertiary="Jupyter Notebook" data-type="indexterm" id="id882"/><a contenteditable="false" data-primary="unit testing" data-secondary="Jupyter Notebook" data-type="indexterm" id="id883"/>errors in the unit test, and because the <code>unittest</code> framework exits Python by default after the test is run (which causes problems in the notebook kernel), we also need to prevent that from happening.</p>&#13;
&#13;
<p>In the Jupyter notebooks, you will use the following to launch unit tests:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="k">if</code> <code class="vm">__name__</code> <code class="o">==</code> <code class="s1">'__main__'</code><code class="p">:</code>&#13;
    <code class="n">unittest</code><code class="o">.</code><code class="n">main</code><code class="p">(</code><code class="n">argv</code><code class="o">=</code><code class="p">[</code><code class="s1">''</code><code class="p">],</code> <code class="n">exit</code><code class="o">=</code><code class="kc">False</code><code class="p">)</code>&#13;
    <code class="o">%</code><code class="n">reset</code></pre>&#13;
&#13;
<p>The second line sets all of the <code>argv</code> variables (command-line arguments) to a single empty string, which is ignored by <code>unnittest.main</code>. It also prevents <code>unittest</code> from exiting after the test is run.</p>&#13;
&#13;
<p>The <code>%reset</code> line is useful because it resets the memory and destroys all user-created variables in the Jupyter notebook. Without it, each unit test you write in the notebook will contain all of the methods from all other previously run tests that also inherited <code>unittest.TestCase</code>, including <code>setUp</code> and <code>tearDown</code> methods. This also means that each unit test would run all of the methods from the unit tests before it!</p>&#13;
&#13;
<p>Using <code>%reset</code> does create one extra manual step for the user when running the tests. When running the test, the notebook will prompt the user if they’re sure they want to reset the memory. Simply <a contenteditable="false" data-primary="testing" data-secondary="unit testing" data-startref="ttgutt" data-tertiary="Python unittest" data-type="indexterm" id="id884"/><a contenteditable="false" data-primary="unit testing" data-secondary="unittest (Python)" data-startref="utestest" data-type="indexterm" id="id885"/><a contenteditable="false" data-primary="unittest (Python)" data-startref="utnsti" data-type="indexterm" id="id886"/>type <code><strong>y</strong></code> and hit Enter to do this.</p>&#13;
</div></aside>&#13;
&#13;
<section data-pdf-bookmark="Testing Wikipedia" data-type="sect2"><div class="sect2" id="id171">&#13;
<h2>Testing Wikipedia</h2>&#13;
&#13;
<p>Testing the frontend of your website (excluding JavaScript, which we’ll cover next) is as simple as combining <a contenteditable="false" data-primary="testing" data-secondary="Wikipedia" data-type="indexterm" id="tstwkp"/><a contenteditable="false" data-primary="Wikipedia" data-secondary="testing" data-type="indexterm" id="wkpdtt"/>the Python <code>unittest</code> library with a web scraper:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="kn">from</code> <code class="nn">urllib.request</code> <code class="kn">import</code> <code class="n">urlopen</code>&#13;
<code class="kn">from</code> <code class="nn">bs4</code> <code class="kn">import</code> <code class="n">BeautifulSoup</code>&#13;
<code class="kn">import</code> <code class="nn">unittest</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">TestWikipedia</code><code class="p">(</code><code class="n">unittest</code><code class="o">.</code><code class="n">TestCase</code><code class="p">):</code>&#13;
    <code class="n">bs</code> <code class="o">=</code> <code class="kc">None</code>&#13;
    <code class="k">def</code> <code class="nf">setUpClass</code><code class="p">():</code>&#13;
        <code class="n">url</code> <code class="o">=</code> <code class="s1">'http://en.wikipedia.org/wiki/Monty_Python'</code>&#13;
        <code class="n">TestWikipedia</code><code class="o">.</code><code class="n">bs</code> <code class="o">=</code> <code class="n">BeautifulSoup</code><code class="p">(</code><code class="n">urlopen</code><code class="p">(</code><code class="n">url</code><code class="p">),</code> <code class="s1">'html.parser'</code><code class="p">)</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">test_titleText</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
        <code class="n">pageTitle</code> <code class="o">=</code> <code class="n">TestWikipedia</code><code class="o">.</code><code class="n">bs</code><code class="o">.</code><code class="n">find</code><code class="p">(</code><code class="s1">'h1'</code><code class="p">)</code><code class="o">.</code><code class="n">get_text</code><code class="p">()</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">assertEqual</code><code class="p">(</code><code class="s1">'Monty Python'</code><code class="p">,</code> <code class="n">pageTitle</code><code class="p">);</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">test_contentExists</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
        <code class="n">content</code> <code class="o">=</code> <code class="n">TestWikipedia</code><code class="o">.</code><code class="n">bs</code><code class="o">.</code><code class="n">find</code><code class="p">(</code><code class="s1">'div'</code><code class="p">,{</code><code class="s1">'id'</code><code class="p">:</code><code class="s1">'mw-content-text'</code><code class="p">})</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">assertIsNotNone</code><code class="p">(</code><code class="n">content</code><code class="p">)</code>&#13;
&#13;
&#13;
<code class="k">if</code> <code class="vm">__name__</code> <code class="o">==</code> <code class="s1">'__main__'</code><code class="p">:</code>&#13;
    <code class="n">unittest</code><code class="o">.</code><code class="n">main</code><code class="p">()</code></pre>&#13;
&#13;
<p>There are two tests this time: the first tests whether the title of the page is the expected “Monty Python,” and the second makes sure that the page has a content <code>div</code>.</p>&#13;
&#13;
<p>Note that the content of the page is loaded only once, and that the global object <code>bs</code> is shared between tests. This is accomplished by using the <code>unittest</code>-specified function <code>setUpClass</code>, which is run only once at the start of the class (unlike <code>setUp</code>, which is run before every individual test). Using <code>setUpClass</code> instead of <code>setUp</code> saves unnecessary page loads; you can grab the content once and run multiple tests on it.</p>&#13;
&#13;
<p>One major architectural difference between <code>setUpClass</code> and <code>setUp</code>, besides just when and how often they’re run, is that <code>setUpClass</code> is a static method that “belongs” to the class itself and has global class variables, whereas <code>setUp</code> is an instance function that belongs to a particular instance of the class. This is why <code>setUp</code> can set attributes on <code>self</code>—the particular instance of that class—while <code>setUpClass</code> can access only static class attributes on the class <code>TestWikipedia</code>.</p>&#13;
&#13;
<p>Although testing a single page at a time might not seem all that powerful or interesting, as you may recall from <a data-type="xref" href="ch06.html#c-6">Chapter 6</a>, it is relatively easy to build web crawlers that can iteratively move through all pages of a website. What happens when you combine a web crawler with a unit test that makes an assertion about each page?</p>&#13;
&#13;
<p>There are many ways to run a test repeatedly, but you must be careful to load each page only once for each set of tests you want to run on the page, and you must also avoid holding large amounts of information in memory at once. The following setup does just that:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="kn">from</code> <code class="nn">urllib.request</code> <code class="kn">import</code> <code class="n">urlopen</code>&#13;
<code class="kn">from</code> <code class="nn">bs4</code> <code class="kn">import</code> <code class="n">BeautifulSoup</code>&#13;
<code class="kn">import</code> <code class="nn">unittest</code>&#13;
<code class="kn">import</code> <code class="nn">re</code>&#13;
<code class="kn">import</code> <code class="nn">random</code>&#13;
<code class="kn">from</code> <code class="nn">urllib.parse</code> <code class="kn">import</code> <code class="n">unquote</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">TestWikipedia</code><code class="p">(</code><code class="n">unittest</code><code class="o">.</code><code class="n">TestCase</code><code class="p">):</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">test_PageProperties</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">url</code> <code class="o">=</code> <code class="s1">'http://en.wikipedia.org/wiki/Monty_Python'</code>&#13;
        <code class="c1">#Test the first 10 pages we encounter</code>&#13;
        <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">10</code><code class="p">):</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">bs</code> <code class="o">=</code> <code class="n">BeautifulSoup</code><code class="p">(</code><code class="n">urlopen</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">url</code><code class="p">),</code> <code class="s1">'html.parser'</code><code class="p">)</code>&#13;
            <code class="n">titles</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">titleMatchesURL</code><code class="p">()</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">assertEquals</code><code class="p">(</code><code class="n">titles</code><code class="p">[</code><code class="mi">0</code><code class="p">],</code> <code class="n">titles</code><code class="p">[</code><code class="mi">1</code><code class="p">])</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">assertTrue</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">contentExists</code><code class="p">())</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">url</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">getNextLink</code><code class="p">()</code>&#13;
        <code class="nb">print</code><code class="p">(</code><code class="s1">'Done!'</code><code class="p">)</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">titleMatchesURL</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
        <code class="n">pageTitle</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">bs</code><code class="o">.</code><code class="n">find</code><code class="p">(</code><code class="s1">'h1'</code><code class="p">)</code><code class="o">.</code><code class="n">get_text</code><code class="p">()</code>&#13;
        <code class="n">urlTitle</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">url</code><code class="p">[(</code><code class="bp">self</code><code class="o">.</code><code class="n">url</code><code class="o">.</code><code class="n">index</code><code class="p">(</code><code class="s1">'/wiki/'</code><code class="p">)</code><code class="o">+</code><code class="mi">6</code><code class="p">):]</code>&#13;
        <code class="n">urlTitle</code> <code class="o">=</code> <code class="n">urlTitle</code><code class="o">.</code><code class="n">replace</code><code class="p">(</code><code class="s1">'_'</code><code class="p">,</code> <code class="s1">' '</code><code class="p">)</code>&#13;
        <code class="n">urlTitle</code> <code class="o">=</code> <code class="n">unquote</code><code class="p">(</code><code class="n">urlTitle</code><code class="p">)</code>&#13;
        <code class="k">return</code> <code class="p">[</code><code class="n">pageTitle</code><code class="o">.</code><code class="n">lower</code><code class="p">(),</code> <code class="n">urlTitle</code><code class="o">.</code><code class="n">lower</code><code class="p">()]</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">contentExists</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
        <code class="n">content</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">bs</code><code class="o">.</code><code class="n">find</code><code class="p">(</code><code class="s1">'div'</code><code class="p">,{</code><code class="s1">'id'</code><code class="p">:</code><code class="s1">'mw-content-text'</code><code class="p">})</code>&#13;
        <code class="k">if</code> <code class="n">content</code> <code class="ow">is</code> <code class="ow">not</code> <code class="kc">None</code><code class="p">:</code>&#13;
            <code class="k">return</code> <code class="kc">True</code>&#13;
        <code class="k">return</code> <code class="kc">False</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">getNextLink</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
        <code class="c1">#Returns random link on page, using technique from Chapter 3</code>&#13;
        <code class="n">links</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">bs</code><code class="o">.</code><code class="n">find</code><code class="p">(</code><code class="s1">'div'</code><code class="p">,</code> <code class="p">{</code><code class="s1">'id'</code><code class="p">:</code><code class="s1">'bodyContent'</code><code class="p">})</code><code class="o">.</code><code class="n">find_all</code><code class="p">(</code>&#13;
            <code class="s1">'a'</code><code class="p">,</code> <code class="n">href</code><code class="o">=</code><code class="n">re</code><code class="o">.</code><code class="n">compile</code><code class="p">(</code><code class="s1">'^(/wiki/)((?!:).)*$'</code><code class="p">))</code>&#13;
        <code class="n">randomLink</code> <code class="o">=</code> <code class="n">random</code><code class="o">.</code><code class="n">SystemRandom</code><code class="p">()</code><code class="o">.</code><code class="n">choice</code><code class="p">(</code><code class="n">links</code><code class="p">)</code>&#13;
        <code class="k">return</code> <code class="s1">'https://wikipedia.org</code><code class="si">{}</code><code class="s1">'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">randomLink</code><code class="o">.</code><code class="n">attrs</code><code class="p">[</code><code class="s1">'href'</code><code class="p">])</code>&#13;
&#13;
<code class="k">if</code> <code class="vm">__name__</code> <code class="o">==</code> <code class="s1">'__main__'</code><code class="p">:</code>&#13;
    <code class="n">unittest</code><code class="o">.</code><code class="n">main</code><code class="p">()</code>&#13;
</pre>&#13;
&#13;
<p>There are a few things to notice. First, there is only one actual test in this class. The other functions are technically only helper functions, even though they’re doing the bulk of the computational work to determine whether a test passes. Because the test function performs the assertion statements, the results of the test are passed back to the test function where the assertions happen.</p>&#13;
&#13;
<p>Also, while <code>contentExists</code> returns a boolean, <code>titleMatchesURL</code> returns the values themselves for evaluation. To see why you would want to pass values back rather than just a boolean, compare the results of a boolean assertion:</p>&#13;
&#13;
<pre data-code-language="text" data-type="programlisting">&#13;
======================================================================&#13;
FAIL: test_PageProperties (__main__.TestWikipedia)&#13;
----------------------------------------------------------------------&#13;
Traceback (most recent call last):&#13;
  File "15-3.py", line 22, in test_PageProperties&#13;
    self.assertTrue(self.titleMatchesURL())&#13;
AssertionError: False is not true&#13;
</pre>&#13;
&#13;
<p>with the results of an <code>assertEquals</code> statement:</p>&#13;
&#13;
<pre data-code-language="text" data-type="programlisting">&#13;
======================================================================&#13;
FAIL: test_PageProperties (__main__.TestWikipedia)&#13;
----------------------------------------------------------------------&#13;
Traceback (most recent call last):&#13;
  File "15-3.py", line 23, in test_PageProperties&#13;
    self.assertEquals(titles[0], titles[1])&#13;
AssertionError: 'lockheed u-2' != 'u-2 spy plane'</pre>&#13;
&#13;
<p>Which one is easier to debug? (In this case, the error is occurring because of a redirect, when the article <em>http://wikipedia.org/wiki/u-2%20spy%20plane</em> redirects to an article <a contenteditable="false" data-primary="testing" data-secondary="Wikipedia" data-startref="tstwkp" data-type="indexterm" id="id887"/><a contenteditable="false" data-primary="Wikipedia" data-secondary="testing" data-startref="wkpdtt" data-type="indexterm" id="id888"/>titled “Lockheed U-2.”)</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Testing with Selenium" data-type="sect1"><div class="sect1" id="c-14-testing-with-selenium">&#13;
<h1>Testing with Selenium</h1>&#13;
&#13;
<p>As with Ajax scraping in <a data-type="xref" href="ch14.html#c-14">Chapter 14</a>, JavaScript presents particular challenges when <a contenteditable="false" data-primary="testing" data-secondary="Selenium and" data-type="indexterm" id="tsgslnu"/><a contenteditable="false" data-primary="Selenium" data-secondary="testing with" data-type="indexterm" id="slnttg"/>doing website testing. Fortunately, Selenium has an excellent framework in place for handling particularly complicated websites; in fact, the library was originally designed for website testing!</p>&#13;
&#13;
<p>Although obviously written in the same language, the syntaxes of Python unit tests and Selenium unit tests have surprisingly little in common. Selenium does not require that its unit tests be contained as functions within classes; its <code>assert</code> statements do not require parentheses; and tests pass silently, producing some kind of message only on a failure:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="n">driver</code> <code class="o">=</code> <code class="n">webdriver</code><code class="o">.</code><code class="n">Chrome</code><code class="p">()</code>&#13;
<code class="n">driver</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s1">'http://en.wikipedia.org/wiki/Monty_Python'</code><code class="p">)</code>&#13;
<code class="k">assert</code> <code class="s1">'Monty Python'</code> <code class="ow">in</code> <code class="n">driver</code><code class="o">.</code><code class="n">title</code>&#13;
<code class="n">driver</code><code class="o">.</code><code class="n">close</code><code class="p">()</code></pre>&#13;
&#13;
<p>When run, this test should produce no output.</p>&#13;
&#13;
<p>In this way, Selenium tests can be written more casually than Python unit tests, and <code>assert</code> statements can even be integrated into regular code, where it is desirable for code execution to terminate if some condition is not met.</p>&#13;
&#13;
<section data-pdf-bookmark="Interacting with the Site" data-type="sect2"><div class="sect2" id="id173">&#13;
<h2>Interacting with the Site</h2>&#13;
&#13;
<p>Recently, I wanted to contact a local small <a contenteditable="false" data-primary="websites" data-secondary="interacting with, testing and" data-type="indexterm" id="wbstwtg"/><a contenteditable="false" data-primary="testing" data-secondary="interacting with website and" data-type="indexterm" id="tstgciwb"/>business through its website’s contact form but found that the HTML form was broken; nothing happened when I clicked the Submit button. After a little investigation, I saw they were using a simple mailto form that was designed to send them an email with the form’s contents. Fortunately, I was able to use this information to send them an email, explain the problem with their form, and hire them, despite the technical issue.</p>&#13;
&#13;
<p>If I were to write a traditional scraper that used or tested this form, my scraper would likely just copy the layout of the form and send an email directly—bypassing the form altogether. How could I test the functionality of the form and ensure that it was working perfectly through a browser?</p>&#13;
&#13;
<p>Although previous chapters have discussed navigating links, submitting forms, and other types of interaction-like activity, at its core everything we’ve done is designed to <em>bypass</em> the browser interface, not use it. Selenium, on the other hand, can literally enter text, click buttons, and do everything through the browser (in this case, the headless Chrome browser), and detect things like broken forms, badly coded JavaScript, HTML typos, and other issues that might stymie actual customers.</p>&#13;
&#13;
<p>Key to this sort of testing is the <a contenteditable="false" data-primary="Selenium" data-secondary="elements" data-type="indexterm" id="id889"/>concept of Selenium elements. This object was briefly encountered in <a data-type="xref" href="ch14.html#c-14">Chapter 14</a>, and is returned by calls like this:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="n">usernameField</code> <code class="o">=</code> <code class="n">driver</code><code class="o">.</code><code class="n">find_element_by_name</code><code class="p">(</code><code class="s1">'username'</code><code class="p">)</code></pre>&#13;
&#13;
<p>Just as there are numerous actions you can take on various elements of a website in your browser, there are many actions Selenium can perform on any given element. Among these are:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="n">myElement</code><code class="o">.</code><code class="n">click</code><code class="p">()</code>&#13;
<code class="n">myElement</code><code class="o">.</code><code class="n">click_and_hold</code><code class="p">()</code>&#13;
<code class="n">myElement</code><code class="o">.</code><code class="n">release</code><code class="p">()</code>&#13;
<code class="n">myElement</code><code class="o">.</code><code class="n">double_click</code><code class="p">()</code>&#13;
<code class="n">myElement</code><code class="o">.</code><code class="n">send_keys_to_element</code><code class="p">(</code><code class="s1">'content to enter'</code><code class="p">)</code></pre>&#13;
&#13;
<p>In addition to performing a one-time action on an element, strings of actions can be combined into <em>action chains</em>, which <a contenteditable="false" data-primary="Selenium" data-secondary="action chains" data-type="indexterm" id="id890"/>can be stored and executed once or multiple times in a program. Action chains are useful in that they can be a convenient way to string long sets of multiple actions, but they are functionally identical to calling the action explicitly on the element, as in the preceding examples.</p>&#13;
&#13;
<p>To see this difference, take a look at the form page at <a href="http://pythonscraping.com/pages/files/form.html"><em>http://pythonscraping.com/pages/files/form.html</em></a> (which was previously used as an example in <a data-type="xref" href="ch13.html#c-13">Chapter 13</a>). We can fill out the form and submit it in this way:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="kn">from</code> <code class="nn">selenium</code> <code class="kn">import</code> <code class="n">webdriver</code>&#13;
<code class="kn">from</code> <code class="nn">selenium.webdriver.remote.webelement</code> <code class="kn">import</code> <code class="n">WebElement</code>&#13;
<code class="kn">from</code> <code class="nn">selenium.webdriver.common.keys</code> <code class="kn">import</code> <code class="n">Keys</code>&#13;
<code class="kn">from</code> <code class="nn">selenium.webdriver</code> <code class="kn">import</code> <code class="n">ActionChains</code>&#13;
<code class="kn">from</code> <code class="nn">selenium.webdriver.chrome.options</code> <code class="kn">import</code> <code class="n">Options</code>&#13;
&#13;
<code class="n">chrome_options</code> <code class="o">=</code> <code class="n">Options</code><code class="p">()</code>&#13;
<code class="n">chrome_options</code><code class="o">.</code><code class="n">add_argument</code><code class="p">(</code><code class="s1">'--headless'</code><code class="p">)</code>&#13;
&#13;
<code class="n">driver</code> <code class="o">=</code> <code class="n">webdriver</code><code class="o">.</code><code class="n">Chrome</code><code class="p">(</code>&#13;
    <code class="n">executable_path</code><code class="o">=</code><code class="s1">'drivers/chromedriver'</code><code class="p">,</code> <code class="n">options</code><code class="o">=</code><code class="n">chrome_options</code><code class="p">)</code>&#13;
<code class="n">driver</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s1">'http://pythonscraping.com/pages/files/form.html'</code><code class="p">)</code>&#13;
&#13;
<code class="n">firstnameField</code> <code class="o">=</code> <code class="n">driver</code><code class="o">.</code><code class="n">find_element_by_name</code><code class="p">(</code><code class="s1">'firstname'</code><code class="p">)</code>&#13;
<code class="n">lastnameField</code> <code class="o">=</code> <code class="n">driver</code><code class="o">.</code><code class="n">find_element_by_name</code><code class="p">(</code><code class="s1">'lastname'</code><code class="p">)</code>&#13;
<code class="n">submitButton</code> <code class="o">=</code> <code class="n">driver</code><code class="o">.</code><code class="n">find_element_by_id</code><code class="p">(</code><code class="s1">'submit'</code><code class="p">)</code>&#13;
&#13;
<code class="c1">### METHOD 1 ###</code>&#13;
<code class="c1">#firstnameField.send_keys('Ryan')</code>&#13;
<code class="n">lastnameField</code><code class="o">.</code><code class="n">send_keys</code><code class="p">(</code><code class="s1">'Mitchell'</code><code class="p">)</code>&#13;
<code class="n">submitButton</code><code class="o">.</code><code class="n">click</code><code class="p">()</code>&#13;
<code class="c1">################</code>&#13;
&#13;
<code class="c1">### METHOD 2 ###</code>&#13;
<code class="n">actions</code> <code class="o">=</code> <code class="n">ActionChains</code><code class="p">(</code><code class="n">driver</code><code class="p">)</code><code class="o">.</code><code class="n">click</code><code class="p">(</code><code class="n">firstnameField</code><code class="p">)</code>&#13;
    <code class="o">.</code><code class="n">send_keys</code><code class="p">(</code><code class="s1">'Ryan'</code><code class="p">)</code>&#13;
    <code class="o">.</code><code class="n">click</code><code class="p">(</code><code class="n">lastnameField</code><code class="p">)</code>&#13;
    <code class="o">.</code><code class="n">send_keys</code><code class="p">(</code><code class="s1">'Mitchell'</code><code class="p">)</code>&#13;
    <code class="o">.</code><code class="n">send_keys</code><code class="p">(</code><code class="n">Keys</code><code class="o">.</code><code class="n">RETURN</code><code class="p">)</code>&#13;
<code class="n">actions</code><code class="o">.</code><code class="n">perform</code><code class="p">()</code>&#13;
<code class="c1">################</code>&#13;
&#13;
<code class="nb">print</code><code class="p">(</code><code class="n">driver</code><code class="o">.</code><code class="n">find_element_by_tag_name</code><code class="p">(</code><code class="s1">'body'</code><code class="p">)</code><code class="o">.</code><code class="n">text</code><code class="p">)</code>&#13;
&#13;
<code class="n">driver</code><code class="o">.</code><code class="n">close</code><code class="p">()</code>&#13;
</pre>&#13;
&#13;
<p>Method 1 calls <code>send_keys</code> on the two fields and then clicks the Submit button. Method 2 uses a single action chain to click and enter text in each field, which happens in a sequence after the <code>perform</code> method is called. This script operates in the same way, whether the first method or the second method is used, and prints this line:</p>&#13;
&#13;
<pre data-code-language="text" data-type="programlisting">&#13;
Hello there, Ryan Mitchell!</pre>&#13;
&#13;
<p class="pagebreak-before">There is another variation in the two methods, in addition to the objects they use to handle the commands: notice that the first method clicks the Submit button, while the second uses the Return keystroke to submit the form while the text box is submitted. Because there are many ways to think about the sequence of events that complete the same action, there are many ways to complete the same action using Selenium.</p>&#13;
&#13;
<section data-pdf-bookmark="Drag and drop" data-type="sect3"><div class="sect3" id="id254">&#13;
<h3>Drag and drop</h3>&#13;
&#13;
<p>Clicking buttons and entering text is one thing, but where Selenium really shines is in its ability to deal with relatively novel forms of web interaction. Selenium allows for the manipulation of drag-and-drop interfaces with ease. Using its drag-and-drop function requires you to specify a <em>source</em> element (the element to be dragged) and either an offset to drag it across, or a target element to drag it to.</p>&#13;
&#13;
<p>The demo page located at <a href="http://pythonscraping.com/pages/javascript/draggableDemo.html"><em>http://pythonscraping.com/pages/javascript/draggableDemo.html</em></a> presents an example of this type of interface:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="kn">from</code> <code class="nn">selenium</code> <code class="kn">import</code> <code class="n">webdriver</code>&#13;
<code class="kn">from</code> <code class="nn">selenium.webdriver.remote.webelement</code> <code class="kn">import</code> <code class="n">WebElement</code>&#13;
<code class="kn">from</code> <code class="nn">selenium.webdriver</code> <code class="kn">import</code> <code class="n">ActionChains</code>&#13;
<code class="kn">from</code> <code class="nn">selenium.webdriver.chrome.options</code> <code class="kn">import</code> <code class="n">Options</code>&#13;
<code class="kn">import</code> <code class="nn">unittest</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">TestDragAndDrop</code><code class="p">(</code><code class="n">unittest</code><code class="o">.</code><code class="n">TestCase</code><code class="p">):</code>&#13;
    <code class="n">driver</code> <code class="o">=</code> <code class="kc">None</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">setUp</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
        <code class="n">chrome_options</code> <code class="o">=</code> <code class="n">Options</code><code class="p">()</code>&#13;
        <code class="n">chrome_options</code><code class="o">.</code><code class="n">add_argument</code><code class="p">(</code><code class="s1">'--headless'</code><code class="p">)</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">driver</code> <code class="o">=</code> <code class="n">webdriver</code><code class="o">.</code><code class="n">Chrome</code><code class="p">(</code>&#13;
            <code class="n">executable_path</code><code class="o">=</code><code class="s1">'drivers/chromedriver'</code><code class="p">,</code> <code class="n">options</code><code class="o">=</code><code class="n">chrome_options</code><code class="p">)</code>&#13;
        <code class="n">url</code> <code class="o">=</code> <code class="s1">'http://pythonscraping.com/pages/javascript/draggableDemo.html'</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">driver</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">url</code><code class="p">)</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">tearDown</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
        <code class="n">driver</code><code class="o">.</code><code class="n">close</code><code class="p">()</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">test_drag</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
        <code class="n">element</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">driver</code><code class="o">.</code><code class="n">find_element_by_id</code><code class="p">(</code><code class="s1">'draggable'</code><code class="p">)</code>&#13;
        <code class="n">target</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">driver</code><code class="o">.</code><code class="n">find_element_by_id</code><code class="p">(</code><code class="s1">'div2'</code><code class="p">)</code>&#13;
        <code class="n">actions</code> <code class="o">=</code> <code class="n">ActionChains</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">driver</code><code class="p">)</code>&#13;
        <code class="n">actions</code><code class="o">.</code><code class="n">drag_and_drop</code><code class="p">(</code><code class="n">element</code><code class="p">,</code> <code class="n">target</code><code class="p">)</code><code class="o">.</code><code class="n">perform</code><code class="p">()</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">assertEqual</code><code class="p">(</code><code class="s1">'You are definitely not a bot!'</code><code class="p">,</code>&#13;
                         <code class="bp">self</code><code class="o">.</code><code class="n">driver</code><code class="o">.</code><code class="n">find_element_by_id</code><code class="p">(</code><code class="s1">'message'</code><code class="p">)</code><code class="o">.</code><code class="n">text</code><code class="p">)</code>&#13;
&#13;
</pre>&#13;
&#13;
<p>Two messages are printed out from the <code>message div</code> on the demo page. The first says:</p>&#13;
&#13;
<pre data-code-language="text" data-type="programlisting">&#13;
Prove you are not a bot, by dragging the square from the blue area to the red &#13;
area!</pre>&#13;
&#13;
<p>Then, quickly, after the task is completed, the content is printed out again, which now reads:</p>&#13;
&#13;
<pre data-code-language="text" data-type="programlisting">&#13;
You are definitely not a bot!</pre>&#13;
&#13;
<p>As the demo page suggests, dragging elements to prove you’re not a bot is a common theme in many CAPTCHAs. Although bots have been able to drag objects around for a long time (it’s just a matter of clicking, holding, and moving), somehow the idea of using “drag this” as a verification of humanity just won’t die.</p>&#13;
&#13;
<p>In addition, these draggable CAPTCHA libraries rarely use any difficult-for-bots tasks, like “drag the picture of the kitten onto the picture of the cow” (which requires you to identify the pictures as “a kitten” and “a cow,” while parsing instructions); instead, they often involve number ordering or some other fairly trivial task like the one in the preceding example.</p>&#13;
&#13;
<p>Of course, their strength lies in the fact that there are so many variations, and they are so infrequently used; no one will likely bother making a bot that can defeat all of them. At any rate, this example should be enough to illustrate why you should never use this technique for large-scale websites.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Taking screenshots" data-type="sect3"><div class="sect3" id="id117">&#13;
<h3>Taking screenshots</h3>&#13;
&#13;
<p>In addition to the usual testing <a contenteditable="false" data-primary="Selenium" data-secondary="screenshots" data-type="indexterm" id="id891"/><a contenteditable="false" data-primary="screenshots, Selenium" data-type="indexterm" id="id892"/>capabilities, Selenium has an interesting trick up its sleeve that might make your testing (or impressing your boss) a little easier: screenshots. Yes, photographic evidence can be created from unit tests run without the need for actually pressing the PrtScn key:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="n">driver</code> <code class="o">=</code> <code class="n">webdriver</code><code class="o">.</code><code class="n">Chrome</code><code class="p">()</code>&#13;
<code class="n">driver</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s1">'http://www.pythonscraping.com/'</code><code class="p">)</code>&#13;
<code class="n">driver</code><code class="o">.</code><code class="n">get_screenshot_as_file</code><code class="p">(</code><code class="s1">'tmp/pythonscraping.png'</code><code class="p">)</code></pre>&#13;
&#13;
<p>This script navigates to <a class="orm:hideurl" href="http://pythonscraping.com"><em>http://pythonscraping.com</em></a> and then stores a screenshot of the home page in the local <em>tmp</em> folder (the folder must already exist for this to store correctly). Screenshots can be saved <a contenteditable="false" data-primary="testing" data-secondary="Selenium and" data-startref="tsgslnu" data-type="indexterm" id="id893"/><a contenteditable="false" data-primary="Selenium" data-secondary="testing with" data-startref="slnttg" data-type="indexterm" id="id894"/><a contenteditable="false" data-primary="websites" data-secondary="interacting with, testing and" data-startref="wbstwtg" data-type="indexterm" id="id895"/><a contenteditable="false" data-primary="testing" data-secondary="interacting with website and" data-startref="tstgciwb" data-type="indexterm" id="id896"/>as a variety of image formats.</p>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section></body></html>