<html><head></head><body><section data-type="appendix" epub:type="appendix" data-pdf-bookmark="Appendix B. Supplementary Material"><div class="appendix" id="appendixb">
<h1><span class="label">Appendix B. </span>Supplementary Material</h1>


<p>This appendix contains some additional code related to the case studies presented in the book. You might find this material helpful to round out your understanding of the examples.<a data-type="indexterm" data-primary="code" data-secondary="supplementary, for case studies in this book" id="ix_codecs"/></p>






<section data-type="sect1" data-pdf-bookmark="Cutlery Example Using Asyncio"><div class="sect1" id="idm46363039268520">
<h1>Cutlery Example Using Asyncio</h1>

<p><a data-type="xref" href="ch02.html#robotcut">“Case Study: Robots and Cutlery”</a> analyzed a race condition bug
caused by multiple threads modifying the cutlery records in the
global “kitchen” object instance<a data-type="indexterm" data-primary="threading" data-secondary="Robots and Cutlery case study" data-tertiary="cutlery management using asyncio" id="idm46363039266168"/>.<a data-type="indexterm" data-primary="Robots and Cutlery case study" data-secondary="cutlery cutlery management using asyncio" id="idm46363039264888"/>  For completeness, here is how we might create an async version of the <span class="keep-together">solution.</span></p>

<p>There is a specific point<a data-type="indexterm" data-primary="observability of concurrency in asyncio" id="idm46363039262904"/> I want to highlight about the
<em>observability</em> of concurrency in the <code>asyncio</code> approach, shown in <a data-type="xref" href="#corobot">Example B-1</a>.</p>
<div id="corobot" data-type="example">
<h5><span class="label">Example B-1. </span>Cutlery management using asyncio</h5>

<pre data-type="programlisting" data-code-language="python3"><code class="kn">import</code><code> </code><code class="nn">asyncio</code><code>
</code><code>
</code><code class="k">class</code><code> </code><code class="nc">CoroBot</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" id="co_supplementary_material_CO1-1" href="#callout_supplementary_material_CO1-1"><img src="assets/1.png" alt="1"/></a><code>
</code><code>  </code><code class="k">def</code><code> </code><code class="nf">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="bp">self</code><code class="o">.</code><code class="n">cutlery</code><code> </code><code class="o">=</code><code> </code><code class="n">Cutlery</code><code class="p">(</code><code class="n">knives</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="n">forks</code><code class="o">=</code><code class="mi">0</code><code class="p">)</code><code>
</code><code>    </code><code class="bp">self</code><code class="o">.</code><code class="n">tasks</code><code> </code><code class="o">=</code><code> </code><code class="n">asyncio</code><code class="o">.</code><code class="n">Queue</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_supplementary_material_CO1-2" href="#callout_supplementary_material_CO1-2"><img src="assets/2.png" alt="2"/></a><code>
</code><code>
</code><code>  </code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">manage_table</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="k">while</code><code> </code><code class="kc">True</code><code class="p">:</code><code>
</code><code>      </code><code class="n">task</code><code> </code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">tasks</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_supplementary_material_CO1-3" href="#callout_supplementary_material_CO1-3"><img src="assets/3.png" alt="3"/></a><code>
</code><code>      </code><code class="k">if</code><code> </code><code class="n">task</code><code> </code><code class="o">==</code><code> </code><code class="s1">'</code><code class="s1">prepare table</code><code class="s1">'</code><code class="p">:</code><code>
</code><code>        </code><code class="n">kitchen</code><code class="o">.</code><code class="n">give</code><code class="p">(</code><code class="n">to</code><code class="o">=</code><code class="bp">self</code><code class="o">.</code><code class="n">cutlery</code><code class="p">,</code><code> </code><code class="n">knives</code><code class="o">=</code><code class="mi">4</code><code class="p">,</code><code> </code><code class="n">forks</code><code class="o">=</code><code class="mi">4</code><code class="p">)</code><code>
</code><code>      </code><code class="k">elif</code><code> </code><code class="n">task</code><code> </code><code class="o">==</code><code> </code><code class="s1">'</code><code class="s1">clear table</code><code class="s1">'</code><code class="p">:</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">cutlery</code><code class="o">.</code><code class="n">give</code><code class="p">(</code><code class="n">to</code><code class="o">=</code><code class="n">kitchen</code><code class="p">,</code><code> </code><code class="n">knives</code><code class="o">=</code><code class="mi">4</code><code class="p">,</code><code> </code><code class="n">forks</code><code class="o">=</code><code class="mi">4</code><code class="p">)</code><code>
</code><code>      </code><code class="k">elif</code><code> </code><code class="n">task</code><code> </code><code class="o">==</code><code> </code><code class="s1">'</code><code class="s1">shutdown</code><code class="s1">'</code><code class="p">:</code><code>
</code><code>        </code><code class="k">return</code><code>
</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">attr</code><code> </code><code class="k">import</code><code> </code><code class="n">attrs</code><code class="p">,</code><code> </code><code class="n">attrib</code><code>
</code><code>
</code><code class="nd">@attrs</code><code>
</code><code class="k">class</code><code> </code><code class="nc">Cutlery</code><code class="p">:</code><code>
</code><code>    </code><code class="n">knives</code><code> </code><code class="o">=</code><code> </code><code class="n">attrib</code><code class="p">(</code><code class="n">default</code><code class="o">=</code><code class="mi">0</code><code class="p">)</code><code>
</code><code>    </code><code class="n">forks</code><code> </code><code class="o">=</code><code> </code><code class="n">attrib</code><code class="p">(</code><code class="n">default</code><code class="o">=</code><code class="mi">0</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">give</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">to</code><code class="p">:</code><code> </code><code class="s1">'</code><code class="s1">Cutlery</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">knives</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="n">forks</code><code class="o">=</code><code class="mi">0</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">change</code><code class="p">(</code><code class="o">-</code><code class="n">knives</code><code class="p">,</code><code> </code><code class="o">-</code><code class="n">forks</code><code class="p">)</code><code>
</code><code>        </code><code class="n">to</code><code class="o">.</code><code class="n">change</code><code class="p">(</code><code class="n">knives</code><code class="p">,</code><code> </code><code class="n">forks</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">change</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">knives</code><code class="p">,</code><code> </code><code class="n">forks</code><code class="p">)</code><code class="p">:</code><code>
</code><code>            </code><code class="bp">self</code><code class="o">.</code><code class="n">knives</code><code> </code><code class="o">+</code><code class="o">=</code><code> </code><code class="n">knives</code><code>
</code><code>            </code><code class="bp">self</code><code class="o">.</code><code class="n">forks</code><code> </code><code class="o">+</code><code class="o">=</code><code> </code><code class="n">forks</code><code>
</code><code>
</code><code class="n">kitchen</code><code> </code><code class="o">=</code><code> </code><code class="n">Cutlery</code><code class="p">(</code><code class="n">knives</code><code class="o">=</code><code class="mi">100</code><code class="p">,</code><code> </code><code class="n">forks</code><code class="o">=</code><code class="mi">100</code><code class="p">)</code><code>
</code><code class="n">bots</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="n">CoroBot</code><code class="p">(</code><code class="p">)</code><code> </code><code class="k">for</code><code> </code><code class="n">i</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="mi">10</code><code class="p">)</code><code class="p">]</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">sys</code><code>
</code><code class="k">for</code><code> </code><code class="n">b</code><code> </code><code class="ow">in</code><code> </code><code class="n">bots</code><code class="p">:</code><code>
</code><code>    </code><code class="k">for</code><code> </code><code class="n">i</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="nb">int</code><code class="p">(</code><code class="n">sys</code><code class="o">.</code><code class="n">argv</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="n">b</code><code class="o">.</code><code class="n">tasks</code><code class="o">.</code><code class="n">put_nowait</code><code class="p">(</code><code class="s1">'</code><code class="s1">prepare table</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>        </code><code class="n">b</code><code class="o">.</code><code class="n">tasks</code><code class="o">.</code><code class="n">put_nowait</code><code class="p">(</code><code class="s1">'</code><code class="s1">clear table</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>    </code><code class="n">b</code><code class="o">.</code><code class="n">tasks</code><code class="o">.</code><code class="n">put_nowait</code><code class="p">(</code><code class="s1">'</code><code class="s1">shutdown</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>
</code><code class="nb">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">Kitchen inventory before service:</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">kitchen</code><code class="p">)</code><code>
</code><code>
</code><code class="n">loop</code><code> </code><code class="o">=</code><code> </code><code class="n">asyncio</code><code class="o">.</code><code class="n">get_event_loop</code><code class="p">(</code><code class="p">)</code><code>
</code><code class="n">tasks</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="p">]</code><code>
</code><code class="k">for</code><code> </code><code class="n">b</code><code> </code><code class="ow">in</code><code> </code><code class="n">bots</code><code class="p">:</code><code>
</code><code>    </code><code class="n">t</code><code> </code><code class="o">=</code><code> </code><code class="n">loop</code><code class="o">.</code><code class="n">create_task</code><code class="p">(</code><code class="n">b</code><code class="o">.</code><code class="n">manage_table</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>
</code><code>    </code><code class="n">tasks</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">t</code><code class="p">)</code><code>
</code><code>
</code><code class="n">task_group</code><code> </code><code class="o">=</code><code> </code><code class="n">asyncio</code><code class="o">.</code><code class="n">gather</code><code class="p">(</code><code class="o">*</code><code class="n">tasks</code><code class="p">)</code><code>
</code><code class="n">loop</code><code class="o">.</code><code class="n">run_until_complete</code><code class="p">(</code><code class="n">task_group</code><code class="p">)</code><code>
</code><code class="nb">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">Kitchen inventory after service:</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">kitchen</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_supplementary_material_CO1-1" href="#co_supplementary_material_CO1-1"><img src="assets/1.png" alt="1"/></a></dt>
<dd><p>Instead of a ThreadBot, we now have a CoroBot. This code sample uses only one thread, and that thread
will be managing all 10 separate CoroBot object <span class="keep-together">instances—one</span> for each
table in the restaurant.</p></dd>
<dt><a class="co" id="callout_supplementary_material_CO1-2" href="#co_supplementary_material_CO1-2"><img src="assets/2.png" alt="2"/></a></dt>
<dd><p>Instead of <code>queue.Queue</code>, we’re using the <code>asyncio</code>-enabled queue.</p></dd>
<dt><a class="co" id="callout_supplementary_material_CO1-3" href="#co_supplementary_material_CO1-3"><img src="assets/3.png" alt="3"/></a></dt>
<dd><p>This is the main point: the only places at which execution can
switch between different CoroBot instances is where the <code>await</code>
keyword appears. It is <em>not possible</em> to have a context switch during
the rest of this function, and this is why there is no race condition
during the modification of the kitchen cutlery inventory.</p></dd>
</dl></div>

<p>The presence of <code>await</code> keywords makes context switches <em>observable</em>. This
makes it significantly easier to reason about any potential race conditions
in concurrent applications. <a data-type="indexterm" data-primary="await keyword" data-secondary="making context switches observable" id="idm46363017887784"/>This version of the code always
passes the test, no matter how many tasks are assigned:</p>
<pre data-type="programlisting">
$ <strong>python cutlery_test_corobot.py 100000</strong>
Kitchen inventory before service: Cutlery(knives=100, forks=100)
Kitchen inventory after service: Cutlery(knives=100, forks=100)
</pre>

<p>This really isn’t impressive at all: it’s an entirely predictable outcome
based on the fact that there are clearly no race conditions in the code.
And that is <em>exactly</em> the point.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Supplementary Material for News Website Scraper"><div class="sect1" id="supnews">
<h1>Supplementary Material for News Website Scraper</h1>

<p>This <em>index.html</em> file shown in <a data-type="xref" href="#indexhtml">Example B-2</a> is required <a data-type="indexterm" data-primary="news scraper case study (aiohttp)" data-secondary="index.html file" id="idm46363017897032"/><a data-type="indexterm" data-primary="aiohttp" data-secondary="news scraper case study" data-tertiary="index.html file" id="idm46363017896088"/>to run the code in <a data-type="xref" href="ch04.html#scrapingthenews">“Case Study: Scraping the News”</a>.</p>
<div id="indexhtml" data-type="example">
<h5><span class="label">Example B-2. </span>The index.html file required for the web scraping case study</h5>

<pre data-type="programlisting" data-code-language="html"><code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="nt">&lt;html</code> <code class="na">lang=</code><code class="s">"en"</code><code class="nt">&gt;</code>
<code class="nt">&lt;head&gt;</code>
    <code class="nt">&lt;meta</code> <code class="na">charset=</code><code class="s">"UTF-8"</code><code class="nt">&gt;</code>
    <code class="nt">&lt;title&gt;</code>The News<code class="nt">&lt;/title&gt;</code>
    <code class="nt">&lt;style&gt;</code>
        <code class="nc">.wrapper</code> <code class="p">{</code>
            <code class="k">display</code><code class="o">:</code> <code class="nb">grid</code><code class="p">;</code>
            <code class="k">grid-template-columns</code><code class="o">:</code> <code class="m">300px</code> <code class="m">300px</code> <code class="m">300px</code><code class="p">;</code>
            <code class="k">grid-gap</code><code class="o">:</code> <code class="m">10px</code><code class="p">;</code>
            <code class="k">width</code><code class="o">:</code> <code class="m">920px</code><code class="p">;</code>
            <code class="k">margin</code><code class="o">:</code> <code class="m">0</code> <code class="nb">auto</code><code class="p">;</code>
        <code class="p">}</code>

        <code class="nc">.box</code> <code class="p">{</code>
            <code class="k">border-radius</code><code class="o">:</code> <code class="m">40px</code><code class="p">;</code>
            <code class="k">padding</code><code class="o">:</code> <code class="m">20px</code><code class="p">;</code>
            <code class="k">border</code><code class="o">:</code> <code class="m">1px</code> <code class="nb">solid</code> <code class="nb">slategray</code><code class="p">;</code>
        <code class="p">}</code>

        <code class="nc">.cnn</code> <code class="p">{</code>
            <code class="k">background-color</code><code class="o">:</code> <code class="m">#cef</code><code class="p">;</code>
        <code class="p">}</code>

        <code class="nc">.aljazeera</code> <code class="p">{</code>
            <code class="k">background-color</code><code class="o">:</code> <code class="m">#fea</code><code class="p">;</code>
        <code class="p">}</code>

        <code class="nt">h1</code> <code class="p">{</code>
            <code class="k">text-align</code><code class="o">:</code> <code class="nb">center</code><code class="p">;</code>
            <code class="k">font-size</code><code class="o">:</code> <code class="m">60pt</code><code class="p">;</code>
        <code class="p">}</code>

        <code class="nt">a</code> <code class="p">{</code>
            <code class="k">color</code><code class="o">:</code> <code class="nb">black</code><code class="p">;</code>
            <code class="k">text-decoration</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
        <code class="p">}</code>
        <code class="nt">span</code> <code class="p">{</code>
            <code class="k">text-align</code><code class="o">:</code> <code class="nb">center</code><code class="p">;</code>
            <code class="k">font-size</code><code class="o">:</code> <code class="m">15pt</code><code class="p">;</code>
            <code class="k">color</code><code class="o">:</code> <code class="nb">black</code><code class="p">;</code>
        <code class="p">}</code>
    <code class="nt">&lt;/style&gt;</code>
<code class="nt">&lt;/head&gt;</code>
<code class="nt">&lt;body&gt;</code>
<code class="nt">&lt;h1&gt;</code>The News<code class="nt">&lt;/h1&gt;</code>
<code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"wrapper"</code><code class="nt">&gt;</code>
    $body
<code class="nt">&lt;/div&gt;</code>
<code class="nt">&lt;/body&gt;</code>
<code class="nt">&lt;/html&gt;</code></pre></div>

<p>It’s a very basic template with rudimentary styling.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Supplementary Material for the ZeroMQ Case Study"><div class="sect1" id="supappmon">
<h1>Supplementary Material for the ZeroMQ Case Study</h1>

<p>In <a data-type="xref" href="ch04.html#appmon">“Case Study: Application Performance Monitoring”</a>, I mentioned that you’ll need the HTML file
being served to show the metrics charts. <a data-type="indexterm" data-primary="HTML" data-secondary="charts.html file for ZeroMQ case study" id="idm46363039419688"/><a data-type="indexterm" data-primary="application performance monitoring (APM) case study (ZeroMQ)" data-secondary="charts.html file for" id="idm46363039418776"/><a data-type="indexterm" data-primary="ZeroMQ" data-secondary="application performance monitoring case study" data-tertiary="supplementary material for" id="idm46363039417864"/>That file, <em>charts.html</em>, is presented in
<a data-type="xref" href="#chartshtml">Example B-3</a>. You should obtain a URL for <em>smoothie.min.js</em> from
<a href="http://smoothiecharts.org">Smoothie Charts</a> or one of the CDNs, and use
that URL as the <code>src</code> attribute instead.<a data-type="indexterm" data-primary="Smoothie Charts library" id="idm46363018089224"/></p>
<div id="chartshtml" data-type="example">
<h5><span class="label">Example B-3. </span>charts.html</h5>

<pre data-type="programlisting" data-code-language="html"><code class="cp">&lt;!DOCTYPE html&gt;</code><code>
</code><code class="nt">&lt;html</code><code> </code><code class="na">lang=</code><code class="s">"en"</code><code class="nt">&gt;</code><code>
</code><code class="nt">&lt;head</code><code class="nt">&gt;</code><code>
    </code><code class="nt">&lt;meta</code><code> </code><code class="na">charset=</code><code class="s">"UTF-8"</code><code class="nt">&gt;</code><code>
    </code><code class="nt">&lt;title</code><code class="nt">&gt;</code><code>Server Performance</code><code class="nt">&lt;/title&gt;</code><code>
    </code><code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"smoothie.min.js"</code><code class="nt">&gt;</code><code class="nt">&lt;/script&gt;</code><code>
    </code><code class="nt">&lt;script </code><code class="na">type=</code><code class="s">"text/javascript"</code><code class="nt">&gt;</code><code>
        </code><code class="kd">function</code><code> </code><code class="nx">createTimeline</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>
            </code><code class="kd">var</code><code> </code><code class="nx">cpu</code><code> </code><code class="o">=</code><code> </code><code class="p">{</code><code class="p">}</code><code class="p">;</code><code>  </code><a class="co" id="co_supplementary_material_CO2-1" href="#callout_supplementary_material_CO2-1"><img src="assets/1.png" alt="1"/></a><code>
            </code><code class="kd">var</code><code> </code><code class="nx">mem</code><code> </code><code class="o">=</code><code> </code><code class="p">{</code><code class="p">}</code><code class="p">;</code><code>

            </code><code class="kd">var</code><code> </code><code class="nx">chart_props</code><code> </code><code class="o">=</code><code> </code><code class="p">{</code><code>
                </code><code class="nx">responsive</code><code class="o">:</code><code> </code><code class="kc">true</code><code class="p">,</code><code>
                </code><code class="nx">enableDpiScaling</code><code class="o">:</code><code> </code><code class="kc">false</code><code class="p">,</code><code>
                </code><code class="nx">millisPerPixel</code><code class="o">:</code><code class="mi">100</code><code class="p">,</code><code>
                </code><code class="nx">grid</code><code class="o">:</code><code> </code><code class="p">{</code><code>
                    </code><code class="nx">millisPerLine</code><code class="o">:</code><code> </code><code class="mi">4000</code><code class="p">,</code><code>
                    </code><code class="nx">fillStyle</code><code class="o">:</code><code> </code><code class="s1">'#ffffff'</code><code class="p">,</code><code>
                    </code><code class="nx">strokeStyle</code><code class="o">:</code><code> </code><code class="s1">'rgba(0,0,0,0.08)'</code><code class="p">,</code><code>
                    </code><code class="nx">verticalSections</code><code class="o">:</code><code> </code><code class="mi">10</code><code>
                </code><code class="p">}</code><code class="p">,</code><code>
                </code><code class="nx">labels</code><code class="o">:</code><code class="p">{</code><code class="nx">fillStyle</code><code class="o">:</code><code class="s1">'#000000'</code><code class="p">,</code><code class="nx">fontSize</code><code class="o">:</code><code class="mi">18</code><code class="p">}</code><code class="p">,</code><code>
                </code><code class="nx">timestampFormatter</code><code class="o">:</code><code class="nx">SmoothieChart</code><code class="p">.</code><code class="nx">timeFormatter</code><code class="p">,</code><code>
                </code><code class="nx">maxValue</code><code class="o">:</code><code> </code><code class="mi">100</code><code class="p">,</code><code>
                </code><code class="nx">minValue</code><code class="o">:</code><code> </code><code class="mi">0</code><code>
            </code><code class="p">}</code><code class="p">;</code><code>

            </code><code class="kd">var</code><code> </code><code class="nx">cpu_chart</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="nx">SmoothieChart</code><code class="p">(</code><code class="nx">chart_props</code><code class="p">)</code><code class="p">;</code><code>  </code><a class="co" id="co_supplementary_material_CO2-2" href="#callout_supplementary_material_CO2-2"><img src="assets/2.png" alt="2"/></a><code>
            </code><code class="kd">var</code><code> </code><code class="nx">mem_chart</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="nx">SmoothieChart</code><code class="p">(</code><code class="nx">chart_props</code><code class="p">)</code><code class="p">;</code><code>

            </code><code class="kd">function</code><code> </code><code class="nx">add_timeseries</code><code class="p">(</code><code class="nx">obj</code><code class="p">,</code><code> </code><code class="nx">chart</code><code class="p">,</code><code> </code><code class="nx">color</code><code class="p">)</code><code> </code><code class="p">{</code><code>  </code><a class="co" id="co_supplementary_material_CO2-3" href="#callout_supplementary_material_CO2-3"><img src="assets/3.png" alt="3"/></a><code>
                </code><code class="nx">obj</code><code class="p">[</code><code class="nx">color</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="nx">TimeSeries</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
                </code><code class="nx">chart</code><code class="p">.</code><code class="nx">addTimeSeries</code><code class="p">(</code><code class="nx">obj</code><code class="p">[</code><code class="nx">color</code><code class="p">]</code><code class="p">,</code><code> </code><code class="p">{</code><code>
                    </code><code class="nx">strokeStyle</code><code class="o">:</code><code> </code><code class="nx">color</code><code class="p">,</code><code>
                    </code><code class="nx">lineWidth</code><code class="o">:</code><code> </code><code class="mi">4</code><code>
                </code><code class="p">}</code><code class="p">)</code><code>
            </code><code class="p">}</code><code>

            </code><code class="kd">var</code><code> </code><code class="nx">evtSource</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="nx">EventSource</code><code class="p">(</code><code class="s2">"/feed"</code><code class="p">)</code><code class="p">;</code><code>  </code><a class="co" id="co_supplementary_material_CO2-4" href="#callout_supplementary_material_CO2-4"><img src="assets/4.png" alt="4"/></a><code>
            </code><code class="nx">evtSource</code><code class="p">.</code><code class="nx">onmessage</code><code> </code><code class="o">=</code><code> </code><code class="kd">function</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code><code> </code><code class="p">{</code><code>
                </code><code class="kd">var</code><code> </code><code class="nx">obj</code><code> </code><code class="o">=</code><code> </code><code class="nx">JSON</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">e</code><code class="p">.</code><code class="nx">data</code><code class="p">)</code><code class="p">;</code><code>  </code><a class="co" id="co_supplementary_material_CO2-5" href="#callout_supplementary_material_CO2-5"><img src="assets/5.png" alt="5"/></a><code>
                </code><code class="k">if</code><code> </code><code class="p">(</code><code class="o">!</code><code class="p">(</code><code class="nx">obj</code><code class="p">.</code><code class="nx">color</code><code> </code><code class="k">in</code><code> </code><code class="nx">cpu</code><code class="p">)</code><code class="p">)</code><code> </code><code class="p">{</code><code>
                    </code><code class="nx">add_timeseries</code><code class="p">(</code><code class="nx">cpu</code><code class="p">,</code><code> </code><code class="nx">cpu_chart</code><code class="p">,</code><code> </code><code class="nx">obj</code><code class="p">.</code><code class="nx">color</code><code class="p">)</code><code class="p">;</code><code>
                </code><code class="p">}</code><code>
                </code><code class="k">if</code><code> </code><code class="p">(</code><code class="o">!</code><code class="p">(</code><code class="nx">obj</code><code class="p">.</code><code class="nx">color</code><code> </code><code class="k">in</code><code> </code><code class="nx">mem</code><code class="p">)</code><code class="p">)</code><code> </code><code class="p">{</code><code>
                    </code><code class="nx">add_timeseries</code><code class="p">(</code><code class="nx">mem</code><code class="p">,</code><code> </code><code class="nx">mem_chart</code><code class="p">,</code><code> </code><code class="nx">obj</code><code class="p">.</code><code class="nx">color</code><code class="p">)</code><code class="p">;</code><code>
                </code><code class="p">}</code><code>
                </code><code class="nx">cpu</code><code class="p">[</code><code class="nx">obj</code><code class="p">.</code><code class="nx">color</code><code class="p">]</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code>
                    </code><code class="nb">Date</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">obj</code><code class="p">.</code><code class="nx">timestamp</code><code class="p">)</code><code class="p">,</code><code> </code><code class="nx">obj</code><code class="p">.</code><code class="nx">cpu</code><code class="p">)</code><code class="p">;</code><code>  </code><a class="co" id="co_supplementary_material_CO2-6" href="#callout_supplementary_material_CO2-6"><img src="assets/6.png" alt="6"/></a><code>
                </code><code class="nx">mem</code><code class="p">[</code><code class="nx">obj</code><code class="p">.</code><code class="nx">color</code><code class="p">]</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code>
                    </code><code class="nb">Date</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">obj</code><code class="p">.</code><code class="nx">timestamp</code><code class="p">)</code><code class="p">,</code><code> </code><code class="nx">obj</code><code class="p">.</code><code class="nx">mem</code><code class="p">)</code><code class="p">;</code><code>
            </code><code class="p">}</code><code class="p">;</code><code>

            </code><code class="nx">cpu_chart</code><code class="p">.</code><code class="nx">streamTo</code><code class="p">(</code><code>
                </code><code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s2">"cpu_chart"</code><code class="p">)</code><code class="p">,</code><code> </code><code class="mi">1000</code><code>
            </code><code class="p">)</code><code class="p">;</code><code>
            </code><code class="nx">mem_chart</code><code class="p">.</code><code class="nx">streamTo</code><code class="p">(</code><code>
                </code><code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s2">"mem_chart"</code><code class="p">)</code><code class="p">,</code><code> </code><code class="mi">1000</code><code>
            </code><code class="p">)</code><code class="p">;</code><code>
        </code><code class="p">}</code><code>
    </code><code class="nt">&lt;/script&gt;</code><code>
    </code><code class="nt">&lt;style</code><code class="nt">&gt;</code><code>
        </code><code class="nt">h1</code><code> </code><code class="p">{</code><code>
            </code><code class="k">text-align</code><code class="o">:</code><code> </code><code class="nb">center</code><code class="p">;</code><code>
            </code><code class="k">font-family</code><code class="o">:</code><code> </code><code class="nb">sans-serif</code><code class="p">;</code><code>
        </code><code class="p">}</code><code>
    </code><code class="nt">&lt;/style&gt;</code><code>
</code><code class="nt">&lt;/head&gt;</code><code>
</code><code class="nt">&lt;body</code><code> </code><code class="na">onload=</code><code class="s">"createTimeline()"</code><code class="nt">&gt;</code><code>
    </code><code class="nt">&lt;h1</code><code class="nt">&gt;</code><code>CPU (%)</code><code class="nt">&lt;/h1&gt;</code><code>
    </code><code class="nt">&lt;canvas</code><code> </code><code class="na">id=</code><code class="s">"cpu_chart"</code><code> </code><code class="na">style=</code><code class="s">"width:100%; height:300px"</code><code class="nt">&gt;</code><code>
    </code><code class="nt">&lt;/canvas&gt;</code><code>
    </code><code class="nt">&lt;hr</code><code class="nt">&gt;</code><code>
    </code><code class="nt">&lt;h1</code><code class="nt">&gt;</code><code>Memory usage (MB)</code><code class="nt">&lt;/h1&gt;</code><code>
    </code><code class="nt">&lt;canvas</code><code> </code><code class="na">id=</code><code class="s">"mem_chart"</code><code> </code><code class="na">style=</code><code class="s">"width:100%; height:300px"</code><code class="nt">&gt;</code><code>
    </code><code class="nt">&lt;/canvas&gt;</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_supplementary_material_CO2-1" href="#co_supplementary_material_CO2-1"><img src="assets/1.png" alt="1"/></a></dt>
<dd><p><code>cpu</code> and <code>mem</code> are each a mapping of a color to a <code>TimeSeries()</code> instance.</p></dd>
<dt><a class="co" id="callout_supplementary_material_CO2-2" href="#co_supplementary_material_CO2-2"><img src="assets/2.png" alt="2"/></a></dt>
<dd><p>One chart instance is created for CPU, and one for memory usage.</p></dd>
<dt><a class="co" id="callout_supplementary_material_CO2-3" href="#co_supplementary_material_CO2-3"><img src="assets/3.png" alt="3"/></a></dt>
<dd><p>We create a <code>TimeSeries()</code> instance <em>inside</em> the <code>onmessage</code> event of
the <span class="keep-together"><code>EventSource()</code></span> instance. This means that any new data coming in (e.g.,
on a different color name) will automatically get a new time series
created for it. The <code>add_timeseries()</code> function creates the <code>TimeSeries()</code> instance and adds to the given chart instance.</p></dd>
<dt><a class="co" id="callout_supplementary_material_CO2-4" href="#co_supplementary_material_CO2-4"><img src="assets/4.png" alt="4"/></a></dt>
<dd><p>Create a new <code>EventSource()</code> instance on the <em>/feed</em> URL.  The browser
will connect to this endpoint on our server,  (<em>metric_server.py</em>). Note that
the browser will automatically try to reconnect if the connection is lost.
Server-sent events are often overlooked, but in many situations their simplicity makes them preferable to WebSockets.</p></dd>
<dt><a class="co" id="callout_supplementary_material_CO2-5" href="#co_supplementary_material_CO2-5"><img src="assets/5.png" alt="5"/></a></dt>
<dd><p>The <code>onmessage</code> event will fire every time the server sends data. Here
the data is parsed as JSON.</p></dd>
<dt><a class="co" id="callout_supplementary_material_CO2-6" href="#co_supplementary_material_CO2-6"><img src="assets/6.png" alt="6"/></a></dt>
<dd><p>Recall that the <code>cpu</code> identifier is a mapping of a color to a
<code>TimeSeries()</code> instance. Here, we obtain that time series and append data
to it.  We also obtain the timestamp and parse it to get the correct
format required by the chart.</p></dd>
</dl></div>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Database Trigger Handling for the asyncpg Case Study"><div class="sect1" id="appendix_trigger">
<h1>Database Trigger Handling for the asyncpg Case Study</h1>

<p>In <a data-type="xref" href="ch04.html#asyncpg_cs">“Case Study: Cache Invalidation”</a>, one of the required Python
source files was omitted in the interest of saving space.<a data-type="indexterm" data-primary="database trigger handling (asyncpg case study)" id="idm46363017281064"/><a data-type="indexterm" data-primary="asyncpg and Sanic" data-secondary="database trigger handling for case study" id="idm46363017273416"/>  That file
is presented in <a data-type="xref" href="#triggers">Example B-4</a>.</p>
<div id="triggers" data-type="example">
<h5><span class="label">Example B-4. </span>triggers.py</h5>

<pre data-type="programlisting" data-code-language="python3"><code class="c1"># triggers.py</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">asyncpg</code><code class="nn">.</code><code class="nn">connection</code><code> </code><code class="k">import</code><code> </code><code class="n">Connection</code><code>  </code><a class="co" id="co_supplementary_material_CO3-1" href="#callout_supplementary_material_CO3-1"><img src="assets/1.png" alt="1"/></a><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">create_notify_trigger</code><code class="p">(</code><code>  </code><a class="co" id="co_supplementary_material_CO3-2" href="#callout_supplementary_material_CO3-2"><img src="assets/2.png" alt="2"/></a><code>
</code><code>        </code><code class="n">conn</code><code class="p">:</code><code> </code><code class="n">Connection</code><code class="p">,</code><code>
</code><code>        </code><code class="n">trigger_name</code><code class="p">:</code><code> </code><code class="nb">str</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">table_update_notify</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>        </code><code class="n">channel</code><code class="p">:</code><code> </code><code class="nb">str</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">table_change</code><code class="s1">'</code><code class="p">)</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="kc">None</code><code class="p">:</code><code>
</code><code>    </code><code class="k">await</code><code> </code><code class="n">conn</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code>
</code><code>        </code><code class="s1">'</code><code class="s1">CREATE EXTENSION IF NOT EXISTS hstore</code><code class="s1">'</code><code class="p">)</code><code>  </code><a class="co" id="co_supplementary_material_CO3-3" href="#callout_supplementary_material_CO3-3"><img src="assets/3.png" alt="3"/></a><code>
</code><code>    </code><code class="k">await</code><code> </code><code class="n">conn</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code>
</code><code>            </code><code class="n">SQL_CREATE_TRIGGER</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code>
</code><code>                </code><code class="n">trigger_name</code><code class="o">=</code><code class="n">trigger_name</code><code class="p">,</code><code>
</code><code>                </code><code class="n">channel</code><code class="o">=</code><code class="n">channel</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" id="co_supplementary_material_CO3-4" href="#callout_supplementary_material_CO3-4"><img src="assets/4.png" alt="4"/></a><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">add_table_triggers</code><code class="p">(</code><code>  </code><a class="co" id="co_supplementary_material_CO3-5" href="#callout_supplementary_material_CO3-5"><img src="assets/5.png" alt="5"/></a><code>
</code><code>        </code><code class="n">conn</code><code class="p">:</code><code> </code><code class="n">Connection</code><code class="p">,</code><code>
</code><code>        </code><code class="n">table</code><code class="p">:</code><code> </code><code class="nb">str</code><code class="p">,</code><code>
</code><code>        </code><code class="n">trigger_name</code><code class="p">:</code><code> </code><code class="nb">str</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">table_update_notify</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>        </code><code class="n">schema</code><code class="p">:</code><code> </code><code class="nb">str</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">public</code><code class="s1">'</code><code class="p">)</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="kc">None</code><code class="p">:</code><code>
</code><code>    </code><code class="n">templates</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">SQL_TABLE_INSERT</code><code class="p">,</code><code> </code><code class="n">SQL_TABLE_UPDATE</code><code class="p">,</code><code>
</code><code>                 </code><code class="n">SQL_TABLE_DELETE</code><code class="p">)</code><code>  </code><a class="co" id="co_supplementary_material_CO3-6" href="#callout_supplementary_material_CO3-6"><img src="assets/6.png" alt="6"/></a><code>
</code><code>    </code><code class="k">for</code><code> </code><code class="n">template</code><code> </code><code class="ow">in</code><code> </code><code class="n">templates</code><code class="p">:</code><code>
</code><code>        </code><code class="k">await</code><code> </code><code class="n">conn</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code>
</code><code>            </code><code class="n">template</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code>
</code><code>                </code><code class="n">table</code><code class="o">=</code><code class="n">table</code><code class="p">,</code><code>
</code><code>                </code><code class="n">trigger_name</code><code class="o">=</code><code class="n">trigger_name</code><code class="p">,</code><code>
</code><code>                </code><code class="n">schema</code><code class="o">=</code><code class="n">schema</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" id="co_supplementary_material_CO3-7" href="#callout_supplementary_material_CO3-7"><img src="assets/7.png" alt="7"/></a><code>
</code><code>
</code><code class="n">SQL_CREATE_TRIGGER</code><code> </code><code class="o">=</code><code> </code><code class="s2">"""</code><code class="se">\
</code><code class="s2">CREATE OR REPLACE FUNCTION </code><code class="si">{trigger_name}</code><code class="s2">()</code><code class="s2">
</code><code class="s2">  RETURNS trigger AS $$</code><code class="s2">
</code><code class="s2">DECLARE</code><code class="s2">
</code><code class="s2">  id integer; -- or uuid</code><code class="s2">
</code><code class="s2">  data json;</code><code class="s2">
</code><code class="s2">BEGIN</code><code class="s2">
</code><code class="s2">  data = json </code><code class="s2">'</code><code class="s2">null</code><code class="s2">'</code><code class="s2">;</code><code class="s2">
</code><code class="s2">  IF TG_OP = </code><code class="s2">'</code><code class="s2">INSERT</code><code class="s2">'</code><code class="s2"> THEN</code><code class="s2">
</code><code class="s2">    id = NEW.id;</code><code class="s2">
</code><code class="s2">    data = row_to_json(NEW);</code><code class="s2">
</code><code class="s2">  ELSIF TG_OP = </code><code class="s2">'</code><code class="s2">UPDATE</code><code class="s2">'</code><code class="s2"> THEN</code><code class="s2">
</code><code class="s2">    id = NEW.id;</code><code class="s2">
</code><code class="s2">    data = json_build_object(</code><code class="s2">
</code><code class="s2">      </code><code class="s2">'</code><code class="s2">old</code><code class="s2">'</code><code class="s2">, row_to_json(OLD),</code><code class="s2">
</code><code class="s2">      </code><code class="s2">'</code><code class="s2">new</code><code class="s2">'</code><code class="s2">, row_to_json(NEW),</code><code class="s2">
</code><code class="s2">      </code><code class="s2">'</code><code class="s2">diff</code><code class="s2">'</code><code class="s2">, hstore_to_json(hstore(NEW) - hstore(OLD))</code><code class="s2">
</code><code class="s2">    );</code><code class="s2">
</code><code class="s2">  ELSE</code><code class="s2">
</code><code class="s2">    id = OLD.id;</code><code class="s2">
</code><code class="s2">    data = row_to_json(OLD);</code><code class="s2">
</code><code class="s2">  END IF;</code><code class="s2">
</code><code class="s2">  PERFORM</code><code class="s2">
</code><code class="s2">    pg_notify(</code><code class="s2">
</code><code class="s2">      </code><code class="s2">'</code><code class="si">{channel}</code><code class="s2">'</code><code class="s2">,</code><code class="s2">
</code><code class="s2">      json_build_object(</code><code class="s2">
</code><code class="s2">        </code><code class="s2">'</code><code class="s2">table</code><code class="s2">'</code><code class="s2">, TG_TABLE_NAME,</code><code class="s2">
</code><code class="s2">        </code><code class="s2">'</code><code class="s2">id</code><code class="s2">'</code><code class="s2">, id,</code><code class="s2">
</code><code class="s2">        </code><code class="s2">'</code><code class="s2">type</code><code class="s2">'</code><code class="s2">, TG_OP,</code><code class="s2">
</code><code class="s2">        </code><code class="s2">'</code><code class="s2">data</code><code class="s2">'</code><code class="s2">, data</code><code class="s2">
</code><code class="s2">      )::text</code><code class="s2">
</code><code class="s2">    );</code><code class="s2">
</code><code class="s2">  RETURN NEW;</code><code class="s2">
</code><code class="s2">END;</code><code class="s2">
</code><code class="s2">$$ LANGUAGE plpgsql;</code><code class="s2">
</code><code class="s2">"""</code><code>  </code><a class="co" id="co_supplementary_material_CO3-8" href="#callout_supplementary_material_CO3-8"><img src="assets/8.png" alt="8"/></a><code>
</code><code>
</code><code class="n">SQL_TABLE_UPDATE</code><code> </code><code class="o">=</code><code> </code><code class="s2">"""</code><code class="se">\
</code><code class="s2">DROP TRIGGER IF EXISTS</code><code class="s2">
</code><code class="s2">  </code><code class="si">{table}</code><code class="s2">_notify_update ON </code><code class="si">{schema}</code><code class="s2">.</code><code class="si">{table}</code><code class="s2">;</code><code class="s2">
</code><code class="s2">CREATE TRIGGER </code><code class="si">{table}</code><code class="s2">_notify_update</code><code class="s2">
</code><code class="s2">  AFTER UPDATE ON </code><code class="si">{schema}</code><code class="s2">.</code><code class="si">{table}</code><code class="s2">
</code><code class="s2">    FOR EACH ROW</code><code class="s2">
</code><code class="s2">      EXECUTE PROCEDURE </code><code class="si">{trigger_name}</code><code class="s2">();</code><code class="s2">
</code><code class="s2">"""</code><code>  </code><a class="co" id="co_supplementary_material_CO3-9" href="#callout_supplementary_material_CO3-9"><img src="assets/9.png" alt="9"/></a><code>
</code><code>
</code><code class="n">SQL_TABLE_INSERT</code><code> </code><code class="o">=</code><code> </code><code class="s2">"""</code><code class="se">\
</code><code class="s2">DROP TRIGGER IF EXISTS</code><code class="s2">
</code><code class="s2">  </code><code class="si">{table}</code><code class="s2">_notify_insert ON </code><code class="si">{schema}</code><code class="s2">.</code><code class="si">{table}</code><code class="s2">;</code><code class="s2">
</code><code class="s2">CREATE TRIGGER </code><code class="si">{table}</code><code class="s2">_notify_insert</code><code class="s2">
</code><code class="s2">  AFTER INSERT ON </code><code class="si">{schema}</code><code class="s2">.</code><code class="si">{table}</code><code class="s2">
</code><code class="s2">    FOR EACH ROW</code><code class="s2">
</code><code class="s2">      EXECUTE PROCEDURE </code><code class="si">{trigger_name}</code><code class="s2">();</code><code class="s2">
</code><code class="s2">"""</code><code>
</code><code>
</code><code class="n">SQL_TABLE_DELETE</code><code> </code><code class="o">=</code><code> </code><code class="s2">"""</code><code class="se">\
</code><code class="s2">DROP TRIGGER IF EXISTS</code><code class="s2">
</code><code class="s2">  </code><code class="si">{table}</code><code class="s2">_notify_delete ON </code><code class="si">{schema}</code><code class="s2">.</code><code class="si">{table}</code><code class="s2">;</code><code class="s2">
</code><code class="s2">CREATE TRIGGER </code><code class="si">{table}</code><code class="s2">_notify_delete</code><code class="s2">
</code><code class="s2">  AFTER DELETE ON </code><code class="si">{schema}</code><code class="s2">.</code><code class="si">{table}</code><code class="s2">
</code><code class="s2">    FOR EACH ROW</code><code class="s2">
</code><code class="s2">      EXECUTE PROCEDURE </code><code class="si">{trigger_name}</code><code class="s2">();</code><code class="s2">
</code><code class="s2">"""</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_supplementary_material_CO3-1" href="#co_supplementary_material_CO3-1"><img src="assets/1.png" alt="1"/></a></dt>
<dd><p>These functions require <code>asyncpg</code>, although this import is used only to allow <span class="keep-together"><code>Connection</code></span> to be used in type annotations.</p></dd>
<dt><a class="co" id="callout_supplementary_material_CO3-2" href="#co_supplementary_material_CO3-2"><img src="assets/2.png" alt="2"/></a></dt>
<dd><p>The <code>create_notify_trigger()</code> coroutine function will create
the trigger function itself in the database. The trigger function
will contain the name of the channel that updates will be sent to. The
code for the function itself is in the <span class="keep-together"><code>SQL_CREATE_TRIGGER</code></span>
identifier, and it is set up as a format string.</p></dd>
<dt><a class="co" id="callout_supplementary_material_CO3-3" href="#co_supplementary_material_CO3-3"><img src="assets/3.png" alt="3"/></a></dt>
<dd><p>Recall from the case study example that update notifications
included a “diff” section in which the difference between old and
new data was shown. We use the <code>hstore</code> feature of PostgreSQL to
calculate that diff. It provides something close to the semantics
of sets. The <code>hstore</code> extension is not enabled by default, so we
enable it here.</p></dd>
<dt><a class="co" id="callout_supplementary_material_CO3-4" href="#co_supplementary_material_CO3-4"><img src="assets/4.png" alt="4"/></a></dt>
<dd><p>The desired trigger name and channel are substituted into the
template and then executed.</p></dd>
<dt><a class="co" id="callout_supplementary_material_CO3-5" href="#co_supplementary_material_CO3-5"><img src="assets/5.png" alt="5"/></a></dt>
<dd><p>The second function, <code>add_table_triggers()</code>, connects the
trigger function to table events like insert, update, and delete.</p></dd>
<dt><a class="co" id="callout_supplementary_material_CO3-6" href="#co_supplementary_material_CO3-6"><img src="assets/6.png" alt="6"/></a></dt>
<dd><p>There are three format strings for each of the three methods.</p></dd>
<dt><a class="co" id="callout_supplementary_material_CO3-7" href="#co_supplementary_material_CO3-7"><img src="assets/7.png" alt="7"/></a></dt>
<dd><p>The desired variables are substituted into the templates and
then executed.</p></dd>
<dt><a class="co" id="callout_supplementary_material_CO3-8" href="#co_supplementary_material_CO3-8"><img src="assets/8.png" alt="8"/></a></dt>
<dd><p>This SQL code took me a lot longer than expected to get
exactly right! This <span class="keep-together">PostgreSQL</span> procedure is called for insert, update, and
delete events; the way to know which is to check the <code>TG_OP</code> variable.
If the operation is <code>INSERT</code>, then <code>NEW</code> will be defined (and <code>OLD</code>
will <em>not</em> be defined). For <code>DELETE</code>, <code>OLD</code> will be defined but
not <code>NEW</code>. For <code>UPDATE</code>, both are defined, which allows us to
calculate the diff. We also make use of PostgreSQL’s built-in
support for JSON with the <code>row_to_json()</code> and <code>hstore_to_json()</code>
functions: these mean that our callback handler will receive
valid JSON.<br/></p>

<p>Finally, the call to the <code>pg_notify()</code> function is what actually
sends the event. <em>All subscribers</em> on <code>{channel}</code> will receive
the notification.</p></dd>
<dt><a class="co" id="callout_supplementary_material_CO3-9" href="#co_supplementary_material_CO3-9"><img src="assets/9.png" alt="9"/></a></dt>
<dd><p>This is standard trigger code: it sets up a
trigger to call a specific procedure <code>{trigger_name}()</code> when a
specific event occurs, like an <code>INSERT</code> or an <code>UPDATE</code>.</p></dd>
</dl></div>

<p>There are sure to be many useful applications that can be
built around notifications received from PostgreSQL.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Supplementary Material for the Sanic Example: aelapsed and aprofiler"><div class="sect1" id="appendix_perf">
<h1>Supplementary Material for the Sanic Example: aelapsed and aprofiler</h1>

<p>The Sanic case study (see <a href="ch04.html#asyncpg_cs"><em>asyncpg</em> case study</a>) included utility decorators for printing out
elapsed time taken by a function.<a data-type="indexterm" data-primary="Sanic web framework" data-secondary="code for aelapsed and aprofiler" id="idm46363016704056"/> These are shown in <a data-type="xref" href="#aelapsed">Example B-5</a>.</p>
<div id="aelapsed" data-type="example">
<h5><span class="label">Example B-5. </span>perf.py</h5>

<pre data-type="programlisting" data-code-language="python3"><code class="c1"># perf.py</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">logging</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">time</code><code> </code><code class="k">import</code><code> </code><code class="n">perf_counter</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">inspect</code><code> </code><code class="k">import</code><code> </code><code class="n">iscoroutinefunction</code><code>
</code><code>
</code><code class="n">logger</code><code> </code><code class="o">=</code><code> </code><code class="n">logging</code><code class="o">.</code><code class="n">getLogger</code><code class="p">(</code><code class="s1">'</code><code class="s1">perf</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>
</code><code class="k">def</code><code> </code><code class="nf">aelapsed</code><code class="p">(</code><code class="n">corofn</code><code class="p">,</code><code> </code><code class="n">caption</code><code class="o">=</code><code class="s1">'</code><code class="s1">'</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" id="co_supplementary_material_CO4-1" href="#callout_supplementary_material_CO4-1"><img src="assets/1.png" alt="1"/></a><code>
</code><code>    </code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">wrapper</code><code class="p">(</code><code class="o">*</code><code class="n">args</code><code class="p">,</code><code> </code><code class="o">*</code><code class="o">*</code><code class="n">kwargs</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="n">t0</code><code> </code><code class="o">=</code><code> </code><code class="n">perf_counter</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="n">result</code><code> </code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="n">corofn</code><code class="p">(</code><code class="o">*</code><code class="n">args</code><code class="p">,</code><code> </code><code class="o">*</code><code class="o">*</code><code class="n">kwargs</code><code class="p">)</code><code>
</code><code>        </code><code class="n">delta</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">perf_counter</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">-</code><code> </code><code class="n">t0</code><code class="p">)</code><code> </code><code class="o">*</code><code> </code><code class="mf">1e3</code><code>
</code><code>        </code><code class="n">logger</code><code class="o">.</code><code class="n">info</code><code class="p">(</code><code>
</code><code>            </code><code class="n">f</code><code class="s1">'</code><code class="si">{caption}</code><code class="s1"> Elapsed: </code><code class="si">{delta:.2f}</code><code class="s1"> ms</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">result</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">wrapper</code><code>
</code><code>
</code><code class="k">def</code><code> </code><code class="nf">aprofiler</code><code class="p">(</code><code class="bp">cls</code><code class="p">,</code><code> </code><code class="n">bases</code><code class="p">,</code><code> </code><code class="n">members</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" id="co_supplementary_material_CO4-2" href="#callout_supplementary_material_CO4-2"><img src="assets/2.png" alt="2"/></a><code>
</code><code>    </code><code class="k">for</code><code> </code><code class="n">k</code><code class="p">,</code><code> </code><code class="n">v</code><code> </code><code class="ow">in</code><code> </code><code class="n">members</code><code class="o">.</code><code class="n">items</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="n">iscoroutinefunction</code><code class="p">(</code><code class="n">v</code><code class="p">)</code><code class="p">:</code><code>
</code><code>            </code><code class="n">members</code><code class="p">[</code><code class="n">k</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">aelapsed</code><code class="p">(</code><code class="n">v</code><code class="p">,</code><code> </code><code class="n">k</code><code class="p">)</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="nb">type</code><code class="o">.</code><code class="nf-Magic">__new__</code><code class="p">(</code><code class="nb">type</code><code class="p">,</code><code> </code><code class="bp">cls</code><code class="p">,</code><code> </code><code class="n">bases</code><code class="p">,</code><code> </code><code class="n">members</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_supplementary_material_CO4-1" href="#co_supplementary_material_CO4-1"><img src="assets/1.png" alt="1"/></a></dt>
<dd><p>The <code>aelapsed()</code> decorator will record the time taken to
execute the wrapped coroutine.<a data-type="indexterm" data-primary="aelapsed decorator" id="idm46363016333112"/></p></dd>
<dt><a class="co" id="callout_supplementary_material_CO4-2" href="#co_supplementary_material_CO4-2"><img src="assets/2.png" alt="2"/></a></dt>
<dd><p>The <code>aprofiler()</code> metaclass will make sure that every
member of the class that is a coroutine function will get
wrapped in the <code>aelapsed()</code> decorator.<a data-type="indexterm" data-primary="aprofiler metaclass" id="idm46363016328968"/><a data-type="indexterm" data-primary="code" data-secondary="supplementary, for case studies in this book" data-startref="ix_codecs" id="idm46363016616424"/></p></dd>
</dl></div>
</div></section>







</div></section></body></html>