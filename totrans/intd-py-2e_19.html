<html><head></head><body><section data-pdf-bookmark="Chapter 17. Data in Space: Networks" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch_networks">&#13;
<h1><span class="label">Chapter 17. </span>Data in Space: Networks</h1>&#13;
&#13;
<blockquote>&#13;
<p><a data-primary="networks/networking" data-type="indexterm" id="ix_ch17-networks-asciidoc0"/>Time is nature’s way of keeping everything from happening at once.&#13;
Space is what prevents everything from happening to me.</p>&#13;
<p data-type="attribution"><a href="http://bit.ly/wiki-time">Quotes About Time</a></p>&#13;
</blockquote>&#13;
&#13;
<p>In <a data-type="xref" href="ch15.html#ch_systems">Chapter 15</a>, you read about <em>concurrency</em>:&#13;
how to do more than one thing at a time.&#13;
Now we’ll try to do things in more than one place:&#13;
<em>distributed computing</em> or <em>networking</em>.&#13;
There are many good reasons to challenge time and space:</p>&#13;
<dl>&#13;
<dt>Performance</dt>&#13;
<dd>&#13;
<p>Your goal is to keep fast components busy, not waiting for slow ones.</p>&#13;
</dd>&#13;
<dt>Robustness</dt>&#13;
<dd>&#13;
<p>There’s safety in numbers, so you want to duplicate tasks to work&#13;
around hardware and software failures.</p>&#13;
</dd>&#13;
<dt>Simplicity</dt>&#13;
<dd>&#13;
<p>It’s best practice to break complex tasks into&#13;
many little ones that are easier to create, understand, and fix.</p>&#13;
</dd>&#13;
<dt>Scalability</dt>&#13;
<dd>&#13;
<p>Increase your servers to handle load,&#13;
decrease them to save money.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>In this chapter,&#13;
we work our way up&#13;
from networking primitives&#13;
to higher-level concepts.&#13;
Let’s start with TCP/IP and sockets.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="TCP/IP" data-type="sect1"><div class="sect1" id="tcp_ip">&#13;
<h1>TCP/IP</h1>&#13;
&#13;
<p><a data-primary="TCP/IP (Transmission Control Protocol/Internet Protocol)" data-type="indexterm" id="ix_ch17-networks-asciidoc1"/>The internet is based on rules about how to make connections,&#13;
exchange data, terminate connections, handle timeouts, and so on.&#13;
<a data-primary="layers" data-type="indexterm" id="idm45794973027368"/>These are called <em>protocols</em>, and they are arranged in <em>layers</em>.&#13;
The purpose of layers is to allow&#13;
innovation and alternative ways of doing things;&#13;
you can do anything you want on one layer&#13;
as long as you follow the conventions&#13;
in dealing with the layers above and below you.</p>&#13;
&#13;
<p>The very lowest layer governs aspects such as&#13;
electrical signals; each higher layer builds on those below.&#13;
In the middle, more or less, is the IP (Internet Protocol) layer,&#13;
which specifies how network locations are addressed&#13;
and how <em>packets</em> (chunks) of data flow.&#13;
In the layer above that, two protocols describe&#13;
how to move bytes between locations:</p>&#13;
<dl>&#13;
<dt>UDP (User Datagram Protocol)</dt>&#13;
<dd>&#13;
<p><a data-primary="UDP (User Datagram Protocol)" data-type="indexterm" id="idm45794973022984"/>This is used for short exchanges.&#13;
A <em>datagram</em> is a tiny message sent in a single burst,&#13;
like a note on a postcard.</p>&#13;
</dd>&#13;
<dt>TCP (Transmission Control Protocol)</dt>&#13;
<dd>&#13;
<p><a data-primary="TCP (Transmission Control Protocol)" data-type="indexterm" id="idm45794973020376"/>This protocol is used for longer-lived connections.&#13;
It sends <em>streams</em> of bytes and ensures&#13;
that they arrive in order without duplication.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>UDP messages are not acknowledged,&#13;
so you’re never sure whether they arrive at their destination.&#13;
If you wanted to tell a joke over UDP:</p>&#13;
&#13;
<pre data-type="programlisting">Here's a UDP joke. Get it?</pre>&#13;
&#13;
<p>TCP sets up a secret handshake between sender and receiver&#13;
to ensure a good connection.&#13;
A TCP joke would start like this:</p>&#13;
&#13;
<pre data-type="programlisting">Do you want to hear a TCP joke?&#13;
Yes, I want to hear a TCP joke.&#13;
Okay, I'll tell you a TCP joke.&#13;
Okay, I'll hear a TCP joke.&#13;
Okay, I'll send you a TCP joke now.&#13;
Okay, I'll receive the TCP joke now.&#13;
... (and so on)</pre>&#13;
&#13;
<p>Your local machine always has the&#13;
IP address <code>127.0.0.1</code> and the name <code>localhost</code>.&#13;
You might see this called the <em>loopback interface</em>.&#13;
If it’s connected to the internet,&#13;
your machine will also have a <em>public</em> IP.&#13;
If you’re just using a home computer,&#13;
it’s behind equipment such as&#13;
a cable modem or router.&#13;
You can run internet protocols even between&#13;
processes on the same machine.</p>&#13;
&#13;
<p>Most of the internet with which we interact—the web, database servers,&#13;
and so on—is based on the TCP protocol running atop the IP protocol;&#13;
for brevity, TCP/IP.&#13;
Let’s first look at some basic internet services.&#13;
After that, we explore general networking patterns.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before" data-pdf-bookmark="Sockets" data-type="sect2"><div class="sect2" id="sockets">&#13;
<h2>Sockets</h2>&#13;
&#13;
<p><a data-primary="sockets" data-type="indexterm" id="ix_ch17-networks-asciidoc2"/><a data-primary="TCP/IP (Transmission Control Protocol/Internet Protocol)" data-secondary="sockets" data-type="indexterm" id="ix_ch17-networks-asciidoc3"/>If you like to know how things work, all the way down,&#13;
this section is for you.</p>&#13;
&#13;
<p>The lowest level of network programming uses a <em>socket</em>,&#13;
borrowed from the C language and the Unix operating system.&#13;
Socket-level coding is tedious.&#13;
You’ll have more fun using something like ZeroMQ,&#13;
but it’s useful to see what lies beneath.&#13;
For instance, messages about sockets often turn up&#13;
when networking errors take place.</p>&#13;
&#13;
<p>Let’s write a very simple client-server exchange,&#13;
once with UDP and once with TCP.&#13;
In the UDP example,&#13;
the client sends a string in a UDP datagram to a server,&#13;
and the server returns a packet of data containing a string.&#13;
The server needs to listen at a particular address and port—like a post office and a post office box.&#13;
The client needs to know these two values to deliver its message&#13;
and receive any reply.</p>&#13;
&#13;
<p>In the following client and server code,&#13;
<code>address</code> is a tuple of (<em>address</em>, <em>port</em>).&#13;
The <code>address</code> is a string, which can be a name or an <em>IP address</em>.&#13;
When your programs are just talking to one another&#13;
on the same machine,&#13;
you can use the name <code>'localhost'</code>&#13;
or the equivalent address string <code>'127.0.0.1'</code>.</p>&#13;
&#13;
<p>First, let’s send a little data from one process to another&#13;
and return a little data back to the originator.&#13;
The first program is the client and the second is the server.&#13;
In each program, we print the time and open a socket.&#13;
The server will listen for connections to its socket,&#13;
and the client will write to its socket,&#13;
which transmits a message to the server.</p>&#13;
&#13;
<p><a data-type="xref" href="#udp_server">Example 17-1</a> presents the first program, <em>udp_server.py</em>.</p>&#13;
<div data-type="example" id="udp_server">&#13;
<h5><span class="label">Example 17-1. </span>udp_server.py</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">datetime</code> <code class="kn">import</code> <code class="n">datetime</code>&#13;
<code class="kn">import</code> <code class="nn">socket</code>&#13;
&#13;
<code class="n">server_address</code> <code class="o">=</code> <code class="p">(</code><code class="s1">'localhost'</code><code class="p">,</code> <code class="mi">6789</code><code class="p">)</code>&#13;
<code class="n">max_size</code> <code class="o">=</code> <code class="mi">4096</code>&#13;
&#13;
<code class="k">print</code><code class="p">(</code><code class="s1">'Starting the server at'</code><code class="p">,</code> <code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">())</code>&#13;
<code class="k">print</code><code class="p">(</code><code class="s1">'Waiting for a client to call.'</code><code class="p">)</code>&#13;
<code class="n">server</code> <code class="o">=</code> <code class="n">socket</code><code class="o">.</code><code class="n">socket</code><code class="p">(</code><code class="n">socket</code><code class="o">.</code><code class="n">AF_INET</code><code class="p">,</code> <code class="n">socket</code><code class="o">.</code><code class="n">SOCK_DGRAM</code><code class="p">)</code>&#13;
<code class="n">server</code><code class="o">.</code><code class="n">bind</code><code class="p">(</code><code class="n">server_address</code><code class="p">)</code>&#13;
&#13;
<code class="n">data</code><code class="p">,</code> <code class="n">client</code> <code class="o">=</code> <code class="n">server</code><code class="o">.</code><code class="n">recvfrom</code><code class="p">(</code><code class="n">max_size</code><code class="p">)</code>&#13;
&#13;
<code class="k">print</code><code class="p">(</code><code class="s1">'At'</code><code class="p">,</code> <code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(),</code> <code class="n">client</code><code class="p">,</code> <code class="s1">'said'</code><code class="p">,</code> <code class="n">data</code><code class="p">)</code>&#13;
<code class="n">server</code><code class="o">.</code><code class="n">sendto</code><code class="p">(</code><code class="s-Affix">b</code><code class="s1">'Are you talking to me?'</code><code class="p">,</code> <code class="n">client</code><code class="p">)</code>&#13;
<code class="n">server</code><code class="o">.</code><code class="n">close</code><code class="p">()</code></pre></div>&#13;
&#13;
<p>The server has to set up networking through&#13;
two methods imported from the <code>socket</code> package.&#13;
The first method, <code>socket.socket</code>, creates a socket,&#13;
and the second, <code>bind</code>, <em>binds</em> to it&#13;
(listens to any data arriving at that IP address and port).&#13;
<code>AF_INET</code> means we’ll create an IP socket.&#13;
(There’s another type for <em>Unix domain sockets</em>,&#13;
but those work only on the local machine.)&#13;
<code>SOCK_DGRAM</code> means we’ll send and receive datagrams—in other words, we’ll use UDP.</p>&#13;
&#13;
<p>At this point, the server sits and waits for a datagram&#13;
to come in (<code>recvfrom</code>).&#13;
When one arrives, the server wakes up and gets&#13;
both the data and information about the client.&#13;
The <code>client</code> variable contains the address and port combination&#13;
needed to reach the client.&#13;
The server ends by sending a reply and closing its connection.</p>&#13;
&#13;
<p>Let’s take a look at <em>udp_client.py</em> (<a data-type="xref" href="#udp_client">Example 17-2</a>).</p>&#13;
<div data-type="example" id="udp_client">&#13;
<h5><span class="label">Example 17-2. </span>udp_client.py</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">socket</code>&#13;
<code class="kn">from</code> <code class="nn">datetime</code> <code class="kn">import</code> <code class="n">datetime</code>&#13;
&#13;
<code class="n">server_address</code> <code class="o">=</code> <code class="p">(</code><code class="s1">'localhost'</code><code class="p">,</code> <code class="mi">6789</code><code class="p">)</code>&#13;
<code class="n">max_size</code> <code class="o">=</code> <code class="mi">4096</code>&#13;
&#13;
<code class="k">print</code><code class="p">(</code><code class="s1">'Starting the client at'</code><code class="p">,</code> <code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">())</code>&#13;
<code class="n">client</code> <code class="o">=</code> <code class="n">socket</code><code class="o">.</code><code class="n">socket</code><code class="p">(</code><code class="n">socket</code><code class="o">.</code><code class="n">AF_INET</code><code class="p">,</code> <code class="n">socket</code><code class="o">.</code><code class="n">SOCK_DGRAM</code><code class="p">)</code>&#13;
<code class="n">client</code><code class="o">.</code><code class="n">sendto</code><code class="p">(</code><code class="s-Affix">b</code><code class="s1">'Hey!'</code><code class="p">,</code> <code class="n">server_address</code><code class="p">)</code>&#13;
<code class="n">data</code><code class="p">,</code> <code class="n">server</code> <code class="o">=</code> <code class="n">client</code><code class="o">.</code><code class="n">recvfrom</code><code class="p">(</code><code class="n">max_size</code><code class="p">)</code>&#13;
<code class="k">print</code><code class="p">(</code><code class="s1">'At'</code><code class="p">,</code> <code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(),</code> <code class="n">server</code><code class="p">,</code> <code class="s1">'said'</code><code class="p">,</code> <code class="n">data</code><code class="p">)</code>&#13;
<code class="n">client</code><code class="o">.</code><code class="n">close</code><code class="p">()</code></pre></div>&#13;
&#13;
<p>The client has most of the same methods as the server&#13;
(with the exception of <code>bind()</code>).&#13;
The client sends and then receives,&#13;
whereas the server receives first.</p>&#13;
&#13;
<p>Start the server first, in its own window.&#13;
It will print its greeting&#13;
and then wait with an eerie calm until a client sends it some data:</p>&#13;
<pre>$ <strong>python udp_server.py</strong>&#13;
Starting the server at 2014-02-05 21:17:41.945649&#13;
Waiting for a client to call.</pre>&#13;
&#13;
<p>Next, start the client in another window.&#13;
It will print its greeting,&#13;
send data (the bytes value <code>'Hey'</code>)&#13;
to the server,&#13;
print the reply, and then exit:</p>&#13;
<pre>$ <strong>python udp_client.py</strong>&#13;
Starting the client at 2014-02-05 21:24:56.509682&#13;
At 2014-02-05 21:24:56.518670 ('127.0.0.1', 6789) said b'Are you talking to me?'</pre>&#13;
&#13;
<p>Finally,&#13;
the server will print the message it received,&#13;
and exit:</p>&#13;
&#13;
<pre data-type="programlisting">At 2014-02-05 21:24:56.518473 ('127.0.0.1', 56267) said b'Hey!'</pre>&#13;
&#13;
<p>The client needed to know the server’s address and port number&#13;
but didn’t need to specify a port number for itself.&#13;
That was automatically assigned by the system—in this case,&#13;
it was <code>56267</code>.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>UDP sends data in single chunks.&#13;
It does not guarantee delivery.&#13;
If you send multiple messages via UDP,&#13;
they can arrive out of order, or not at all.&#13;
It’s fast, light, connectionless, and unreliable.&#13;
UDP is useful when you need to push packets quickly,&#13;
and can tolerate a lost packet now and then, such as&#13;
with VoIP (voice over IP).</p>&#13;
</div>&#13;
&#13;
<p><a data-primary="TCP (Transmission Control Protocol)" data-type="indexterm" id="ix_ch17-networks-asciidoc4"/>Which brings us to TCP (Transmission Control Protocol).&#13;
TCP is used for longer-lived connections,&#13;
such as the web.&#13;
TCP delivers data in the order in which you send it.&#13;
If there were any problems, it tries to send it again.&#13;
This makes TCP a bit slower than UDP,&#13;
but usually a better choice when you need all the packets,&#13;
in the right order.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>The first two versions of the web protocol HTTP were&#13;
based on TCP, but HTTP/3 is based on a protocol called&#13;
<a href="https://oreil.ly/Y3Jym">QUIC</a>,&#13;
which itself uses UDP.&#13;
So choosing between UDP and TCP can involve many factors.</p>&#13;
</div>&#13;
&#13;
<p>Let’s shoot a few packets from client to server and back with TCP.</p>&#13;
&#13;
<p><em>tcp_client.py</em> acts like the previous UDP client,&#13;
sending only one string to the server,&#13;
but there are small differences in the socket calls,&#13;
illustrated in <a data-type="xref" href="#tcp_client">Example 17-3</a>.</p>&#13;
<div data-type="example" id="tcp_client">&#13;
<h5><span class="label">Example 17-3. </span>tcp_client.py</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">socket</code>&#13;
<code class="kn">from</code> <code class="nn">datetime</code> <code class="kn">import</code> <code class="n">datetime</code>&#13;
&#13;
<code class="n">address</code> <code class="o">=</code> <code class="p">(</code><code class="s1">'localhost'</code><code class="p">,</code> <code class="mi">6789</code><code class="p">)</code>&#13;
<code class="n">max_size</code> <code class="o">=</code> <code class="mi">1000</code>&#13;
&#13;
<code class="k">print</code><code class="p">(</code><code class="s1">'Starting the client at'</code><code class="p">,</code> <code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">())</code>&#13;
<code class="n">client</code> <code class="o">=</code> <code class="n">socket</code><code class="o">.</code><code class="n">socket</code><code class="p">(</code><code class="n">socket</code><code class="o">.</code><code class="n">AF_INET</code><code class="p">,</code> <code class="n">socket</code><code class="o">.</code><code class="n">SOCK_STREAM</code><code class="p">)</code>&#13;
<code class="n">client</code><code class="o">.</code><code class="n">connect</code><code class="p">(</code><code class="n">address</code><code class="p">)</code>&#13;
<code class="n">client</code><code class="o">.</code><code class="n">sendall</code><code class="p">(</code><code class="s-Affix">b</code><code class="s1">'Hey!'</code><code class="p">)</code>&#13;
<code class="n">data</code> <code class="o">=</code> <code class="n">client</code><code class="o">.</code><code class="n">recv</code><code class="p">(</code><code class="n">max_size</code><code class="p">)</code>&#13;
<code class="k">print</code><code class="p">(</code><code class="s1">'At'</code><code class="p">,</code> <code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(),</code> <code class="s1">'someone replied'</code><code class="p">,</code> <code class="n">data</code><code class="p">)</code>&#13;
<code class="n">client</code><code class="o">.</code><code class="n">close</code><code class="p">()</code></pre></div>&#13;
&#13;
<p>We’ve replaced <code>SOCK_DGRAM</code> with <code>SOCK_STREAM</code>&#13;
to get the streaming protocol, TCP.&#13;
We also added a <code>connect()</code> call to set up the stream.&#13;
We didn’t need that for UDP because each datagram&#13;
was on its own&#13;
in the wild, wooly internet.</p>&#13;
&#13;
<p>As <a data-type="xref" href="#tcp_server">Example 17-4</a> demonstrates, <em>tcp_server.py</em> also differs from its UDP cousin.</p>&#13;
<div data-type="example" id="tcp_server">&#13;
<h5><span class="label">Example 17-4. </span>tcp_server.py</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">datetime</code> <code class="kn">import</code> <code class="n">datetime</code>&#13;
<code class="kn">import</code> <code class="nn">socket</code>&#13;
&#13;
<code class="n">address</code> <code class="o">=</code> <code class="p">(</code><code class="s1">'localhost'</code><code class="p">,</code> <code class="mi">6789</code><code class="p">)</code>&#13;
<code class="n">max_size</code> <code class="o">=</code> <code class="mi">1000</code>&#13;
&#13;
<code class="k">print</code><code class="p">(</code><code class="s1">'Starting the server at'</code><code class="p">,</code> <code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">())</code>&#13;
<code class="k">print</code><code class="p">(</code><code class="s1">'Waiting for a client to call.'</code><code class="p">)</code>&#13;
<code class="n">server</code> <code class="o">=</code> <code class="n">socket</code><code class="o">.</code><code class="n">socket</code><code class="p">(</code><code class="n">socket</code><code class="o">.</code><code class="n">AF_INET</code><code class="p">,</code> <code class="n">socket</code><code class="o">.</code><code class="n">SOCK_STREAM</code><code class="p">)</code>&#13;
<code class="n">server</code><code class="o">.</code><code class="n">bind</code><code class="p">(</code><code class="n">address</code><code class="p">)</code>&#13;
<code class="n">server</code><code class="o">.</code><code class="n">listen</code><code class="p">(</code><code class="mi">5</code><code class="p">)</code>&#13;
&#13;
<code class="n">client</code><code class="p">,</code> <code class="n">addr</code> <code class="o">=</code> <code class="n">server</code><code class="o">.</code><code class="n">accept</code><code class="p">()</code>&#13;
<code class="n">data</code> <code class="o">=</code> <code class="n">client</code><code class="o">.</code><code class="n">recv</code><code class="p">(</code><code class="n">max_size</code><code class="p">)</code>&#13;
&#13;
<code class="k">print</code><code class="p">(</code><code class="s1">'At'</code><code class="p">,</code> <code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(),</code> <code class="n">client</code><code class="p">,</code> <code class="s1">'said'</code><code class="p">,</code> <code class="n">data</code><code class="p">)</code>&#13;
<code class="n">client</code><code class="o">.</code><code class="n">sendall</code><code class="p">(</code><code class="s-Affix">b</code><code class="s1">'Are you talking to me?'</code><code class="p">)</code>&#13;
<code class="n">client</code><code class="o">.</code><code class="n">close</code><code class="p">()</code>&#13;
<code class="n">server</code><code class="o">.</code><code class="n">close</code><code class="p">()</code></pre></div>&#13;
&#13;
<p><code>server.listen(5)</code> is configured to queue up to&#13;
five client connections&#13;
before refusing new ones.&#13;
<code>server.accept()</code> gets the first available message&#13;
as it arrives.</p>&#13;
&#13;
<p>The <code>client.recv(1000)</code> sets a maximum acceptable message&#13;
length of 1,000 bytes.</p>&#13;
&#13;
<p>As you did earlier, start the server and then the client,&#13;
and watch the fun.&#13;
First, the server:</p>&#13;
<pre>$ <strong>python tcp_server.py</strong>&#13;
Starting the server at 2014-02-06 22:45:13.306971&#13;
Waiting for a client to call.&#13;
At 2014-02-06 22:45:16.048865 &lt;socket.socket object, fd=6, family=2, type=1,&#13;
    proto=0&gt; said b'Hey!'</pre>&#13;
&#13;
<p>Now, start the client.&#13;
It will send its message to the server,&#13;
receive a response, and then exit:</p>&#13;
<pre>$ <strong>python tcp_client.py</strong>&#13;
Starting the client at 2014-02-06 22:45:16.038642&#13;
At 2014-02-06 22:45:16.049078 someone replied b'Are you talking to me?'</pre>&#13;
&#13;
<p>The server collects the message, prints it,&#13;
responds, and then quits:</p>&#13;
&#13;
<pre data-type="programlisting">At 2014-02-06 22:45:16.048865 &lt;socket.socket object, fd=6, family=2, type=1,&#13;
    proto=0&gt; said b'Hey!'</pre>&#13;
&#13;
<p>Notice that the TCP server called <code>client.sendall()</code> to respond,&#13;
and the earlier UDP server called <code>client.sendto()</code>.&#13;
TCP maintains the client-server connection across&#13;
multiple socket calls and remembers the client’s IP address.</p>&#13;
&#13;
<p>This didn’t look so bad,&#13;
but if you try to write anything more complex,&#13;
you’ll see how sockets really operate at a low level:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>UDP sends messages, but their size is limited&#13;
and they’re not guaranteed to reach their destination.</p>&#13;
</li>&#13;
<li>&#13;
<p>TCP sends streams of bytes, not messages.&#13;
You don’t know how many bytes the system will&#13;
send or receive with each call.</p>&#13;
</li>&#13;
<li>&#13;
<p>To exchange entire messages with TCP,&#13;
you need some extra information to reassemble the full message&#13;
from its segments: a fixed message size (bytes),&#13;
or the size of the full message,&#13;
or some delimiting character.</p>&#13;
</li>&#13;
<li>&#13;
<p>Because messages are bytes,&#13;
not Unicode text strings,&#13;
you need to use the Python <code>bytes</code> type.&#13;
For more information on that, see <a data-type="xref" href="ch12.html#ch_munging">Chapter 12</a>.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>After all of this, if you find yourself interested&#13;
in socket programming, check out the&#13;
Python socket programming&#13;
<a href="http://bit.ly/socket-howto">HOWTO</a>&#13;
for more details<a data-startref="ix_ch17-networks-asciidoc4" data-type="indexterm" id="idm45794972508136"/>.<a data-startref="ix_ch17-networks-asciidoc3" data-type="indexterm" id="idm45794972507256"/><a data-startref="ix_ch17-networks-asciidoc2" data-type="indexterm" id="idm45794972506536"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Scapy" data-type="sect2"><div class="sect2" id="scapy">&#13;
<h2>Scapy</h2>&#13;
&#13;
<p><a data-primary="scapy library" data-type="indexterm" id="idm45794972505400"/><a data-primary="TCP/IP (Transmission Control Protocol/Internet Protocol)" data-secondary="scapy library" data-type="indexterm" id="idm45794972504696"/>Sometimes you need to dip into the networking stream and watch&#13;
the bytes swimming by.&#13;
You may want to debug a web API,&#13;
or track down some security issue.&#13;
The <code>scapy</code> library and program&#13;
provide a domain-specific language&#13;
to create and inspect packets in Python,&#13;
which is much easier than writing and debugging&#13;
the equivalent C programs.</p>&#13;
&#13;
<p>A standard install uses <code>pip install scapy</code>.&#13;
The <a href="https://scapy.readthedocs.io">docs</a> are extremely&#13;
thorough.&#13;
If you use tools like <code>tcpdump</code> or <code>wireshark</code> to&#13;
investigate TCP issues, you should look at <code>scapy</code>.&#13;
Finally,&#13;
don’t confuse <code>scapy</code> with <code>scrapy</code>,&#13;
which is covered in <a data-type="xref" href="ch18.html#scraping">“Crawl and Scrape”</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Netcat" data-type="sect2"><div class="sect2" id="netcat">&#13;
<h2>Netcat</h2>&#13;
&#13;
<p><a data-primary="Netcat" data-type="indexterm" id="idm45794972496248"/><a data-primary="TCP/IP (Transmission Control Protocol/Internet Protocol)" data-secondary="Netcat and" data-type="indexterm" id="idm45794972495544"/>Another tool to test networks and ports is&#13;
<a href="https://oreil.ly/K37H2">Netcat</a>,&#13;
often abbreviated to <code>nc</code>.&#13;
Here’s an example of an HTTP connnection to&#13;
Google’s website, and requesting some basic information&#13;
about its home page:</p>&#13;
<pre>$ <strong>$ nc www.google.com 80</strong>&#13;
<strong>HEAD / HTTP/1.1</strong>&#13;
&#13;
HTTP/1.1 200 OK&#13;
Date: Sat, 27 Jul 2019 21:04:02 GMT&#13;
...&#13;
</pre>&#13;
&#13;
<p>In the next chapter, there’s an example&#13;
that uses <a data-type="xref" href="ch18.html#telnet">“Test with telnet”</a> to do the same.<a data-startref="ix_ch17-networks-asciidoc1" data-type="indexterm" id="idm45794972490568"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Networking Patterns" data-type="sect1"><div class="sect1" id="networking_patterns">&#13;
<h1>Networking Patterns</h1>&#13;
&#13;
<p><a data-primary="networks/networking" data-secondary="patterns for" data-type="indexterm" id="ix_ch17-networks-asciidoc5"/>You can build networking applications from some basic patterns:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>The most common pattern is <em>request</em>-<em>reply</em>,&#13;
also known as&#13;
<em>request</em>-<em>response</em> or&#13;
<em>client</em>-<em>server</em>.&#13;
This pattern is synchronous:&#13;
the client waits until the server responds.&#13;
You’ve seen many examples of request-reply in this book.&#13;
Your web browser is also a client,&#13;
making an HTTP request to a web server,&#13;
which returns a reply.</p>&#13;
</li>&#13;
<li>&#13;
<p><a data-primary="fanout pattern" data-type="indexterm" id="idm45794972482136"/><a data-primary="push pattern" data-type="indexterm" id="idm45794972481432"/>Another common pattern is <em>push</em>, or <em>fanout</em>:&#13;
you send data to any available worker in a pool of processes.&#13;
An example is a web server behind a load balancer.</p>&#13;
</li>&#13;
<li>&#13;
<p><a data-primary="fanin pattern" data-type="indexterm" id="idm45794972478888"/><a data-primary="pull pattern" data-type="indexterm" id="idm45794972478184"/>The opposite of push is <em>pull</em>, or <em>fanin</em>:&#13;
you accept data from&#13;
one or more sources.&#13;
An example would be a logger that takes text messages from multiple&#13;
processes and writes them to a single log file.</p>&#13;
</li>&#13;
<li>&#13;
<p><a data-primary="publish-subscribe (pub-sub) pattern" data-secondary="defined" data-type="indexterm" id="idm45794972475592"/>One pattern is similar to radio or television broadcasting:&#13;
<em>publish</em>-<em>subscribe</em>, or <em>pub</em>-<em>sub</em>.&#13;
With this pattern, a publisher sends out data.&#13;
In a simple pub-sub system, all subscribers would receive a copy.&#13;
More often, subscribers can indicate that they’re interested only in&#13;
certain types of data (often called a <em>topic</em>),&#13;
and the publisher will send just those.&#13;
So, unlike the push pattern,&#13;
more than one subscriber might receive a given piece of data.&#13;
If there’s no subscriber for a topic, the data are ignored.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Let’s show some request-reply examples,&#13;
and later some pub-sub ones.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The Request-Reply Pattern" data-type="sect1"><div class="sect1" id="request_reply">&#13;
<h1>The Request-Reply Pattern</h1>&#13;
&#13;
<p><a data-primary="networks/networking" data-secondary="request-reply patterns" data-type="indexterm" id="ix_ch17-networks-asciidoc6"/><a data-primary="request-reply patterns" data-type="indexterm" id="ix_ch17-networks-asciidoc7"/>This is the most familiar pattern.&#13;
You request DNS, web, or email data from&#13;
the appropriate servers, and they reply,&#13;
or tell you whether there’s a problem.</p>&#13;
&#13;
<p>I just showed you how to make some basic requests with&#13;
UDP or TCP,&#13;
but it’s hard to build a networking application&#13;
at the socket level.&#13;
Let’s see if ZeroMQ can help.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="ZeroMQ" data-type="sect2"><div class="sect2" id="sockets_zmq">&#13;
<h2>ZeroMQ</h2>&#13;
&#13;
<p><a data-primary="ZeroMQ library" data-type="indexterm" id="ix_ch17-networks-asciidoc8"/>ZeroMQ is a library, not a server.&#13;
Sometimes described as <em>sockets on steroids</em>,&#13;
<span class="keep-together">ZeroMQ</span> sockets do the things that you sort of expected&#13;
plain sockets to do:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Exchange entire messages</p>&#13;
</li>&#13;
<li>&#13;
<p>Retry connections</p>&#13;
</li>&#13;
<li>&#13;
<p>Buffer data to preserve them when the timing&#13;
between senders and receivers doesn’t line up</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The <a href="http://zguide.zeromq.org">online guide</a>&#13;
is well written and witty,&#13;
and it presents the best description of&#13;
networking patterns that I’ve seen.&#13;
The printed version&#13;
(<em>ZeroMQ: Messaging for Many Applications</em>,&#13;
by Pieter Hintjens,&#13;
from that animal house, O’Reilly)&#13;
has that good code smell and a big fish on the cover,&#13;
rather than the other way around.&#13;
All the examples in the printed guide are in the C language,&#13;
but the online version lets you choose from multiple languages&#13;
for each code example.&#13;
The Python <a href="http://bit.ly/zeromq-py">examples are also viewable</a>.&#13;
In this chapter, I show you some basic request-reply ZeroMQ examples.</p>&#13;
&#13;
<p>ZeroMQ is like a LEGO set, and we all know that&#13;
you can build an amazing variety of things from a few Lego shapes.&#13;
In this case, you construct networks from&#13;
a few socket types and patterns.&#13;
The basic “LEGO pieces” presented in the following list are the ZeroMQ socket types,&#13;
which by some twist of fate&#13;
look like the network patterns we’ve already discussed:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>REQ (synchronous request)</p>&#13;
</li>&#13;
<li>&#13;
<p>REP (synchronous reply)</p>&#13;
</li>&#13;
<li>&#13;
<p>DEALER (asynchronous request)</p>&#13;
</li>&#13;
<li>&#13;
<p>ROUTER (asynchronous reply)</p>&#13;
</li>&#13;
<li>&#13;
<p>PUB (publish)</p>&#13;
</li>&#13;
<li>&#13;
<p>SUB (subscribe)</p>&#13;
</li>&#13;
<li>&#13;
<p>PUSH (fanout)</p>&#13;
</li>&#13;
<li>&#13;
<p>PULL (fanin)</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>To try these yourself, you’ll need to&#13;
install the Python ZeroMQ library by typing this command:</p>&#13;
<pre>$ <strong>pip install pyzmq</strong></pre>&#13;
&#13;
<p>The simplest pattern is a single request-reply pair.&#13;
This is synchronous:&#13;
one socket makes a request and&#13;
then the other replies.&#13;
First, the code for the reply (server),&#13;
<em>zmq_server.py</em>, as shown in <a data-type="xref" href="#zmq_server">Example 17-5</a>.</p>&#13;
<div data-type="example" id="zmq_server">&#13;
<h5><span class="label">Example 17-5. </span>zmq_server.py</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">zmq</code>&#13;
&#13;
<code class="n">host</code> <code class="o">=</code> <code class="s1">'127.0.0.1'</code>&#13;
<code class="n">port</code> <code class="o">=</code> <code class="mi">6789</code>&#13;
<code class="n">context</code> <code class="o">=</code> <code class="n">zmq</code><code class="o">.</code><code class="n">Context</code><code class="p">()</code>&#13;
<code class="n">server</code> <code class="o">=</code> <code class="n">context</code><code class="o">.</code><code class="n">socket</code><code class="p">(</code><code class="n">zmq</code><code class="o">.</code><code class="n">REP</code><code class="p">)</code>&#13;
<code class="n">server</code><code class="o">.</code><code class="n">bind</code><code class="p">(</code><code class="s2">"tcp://</code><code class="si">%s</code><code class="s2">:</code><code class="si">%s</code><code class="s2">"</code> <code class="o">%</code> <code class="p">(</code><code class="n">host</code><code class="p">,</code> <code class="n">port</code><code class="p">))</code>&#13;
<code class="k">while</code> <code class="bp">True</code><code class="p">:</code>&#13;
    <code class="c1">#  Wait for next request from client</code>&#13;
    <code class="n">request_bytes</code> <code class="o">=</code> <code class="n">server</code><code class="o">.</code><code class="n">recv</code><code class="p">()</code>&#13;
    <code class="n">request_str</code> <code class="o">=</code> <code class="n">request_bytes</code><code class="o">.</code><code class="n">decode</code><code class="p">(</code><code class="s1">'utf-8'</code><code class="p">)</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="s2">"That voice in my head says: </code><code class="si">%s</code><code class="s2">"</code> <code class="o">%</code> <code class="n">request_str</code><code class="p">)</code>&#13;
    <code class="n">reply_str</code> <code class="o">=</code> <code class="s2">"Stop saying: </code><code class="si">%s</code><code class="s2">"</code> <code class="o">%</code> <code class="n">request_str</code>&#13;
    <code class="n">reply_bytes</code> <code class="o">=</code> <code class="nb">bytes</code><code class="p">(</code><code class="n">reply_str</code><code class="p">,</code> <code class="s1">'utf-8'</code><code class="p">)</code>&#13;
    <code class="n">server</code><code class="o">.</code><code class="n">send</code><code class="p">(</code><code class="n">reply_bytes</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>We create a <code>Context</code> object:&#13;
this is a ZeroMQ object that maintains state.&#13;
Then, we make a ZeroMQ <code>socket</code> of type <code>REP</code> (for REPly).&#13;
We call <code>bind()</code> to make it listen on a&#13;
particular IP address and port.&#13;
Notice that they’re specified in a string such as&#13;
<code>'tcp://localhost:6789'</code>&#13;
rather than a tuple, as in the plain-socket examples.</p>&#13;
&#13;
<p>This example keeps receiving requests&#13;
from a sender and sending a response.&#13;
The messages can be very long—ZeroMQ takes care of the details.</p>&#13;
&#13;
<p><a data-type="xref" href="#zmq_client">Example 17-6</a> shows the code for the corresponding request (client),&#13;
<em>zmq_client.py</em>.&#13;
Its type is <code>REQ</code> (for REQuest),&#13;
and it calls <code>connect()</code> rather than <code>bind()</code>.</p>&#13;
<div data-type="example" id="zmq_client">&#13;
<h5><span class="label">Example 17-6. </span>zmq_client.py</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">zmq</code>&#13;
&#13;
<code class="n">host</code> <code class="o">=</code> <code class="s1">'127.0.0.1'</code>&#13;
<code class="n">port</code> <code class="o">=</code> <code class="mi">6789</code>&#13;
<code class="n">context</code> <code class="o">=</code> <code class="n">zmq</code><code class="o">.</code><code class="n">Context</code><code class="p">()</code>&#13;
<code class="n">client</code> <code class="o">=</code> <code class="n">context</code><code class="o">.</code><code class="n">socket</code><code class="p">(</code><code class="n">zmq</code><code class="o">.</code><code class="n">REQ</code><code class="p">)</code>&#13;
<code class="n">client</code><code class="o">.</code><code class="n">connect</code><code class="p">(</code><code class="s2">"tcp://</code><code class="si">%s</code><code class="s2">:</code><code class="si">%s</code><code class="s2">"</code> <code class="o">%</code> <code class="p">(</code><code class="n">host</code><code class="p">,</code> <code class="n">port</code><code class="p">))</code>&#13;
<code class="k">for</code> <code class="n">num</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">6</code><code class="p">):</code>&#13;
    <code class="n">request_str</code> <code class="o">=</code> <code class="s2">"message #</code><code class="si">%s</code><code class="s2">"</code> <code class="o">%</code> <code class="n">num</code>&#13;
    <code class="n">request_bytes</code> <code class="o">=</code> <code class="n">request_str</code><code class="o">.</code><code class="n">encode</code><code class="p">(</code><code class="s1">'utf-8'</code><code class="p">)</code>&#13;
    <code class="n">client</code><code class="o">.</code><code class="n">send</code><code class="p">(</code><code class="n">request_bytes</code><code class="p">)</code>&#13;
    <code class="n">reply_bytes</code> <code class="o">=</code> <code class="n">client</code><code class="o">.</code><code class="n">recv</code><code class="p">()</code>&#13;
    <code class="n">reply_str</code> <code class="o">=</code> <code class="n">reply_bytes</code><code class="o">.</code><code class="n">decode</code><code class="p">(</code><code class="s1">'utf-8'</code><code class="p">)</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="s2">"Sent </code><code class="si">%s</code><code class="s2">, received </code><code class="si">%s</code><code class="s2">"</code> <code class="o">%</code> <code class="p">(</code><code class="n">request_str</code><code class="p">,</code> <code class="n">reply_str</code><code class="p">))</code></pre></div>&#13;
&#13;
<p>Now it’s time to start them.&#13;
One interesting difference from the plain-socket&#13;
examples is that you can start the server and client in either order.&#13;
Go ahead and start the server in one window in the background:</p>&#13;
<pre>$ <strong>python zmq_server.py &amp;</strong></pre>&#13;
&#13;
<p>Start the client in the same window:</p>&#13;
<pre>$ <strong>python zmq_client.py</strong></pre>&#13;
&#13;
<p class="pagebreak-before">You’ll see these alternating output lines&#13;
from the client and server:</p>&#13;
&#13;
<pre data-type="programlisting">That voice in my head says 'message #1'&#13;
Sent 'message #1', received 'Stop saying message #1'&#13;
That voice in my head says 'message #2'&#13;
Sent 'message #2', received 'Stop saying message #2'&#13;
That voice in my head says 'message #3'&#13;
Sent 'message #3', received 'Stop saying message #3'&#13;
That voice in my head says 'message #4'&#13;
Sent 'message #4', received 'Stop saying message #4'&#13;
That voice in my head says 'message #5'&#13;
Sent 'message #5', received 'Stop saying message #5'</pre>&#13;
&#13;
<p>Our client ends after sending its fifth message,&#13;
but we didn’t tell the server to quit,&#13;
so it sits by the phone, waiting for another message.&#13;
If you run the client again,&#13;
it will print the same five lines,&#13;
and the server will print its five also.&#13;
If you don’t kill the <em>zmq_server.py</em> process&#13;
and try to run another one,&#13;
Python will complain that&#13;
the address is already is use:</p>&#13;
<pre>$ <strong>python zmq_server.py</strong></pre>&#13;
&#13;
<pre data-type="programlisting">[2] 356&#13;
Traceback (most recent call last):&#13;
  File "zmq_server.py", line 7, in &lt;module&gt;&#13;
    server.bind("tcp://%s:%s" % (host, port))&#13;
  File "socket.pyx", line 444, in zmq.backend.cython.socket.Socket.bind&#13;
      (zmq/backend/cython/socket.c:4076)&#13;
  File "checkrc.pxd", line 21, in zmq.backend.cython.checkrc._check_rc&#13;
      (zmq/backend/cython/socket.c:6032)&#13;
zmq.error.ZMQError: Address already in use</pre>&#13;
&#13;
<p>The messages need to be sent as byte strings,&#13;
so we encoded our example’s&#13;
text strings in UTF-8 format.&#13;
You can send any kind of message you like,&#13;
as long as you convert it to <code>bytes</code>.&#13;
We used simple text strings as the source of our messages,&#13;
so <code>encode()</code> and <code>decode()</code> were enough to convert to&#13;
and from byte strings.&#13;
If your messages have other data types,&#13;
you can use a library such as&#13;
<a href="http://msgpack.org">MessagePack</a>.</p>&#13;
&#13;
<p>Even this basic REQ-REP pattern allows for some fancy communication&#13;
patterns, because&#13;
any number of REQ clients can <code>connect()</code> to a single <code>REP</code> server.&#13;
The server handles requests one at a time,&#13;
synchronously,&#13;
but doesn’t drop other requests that are arriving in the meantime.&#13;
ZeroMQ buffers messages, up to some specified limit,&#13;
until they can get through; that’s where it earns the Q in its name.&#13;
The Q stands for Queue, the M stands for Message, and the Zero&#13;
means there doesn’t need to be any broker.</p>&#13;
&#13;
<p>Although ZeroMQ doesn’t impose any central&#13;
brokers (intermediaries),&#13;
you can build them where needed.&#13;
For example,&#13;
use DEALER and ROUTER sockets to connect&#13;
multiple sources and/or destinations asynchronously.</p>&#13;
&#13;
<p>Multiple REQ sockets connect to a single ROUTER,&#13;
which passes each request to a DEALER,&#13;
which then contacts any REP sockets that have connected to it&#13;
(<a data-type="xref" href="#fig_broker">Figure 17-1</a>).&#13;
This is similar to a bunch of browsers contacting a proxy server&#13;
in front of a web server farm.&#13;
It lets you add multiple clients and servers as needed.</p>&#13;
&#13;
<p>The REQ sockets connect only to the ROUTER socket;&#13;
the DEALER connects to the multiple&#13;
REP sockets behind it.&#13;
ZeroMQ takes care of the nasty details,&#13;
ensuring that the requests are load balanced and that the replies go&#13;
back to the right place.</p>&#13;
&#13;
<p>Another networking pattern called the <em>ventilator</em>&#13;
uses PUSH sockets to farm out asynchronous tasks,&#13;
and PULL sockets to gather the results.</p>&#13;
&#13;
<p>The last notable feature of ZeroMQ is that it&#13;
scales up <em>and</em> down,&#13;
just by changing the connection type of the&#13;
socket when it’s created:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><code>tcp</code> between processes, on one or more machines</p>&#13;
</li>&#13;
<li>&#13;
<p><code>ipc</code> between processes on one machine</p>&#13;
</li>&#13;
<li>&#13;
<p><code>inproc</code> between threads in a single process</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>That last one, <code>inproc</code>, is a way to pass data&#13;
between threads without locks,&#13;
and an alternative to the <code>threading</code> example in <a data-type="xref" href="ch15.html#threads">“Threads”</a>.</p>&#13;
&#13;
<figure><div class="figure" id="fig_broker">&#13;
<img alt="inp2 1701" src="assets/inp2_1701.png"/>&#13;
<h6><span class="label">Figure 17-1. </span>Using a broker to connect multiple clients and services</h6>&#13;
</div></figure>&#13;
&#13;
<p>After using ZeroMQ,&#13;
you may not want to write raw socket code again.<a data-startref="ix_ch17-networks-asciidoc8" data-type="indexterm" id="idm45794972125544"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Other Messaging Tools" data-type="sect2"><div class="sect2" id="idm45794972465096">&#13;
<h2>Other Messaging Tools</h2>&#13;
&#13;
<p>ZeroMQ is certainly not the only message-passing library&#13;
that Python supports.&#13;
Message passing is one of the most popular ideas in&#13;
networking,&#13;
and Python keeps up with other languages:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>The Apache project, whose web server we saw in <a data-type="xref" href="ch18.html#apache">“Apache”</a>,&#13;
also maintains the&#13;
<a href="https://activemq.apache.org">ActiveMQ</a> project,&#13;
including several Python interfaces using the simple-text&#13;
<a href="https://oreil.ly/a3h_M">STOMP</a> protocol.</p>&#13;
</li>&#13;
<li>&#13;
<p><a href="http://www.rabbitmq.com">RabbitMQ</a>&#13;
is also popular,&#13;
and it has useful online Python&#13;
<a href="http://bit.ly/rabbitmq-tut">tutorials</a>.</p>&#13;
</li>&#13;
<li>&#13;
<p><a href="http://www.nats.io">NATS</a> is a fast messaging system,&#13;
written in Go.<a data-startref="ix_ch17-networks-asciidoc7" data-type="indexterm" id="idm45794972116632"/><a data-startref="ix_ch17-networks-asciidoc6" data-type="indexterm" id="idm45794972115912"/></p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The Publish-Subscribe Pattern" data-type="sect1"><div class="sect1" id="pubsub">&#13;
<h1>The Publish-Subscribe Pattern</h1>&#13;
&#13;
<p><a data-primary="networks/networking" data-secondary="publish-subscribe model" data-type="indexterm" id="ix_ch17-networks-asciidoc9"/><a data-primary="publish-subscribe (pub-sub) pattern" data-type="indexterm" id="ix_ch17-networks-asciidoc10"/>Publish-subscribe is not a queue but a broadcast.&#13;
One or more processes publish messages.&#13;
Each subscriber process indicates what type of messages&#13;
it would like to receive.&#13;
A copy of each message is sent to each subscriber that&#13;
matched its type.&#13;
Thus, a given message might be processed once,&#13;
more than once,&#13;
or not at all.&#13;
Like a lonely radio operator,&#13;
each publisher is just broadcasting and doesn’t know who,&#13;
if anyone, is listening.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Redis" data-type="sect2"><div class="sect2" id="pubsub_redis">&#13;
<h2>Redis</h2>&#13;
&#13;
<p><a data-primary="publish-subscribe (pub-sub) pattern" data-secondary="Redis" data-type="indexterm" id="ix_ch17-networks-asciidoc11"/><a data-primary="Redis" data-secondary="publish-subscribe system with" data-type="indexterm" id="ix_ch17-networks-asciidoc12"/>You’ve seen Redis in <a data-type="xref" href="ch16.html#ch_databases">Chapter 16</a>,&#13;
mainly as a data structure server,&#13;
but it also contains a pub-sub system.&#13;
The publisher emits messages with a topic and a value,&#13;
and subscribers say which topics they want to receive.</p>&#13;
&#13;
<p><a data-type="xref" href="#redis_pub">Example 17-7</a> contains a publisher, <em>redis_pub.py</em>.</p>&#13;
<div data-type="example" id="redis_pub">&#13;
<h5><span class="label">Example 17-7. </span>redis_pub.py</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">redis</code>&#13;
<code class="kn">import</code> <code class="nn">random</code>&#13;
&#13;
<code class="n">conn</code> <code class="o">=</code> <code class="n">redis</code><code class="o">.</code><code class="n">Redis</code><code class="p">()</code>&#13;
<code class="n">cats</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'siamese'</code><code class="p">,</code> <code class="s1">'persian'</code><code class="p">,</code> <code class="s1">'maine coon'</code><code class="p">,</code> <code class="s1">'norwegian forest'</code><code class="p">]</code>&#13;
<code class="n">hats</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'stovepipe'</code><code class="p">,</code> <code class="s1">'bowler'</code><code class="p">,</code> <code class="s1">'tam-o-shanter'</code><code class="p">,</code> <code class="s1">'fedora'</code><code class="p">]</code>&#13;
<code class="k">for</code> <code class="n">msg</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="mi">10</code><code class="p">):</code>&#13;
    <code class="n">cat</code> <code class="o">=</code> <code class="n">random</code><code class="o">.</code><code class="n">choice</code><code class="p">(</code><code class="n">cats</code><code class="p">)</code>&#13;
    <code class="n">hat</code> <code class="o">=</code> <code class="n">random</code><code class="o">.</code><code class="n">choice</code><code class="p">(</code><code class="n">hats</code><code class="p">)</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="s1">'Publish: </code><code class="si">%s</code><code class="s1"> wears a </code><code class="si">%s</code><code class="s1">'</code> <code class="o">%</code> <code class="p">(</code><code class="n">cat</code><code class="p">,</code> <code class="n">hat</code><code class="p">))</code>&#13;
    <code class="n">conn</code><code class="o">.</code><code class="n">publish</code><code class="p">(</code><code class="n">cat</code><code class="p">,</code> <code class="n">hat</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>Each topic is a breed of cat,&#13;
and the accompanying message is a type of hat.</p>&#13;
&#13;
<p><a data-type="xref" href="#redis_sub">Example 17-8</a> shows a single subscriber, <em>redis_sub.py</em>.</p>&#13;
<div data-type="example" id="redis_sub">&#13;
<h5><span class="label">Example 17-8. </span>redis_sub.py</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">redis</code>&#13;
<code class="n">conn</code> <code class="o">=</code> <code class="n">redis</code><code class="o">.</code><code class="n">Redis</code><code class="p">()</code>&#13;
&#13;
<code class="n">topics</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'maine coon'</code><code class="p">,</code> <code class="s1">'persian'</code><code class="p">]</code>&#13;
<code class="n">sub</code> <code class="o">=</code> <code class="n">conn</code><code class="o">.</code><code class="n">pubsub</code><code class="p">()</code>&#13;
<code class="n">sub</code><code class="o">.</code><code class="n">subscribe</code><code class="p">(</code><code class="n">topics</code><code class="p">)</code>&#13;
<code class="k">for</code> <code class="n">msg</code> <code class="ow">in</code> <code class="n">sub</code><code class="o">.</code><code class="n">listen</code><code class="p">():</code>&#13;
    <code class="k">if</code> <code class="n">msg</code><code class="p">[</code><code class="s1">'type'</code><code class="p">]</code> <code class="o">==</code> <code class="s1">'message'</code><code class="p">:</code>&#13;
        <code class="n">cat</code> <code class="o">=</code> <code class="n">msg</code><code class="p">[</code><code class="s1">'channel'</code><code class="p">]</code>&#13;
        <code class="n">hat</code> <code class="o">=</code> <code class="n">msg</code><code class="p">[</code><code class="s1">'data'</code><code class="p">]</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="s1">'Subscribe: </code><code class="si">%s</code><code class="s1"> wears a </code><code class="si">%s</code><code class="s1">'</code> <code class="o">%</code> <code class="p">(</code><code class="n">cat</code><code class="p">,</code> <code class="n">hat</code><code class="p">))</code></pre></div>&#13;
&#13;
<p>This subscriber wants all messages for&#13;
cat types <code>'maine coon'</code> and <code>'persian'</code>, and no others.&#13;
The <code>listen()</code> method returns a dictionary.&#13;
If its type is <code>'message'</code>,&#13;
it was sent by the publisher and matches&#13;
our criteria.&#13;
The <code>'channel'</code> key is the topic (cat),&#13;
and the <code>'data'</code> key contains the message (hat).</p>&#13;
&#13;
<p>If you start the publisher first and no one is listening,&#13;
it’s like a mime falling in the forest (does he make a sound?),&#13;
so start the subscriber first:</p>&#13;
<pre>$ <strong>python redis_sub.py</strong></pre>&#13;
&#13;
<p>Next, start the publisher.&#13;
It will send 10 messages and then quit:</p>&#13;
<pre>$ <strong>python redis_pub.py</strong>&#13;
Publish: maine coon wears a stovepipe&#13;
Publish: norwegian forest wears a stovepipe&#13;
Publish: norwegian forest wears a tam-o-shanter&#13;
Publish: maine coon wears a bowler&#13;
Publish: siamese wears a stovepipe&#13;
Publish: norwegian forest wears a tam-o-shanter&#13;
Publish: maine coon wears a bowler&#13;
Publish: persian wears a bowler&#13;
Publish: norwegian forest wears a bowler&#13;
Publish: maine coon wears a stovepipe</pre>&#13;
&#13;
<p>The subscriber cares about only two types of cat:</p>&#13;
<pre>$ <strong>python redis_sub.py</strong>&#13;
Subscribe: maine coon wears a stovepipe&#13;
Subscribe: maine coon wears a bowler&#13;
Subscribe: maine coon wears a bowler&#13;
Subscribe: persian wears a bowler&#13;
Subscribe: maine coon wears a stovepipe</pre>&#13;
&#13;
<p>We didn’t tell the subscriber to quit,&#13;
so it’s still waiting for messages.&#13;
If you restart the publisher,&#13;
the subscriber will grab a few more messages&#13;
and print them.</p>&#13;
&#13;
<p>You can have as many subscribers (and publishers) as you want.&#13;
If there’s no subscriber for a message,&#13;
it disappears from the Redis server.&#13;
However, if there are subscribers,&#13;
the messages stay in the server&#13;
until all subscribers have retrieved them.<a data-startref="ix_ch17-networks-asciidoc12" data-type="indexterm" id="idm45794971840296"/><a data-startref="ix_ch17-networks-asciidoc11" data-type="indexterm" id="idm45794971839624"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="ZeroMQ" data-type="sect2"><div class="sect2" id="pubsub_zmq">&#13;
<h2>ZeroMQ</h2>&#13;
&#13;
<p><a data-primary="publish-subscribe (pub-sub) pattern" data-secondary="ZeroMQ" data-type="indexterm" id="idm45794971837144"/><a data-primary="ZeroMQ library" data-type="indexterm" id="idm45794971836200"/>ZeroMQ has no central server,&#13;
so each publisher writes to all subscribers.&#13;
The publisher, <em>zmq_pub.py</em>, is provided in <a data-type="xref" href="#zmq_pub">Example 17-9</a>.</p>&#13;
<div data-type="example" id="zmq_pub">&#13;
<h5><span class="label">Example 17-9. </span>zmq_pub.py</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">zmq</code>&#13;
<code class="kn">import</code> <code class="nn">random</code>&#13;
<code class="kn">import</code> <code class="nn">time</code>&#13;
<code class="n">host</code> <code class="o">=</code> <code class="s1">'*'</code>&#13;
<code class="n">port</code> <code class="o">=</code> <code class="mi">6789</code>&#13;
<code class="n">ctx</code> <code class="o">=</code> <code class="n">zmq</code><code class="o">.</code><code class="n">Context</code><code class="p">()</code>&#13;
<code class="n">pub</code> <code class="o">=</code> <code class="n">ctx</code><code class="o">.</code><code class="n">socket</code><code class="p">(</code><code class="n">zmq</code><code class="o">.</code><code class="n">PUB</code><code class="p">)</code>&#13;
<code class="n">pub</code><code class="o">.</code><code class="n">bind</code><code class="p">(</code><code class="s1">'tcp://</code><code class="si">%s</code><code class="s1">:</code><code class="si">%s</code><code class="s1">'</code> <code class="o">%</code> <code class="p">(</code><code class="n">host</code><code class="p">,</code> <code class="n">port</code><code class="p">))</code>&#13;
<code class="n">cats</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'siamese'</code><code class="p">,</code> <code class="s1">'persian'</code><code class="p">,</code> <code class="s1">'maine coon'</code><code class="p">,</code> <code class="s1">'norwegian forest'</code><code class="p">]</code>&#13;
<code class="n">hats</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'stovepipe'</code><code class="p">,</code> <code class="s1">'bowler'</code><code class="p">,</code> <code class="s1">'tam-o-shanter'</code><code class="p">,</code> <code class="s1">'fedora'</code><code class="p">]</code>&#13;
<code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>&#13;
<code class="k">for</code> <code class="n">msg</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="mi">10</code><code class="p">):</code>&#13;
    <code class="n">cat</code> <code class="o">=</code> <code class="n">random</code><code class="o">.</code><code class="n">choice</code><code class="p">(</code><code class="n">cats</code><code class="p">)</code>&#13;
    <code class="n">cat_bytes</code> <code class="o">=</code> <code class="n">cat</code><code class="o">.</code><code class="n">encode</code><code class="p">(</code><code class="s1">'utf-8'</code><code class="p">)</code>&#13;
    <code class="n">hat</code> <code class="o">=</code> <code class="n">random</code><code class="o">.</code><code class="n">choice</code><code class="p">(</code><code class="n">hats</code><code class="p">)</code>&#13;
    <code class="n">hat_bytes</code> <code class="o">=</code> <code class="n">hat</code><code class="o">.</code><code class="n">encode</code><code class="p">(</code><code class="s1">'utf-8'</code><code class="p">)</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="s1">'Publish: </code><code class="si">%s</code><code class="s1"> wears a </code><code class="si">%s</code><code class="s1">'</code> <code class="o">%</code> <code class="p">(</code><code class="n">cat</code><code class="p">,</code> <code class="n">hat</code><code class="p">))</code>&#13;
    <code class="n">pub</code><code class="o">.</code><code class="n">send_multipart</code><code class="p">([</code><code class="n">cat_bytes</code><code class="p">,</code> <code class="n">hat_bytes</code><code class="p">])</code></pre></div>&#13;
&#13;
<p>Notice how this code uses UTF-8 encoding&#13;
for the topic and value strings.</p>&#13;
&#13;
<p>The file for the subscriber is <em>zmq_sub.py</em> (<a data-type="xref" href="#zmq_sub">Example 17-10</a>).</p>&#13;
<div data-type="example" id="zmq_sub">&#13;
<h5><span class="label">Example 17-10. </span>zmq_sub.py</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">zmq</code>&#13;
<code class="n">host</code> <code class="o">=</code> <code class="s1">'127.0.0.1'</code>&#13;
<code class="n">port</code> <code class="o">=</code> <code class="mi">6789</code>&#13;
<code class="n">ctx</code> <code class="o">=</code> <code class="n">zmq</code><code class="o">.</code><code class="n">Context</code><code class="p">()</code>&#13;
<code class="n">sub</code> <code class="o">=</code> <code class="n">ctx</code><code class="o">.</code><code class="n">socket</code><code class="p">(</code><code class="n">zmq</code><code class="o">.</code><code class="n">SUB</code><code class="p">)</code>&#13;
<code class="n">sub</code><code class="o">.</code><code class="n">connect</code><code class="p">(</code><code class="s1">'tcp://</code><code class="si">%s</code><code class="s1">:</code><code class="si">%s</code><code class="s1">'</code> <code class="o">%</code> <code class="p">(</code><code class="n">host</code><code class="p">,</code> <code class="n">port</code><code class="p">))</code>&#13;
<code class="n">topics</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'maine coon'</code><code class="p">,</code> <code class="s1">'persian'</code><code class="p">]</code>&#13;
<code class="k">for</code> <code class="n">topic</code> <code class="ow">in</code> <code class="n">topics</code><code class="p">:</code>&#13;
    <code class="n">sub</code><code class="o">.</code><code class="n">setsockopt</code><code class="p">(</code><code class="n">zmq</code><code class="o">.</code><code class="n">SUBSCRIBE</code><code class="p">,</code> <code class="n">topic</code><code class="o">.</code><code class="n">encode</code><code class="p">(</code><code class="s1">'utf-8'</code><code class="p">))</code>&#13;
<code class="k">while</code> <code class="bp">True</code><code class="p">:</code>&#13;
    <code class="n">cat_bytes</code><code class="p">,</code> <code class="n">hat_bytes</code> <code class="o">=</code> <code class="n">sub</code><code class="o">.</code><code class="n">recv_multipart</code><code class="p">()</code>&#13;
    <code class="n">cat</code> <code class="o">=</code> <code class="n">cat_bytes</code><code class="o">.</code><code class="n">decode</code><code class="p">(</code><code class="s1">'utf-8'</code><code class="p">)</code>&#13;
    <code class="n">hat</code> <code class="o">=</code> <code class="n">hat_bytes</code><code class="o">.</code><code class="n">decode</code><code class="p">(</code><code class="s1">'utf-8'</code><code class="p">)</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="s1">'Subscribe: </code><code class="si">%s</code><code class="s1"> wears a </code><code class="si">%s</code><code class="s1">'</code> <code class="o">%</code> <code class="p">(</code><code class="n">cat</code><code class="p">,</code> <code class="n">hat</code><code class="p">))</code></pre></div>&#13;
&#13;
<p>In this code, we subscribe to two different byte values:&#13;
the two strings in <code>topics</code>, encoded as UTF-8.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>It seems a little backward,&#13;
but if you want <em>all</em> topics,&#13;
you need to subscribe to the empty bytestring <code>b''</code>;&#13;
if you don’t, you’ll get nothing.</p>&#13;
</div>&#13;
&#13;
<p>Notice that we call <code>send_multipart()</code>&#13;
in the publisher and <code>recv_multipart()</code>&#13;
in the subscriber.&#13;
This makes it possible for us to send multipart messages&#13;
and use the first part as the topic.&#13;
We could also send the topic and message&#13;
as a single string or bytestring,&#13;
but it seems cleaner to keep cats and hats separate.</p>&#13;
&#13;
<p>Start the subscriber:</p>&#13;
<pre>$ <strong>python zmq_sub.py</strong></pre>&#13;
&#13;
<p>Start the publisher.&#13;
It immediately sends 10 messages and then quits:</p>&#13;
<pre>$ <strong>python zmq_pub.py</strong>&#13;
Publish: norwegian forest wears a stovepipe&#13;
Publish: siamese wears a bowler&#13;
Publish: persian wears a stovepipe&#13;
Publish: norwegian forest wears a fedora&#13;
Publish: maine coon wears a tam-o-shanter&#13;
Publish: maine coon wears a stovepipe&#13;
Publish: persian wears a stovepipe&#13;
Publish: norwegian forest wears a fedora&#13;
Publish: norwegian forest wears a bowler&#13;
Publish: maine coon wears a bowler</pre>&#13;
&#13;
<p>The subscriber prints what it requested and received:</p>&#13;
&#13;
<pre data-type="programlisting">Subscribe: persian wears a stovepipe&#13;
Subscribe: maine coon wears a tam-o-shanter&#13;
Subscribe: maine coon wears a stovepipe&#13;
Subscribe: persian wears a stovepipe&#13;
Subscribe: maine coon wears a bowler</pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Other Pub-Sub Tools" data-type="sect2"><div class="sect2" id="pubsub_other">&#13;
<h2>Other Pub-Sub Tools</h2>&#13;
&#13;
<p>You might like to explore some of these other Python pub-sub links:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>RabbitMQ is a well-known messaging broker,&#13;
and <code>pika</code> is a Python API for it.&#13;
See <a href="http://pika.readthedocs.org">the <code>pika</code> documentation</a>&#13;
and a <a href="http://bit.ly/pub-sub-tut">pub-sub tutorial</a>.</p>&#13;
</li>&#13;
<li>&#13;
<p>Go to the&#13;
<a href="https://pypi.python.org">PyPi</a>&#13;
search window and type <code>pubsub</code> to find Python packages like&#13;
<a href="http://pubsub.sourceforge.net"><code>pypubsub</code></a>.</p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://code.google.com/p/pubsubhubbub">PubSubHubbub</a>&#13;
enables subscribers to register callbacks with publishers.</p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://nats.io">NATS</a> is a fast, open source messaging system&#13;
that supports pub-sub, request-reply, and queuing<a data-startref="ix_ch17-networks-asciidoc10" data-type="indexterm" id="idm45794971480152"/><a data-startref="ix_ch17-networks-asciidoc9" data-type="indexterm" id="idm45794971479432"/>.<a data-startref="ix_ch17-networks-asciidoc5" data-type="indexterm" id="idm45794971478616"/></p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Internet Services" data-type="sect1"><div class="sect1" id="idm45794971477384">&#13;
<h1>Internet Services</h1>&#13;
&#13;
<p><a data-primary="networks/networking" data-secondary="internet services" data-type="indexterm" id="idm45794971475976"/>Python has an extensive networking toolset.&#13;
In the following sections,&#13;
we look at ways to automate some of the&#13;
most popular internet services.&#13;
The official, comprehensive&#13;
<a href="http://bit.ly/py-internet">documentation</a> is&#13;
available online.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Domain Name System" data-type="sect2"><div class="sect2" id="dns">&#13;
<h2>Domain Name System</h2>&#13;
&#13;
<p><a data-primary="Domain Name System (DNS)" data-type="indexterm" id="idm45794971472024"/><a data-primary="networks/networking" data-secondary="Domain Name System and" data-type="indexterm" id="idm45794971471304"/>Computers have numeric IP addresses such as <code>85.2.101.94</code>,&#13;
but we remember names better than numbers.&#13;
The Domain Name System (DNS) is a critical internet service&#13;
that converts IP addresses to and from names&#13;
via a distributed database.&#13;
Whenever you’re using a web browser and suddenly see&#13;
a message like&#13;
“looking up host,”&#13;
you’ve probably lost your internet connection,&#13;
and your first clue is a DNS failure.</p>&#13;
&#13;
<p>Some DNS functions are found in the low-level <code>socket</code> module.&#13;
<a data-primary="gethostbyname() function" data-type="indexterm" id="idm45794971468648"/><code>gethostbyname()</code> returns the IP address for a domain name,&#13;
and the extended edition&#13;
<code>gethostbyname_ex()</code> returns the name,&#13;
a list of alternative names,&#13;
and a list of addresses:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">socket</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">socket</code><code class="o">.</code><code class="n">gethostbyname</code><code class="p">(</code><code class="s">'www.crappytaxidermy.com'</code><code class="p">)</code>&#13;
<code class="go">'66.6.44.4'</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">socket</code><code class="o">.</code><code class="n">gethostbyname_ex</code><code class="p">(</code><code class="s">'www.crappytaxidermy.com'</code><code class="p">)</code>&#13;
<code class="go">('crappytaxidermy.com', ['www.crappytaxidermy.com'], ['66.6.44.4'])</code></pre>&#13;
&#13;
<p><a data-primary="getaddrinfo() function" data-type="indexterm" id="idm45794971446760"/>The <code>getaddrinfo()</code> method looks up the IP address, but it also returns enough&#13;
information to create a socket to connect to it:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">socket</code><code class="o">.</code><code class="n">getaddrinfo</code><code class="p">(</code><code class="s">'www.crappytaxidermy.com'</code><code class="p">,</code> <code class="mi">80</code><code class="p">)</code>&#13;
<code class="go">[(2, 2, 17, '', ('66.6.44.4', 80)),</code>&#13;
<code class="go">(2, 1, 6, '', ('66.6.44.4', 80))]</code></pre>&#13;
&#13;
<p>The preceding call returned two tuples: the first for UDP,&#13;
and the second for TCP&#13;
(the <code>6</code> in the <code>2, 1, 6</code> is the value for TCP).</p>&#13;
&#13;
<p>You can ask for TCP or UDP information only:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">socket</code><code class="o">.</code><code class="n">getaddrinfo</code><code class="p">(</code><code class="s">'www.crappytaxidermy.com'</code><code class="p">,</code> <code class="mi">80</code><code class="p">,</code> <code class="n">socket</code><code class="o">.</code><code class="n">AF_INET</code><code class="p">,</code>&#13;
<code class="go">socket.SOCK_STREAM)</code>&#13;
<code class="go">[(2, 1, 6, '', ('66.6.44.4', 80))]</code></pre>&#13;
&#13;
<p>Some <a href="http://bit.ly/tcp-udp-ports">TCP and UDP port numbers</a>&#13;
are reserved for certain services by IANA,&#13;
and are associated with service names.&#13;
For example, HTTP is named <code>http</code> and is assigned TCP port 80.</p>&#13;
&#13;
<p>These functions convert between service names and port numbers:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">socket</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">socket</code><code class="o">.</code><code class="n">getservbyname</code><code class="p">(</code><code class="s">'http'</code><code class="p">)</code>&#13;
<code class="go">80</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">socket</code><code class="o">.</code><code class="n">getservbyport</code><code class="p">(</code><code class="mi">80</code><code class="p">)</code>&#13;
<code class="go">'http'</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Python Email Modules" data-type="sect2"><div class="sect2" id="email">&#13;
<h2>Python Email Modules</h2>&#13;
&#13;
<p><a data-primary="email modules" data-type="indexterm" id="idm45794971326200"/><a data-primary="networks/networking" data-secondary="email modules" data-type="indexterm" id="idm45794971325496"/>The standard library contains these email modules:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://oreil.ly/_kF6V"><code>smtplib</code></a>&#13;
for sending email messages via Simple Mail Transfer Protocol (SMTP)</p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/WVGbE"><code>email</code></a>&#13;
for creating and parsing email messages</p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/xiJT7"><code>poplib</code></a>&#13;
for reading email via Post Office Protocol 3 (POP3)</p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/wengo"><code>imaplib</code></a>&#13;
for reading email via Internet Message Access Protocol (IMAP)</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>If you want to write your own Python SMTP server,&#13;
try <a href="https://oreil.ly/JkLsD"><code>smtpd</code></a>,&#13;
or the new asynchronous version&#13;
<a href="https://aiosmtpd.readthedocs.io"><code>aiosmtpd</code></a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Other Protocols" data-type="sect2"><div class="sect2" id="idm45794971288184">&#13;
<h2>Other Protocols</h2>&#13;
&#13;
<p><a data-primary="ftplib module" data-type="indexterm" id="idm45794971286984"/>Using the standard&#13;
<a href="http://bit.ly/py-ftplib"><code>ftplib</code> module</a>,&#13;
you can push bytes around by using the&#13;
File Transfer Protocol (FTP).&#13;
Although it’s an old protocol,&#13;
FTP still performs very well.</p>&#13;
&#13;
<p>You’ve seen many of these modules in various places in this book,&#13;
but also try the documentation for standard library support of&#13;
<a href="http://bit.ly/py-internet">internet protocols</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Web Services and APIs" data-type="sect1"><div class="sect1" id="web_service_apis">&#13;
<h1>Web Services and APIs</h1>&#13;
&#13;
<p><a data-primary="API (application programming interface)" data-type="indexterm" id="idm45794971282056"/><a data-primary="networks/networking" data-secondary="web services/APIs" data-type="indexterm" id="idm45794971281384"/><a data-primary="World Wide Web" data-secondary="web services/APIs" data-type="indexterm" id="idm45794971280440"/>Information providers always have a website,&#13;
but those are targeted for human eyes, not automation.&#13;
If data is published only on a website,&#13;
anyone who wants to access and structure the data&#13;
needs to write scrapers&#13;
(as shown in <a data-type="xref" href="ch18.html#scraping">“Crawl and Scrape”</a>), and&#13;
rewrite them each time a page format changes.&#13;
This is usually tedious.&#13;
In contrast, if a website offers an API to its data,&#13;
the data becomes directly available to client programs.&#13;
APIs change less often than web page layouts,&#13;
so client rewrites are less common.&#13;
A fast, clean data pipeline&#13;
also makes it easier to build&#13;
unforeseen but useful combinations.</p>&#13;
&#13;
<p>In many ways, the easiest API is a web interface,&#13;
but one that provides&#13;
data in a structured format such as JSON or XML&#13;
rather than plain text or HTML.&#13;
The API might be minimal or a full-fledged RESTful API&#13;
(defined in <a data-type="xref" href="ch18.html#rest">“Web APIs and REST”</a>), but&#13;
it provides another outlet for those restless bytes.</p>&#13;
&#13;
<p>At the very beginning of this book, you saw a web API&#13;
query the Internet Archive for an old copy of a website.</p>&#13;
&#13;
<p><a data-primary="social media sites, APIs and" data-type="indexterm" id="idm45794971275688"/>APIs are especially useful for mining well-known&#13;
social media sites such as Twitter,&#13;
Facebook, and LinkedIn.&#13;
All these sites provide APIs that are free to use,&#13;
but they require you to register and get a&#13;
key (a long-generated text string,&#13;
sometimes also known as a <em>token</em>)&#13;
to use when connecting.&#13;
The key lets a site determine who’s accessing its data.&#13;
It can also serve as a way to limit request traffic to servers.</p>&#13;
&#13;
<p>Here are some interesting service APIs:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="http://developer.nytimes.com">New York Times</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://python-twitter.readthedocs.io">Twitter</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://developers.facebook.com/tools">Facebook</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="http://www.wunderground.com/weather/api">Weather Underground</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="http://developer.marvel.com">Marvel Comics</a></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>You can see examples of APIs for maps in <a data-type="xref" href="ch21.html#ch_business">Chapter 21</a>,&#13;
and others in <a data-type="xref" href="ch22.html#ch_science">Chapter 22</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Data Serialization" data-type="sect1"><div class="sect1" id="serialization">&#13;
<h1>Data Serialization</h1>&#13;
&#13;
<p><a data-primary="data serialization" data-type="indexterm" id="ix_ch17-networks-asciidoc13"/><a data-primary="networks/networking" data-secondary="data serialization" data-type="indexterm" id="ix_ch17-networks-asciidoc14"/>As you saw in <a data-type="xref" href="ch16.html#ch_databases">Chapter 16</a>,&#13;
formats like XML, JSON, and YAML&#13;
are ways to store structured text data.&#13;
Networked applications need to exchange data with other programs.&#13;
The conversion between data in memory and byte sequences&#13;
“on the wire” is called <em>serialization</em> or <em>marshaling</em>.&#13;
JSON is a popular serialization format,&#13;
especially with web RESTful systems,&#13;
but it can’t express all Python data types directly.&#13;
Also, as a text format it tends to be more verbose&#13;
than some binary serialization methods.&#13;
Let’s look at some approaches that you’re likely to run into.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Serialize with pickle" data-type="sect2"><div class="sect2" id="pickle">&#13;
<h2>Serialize with pickle</h2>&#13;
&#13;
<p><a data-primary="pickle module" data-type="indexterm" id="idm45794971232008"/>Python provides the <code>pickle</code> module to save and restore any object&#13;
in a special binary format.</p>&#13;
&#13;
<p>Remember how JSON lost its mind when&#13;
encountering a <code>datetime</code> object?&#13;
Not a problem for <code>pickle</code>:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">pickle</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">datetime</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">now1</code> <code class="o">=</code> <code class="n">datetime</code><code class="o">.</code><code class="n">datetime</code><code class="o">.</code><code class="n">utcnow</code><code class="p">()</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">pickled</code> <code class="o">=</code> <code class="n">pickle</code><code class="o">.</code><code class="n">dumps</code><code class="p">(</code><code class="n">now1</code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">now2</code> <code class="o">=</code> <code class="n">pickle</code><code class="o">.</code><code class="n">loads</code><code class="p">(</code><code class="n">pickled</code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">now1</code>&#13;
<code class="go">datetime.datetime(2014, 6, 22, 23, 24, 19, 195722)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">now2</code>&#13;
<code class="go">datetime.datetime(2014, 6, 22, 23, 24, 19, 195722)</code></pre>&#13;
&#13;
<p><code>pickle</code> works with your own classes and objects, too.&#13;
Let’s define a little class called <code>Tiny</code>&#13;
that returns the string <code>'tiny'</code> when treated as a string:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">pickle</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="k">class</code> <code class="nc">Tiny</code><code class="p">():</code>&#13;
<code class="gp">... </code>    <code class="k">def</code> <code class="nf">__str__</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
<code class="gp">... </code>       <code class="k">return</code> <code class="s">'tiny'</code>&#13;
<code class="gp">...</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">obj1</code> <code class="o">=</code> <code class="n">Tiny</code><code class="p">()</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">obj1</code>&#13;
<code class="go">&lt;__main__.Tiny object at 0x10076ed10&gt;</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="nb">str</code><code class="p">(</code><code class="n">obj1</code><code class="p">)</code>&#13;
<code class="go">'tiny'</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">pickled</code> <code class="o">=</code> <code class="n">pickle</code><code class="o">.</code><code class="n">dumps</code><code class="p">(</code><code class="n">obj1</code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">pickled</code>&#13;
<code class="go">b'\x80\x03c__main__\nTiny\nq\x00)\x81q\x01.'</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">obj2</code> <code class="o">=</code> <code class="n">pickle</code><code class="o">.</code><code class="n">loads</code><code class="p">(</code><code class="n">pickled</code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">obj2</code>&#13;
<code class="go">&lt;__main__.Tiny object at 0x10076e550&gt;</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="nb">str</code><code class="p">(</code><code class="n">obj2</code><code class="p">)</code>&#13;
<code class="go">'tiny'</code></pre>&#13;
&#13;
<p><code>pickled</code> is the pickled binary string made&#13;
from the object <code>obj1</code>.&#13;
We converted that back to the object <code>obj2</code>&#13;
to make a copy of <code>obj1</code>.&#13;
Use <code>dump()</code> to pickle to a file,&#13;
and <code>load()</code> to unpickle from one.</p>&#13;
&#13;
<p>The <code>multiprocessing</code> module&#13;
uses <code>pickle</code> to interchange data among processes.</p>&#13;
&#13;
<p>If <code>pickle</code> can’t serialize your data format,&#13;
a newer third-party package called&#13;
<a href="https://pypi.org/project/dill"><code>dill</code></a> might.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p><a data-primary="security issues" data-secondary="pickle module" data-type="indexterm" id="idm45794971079016"/>Because <code>pickle</code> can create Python objects,&#13;
the same security warnings that were discussed&#13;
in earlier sections apply.&#13;
A public service announcement:&#13;
don’t unpickle something that you don’t trust.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Other Serialization Formats" data-type="sect2"><div class="sect2" id="other_serialization">&#13;
<h2>Other Serialization Formats</h2>&#13;
&#13;
<p>These binary data interchange&#13;
formats are usually more compact and faster&#13;
than XML or JSON:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="http://msgpack.org">MsgPack</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://code.google.com/p/protobuf">Protocol Buffers</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="http://avro.apache.org/docs/current">Avro</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="http://thrift.apache.org">Thrift</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://lima.readthedocs.io">Lima</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://pypi.org/project/Serialize"><code>Serialize</code></a>&#13;
is a Python frontend to other formats,&#13;
including JSON, YAML, pickle, and MsgPack.</p>&#13;
</li>&#13;
<li>&#13;
<p>A <a href="https://oreil.ly/S3ESH">benchmark</a>&#13;
of various Python serialization packages.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Because they are binary, none can be easily edited by a human&#13;
with a text editor.</p>&#13;
&#13;
<p id="validation">Some third-party packages&#13;
interconvert objects and basic Python data types&#13;
(allowing further conversion to/from formats like JSON),&#13;
and provide <em>validation</em> of the <span class="keep-together">following:</span></p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Data types</p>&#13;
</li>&#13;
<li>&#13;
<p>Value ranges</p>&#13;
</li>&#13;
<li>&#13;
<p>Required versus optional data</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>These include:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://marshmallow.readthedocs.io/en/3.0">Marshmallow</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://pydantic-docs.helpmanual.io">Pydantic</a>—uses type hints, so requires at least Python 3.6</p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://www.encode.io/typesystem">TypeSystem</a></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>These are often used with web servers to ensure that&#13;
the bytes that came over the wire via HTTP&#13;
end up in the right data structures for further processing.<a data-startref="ix_ch17-networks-asciidoc14" data-type="indexterm" id="idm45794971053736"/><a data-startref="ix_ch17-networks-asciidoc13" data-type="indexterm" id="idm45794971053016"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Remote Procedure Calls" data-type="sect1"><div class="sect1" id="rpc">&#13;
<h1>Remote Procedure Calls</h1>&#13;
&#13;
<p><a data-primary="networks/networking" data-secondary="Remote Procedure Calls" data-type="indexterm" id="ix_ch17-networks-asciidoc15"/><a data-primary="Remote Procedure Calls (RPCs)" data-type="indexterm" id="ix_ch17-networks-asciidoc16"/>Remote Procedure Calls (RPCs)&#13;
look like normal functions but execute&#13;
on remote machines across a network.&#13;
Instead of calling a RESTful API with&#13;
arguments encoded in the URL or request body,&#13;
you call an RPC function on your own machine.&#13;
Your local machine:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Serializes your function arguments into bytes.</p>&#13;
</li>&#13;
<li>&#13;
<p>Sends the encoded bytes to the remote machine.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The remote machine:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Receives the encoded request bytes.</p>&#13;
</li>&#13;
<li>&#13;
<p>Deserializes the bytes back to data structures.</p>&#13;
</li>&#13;
<li>&#13;
<p>Finds and calls the service function with the decoded data.</p>&#13;
</li>&#13;
<li>&#13;
<p>Encodes the function results.</p>&#13;
</li>&#13;
<li>&#13;
<p>Sends the encoded bytes back to the caller.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>And finally, the local machine that started it all:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Decodes the bytes to return values.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>RPC is a popular technique,&#13;
and people have implemented it in many ways.&#13;
On the server side, you start a server program,&#13;
connect it with some byte transport and encoding/decoding method,&#13;
define some service functions,&#13;
and light up your <em>RPC is open for business</em> sign.&#13;
The client connects to the server&#13;
and calls one of its functions via RPC.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="XML RPC" data-type="sect2"><div class="sect2" id="xmlrpc">&#13;
<h2>XML RPC</h2>&#13;
&#13;
<p><a data-primary="Remote Procedure Calls (RPCs)" data-secondary="XML RPC" data-type="indexterm" id="idm45794971035352"/><a data-primary="xmlrpc" data-type="indexterm" id="idm45794971034312"/>The standard library includes one RPC implementation&#13;
that uses XML as the exchange format: <code>xmlrpc</code>.&#13;
You define and register functions on the server,&#13;
and the client calls them as though they were imported.&#13;
First, let’s explore the file <em>xmlrpc_server.py</em>, as shown in <a data-type="xref" href="#xmlrpc_server">Example 17-11</a>.</p>&#13;
<div data-type="example" id="xmlrpc_server">&#13;
<h5><span class="label">Example 17-11. </span>xmlrpc_server.py</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">xmlrpc.server</code> <code class="kn">import</code> <code class="n">SimpleXMLRPCServer</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">double</code><code class="p">(</code><code class="n">num</code><code class="p">):</code>&#13;
    <code class="k">return</code> <code class="n">num</code> <code class="o">*</code> <code class="mi">2</code>&#13;
&#13;
<code class="n">server</code> <code class="o">=</code> <code class="n">SimpleXMLRPCServer</code><code class="p">((</code><code class="s2">"localhost"</code><code class="p">,</code> <code class="mi">6789</code><code class="p">))</code>&#13;
<code class="n">server</code><code class="o">.</code><code class="n">register_function</code><code class="p">(</code><code class="n">double</code><code class="p">,</code> <code class="s2">"double"</code><code class="p">)</code>&#13;
<code class="n">server</code><code class="o">.</code><code class="n">serve_forever</code><code class="p">()</code></pre></div>&#13;
&#13;
<p>The function we’re providing on the server is called <code>double()</code>.&#13;
It expects a number as an argument and returns&#13;
the value of that number times two.&#13;
The server starts up on an address and port.&#13;
We need to <em>register</em> the function to make it&#13;
available to clients via RPC.&#13;
Finally, start serving and carry on.</p>&#13;
&#13;
<p>Now—you guessed it—<em>xmlrpc_client.py</em>, proudly presented in <a data-type="xref" href="#xmlrpc_client">Example 17-12</a>.</p>&#13;
<div data-type="example" id="xmlrpc_client">&#13;
<h5><span class="label">Example 17-12. </span>xmlrpc_client.py</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">xmlrpc.client</code>&#13;
&#13;
<code class="n">proxy</code> <code class="o">=</code> <code class="n">xmlrpc</code><code class="o">.</code><code class="n">client</code><code class="o">.</code><code class="n">ServerProxy</code><code class="p">(</code><code class="s2">"http://localhost:6789/"</code><code class="p">)</code>&#13;
<code class="n">num</code> <code class="o">=</code> <code class="mi">7</code>&#13;
<code class="n">result</code> <code class="o">=</code> <code class="n">proxy</code><code class="o">.</code><code class="n">double</code><code class="p">(</code><code class="n">num</code><code class="p">)</code>&#13;
<code class="k">print</code><code class="p">(</code><code class="s2">"Double </code><code class="si">%s</code><code class="s2"> is </code><code class="si">%s</code><code class="s2">"</code> <code class="o">%</code> <code class="p">(</code><code class="n">num</code><code class="p">,</code> <code class="n">result</code><code class="p">))</code></pre></div>&#13;
&#13;
<p>The client connects to the server by using <code>ServerProxy()</code>.&#13;
Then, it calls the function <code>proxy.double()</code>.&#13;
Where did that come from?&#13;
It was created dynamically by the server.&#13;
The RPC machinery magically hooks this function name into&#13;
a call to the remote server.</p>&#13;
&#13;
<p>Give it a try—start the server and then run the client:</p>&#13;
<pre>$ <strong>python xmlrpc_server.py</strong></pre>&#13;
&#13;
<p>Run the client again:</p>&#13;
<pre>$ <strong>python xmlrpc_client.py</strong>&#13;
Double 7 is 14</pre>&#13;
&#13;
<p>The server then prints the following:</p>&#13;
&#13;
<pre data-type="programlisting">127.0.0.1 - - [13/Feb/2014 20:16:23] "POST / HTTP/1.1" 200 -</pre>&#13;
&#13;
<p>Popular transport methods are HTTP and ZeroMQ.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="JSON RPC" data-type="sect2"><div class="sect2" id="jsonrpc">&#13;
<h2>JSON RPC</h2>&#13;
&#13;
<p><a data-primary="JSON-RPC" data-type="indexterm" id="idm45794970890856"/><a data-primary="Remote Procedure Calls (RPCs)" data-secondary="JSON-RPC" data-type="indexterm" id="idm45794970889928"/>JSON-RPC (versions&#13;
<a href="https://oreil.ly/OklKa">1.0</a>&#13;
and&#13;
<a href="https://oreil.ly/4CS0r">2.0</a>)&#13;
is similar to XML-RPC,&#13;
but with JSON.&#13;
There are many Python JSON-RPC libraries,&#13;
but the simplest one I’ve found comes in two parts:&#13;
<a href="https://oreil.ly/8npxf">client</a>&#13;
and&#13;
<a href="https://oreil.ly/P_uDr">server</a>.</p>&#13;
&#13;
<p>Installation of both is familiar:&#13;
<code>pip install jsonrpcserver</code>&#13;
and&#13;
<code>pip install jsonrpclient</code>.</p>&#13;
&#13;
<p>These libraries provide many alternative ways to&#13;
write a&#13;
<a href="https://oreil.ly/fd412">client</a>&#13;
and&#13;
<a href="https://oreil.ly/SINeg">server</a>.&#13;
In <a data-type="xref" href="#jsonrpc_server">Example 17-13</a> and <a data-type="xref" href="#jsonrpc_client">Example 17-14</a>, I use this library’s built-in&#13;
server, which uses port 5000 and is the simplest.</p>&#13;
&#13;
<p>First, the server.</p>&#13;
<div data-type="example" id="jsonrpc_server">&#13;
<h5><span class="label">Example 17-13. </span>jsonrpc_server.py</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">jsonrpcserver</code> <code class="kn">import</code> <code class="n">method</code><code class="p">,</code> <code class="n">serve</code>&#13;
&#13;
<code class="nd">@method</code>&#13;
<code class="k">def</code> <code class="nf">double</code><code class="p">(</code><code class="n">num</code><code class="p">):</code>&#13;
    <code class="k">return</code> <code class="n">num</code> <code class="o">*</code> <code class="mi">2</code>&#13;
&#13;
<code class="k">if</code> <code class="nv-Magic">__name__</code> <code class="o">==</code> <code class="s2">"__main__"</code><code class="p">:</code>&#13;
    <code class="n">serve</code><code class="p">()</code></pre></div>&#13;
&#13;
<p class="pagebreak-before">Second, the client.</p>&#13;
<div data-type="example" id="jsonrpc_client">&#13;
<h5><span class="label">Example 17-14. </span>jsonrpc_client.py</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">jsonrpcclient</code> <code class="kn">import</code> <code class="n">request</code>&#13;
&#13;
<code class="n">num</code> <code class="o">=</code> <code class="mi">7</code>&#13;
<code class="n">response</code> <code class="o">=</code> <code class="n">request</code><code class="p">(</code><code class="s2">"http://localhost:5000"</code><code class="p">,</code> <code class="s2">"double"</code><code class="p">,</code> <code class="n">num</code><code class="o">=</code><code class="n">num</code><code class="p">)</code>&#13;
<code class="k">print</code><code class="p">(</code><code class="s2">"Double"</code><code class="p">,</code> <code class="n">num</code><code class="p">,</code> <code class="s2">"is"</code><code class="p">,</code> <code class="n">response</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">result</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>As with most of the client-server examples in this chapter,&#13;
start the server first&#13;
(in its own terminal window, or with a following <code>&amp;</code>&#13;
to put it in the background) and&#13;
then run the client:</p>&#13;
<pre>$ <strong>python jsonrpc_server.py &amp;</strong>&#13;
[1] 10621&#13;
$ <strong>python jsonrpc_client.py</strong>&#13;
127.0.0.1 - - [23/Jun/2019 15:39:24] "POST / HTTP/1.1" 200 -&#13;
Double 7 is 14</pre>&#13;
&#13;
<p>If you put the server in the background, kill it when you’re done.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="MessagePack RPC" data-type="sect2"><div class="sect2" id="idm45794970892104">&#13;
<h2>MessagePack RPC</h2>&#13;
&#13;
<p><a data-primary="MessagePack RPC" data-type="indexterm" id="idm45794970763960"/><a data-primary="Remote Procedure Calls (RPCs)" data-secondary="MessagePack RPC" data-type="indexterm" id="idm45794970763256"/>The encoding library MessagePack has its own&#13;
<a href="http://bit.ly/msgpack-rpc">Python RPC implementation</a>.&#13;
Here’s how to install it:</p>&#13;
<pre>$ <strong>pip install msgpack-rpc-python</strong></pre>&#13;
&#13;
<p>This will also install <code>tornado</code>,&#13;
a Python event-based web server&#13;
that this library uses as a transport.&#13;
As usual, the server (<em>msgpack_server.py</em>) comes first (<a data-type="xref" href="#msgpack_server">Example 17-15</a>).</p>&#13;
<div data-type="example" id="msgpack_server">&#13;
<h5><span class="label">Example 17-15. </span>msgpack_server.py</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">msgpackrpc</code> <code class="kn">import</code> <code class="n">Server</code><code class="p">,</code> <code class="n">Address</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">Services</code><code class="p">():</code>&#13;
    <code class="k">def</code> <code class="nf">double</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">num</code><code class="p">):</code>&#13;
        <code class="k">return</code> <code class="n">num</code> <code class="o">*</code> <code class="mi">2</code>&#13;
&#13;
<code class="n">server</code> <code class="o">=</code> <code class="n">Server</code><code class="p">(</code><code class="n">Services</code><code class="p">())</code>&#13;
<code class="n">server</code><code class="o">.</code><code class="n">listen</code><code class="p">(</code><code class="n">Address</code><code class="p">(</code><code class="s2">"localhost"</code><code class="p">,</code> <code class="mi">6789</code><code class="p">))</code>&#13;
<code class="n">server</code><code class="o">.</code><code class="n">start</code><code class="p">()</code></pre></div>&#13;
&#13;
<p>The <code>Services</code> class exposes its methods as RPC services.&#13;
Go ahead and start the client, <em>msgpack_client.py</em> (<a data-type="xref" href="#msgpack_client">Example 17-16</a>).</p>&#13;
<div data-type="example" id="msgpack_client">&#13;
<h5><span class="label">Example 17-16. </span>msgpack_client.py</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">msgpackrpc</code> <code class="kn">import</code> <code class="n">Client</code><code class="p">,</code> <code class="n">Address</code>&#13;
&#13;
<code class="n">client</code> <code class="o">=</code> <code class="n">Client</code><code class="p">(</code><code class="n">Address</code><code class="p">(</code><code class="s2">"localhost"</code><code class="p">,</code> <code class="mi">6789</code><code class="p">))</code>&#13;
<code class="n">num</code> <code class="o">=</code> <code class="mi">8</code>&#13;
<code class="n">result</code> <code class="o">=</code>  <code class="n">client</code><code class="o">.</code><code class="n">call</code><code class="p">(</code><code class="s1">'double'</code><code class="p">,</code> <code class="n">num</code><code class="p">)</code>&#13;
<code class="k">print</code><code class="p">(</code><code class="s2">"Double </code><code class="si">%s</code><code class="s2"> is </code><code class="si">%s</code><code class="s2">"</code> <code class="o">%</code> <code class="p">(</code><code class="n">num</code><code class="p">,</code> <code class="n">result</code><code class="p">))</code></pre></div>&#13;
&#13;
<p>To run these, follow the usual drill—start the server and client in&#13;
separate terminal&#13;
windows,<sup><a data-type="noteref" href="ch17.html#idm45794970661368" id="idm45794970661368-marker">1</a></sup> and observe the results:</p>&#13;
<pre>$ <strong>python msgpack_server.py</strong></pre>&#13;
<pre>$ <strong>python msgpack_client.py</strong>&#13;
Double 8 is 16</pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Zerorpc" data-type="sect2"><div class="sect2" id="zerorpc">&#13;
<h2>Zerorpc</h2>&#13;
&#13;
<p><a data-primary="Remote Procedure Calls (RPCs)" data-secondary="Zerorpc" data-type="indexterm" id="idm45794970606184"/><a data-primary="Zerorpc" data-type="indexterm" id="idm45794970605240"/>Written by the developers of Docker&#13;
(when they were called dotCloud),&#13;
<a href="http://www.zerorpc.io">zerorpc</a>&#13;
uses&#13;
ZeroMQ and MsgPack to connect clients and servers.&#13;
It magically exposes functions as RPC endpoints.</p>&#13;
&#13;
<p>Type <code>pip install zerorpc</code> to install it.&#13;
The sample code in <a data-type="xref" href="#zerorpc_server">Example 17-17</a> and <a data-type="xref" href="#zerorpc_client">Example 17-18</a> shows a request-reply&#13;
client and server.</p>&#13;
<div data-type="example" id="zerorpc_server">&#13;
<h5><span class="label">Example 17-17. </span>zerorpc_server.py</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">zerorpc</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">RPC</code><code class="p">():</code>&#13;
    <code class="k">def</code> <code class="nf">double</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">num</code><code class="p">):</code>&#13;
        <code class="k">return</code> <code class="mi">2</code> <code class="o">*</code> <code class="n">num</code>&#13;
&#13;
<code class="n">server</code> <code class="o">=</code> <code class="n">zerorpc</code><code class="o">.</code><code class="n">Server</code><code class="p">(</code><code class="n">RPC</code><code class="p">())</code>&#13;
<code class="n">server</code><code class="o">.</code><code class="n">bind</code><code class="p">(</code><code class="s2">"tcp://0.0.0.0:4242"</code><code class="p">)</code>&#13;
<code class="n">server</code><code class="o">.</code><code class="n">run</code><code class="p">()</code></pre></div>&#13;
<div data-type="example" id="zerorpc_client">&#13;
<h5><span class="label">Example 17-18. </span>zerorpc_client.py</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">zerorpc</code>&#13;
&#13;
<code class="n">client</code> <code class="o">=</code> <code class="n">zerorpc</code><code class="o">.</code><code class="n">Client</code><code class="p">()</code>&#13;
<code class="n">client</code><code class="o">.</code><code class="n">connect</code><code class="p">(</code><code class="s2">"tcp://127.0.0.1:4242"</code><code class="p">)</code>&#13;
<code class="n">num</code> <code class="o">=</code> <code class="mi">7</code>&#13;
<code class="n">result</code> <code class="o">=</code> <code class="n">client</code><code class="o">.</code><code class="n">double</code><code class="p">(</code><code class="n">num</code><code class="p">)</code>&#13;
<code class="k">print</code><code class="p">(</code><code class="s2">"Double"</code><code class="p">,</code> <code class="n">num</code><code class="p">,</code> <code class="s2">"is"</code><code class="p">,</code> <code class="n">result</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>Notice that the client calls <code>client.double()</code>,&#13;
even though there’s no definition of it in there:</p>&#13;
<pre>$ <strong>python zerorpc_server &amp;</strong>&#13;
[1] 55172&#13;
$ <strong>python zerorpc_client.py</strong>&#13;
Double 7 is 14</pre>&#13;
&#13;
<p>The site has many more&#13;
<a href="https://github.com/0rpc/zerorpc-python">examples</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="gRPC" data-type="sect2"><div class="sect2" id="gprc">&#13;
<h2>gRPC</h2>&#13;
&#13;
<p><a data-primary="gRPC" data-type="indexterm" id="idm45794970460728"/><a data-primary="Remote Procedure Calls (RPCs)" data-secondary="gRPC" data-type="indexterm" id="idm45794970460024"/>Google created <a href="https://grpc.io">gRPC</a>&#13;
as a portable and fast way to define&#13;
and connect services.&#13;
It encodes data as&#13;
<a href="https://oreil.ly/UINlc">protocol buffers</a>.</p>&#13;
&#13;
<p>Install the Python parts:</p>&#13;
<pre>$ <strong>pip install grpcio</strong>&#13;
$ <strong>pip install grpcio-tools</strong></pre>&#13;
&#13;
<p>The Python client&#13;
<a href="https://grpc.io/docs/quickstart/python">docs</a>&#13;
are very detailed,&#13;
so I’m giving only a brief overview here.&#13;
You may also like this separate&#13;
<a href="https://oreil.ly/awnxO">tutorial</a>.</p>&#13;
&#13;
<p>To use gRPC, you write a <em>.proto</em> file&#13;
to define a <code>service</code>&#13;
and its <code>rpc</code> methods.</p>&#13;
&#13;
<p>An <code>rpc</code> method is like a function definition&#13;
(describing its arguments and return types)&#13;
and may specify one of these networking&#13;
patterns:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Request-response (sync or async)</p>&#13;
</li>&#13;
<li>&#13;
<p>Request-streaming response</p>&#13;
</li>&#13;
<li>&#13;
<p>Streaming request-response (sync or async)</p>&#13;
</li>&#13;
<li>&#13;
<p>Streaming request-streaming response</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Single responses can be blocking or&#13;
asynchronous.&#13;
Streaming responses are iterated.</p>&#13;
&#13;
<p>Next, you would run the&#13;
<code>grpc_tools.protoc</code> program to create&#13;
Python code for the client and server.&#13;
gRPC handles the serialization&#13;
and network communication;&#13;
you add your application-specific code to the&#13;
client and server stubs.</p>&#13;
&#13;
<p>gRPC is a top-level alternative to web REST APIs.&#13;
It seems to be a better fit than REST&#13;
for inter-service communication,&#13;
and REST may be preferred for public APIs.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Twirp" data-type="sect2"><div class="sect2" id="twirprpc">&#13;
<h2>Twirp</h2>&#13;
&#13;
<p><a data-primary="Remote Procedure Calls (RPCs)" data-secondary="Twirp" data-type="indexterm" id="idm45794970443688"/><a data-primary="Twirp" data-type="indexterm" id="idm45794970442648"/><a href="https://oreil.ly/buf4x">Twirp</a>&#13;
is similar to gRPC,&#13;
but claims to be simpler.&#13;
You define a <code>.proto</code> file as you would with gRPC,&#13;
and twirp can generate Python code to handle the client&#13;
and server ends.<a data-startref="ix_ch17-networks-asciidoc16" data-type="indexterm" id="idm45794970440792"/><a data-startref="ix_ch17-networks-asciidoc15" data-type="indexterm" id="idm45794970440072"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Remote Management Tools" data-type="sect1"><div class="sect1" id="salt">&#13;
<h1>Remote Management Tools</h1>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="http://www.saltstack.com"><code>Salt</code></a> <a data-primary="networks/networking" data-secondary="remote management tools" data-type="indexterm" id="idm45794970436216"/><a data-primary="Salt" data-type="indexterm" id="idm45794970435240"/>is written in Python.&#13;
It started as a way to implement remote execution,&#13;
but grew to a full-fledged&#13;
systems management platform.&#13;
Based on ZeroMQ rather than SSH,&#13;
it can scale to thousands of servers.</p>&#13;
</li>&#13;
<li>&#13;
<p><a href="http://puppetlabs.com"><code>Puppet</code></a>&#13;
and&#13;
<a href="http://www.getchef.com/chef"><code>Chef</code></a>&#13;
<a data-primary="Chef" data-type="indexterm" id="idm45794970431816"/><a data-primary="Puppet" data-type="indexterm" id="idm45794970431112"/>are popular and closely tied to Ruby.</p>&#13;
</li>&#13;
<li>&#13;
<p>The&#13;
<a href="http://www.ansible.com/home"><code>Ansible</code></a>&#13;
<a data-primary="Ansible" data-type="indexterm" id="idm45794970428536"/>package, which like Salt is written in Python,&#13;
is also comparable.&#13;
It’s free to download and use,&#13;
but support and some add-on packages require a commercial license.&#13;
It uses SSH by default and does not require any special software to be&#13;
installed on the machines that it will <span class="keep-together">manage.</span></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p><code>Salt</code> and <code>Ansible</code> are both&#13;
functional supersets of <code>Fabric</code>,&#13;
handling initial configuration,&#13;
deployment, and remote execution.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Big Fat Data" data-type="sect1"><div class="sect1" id="big_data">&#13;
<h1>Big Fat Data</h1>&#13;
&#13;
<p><a data-primary="big data" data-type="indexterm" id="idm45794970400904"/><a data-primary="networks/networking" data-secondary="for big data" data-type="indexterm" id="idm45794970400200"/>As Google and other internet companies grew,&#13;
they found that traditional computing solutions didn’t scale.&#13;
Software that worked for single machines, or even a few dozen,&#13;
could not keep up with thousands.</p>&#13;
&#13;
<p>Disk storage for databases and files involved too much <em>seeking</em>,&#13;
which requires mechanical movement of disk heads.&#13;
(Think of a vinyl record, and the time it takes to move the needle&#13;
from one track to another manually.&#13;
And think of the screeching sound it makes when you drop it too hard,&#13;
not to mention the sounds made by the record’s owner.)&#13;
But you could <em>stream</em> consecutive segments of the disk more quickly.</p>&#13;
&#13;
<p>Developers found that it was faster to&#13;
distribute and analyze data on many networked machines than&#13;
on individual ones.&#13;
They could use algorithms that sounded simplistic&#13;
but actually worked better overall with massively distributed data.&#13;
<a data-primary="MapReduce" data-type="indexterm" id="idm45794970396568"/>One of these is MapReduce,&#13;
which spreads a calculation across many machines and&#13;
then gathers the results.&#13;
It’s similar to working with queues.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Hadoop" data-type="sect2"><div class="sect2" id="hadoop">&#13;
<h2>Hadoop</h2>&#13;
&#13;
<p><a data-primary="Hadoop" data-type="indexterm" id="idm45794970393832"/>After Google published its MapReduce results in a&#13;
<a href="https://oreil.ly/cla0d">paper</a>,&#13;
Yahoo followed with an open source Java-based package named <em>Hadoop</em>&#13;
(named after the toy stuffed elephant of the lead programmer’s son).</p>&#13;
&#13;
<p>The phrase <em>big data</em> applies here.&#13;
Often it just means “data too big to fit on my machine”: data that&#13;
exceeds the disk, memory, CPU time, or all of the above.&#13;
To some organizations, if <em>big data</em> is mentioned somewhere&#13;
in a question, the answer is always Hadoop.&#13;
Hadoop copies data among machines,&#13;
running them through <em>map</em> (scatter) and <em>reduce</em> (gather) programs,&#13;
and saving the results on disk at each step.</p>&#13;
&#13;
<p>This batch process can be slow.&#13;
A quicker method called <em>Hadoop streaming</em> works like Unix pipes,&#13;
streaming the data through programs without&#13;
requiring disk writes at each step.&#13;
You can write Hadoop streaming programs in any language,&#13;
including Python.</p>&#13;
&#13;
<p>Many Python modules have been written for Hadoop,&#13;
and some are discussed in the blog post&#13;
<a href="http://bit.ly/py-hadoop">“A Guide to Python Frameworks for Hadoop”</a>.&#13;
Spotify, known for streaming music,&#13;
open sourced its Python component for Hadoop streaming,&#13;
<a href="https://github.com/spotify/luigi">Luigi</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Spark" data-type="sect2"><div class="sect2" id="spark">&#13;
<h2>Spark</h2>&#13;
&#13;
<p><a data-primary="Spark" data-type="indexterm" id="idm45794970384648"/>A rival named&#13;
<a href="http://bit.ly/about-spark">Spark</a>&#13;
was designed to run 10 to 100 times faster than Hadoop.&#13;
It can read and process any Hadoop data source and format.&#13;
Spark includes APIs for Python and other languages.&#13;
You can find the&#13;
<a href="http://bit.ly/dl-spark">installation</a>&#13;
documents online.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Disco" data-type="sect2"><div class="sect2" id="disco">&#13;
<h2>Disco</h2>&#13;
&#13;
<p><a data-primary="Disco" data-type="indexterm" id="idm45794970380424"/>Another alternative to Hadoop is <a href="http://discoproject.org">Disco</a>,&#13;
which uses Python for MapReduce processing&#13;
and Erlang for communication.&#13;
Alas, you can’t install it with <code>pip</code>;&#13;
see the <a href="http://bit.ly/get-disco">documentation</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Dask" data-type="sect2"><div class="sect2" id="dask">&#13;
<h2>Dask</h2>&#13;
&#13;
<p><a data-primary="Dask" data-type="indexterm" id="idm45794970375736"/><a href="https://dask.org">Dask</a>&#13;
is similar to Spark,&#13;
although it’s written in Python&#13;
and is largely used with scientific Python&#13;
packages like NumPy, Pandas, and scikit-learn.&#13;
It can spread tasks across thousand-machine&#13;
clusters.</p>&#13;
&#13;
<p>To get Dask and all of its extra helpers:</p>&#13;
<pre>$ <strong>pip install dask[complete]</strong></pre>&#13;
&#13;
<p>See <a data-type="xref" href="ch22.html#ch_science">Chapter 22</a>&#13;
for related examples of <em>parallel programming</em>,&#13;
in which a large structured calculation is distributed&#13;
among many machines.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Clouds" data-type="sect1"><div class="sect1" id="clouds">&#13;
<h1>Clouds</h1>&#13;
<blockquote>&#13;
<p><a data-primary="cloud computing" data-type="indexterm" id="ix_ch17-networks-asciidoc17"/>I really don’t know clouds at all.</p>&#13;
<p data-type="attribution">Joni Mitchell</p>&#13;
</blockquote>&#13;
&#13;
<p>Not so long ago,&#13;
you would buy your own servers,&#13;
bolt them into racks in data centers,&#13;
and install layers of software on them:&#13;
operating systems, device drivers,&#13;
filesystems, databases, web servers,&#13;
email servers, name servers,&#13;
load balancers, monitors,&#13;
and more.&#13;
Any initial novelty wore off&#13;
as you tried to keep multiple systems&#13;
alive and responsive.&#13;
And you worried constantly about security.</p>&#13;
&#13;
<p>Many hosting services offered to take care of&#13;
your servers for a fee,&#13;
but you still leased the physical devices&#13;
and had to pay for&#13;
your peak load configuration at all times.</p>&#13;
&#13;
<p>With more individual machines, failures are no longer infrequent:&#13;
they’re very common.&#13;
You need to scale services horizontally and&#13;
store data redundantly.&#13;
You can’t assume that the network operates like a single machine.&#13;
The eight fallacies of distributed computing,&#13;
according to Peter Deutsch, are as follows:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>The network is reliable.</p>&#13;
</li>&#13;
<li>&#13;
<p>Latency is zero.</p>&#13;
</li>&#13;
<li>&#13;
<p>Bandwidth is infinite.</p>&#13;
</li>&#13;
<li>&#13;
<p>The network is secure.</p>&#13;
</li>&#13;
<li>&#13;
<p>Topology doesn’t change.</p>&#13;
</li>&#13;
<li>&#13;
<p>There is one administrator.</p>&#13;
</li>&#13;
<li>&#13;
<p>Transport cost is zero.</p>&#13;
</li>&#13;
<li>&#13;
<p>The network is homogeneous.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>You can try to build these complex distributed systems,&#13;
but it’s a lot of work, and a different toolset is needed.&#13;
To borrow an analogy,&#13;
when you have a handful of servers,&#13;
you treat them like pets—you give them names,&#13;
know their personalities, and nurse them back to health when needed.&#13;
But at scale, you treat servers more like livestock:&#13;
they look alike, have numbers,&#13;
and are just replaced if they have any problems.</p>&#13;
&#13;
<p>Instead of building, you can&#13;
rent servers in the <em>cloud</em>.&#13;
By adopting this model, maintenance is someone else’s problem,&#13;
and you can concentrate on your service,&#13;
or blog,&#13;
or whatever you want to show the world.&#13;
Using web dashboards and APIs,&#13;
you can spin up servers with whatever configuration you need,&#13;
quickly and easily—they’re <em>elastic</em>.&#13;
You can monitor their status,&#13;
and be alerted if some metric exceeds a given threshold.&#13;
Clouds are currently a pretty hot topic,&#13;
and corporate spending on cloud components has spiked.</p>&#13;
&#13;
<p class="pagebreak-before">The big cloud vendors are:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Amazon (AWS)</p>&#13;
</li>&#13;
<li>&#13;
<p>Google</p>&#13;
</li>&#13;
<li>&#13;
<p>Microsoft Azure</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Amazon Web Services" data-type="sect2"><div class="sect2" id="aws">&#13;
<h2>Amazon Web Services</h2>&#13;
&#13;
<p><a data-primary="Amazon Web Services (AWS)" data-type="indexterm" id="idm45794970348920"/>As Amazon was growing from hundreds to thousands&#13;
to millions of servers,&#13;
developers ran into all the nasty problems of distributed systems.&#13;
One day in 2002 or thereabouts,&#13;
CEO Jeff Bezos declared to Amazon employees&#13;
that, henceforth, all&#13;
data and functionality needed to be exposed&#13;
only via network service interfaces—not files, or databases, or local function calls.&#13;
They had to design these interfaces as though&#13;
they were being offered&#13;
to the public.&#13;
The memo ended with a motivational nugget:&#13;
<em>“Anyone who doesn’t do this will be fired.”</em></p>&#13;
&#13;
<p>Not surprisingly, developers got to work,&#13;
and over time built a huge service-oriented&#13;
architecture.&#13;
They borrowed or innovated many solutions,&#13;
evolving into&#13;
<a href="http://aws.amazon.com">Amazon Web Services (AWS)</a>,&#13;
which now dominates the market.&#13;
The official Python AWS library is <code>boto3</code>:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://oreil.ly/y2Baz">documentation</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://aws.amazon.com/sdk-for-python">SDK</a> pages</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Install it with:</p>&#13;
<pre>$ <strong>pip install boto3</strong></pre>&#13;
&#13;
<p>You can use <code>boto3</code> as an alternative to AWS’s&#13;
web-based management pages.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Google Cloud" data-type="sect2"><div class="sect2" id="google_cloud">&#13;
<h2>Google Cloud</h2>&#13;
&#13;
<p><a data-primary="Google Cloud Platform" data-type="indexterm" id="idm45794970338456"/>Google uses Python a lot internally,&#13;
and it employs some prominent Python developers&#13;
(even Guido van Rossum himself, for some time).&#13;
From its&#13;
<a href="https://cloud.google.com">main</a>&#13;
and&#13;
<a href="https://cloud.google.com/python">Python</a> pages,&#13;
you can find details on its many services.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Microsoft Azure" data-type="sect2"><div class="sect2" id="azure">&#13;
<h2>Microsoft Azure</h2>&#13;
&#13;
<p><a data-primary="Azure" data-type="indexterm" id="idm45794970334312"/><a data-primary="Microsoft Azure" data-type="indexterm" id="idm45794970333608"/>Microsoft caught up with Amazon and Google&#13;
with its cloud offering,&#13;
<a href="https://azure.microsoft.com">Azure</a>.&#13;
See&#13;
<a href="https://oreil.ly/Yo6Nz">Python on Azure</a>&#13;
to learn how to develop and deploy Python applications.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="OpenStack" data-type="sect2"><div class="sect2" id="openstack">&#13;
<h2>OpenStack</h2>&#13;
&#13;
<p><a data-primary="OpenStack" data-type="indexterm" id="idm45794970329528"/><a href="https://www.openstack.org">OpenStack</a>&#13;
is an open source framework&#13;
of Python services and REST APIs.&#13;
Many of the services are similar to those in the&#13;
commercial clouds.<a data-startref="ix_ch17-networks-asciidoc17" data-type="indexterm" id="idm45794970328008"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Docker" data-type="sect1"><div class="sect1" id="docker">&#13;
<h1>Docker</h1>&#13;
&#13;
<p><a data-primary="Docker" data-type="indexterm" id="idm45794970325576"/><a data-primary="networks/networking" data-secondary="Docker" data-type="indexterm" id="idm45794970324872"/>The humble standardized shipping container&#13;
revolutionized international trade.&#13;
Only a few years ago,&#13;
Docker applied the <em>container</em> name and analogy&#13;
to a <em>virtualization</em> method&#13;
using some little-known Linux features.&#13;
Containers are much lighter than virtual machines,&#13;
and a bit heavier than Python virtualenvs.&#13;
They allow you to package an application separately&#13;
from other applications on the same machine,&#13;
sharing only the operating system kernel.</p>&#13;
&#13;
<p>To install Docker’s Python client&#13;
<a href="https://pypi.org/project/docker">library</a>:</p>&#13;
<pre>$ <strong>pip install docker</strong></pre>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Kubernetes" data-type="sect2"><div class="sect2" id="idm45794970320504">&#13;
<h2>Kubernetes</h2>&#13;
&#13;
<p><a data-primary="Kubernetes" data-type="indexterm" id="idm45794970319128"/>Containers caught on and spread through the computing world.&#13;
Eventually, people needed ways to manage multiple containers&#13;
and wanted to automate some of the manual steps that have&#13;
been usually required in large distributed systems:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Failover</p>&#13;
</li>&#13;
<li>&#13;
<p>Load balancing</p>&#13;
</li>&#13;
<li>&#13;
<p>Scaling up and down</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>It looks like <a href="https://kubernetes.io">Kubernetes</a>&#13;
is leading the pack in this new area of&#13;
<em>container orchestration</em>.</p>&#13;
&#13;
<p>To install the Python client&#13;
<a href="https://github.com/kubernetes-client/python">library</a>:</p>&#13;
<pre>$ <strong>pip install kubernetes</strong></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Coming Up" data-type="sect1"><div class="sect1" id="idm45794970311208">&#13;
<h1>Coming Up</h1>&#13;
&#13;
<p>As they say on television, our next guest needs no introduction.&#13;
Learn why Python is one of the best languages to tame the web.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Things to Do" data-type="sect1"><div class="sect1" id="idm45794970309480">&#13;
<h1>Things to Do</h1>&#13;
&#13;
<p>17.1&#13;
<a data-primary="networks/networking" data-secondary="practice exercises" data-type="indexterm" id="idm45794970307976"/>Use a plain <code>socket</code> to implement a current-time-service. When a client sends the string <em>time</em> to the server, return the current date and time as an ISO string.</p>&#13;
&#13;
<p>17.2&#13;
Use ZeroMQ REQ and REP sockets to do the same thing.</p>&#13;
&#13;
<p>17.3&#13;
Try the same with XMLRPC.</p>&#13;
&#13;
<p>17.4&#13;
You may have seen the classic <em>I Love Lucy</em> television episode&#13;
in which Lucy and Ethel worked in a chocolate factory.&#13;
The duo fell behind as the conveyor belt that supplied&#13;
the confections for them to process&#13;
began operating at an ever-faster rate.&#13;
Write a simulation that pushes different types of chocolates&#13;
to a Redis list,&#13;
and Lucy is a client doing blocking pops of this list.&#13;
She needs 0.5 seconds to handle a piece of chocolate.&#13;
Print the time and type of each chocolate as Lucy gets it,&#13;
and how many remain to be handled.</p>&#13;
&#13;
<p>17.5&#13;
Use ZeroMQ to publish the poem from exercise 12.4&#13;
(from <a data-type="xref" href="ch12.html#mammoth">Example 12-1</a>), one word at a time.&#13;
Write a ZeroMQ consumer that prints every word that&#13;
starts with a vowel,&#13;
and another that prints every word that contains five letters.&#13;
Ignore punctuation characters.<a data-startref="ix_ch17-networks-asciidoc0" data-type="indexterm" id="idm45794970302072"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<div data-type="footnotes"><p data-type="footnote" id="idm45794970661368"><sup><a href="ch17.html#idm45794970661368-marker">1</a></sup> Or put the server in the background with a final <code>&amp;</code>.</p></div></div></section></body></html>