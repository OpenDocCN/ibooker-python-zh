<html><head></head><body>
<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 20. Static Analysis" class="preface"><div class="preface" id="static_analysis">
<h1 class="calibre10" id="calibre_pb_0"><span class="calibre">Chapter 20. </span>Static Analysis</h1>


<p class="author1">Before I get to testing, I first want<a data-type="indexterm" data-primary="static analysis" id="ix_statan" class="calibre5"/> to talk about static analysis. <em class="calibre6">Static analysis</em> is a set of tools that inspect your codebase, looking for potential errors or inconsistencies. It’s a great asset for finding common mistakes. In fact, you’ve already been working with a static analysis tool: mypy. Mypy (and other typecheckers) inspect your codebase and find typing errors. Other static analysis tools check for other types of errors. In this chapter, I’ll walk you through common static analyzers for linting, complexity checking, and security scanning.</p>






</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 20. Static Analysis" class="preface">
<div class="preface" id="static_analysis">
<section data-type="sect1" data-pdf-bookmark="Linting" class="preface"><div class="preface" id="idm45644728707560">
<h1 class="calibre12" id="calibre_pb_1">Linting</h1>

<p class="author1">The first class of static analysis tools that I’ll walk you through is called a <em class="calibre6">linter</em>. <a data-type="indexterm" data-primary="linting" id="ix_lnt" class="calibre5"/><a data-type="indexterm" data-primary="static analysis" data-secondary="linting" id="ix_statanlnt" class="calibre5"/><a data-type="indexterm" data-primary="linters" id="idm45644728702968" class="calibre5"/>Linters search for common programming mistakes and style violations within your codebase.<a data-type="indexterm" data-primary="lint" id="idm45644728702056" class="calibre5"/> They get their name from the original linter: a program named <em class="calibre6">lint</em> that used to check C programs for common errors. It would search for “fuzzy” logic and try to remove that fuzz (hence, linting). In Python, the most common linter you will come across is Pylint.<a data-type="indexterm" data-primary="linting" data-secondary="Pylint" id="ix_lntPy" class="calibre5"/><a data-type="indexterm" data-primary="Pylint" id="ix_Pylnt" class="calibre5"/><a data-type="indexterm" data-primary="errors" data-secondary="Pylint checking for" id="idm45644728698472" class="calibre5"/><a data-type="indexterm" data-primary="static analysis" data-secondary="linting" data-tertiary="Pylint" id="ix_statanlntPy" class="calibre5"/> Pylint is used to check for a myriad of common mistakes:</p>

<ul class="printings">
<li class="calibre9">
<p class="author1">Certain style violations of the <a href="https://oreil.ly/MnCoY" class="calibre5">PEP 8</a> Python style guide</p>
</li>
<li class="calibre9">
<p class="author1">Dead code that is unreachable (such as code after a return statement)</p>
</li>
<li class="calibre9">
<p class="author1">Violations of access constraints (such as private or protected members of a class)</p>
</li>
<li class="calibre9">
<p class="author1">Unused variables and functions</p>
</li>
<li class="calibre9">
<p class="author1">Lack of cohesion in a class (no use of self in a method, too many public methods)</p>
</li>
<li class="calibre9">
<p class="author1">Missing documentation in the form of docstrings</p>
</li>
<li class="calibre9">
<p class="author1">Common programming errors</p>
</li>
</ul>

<p class="author1">Many of these error classes are things that we’ve discussed previously, such as accessing private members or a function needing to be a free function instead of a member function (as discussed in <a data-type="xref" href="part0014_split_000.html#classes" class="calibre5">Chapter 10</a>.) A linter like Pylint will complement all of the techniques you’ve learned throughout this book; if you violate some of the principles I’ve been espousing, linters will catch those violations for you.</p>

<p class="author1">Pylint is also incredibly handy at finding some common errors in your code. Consider a developer adding code that adds all of an author’s cookbooks to an existing list:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="k">def</code> <code class="nf">add_authors_cookbooks</code><code class="calibre17">(</code><code class="n">author_name</code><code class="calibre17">:</code> <code class="nb">str</code><code class="calibre17">,</code> <code class="n">cookbooks</code><code class="calibre17">:</code> <code class="nb">list</code><code class="calibre17">[</code><code class="nb">str</code><code class="calibre17">]</code> <code class="calibre17">=</code> <code class="calibre17">[])</code> <code class="calibre17">-&gt;</code> <code class="nb">bool</code><code class="calibre17">:</code>

    <code class="n">author</code> <code class="calibre17">=</code> <code class="n">find_author</code><code class="calibre17">(</code><code class="n">author_name</code><code class="calibre17">)</code>
    <code class="k">if</code> <code class="n">author</code> <code class="calibre19">is</code> <code class="nb">None</code><code class="calibre17">:</code>
        <code class="k">assert</code> <code class="nb">False</code><code class="calibre17">,</code> <code class="s">"Author does not exist"</code>
    <code class="k">else</code><code class="calibre17">:</code>
        <code class="k">for</code> <code class="n">cookbook</code> <code class="calibre19">in</code> <code class="n">author</code><code class="calibre17">.</code><code class="n">get_cookbooks</code><code class="calibre17">():</code>
            <code class="n">cookbooks</code><code class="calibre17">.</code><code class="n">append</code><code class="calibre17">(</code><code class="n">cookbook</code><code class="calibre17">)</code>
        <code class="k">return</code> <code class="nb">True</code></pre>

<p class="author1">This seems innocuous, but there are two issues in this code. Take a few minutes and see if you can find them.<a data-type="indexterm" data-primary="Pylint" data-secondary="checking for errors in code" id="idm45644728653880" class="calibre5"/></p>

<p class="author1">Now let’s see what Pylint can do. First, I need to install it:</p>

<pre data-type="programlisting" class="calibre35">pip install pylint</pre>

<p class="author1">Then, I’ll run Pylint against the example above:</p>

<pre data-type="programlisting" class="calibre35">pylint code_examples/chapter20/lint_example.py
************* Module lint_example

code_examples/chapter20/lint_example.py:11:0: W0102:
    Dangerous default value [] as argument (dangerous-default-value)
code_examples/chapter20/lint_example.py:11:0: R1710:
    Either all return statements in a function should return an expression,
    or none of them should. (inconsistent-return-statements)</pre>

<p class="author1">Pylint has identified the two issues in my code (it actually found more, such as missing documentation strings, but I’ve elided them for the purposes of this discussion). <a data-type="indexterm" data-primary="[] dangerous mutable default value of an argument" id="idm45644728602040" class="calibre5"/>First, there is a dangerous mutable default value of an argument in the form of <code class="calibre17">[]</code>. Much has been written on this behavior <a href="https://oreil.ly/sCQQu" class="calibre5">before</a>, but it’s a common gotcha for errors, especially for people new to the language.</p>

<p class="author1">The other error is a bit more subtle: not all branches return the same type. “But wait!” you exclaim. “It’s OK, because <a data-type="indexterm" data-primary="assert statements" id="idm45644728599256" class="calibre5"/>I assert, which raises an error instead of falling through the <code class="calibre17">if</code> statement (which returns <code class="calibre17">None</code>).” However, while <code class="calibre17">assert</code> statements are fantastic, they can be turned off. When you pass the <code class="calibre17">-O</code> flag to Python, it disables all <code class="calibre17">assert</code> statements. So, when the <code class="calibre17">-O</code> flag is turned on, this function returns <code class="calibre17">None</code>. For the record, mypy does not catch this error, but Pylint does. Even better, Pylint ran in under a second to find those bugs.</p>

<p class="author1">It doesn’t matter if you don’t make those errors, or you if always find them in code review. There are countless developers working in any codebase, and errors can happen anywhere. By enforcing a linter like Pylint, you can eliminate very common, detectable errors.<a data-type="indexterm" data-primary="static analysis" data-secondary="linting" data-tertiary="Pylint" data-startref="ix_statanlntPy" id="idm45644728594728" class="calibre5"/><a data-type="indexterm" data-primary="checkers (or rules)" data-secondary="Pylint built-in checkers" id="idm45644728593208" class="calibre5"/><a data-type="indexterm" data-primary="Pylint" data-secondary="built-in checkers, list of" id="idm45644728592296" class="calibre5"/> For a full list of built-in checkers, see the <a href="https://oreil.ly/9HRzC" class="calibre5">Pylint documentation</a>.</p>
<aside data-type="sidebar" epub:type="sidebar" class="calibre32"><div class="sidebar" id="idm45644728590408">
<h5 class="calibre33">Shift Errors Left</h5>
<p class="author1">One of the common tenets of the DevOps mindset<a data-type="indexterm" data-primary="errors" data-secondary="shifting left" id="idm45644728588984" class="calibre5"/><a data-type="indexterm" data-primary="shifting errors left" id="idm45644728588008" class="calibre5"/><a data-type="indexterm" data-primary="static analysis" data-secondary="shifting errors left" id="idm45644728587336" class="calibre5"/> is to “shift your errors left.” I mentioned this when discussing types, but it applies to static analysis and tests as well. The idea is to think of your errors in terms of their cost. How expensive is it to fix an error? It depends on where you find that error. An error found in production by a customer is costly. Developers have to spend time away from their normal feature development, tech support and testers get involved, and there are risks when you have to do an emergency deployment.</p>

<p class="author1">The earlier in the development cycle you are, the less expensive it is to address errors. If you can find errors during testing, you can avoid a slew of production costs. However, you want to find these issues even earlier, before they ever enter into the codebase. I talked at length in <a data-type="xref" href="part0004.html#part_1" class="calibre5">Part I</a> about how typecheckers can shift those errors even further left, so that you find the errors right as you develop. It’s not just typecheckers that allow you to do this, but static analysis tools such as linters and complexity checkers as well.<a data-type="indexterm" data-primary="linting" data-secondary="Pylint" data-startref="ix_lntPy" id="idm45644728583976" class="calibre5"/></p>

<p class="author1">These static analysis tools are your first line of defense against errors, even more so than tests. They aren’t a silver bullet (nothing is), but they are invaluable in finding problems early. Add them to your continuous integration pipeline and set them up as pre-commit hooks or server-side hooks in your version control system. Save yourself time and money and don’t let easy-to-detect errors ever enter your codebase.</p>
</div></aside>








</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 20. Static Analysis" class="preface">
<div class="preface" id="static_analysis">
<section data-type="sect1" data-pdf-bookmark="Linting" class="preface">
<div class="preface" id="idm45644728707560">
<section data-type="sect2" data-pdf-bookmark="Writing Your Own Pylint Plug-in" class="preface"><div class="preface" id="idm45644728581672">
<h2 class="calibre34" id="calibre_pb_2">Writing Your Own Pylint Plug-in</h2>

<p class="author1">The real Pylint magic starts to happen when you write your own plug-ins (see <a data-type="xref" href="part0024_split_000.html#pluggable" class="calibre5">Chapter 19</a> for more information on plug-in architectures).<a data-type="indexterm" data-primary="static analysis" data-secondary="linting" data-tertiary="writing your own Pylint plug-in" id="ix_statanlntwr" class="calibre5"/><a data-type="indexterm" data-primary="linting" data-secondary="writing your own Pylint plug-in" id="ix_lntwr" class="calibre5"/><a data-type="indexterm" data-primary="Pylint" data-secondary="writing your own plug-in" id="ix_Pylntwr" class="calibre5"/> A Pylint plug-in lets you write your own custom <em class="calibre6">checkers</em>, or rules.<a data-type="indexterm" data-primary="checkers (or rules)" data-secondary="writing your own" id="idm45644728574376" class="calibre5"/> While built-in checkers look for common Python errors, your custom checkers can look for errors in your problem domain.</p>

<p class="author1">Take a look at a snippet of code way back from <a data-type="xref" href="part0007_split_000.html#constraints" class="calibre5">Chapter 4</a>:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="n">ReadyToServeHotDog</code> <code class="calibre17">=</code> <code class="n">NewType</code><code class="calibre17">(</code><code class="s">"ReadyToServeHotDog"</code><code class="calibre17">,</code> <code class="n">HotDog</code><code class="calibre17">)</code>

<code class="k">def</code> <code class="nf">prepare_for_serving</code><code class="calibre17">()</code> <code class="calibre17">-&gt;</code> <code class="n">ReadyToServeHotDog</code><code class="calibre17">:</code>
    <code class="c"># snip preparation</code>
    <code class="k">return</code> <code class="n">ReadyToServeHotDog</code><code class="calibre17">(</code><code class="n">hotdog</code><code class="calibre17">)</code></pre>

<p class="author1">During <a data-type="xref" href="part0007_split_000.html#constraints" class="calibre5">Chapter 4</a>, I mentioned that in order for <code class="calibre17">NewType</code> to be effective, you need to make sure that you<a data-type="indexterm" data-primary="blessed methods" id="idm45644728562936" class="calibre5"/> are only constructing it from <em class="calibre6">blessed</em> methods, or methods that enforce the constraints tied to that type. At the time, my advice was to use a comment to give hints to readers of the code. However, with Pylint, you can write a custom checker to find out when you violate this expectation.</p>

<p class="author1">Here’s the plug-in in its entirety. I’ll break it down for you afterward:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="k">from</code> <code class="nn">typing</code> <code class="k">import</code> <code class="n">Optional</code>

<code class="k">import</code> <code class="nn">astroid</code>

<code class="k">from</code> <code class="nn">pylint.checkers</code> <code class="k">import</code> <code class="n">BaseChecker</code>
<code class="k">from</code> <code class="nn">pylint.interfaces</code> <code class="k">import</code> <code class="n">IAstroidChecker</code>
<code class="k">from</code> <code class="nn">pylint.lint.pylinter</code> <code class="k">import</code> <code class="n">PyLinter</code>

<code class="k">class</code> <code class="nc">ServableHotDogChecker</code><code class="calibre17">(</code><code class="n">BaseChecker</code><code class="calibre17">):</code>
    <code class="n">__implements__</code> <code class="calibre17">=</code> <code class="n">IAstroidChecker</code>

    <code class="n">name</code> <code class="calibre17">=</code> <code class="s">'unverified-ready-to-serve-hotdog'</code>
    <code class="n">priority</code> <code class="calibre17">=</code> <code class="calibre17">-</code><code class="mi">1</code>
    <code class="n">msgs</code> <code class="calibre17">=</code> <code class="calibre17">{</code>
      <code class="s">'W0001'</code><code class="calibre17">:</code> <code class="calibre17">(</code>
        <code class="s">'ReadyToServeHotDog created outside of hotdog.prepare_for_serving.'</code><code class="calibre17">,</code>
        <code class="s">'unverified-ready-to-serve-hotdog'</code><code class="calibre17">,</code>
        <code class="s">'Only create a ReadyToServeHotDog through hotdog.prepare_for_serving.'</code>
      <code class="calibre17">),</code>
    <code class="calibre17">}</code>

    <code class="k">def</code> <code class="calibre17">__init__</code><code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">,</code> <code class="n">linter</code><code class="calibre17">:</code> <code class="n">Optional</code><code class="calibre17">[</code><code class="n">PyLinter</code><code class="calibre17">]</code> <code class="calibre17">=</code> <code class="nb">None</code><code class="calibre17">):</code>
        <code class="nb">super</code><code class="calibre17">(</code><code class="n">ServableHotDogChecker</code><code class="calibre17">,</code> <code class="nb">self</code><code class="calibre17">)</code><code class="calibre17">.</code><code class="calibre17">__init__</code><code class="calibre17">(</code><code class="n">linter</code><code class="calibre17">)</code>
        <code class="nb">self</code><code class="calibre17">.</code><code class="n">_is_in_prepare_for_serving</code> <code class="calibre17">=</code> <code class="nb">False</code>

    <code class="k">def</code> <code class="nf">visit_functiondef</code><code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">,</code> <code class="n">node</code><code class="calibre17">:</code> <code class="n">astroid</code><code class="calibre17">.</code><code class="n">scoped_nodes</code><code class="calibre17">.</code><code class="n">FunctionDef</code><code class="calibre17">):</code>
        <code class="k">if</code> <code class="calibre17">(</code><code class="n">node</code><code class="calibre17">.</code><code class="n">name</code> <code class="calibre17">==</code> <code class="s">"prepare_for_serving"</code> <code class="calibre19">and</code>
            <code class="n">node</code><code class="calibre17">.</code><code class="n">parent</code><code class="calibre17">.</code><code class="n">name</code> <code class="calibre17">==</code><code class="s">"hotdog"</code> <code class="calibre19">and</code>
            <code class="nb">isinstance</code><code class="calibre17">(</code><code class="n">node</code><code class="calibre17">.</code><code class="n">parent</code><code class="calibre17">,</code> <code class="n">astroid</code><code class="calibre17">.</code><code class="n">scoped_nodes</code><code class="calibre17">.</code><code class="n">Module</code><code class="calibre17">)):</code>

            <code class="nb">self</code><code class="calibre17">.</code><code class="n">_is_in_prepare_for_serving</code> <code class="calibre17">=</code> <code class="nb">True</code>

    <code class="k">def</code> <code class="nf">leave_functiondef</code><code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">,</code> <code class="n">node</code><code class="calibre17">:</code> <code class="n">astroid</code><code class="calibre17">.</code><code class="n">scoped_nodes</code><code class="calibre17">.</code><code class="n">FunctionDef</code><code class="calibre17">):</code>
        <code class="k">if</code> <code class="calibre17">(</code><code class="n">node</code><code class="calibre17">.</code><code class="n">name</code> <code class="calibre17">==</code> <code class="s">"prepare_for_serving"</code> <code class="calibre19">and</code>
            <code class="n">node</code><code class="calibre17">.</code><code class="n">parent</code><code class="calibre17">.</code><code class="n">name</code> <code class="calibre17">==</code><code class="s">"hotdog"</code> <code class="calibre19">and</code>
            <code class="nb">isinstance</code><code class="calibre17">(</code><code class="n">node</code><code class="calibre17">.</code><code class="n">parent</code><code class="calibre17">,</code> <code class="n">astroid</code><code class="calibre17">.</code><code class="n">scoped_nodes</code><code class="calibre17">.</code><code class="n">Module</code><code class="calibre17">)):</code>

            <code class="nb">self</code><code class="calibre17">.</code><code class="n">_is_in_prepare_for_serving</code> <code class="calibre17">=</code> <code class="nb">False</code>

    <code class="k">def</code> <code class="nf">visit_call</code><code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">,</code> <code class="n">node</code><code class="calibre17">:</code> <code class="n">astroid</code><code class="calibre17">.</code><code class="n">node_classes</code><code class="calibre17">.</code><code class="n">Call</code><code class="calibre17">):</code>
        <code class="k">if</code> <code class="n">node</code><code class="calibre17">.</code><code class="n">func</code><code class="calibre17">.</code><code class="n">name</code> <code class="calibre17">!=</code> <code class="s">'ReadyToServeHotDog'</code><code class="calibre17">:</code>
            <code class="k">return</code>

        <code class="k">if</code> <code class="nb">self</code><code class="calibre17">.</code><code class="n">_is_in_prepare_for_serving</code><code class="calibre17">:</code>
            <code class="k">return</code>

        <code class="nb">self</code><code class="calibre17">.</code><code class="n">add_message</code><code class="calibre17">(</code>
            <code class="s">'unverified-ready-to-serve-hotdog'</code><code class="calibre17">,</code> <code class="n">node</code><code class="calibre17">=</code><code class="n">node</code><code class="calibre17">,</code>
        <code class="calibre17">)</code>

<code class="k">def</code> <code class="nf">register</code><code class="calibre17">(</code><code class="n">linter</code><code class="calibre17">:</code> <code class="n">PyLinter</code><code class="calibre17">):</code>
    <code class="n">linter</code><code class="calibre17">.</code><code class="n">register_checker</code><code class="calibre17">(</code><code class="n">ServableHotDogChecker</code><code class="calibre17">(</code><code class="n">linter</code><code class="calibre17">))</code></pre>

<p class="author1">This linter verifies that when someone creates a <code class="calibre17">ReadyToServeHotDog</code>, it is only done in a function that is named <code class="calibre17">prepare_for_serving</code>, and that function must live in a module called <code class="calibre17">hotdog</code>. Now let’s say I were to create any other function that created a ready-to-serve hot dog, like this:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="k">def</code> <code class="nf">create_hot_dog</code><code class="calibre17">()</code> <code class="calibre17">-&gt;</code> <code class="n">ReadyToServeHotDog</code><code class="calibre17">:</code>
    <code class="n">hot_dog</code> <code class="calibre17">=</code> <code class="n">HotDog</code><code class="calibre17">()</code>
    <code class="k">return</code> <code class="n">ReadyToServeHotDog</code><code class="calibre17">(</code><code class="n">hot_dog</code><code class="calibre17">)</code></pre>

<p class="author1">I can run my custom Pylint checker:</p>

<pre data-type="programlisting" class="calibre35"> PYTHONPATH=code_examples/chapter20 pylint --load-plugins \
        hotdog_checker code_examples/chapter20/hotdog.py</pre>

<p class="author1">Pylint confirms that serving an “unservable” hot dog is now an error:</p>

<pre data-type="programlisting" class="calibre35">************* Module hotdog
code_examples/chapter20/hotdog.py:13:12: W0001:
    ReadyToServeHotDog created outside of prepare_for_serving.
        (unverified-ready-to-serve-hotdog)</pre>

<p class="author1">This is fantastic. Now I can write automated tooling that checks for errors that a typechecker like mypy can’t even begin to look for. Don’t let your imagination constrain you. Use Pylint to catch anything you can dream of: business logic constraint violations, temporal dependencies, or a custom style guide. Now, let’s go see how this linter works so that you can build your own.</p>
</div></section>













</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 20. Static Analysis" class="preface">
<div class="preface" id="static_analysis">
<section data-type="sect1" data-pdf-bookmark="Linting" class="preface">
<div class="preface" id="idm45644728707560">
<section data-type="sect2" data-pdf-bookmark="Breaking Down the Plug-in" class="preface"><div class="preface" id="idm45644728581048">
<h2 class="calibre34" id="calibre_pb_3">Breaking Down the Plug-in</h2>

<p class="author1">The first thing I did to write the plug-in was to define a class that inherits from a <code class="calibre17">pylint.checkers.BaseChecker</code>:<a data-type="indexterm" data-primary="Pylint" data-secondary="writing your own plug-in" data-tertiary="breaking down the plug-in" id="ix_Pylntwrbrk" class="calibre5"/><a data-type="indexterm" data-primary="linting" data-secondary="writing your own Pylint plug-in" data-tertiary="breaking down the plug-in" id="ix_lntwrbrk" class="calibre5"/></p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="k">import</code> <code class="nn">astroid</code>

<code class="k">from</code> <code class="nn">pylint.checkers</code> <code class="k">import</code> <code class="n">BaseChecker</code>
<code class="k">from</code> <code class="nn">pylint.interfaces</code> <code class="k">import</code> <code class="n">IAstroidChecker</code>

<code class="k">class</code> <code class="nc">ReadyToServeHotDogChecker</code><code class="calibre17">(</code><code class="n">BaseChecker</code><code class="calibre17">):</code>
    <code class="n">__implements__</code> <code class="calibre17">=</code> <code class="n">IAstroidChecker</code></pre>

<p class="author1">You’ll also notice some references to <code class="calibre17">astroid</code>. The <code class="calibre17">astroid</code> library is useful for parsing Python files into an abstract syntax tree (AST).<a data-type="indexterm" data-primary="abstract syntax tree (AST)" id="idm45644728234968" class="calibre5"/><a data-type="indexterm" data-primary="astroid library" id="idm45644728234328" class="calibre5"/> This provides a conveniently structured way of interacting with Python source code. You’ll see how that’s useful in a little bit.<a data-type="indexterm" data-primary="AST (abstract syntax tree)" id="idm45644728192296" class="calibre5"/></p>

<p class="author1">Next, I define metadata about the plug-in. This provides information such as the plug-in name, messages that get displayed to the user, and an identifier (<code class="calibre17">unverified-ready-to-serve-hotdog</code>) that I can refer to later.</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35">    <code class="n">name</code> <code class="calibre17">=</code> <code class="s">'unverified-ready-to-serve-hotdog'</code>
    <code class="n">priority</code> <code class="calibre17">=</code> <code class="calibre17">-</code><code class="mi">1</code>
    <code class="n">msgs</code> <code class="calibre17">=</code> <code class="calibre17">{</code>
     <code class="s">'W0001'</code><code class="calibre17">:</code> <code class="calibre17">(</code> <code class="c"># this is an arbitrary number I've assigned as an identifier</code>
        <code class="s">'ReadyToServeHotDog created outside of hotdog.prepare_for_serving.'</code><code class="calibre17">,</code>
        <code class="s">'unverified-ready-to-serve-hotdog'</code><code class="calibre17">,</code>
        <code class="s">'Only create a ReadyToServeHotDog through hotdog.prepare_for_serving.'</code>
     <code class="calibre17">),</code>
    <code class="calibre17">}</code></pre>

<p class="author1">Next, I want to track what function I’m in, so that I can tell if I’m using <span class="calibre"><code class="calibre17">prepare_for_serving</code></span> or not. This is where the <code class="calibre17">astroid</code> library will come to play. As mentioned before, the <code class="calibre17">astroid</code> library helps the Pylint checker think in terms of an AST; you don’t need to worry about string parsing. If you’d like to learn more about AST and Python parsing, you can check out <a href="https://oreil.ly/JvQgU" class="calibre5"><code class="calibre17">astroid</code>’s documentation</a>, but for now, all you have to know is that if you define specific functions in your checker, they will get called when <code class="calibre17">astroid</code> parses the code. Each function called gets passed a <code class="calibre17">node</code> which represents a specific part of code, such as an expression or a class definition.</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35">    <code class="k">def</code> <code class="calibre17">__init__</code><code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">,</code> <code class="n">linter</code><code class="calibre17">:</code> <code class="n">Optional</code><code class="calibre17">[</code><code class="n">PyLinter</code><code class="calibre17">]</code> <code class="calibre17">=</code> <code class="nb">None</code><code class="calibre17">):</code>
        <code class="nb">super</code><code class="calibre17">(</code><code class="n">ReadyToServeHotDogChecker</code><code class="calibre17">,</code> <code class="nb">self</code><code class="calibre17">)</code><code class="calibre17">.</code><code class="calibre17">__init__</code><code class="calibre17">(</code><code class="n">linter</code><code class="calibre17">)</code>
        <code class="nb">self</code><code class="calibre17">.</code><code class="n">_is_in_prepare_for_serving</code> <code class="calibre17">=</code> <code class="nb">False</code>

    <code class="k">def</code> <code class="nf">visit_functiondef</code><code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">,</code> <code class="n">node</code><code class="calibre17">:</code> <code class="n">astroid</code><code class="calibre17">.</code><code class="n">scoped_nodes</code><code class="calibre17">.</code><code class="n">FunctionDef</code><code class="calibre17">):</code>
        <code class="k">if</code> <code class="calibre17">(</code><code class="n">node</code><code class="calibre17">.</code><code class="n">name</code> <code class="calibre17">==</code> <code class="s">"prepare_for_serving"</code> <code class="calibre19">and</code>
            <code class="n">node</code><code class="calibre17">.</code><code class="n">parent</code><code class="calibre17">.</code><code class="n">name</code> <code class="calibre17">==</code><code class="s">"hotdog"</code> <code class="calibre19">and</code>
            <code class="nb">isinstance</code><code class="calibre17">(</code><code class="n">node</code><code class="calibre17">.</code><code class="n">parent</code><code class="calibre17">,</code> <code class="n">astroid</code><code class="calibre17">.</code><code class="n">scoped_nodes</code><code class="calibre17">.</code><code class="n">Module</code><code class="calibre17">)):</code>
                <code class="nb">self</code><code class="calibre17">.</code><code class="n">_is_in_prepare_for_serving</code> <code class="calibre17">=</code> <code class="nb">True</code>

    <code class="k">def</code> <code class="nf">leave_functiondef</code><code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">,</code> <code class="n">node</code><code class="calibre17">:</code> <code class="n">astroid</code><code class="calibre17">.</code><code class="n">scoped_nodes</code><code class="calibre17">.</code><code class="n">FunctionDef</code><code class="calibre17">):</code>
        <code class="k">if</code> <code class="calibre17">(</code><code class="n">node</code><code class="calibre17">.</code><code class="n">name</code> <code class="calibre17">==</code> <code class="s">"prepare_for_serving"</code> <code class="calibre19">and</code>
            <code class="n">node</code><code class="calibre17">.</code><code class="n">parent</code><code class="calibre17">.</code><code class="n">name</code> <code class="calibre17">==</code><code class="s">"hotdog"</code> <code class="calibre19">and</code>
            <code class="nb">isinstance</code><code class="calibre17">(</code><code class="n">node</code><code class="calibre17">.</code><code class="n">parent</code><code class="calibre17">,</code> <code class="n">astroid</code><code class="calibre17">.</code><code class="n">scoped_nodes</code><code class="calibre17">.</code><code class="n">Module</code><code class="calibre17">)):</code>

            <code class="nb">self</code><code class="calibre17">.</code><code class="n">_is_in_prepare_for_serving</code> <code class="calibre17">=</code> <code class="nb">False</code></pre>

<p class="author1">In this case, I’ve defined a constructor to save a member variable to track if I’m in the right function. I’ve also defined two functions, <code class="calibre17">visit_functiondef</code> and <code class="calibre17">leave_functiondef</code>. <code class="calibre17">visit_functiondef</code> will get called whenever <code class="calibre17">astroid</code> parses a function <span class="calibre">definition</span>, and <code class="calibre17">leave_functiondef</code> is called whenever the parser stops parsing a function definition. So when the parser encounters a function, I check to see if that function is named <code class="calibre17">prepare_for_serving</code>, which is inside a module called <code class="calibre17">hotdog</code>.</p>

<p class="author1">Now that I have a member variable to track if I’m in the right function or not, I can write another <code class="calibre17">astroid</code> hook to get called whenever a function is called (such as <code class="calibre17">ReadyToServeHotDog(hot_dog)</code>).</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35">    <code class="k">def</code> <code class="nf">visit_call</code><code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">,</code> <code class="n">node</code><code class="calibre17">:</code> <code class="n">astroid</code><code class="calibre17">.</code><code class="n">node_classes</code><code class="calibre17">.</code><code class="n">Call</code><code class="calibre17">):</code>
        <code class="k">if</code> <code class="n">node</code><code class="calibre17">.</code><code class="n">func</code><code class="calibre17">.</code><code class="n">name</code> <code class="calibre17">!=</code> <code class="s">'ReadyToServeHotDog'</code><code class="calibre17">:</code>
            <code class="k">return</code>

        <code class="k">if</code> <code class="nb">self</code><code class="calibre17">.</code><code class="n">_is_in_prepare_for_serving</code><code class="calibre17">:</code>
            <code class="k">return</code>

        <code class="nb">self</code><code class="calibre17">.</code><code class="n">add_message</code><code class="calibre17">(</code>
            <code class="s">'unverified-ready-to-serve-hotdog'</code><code class="calibre17">,</code> <code class="n">node</code><code class="calibre17">=</code><code class="n">node</code><code class="calibre17">,</code>
        <code class="calibre17">)</code></pre>

<p class="author1">If the function call is not <code class="calibre17">ReadyToServeHotDog</code> or if the execution is in <code class="calibre17">prepare_serving</code>, this checker sees no issue and returns early. If the function call is <code class="calibre17">ReadyToServeHotDog</code> and the execution is not in <code class="calibre17">prepare_serving</code>, the checker fails and adds a message to indicate an <code class="calibre17">unverified-ready-to-serve-hotdog</code> check failure. By adding a message, Pylint will pass this on to the user and flag it as a failed check.</p>

<p class="author1">Lastly, I need to register the linter:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35">    <code class="k">def</code> <code class="nf">register</code><code class="calibre17">(</code><code class="n">linter</code><code class="calibre17">:</code> <code class="n">PyLinter</code><code class="calibre17">):</code>
        <code class="n">linter</code><code class="calibre17">.</code><code class="n">register_checker</code><code class="calibre17">(</code><code class="n">ReadyToServeHotDogChecker</code><code class="calibre17">(</code><code class="n">linter</code><code class="calibre17">))</code></pre>

<p class="author1">And that’s it! With about 45 lines of Python, I have defined a Pylint plug-in. This was a simple checker, but your imagination is the limit for what you can do. Pylint checks, either built-in or user created, are invaluable for finding errors.</p>
</div></section>





</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 20. Static Analysis" class="preface">
<div class="preface" id="static_analysis">
<section data-type="sect1" data-pdf-bookmark="Linting" class="preface">
<div class="preface" id="idm45644728707560">
<section data-type="sect2" data-pdf-bookmark="Breaking Down the Plug-in" class="preface">
<div class="preface" id="idm45644728581048">
<div data-type="note" epub:type="note" class="calibre21"><h1 class="calibre38" id="calibre_pb_4">Discussion Topic</h1>
<p class="author1">What checkers can you create in your codebase? What error cases can you catch with the use of these checkers?<a data-type="indexterm" data-primary="static analysis" data-secondary="linting" data-tertiary="writing your own Pylint plug-in" data-startref="ix_statanlntwr" id="idm45644727822072" class="calibre5"/><a data-type="indexterm" data-primary="Pylint" data-secondary="writing your own plug-in" data-tertiary="breaking down the plug-in" data-startref="ix_Pylntwrbrk" id="idm45644727734936" class="calibre5"/><a data-type="indexterm" data-primary="linting" data-secondary="writing your own Pylint plug-in" data-tertiary="breaking down the plug-in" data-startref="ix_lntwrbrk" id="idm45644727733464" class="calibre5"/><a data-type="indexterm" data-primary="linting" data-secondary="writing your own Pylint plug-in" data-startref="ix_lntwr" id="idm45644727731944" class="calibre5"/><a data-type="indexterm" data-primary="Pylint" data-secondary="writing your own plug-in" data-startref="ix_Pylntwr" id="idm45644727730712" class="calibre5"/><a data-type="indexterm" data-primary="Pylint" data-startref="ix_Pylnt" id="idm45644727815848" class="calibre5"/><a data-type="indexterm" data-primary="linting" data-startref="ix_lnt" id="idm45644727814904" class="calibre5"/><a data-type="indexterm" data-primary="static analysis" data-secondary="linting" data-startref="ix_statanlnt" id="idm45644727813960" class="calibre5"/></p>
</div>
</div></section>





</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 20. Static Analysis" class="preface">
<div class="preface" id="static_analysis">
<section data-type="sect1" data-pdf-bookmark="Other Static Analyzers" class="preface"><div class="preface" id="idm45644728707064">
<h1 class="calibre12" id="calibre_pb_5">Other Static Analyzers</h1>

<p class="author1">Typecheckers and linters are often the first things people <a data-type="indexterm" data-primary="static analysis" data-secondary="other analyzers" id="ix_statanoth" class="calibre5"/>think of when they hear “static analysis,” but there are so many additional tools that can help you write robust code.  Each tool acts as a separate line of defense, all stacked together, to protect your codebase. Think about each tool as a piece of Swiss cheese.<sup class="calibre11"><a data-type="noteref" id="idm45644727809592-marker" href="part0026_split_008.html#idm45644727809592" class="calibre5">1</a></sup> Each individual piece of Swiss cheese has holes of various widths or sizes, but when multiple pieces are stacked together, it is unlikely that there is an area where all holes align and you can see through the stack.</p>

<p class="author1">Likewise, each tool you use to build a safety net will miss certain errors. Typecheckers won’t catch common programming mistakes, linters won’t check security violations, security checkers won’t catch complex code, and so on. But when these tools are stacked together, it’s much less likely for a legitimate error to squeak by (and for those that do, that’s why you have tests). As Bruce MacLennan says, “Have a series of defenses so that if an error is not caught by one, it will probably be caught by another.”<sup class="calibre11"><a data-type="noteref" id="idm45644727806264-marker" href="part0026_split_008.html#idm45644727806264" class="calibre5">2</a></sup></p>








</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 20. Static Analysis" class="preface">
<div class="preface" id="static_analysis">
<section data-type="sect1" data-pdf-bookmark="Other Static Analyzers" class="preface">
<div class="preface" id="idm45644728707064">
<section data-type="sect2" data-pdf-bookmark="Complexity Checkers" class="preface"><div class="preface" id="idm45644727804360">
<h2 class="calibre34" id="calibre_pb_6">Complexity Checkers</h2>

<p class="author1">Most of this book has been centered on readable and maintainable code.<a data-type="indexterm" data-primary="static analysis" data-secondary="other analyzers" data-tertiary="complexity checkers" id="ix_statanothCC" class="calibre5"/><a data-type="indexterm" data-primary="complexity checkers" id="ix_cmplck" class="calibre5"/> I’ve talked about how complex code impacts the speed of feature development. It’d be nice for a tool to indicate which parts of your codebase have high complexity. Unfortunately, complexity is subjective and reducing complexity will not always reduce errors. I can, however, treat complexity measures as a <em class="calibre6">heuristic</em>. <a data-type="indexterm" data-primary="heuristics" id="idm45644727799768" class="calibre5"/>A heuristic is something that provides an answer, but offers no guarantee that it is an optimal answer. In this case, the question is, “Where can I find the most bugs in my code?” Most of the time, it will be in code with high complexity, but remember that this is not a guarantee.</p>










<section data-type="sect3" data-pdf-bookmark="Cyclomatic complexity with mccabe" class="preface"><div class="preface" id="idm45644727713864">
<h3 class="calibre44">Cyclomatic complexity with mccabe</h3>

<p class="author1">One of the most popular complexity<a data-type="indexterm" data-primary="cyclomatic complexity" id="ix_cycco" class="calibre5"/><a data-type="indexterm" data-primary="complexity checkers" data-secondary="cyclomatic complexity with mccabe tool" id="idm45644727711224" class="calibre5"/> heuristics is known as <em class="calibre6">cyclomatic complexity</em>, first described by Thomas McCabe.<sup class="calibre11"><a data-type="noteref" id="idm45644727709720-marker" href="part0026_split_008.html#idm45644727709720" class="calibre5">3</a></sup> To measure code’s cyclomatic complexity, you must view your code as a  <em class="calibre6">control flow graph</em>, or a graph that maps out the different paths<a data-type="indexterm" data-primary="control flow graph" id="idm45644727706824" class="calibre5"/> of execution your code can take. <a data-type="xref" href="part0026_split_006.html#cyclomatic" class="calibre5">Figure 20-1</a> shows you a few different <span class="calibre">examples</span>.</p>

<figure class="calibre36"><div id="cyclomatic" class="figure">
<img src="../images/00038.gif" alt="ropy 2001" class="calibre40"/>
<h6 class="calibre37"><span class="calibre">Figure 20-1. </span>Cyclomatic complexity examples</h6>
</div></figure>

<p class="author1">Section A of <a data-type="xref" href="part0026_split_006.html#cyclomatic" class="calibre5">Figure 20-1</a> demonstrates a linear flow of statements, which has a complexity of one. An <code class="calibre17">if</code> with no <code class="calibre17">elif</code> statement, as shown in Section B of <a data-type="xref" href="part0026_split_006.html#cyclomatic" class="calibre5">Figure 20-1</a>, has two paths (<code class="calibre17">if</code> or <code class="calibre17">else</code>/fall-through), so the complexity is two. Similarly a <code class="calibre17">while</code> loop, like in Section C of <a data-type="xref" href="part0026_split_006.html#cyclomatic" class="calibre5">Figure 20-1</a>, has two separate paths: either the loop continues or exits. As the code gets more complex, the cyclomatic complexity number gets higher.</p>

<p class="author1">You can <a data-type="indexterm" data-primary="mccabe tool, measuring cyclomatic complexity with" id="idm45644727696792" class="calibre5"/>use a static analysis tool in Python to measure cyclomatic complexity, aptly named <code class="calibre17">mccabe</code>.</p>

<p class="author1">I’ll install it with <code class="calibre17">pip</code>:</p>

<pre data-type="programlisting" class="calibre35">pip install mccabe</pre>

<p class="author1">To test it out, I’ll run it on the <code class="calibre17">mccabe</code> codebase itself and flag any function that has a cyclomatic complexity greater than or equal to five:</p>

<pre data-type="programlisting" class="calibre35">python -m mccabe --min 5 mccabe.py
192:4: 'PathGraphingAstVisitor._subgraph_parse' 5
273:0: 'get_code_complexity' 5
298:0: '_read' 5
315:0: 'main' 7</pre>

<p class="author1">Let’ take a look at <code class="calibre17">PathGraphingAstVisitor._subgraph_parse</code>:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="k">def</code> <code class="nf">_subgraph_parse</code><code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">,</code> <code class="n">node</code><code class="calibre17">,</code> <code class="n">pathnode</code><code class="calibre17">,</code> <code class="n">extra_blocks</code><code class="calibre17">):</code>
       <code class="sd">"""parse the body and any `else` block of `if` and `for` statements"""</code>
       <code class="n">loose_ends</code> <code class="calibre17">=</code> <code class="calibre17">[]</code>
       <code class="nb">self</code><code class="calibre17">.</code><code class="n">tail</code> <code class="calibre17">=</code> <code class="n">pathnode</code>
       <code class="nb">self</code><code class="calibre17">.</code><code class="n">dispatch_list</code><code class="calibre17">(</code><code class="n">node</code><code class="calibre17">.</code><code class="n">body</code><code class="calibre17">)</code>
       <code class="n">loose_ends</code><code class="calibre17">.</code><code class="n">append</code><code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">.</code><code class="n">tail</code><code class="calibre17">)</code>
       <code class="k">for</code> <code class="n">extra</code> <code class="calibre19">in</code> <code class="n">extra_blocks</code><code class="calibre17">:</code>
           <code class="nb">self</code><code class="calibre17">.</code><code class="n">tail</code> <code class="calibre17">=</code> <code class="n">pathnode</code>
           <code class="nb">self</code><code class="calibre17">.</code><code class="n">dispatch_list</code><code class="calibre17">(</code><code class="n">extra</code><code class="calibre17">.</code><code class="n">body</code><code class="calibre17">)</code>
           <code class="n">loose_ends</code><code class="calibre17">.</code><code class="n">append</code><code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">.</code><code class="n">tail</code><code class="calibre17">)</code>
       <code class="k">if</code> <code class="n">node</code><code class="calibre17">.</code><code class="n">orelse</code><code class="calibre17">:</code>
           <code class="nb">self</code><code class="calibre17">.</code><code class="n">tail</code> <code class="calibre17">=</code> <code class="n">pathnode</code>
           <code class="nb">self</code><code class="calibre17">.</code><code class="n">dispatch_list</code><code class="calibre17">(</code><code class="n">node</code><code class="calibre17">.</code><code class="n">orelse</code><code class="calibre17">)</code>
           <code class="n">loose_ends</code><code class="calibre17">.</code><code class="n">append</code><code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">.</code><code class="n">tail</code><code class="calibre17">)</code>
       <code class="k">else</code><code class="calibre17">:</code>
           <code class="n">loose_ends</code><code class="calibre17">.</code><code class="n">append</code><code class="calibre17">(</code><code class="n">pathnode</code><code class="calibre17">)</code>
       <code class="k">if</code> <code class="n">pathnode</code><code class="calibre17">:</code>
           <code class="n">bottom</code> <code class="calibre17">=</code> <code class="n">PathNode</code><code class="calibre17">(</code><code class="s">""</code><code class="calibre17">,</code> <code class="n">look</code><code class="calibre17">=</code><code class="s">'point'</code><code class="calibre17">)</code>
           <code class="k">for</code> <code class="n">le</code> <code class="calibre19">in</code> <code class="n">loose_ends</code><code class="calibre17">:</code>
               <code class="nb">self</code><code class="calibre17">.</code><code class="n">graph</code><code class="calibre17">.</code><code class="n">connect</code><code class="calibre17">(</code><code class="n">le</code><code class="calibre17">,</code> <code class="n">bottom</code><code class="calibre17">)</code>
           <code class="nb">self</code><code class="calibre17">.</code><code class="n">tail</code> <code class="calibre17">=</code> <code class="n">bottom</code></pre>

<p class="author1">There are a few things going on in this function: various conditional branches, loops, and even a loop nested in an <code class="calibre17">if</code> statement. Each of these paths is independent and needs to be tested for. As cyclomatic complexity grows, code gets harder to read and harder to reason about. There is no magic number for cyclomatic complexity; you will need to inspect your codebase and look for a suitable limit.<a data-type="indexterm" data-primary="cyclomatic complexity" data-startref="ix_cycco" id="idm45644727687576" class="calibre5"/></p>
</div></section>













<section data-type="sect3" data-pdf-bookmark="Whitespace heuristic" class="preface"><div class="preface" id="idm45644727713272">
<h3 class="calibre44">Whitespace heuristic</h3>

<p class="author1">There’s another complexity heuristic that <a data-type="indexterm" data-primary="complexity checkers" data-secondary="whitespace heuristic" id="idm45644727559688" class="calibre5"/><a data-type="indexterm" data-primary="whitespace heuristic" id="idm45644727558712" class="calibre5"/>I am quite fond of that is a bit simpler to reason about than cyclomatic complexity: <a href="https://oreil.ly/i3Dpd" class="calibre5">whitespace checking</a>. The idea is as follows: count how many levels of indentation there are in a single Python file. High levels of indentation indicate nested loops and branches, which may signal complex code.</p>

<p class="author1">Unfortunately, there are no popular tools at the time of writing that handle whitespace heuristics. However, it is easy to write this checker yourself:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="k">def</code> <code class="nf">get_amount_of_preceding_whitespace</code><code class="calibre17">(</code><code class="n">line</code><code class="calibre17">:</code> <code class="nb">str</code><code class="calibre17">)</code> <code class="calibre17">-&gt;</code> <code class="nb">int</code><code class="calibre17">:</code>
    <code class="c"># replace tabs with 4 spaces (and start tab/spaces flame-war)</code>
    <code class="n">tab_normalized_text</code> <code class="calibre17">=</code> <code class="n">line</code><code class="calibre17">.</code><code class="n">replace</code><code class="calibre17">(</code><code class="s">"</code><code class="se">\t</code><code class="s">"</code><code class="calibre17">,</code> <code class="s">"    "</code><code class="calibre17">)</code>
    <code class="k">return</code> <code class="nb">len</code><code class="calibre17">(</code><code class="n">tab_normalized_text</code><code class="calibre17">)</code> <code class="calibre17">-</code> <code class="nb">len</code><code class="calibre17">(</code><code class="n">tab_normalized_text</code><code class="calibre17">.</code><code class="n">lstrip</code><code class="calibre17">())</code>

<code class="k">def</code> <code class="nf">get_average_whitespace</code><code class="calibre17">(</code><code class="n">filename</code><code class="calibre17">:</code> <code class="nb">str</code><code class="calibre17">):</code>
    <code class="k">with</code> <code class="nb">open</code><code class="calibre17">(</code><code class="n">filename</code><code class="calibre17">)</code> <code class="k">as</code> <code class="n">file_to_check</code><code class="calibre17">:</code>
        <code class="n">whitespace_count</code> <code class="calibre17">=</code> <code class="calibre17">[</code><code class="n">get_amount_of_preceding_whitespace</code><code class="calibre17">(</code><code class="n">line</code><code class="calibre17">)</code>
                            <code class="k">for</code> <code class="n">line</code> <code class="calibre19">in</code> <code class="n">file_to_check</code>
                            <code class="k">if</code> <code class="n">line</code> <code class="calibre17">!=</code> <code class="s">""</code><code class="calibre17">]</code>
        <code class="n">average</code> <code class="calibre17">=</code> <code class="nb">sum</code><code class="calibre17">(</code><code class="n">whitespace_count</code><code class="calibre17">)</code> <code class="calibre17">/</code> <code class="nb">len</code><code class="calibre17">(</code><code class="n">whitespace_count</code><code class="calibre17">)</code> <code class="calibre17">/</code> <code class="mi">4</code>
        <code class="k">print</code><code class="calibre17">(</code><code class="n">f</code><code class="s">"Avg indentation level for {filename}: {average}"</code><code class="calibre17">)</code></pre>
<div data-type="note" epub:type="note" class="calibre21"><h6 class="calibre22">Note</h6>
<p class="author1">Another possible measure of whitespace is the “area” of indentation per function, where you sum up all the indentation instead of averaging it. I am leaving this as an exercise for the reader to <span class="calibre">implement</span>.</p>
</div>

<p class="author1">As with cyclomatic complexity, there is no magic number to check for with whitespace complexity. I encourage you to play around in your codebase and determine what an appropriate amount of indentation is.<a data-type="indexterm" data-primary="static analysis" data-secondary="other analyzers" data-tertiary="complexity checkers" data-startref="ix_statanothCC" id="idm45644727328216" class="calibre5"/><a data-type="indexterm" data-primary="complexity checkers" data-startref="ix_cmplck" id="idm45644727511848" class="calibre5"/></p>
</div></section>



</div></section>













</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 20. Static Analysis" class="preface">
<div class="preface" id="static_analysis">
<section data-type="sect1" data-pdf-bookmark="Other Static Analyzers" class="preface">
<div class="preface" id="idm45644728707064">
<section data-type="sect2" data-pdf-bookmark="Security Analysis" class="preface"><div class="preface" id="idm45644727510648">
<h2 class="calibre34" id="calibre_pb_7">Security Analysis</h2>

<p class="author1">Security is difficult to do right, and hardly anyone ever gets lauded for breach prevention.<a data-type="indexterm" data-primary="security" data-secondary="static analysis of" id="ix_secstat" class="calibre5"/><a data-type="indexterm" data-primary="static analysis" data-secondary="other analyzers" data-tertiary="security analysis" id="ix_statanothsec" class="calibre5"/> Instead, it’s the breaches themselves that seem to dominate the news. Every month I hear of another breach or data leak. These breakdowns are incredibly costly to a company, be it from regulatory fines or loss of customer base.</p>

<p class="author1">Every developer needs to be hyperaware of the security of their codebase. You don’t want to hear about how <em class="calibre6">your</em> codebase is the root cause of the latest massive data breach in the news. Thankfully, there are static analysis tools that can prevent common security flaws.</p>










<section data-type="sect3" data-pdf-bookmark="Leaking secrets" class="preface"><div class="preface" id="idm45644727504664">
<h3 class="calibre44">Leaking secrets</h3>

<p class="author1">If you ever<a data-type="indexterm" data-primary="security" data-secondary="static analysis of" data-tertiary="leaking secrets" id="idm45644727503336" class="calibre5"/><a data-type="indexterm" data-primary="leaked secrets, checking for" id="idm45644727502056" class="calibre5"/> want to be terrified, search for the text <code class="calibre17">AWS_SECRET_KEY</code> in your favorite code-hosting tool, like <a href="https://oreil.ly/FEm7D" class="calibre5">GitHub</a>. You will be amazed at how many people commit secret values such as the key that provides access to AWS.<sup class="calibre11"><a data-type="noteref" id="idm45644727499976-marker" href="part0026_split_008.html#idm45644727499976" class="calibre5">4</a></sup></p>

<p class="author1">Once a secret is in a version control system, especially a publicly hosted one, it is very hard to remove traces of it. The organization is forced to revoke any leaked credentials, but they have to do it faster than the troves of hackers trawling repositories for keys. <a data-type="indexterm" data-primary="dodgy, checking for leaked secrets" id="idm45644727497480" class="calibre5"/>To prevent this, use a static analysis tool that specifically looks for leaked secrets, such as <a href="https://github.com/landscapeio/dodgy" class="calibre5">dodgy</a>. If you don’t choose to use a prebuilt tool, at least perform a text search on your codebase to make sure that nobody is leaking common credentials.</p>
</div></section>













<section data-type="sect3" data-pdf-bookmark="Security flaw checking" class="preface"><div class="preface" id="idm45644727495432">
<h3 class="calibre44">Security flaw checking</h3>

<p class="author1">Checking for leaked credentials is one thing, but what about more serious security flaws?<a data-type="indexterm" data-primary="security" data-secondary="static analysis of" data-tertiary="security flaw checking" id="idm45644727493752" class="calibre5"/> How do you find things like SQL injection, arbitrary code execution, or incorrectly configured network settings? When exploited, these sorts of flaws can be <span class="calibre">detrimental</span> to your security profile. But, just like every other problem in this chapter, there is a static analysis tool for handling this: Bandit.</p>

<p class="author1">Bandit checks for common security problems<a data-type="indexterm" data-primary="Bandit" id="idm45644727490968" class="calibre5"/>. You can find a full list in the <a href="https://bandit.readthedocs.io/en/latest" class="calibre5">Bandit documentation</a>, but here is a preview of the sorts of flaws Bandit looks for:</p>

<ul class="printings">
<li class="calibre9">
<p class="author1">Flask in debug mode, which can lead to remote code execution</p>
</li>
<li class="calibre9">
<p class="author1">Making an HTTPS request without certificate validation turned on</p>
</li>
<li class="calibre9">
<p class="author1">Raw SQL statements that have the potential for SQL injection</p>
</li>
<li class="calibre9">
<p class="author1">Weak cryptographic key creation</p>
</li>
<li class="calibre9">
<p class="author1">Flagging untrusted data influencing code paths, such as unsafe YAML loading</p>
</li>
</ul>

<p class="author1">Bandit checks for so many different potential security flaws. I highly recommend running it against your codebase:</p>

<pre data-type="programlisting" class="calibre35">pip install bandit
bandit -r path/to/your/code</pre>

<p class="author1">Bandit also has a robust plug-in system, so that you can augment the flaw detection with your own security checks.</p>
<div data-type="warning" epub:type="warning" class="calibre23"><h6 class="calibre24">Warning</h6>
<p class="author1">While security-oriented static analyzers are very useful, do not make them your only line of defense. Supplement these tools by continuing additional security practices (such as conducting audits, running penetration tests, and securing your networks).<a data-type="indexterm" data-primary="static analysis" data-secondary="other analyzers" data-tertiary="security analysis" data-startref="ix_statanothsec" id="idm45644727481432" class="calibre5"/><a data-type="indexterm" data-primary="security" data-secondary="static analysis of" data-startref="ix_secstat" id="idm45644727479912" class="calibre5"/><a data-type="indexterm" data-primary="static analysis" data-secondary="other analyzers" data-startref="ix_statanoth" id="idm45644727478696" class="calibre5"/></p>
</div>
</div></section>



</div></section>





</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 20. Static Analysis" class="preface">
<div class="preface" id="static_analysis">
<section data-type="sect1" data-pdf-bookmark="Closing Thoughts" class="preface"><div class="preface" id="idm45644727477224">
<h1 class="calibre12" id="calibre_pb_8">Closing Thoughts</h1>

<p class="author1">Catching errors early saves you time and money. Your goal is to find errors as you develop code. Static analysis tools are your friends in this endeavor. They are a cheap, quick way to find any problems in your codebase. There are a variety of static analyzers to meet your needs: linters, security checkers, and complexity checkers. Each has its own purpose and provides a layer of defense. And for the errors that these tools don’t catch, you extend the static analyzers through the use of a plug-in system.</p>

<p class="author1">While static analyzers are your first line of defense, they are not your only line. For the rest of the book, I will focus on tests. The next chapter will focus on your testing strategy. I’ll walk through how you need to organize your tests, as well as the best practices surrounding writing tests. You’ll learn how to write a testing triangle, how to ask the right questions around testing, and how to write effective developer tests.<a data-type="indexterm" data-primary="static analysis" data-startref="ix_statan" id="idm45644727474536" class="calibre5"/></p>
</div></section>







<div data-type="footnotes" class="calibre25"><p data-type="footnote" id="idm45644727809592" class="calibre26"><sup class="calibre27"><a href="part0026_split_005.html#idm45644727809592-marker" class="calibre5">1</a></sup> J. Reason. “Human Error: Models and Management.” <em class="calibre6">BMJ</em> 320, no. 7237 (2000): 768–70. <a href="https://doi.org/10.1136/bmj.320.7237.768" class="calibre5"><em class="calibre6">https://doi.org/10.1136/bmj.320.7237.768</em></a>.</p><p data-type="footnote" id="idm45644727806264" class="calibre26"><sup class="calibre27"><a href="part0026_split_005.html#idm45644727806264-marker" class="calibre5">2</a></sup> Bruce MacLennan. “Principles of Programming Language Design.” web.eecs.utk.edu, September 10, 1998. <a href="https://oreil.ly/hrjdR" class="calibre5"><em class="calibre6">https://oreil.ly/hrjdR</em></a>.</p><p data-type="footnote" id="idm45644727709720" class="calibre26"><sup class="calibre27"><a href="part0026_split_006.html#idm45644727709720-marker" class="calibre5">3</a></sup> T.J. McCabe. “A Complexity Measure.” <em class="calibre6">IEEE Transactions on Software Engineering</em> SE-2, no. 4 (December 1976): 308–20. <a href="https://doi.org/10.1109/tse.1976.233837" class="calibre5"><em class="calibre6">https://doi.org/10.1109/tse.1976.233837</em></a>.</p><p data-type="footnote" id="idm45644727499976" class="calibre26"><sup class="calibre27"><a href="part0026_split_007.html#idm45644727499976-marker" class="calibre5">4</a></sup> There are real-world implications to this. A quick search on the internet turns up tons of articles detailing this problem, such as <a href="https://oreil.ly/gimse" class="calibre5"><em class="calibre6">https://oreil.ly/gimse</em></a>.</p></div></div></section></body></html>