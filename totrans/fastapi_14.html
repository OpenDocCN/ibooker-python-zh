<html><head></head><body><section data-pdf-bookmark="Chapter 11. Authentication and Authorization" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch11">&#13;
<h1><span class="label">Chapter 11. </span>Authentication and Authorization</h1>&#13;
&#13;
<blockquote>&#13;
<p>Respect mah authoritay!</p>&#13;
<p data-type="attribution">Eric Cartman, <cite><em>South Park</em></cite></p>&#13;
</blockquote>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Preview" data-type="sect1"><div class="sect1" id="id313">&#13;
<h1>Preview</h1>&#13;
&#13;
<p>Sometimes a website is wide open,&#13;
and any visitor can visit any page.&#13;
But if any of the site’s content may be modified,&#13;
some endpoints will be restricted to certain people or groups.&#13;
If anyone could alter pages on Amazon,&#13;
imagine the odd items that would show up,&#13;
and the amazing sales some people would suddenly get.&#13;
Unfortunately, it’s human nature—for some humans—to take advantage of the rest, who pay a hidden tax for their activities.</p>&#13;
&#13;
<p>Should we leave our cryptid site open for any users&#13;
to access any endpoint?&#13;
No!&#13;
Almost any sizable web service eventually needs to deal with the following:</p>&#13;
<dl>&#13;
<dt>Authentication (authn)</dt>&#13;
<dd>&#13;
<p>Who are you?</p>&#13;
</dd>&#13;
<dt>Authorization (authz)</dt>&#13;
<dd>&#13;
<p>What do you want?</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>Should the authentication and authorization (auth) code have its own new layer, say between Web and Service?&#13;
Or should everything be handled by the Web or Service layer itself?&#13;
This chapter dips into auth techniques and&#13;
where to put them.</p>&#13;
&#13;
<p>Often&#13;
descriptions of web security&#13;
seem more confusing than they need to be.&#13;
Attackers can be really, really sneaky,&#13;
and countermeasures may not be simple.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>As I’ve mentioned more than once,&#13;
the official FastAPI documentation is excellent.&#13;
Try the&#13;
<a href="https://oreil.ly/oYsKl">Security section</a> if this chapter&#13;
doesn’t provide as many details as you’d like.</p>&#13;
</div>&#13;
&#13;
<p>So, let’s take this walk-through in steps.&#13;
I’ll start with simple techniques that are intended&#13;
to only hook auth into a web endpoint for testing,&#13;
but would not stand up in a public website.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Interlude 1: Do You Need Authentication?" data-type="sect1"><div class="sect1" id="id208">&#13;
<h1>Interlude 1: Do You Need Authentication?</h1>&#13;
&#13;
<p><a data-primary="authentication" data-secondary="implementing" data-type="indexterm" id="id693"/>Again,&#13;
<em>authentication</em> is concerned with <em>identity</em>:&#13;
who are you?&#13;
To implement authentication,&#13;
we need a mapping of secret information&#13;
to a unique identity.&#13;
There are many ways to do this, with&#13;
<em>many</em> variations of complexity.&#13;
Let’s start small and work up.</p>&#13;
&#13;
<p>Often books and articles on web development&#13;
jump right away into the details of&#13;
authentication and authorization,&#13;
sometimes muddling them.&#13;
They sometimes skip the first question:&#13;
do you really need either?</p>&#13;
&#13;
<p>You could allow completely anonymous access to all your&#13;
website’s pages.&#13;
But that would leave you open to&#13;
exploits like denial-of-service attacks.&#13;
Although some protections like rate limits&#13;
can be implemented outside the web&#13;
server (see <a data-type="xref" href="ch13.html#ch13">Chapter 13</a>),&#13;
almost all public API&#13;
providers require at least some authentication.</p>&#13;
&#13;
<p>Beyond security, we want to know how effective websites are:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>How many unique visitors?</p>&#13;
</li>&#13;
<li>&#13;
<p>What are the most popular pages?</p>&#13;
</li>&#13;
<li>&#13;
<p>Do some changes increase views?</p>&#13;
</li>&#13;
<li>&#13;
<p>What page sequences are common?</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The answers to these questions require authentication of specific visitors.&#13;
Otherwise, you can get only total counts.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>If your site needs authentication or authorization, access to it should be encrypted (using HTTPS instead of HTTP),&#13;
to prevent attackers from extracting secret data&#13;
from plain text.&#13;
See <a data-type="xref" href="ch13.html#ch13">Chapter 13</a> for&#13;
details on setting up HTTPS.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before less_space" data-pdf-bookmark="Authentication Methods" data-type="sect1"><div class="sect1" id="id209">&#13;
<h1>Authentication Methods</h1>&#13;
&#13;
<p><a data-primary="authentication" data-secondary="methods" data-type="indexterm" id="id694"/>There are many web authentication methods and tools:</p>&#13;
<dl>&#13;
<dt>Username/email and password</dt>&#13;
<dd>&#13;
<p>Using classic HTTP Basic and Digest Authentication</p>&#13;
</dd>&#13;
<dt>API key</dt>&#13;
<dd>&#13;
<p>An opaque long string with an accompanying <em>secret</em></p>&#13;
</dd>&#13;
<dt>OAuth2</dt>&#13;
<dd>&#13;
<p>A set of standards for authentication and authorization</p>&#13;
</dd>&#13;
<dt>JavaScript Web Tokens (JWT)</dt>&#13;
<dd>&#13;
<p>An encoding format containing&#13;
cryptographically signed user information</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>In this section,&#13;
I’ll review the first two methods and show you how to traditionally implement them.&#13;
But I’ll stop before filling out the API and&#13;
database code.&#13;
Instead, we’ll&#13;
fully implement a more modern scheme with OAuth2 and JWT.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Global Authentication: Shared Secret" data-type="sect1"><div class="sect1" id="id91">&#13;
<h1>Global Authentication: Shared Secret</h1>&#13;
&#13;
<p><a data-primary="authentication" data-secondary="global" data-type="indexterm" id="ibd065"/>The <a data-primary="global authentication" data-type="indexterm" id="ibd073"/>very simplest authentication method is to pass a secret that’s&#13;
normally known only by the web server.&#13;
If it matches, you’re in.&#13;
This isn’t safe if your API site is exposed to the public&#13;
with HTTP instead of HTTPS.&#13;
If it’s hidden behind a frontend site that is itself open,&#13;
the frontends and backends could communicate&#13;
using a shared constant secret.&#13;
But if your frontend site is hacked,&#13;
then darn.&#13;
Let’s see how FastAPI handles simple authentication.</p>&#13;
&#13;
<p>Make a new top-level file called <em>auth.py</em>.&#13;
Check that you don’t have another FastAPI server&#13;
still running from one of those ever-changing&#13;
<em>main.py</em> files from previous chapters.&#13;
<a data-type="xref" href="#ex-11-1">Example 11-1</a> implements a server that&#13;
just returns whatever <code>username</code> and <code>password</code>&#13;
were sent to it using&#13;
HTTP Basic Authentication—a method from the original days of the web.</p>&#13;
<div data-type="example" id="ex-11-1">&#13;
<h5><span class="label">Example 11-1. </span>Use HTTP Basic Auth to get user info: <span class="plain">auth.py</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">uvicorn</code>&#13;
<code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">Depends</code><code class="p">,</code> <code class="n">FastAPI</code>&#13;
<code class="kn">from</code> <code class="nn">fastapi.security</code> <code class="kn">import</code> <code class="n">HTTPBasic</code><code class="p">,</code> <code class="n">HTTPBasicCredentials</code>&#13;
&#13;
<code class="n">app</code> <code class="o">=</code> <code class="n">FastAPI</code><code class="p">()</code>&#13;
&#13;
<code class="n">basic</code> <code class="o">=</code> <code class="n">HTTPBasic</code><code class="p">()</code>&#13;
&#13;
<code class="nd">@app</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/who"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">get_user</code><code class="p">(</code>&#13;
    <code class="n">creds</code><code class="p">:</code> <code class="n">HTTPBasicCredentials</code> <code class="o">=</code> <code class="n">Depends</code><code class="p">(</code><code class="n">basic</code><code class="p">)):</code>&#13;
    <code class="k">return</code> <code class="p">{</code><code class="s2">"username"</code><code class="p">:</code> <code class="n">creds</code><code class="o">.</code><code class="n">username</code><code class="p">,</code> <code class="s2">"password"</code><code class="p">:</code> <code class="n">creds</code><code class="o">.</code><code class="n">password</code><code class="p">}</code>&#13;
&#13;
<code class="k">if</code> <code class="vm">__name__</code> <code class="o">==</code> <code class="s2">"__main__"</code><code class="p">:</code>&#13;
    <code class="n">uvicorn</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="s2">"auth:app"</code><code class="p">,</code> <code class="n">reload</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>In <a data-type="xref" href="#ex-11-2">Example 11-2</a>,&#13;
tell HTTPie to make this Basic Auth request&#13;
(this requires&#13;
the arguments <code>-a</code> <em><code>name:password</code></em>).&#13;
Here, let’s use the name <code>me</code> and the password <code>secret</code>.</p>&#13;
<div data-type="example" id="ex-11-2">&#13;
<h5><span class="label">Example 11-2. </span>Test with HTTPie</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http -q -a me:secret localhost:8000/who</strong>&#13;
{&#13;
    "password": "secret",&#13;
    "username": "me"&#13;
}</pre></div>&#13;
&#13;
<p>Testing with the Requests package in <a data-type="xref" href="#ex-11-3">Example 11-3</a> is similar,&#13;
using the <code>auth</code> <span class="keep-together">parameter</span>.</p>&#13;
<div data-type="example" id="ex-11-3">&#13;
<h5><span class="label">Example 11-3. </span>Test with Requests</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="o">&gt;&gt;&gt;</code> <code class="kn">import</code> <code class="nn">requests</code>&#13;
<code class="o">&gt;&gt;&gt;</code> <code class="n">r</code> <code class="o">=</code> <code class="n">requests</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"http://localhost:8000/who"</code><code class="p">,</code>&#13;
    <code class="n">auth</code><code class="o">=</code><code class="p">(</code><code class="s2">"me"</code><code class="p">,</code> <code class="s2">"secret"</code><code class="p">))</code>&#13;
<code class="o">&gt;&gt;&gt;</code> <code class="n">r</code><code class="o">.</code><code class="n">json</code><code class="p">()</code>&#13;
<code class="p">{</code><code class="s1">'username'</code><code class="p">:</code> <code class="s1">'me'</code><code class="p">,</code> <code class="s1">'password'</code><code class="p">:</code> <code class="s1">'secret'</code><code class="p">}</code></pre></div>&#13;
&#13;
<p>You can also test <a data-type="xref" href="#ex-11-1">Example 11-1</a> with the automatic docs page (<em>http://localhost:8000/docs</em>),&#13;
shown in <a data-type="xref" href="#fig-docs-1">Figure 11-1</a>.</p>&#13;
&#13;
<figure><div class="figure" id="fig-docs-1">&#13;
<img alt="fapi 1101" src="assets/fapi_1101.png"/>&#13;
<h6><span class="label">Figure 11-1. </span>Docs page for simple authentication</h6>&#13;
</div></figure>&#13;
&#13;
<p>Click that down arrow on the right,&#13;
then the Try It Out button,&#13;
and then the Execute button.&#13;
You’ll see a form requesting the username and password.&#13;
Type anything.&#13;
The documentation form will hit that server endpoint and show those values&#13;
in the response.</p>&#13;
&#13;
<p>These tests show that you can get a username and password&#13;
to the server and back&#13;
(although none of these actually checked anything).&#13;
Something in the server needs to verify that this name and password&#13;
match the approved values.&#13;
So, in <a data-type="xref" href="#ex-11-4">Example 11-4</a>,&#13;
I’ll include a single secret username and password in the web server.&#13;
The username and password that you pass in now needs to match them&#13;
(each is a <em>shared secret</em>),&#13;
or you’ll get an exception.&#13;
The HTTP status code <code>401</code> is officially called <code>Unauthorized</code>,&#13;
but it really means <em>unauthenticated</em>.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Instead of memorizing all the HTTP status codes,&#13;
you can import FastAPI’s status module&#13;
(which itself is imported directly from Starlette).&#13;
So you can use the more explanatory&#13;
<code>sta⁠tus_code=​HTTP_401_UNAUTHORIZED</code> in <a data-type="xref" href="#ex-11-4">Example 11-4</a> instead of&#13;
a plain <code>sta⁠tus_​code=401</code>.</p>&#13;
</div>&#13;
<div data-type="example" id="ex-11-4">&#13;
<h5><span class="label">Example 11-4. </span>Add a secret username and password to <span class="plain">auth.py</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">uvicorn</code>&#13;
<code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">Depends</code><code class="p">,</code> <code class="n">FastAPI</code><code class="p">,</code> <code class="n">HTTPException</code>&#13;
<code class="kn">from</code> <code class="nn">fastapi.security</code> <code class="kn">import</code> <code class="n">HTTPBasic</code><code class="p">,</code> <code class="n">HTTPBasicCredentials</code>&#13;
&#13;
<code class="n">app</code> <code class="o">=</code> <code class="n">FastAPI</code><code class="p">()</code>&#13;
&#13;
<code class="n">secret_user</code><code class="p">:</code> <code class="nb">str</code> <code class="o">=</code> <code class="s2">"newphone"</code>&#13;
<code class="n">secret_password</code><code class="p">:</code> <code class="nb">str</code> <code class="o">=</code> <code class="s2">"whodis?"</code>&#13;
&#13;
<code class="n">basic</code><code class="p">:</code> <code class="n">HTTPBasicCredentials</code> <code class="o">=</code> <code class="n">HTTPBasic</code><code class="p">()</code>&#13;
&#13;
<code class="nd">@app</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/who"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">get_user</code><code class="p">(</code>&#13;
    <code class="n">creds</code><code class="p">:</code> <code class="n">HTTPBasicCredentials</code> <code class="o">=</code> <code class="n">Depends</code><code class="p">(</code><code class="n">basic</code><code class="p">))</code> <code class="o">-&gt;</code> <code class="nb">dict</code><code class="p">:</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="n">creds</code><code class="o">.</code><code class="n">username</code> <code class="o">==</code> <code class="n">secret_user</code> <code class="ow">and</code>&#13;
        <code class="n">creds</code><code class="o">.</code><code class="n">password</code> <code class="o">==</code> <code class="n">secret_password</code><code class="p">):</code>&#13;
        <code class="k">return</code> <code class="p">{</code><code class="s2">"username"</code><code class="p">:</code> <code class="n">creds</code><code class="o">.</code><code class="n">username</code><code class="p">,</code>&#13;
            <code class="s2">"password"</code><code class="p">:</code> <code class="n">creds</code><code class="o">.</code><code class="n">password</code><code class="p">}</code>&#13;
    <code class="k">raise</code> <code class="n">HTTPException</code><code class="p">(</code><code class="n">status_code</code><code class="o">=</code><code class="mi">401</code><code class="p">,</code> <code class="n">detail</code><code class="o">=</code><code class="s2">"Hey!"</code><code class="p">)</code>&#13;
&#13;
<code class="k">if</code> <code class="vm">__name__</code> <code class="o">==</code> <code class="s2">"__main__"</code><code class="p">:</code>&#13;
    <code class="n">uvicorn</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="s2">"auth:app"</code><code class="p">,</code> <code class="n">reload</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>Misguessing the username and password will earn a mild <code>401</code>&#13;
rebuke&#13;
in <a data-type="xref" href="#ex-11-5">Example 11-5</a>.</p>&#13;
<div data-type="example" id="ex-11-5">&#13;
<h5><span class="label">Example 11-5. </span>Test with HTTPie and a mismatched username/password</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http -a me:secret localhost:8000/who</strong>&#13;
HTTP/1.1 401 Unauthorized&#13;
content-length: 17&#13;
content-type: application/json&#13;
date: Fri, 03 Mar 2023 03:25:09 GMT&#13;
server: uvicorn&#13;
&#13;
{&#13;
    "detail": "Hey!"&#13;
}</pre></div>&#13;
&#13;
<p>Using the magic combination returns the username and password, as <a data-primary="global authentication" data-startref="ibd073" data-type="indexterm" id="id695"/>before,&#13;
in<a data-primary="authentication" data-secondary="global" data-startref="ibd065" data-type="indexterm" id="id696"/> <a data-type="xref" href="#ex-11-6">Example 11-6</a>.</p>&#13;
<div data-type="example" id="ex-11-6">&#13;
<h5><span class="label">Example 11-6. </span>Test with HTTPie and the correct username/password</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http -q -a newphone:whodis? localhost:8000/who</strong>&#13;
{&#13;
    "password": "whodis?",&#13;
    "username": "newphone"&#13;
}</pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Simple Individual Authentication" data-type="sect1"><div class="sect1" id="id92">&#13;
<h1>Simple Individual Authentication</h1>&#13;
&#13;
<p><a data-primary="authentication" data-secondary="individual" data-type="indexterm" id="ibd066"/>The<a data-primary="individual authentication" data-type="indexterm" id="ibd074"/> previous section showed how you could use a shared secret&#13;
to control access.&#13;
It’s a broad approach,&#13;
not very secure.&#13;
And it doesn’t tell you anything about the individual visitor,&#13;
just that they (or a sentient AI)&#13;
know the secret.</p>&#13;
&#13;
<p>Many websites want to do the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Define individual visitors in some way</p>&#13;
</li>&#13;
<li>&#13;
<p>Identify specific visitors as they access certain endpoints&#13;
(authentication)</p>&#13;
</li>&#13;
<li>&#13;
<p>Possibly assign different permissions to some visitors&#13;
and endpoints&#13;
<span class="keep-together">(authorization)</span></p>&#13;
</li>&#13;
<li>&#13;
<p>Possibly save specific information per visitor&#13;
(interests, purchases, and so on)</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>If your visitors are humans, you may want them to provide a&#13;
username or email and a password.&#13;
If they’re external programs,&#13;
you may want them to provide an API key and secret.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>From here on,&#13;
I’ll use just <em>username</em> to refer&#13;
to either a user-selected name or&#13;
an email.</p>&#13;
</div>&#13;
&#13;
<p>To authenticate real individual users instead of a fake one,&#13;
you’ll need to do a bit more:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Pass the user values (name and password)&#13;
to the API server endpoints&#13;
as HTTP headers.</p>&#13;
</li>&#13;
<li>&#13;
<p>Use HTTPS instead of HTTP, to avoid anyone snooping&#13;
the text of these headers.</p>&#13;
</li>&#13;
<li>&#13;
<p><em>Hash</em> the password to a different string. The result is not&#13;
“de-hashable”—you can’t derive the original password from&#13;
its hash.</p>&#13;
</li>&#13;
<li>&#13;
<p>Make a real database store a <code>User</code> database table containing the username and&#13;
the hashed password (never the original plain-text password).</p>&#13;
</li>&#13;
<li>&#13;
<p>Hash the newly input password and compare the result&#13;
with the&#13;
hashed password in the database.</p>&#13;
</li>&#13;
<li>&#13;
<p>If the username and hashed password match,&#13;
pass the matching <code>User</code> object&#13;
up the stack.&#13;
If they don’t match, return <code>None</code> or raise an exception.</p>&#13;
</li>&#13;
<li>&#13;
<p>In the Service layer,&#13;
fire off any metrics/logging/whatever that&#13;
are relevant to individual user authentication.</p>&#13;
</li>&#13;
<li>&#13;
<p>In the Web layer,&#13;
send the authenticated user info to any&#13;
functions that require it.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>I’ll show you how to do all these things in the following sections,&#13;
using recent tools like OAuth2 and JWT.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Fancier Individual Authentication" data-type="sect1"><div class="sect1" id="id93">&#13;
<h1>Fancier Individual Authentication</h1>&#13;
&#13;
<p>If you want to authenticate individuals, you have to store some individual information somewhere—for example, in a database containing records with&#13;
at least a key (username or API key),&#13;
and a secret (password or API secret).&#13;
Your website visitors will&#13;
provide these when accessing protected URLs,&#13;
and you need something in the database to match them with.</p>&#13;
&#13;
<p>The official FastAPI security docs&#13;
(<a href="https://oreil.ly/kkTUB">introductory</a>&#13;
and&#13;
<a href="https://oreil.ly/biKwy">advanced</a>)&#13;
have top-down descriptions of how to set up&#13;
authentication for multiple users,&#13;
using a local database.&#13;
But, example web functions fake the actual database access.</p>&#13;
&#13;
<p class="pagebreak-before">Here, you’ll do the opposite:&#13;
starting at the Data layer&#13;
and working up.&#13;
You’ll define how a user/visitor is defined,&#13;
stored, and accessed.&#13;
Then you’ll work up to the Web layer,&#13;
and how user identification is passed in,&#13;
evaluated,&#13;
and authenticated<a data-primary="individual authentication" data-startref="ibd074" data-type="indexterm" id="id697"/>.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="OAuth2" data-type="sect2"><div class="sect2" id="id94">&#13;
<h2>OAuth2</h2>&#13;
<blockquote>&#13;
<p><a data-primary="authentication" data-secondary="OAuth2" data-type="indexterm" id="id698"/>OAuth 2.0, <a data-primary="OAuth2" data-type="indexterm" id="id699"/>which stands for “Open Authorization,”&#13;
is a standard designed to allow a website or application&#13;
to access resources hosted by other web apps on behalf of a user.</p>&#13;
<p data-type="attribution">Auth0</p>&#13;
</blockquote>&#13;
&#13;
<p>In the early trusting web days, you could provide&#13;
your login name and password of a website&#13;
(let’s call it B)&#13;
to another website (A, of course)&#13;
and let it access stuff on B for you.&#13;
This would give A <em>full access</em> to B,&#13;
although it was trusted to access only what it was&#13;
supposed to.&#13;
Examples of B and resources were things like&#13;
Twitter followers, Facebook friends, email contacts,&#13;
and so on.&#13;
Of course, this couldn’t last long,&#13;
so various companies and groups got together to define OAuth.&#13;
It was originally designed only to allow website A to&#13;
access specific (not all) resources on website B.</p>&#13;
&#13;
<p><a href="https://oauth.net/2">OAuth2</a>&#13;
is a popular but complex <em>authorization</em> standard,&#13;
with uses beyond the A/B example.&#13;
There are many explanations of it, from&#13;
<a href="https://oreil.ly/ehmuf">light</a>&#13;
to&#13;
<a href="https://oreil.ly/qAUaM">heavy</a>.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>There used to be an&#13;
<a href="https://oauth.net/1">OAuth1</a>,&#13;
but it isn’t used anymore.&#13;
Some of the original OAuth2 recommendations are now&#13;
deprecated (computerese for <em>don’t use them</em>).&#13;
On the horizon are&#13;
<a href="https://oauth.net/2.1">OAuth2.1</a>&#13;
and, even <a data-primary="txauth" data-type="indexterm" id="id700"/>further into the mist,&#13;
<a href="https://oreil.ly/5PW2T">txauth</a>.</p>&#13;
</div>&#13;
&#13;
<p>OAuth offers various&#13;
<a href="https://oreil.ly/kRiWh">flows</a>&#13;
for different circumstances.&#13;
I’ll use the&#13;
<em>authorization code flow</em> here.&#13;
This section will walk through an implementation,&#13;
one average-sized step at a time.</p>&#13;
&#13;
<p>First, you’ll need to install these third-party Python packages:</p>&#13;
<dl>&#13;
<dt>JWT handling</dt>&#13;
<dd>&#13;
<p><code>pip install python-jose[cryptography]</code></p>&#13;
</dd>&#13;
<dt>Secure password handling</dt>&#13;
<dd>&#13;
<p><code>pip install passlib</code></p>&#13;
</dd>&#13;
<dt>Form handling</dt>&#13;
<dd>&#13;
<p><code>pip install python-multipart</code></p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>The following sections start with the user data model&#13;
and database management,&#13;
and work up the familiar layers to the Service and Web,&#13;
where OAuth pops up<a data-primary="authentication" data-secondary="individual" data-startref="ibd066" data-type="indexterm" id="id701"/>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="User Model" data-type="sect2"><div class="sect2" id="id210">&#13;
<h2>User Model</h2>&#13;
&#13;
<p><a data-primary="authentication" data-secondary="user model" data-type="indexterm" id="id702"/>Let’s start with the very minimal user model definitions&#13;
in <a data-type="xref" href="#ex-11-7">Example 11-7</a>.&#13;
These will be used in all layers.</p>&#13;
<div data-type="example" id="ex-11-7">&#13;
<h5><span class="label">Example 11-7. </span>User definition: <span class="plain">model/user.py</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">pydantic</code> <code class="kn">import</code> <code class="n">BaseModel</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">User</code><code class="p">(</code><code class="n">BaseModel</code><code class="p">):</code>&#13;
    <code class="n">name</code><code class="p">:</code> <code class="nb">str</code>&#13;
    <code class="nb">hash</code><code class="p">:</code> <code class="nb">str</code></pre></div>&#13;
&#13;
<p>A <code>User</code> object contains an arbitrary <code>name</code> plus a <code>hash</code> string&#13;
(the hashed password, not the original plain-text password),&#13;
and is what’s saved in the database.&#13;
We’ll need both to authenticate a visitor.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="User Data Layer" data-type="sect2"><div class="sect2" id="id211">&#13;
<h2>User Data Layer</h2>&#13;
&#13;
<p><a data-type="xref" href="#ex-11-8">Example 11-8</a> contains the user database code.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p><a data-primary="authentication" data-secondary="Data layer" data-type="indexterm" id="ibd067"/>The <a data-primary="Data layer" data-secondary="authentication" data-type="indexterm" id="ibd075"/>code creates <code>user</code> (active users) and&#13;
<code>xuser</code> (deleted users) tables.&#13;
Often developers add a Boolean <code>deleted</code> field to a user table&#13;
to indicate the user is no longer active, without&#13;
actually deleting the record from the table.&#13;
I prefer moving the deleted user’s data to another table.&#13;
This avoids repetitive checking of the <code>deleted</code> field&#13;
in all user queries.&#13;
It can also help speed up queries:&#13;
making an index for a <em>low cardinality</em> field&#13;
like a Boolean does no good.</p>&#13;
</div>&#13;
<div data-type="example" id="ex-11-8">&#13;
<h5><span class="label">Example 11-8. </span>Data layer: <span class="plain">data/user.py</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">model.user</code> <code class="kn">import</code> <code class="n">User</code>&#13;
<code class="kn">from</code> <code class="nn">.init</code> <code class="kn">import</code> <code class="p">(</code><code class="n">conn</code><code class="p">,</code> <code class="n">curs</code><code class="p">,</code> <code class="n">get_db</code><code class="p">,</code> <code class="n">IntegrityError</code><code class="p">)</code>&#13;
<code class="kn">from</code> <code class="nn">error</code> <code class="kn">import</code> <code class="n">Missing</code><code class="p">,</code> <code class="n">Duplicate</code>&#13;
&#13;
<code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s2">"""create table if not exists</code>&#13;
<code class="s2">                user(</code>&#13;
<code class="s2">                  name text primary key,</code>&#13;
<code class="s2">                  hash text)"""</code><code class="p">)</code>&#13;
<code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s2">"""create table if not exists</code>&#13;
<code class="s2">                xuser(</code>&#13;
<code class="s2">                  name text primary key,</code>&#13;
<code class="s2">                  hash text)"""</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">row_to_model</code><code class="p">(</code><code class="n">row</code><code class="p">:</code> <code class="nb">tuple</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">User</code><code class="p">:</code>&#13;
    <code class="n">name</code><code class="p">,</code> <code class="nb">hash</code> <code class="o">=</code> <code class="n">row</code>&#13;
    <code class="k">return</code> <code class="n">User</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="n">name</code><code class="p">,</code> <code class="nb">hash</code><code class="o">=</code><code class="nb">hash</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">model_to_dict</code><code class="p">(</code><code class="n">user</code><code class="p">:</code> <code class="n">User</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">dict</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">user</code><code class="o">.</code><code class="n">dict</code><code class="p">()</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">get_one</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">User</code><code class="p">:</code>&#13;
    <code class="n">qry</code> <code class="o">=</code> <code class="s2">"select * from user where name=:name"</code>&#13;
    <code class="n">params</code> <code class="o">=</code> <code class="p">{</code><code class="s2">"name"</code><code class="p">:</code> <code class="n">name</code><code class="p">}</code>&#13;
    <code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">qry</code><code class="p">,</code> <code class="n">params</code><code class="p">)</code>&#13;
    <code class="n">row</code> <code class="o">=</code> <code class="n">curs</code><code class="o">.</code><code class="n">fetchone</code><code class="p">()</code>&#13;
    <code class="k">if</code> <code class="n">row</code><code class="p">:</code>&#13;
        <code class="k">return</code> <code class="n">row_to_model</code><code class="p">(</code><code class="n">row</code><code class="p">)</code>&#13;
    <code class="k">else</code><code class="p">:</code>&#13;
        <code class="k">raise</code> <code class="n">Missing</code><code class="p">(</code><code class="n">msg</code><code class="o">=</code><code class="sa">f</code><code class="s2">"User </code><code class="si">{</code><code class="n">name</code><code class="si">}</code><code class="s2"> not found"</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">get_all</code><code class="p">()</code> <code class="o">-&gt;</code> <code class="nb">list</code><code class="p">[</code><code class="n">User</code><code class="p">]:</code>&#13;
    <code class="n">qry</code> <code class="o">=</code> <code class="s2">"select * from user"</code>&#13;
    <code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">qry</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="p">[</code><code class="n">row_to_model</code><code class="p">(</code><code class="n">row</code><code class="p">)</code> <code class="k">for</code> <code class="n">row</code> <code class="ow">in</code> <code class="n">curs</code><code class="o">.</code><code class="n">fetchall</code><code class="p">()]</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">create</code><code class="p">(</code><code class="n">user</code><code class="p">:</code> <code class="n">User</code><code class="p">,</code> <code class="n">table</code><code class="p">:</code><code class="nb">str</code> <code class="o">=</code> <code class="s2">"user"</code><code class="p">):</code>&#13;
    <code class="sd">"""Add &lt;user&gt; to user or xuser table"""</code>&#13;
    <code class="n">qry</code> <code class="o">=</code> <code class="sa">f</code><code class="s2">"""insert into </code><code class="si">{</code><code class="n">table</code><code class="si">}</code><code class="s2"/>&#13;
<code class="s2">        (name, hash)</code>&#13;
<code class="s2">        values</code>&#13;
<code class="s2">        (:name, :hash)"""</code>&#13;
    <code class="n">params</code> <code class="o">=</code> <code class="n">model_to_dict</code><code class="p">(</code><code class="n">user</code><code class="p">)</code>&#13;
    <code class="k">try</code><code class="p">:</code>&#13;
        <code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">qry</code><code class="p">,</code> <code class="n">params</code><code class="p">)</code>&#13;
    <code class="k">except</code> <code class="n">IntegrityError</code><code class="p">:</code>&#13;
        <code class="k">raise</code> <code class="n">Duplicate</code><code class="p">(</code><code class="n">msg</code><code class="o">=</code>&#13;
            <code class="sa">f</code><code class="s2">"</code><code class="si">{</code><code class="n">table</code><code class="si">}</code><code class="s2">: user </code><code class="si">{</code><code class="n">user</code><code class="o">.</code><code class="n">name</code><code class="si">}</code><code class="s2"> already exists"</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">modify</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">,</code> <code class="n">user</code><code class="p">:</code> <code class="n">User</code><code class="p">)</code>  <code class="o">-&gt;</code> <code class="n">User</code><code class="p">:</code>&#13;
    <code class="n">qry</code> <code class="o">=</code> <code class="s2">"""update user set</code>&#13;
<code class="s2">             name=:name, hash=:hash</code>&#13;
<code class="s2">             where name=:name0"""</code>&#13;
    <code class="n">params</code> <code class="o">=</code> <code class="p">{</code>&#13;
        <code class="s2">"name"</code><code class="p">:</code> <code class="n">user</code><code class="o">.</code><code class="n">name</code><code class="p">,</code>&#13;
        <code class="s2">"hash"</code><code class="p">:</code> <code class="n">user</code><code class="o">.</code><code class="n">hash</code><code class="p">,</code>&#13;
        <code class="s2">"name0"</code><code class="p">:</code> <code class="n">name</code><code class="p">}</code>&#13;
    <code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">qry</code><code class="p">,</code> <code class="n">params</code><code class="p">)</code>&#13;
    <code class="k">if</code> <code class="n">curs</code><code class="o">.</code><code class="n">rowcount</code> <code class="o">==</code> <code class="mi">1</code><code class="p">:</code>&#13;
        <code class="k">return</code> <code class="n">get_one</code><code class="p">(</code><code class="n">user</code><code class="o">.</code><code class="n">name</code><code class="p">)</code>&#13;
    <code class="k">else</code><code class="p">:</code>&#13;
        <code class="k">raise</code> <code class="n">Missing</code><code class="p">(</code><code class="n">msg</code><code class="o">=</code><code class="sa">f</code><code class="s2">"User </code><code class="si">{</code><code class="n">name</code><code class="si">}</code><code class="s2"> not found"</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">delete</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="kc">None</code><code class="p">:</code>&#13;
    <code class="sd">"""Drop user with &lt;name&gt; from user table, add to xuser table"""</code>&#13;
    <code class="n">user</code> <code class="o">=</code> <code class="n">get_one</code><code class="p">(</code><code class="n">name</code><code class="p">)</code>&#13;
    <code class="n">qry</code> <code class="o">=</code> <code class="s2">"delete from user where name = :name"</code>&#13;
    <code class="n">params</code> <code class="o">=</code> <code class="p">{</code><code class="s2">"name"</code><code class="p">:</code> <code class="n">name</code><code class="p">}</code>&#13;
    <code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">qry</code><code class="p">,</code> <code class="n">params</code><code class="p">)</code>&#13;
    <code class="k">if</code> <code class="n">curs</code><code class="o">.</code><code class="n">rowcount</code> <code class="o">!=</code> <code class="mi">1</code><code class="p">:</code>&#13;
        <code class="k">raise</code> <code class="n">Missing</code><code class="p">(</code><code class="n">msg</code><code class="o">=</code><code class="sa">f</code><code class="s2">"User </code><code class="si">{</code><code class="n">name</code><code class="si">}</code><code class="s2"> not found"</code><code class="p">)</code>&#13;
    <code class="n">create</code><code class="p">(</code><code class="n">user</code><code class="p">,</code> <code class="n">table</code><code class="o">=</code><code class="s2">"xuser"</code><code class="p">)</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="User Fake Data Layer" data-type="sect2"><div class="sect2" id="id212">&#13;
<h2>User Fake Data Layer</h2>&#13;
&#13;
<p>The module in <a data-type="xref" href="#ex-11-9">Example 11-9</a> is used in tests&#13;
that exclude the database but need some user <a data-primary="Data layer" data-secondary="authentication" data-startref="ibd075" data-type="indexterm" id="id703"/>data<a data-primary="authentication" data-secondary="Data layer" data-startref="ibd067" data-type="indexterm" id="id704"/>.</p>&#13;
<div data-type="example" id="ex-11-9">&#13;
<h5><span class="label">Example 11-9. </span>Fake layer: <span class="plain">fake/user.py</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">model.user</code> <code class="kn">import</code> <code class="n">User</code>&#13;
<code class="kn">from</code> <code class="nn">error</code> <code class="kn">import</code> <code class="n">Missing</code><code class="p">,</code> <code class="n">Duplicate</code>&#13;
&#13;
<code class="c1"># (no hashed password checking in this module)</code>&#13;
<code class="n">fakes</code> <code class="o">=</code> <code class="p">[</code>&#13;
    <code class="n">User</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s2">"kwijobo"</code><code class="p">,</code>&#13;
         <code class="nb">hash</code><code class="o">=</code><code class="s2">"abc"</code><code class="p">),</code>&#13;
    <code class="n">User</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s2">"ermagerd"</code><code class="p">,</code>&#13;
         <code class="nb">hash</code><code class="o">=</code><code class="s2">"xyz"</code><code class="p">),</code>&#13;
    <code class="p">]</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">find</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">User</code> <code class="o">|</code> <code class="kc">None</code><code class="p">:</code>&#13;
    <code class="k">for</code> <code class="n">e</code> <code class="ow">in</code> <code class="n">fakes</code><code class="p">:</code>&#13;
        <code class="k">if</code> <code class="n">e</code><code class="o">.</code><code class="n">name</code> <code class="o">==</code> <code class="n">name</code><code class="p">:</code>&#13;
            <code class="k">return</code> <code class="n">e</code>&#13;
    <code class="k">return</code> <code class="kc">None</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">check_missing</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">):</code>&#13;
    <code class="k">if</code> <code class="ow">not</code> <code class="n">find</code><code class="p">(</code><code class="n">name</code><code class="p">):</code>&#13;
        <code class="k">raise</code> <code class="n">Missing</code><code class="p">(</code><code class="n">msg</code><code class="o">=</code><code class="sa">f</code><code class="s2">"Missing user </code><code class="si">{</code><code class="n">name</code><code class="si">}</code><code class="s2">"</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">check_duplicate</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">):</code>&#13;
    <code class="k">if</code> <code class="n">find</code><code class="p">(</code><code class="n">name</code><code class="p">):</code>&#13;
        <code class="k">raise</code> <code class="n">Duplicate</code><code class="p">(</code><code class="n">msg</code><code class="o">=</code><code class="sa">f</code><code class="s2">"Duplicate user </code><code class="si">{</code><code class="n">name</code><code class="si">}</code><code class="s2">"</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">get_all</code><code class="p">()</code> <code class="o">-&gt;</code> <code class="nb">list</code><code class="p">[</code><code class="n">User</code><code class="p">]:</code>&#13;
    <code class="sd">"""Return all users"""</code>&#13;
    <code class="k">return</code> <code class="n">fakes</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">get_one</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">User</code><code class="p">:</code>&#13;
    <code class="sd">"""Return one user"""</code>&#13;
    <code class="n">check_missing</code><code class="p">(</code><code class="n">name</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">find</code><code class="p">(</code><code class="n">name</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">create</code><code class="p">(</code><code class="n">user</code><code class="p">:</code> <code class="n">User</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">User</code><code class="p">:</code>&#13;
    <code class="sd">"""Add a user"""</code>&#13;
    <code class="n">check_duplicate</code><code class="p">(</code><code class="n">user</code><code class="o">.</code><code class="n">name</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">user</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">modify</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">,</code> <code class="n">user</code><code class="p">:</code> <code class="n">User</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">User</code><code class="p">:</code>&#13;
    <code class="sd">"""Partially modify a user"""</code>&#13;
    <code class="n">check_missing</code><code class="p">(</code><code class="n">name</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">user</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">delete</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="kc">None</code><code class="p">:</code>&#13;
    <code class="sd">"""Delete a user"""</code>&#13;
    <code class="n">check_missing</code><code class="p">(</code><code class="n">name</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="kc">None</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="User Service Layer" data-type="sect2"><div class="sect2" id="id213">&#13;
<h2>User Service Layer</h2>&#13;
&#13;
<p><a data-type="xref" href="#ex-11-10">Example 11-10</a> defines the <a data-primary="authentication" data-secondary="Service layer" data-type="indexterm" id="ibd068"/>Service <a data-primary="Service layer" data-secondary="authentication" data-type="indexterm" id="ibd076"/>layer for&#13;
users.&#13;
A difference from the other Service layer&#13;
modules is the addition of OAuth2 and JWT functions.&#13;
I think it’s cleaner to have them here than in the Web layer,&#13;
though a few OAuth2 Web-layer&#13;
functions are in the upcoming <em>web/user.py</em>.</p>&#13;
&#13;
<p>The CRUD functions are still pass-throughs for now&#13;
but could be flavored to taste with&#13;
metrics in the future.&#13;
Notice that, like the creature and explorer services,&#13;
this design supports runtime use of either the fake&#13;
or real Data layers to access user data.</p>&#13;
<div data-type="example" id="ex-11-10">&#13;
<h5><span class="label">Example 11-10. </span>Service layer: <span class="plain">service/user.py</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">datetime</code> <code class="kn">import</code> <code class="n">timedelta</code><code class="p">,</code> <code class="n">datetime</code>&#13;
<code class="kn">import</code> <code class="nn">os</code>&#13;
<code class="kn">from</code> <code class="nn">jose</code> <code class="kn">import</code> <code class="n">jwt</code>&#13;
<code class="kn">from</code> <code class="nn">model.user</code> <code class="kn">import</code> <code class="n">User</code>&#13;
&#13;
<code class="k">if</code> <code class="n">os</code><code class="o">.</code><code class="n">getenv</code><code class="p">(</code><code class="s2">"CRYPTID_UNIT_TEST"</code><code class="p">):</code>&#13;
    <code class="kn">from</code> <code class="nn">fake</code> <code class="kn">import</code> <code class="n">user</code> <code class="k">as</code> <code class="n">data</code>&#13;
<code class="k">else</code><code class="p">:</code>&#13;
    <code class="kn">from</code> <code class="nn">data</code> <code class="kn">import</code> <code class="n">user</code> <code class="k">as</code> <code class="n">data</code>&#13;
&#13;
<code class="c1"># --- New auth stuff</code>&#13;
&#13;
<code class="kn">from</code> <code class="nn">passlib.context</code> <code class="kn">import</code> <code class="n">CryptContext</code>&#13;
&#13;
<code class="c1"># Change SECRET_KEY for production!</code>&#13;
<code class="n">SECRET_KEY</code> <code class="o">=</code> <code class="s2">"keep-it-secret-keep-it-safe"</code>&#13;
<code class="n">ALGORITHM</code> <code class="o">=</code> <code class="s2">"HS256"</code>&#13;
<code class="n">pwd_context</code> <code class="o">=</code> <code class="n">CryptContext</code><code class="p">(</code><code class="n">schemes</code><code class="o">=</code><code class="p">[</code><code class="s2">"bcrypt"</code><code class="p">],</code> <code class="n">deprecated</code><code class="o">=</code><code class="s2">"auto"</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">verify_password</code><code class="p">(</code><code class="n">plain</code><code class="p">:</code> <code class="nb">str</code><code class="p">,</code> <code class="nb">hash</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">bool</code><code class="p">:</code>&#13;
    <code class="sd">"""Hash &lt;plain&gt; and compare with &lt;hash&gt; from the database"""</code>&#13;
    <code class="k">return</code> <code class="n">pwd_context</code><code class="o">.</code><code class="n">verify</code><code class="p">(</code><code class="n">plain</code><code class="p">,</code> <code class="nb">hash</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">get_hash</code><code class="p">(</code><code class="n">plain</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">str</code><code class="p">:</code>&#13;
    <code class="sd">"""Return the hash of a &lt;plain&gt; string"""</code>&#13;
    <code class="k">return</code> <code class="n">pwd_context</code><code class="o">.</code><code class="n">hash</code><code class="p">(</code><code class="n">plain</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">get_jwt_username</code><code class="p">(</code><code class="n">token</code><code class="p">:</code><code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">str</code> <code class="o">|</code> <code class="kc">None</code><code class="p">:</code>&#13;
    <code class="sd">"""Return username from JWT access &lt;token&gt;"""</code>&#13;
    <code class="k">try</code><code class="p">:</code>&#13;
        <code class="n">payload</code> <code class="o">=</code> <code class="n">jwt</code><code class="o">.</code><code class="n">decode</code><code class="p">(</code><code class="n">token</code><code class="p">,</code> <code class="n">SECRET_KEY</code><code class="p">,</code> <code class="n">algorithms</code><code class="o">=</code><code class="p">[</code><code class="n">ALGORITHM</code><code class="p">])</code>&#13;
        <code class="k">if</code> <code class="ow">not</code> <code class="p">(</code><code class="n">username</code> <code class="o">:=</code> <code class="n">payload</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"sub"</code><code class="p">)):</code>&#13;
            <code class="k">return</code> <code class="kc">None</code>&#13;
    <code class="k">except</code> <code class="n">jwt</code><code class="o">.</code><code class="n">JWTError</code><code class="p">:</code>&#13;
        <code class="k">return</code> <code class="kc">None</code>&#13;
    <code class="k">return</code> <code class="n">username</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">get_current_user</code><code class="p">(</code><code class="n">token</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">User</code> <code class="o">|</code> <code class="kc">None</code><code class="p">:</code>&#13;
    <code class="sd">"""Decode an OAuth access &lt;token&gt; and return the User"""</code>&#13;
    <code class="k">if</code> <code class="ow">not</code> <code class="p">(</code><code class="n">username</code> <code class="o">:=</code> <code class="n">get_jwt_username</code><code class="p">(</code><code class="n">token</code><code class="p">)):</code>&#13;
        <code class="k">return</code> <code class="kc">None</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="n">user</code> <code class="o">:=</code> <code class="n">lookup_user</code><code class="p">(</code><code class="n">username</code><code class="p">)):</code>&#13;
        <code class="k">return</code> <code class="n">user</code>&#13;
    <code class="k">return</code> <code class="kc">None</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">lookup_user</code><code class="p">(</code><code class="n">username</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">User</code> <code class="o">|</code> <code class="kc">None</code><code class="p">:</code>&#13;
    <code class="sd">"""Return a matching User from the database for &lt;name&gt;"""</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="n">user</code> <code class="o">:=</code> <code class="n">data</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">username</code><code class="p">)):</code>&#13;
        <code class="k">return</code> <code class="n">user</code>&#13;
    <code class="k">return</code> <code class="kc">None</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">auth_user</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">,</code> <code class="n">plain</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">User</code> <code class="o">|</code> <code class="kc">None</code><code class="p">:</code>&#13;
    <code class="sd">"""Authenticate user &lt;name&gt; and &lt;plain&gt; password"""</code>&#13;
    <code class="k">if</code> <code class="ow">not</code> <code class="p">(</code><code class="n">user</code> <code class="o">:=</code> <code class="n">lookup_user</code><code class="p">(</code><code class="n">name</code><code class="p">)):</code>&#13;
        <code class="k">return</code> <code class="kc">None</code>&#13;
    <code class="k">if</code> <code class="ow">not</code> <code class="n">verify_password</code><code class="p">(</code><code class="n">plain</code><code class="p">,</code> <code class="n">user</code><code class="o">.</code><code class="n">hash</code><code class="p">):</code>&#13;
        <code class="k">return</code> <code class="kc">None</code>&#13;
    <code class="k">return</code> <code class="n">user</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">create_access_token</code><code class="p">(</code><code class="n">data</code><code class="p">:</code> <code class="nb">dict</code><code class="p">,</code>&#13;
    <code class="n">expires</code><code class="p">:</code> <code class="n">timedelta</code> <code class="o">|</code> <code class="kc">None</code> <code class="o">=</code> <code class="kc">None</code>&#13;
<code class="p">):</code>&#13;
    <code class="sd">"""Return a JWT access token"""</code>&#13;
    <code class="n">src</code> <code class="o">=</code> <code class="n">data</code><code class="o">.</code><code class="n">copy</code><code class="p">()</code>&#13;
    <code class="n">now</code> <code class="o">=</code> <code class="n">datetime</code><code class="o">.</code><code class="n">utcnow</code><code class="p">()</code>&#13;
    <code class="k">if</code> <code class="ow">not</code> <code class="n">expires</code><code class="p">:</code>&#13;
        <code class="n">expires</code> <code class="o">=</code> <code class="n">timedelta</code><code class="p">(</code><code class="n">minutes</code><code class="o">=</code><code class="mi">15</code><code class="p">)</code>&#13;
    <code class="n">src</code><code class="o">.</code><code class="n">update</code><code class="p">({</code><code class="s2">"exp"</code><code class="p">:</code> <code class="n">now</code> <code class="o">+</code> <code class="n">expires</code><code class="p">})</code>&#13;
    <code class="n">encoded_jwt</code> <code class="o">=</code> <code class="n">jwt</code><code class="o">.</code><code class="n">encode</code><code class="p">(</code><code class="n">src</code><code class="p">,</code> <code class="n">SECRET_KEY</code><code class="p">,</code> <code class="n">algorithm</code><code class="o">=</code><code class="n">ALGORITHM</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">encoded_jwt</code>&#13;
&#13;
<code class="c1"># --- CRUD passthrough stuff</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">get_all</code><code class="p">()</code> <code class="o">-&gt;</code> <code class="nb">list</code><code class="p">[</code><code class="n">User</code><code class="p">]:</code>&#13;
    <code class="k">return</code> <code class="n">data</code><code class="o">.</code><code class="n">get_all</code><code class="p">()</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">get_one</code><code class="p">(</code><code class="n">name</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">User</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">data</code><code class="o">.</code><code class="n">get_one</code><code class="p">(</code><code class="n">name</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">create</code><code class="p">(</code><code class="n">user</code><code class="p">:</code> <code class="n">User</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">User</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">data</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">user</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">modify</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">,</code> <code class="n">user</code><code class="p">:</code> <code class="n">User</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">User</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">data</code><code class="o">.</code><code class="n">modify</code><code class="p">(</code><code class="n">name</code><code class="p">,</code> <code class="n">user</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">delete</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="kc">None</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">data</code><code class="o">.</code><code class="n">delete</code><code class="p">(</code><code class="n">name</code><code class="p">)</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="User Web Layer" data-type="sect2"><div class="sect2" id="id214">&#13;
<h2>User Web Layer</h2>&#13;
&#13;
<p><a data-type="xref" href="#ex-11-11">Example 11-11</a> <a data-primary="authentication" data-secondary="Web layer" data-type="indexterm" id="ibd069"/>defines<a data-primary="Web layer" data-secondary="authentication" data-type="indexterm" id="ibd077"/> the base user module&#13;
in the Web layer.&#13;
It uses the new auth code from the <em>service/user.py</em>&#13;
module in <a data-type="xref" href="#ex-11-10">Example 11-10</a>.</p>&#13;
<div data-type="example" id="ex-11-11">&#13;
<h5><span class="label">Example 11-11. </span>Web layer: <span class="plain">web/user.py</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">os</code>&#13;
<code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">APIRouter</code><code class="p">,</code> <code class="n">HTTPException</code>&#13;
<code class="kn">from</code> <code class="nn">fastapi.security</code> <code class="kn">import</code> <code class="n">OAuth2PasswordBearer</code><code class="p">,</code> <code class="n">OAuth2PasswordRequestForm</code>&#13;
<code class="kn">from</code> <code class="nn">model.user</code> <code class="kn">import</code> <code class="n">User</code>&#13;
<code class="k">if</code> <code class="n">os</code><code class="o">.</code><code class="n">getenv</code><code class="p">(</code><code class="s2">"CRYPTID_UNIT_TEST"</code><code class="p">):</code>&#13;
    <code class="kn">from</code> <code class="nn">fake</code> <code class="kn">import</code> <code class="n">user</code> <code class="k">as</code> <code class="n">service</code>&#13;
<code class="k">else</code><code class="p">:</code>&#13;
    <code class="kn">from</code> <code class="nn">service</code> <code class="kn">import</code> <code class="n">user</code> <code class="k">as</code> <code class="n">service</code>&#13;
<code class="kn">from</code> <code class="nn">error</code> <code class="kn">import</code> <code class="n">Missing</code><code class="p">,</code> <code class="n">Duplicate</code>&#13;
&#13;
<code class="n">ACCESS_TOKEN_EXPIRE_MINUTES</code> <code class="o">=</code> <code class="mi">30</code>&#13;
&#13;
<code class="n">router</code> <code class="o">=</code> <code class="n">APIRouter</code><code class="p">(</code><code class="n">prefix</code> <code class="o">=</code> <code class="s2">"/user"</code><code class="p">)</code>&#13;
&#13;
<code class="c1"># --- new auth stuff</code>&#13;
&#13;
<code class="c1"># This dependency makes a post to "/user/token"</code>&#13;
<code class="c1"># (from a form containing a username and password)</code>&#13;
<code class="c1"># and returns an access token.</code>&#13;
<code class="n">oauth2_dep</code> <code class="o">=</code> <code class="n">OAuth2PasswordBearer</code><code class="p">(</code><code class="n">tokenUrl</code><code class="o">=</code><code class="s2">"token"</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">unauthed</code><code class="p">():</code>&#13;
    <code class="k">raise</code> <code class="n">HTTPException</code><code class="p">(</code>&#13;
        <code class="n">status_code</code><code class="o">=</code><code class="mi">401</code><code class="p">,</code>&#13;
        <code class="n">detail</code><code class="o">=</code><code class="s2">"Incorrect username or password"</code><code class="p">,</code>&#13;
        <code class="n">headers</code><code class="o">=</code><code class="p">{</code><code class="s2">"WWW-Authenticate"</code><code class="p">:</code> <code class="s2">"Bearer"</code><code class="p">},</code>&#13;
        <code class="p">)</code>&#13;
&#13;
<code class="c1"># This endpoint is directed to by any call that has the</code>&#13;
<code class="c1"># oauth2_dep() dependency:</code>&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"/token"</code><code class="p">)</code>&#13;
<code class="k">async</code> <code class="k">def</code> <code class="nf">create_access_token</code><code class="p">(</code>&#13;
    <code class="n">form_data</code><code class="p">:</code> <code class="n">OAuth2PasswordRequestForm</code> <code class="o">=</code>  <code class="n">Depends</code><code class="p">()</code>&#13;
<code class="p">):</code>&#13;
    <code class="sd">"""Get username and password from OAuth form,</code>&#13;
<code class="sd">        return access token"""</code>&#13;
    <code class="n">user</code> <code class="o">=</code> <code class="n">service</code><code class="o">.</code><code class="n">auth_user</code><code class="p">(</code><code class="n">form_data</code><code class="o">.</code><code class="n">username</code><code class="p">,</code> <code class="n">form_data</code><code class="o">.</code><code class="n">password</code><code class="p">)</code>&#13;
    <code class="k">if</code> <code class="ow">not</code> <code class="n">user</code><code class="p">:</code>&#13;
        <code class="n">unauthed</code><code class="p">()</code>&#13;
    <code class="n">expires</code> <code class="o">=</code> <code class="n">timedelta</code><code class="p">(</code><code class="n">minutes</code><code class="o">=</code><code class="n">ACCESS_TOKEN_EXPIRE_MINUTES</code><code class="p">)</code>&#13;
    <code class="n">access_token</code> <code class="o">=</code> <code class="n">service</code><code class="o">.</code><code class="n">create_access_token</code><code class="p">(</code>&#13;
        <code class="n">data</code><code class="o">=</code><code class="p">{</code><code class="s2">"sub"</code><code class="p">:</code> <code class="n">user</code><code class="o">.</code><code class="n">username</code><code class="p">},</code> <code class="n">expires</code><code class="o">=</code><code class="n">expires</code>&#13;
    <code class="p">)</code>&#13;
    <code class="k">return</code> <code class="p">{</code><code class="s2">"access_token"</code><code class="p">:</code> <code class="n">access_token</code><code class="p">,</code> <code class="s2">"token_type"</code><code class="p">:</code> <code class="s2">"bearer"</code><code class="p">}</code>&#13;
&#13;
<code class="nd">@app</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/token"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">get_access_token</code><code class="p">(</code><code class="n">token</code><code class="p">:</code> <code class="nb">str</code> <code class="o">=</code> <code class="n">Depends</code><code class="p">(</code><code class="n">oauth2_dep</code><code class="p">))</code> <code class="o">-&gt;</code> <code class="nb">dict</code><code class="p">:</code>&#13;
    <code class="sd">"""Return the current access token"""</code>&#13;
    <code class="k">return</code> <code class="p">{</code><code class="s2">"token"</code><code class="p">:</code> <code class="n">token</code><code class="p">}</code>&#13;
&#13;
<code class="c1"># --- previous CRUD stuff</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">get_all</code><code class="p">()</code> <code class="o">-&gt;</code> <code class="nb">list</code><code class="p">[</code><code class="n">User</code><code class="p">]:</code>&#13;
    <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="n">get_all</code><code class="p">()</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/</code><code class="si">{name}</code><code class="s2">"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">get_one</code><code class="p">(</code><code class="n">name</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">User</code><code class="p">:</code>&#13;
    <code class="k">try</code><code class="p">:</code>&#13;
        <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="n">get_one</code><code class="p">(</code><code class="n">name</code><code class="p">)</code>&#13;
    <code class="k">except</code> <code class="n">Missing</code> <code class="k">as</code> <code class="n">exc</code><code class="p">:</code>&#13;
        <code class="k">raise</code> <code class="n">HTTPException</code><code class="p">(</code><code class="n">status_code</code><code class="o">=</code><code class="mi">404</code><code class="p">,</code> <code class="n">detail</code><code class="o">=</code><code class="n">exc</code><code class="o">.</code><code class="n">msg</code><code class="p">)</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"/"</code><code class="p">,</code> <code class="n">status_code</code><code class="o">=</code><code class="mi">201</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">create</code><code class="p">(</code><code class="n">user</code><code class="p">:</code> <code class="n">User</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">User</code><code class="p">:</code>&#13;
    <code class="k">try</code><code class="p">:</code>&#13;
        <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">user</code><code class="p">)</code>&#13;
    <code class="k">except</code> <code class="n">Duplicate</code> <code class="k">as</code> <code class="n">exc</code><code class="p">:</code>&#13;
        <code class="k">raise</code> <code class="n">HTTPException</code><code class="p">(</code><code class="n">status_code</code><code class="o">=</code><code class="mi">409</code><code class="p">,</code> <code class="n">detail</code><code class="o">=</code><code class="n">exc</code><code class="o">.</code><code class="n">msg</code><code class="p">)</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">patch</code><code class="p">(</code><code class="s2">"/"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">modify</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">,</code> <code class="n">user</code><code class="p">:</code> <code class="n">User</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">User</code><code class="p">:</code>&#13;
    <code class="k">try</code><code class="p">:</code>&#13;
        <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="n">modify</code><code class="p">(</code><code class="n">name</code><code class="p">,</code> <code class="n">user</code><code class="p">)</code>&#13;
    <code class="k">except</code> <code class="n">Missing</code> <code class="k">as</code> <code class="n">exc</code><code class="p">:</code>&#13;
        <code class="k">raise</code> <code class="n">HTTPException</code><code class="p">(</code><code class="n">status_code</code><code class="o">=</code><code class="mi">404</code><code class="p">,</code> <code class="n">detail</code><code class="o">=</code><code class="n">exc</code><code class="o">.</code><code class="n">msg</code><code class="p">)</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">delete</code><code class="p">(</code><code class="s2">"/</code><code class="si">{name}</code><code class="s2">"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">delete</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="kc">None</code><code class="p">:</code>&#13;
    <code class="k">try</code><code class="p">:</code>&#13;
        <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="n">delete</code><code class="p">(</code><code class="n">name</code><code class="p">)</code>&#13;
    <code class="k">except</code> <code class="n">Missing</code> <code class="k">as</code> <code class="n">exc</code><code class="p">:</code>&#13;
        <code class="k">raise</code> <code class="n">HTTPException</code><code class="p">(</code><code class="n">status_code</code><code class="o">=</code><code class="mi">404</code><code class="p">,</code> <code class="n">detail</code><code class="o">=</code><code class="n">exc</code><code class="o">.</code><code class="n">msg</code><code class="p">)</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Test!" data-type="sect2"><div class="sect2" id="id215">&#13;
<h2>Test!</h2>&#13;
&#13;
<p><a data-primary="authentication" data-secondary="testing" data-type="indexterm" id="id705"/>The <a data-primary="testing" data-secondary="authentication" data-type="indexterm" id="id706"/>unit and full tests for this new user component&#13;
are similar to those that you’ve already seen for&#13;
creatures and explorers.&#13;
Rather than using the ink and paper&#13;
here,&#13;
you can view them at this book’s accompanying&#13;
website.<sup><a data-type="noteref" href="ch11.html#id707" id="id707-marker">1</a></sup></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Top Layer" data-type="sect2"><div class="sect2" id="id216">&#13;
<h2>Top Layer</h2>&#13;
&#13;
<p><a data-primary="authentication" data-secondary="top layer" data-type="indexterm" id="id708"/>The previous section defined a new <code>router</code> variable&#13;
for URLs starting with <em>/user</em>,&#13;
so <a data-type="xref" href="#ex-11-12">Example 11-12</a> adds&#13;
this subrouter.</p>&#13;
<div data-type="example" id="ex-11-12">&#13;
<h5><span class="label">Example 11-12. </span>Top layer: <span class="plain">main.py</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">FastAPI</code>&#13;
<code class="kn">from</code> <code class="nn">web</code> <code class="kn">import</code> <code class="n">explorer</code><code class="p">,</code> <code class="n">creature</code><code class="p">,</code> <code class="n">user</code>&#13;
&#13;
<code class="n">app</code> <code class="o">=</code> <code class="n">FastAPI</code><code class="p">()</code>&#13;
<code class="n">app</code><code class="o">.</code><code class="n">include_router</code><code class="p">(</code><code class="n">explorer</code><code class="o">.</code><code class="n">router</code><code class="p">)</code>&#13;
<code class="n">app</code><code class="o">.</code><code class="n">include_router</code><code class="p">(</code><code class="n">creature</code><code class="o">.</code><code class="n">router</code><code class="p">)</code>&#13;
<code class="n">app</code><code class="o">.</code><code class="n">include_router</code><code class="p">(</code><code class="n">user</code><code class="o">.</code><code class="n">router</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>When Uvicorn autoreloads, the <em>/user/…​</em> endpoints&#13;
should now be available.</p>&#13;
&#13;
<p>That was fun,&#13;
in a stretched definition of fun.&#13;
Given all the user code that was just created,&#13;
let’s give it something to do.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Authentication Steps" data-type="sect2"><div class="sect2" id="id217">&#13;
<h2>Authentication Steps</h2>&#13;
&#13;
<p><a data-primary="authentication" data-secondary="steps of" data-type="indexterm" id="id709"/>Here’s a review of that heap of code from the previous sections:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>If an endpoint has the dependency <code>oauth2_dep()</code>&#13;
(in <em>web/user.py</em>),&#13;
a form containing username and password fields is&#13;
generated and sent to the client.</p>&#13;
</li>&#13;
<li>&#13;
<p>After the client fills out and submits this form,&#13;
the username and password&#13;
(hashed with the same algorithm as those already stored in the&#13;
local database)&#13;
are matched against the local&#13;
database.</p>&#13;
</li>&#13;
<li>&#13;
<p>If a match occurs, an access token is generated&#13;
(in JWT format) and returned.</p>&#13;
</li>&#13;
<li>&#13;
<p>This access token is passed back to the web server as an&#13;
<code>Authorization</code> HTTP header in subsequent requests.&#13;
This JWT token is decoded on the local server to the username&#13;
and other details. This name does not need to be looked up in the&#13;
database again.</p>&#13;
</li>&#13;
<li>&#13;
<p>The username is authenticated, and the server can do&#13;
whatever it likes with it.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>What can the server do with this hard-won authentication information? The server can do the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Generate metrics (this user, this endpoint, this time)&#13;
to help study what’s being viewed, by whom, for how long, and so on.</p>&#13;
</li>&#13;
<li>&#13;
<p>Save user-specific information.</p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="JWT" data-type="sect2"><div class="sect2" id="id95">&#13;
<h2>JWT</h2>&#13;
&#13;
<p><a data-primary="authentication" data-secondary="JWT" data-type="indexterm" id="id710"/>This <a data-primary="JWT (JavaScript Web Tokens)" data-type="indexterm" id="id711"/>section contains some details on the JWT.&#13;
You really don’t need them to use all the earlier code&#13;
in this chapter,&#13;
but if you’re a little curious…​</p>&#13;
&#13;
<p>A&#13;
<a href="https://jwt.io">JWT</a>&#13;
is an encoding scheme, not an authentication method.&#13;
The low-level details are defined in&#13;
<a href="https://oreil.ly/_op1j">RFC 7519</a>.&#13;
It can be used to convey authentication information&#13;
for OAuth2 (and other methods),&#13;
and I’ll show that here.</p>&#13;
&#13;
<p>A JWT is a readable string with three dot-separated sections:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><em>Header</em>: Encryption algorithm used, and token type</p>&#13;
</li>&#13;
<li>&#13;
<p><em>Payload</em>: …​</p>&#13;
</li>&#13;
<li>&#13;
<p><em>Signature</em>: …​</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Each section consists of a JSON string,&#13;
encoded in&#13;
<a href="https://www.base64url.com">Base 64 URL</a>&#13;
format.&#13;
Here’s an example (which has been split at the dots to fit on this page):</p>&#13;
&#13;
<pre data-type="programlisting">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.&#13;
eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.&#13;
SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c</pre>&#13;
&#13;
<p>As a plain ASCII string that’s also safe to use in URLs,&#13;
it can be passed to web servers as part of the URL,&#13;
a query parameter,&#13;
HTTP header,&#13;
cookie,&#13;
and so on.</p>&#13;
&#13;
<p>JWT avoids a database lookup, but this also means that you can’t detect a revoked authorization directly.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Third-Party Authentication: OIDC" data-type="sect2"><div class="sect2" id="id96">&#13;
<h2>Third-Party Authentication: OIDC</h2>&#13;
&#13;
<p><a data-primary="authentication" data-secondary="OpenID Connect" data-type="indexterm" id="ibd070"/>You’ll <a data-primary="OIDC (OpenID Connect)" data-type="indexterm" id="ibd078"/>often see websites that let you log in&#13;
with an ID and password,&#13;
or let you log in via your account at a different site,&#13;
like Google, Facebook/Meta, LinkedIn, or many others.&#13;
These frequently use a standard called&#13;
<a href="https://openid.net/connect">OpenID Connect (OIDC)</a>,&#13;
which is built atop OAuth2.&#13;
When you connect to an external OIDC-enabled&#13;
site, you’ll get back an OAuth2 access token&#13;
(as in the examples in this chapter),&#13;
but also an <em>ID token</em>.</p>&#13;
&#13;
<p>The official FastAPI docs don’t include example code&#13;
for integration with OIDC. If you want to try it,&#13;
some third-party packages&#13;
(FastAPI-specific and more generic) <a data-primary="oidc-op" data-type="indexterm" id="id712"/><a data-primary="OIDC Client" data-type="indexterm" id="id713"/><a data-primary="oic" data-type="indexterm" id="id714"/><a data-primary="oauthlib" data-type="indexterm" id="id715"/><a data-primary="FastAPI Resource Server" data-type="indexterm" id="id716"/><a data-primary="fastapi-third-party-auth" data-type="indexterm" id="id717"/><a data-primary="FastAPI OIDC" data-type="indexterm" id="id718"/>will save time&#13;
over rolling your own implementation:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://oreil.ly/TDABr">FastAPI OIDC</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/yGaO6">fastapi-third-party-auth</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/THByF">FastAPI Resource Server</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/J-pDB">oauthlib</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/AgYKZ">oic</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/e9QGb">OIDC Client</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/cJCF4">oidc-op</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/WH49I">OpenID Connect</a></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The <a href="https://oreil.ly/ztR3r">FastAPI Repo Issues page</a>&#13;
includes multiple code examples,&#13;
and a comment from tiangelo (Sebastián Ramírez) that&#13;
FastAPI OIDC examples&#13;
will be included in the official docs and tutorials in the<a data-primary="OIDC (OpenID Connect)" data-startref="ibd078" data-type="indexterm" id="id719"/> future<a data-primary="authentication" data-secondary="OpenID Connect" data-startref="ibd070" data-type="indexterm" id="id720"/>.<a data-primary="FastAPI Repo Issues page" data-type="indexterm" id="id721"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Authorization" data-type="sect1"><div class="sect1" id="id97">&#13;
<h1>Authorization</h1>&#13;
&#13;
<p><a data-primary="authorization" data-secondary="defined" data-type="indexterm" id="id722"/>Authentication handles the <em>who</em> (identity),&#13;
and&#13;
authorization handles the <em>what</em>:&#13;
which resources (web endpoints)&#13;
are you allowed to access, and in what way?&#13;
The number of combinations of <em>who</em> and <em>what</em>&#13;
can be large.</p>&#13;
&#13;
<p>In this book, explorers and creatures have been the main resources.&#13;
Looking up an explorer, or listing all of them,&#13;
would typically be more “open” than adding or modifying an existing one.&#13;
If the website is supposed to be a reliable interface to some data, write access should be more limited than read access.&#13;
Because, grr, people.</p>&#13;
&#13;
<p>If every endpoint is completely open,&#13;
you don’t need authorization&#13;
and can skip this section.&#13;
The simplest authorization could be&#13;
a simple Boolean (is this user an admin or not?);&#13;
for the examples in this book,&#13;
you might require admin authorization to add, delete, or modify&#13;
an explorer or creature.&#13;
If your database has lots of entries,&#13;
you might also want to limit the <code>get_all()</code> functions&#13;
with further permissions for non-admins.&#13;
As the website gets more complex,&#13;
the permissions might become more <span class="keep-together">fine-grained.</span></p>&#13;
&#13;
<p class="pagebreak-after">Let’s look at a progression of authorization cases.&#13;
We’ll use the <code>User</code> table, in which the <code>name</code> can be an email, username, or API key; “pair” tables are the relational database way of&#13;
matching entries from two separate tables:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>If you want to track only admin visitors&#13;
and leave the rest anonymous:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Use an <code>Admin</code> table of authenticated usernames.&#13;
You’d look up the name from the <code>Admin</code> table,&#13;
and if matched, compare the hashed passwords&#13;
from the <code>User</code> table.</p>&#13;
</li>&#13;
</ul>&#13;
</li>&#13;
<li>&#13;
<p>If <em>all</em> visitors should be authenticated,&#13;
but you need to authorize admins for only some endpoints:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Authenticate everyone as in the earlier examples&#13;
(from the <code>User</code> table), and&#13;
then check the <code>Admin</code> table to see if this user is also an admin.</p>&#13;
</li>&#13;
</ul>&#13;
</li>&#13;
<li>&#13;
<p><a data-primary="authorization" data-secondary="permissions" data-type="indexterm" id="id723"/>For <a data-primary="permissions" data-type="indexterm" id="id724"/>more than one type of permission&#13;
(such as read-only, read, write):</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Use a <code>Permission</code> definition table.</p>&#13;
</li>&#13;
<li>&#13;
<p>Use a <code>UserPermission</code> table that pairs&#13;
users and permissions.&#13;
This is sometimes called an&#13;
<em>access control list</em>.</p>&#13;
</li>&#13;
</ul>&#13;
</li>&#13;
<li>&#13;
<p>If permission combinations are complex,&#13;
add a level and define <em>roles</em>&#13;
(independent sets of permissions):</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Create a <code>Role</code> table.</p>&#13;
</li>&#13;
<li>&#13;
<p>Create a <code>UserRole</code> table pairing <code>User</code> and <code>Role</code> entries.&#13;
This is sometimes <a data-primary="RBAC (role-based access control)" data-type="indexterm" id="id725"/><a data-primary="role-based access control (RBAC)" data-type="indexterm" id="id726"/>called <em>role-based access control</em> (RBAC).</p>&#13;
</li>&#13;
</ul>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Middleware" data-type="sect1"><div class="sect1" id="id98">&#13;
<h1>Middleware</h1>&#13;
&#13;
<p><a data-primary="authorization" data-secondary="middleware" data-type="indexterm" id="id727"/>FastAPI <a data-primary="middleware" data-type="indexterm" id="id728"/>enables insertion of code at the Web layer that does the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Intercepts the request</p>&#13;
</li>&#13;
<li>&#13;
<p>Does something with the request</p>&#13;
</li>&#13;
<li>&#13;
<p>Passes the request to a path function</p>&#13;
</li>&#13;
<li>&#13;
<p>Intercepts the response returned by the patch function</p>&#13;
</li>&#13;
<li>&#13;
<p>Does something with the response</p>&#13;
</li>&#13;
<li>&#13;
<p>Returns the response to the caller</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>It’s similar to what a Python decorator does to the function&#13;
that it “wraps.”</p>&#13;
&#13;
<p>In some cases, you could use either middleware or&#13;
dependency injection with <code>Depends()</code>.&#13;
Middleware is handier for more global security issues like&#13;
CORS, which brings up…​</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="CORS" data-type="sect2"><div class="sect2" id="id99">&#13;
<h2>CORS</h2>&#13;
&#13;
<p><a data-primary="authorization" data-secondary="cross-origin resource sharing" data-type="indexterm" id="ibd071"/><em>Cross-origin resource sharing</em> (CORS) <a data-primary="CORS (cross-origin resource sharing)" data-type="indexterm" id="ibd079"/>involves communication&#13;
between other trusted servers and your website.&#13;
If your site has all the frontend and backend code in one place,&#13;
then there’s no problem.&#13;
But these days, it’s common to have a JavaScript frontend&#13;
talking to a backend written in something like FastAPI.&#13;
These servers will not have the same <em>origin</em>:</p>&#13;
<dl>&#13;
<dt>Protocol</dt>&#13;
<dd>&#13;
<p><code>http</code> or <code>https</code></p>&#13;
</dd>&#13;
<dt>Domain</dt>&#13;
<dd>&#13;
<p>Internet domain, like <code>google.com</code> or <code>localhost</code></p>&#13;
</dd>&#13;
<dt>Port</dt>&#13;
<dd>&#13;
<p>Numeric TCP/IP port on that domain, like <code>80</code>, <code>443</code>, or <code>8000</code></p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>How does the backend know a trustable frontend from a box of&#13;
moldy radishes, or a mustache-twirling attacker?&#13;
That’s a job for CORS, which specifies what the backend trusts,&#13;
the most prominent being the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Origins</p>&#13;
</li>&#13;
<li>&#13;
<p>HTTP methods</p>&#13;
</li>&#13;
<li>&#13;
<p>HTTP headers</p>&#13;
</li>&#13;
<li>&#13;
<p>CORS cache timeout</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>You hook into CORS at the Web level.&#13;
<a data-type="xref" href="#ex-11-13">Example 11-13</a> shows how to allow only one frontend server&#13;
(with the domain <em>https://ui.cryptids.com</em>),&#13;
and any HTTP headers or methods.</p>&#13;
<div data-type="example" id="ex-11-13">&#13;
<h5><span class="label">Example 11-13. </span>Activate the CORS middleware</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">FastAPI</code><code class="p">,</code> <code class="n">Request</code>&#13;
<code class="kn">from</code> <code class="nn">fastapi.middleware.cors</code> <code class="kn">import</code> <code class="n">CORSMiddleware</code>&#13;
&#13;
<code class="n">app</code> <code class="o">=</code> <code class="n">FastAPI</code><code class="p">()</code>&#13;
&#13;
<code class="n">app</code><code class="o">.</code><code class="n">add_middleware</code><code class="p">(</code>&#13;
    <code class="n">CORSMiddleware</code><code class="p">,</code>&#13;
    <code class="n">allow_origins</code><code class="o">=</code><code class="p">[</code><code class="s2">"https://ui.cryptids.com"</code><code class="p">,],</code>&#13;
    <code class="n">allow_credentials</code><code class="o">=</code><code class="kc">True</code><code class="p">,</code>&#13;
    <code class="n">allow_methods</code><code class="o">=</code><code class="p">[</code><code class="s2">"*"</code><code class="p">],</code>&#13;
    <code class="n">allow_headers</code><code class="o">=</code><code class="p">[</code><code class="s2">"*"</code><code class="p">],</code>&#13;
    <code class="p">)</code>&#13;
&#13;
<code class="nd">@app</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/test_cors"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">test_cors</code><code class="p">(</code><code class="n">request</code><code class="p">:</code> <code class="n">Request</code><code class="p">):</code>&#13;
    <code class="nb">print</code><code class="p">(</code><code class="n">request</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>Once that’s done, any other domain that tries to contact your&#13;
backend site directly will be <a data-primary="CORS (cross-origin resource sharing)" data-startref="ibd079" data-type="indexterm" id="id729"/>refused<a data-primary="authorization" data-secondary="cross-origin resource sharing" data-startref="ibd071" data-type="indexterm" id="id730"/>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Third-Party Packages" data-type="sect2"><div class="sect2" id="id100">&#13;
<h2>Third-Party Packages</h2>&#13;
&#13;
<p><a data-primary="authorization" data-secondary="third-party packages" data-type="indexterm" id="id731"/>You’ve now read examples of how to code&#13;
authentication and authorization solutions with FastAPI.&#13;
But maybe you don’t need to do everything yourself.&#13;
The FastAPI ecosystem is growing fast, and packages may be available that do a lot of the work for you.</p>&#13;
&#13;
<p>Here are some untested examples.&#13;
There are no guarantees that any package in this list&#13;
will still be around and supported over time,&#13;
but <a data-primary="fastapi-sso" data-type="indexterm" id="id732"/><a data-primary="fastapi_auth2" data-type="indexterm" id="id733"/><a data-primary="fastapi-jwt" data-type="indexterm" id="id734"/><a data-primary="FastAPI Auth Middleware" data-type="indexterm" id="id735"/><a data-primary="FastAPI-key-auth" data-type="indexterm" id="id736"/><a data-primary="fastapi-opa" data-type="indexterm" id="id737"/><a data-primary="fastapi-authz" data-type="indexterm" id="id738"/><a data-primary="FastAPI-User-Auth" data-type="indexterm" id="id739"/><a data-primary="AuthX" data-type="indexterm" id="id740"/><a data-primary="fastapi-auth0" data-type="indexterm" id="id741"/><a data-primary="FastAPI-Login" data-type="indexterm" id="id742"/><a data-primary="FastAPI Users" data-type="indexterm" id="id743"/><a data-primary="FastAPI JWT Auth" data-type="indexterm" id="id744"/>they may be worth a look:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://oreil.ly/ueVfq">FastAPI Users</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/ooGSK">FastAPI JWT Auth</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/oWA3p">FastAPI-Login</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/fHfkU">fastapi-auth0</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://authx.yezz.me">AuthX</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/J57xu">FastAPI-User-Auth</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/aAGzW">fastapi-authz</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/Bvzv3">fastapi-opa</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/s-Ui5">FastAPI-key-auth</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/jnR-s">FastAPI Auth Middleware</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/RrxUZ">fastapi-jwt</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/5DXkB">fastapi_auth2</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/GLTdt">fastapi-sso</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://www.fief.dev">Fief</a></p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Review" data-type="sect1"><div class="sect1" id="id314">&#13;
<h1>Review</h1>&#13;
&#13;
<p>This was a heavier chapter than most.&#13;
It showed ways that you can authenticate visitors&#13;
and authorize them to do certain things.&#13;
These are two aspects of web security. The chapter also discussed CORS, another important web security topic.</p>&#13;
</div></section>&#13;
<div data-type="footnotes"><p data-type="footnote" id="id707"><sup><a href="ch11.html#id707-marker">1</a></sup> If I were paid by the line, fate might have intervened.</p></div></div></section></body></html>