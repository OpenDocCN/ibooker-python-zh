<html><head></head><body>
<div id="sbo-rt-content"><section data-nutshell-tab="Persistence and Databases" data-pdf-bookmark="Chapter 12. Persistence and Databases" data-type="chapter" epub:type="chapter"><div class="chapter" id="persistence_and_databases">
<h1><span class="label">Chapter 12. </span>Persistence and Databases</h1>
<p>Python<a contenteditable="false" data-primary="persistence and databases" data-secondary="overview of" data-type="indexterm" id="idm44924513300000"/> supports several ways of persisting data. One way, <em>serialization</em>, views data as a collection of Python objects. These objects can be <em>serialized</em> (saved) to a byte stream, and later <em>deserialized</em> back (loaded and re-created) from the byte stream. <em>Object persistence</em> relies on serialization, adding features such as object naming. This chapter covers the Python modules that support serialization and object persistence.</p>
<p>Another way to make data persistent is to store it in a database (DB). One simple category of DBs are files that use <em>keyed access</em> to enable selective reading and updating of parts of the data. This chapter covers Python standard library modules that support several variations of such a file format, known as <em>DBM</em>.</p>
<p>A<a contenteditable="false" data-primary="relational DB management system (RDBMS)" data-type="indexterm" id="idm44924513295008"/><a contenteditable="false" data-primary="RDBMS (relational DB management system)" data-type="indexterm" id="idm44924513293856"/> <em>relational DB management system</em> (RDBMS), such as PostgreSQL or Oracle, offers a more powerful approach to storing, searching, and retrieving persistent data. Relational DBs rely on dialects of Structured Query Language (SQL) to create and alter a DB’s schema, insert and update data in the DB, and query the DB with search criteria. (This book does not provide reference material on SQL; for this purpose we recommend O’Reilly’s <a class="orm:hideurl" href="https://www.oreilly.com/library/view/sql-in-a/9781492088851"><em>SQL in a Nutshell</em></a>, by Kevin Kline, Regina Obe, and Leo Hsu.) Unfortunately, despite the existence of SQL standards, no two RDBMSs implement exactly the same SQL dialect.</p>
<p>The Python standard library does not come with an RDBMS interface. However, many third-party modules let your Python programs access a specific RDBMS. Such modules mostly follow the <a href="https://oreil.ly/sktml">Python Database API 2.0</a> standard, also known as the <em>DBAPI</em>. This chapter covers the DBAPI standard and mentions a few of the most popular third-party modules that implement it.</p>
<p>A DBAPI module that is particularly handy (because it comes with every standard installation of Python) is <a href="https://oreil.ly/mAq7b"><span class="code">sqlite3</span></a>, which wraps <a href="https://www.sqlite.org">SQLite</a>. SQLite, “a self-contained, server-less, zero-configuration, transactional SQL DB engine,” is the most widely deployed relational DB engine in the world. We cover <span class="code">sqlite3</span> in <a data-type="xref" href="#sqlite">“SQLite”</a>.</p>
<p>Besides relational DBs, and the simpler approaches covered in this chapter, there exist several <a href="http://nosql-database.org">NoSQL</a> DBs, such as <a href="https://redis.io">Redis</a> and <a href="https://www.mongodb.com">MongoDB</a>, each with Python interfaces. We do not cover advanced nonrelational DBs in this book.</p>
<section data-pdf-bookmark="Serialization" data-type="sect1"><div class="sect1" id="serialization">
<h1>Serialization</h1>
<p>Python<a contenteditable="false" data-primary="persistence and databases" data-secondary="serialization" data-type="indexterm" id="PADserial12"/><a contenteditable="false" data-primary="serialization" data-type="indexterm" id="serail12"/> supplies several modules to <em>serialize</em> (save) Python objects to various kinds of byte streams and<a contenteditable="false" data-primary="deserialization" data-type="indexterm" id="idm44924513277104"/> <em>deserialize</em> (load and re-create) Python objects back from streams. Serialization is also known as<a contenteditable="false" data-primary="marshaling" data-type="indexterm" id="idm44924513275424"/> <em>marshaling</em>, which means formatting for<a contenteditable="false" data-primary="data interchange" data-type="indexterm" id="idm44924513273744"/> <em>data interchange</em>.</p>
<p>Serialization approaches span a vast range, from the low-level, Python-version-specific <span class="code">marshal</span> and language-independent JSON (both limited to elementary data types) to the richer but Python-specific <span class="code">pickle</span> and cross-language formats such as XML, <a href="http://yaml.org">YAML</a>, <a href="https://developers.google.com/protocol-buffers">protocol buffers</a>, and <a href="http://msgpack.org">MessagePack</a>.</p>
<p>In this section, we cover Python’s <span class="code">csv</span>, <span class="code">json</span>, <span class="code">pickle</span>, and <span class="code">shelve</span> modules. We cover XML in <a data-type="xref" href="ch23.xhtml#structured_text_xml">Chapter 23</a>. <span class="code">marshal</span> is too low-level to use in applications; should you need to maintain old code using it, refer to the <a href="https://oreil.ly/wZZ3s">online docs</a>. As for protocol buffers, MessagePack, YAML, and other data-interchange/serialization approaches (each with specific advantages and weaknesses), we cannot cover everything in this book; we recommend studying them via the resources available on the web.</p>
<section data-pdf-bookmark="The csv Module" data-type="sect2"><div class="sect2" id="the_csv_module">
<h2>The csv Module</h2>
<p>While<a contenteditable="false" data-primary="serialization" data-secondary="csv module" data-type="indexterm" id="idm44924513259904"/><a contenteditable="false" data-primary="csv module" data-type="indexterm" id="csvmod12"/><a contenteditable="false" data-primary="standard library modules" data-secondary="csv" data-type="indexterm" id="SLMcsv11"/> the CSV (standing for <em>comma-separated values</em><sup><a data-type="noteref" href="ch12.xhtml#ch01fn106" id="ch01fn106-marker">1</a></sup>) format isn’t usually considered a form of serialization, it is a widely used and convenient interchange format for tabular data. Since much data is tabular, CSV data is used a lot, despite some lack of agreement on exactly how it should be represented in files. To overcome this issue, the <span class="code">csv</span> module provides a number of <em>dialects</em> (specifications of the way particular sources encode CSV data) and lets you define your own dialects. You can register additional dialects and list the available dialects by calling the <span class="code">csv.list_dialects</span> function. For further information on dialects, consult <a href="https://oreil.ly/3_o6_">the module’s documentation</a>.</p>
<section data-pdf-bookmark="csv functions and classes" data-type="sect3"><div class="sect3" id="csv_functions_and_classes">
<h3>csv functions and classes</h3>
<p>The <span class="code">csv</span> module exposes the functions and classes detailed in <a data-type="xref" href="#functions_and_classes_of_the_csv_module">Table 12-1</a>. It provides two kinds of readers and writers to let you handle CSV data rows in Python as either lists or dictionaries.</p>
<table class="border" id="functions_and_classes_of_the_csv_module">
<caption><span class="label">Table 12-1. </span>Functions and classes of the <span class="code">csv</span> module</caption>
<tbody>
<tr>
<td><span class="code">reader</span></td>
<td><span class="code">reader(<em>csvfile</em>, dialect='excel',</span> <span class="code"><em>**kw</em></span><span class="code">)</span><br/>
			Creates and returns a reader object <span class="code"><em>r</em></span>. <span class="code"><em>csvfile</em></span> can be any iterable object yielding text rows as <span class="code">str</span>s (usually a list of lines or a file opened with <span class="code">newline=''</span><sup><a data-type="noteref" href="ch12.xhtml#ch01fn107" id="ch01fn107-marker">a</a></sup>); <span class="code">dialect</span> is the name of a registered dialect. To modify the dialect, add named arguments: their values override dialect fields of the same name. Iterating over <span class="code"><em>r</em></span> yields a sequence of lists, each containing the elements from one row of <span class="code"><em>csvfile</em></span>.</td>
</tr>
<tr>
<td><span class="code">writer</span></td>
<td><span class="code">writer(<em>csvfile</em>, dialect='excel',</span> <span class="code"><em>**kw</em></span><span class="code">)</span><br/>
			Creates and returns a writer object <span class="code"><em>w</em></span>. <span class="code"><em>csvfile</em></span> is an object with a <span class="code">write</span> method (if a file, open it with <span class="code">newline=''</span>); <span class="code"><em>dialect</em></span> is the name of a registered dialect. To modify the dialect, add named arguments: their values override dialect fields of the same name. <span class="code"><em>w.</em></span><span class="code">writerow</span> accepts a sequence of values and writes their CSV representation as a row to <span class="code"><em>csvfile</em></span>. <span class="code"><em>w.</em></span><span class="code">writerows</span> accepts an iterable of such sequences and calls <span class="code"><em>w.</em></span><span class="code">writerow</span> on each. You are responsible for closing <span class="code"><em>csvfile</em></span>.</td>
</tr>
<tr>
<td><span class="code">D⁠i⁠c⁠t​R⁠e⁠a⁠d⁠e⁠r</span></td>
<td><span class="code">DictReader(<em>csvfile,</em></span> <span class="code">fieldnames=<strong>None</strong>, restkey=<strong>None</strong>,<br/> restval=<strong>None</strong>, dialect='excel',</span> <span class="code"><em>*args,**kw</em>)</span><br/>
			Creates and returns an object <span class="code"><em>r</em></span> that iterates over <span class="code"><em>csvfile</em></span> to generate an iterable of dictionaries (<span class="version">-3.8</span> <span class="code">OrderedDict</span>s), one for each row. When the <span class="code">fieldnames</span> argument is given, it is used to name the fields in <span class="code"><em>csvfile</em></span>; otherwise, the field names are taken from the first row of <span class="code"><em>csvfile</em></span>. If a row contains more columns than field names, the extra values are saved as a list with the key <span class="code">restkey</span>. If there are insufficient values in any row, then those column values will be set to <span class="code">restval</span>. <span class="code">dialect</span>, <span class="code"><em>kw</em></span>, and <span class="code"><em>args</em></span> are passed to the underlying reader object.</td>
</tr>
<tr>
<td><span class="code">DictWriter</span></td>
<td><span class="code">DictWriter(<em>csvfile</em>,</span> <span class="code"><em>fieldnames</em></span><span class="code">, restval='',<br/> extrasaction='raise', dialect='excel'<em>, *args, **kwds</em>)</span><br/>
			Creates and returns an object <span class="code"><em>w</em></span> whose <span class="code">writerow</span> and <span class="code">writerows</span> methods take a dictionary or iterable of dictionaries and write them using the <span class="code"><em>csvfile</em></span>’s <span class="code">write</span> method. <span class="code"><em>fieldnames</em></span> is a sequence of <span class="code">str</span>s, the keys to the dictionaries. <span class="code"><em>restval</em></span> is the value used to fill up a dictionary that’s missing some keys. <span class="code">extrasaction</span> specifies what to do when a dictionary has extra keys not listed in <span class="code"><em>fieldnames</em></span>: when <span class="code">'raise'</span>, the default, the function raises <span class="code">ValueError</span> in such cases; when <span class="code">'ignore'</span>, the function ignores such errors. <span class="code">dialect</span>, <span class="code"><em>kw</em></span>, and <span class="code"><em>args</em></span> are passed to the underlying reader object. You are responsible for closing <span class="code"><em>csvfile</em></span> (usually a file opened with <span class="code">newline=''</span>).</td>
</tr>
</tbody>
<tbody><tr class="footnotes"><td colspan="2"><p data-type="footnote" id="ch01fn107"><sup><a href="ch12.xhtml#ch01fn107-marker">a</a></sup> Opening a file with <span class="code">newline=''</span> allows the <span class="code">csv</span> module to use its own newline processing and correctly handle dialects in which text fields may contain newlines.</p></td></tr></tbody></table>
</div></section>
<section class="pagebreak-before" data-pdf-bookmark="A csv example" data-type="sect3"><div class="sect3" id="a_csv_example">
<h3 class="less_space">A csv example</h3>
<p>Here is a simple example using <span class="code">csv</span> to read color data from a list of strings:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">csv</code><code>
</code><code>
</code><code class="n">color_data</code><code> </code><code class="o">=</code><code> </code><code class="s1">'''</code><code class="se">\
</code><code class="s1">color,r,g,b</code><code class="s1">
</code><code class="s1">red,255,0,0</code><code class="s1">
</code><code class="s1">green,0,255,0</code><code class="s1">
</code><code class="s1">blue,0,0,255</code><code class="s1">
</code><code class="s1">cyan,0,255,255</code><code class="s1">
</code><code class="s1">magenta,255,0,255</code><code class="s1">
</code><code class="s1">yellow,255,255,0</code><code class="s1">
</code><code class="s1">'''</code><code class="o">.</code><code class="n">splitlines</code><code class="p">(</code><code class="p">)</code><code>
</code><code>
</code><code class="n">colors</code><code> </code><code class="o">=</code><code> </code><code class="p">{</code><code class="n">row</code><code class="p">[</code><code class="s1">'</code><code class="s1">color</code><code class="s1">'</code><code class="p">]</code><code class="p">:</code><code> </code><code>
</code><code>          </code><code class="n">row</code><code> </code><strong><code class="k">for</code></strong><code> </code><code class="n">row</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">csv</code><code class="o">.</code><code class="n">DictReader</code><code class="p">(</code><code class="n">color_data</code><code class="p">)</code><code class="p">}</code><code>
</code><code>
</code><code class="nb">print</code><code class="p">(</code><code class="n">colors</code><code class="p">[</code><code class="s1">'</code><code class="s1">red</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code> </code><code>
</code><em><code class="c1"># prints: {'color': 'red', 'r': '255', 'g': '0', 'b': '0'}</code></em></pre>
<p>Note that the integer values are read as strings. <span class="code">csv</span> does not do any data conversion; that needs to be done by your program code with the <span class="code">dict</span>s returned from <span class="code">DictReader</span>.<a contenteditable="false" data-primary="" data-startref="csvmod12" data-type="indexterm" id="idm44924513121072"/><a contenteditable="false" data-primary="" data-startref="SLMcsv11" data-type="indexterm" id="idm44924513119664"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="The json Module" data-type="sect2"><div class="sect2" id="the_json_module">
<h2>The json Module</h2>
<p>The<a contenteditable="false" data-primary="serialization" data-secondary="json module" data-type="indexterm" id="idm44924513116384"/><a contenteditable="false" data-primary="json module" data-type="indexterm" id="jsonmod12"/><a contenteditable="false" data-primary="standard library modules" data-secondary="json" data-type="indexterm" id="SLMjson12"/> standard library’s <span class="code">json</span> module supports serialization for Python’s native data types (<span class="code">tuple</span>, <span class="code">list</span>, <span class="code">dict</span>, <span class="code">int</span>, <span class="code">str</span>, etc.). To serialize instances of your own custom classes, you should implement corresponding classes inheriting from <span class="code">JSONEncoder</span> and <span class="code">JSONDecoder</span>.</p>
<section data-pdf-bookmark="json functions" data-type="sect3"><div class="sect3" id="json_functions">
<h3>json functions</h3>
<p>The <span class="code">json</span> module supplies four key functions, detailed in <a data-type="xref" href="#functions_of_the_json_module">Table 12-2</a>.</p>
<table class="border" id="functions_of_the_json_module">
<caption><span class="label">Table 12-2. </span>Functions of the <span class="code">json</span> module</caption>
<tbody>
<tr>
<td class="width-15"><span class="code">dump</span></td>
<td><span class="code">dump(<em>value</em>,</span> <span class="code"><em>fileobj</em></span><span class="code">, skipkeys=<strong>False</strong>, ensure_ascii=<strong>True</strong>, check_circular=<strong>True</strong>, allow_nan=<strong>True</strong>, cls=JSONEncoder, indent=<strong>None</strong>, separators=(', ', ': '), default=<strong>None</strong>, sort_keys=<strong>False</strong>,</span> <span class="code"><em>**kw</em></span><span class="code">)</span><br/>
			Writes the JSON serialization of object <span class="code"><em>value</em></span> to file-like object <span class="code"><em>fileobj</em></span>, which must be opened for writing in text mode, via calls to <span class="code"><em>fileobj</em></span>.<span class="code">write</span>. Each call to <span class="code"><em>fileobj</em></span><span class="code">.write</span> passes a text string as an argument.<br/>
			When <span class="code">skipkeys</span> is <span class="code"><strong>True</strong></span> (by default, it’s <span class="code"><strong>False</strong></span>), <span class="code">dict</span> keys that are not scalars (i.e., are not of types <span class="code">bool</span>, <span class="code">float</span>, <span class="code">int</span>, <span class="code">str</span>, or <span class="code"><strong>None</strong></span><strong>)</strong> raise an exception. In any case, keys that <em>are</em> scalars are turned into strings (e.g., <span class="code"><strong>None</strong></span> becomes <span class="code">'null'</span>): JSON only allows strings as keys in its mappings.</td>
</tr>
<tr>
<td class="width-15"><span class="code">dump</span><br/>
<em>(cont.)</em></td>
<td>When <span class="code">ensure_ascii</span> is <span class="code"><strong>True</strong></span> (the default), all non-ASCII characters in the output are escaped; when it’s <span class="code"><strong>False</strong></span>, they’re output as is.<br/>
			When <span class="code">check_circular</span> is <span class="code"><strong>True</strong></span> (the default), containers in <span class="code"><em>value</em></span> are checked for circular references and a <span class="code">ValueError</span> exception is raised if any are found; when it’s <span class="code"><strong>False</strong></span>, the check is skipped, and many different exceptions can get raised as a result (even a crash is possible).<br/>
			When <span class="code">allow_nan</span> is <span class="code"><strong>True</strong></span> (the default), float scalars <span class="code">nan</span>, <span class="code">inf</span>, and <span class="code">-inf</span> are output as their respective JavaScript equivalents, <span class="code">NaN</span>, <span class="code">Infinity</span>, and <span class="code">-Infinity</span>; when it’s <span class="code"><strong>False</strong></span>, the presence of such scalars raises a <span class="code">ValueError</span> exception.<br/>
			You can optionally pass <span class="code">cls</span> in order to use a customized subclass of <span class="code">JSONEncoder</span> (such advanced customization is rarely needed, and we don’t cover it in this book); in this case, <span class="code">**</span><span class="code"><em>kw</em></span> gets passed in the call to <span class="code">cls</span> that instantiates it. By default, encoding uses the <span class="code">JSONEncoder</span> class directly.<br/>
			When <span class="code">indent</span> is an <span class="code">int &gt; 0</span>, <span class="code">dump</span> “pretty-prints” the output by prepending that many spaces to each array element and object member; when it’s an <span class="code">int &lt;= 0</span>, <span class="code">dump</span> just inserts <span class="code">\n</span> characters. When <span class="code">indent</span> is <span class="code"><strong>None</strong></span> (the default), <span class="code">dump</span> uses the most compact representation. <span class="code">indent</span> can also be a <span class="code">str</span>—for example, <span class="code">'\t'</span>—and in that case <span class="code">dump</span> uses that string for indenting.<br/>
<span class="code">separators</span> must be a tuple with two items, respectively the strings used to separate items and to separate keys from values. You can explicitly pass <span class="code">separators=(',', ':')</span> to ensure <span class="code">dump</span> inserts no whitespace.<br/>
			You can optionally pass <span class="code">default</span> in order to transform some otherwise nonserializable objects into serializable ones. <span class="code">default</span> is a function called with a single argument that’s a nonserializable object, and it must return a serializable object or raise <span class="code">ValueError</span> (by default, the presence of nonserializable objects raises <span class="code">ValueError</span>).<br/>
			When <span class="code">sort_keys</span> is <span class="code"><strong>True</strong></span> (by default, it’s <span class="code"><strong>False</strong></span>), mappings are output in sorted order of their keys; when <span class="code"><strong>False</strong></span>, they’re output in whatever is their natural order of iteration (nowadays, for most mappings, insertion order).</td>
</tr>
<tr>
<td><span class="code">dumps</span></td>
<td><span class="code">dumps(<em>value</em>, skipkeys=<strong>False</strong>, ensure_ascii=<strong>True</strong>, check_circular=<strong>True</strong>, allow_nan=<strong>True</strong>, cls=JSONEncoder, indent=<strong>None</strong>,</span><br/>
<span class="code">separators=(', ', ': '), default=<strong>None</strong>, sort_keys=<strong>False</strong>,</span> <span class="code"><em>**kw</em></span><span class="code">)</span><br/>
			Returns the string that’s the JSON serialization of object <span class="code"><em>value</em></span>—that is, the string that <span class="code">dump</span> would write to its file object argument. All arguments to <span class="code">dumps</span> have exactly the same meaning as the arguments to <span class="code">dump</span>.
			<div data-type="note" epub:type="note">
<h1>JSON Serializes Just One Object per File</h1>
<p>JSON is not what is known as a <em>framed format</em>: this means it is <em>not</em> possible to call <span class="code">dump</span> more than once in order to serialize multiple objects into the same file, nor to later call <span class="code">load</span> more than once to deserialize the objects, as would be possible, for example, with <span class="code">pickle</span> (discussed in the following section). So, technically, JSON serializes just one object per file. However, that one object can be a <span class="code">list</span> or <span class="code">dict</span> that can contain as many items as you wish.</p>
</div>
</td>
</tr>
<tr>
<td><span class="code">load</span></td>
<td><span class="code">load(<em>fileobj</em>, encoding='utf-8', cls=JSONDecoder, object_hook=<strong>None</strong>, parse_float=float, parse_int=int, parse_constant=<strong>None</strong>, object_pairs_hook=<strong>None</strong>,</span> <span class="code"><em>**kw</em></span><span class="code">)</span><br/>
			Creates and returns the object <span class="code"><em>v</em></span> previously serialized into file-like object <span class="code"><em>fileobj</em></span>, which must be opened for reading in text mode, getting <span class="code"><em>fileobj</em></span>’s contents via a call to <span class="code"><em>fileobj</em></span><span class="code">.read</span>. The call to <span class="code"><em>fileobj</em></span><span class="code">.read</span> must return a text (Unicode) string.<br/>
			The functions <span class="code">load</span> and <span class="code">dump</span> are complementary. In other words, a single call to <span class="code">load(<em>f</em>)</span> deserializes the same value previously serialized when <span class="code"><em>f</em></span>’s contents were created by a single call to <span class="code">dump(<em>v</em>,</span> <span class="code"><em>f</em></span><span class="code">)</span> (possibly with some alterations: e.g., all dictionary keys are turned into strings).<br/>
			You can optionally pass <span class="code">cls</span> in order to use a customized subclass of <span class="code">JSONDecoder</span> (such advanced customization is rarely needed, and we don’t cover it in this book); in this case, <span class="code">**<em>kw</em></span> gets passed in the call to <span class="code">cls</span>, which instantiates it. By default, decoding uses the <span class="code">JSONDecoder</span> class directly.<br/>
			You can optionally pass <span class="code">object_hook</span> or <span class="code">object_pairs_hook</span> (if you pass both, <span class="code">object_hook</span> is ignored and only <span class="code">object_pairs_hook</span> is used), a function that lets you implement custom decoders. When you pass <span class="code">object_hook</span> but not <span class="code">object_pairs_hook</span>, each time an object is decoded into a <span class="code">dict</span>, <span class="code">load</span> calls <span class="code">object_hook</span> with the <span class="code">dict</span> as the only argument, and uses <span class="code">object_hook</span>’s return value instead of that <span class="code">dict</span>. When you pass <span class="code">object_pairs_hook</span>, each time an object is decoded, <span class="code">load</span> calls <span class="code">object_pairs_hook</span> with, as the only argument, a list of the pairs of <span class="code">(</span><span class="code"><em>key</em>,</span> <span class="code"><em>value</em></span><span class="code">)</span> items of the object, in the order in which they are present in the input, and uses <span class="code">object_pairs_hooks</span>’s return value. This lets you perform specialized decoding that potentially depends on the order of <span class="code">(<em>key</em>,</span> <span class="code"><em>value</em></span><span class="code">)</span> pairs in the input.<br/>
<span class="code">parse_float</span>, <span class="code">parse_int</span>, and <span class="code">parse_constant</span> are functions called with a single argument: a <span class="code">str</span> representing a <span class="code">float</span>, an <span class="code">int</span>, or one of the three special constants <span class="code">'NaN'</span>, <span class="code">'Infinity'</span>, or <span class="code">'-Infinity'</span>. <span class="code">load</span> calls the appropriate function each time it identifies in the input a <span class="code">str</span> representing a number, and uses the function’s return value. By default, <span class="code">parse_float</span> is the built-in function <span class="code">float</span>, <span class="code">parse_int</span> is <span class="code">int</span>, and <span class="code">parse_constant</span> is a function that returns one of the three special float scalars <span class="code">nan</span>, <span class="code">inf</span>, or <span class="code">-inf</span>, as appropriate. For example, you could pass <span class="code">parse_float=decimal.Decimal</span> to ensure that all numbers in the result that would normally be <span class="code">float</span>s are instead decimals (covered in <a data-type="xref" href="ch16.xhtml#the_decimal_module">“The decimal Module”</a>).</td>
</tr>
<tr>
<td><span class="code">loads</span></td>
<td><span class="code">loads(<em>s</em>, cls=JSONDecoder, object_hook=<strong>None</strong>, parse_float=float, parse_int=int, parse_constant=<strong>None</strong>, object_pairs_hook=<strong>None</strong>,</span> <span class="code"><em>**kw</em></span><span class="code">)</span><br/>
			Creates and returns the object <span class="code"><em>v</em></span> previously serialized into the string <span class="code"><em>s</em></span>. All arguments to <span class="code">loads</span> have exactly the same meaning as the arguments to <span class="code">load</span>.</td>
</tr>
</tbody>
</table>
</div></section>
<section data-pdf-bookmark="A json example" data-type="sect3"><div class="sect3" id="a_json_example">
<h3>A json example</h3>
<p>Say you need to read several text files, whose names are given as your program’s arguments, recording where each distinct word appears in the files. What you need to record for each word is a list of <span class="code">(<em>filename</em>,</span> <span class="code"><em>linenumber</em></span><span class="code">)</span> pairs. The following example uses the <span class="code">fileinput</span> module to iterate through all the files given as program arguments, and <span class="code">json</span> to encode the lists of <span class="code">(<em>filename</em>,</span> <span class="code"><em>linenumber</em></span><span class="code">)</span> pairs as strings and store them in a DBM-like file (as covered in <a data-type="xref" href="#dbm_modules">“DBM Modules”</a>). Since these lists contain tuples, each containing a string and a number, they are within <span class="code">json</span>’s abilities to serialize:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">collections</code><code class="o">,</code><code> </code><code class="nn">fileinput</code><code class="o">,</code><code> </code><code class="nn">json</code><code class="o">,</code><code> </code><code class="nn">dbm</code><code>
</code><code class="n">word_pos</code><code> </code><code class="o">=</code><code> </code><code class="n">collections</code><code class="o">.</code><code class="n">defaultdict</code><code class="p">(</code><code class="nb">list</code><code class="p">)</code><code>
</code><strong><code class="k">for</code></strong><code> </code><code class="n">line</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">fileinput</code><code class="o">.</code><code class="n">input</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">pos</code><code> </code><code class="o">=</code><code> </code><code class="n">fileinput</code><code class="o">.</code><code class="n">filename</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">fileinput</code><code class="o">.</code><code class="n">filelineno</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><strong><code class="k">for</code></strong><code> </code><code class="n">word</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">line</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="n">word_pos</code><code class="p">[</code><code class="n">word</code><code class="p">]</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">pos</code><code class="p">)</code><code>
</code><strong><code class="k">with</code></strong><code> </code><code class="n">dbm</code><code class="o">.</code><code class="n">open</code><code class="p">(</code><code class="s1">'</code><code class="s1">indexfilem</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">n</code><code class="s1">'</code><code class="p">)</code><code> </code><strong><code class="k">as</code></strong><code> </code><code class="n">dbm_out</code><code class="p">:</code><code>
</code><code>    </code><strong><code class="k">for</code></strong><code> </code><code class="n">word</code><code class="p">,</code><code> </code><code class="n">word_positions</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">word_pos</code><code class="o">.</code><code class="n">items</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="n">dbm_out</code><code class="p">[</code><code class="n">word</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">json</code><code class="o">.</code><code class="n">dumps</code><code class="p">(</code><code class="n">word_positions</code><code class="p">)</code></pre>
<p>We can then use <span class="code">json</span> to deserialize the data stored in the DBM-like file <em>indexfilem</em>, as in the following<a contenteditable="false" data-primary="" data-startref="jsonmod12" data-type="indexterm" id="idm44924512785424"/><a contenteditable="false" data-primary="" data-startref="SLMjson12" data-type="indexterm" id="idm44924512784208"/> example:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">sys</code><code class="o">,</code><code> </code><code class="nn">json</code><code class="o">,</code><code> </code><code class="nn">dbm</code><code class="o">,</code><code> </code><code class="nn">linecache</code><code>
</code><strong><code class="k">with</code></strong><code> </code><code class="n">dbm</code><code class="o">.</code><code class="n">open</code><code class="p">(</code><code class="s1">'</code><code class="s1">indexfilem</code><code class="s1">'</code><code class="p">)</code><code> </code><strong><code class="k">as</code></strong><code> </code><code class="n">dbm_in</code><code class="p">:</code><code>
</code><strong><code>    </code><code class="k">for</code></strong><code> </code><code class="n">word</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">sys</code><code class="o">.</code><code class="n">argv</code><code class="p">[</code><code class="mi">1</code><code class="p">:</code><code class="p">]</code><code class="p">:</code><code>
</code><code>        </code><strong><code class="k">if</code></strong><code> </code><code class="n">word</code><code> </code><strong><code class="ow">not</code><code> </code><code class="ow">in</code></strong><code> </code><code class="n">dbm_in</code><code class="p">:</code><code>
</code><code>             </code><code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s1">'</code><code class="s1">Word </code><code class="si">{</code><code class="n">word</code><code class="si">!r}</code><code class="s1"> not found in index file</code><code class="s1">'</code><code class="p">,</code><code>                                             </code><code class="n">file</code><code class="o">=</code><code class="n">sys</code><code class="o">.</code><code class="n">stderr</code><code class="p">)</code><code>
</code><strong><code>             </code><code class="k">continue</code></strong><code>
</code><code>        </code><code class="n">places</code><code> </code><code class="o">=</code><code> </code><code class="n">json</code><code class="o">.</code><code class="n">loads</code><code class="p">(</code><code class="n">dbm_in</code><code class="p">[</code><code class="n">word</code><code class="p">]</code><code class="p">)</code><code>
</code><code>        </code><strong><code class="k">for</code></strong><code> </code><code class="n">fname</code><code class="p">,</code><code> </code><code class="n">lineno</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">places</code><code class="p">:</code><code>
</code><code>            </code><code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s1">'</code><code class="s1">Word </code><code class="si">{</code><code class="n">word</code><code class="si">!r}</code><code class="s1"> occurs in line </code><code class="si">{</code><code class="n">lineno</code><code class="si">}</code><code class="s1">'</code><code>
</code><code>                  </code><code class="sa">f</code><code class="s1">'</code><code class="s1"> of file </code><code class="si">{</code><code class="n">fname</code><code class="si">!r}</code><code class="s1">:</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>            </code><code class="nb">print</code><code class="p">(</code><code class="n">linecache</code><code class="o">.</code><code class="n">getline</code><code class="p">(</code><code class="n">fname</code><code class="p">,</code><code> </code><code class="n">lineno</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">end</code><code class="o">=</code><code class="s1">'</code><code class="s1">'</code><code class="p">)</code></pre>
</div></section>
</div></section>
<section data-pdf-bookmark="The pickle Module" data-type="sect2"><div class="sect2" id="the_pickle_module">
<h2>The pickle Module</h2>
<p>The<a contenteditable="false" data-primary="serialization" data-secondary="pickle module" data-type="indexterm" id="idm44924512617616"/><a contenteditable="false" data-primary="pickle module" data-type="indexterm" id="picmod12"/><a contenteditable="false" data-primary="standard library modules" data-secondary="pickle" data-type="indexterm" id="SLBpickle12"/> <span class="code">pickle</span> module supplies factory functions, named <span class="code">Pickler</span> and<a contenteditable="false" data-primary="Unpickler function (pickle module)" data-type="indexterm" id="idm44924512635728"/> <span class="code">Unpickler</span>, to generate objects (instances of nonsubclassable types, not classes) that wrap files and supply Python-specific serialization mechanisms. Serializing and deserializing via these modules is also known as <em>pickling</em> and <em>unpickling</em>.</p>
<p>Serialization shares some of the issues of deep copying, covered in <a data-type="xref" href="ch08.xhtml#the_copy_module">“The copy Module”</a>. The <span class="code">pickle</span> module deals with these issues in much the same way as the <span class="code">copy</span> module does. Serialization, like deep copying, implies a recursive walk over a directed graph of references. <span class="code">pickle</span> preserves the graph’s shape: when the same object is encountered more than once, the object is serialized only the first time, and other occurrences of the same object serialize references to that single value. <span class="code">pickle</span> also correctly serializes graphs with reference cycles. However, this means that if a mutable object <span class="code"><em>o</em></span> is serialized more than once to the same <span class="code">Pickler</span> instance <span class="code"><em>p</em></span>, any changes to <span class="code"><em>o</em></span> after the first serialization of <span class="code"><em>o</em></span> to <span class="code"><em>p</em></span> are not saved.</p>
<div data-type="tip">
<h1>Don’t Alter Objects While Their Serialization Is Underway</h1>
<p>For clarity, correctness, and simplicity, don’t alter objects that are being serialized while serialization to a <span class="code">Pickler</span> instance is in progress.</p>
</div>
<p><span class="code">pickle</span> can serialize with a legacy ASCII protocol or with one of several compact binary protocols. <a data-type="xref" href="#pickle_protocols">Table 12-3</a> lists the available protocols.</p>
<table class="border" id="pickle_protocols">
<caption><span class="label">Table 12-3. </span><span class="code">pickle</span> protocols</caption>
<thead>
<tr>
<th>Protocol</th>
<th>Format</th>
<th>Added in Python version</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><span class="code">0</span></td>
<td>ASCII</td>
<td>1.4<sup><a data-type="noteref" href="ch12.xhtml#ch01fn108" id="ch01fn108-marker">a</a></sup></td>
<td>Human-readable format, slow to serialize/deserialize</td>
</tr>
<tr>
<td><span class="code">1</span></td>
<td>Binary</td>
<td>1.5</td>
<td>Early binary format, superseded by protocol <span class="code">2</span></td>
</tr>
<tr>
<td><span class="code">2</span></td>
<td>Binary</td>
<td>2.3</td>
<td>Improved support for later Python 2 features</td>
</tr>
<tr>
<td><span class="code">3</span></td>
<td>Binary</td>
<td>3.0</td>
<td>(<span class="version">-3.8</span> default) Added specific support for <span class="code">bytes</span> objects</td>
</tr>
<tr>
<td><span class="code">4</span></td>
<td>Binary</td>
<td>3.4</td>
<td>(<span class="version">3.8+</span> default) Included support for very large objects</td>
</tr>
<tr>
<td><span class="code">5</span></td>
<td>Binary</td>
<td>3.8</td>
<td><span class="version">3.8+</span> Added features to support pickling as serialization for transport between processes, per <a href="https://oreil.ly/PcSYs">PEP 574</a></td>
</tr>
</tbody>
<tbody><tr class="footnotes"><td colspan="4"><p data-type="footnote" id="ch01fn108"><sup><a href="ch12.xhtml#ch01fn108-marker">a</a></sup> Or possibly earlier. This is the oldest version of documentation available at <a href="http://Python.org">Python.org</a>.</p></td></tr></tbody></table>
<div data-type="tip">
<h1>Always Pickle with Protocol 2 or Higher</h1>
<p>Always use <em>at least</em> protocol <span class="code">2</span>. The size and speed savings can be substantial, and binary format has basically no downside except loss of compatibility of resulting pickles with truly ancient versions of Python.</p>
</div>
<p>When you reload objects, <span class="code">pickle</span> transparently recognizes and uses any protocol that the Python version you’re currently using supports.</p>
<p><span class="code">pickle</span> serializes classes and functions by name, not by value.<sup><a data-type="noteref" href="ch12.xhtml#ch01fn109" id="ch01fn109-marker">2</a></sup> <span class="code">pickle</span> can therefore deserialize a class or function only by importing it from the same module where the class or function was found when <span class="code">pickle</span> serialized it. In particular, <span class="code">pickle</span> can normally serialize and deserialize classes and functions only if they are top-level names (i.e., attributes) of their respective modules. Consider the following example:</p>
<pre class="pagebreak-before" data-code-language="python" data-type="programlisting">
<strong><code class="k">def</code></strong><code> </code><code class="nf">adder</code><code class="p">(</code><code class="n">augend</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><strong><code class="k">def</code></strong><code> </code><code class="nf">inner</code><code class="p">(</code><code class="n">addend</code><code class="p">,</code><code> </code><code class="n">augend</code><code class="o">=</code><code class="n">augend</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><strong><code class="k">return</code></strong><code> </code><code class="n">addend</code><code class="o">+</code><code class="n">augend</code><code>
</code><code>    </code><strong><code class="k">return</code></strong><code> </code><code class="n">inner</code><code>
</code><code class="n">plus5</code><code> </code><code class="o">=</code><code> </code><code class="n">adder</code><code class="p">(</code><code class="mi">5</code><code class="p">)</code></pre>
<p>This code binds a closure to name <span class="code">plus5</span> (as covered in <a data-type="xref" href="ch03.xhtml#nested_functions_and_nested_scopes">“Nested functions and nested scopes”</a>)—a nested function <span class="code">inner</span> plus an appropriate outer scope. Therefore, trying to pickle <span class="code">plus5</span> raises an <span class="code">AttributeError</span>: a function can be pickled only when it is top-level, and the function <span class="code">inner</span>, whose closure is bound to the name <span class="code">plus5</span> in this code, is not top-level but rather is nested inside the function <span class="code">adder</span>. Similar issues apply to pickling nested functions and nested classes (i.e., classes not at the top level).</p>
<section data-pdf-bookmark="pickle functions and classes" data-type="sect3"><div class="sect3" id="pickle_functions_and_classes">
<h3>pickle functions and classes</h3>
<p>The <span class="code">pickle</span> module exposes the functions and classes listed in <a data-type="xref" href="#functions_and_classes_of_the_pickle_mod">Table 12-4</a>.</p>
<table class="border" id="functions_and_classes_of_the_pickle_mod">
<caption><span class="label">Table 12-4. </span>Functions and classes of the <span class="code">pickle</span> module</caption>
<tbody>
<tr>
<td class="width-15"><span class="code">dump</span>,<br/>
<span class="code">dumps</span></td>
<td><span class="code">dump(<em>value</em>,</span> <span class="code"><em>fileobj,</em></span> <span class="code">protocol=<strong>None</strong>, bin=<strong>None</strong>)</span>,<br/>
<span class="code">dumps(<em>value</em>, protocol=<strong>None</strong>,</span> <span class="code">bin=<strong>None</strong>)</span><br/>
<span class="code">dumps</span> returns a bytestring representing the object <span class="code"><em>value</em></span>. <span class="code">dump</span> writes the same string to the file-like object <span class="code"><em>fileobj</em></span>, which must be opened for writing. <span class="code">dump(<em>v</em>,</span> <span class="code"><em>f</em></span><span class="code">)</span> is like <span class="code"><em>f</em></span><span class="code">.write(dumps(<em>v</em>))</span>. The <span class="code">protocol</span> parameter can be <span class="code">0</span> (ASCII output, the slowest and bulkiest option), or a larger <span class="code">int</span> for various kinds of binary output (see <a data-type="xref" href="#pickle_protocols">Table 12-3</a>). Unless <span class="code">protocol</span> is <span class="code">0</span>, the <span class="code"><em>fileobj</em></span> parameter to dump must be open for binary writing. Do not pass the <span class="code">bin</span> parameter, which exists only for compatibility with old versions of Python.</td>
</tr>
<tr>
<td><span class="code">load</span>,<br/>
<span class="code">loads</span></td>
<td><span class="code">load(<em>fileobj</em>)</span>,<br/>
<span class="code">loads(<em>s</em>, *, fix_imports=True, encoding="ASCII", errors="strict")</span><br/>
			The functions <span class="code">load</span> and <span class="code">dump</span> are complementary. In other words, a sequence of calls to <span class="code">load(<em>f</em>)</span> deserializes the same values previously serialized when <span class="code"><em>f</em></span>’s contents were created by a sequence of calls to <span class="code">dump(<em>v, f</em>)</span>. <span class="code">load</span> reads the right number of bytes from file-like object <span class="code"><em>fileobj</em></span> and creates and returns the object <span class="code"><em>v</em></span> represented by those bytes. <span class="code">load</span> and <span class="code">loads</span> transparently support pickles performed in any binary or ASCII protocol. If data is pickled in any binary format, the file must be open as binary for both <span class="code">dump</span> and <span class="code">load</span>. <span class="code">load(<em>f</em>)</span> is like <span class="code">Unpickler(<em>f</em>).load()</span>.</td>
</tr>
<tr>
<td><span class="code">load</span>,<br/>
<span class="code">loads</span><br/>
<em>(cont.)</em></td>
<td><span class="code">loads</span> creates and returns the object <span class="code"><em>v</em></span> represented by bytestring <span class="code"><em>s</em></span>, so that for any object <span class="code"><em>v</em></span> of a supported type, <span class="code"><em>v</em></span><span class="code">==loads(dumps(<em>v</em>))</span>. If <span class="code"><em>s</em></span> is longer than <span class="code">dumps(<em>v</em>)</span>, <span class="code">loads</span> ignores the extra bytes. Optional arguments <span class="code">fix_imports</span>, <span class="code">encoding</span>, and <span class="code">errors</span> are provided for handling streams generated by Python 2 code; see the <span class="code">pickle.loads</span> <a href="https://oreil.ly/VSepJ">documentation</a> for further information.
			<div data-type="warning" epub:type="warning">
<h1>Never Unpickle Untrusted Data</h1>
<p>Unpickling from an untrusted data source is a security risk; an attacker could exploit this vulnerability to execute arbitrary code.</p>
</div>
</td>
</tr>
<tr>
<td><span class="code">Pickler</span></td>
<td><span class="code">Pickler(<em>fileobj</em>, protocol=<strong>None</strong>, bin=<strong>None</strong>)</span><br/>
			Creates and returns an object <span class="code"><em>p</em></span> such that calling <span class="code"><em>p</em></span><span class="code">.dump</span> is equivalent to calling the function <span class="code">dump</span> with the <span class="code"><em>fileobj</em></span>, <span class="code">protocol</span>, and <span class="code">bin</span> arguments passed to <span class="code">Pickler</span>. To serialize many objects to a file, <span class="code">Pickler</span> is more convenient and faster than repeated calls to <span class="code">dump</span>. You can subclass <span class="code">pickle.Pickler</span> to override <span class="code">Pickler</span> methods (particularly the method <span class="code">persistent_id</span>) and create your own persistence framework. However, this is an advanced topic and is not covered further in this book.</td>
</tr>
<tr>
<td><span class="code">Unpickler</span></td>
<td><span class="code">Unpickler(<em>fileobj</em>)</span><br/>
			Creates and returns an object <span class="code"><em>u</em></span> such that calling the <span class="code"><em>u</em></span><span class="code">.load</span> is equivalent to calling <span class="code">load</span> with the <span class="code"><em>fileobj</em></span> argument passed to <span class="code">Unpickler</span>. To deserialize many objects from a file, <span class="code">Unpickler</span> is more convenient and faster than repeated calls to the function <span class="code">load</span>. You can subclass <span class="code">pickle.Unpickler</span> to override <span class="code">Unpickler</span> methods (particularly the method <span class="code">persistent_load</span>) and create your own persistence framework. However, this is an advanced topic and is not covered further in this book.</td>
</tr>
</tbody>
</table>
</div></section>
<section data-pdf-bookmark="A pickling example" data-type="sect3"><div class="sect3" id="a_pickling_example">
<h3>A pickling example</h3>
<p>The following example handles the same task as the <span class="code">json</span> example shown earlier, but uses <span class="code">pickle</span> instead of <span class="code">json</span> to serialize lists of <span class="code">(<em>filename</em>,</span> <span class="code"><em>linenumber</em></span><span class="code">)</span> pairs as strings:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">collections</code><code class="o">,</code><code> </code><code class="nn">fileinput</code><code class="o">,</code><code> </code><code class="nn">pickle</code><code class="o">,</code><code> </code><code class="nn">dbm</code><code>
</code><code class="n">word_pos</code><code> </code><code class="o">=</code><code> </code><code class="n">collections</code><code class="o">.</code><code class="n">defaultdict</code><code class="p">(</code><code class="nb">list</code><code class="p">)</code><code>
</code><strong><code class="k">for</code></strong><code> </code><code class="n">line</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">fileinput</code><code class="o">.</code><code class="n">input</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">pos</code><code> </code><code class="o">=</code><code> </code><code class="n">fileinput</code><code class="o">.</code><code class="n">filename</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">fileinput</code><code class="o">.</code><code class="n">filelineno</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><strong><code class="k">for</code></strong><code> </code><code class="n">word</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">line</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="n">word_pos</code><code class="p">[</code><code class="n">word</code><code class="p">]</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">pos</code><code class="p">)</code><code>
</code><code>
</code><strong><code class="k">with</code></strong><code> </code><code class="n">dbm</code><code class="o">.</code><code class="n">open</code><code class="p">(</code><code class="s1">'</code><code class="s1">indexfilep</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">n</code><code class="s1">'</code><code class="p">)</code><code> </code><strong><code class="k">as</code></strong><code> </code><code class="n">dbm_out</code><code class="p">:</code><code>
</code><code>    </code><strong><code class="k">for</code></strong><code> </code><code class="n">word</code><code class="p">,</code><code> </code><code class="n">word_positions</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">word_pos</code><code class="o">.</code><code class="n">items</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="n">dbm_out</code><code class="p">[</code><code class="n">word</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">pickle</code><code class="o">.</code><code class="n">dumps</code><code class="p">(</code><code class="n">word_positions</code><code class="p">,</code><code> </code><code class="n">protocol</code><code class="o">=</code><code class="mi">2</code><code class="p">)</code></pre>
<p>We can then use <span class="code">pickle</span> to read back the data stored to the DBM-like file <em>indexfilep</em>, as shown in the following example:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">sys</code><code class="o">,</code><code> </code><code class="nn">pickle</code><code class="o">,</code><code> </code><code class="nn">dbm</code><code class="o">,</code><code> </code><code class="nn">linecache</code><code>
</code><strong><code class="k">with</code></strong><code> </code><code class="n">dbm</code><code class="o">.</code><code class="n">open</code><code class="p">(</code><code class="s1">'</code><code class="s1">indexfilep</code><code class="s1">'</code><code class="p">)</code><code> </code><strong><code class="k">as</code></strong><code> </code><code class="n">dbm_in</code><code class="p">:</code><code>
</code><strong><code>    </code><code class="k">for</code></strong><code> </code><code class="n">word</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">sys</code><code class="o">.</code><code class="n">argv</code><code class="p">[</code><code class="mi">1</code><code class="p">:</code><code class="p">]</code><code class="p">:</code><code>
</code><code>        </code><strong><code class="k">if</code></strong><code> </code><code class="n">word</code><code> </code><strong><code class="ow">not</code><code> </code><code class="ow">in</code></strong><code> </code><code class="n">dbm_in</code><code class="p">:</code><code>
</code><code>            </code><code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s1">'</code><code class="s1">Word </code><code class="si">{</code><code class="n">word</code><code class="si">!r}</code><code class="s1"> not found in index file</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>                  </code><code class="n">file</code><code class="o">=</code><code class="n">sys</code><code class="o">.</code><code class="n">stderr</code><code class="p">)</code><code>
</code><strong><code>            </code><code class="k">continue</code></strong><code>
</code><code>        </code><code class="n">places</code><code> </code><code class="o">=</code><code> </code><code class="n">pickle</code><code class="o">.</code><code class="n">loads</code><code class="p">(</code><code class="n">dbm_in</code><code class="p">[</code><code class="n">word</code><code class="p">]</code><code class="p">)</code><code>
</code><code>        </code><strong><code class="k">for</code></strong><code> </code><code class="n">fname</code><code class="p">,</code><code> </code><code class="n">lineno</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">places</code><code class="p">:</code><code>
</code><code>            </code><code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s1">'</code><code class="s1">Word </code><code class="si">{</code><code class="n">word</code><code class="si">!r}</code><code class="s1"> occurs in line </code><code class="si">{</code><code class="n">lineno</code><code class="si">}</code><code class="s1">'</code><code>
</code><code>                  </code><code class="sa">f</code><code class="s1">'</code><code class="s1"> of file </code><code class="si">{</code><code class="n">fname</code><code class="si">!r}</code><code class="s1">:</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>            </code><code class="nb">print</code><code class="p">(</code><code class="n">linecache</code><code class="o">.</code><code class="n">getline</code><code class="p">(</code><code class="n">fname</code><code class="p">,</code><code> </code><code class="n">lineno</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">end</code><code class="o">=</code><code class="s1">'</code><code class="s1">'</code><code class="p">)</code></pre>
</div></section>
<section data-pdf-bookmark="Pickling instances" data-type="sect3"><div class="sect3" id="pickling_instances">
<h3>Pickling instances</h3>
<p>In order for <span class="code">pickle</span> to reload an instance <span class="code"><em>x</em></span>, <span class="code">pickle</span> must be able to import <span class="code"><em>x</em></span>’s class from the same module in which the class was defined when <span class="code">pickle</span> saved the instance. Here is how <span class="code">pickle</span> saves the state of instance object <span class="code"><em>x</em></span> of class <span class="code"><em>T</em></span> and later reloads the saved state into a new instance <span class="code"><em>y</em></span> of <span class="code"><em>T</em></span> (the first step of the reloading is always to make a new empty instance <span class="code"><em>y</em></span> of <span class="code"><em>T</em></span>, except where we explicitly say otherwise):</p>
<ul>
<li>
<p>When <span class="code"><em>T</em></span> supplies the method <span class="code">__getstate__</span>, <span class="code">pickle</span> saves the result <span class="code"><em>d</em></span> of calling <span class="code"><em>T</em></span><span class="code">.__getstate__(<em>x</em>)</span>.</p>
</li>
<li>
<p>When <span class="code"><em>T</em></span> supplies the method <span class="code">__setstate__</span>, <span class="code"><em>d</em></span> can be of any type, and <span class="code">pickle</span> reloads the saved state by calling <span class="code"><em>T</em></span><span class="code">.__setstate__(<em>y, d</em>)</span>.</p>
</li>
<li>
<p>Otherwise, <span class="code"><em>d</em></span> must be a dictionary, and <span class="code">pickle</span> just sets <span class="code"><em>y</em></span><span class="code">.__dict__ =</span> <span class="code"><em>d</em></span>.</p>
</li>
<li>
<p>Otherwise, when <span class="code"><em>T</em></span> supplies the method <span class="code">__getnewargs__</span>, and <span class="code">pickle</span> is pickling with protocol 2 or higher, <span class="code">pickle</span> saves the result <span class="code"><em>t</em></span> of calling <span class="code"><em>T</em></span><span class="code">.__getnewargs__(<em>x</em>)</span>; <span class="code"><em>t</em></span> must be a tuple.</p>
</li>
<li>
<p><span class="code">pickle</span>, in this one case, does not start with an empty <span class="code"><em>y</em></span>, but rather creates <span class="code"><em>y</em></span> by executing <span class="code"><em>y</em></span> <span class="code">=</span> <span class="code"><em>T</em></span><span class="code">.__new__(<em>T</em></span>, <span class="code"><em>*t</em>)</span>, which concludes the reloading.</p>
</li>
<li>
<p>Otherwise, by default, <span class="code">pickle</span> saves as <span class="code"><em>d</em></span> the dictionary <span class="code"><em>x</em></span><span class="code">.__dict__</span>.</p>
</li>
<li>
<p>When <span class="code"><em>T</em></span> supplies the method <span class="code">__setstate__</span>, <span class="code">pickle</span> reloads the saved state by calling <span class="code"><em>T</em></span><span class="code">.__setstate__(<em>y, d</em>)</span>.</p>
</li>
<li>
<p>Otherwise, <span class="code">pickle</span> just sets <span class="code"><em>y</em></span><span class="code">.__dict__ =</span> <span class="code"><em>d</em></span>.</p>
</li>
</ul>
<p>All the items in the <span class="code"><em>d</em></span> or <span class="code"><em>t</em></span> object that <span class="code">pickle</span> saves and reloads (normally a dictionary or tuple) must, in turn, be instances of types suitable for pickling and unpickling (aka <em>pickleable</em> objects), and the procedure just outlined may be repeated recursively, if necessary, until <span class="code">pickle</span> reaches primitive pickleable built-in types (dictionaries, tuples, lists, sets, numbers, strings, etc.).</p>
<p>As mentioned in <a data-type="xref" href="ch08.xhtml#the_copy_module">“The copy Module”</a>, the <span class="code">__getnewargs__</span>, <span class="code">__getstate__</span>, and <span class="code">__setstate__</span> special methods also control the way instance objects are copied and deep copied. If a class defines <span class="code">__slots__</span>, and therefore its instances do not have a <span class="code">__dict__</span> attribute, <span class="code">pickle</span> does its best to save and restore a dictionary equivalent to the names and values of the slots. However, such a class should define <span class="code">__getstate__</span> and <span class="code">__setstate__</span>; otherwise, its instances may not be correctly pickleable and copied through such best-effort endeavors.</p>
</div></section>
<section data-pdf-bookmark="Pickling customization with the copyreg module" data-type="sect3"><div class="sect3" id="pickling_customization_with_the_copy_re">
<h3>Pickling customization with the copyreg module</h3>
<p>You<a contenteditable="false" data-primary="copyreg module" data-type="indexterm" id="idm44924511991152"/><a contenteditable="false" data-primary="standard library modules" data-secondary="copyreg" data-type="indexterm" id="idm44924511990048"/> can control how <span class="code">pickle</span> serializes and deserializes objects of an arbitrary type by registering factory and reduction functions with the module <span class="code">copyreg</span>. This is particularly, though not exclusively, useful when you define a type in a C-coded Python extension. The <span class="code">copyreg</span> module supplies the functions listed in <a data-type="xref" href="#functions_of_the_copy_reg_module">Table 12-5</a>.</p>
<table class="border" id="functions_of_the_copy_reg_module">
<caption><span class="label">Table 12-5. </span>Functions of the <span class="code">copyreg</span> module</caption>
<tbody>
<tr>
<td class="width-15"><span class="code">constructor</span></td>
<td><span class="code">constructor(<em>fcon</em>)</span><br/>
			Adds <span class="code"><em>fcon</em></span> to the table of constructors, which lists all factory functions that <span class="code">pickle</span> may call. <span class="code"><em>fcon</em></span> must be callable and is normally a function.</td>
</tr>
<tr>
<td><span class="code">pickle</span></td>
<td><span class="code">pickle(<em>type</em>,</span> <span class="code"><em>fred</em></span><span class="code">, fcon=<strong>None</strong>)</span><br/>
			Registers function <span class="code"><em>fred</em></span> as the <em>reduction function</em> for type <span class="code"><em>type</em></span>, where <span class="code"><em>type</em></span> must be a type object. To save an object <span class="code"><em>o</em></span> of type <span class="code"><em>type</em></span>, the module <span class="code">pickle</span> calls <span class="code"><em>fred</em></span><span class="code">(<em>o</em>)</span> and saves the result. <span class="code"><em>fred</em></span><span class="code">(<em>o</em>)</span> must return a tuple <span class="code">(fcon,</span> <span class="code"><em>t</em></span><span class="code">)</span> or <span class="code">(fcon,</span> <span class="code"><em>t</em></span><span class="code">,</span> <span class="code"><em>d</em></span><span class="code">)</span>, where <span class="code"><em>fcon</em></span> is a constructor and <span class="code"><em>t</em></span> is a tuple. To reload <span class="code"><em>o</em></span>, <span class="code">pickle</span> uses <span class="code"><em>o</em></span><span class="code">=fcon(*<em>t</em>)</span>. Then, when <span class="code"><em>fred</em></span> also returns a <span class="code"><em>d</em></span>, <span class="code">pickle</span> uses <span class="code"><em>d</em></span> to restore <span class="code"><em>o</em></span>’s state (when <span class="code"><em>o</em></span> supplies <span class="code">__setstate__</span>, <span class="code"><em>o</em></span><span class="code">.__setstate__(<em>d</em>)</span>; otherwise, <span class="code"><em>o</em></span><span class="code">.__dict__.update(<em>d</em>))</span>, as described in the previous section. If <span class="code"><em>fcon</em></span> is not <span class="code"><strong>None</strong></span>, <span class="code">pickle</span> also calls <span class="code">constructor(<em>fcon</em>)</span> to register <span class="code"><em>fcon</em></span> as a constructor.<br/>
<span class="code">pickle</span> does not support pickling of code objects, but <span class="code">marshal</span> does. Here’s how you could customize pickling to support code objects by delegating the work to <span class="code">marshal</span> thanks to <span class="code">copyreg</span>:
			<pre data-code-language="python" data-type="programlisting">
<code class="o">&gt;&gt;</code><code class="o">&gt;</code><code> </code><strong><code class="kn">import</code></strong><code> </code><code class="nn">pickle</code><code class="o">,</code><code> </code><code class="nn">copyreg</code><code class="o">,</code><code> </code><code class="nn">marshal</code><code>
</code><code class="o">&gt;&gt;</code><code class="o">&gt;</code><code> </code><strong><code class="k">def</code></strong><code> </code><code class="nf">marsh</code><code class="p">(</code><code class="n">x</code><code class="p">)</code><code class="p">:</code><code>
</code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code>     </code><strong><code class="k">return</code></strong><code> </code><code class="n">marshal</code><code class="o">.</code><code class="n">loads</code><code class="p">,</code><code> </code><code class="p">(</code><code class="n">marshal</code><code class="o">.</code><code class="n">dumps</code><code class="p">(</code><code class="n">x</code><code class="p">)</code><code class="p">,</code><code class="p">)</code><code>
</code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code>
</code><code class="o">&gt;&gt;</code><code class="o">&gt;</code><code> </code><code class="n">c</code><code class="o">=</code><code class="nb">compile</code><code class="p">(</code><code class="s1">'</code><code class="s1">2+2</code><code class="s1">'</code><code class="p">,</code><code class="s1">'</code><code class="s1">'</code><code class="p">,</code><code class="s1">'</code><code class="s1">eval</code><code class="s1">'</code><code class="p">)</code><code>
</code><code class="o">&gt;&gt;</code><code class="o">&gt;</code><code> </code><code class="n">copyreg</code><code class="o">.</code><code class="n">pickle</code><code class="p">(</code><code class="nb">type</code><code class="p">(</code><code class="n">c</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">marsh</code><code class="p">)</code><code>
</code><code class="o">&gt;&gt;</code><code class="o">&gt;</code><code> </code><code class="n">s</code><code class="o">=</code><code class="n">pickle</code><code class="o">.</code><code class="n">dumps</code><code class="p">(</code><code class="n">c</code><code class="p">,</code><code> </code><code class="mi">2</code><code class="p">)</code><code>
</code><code class="o">&gt;&gt;</code><code class="o">&gt;</code><code> </code><code class="n">cc</code><code class="o">=</code><code class="n">pickle</code><code class="o">.</code><code class="n">loads</code><code class="p">(</code><code class="n">s</code><code class="p">)</code><code>
</code><code class="o">&gt;&gt;</code><code class="o">&gt;</code><code> </code><code class="nb">print</code><code class="p">(</code><code class="nb">eval</code><code class="p">(</code><code class="n">cc</code><code class="p">)</code><code class="p">)</code></pre>
<pre data-type="programlisting">
<strong>4</strong></pre>
<div data-type="warning" epub:type="warning">
<h1>Using marshal Makes Your Code Python Version Dependent</h1>
<p>Be careful when using<a contenteditable="false" data-primary="marshaling" data-type="indexterm" id="idm44924511820768"/> <span class="code">marshal</span> in your code, as the preceding example does. <span class="code">marshal</span>’s serialization isn’t guaranteed to be stable across versions, so using <span class="code">marshal</span> means that programs written in other versions of Python may be unable to load the objects your program has serialized.<a contenteditable="false" data-primary="" data-startref="picmod12" data-type="indexterm" id="idm44924511836560"/><a contenteditable="false" data-primary="" data-startref="SLBpickle12" data-type="indexterm" id="idm44924511835184"/></p>
</div>
</td>
</tr>
</tbody>
</table>
</div></section>
</div></section>
<section data-pdf-bookmark="The shelve Module" data-type="sect2"><div class="sect2" id="the_shelve_module">
<h2>The shelve Module</h2>
<p>The<a contenteditable="false" data-primary="serialization" data-secondary="shelve module" data-type="indexterm" id="idm44924511832432"/><a contenteditable="false" data-primary="shelve module" data-type="indexterm" id="idm44924511786272"/><a contenteditable="false" data-primary="standard library modules" data-secondary="shelve" data-type="indexterm" id="idm44924511785296"/> <span class="code">shelve</span> module orchestrates the modules <span class="code">pickle</span>, <span class="code">io</span>, and <span class="code">dbm</span> (and its underlying modules for access to DBM-like archive files, as discussed in the following section) in order to provide a simple, lightweight persistence mechanism.</p>
<p><span class="code">shelve</span> supplies a function, <span class="code">open</span>, that is polymorphic to <span class="code">dbm.open</span>. The mapping <span class="code"><em>s</em></span> returned by <span class="code">shelve.open</span> is less limited, however, than the mapping <span class="code"><em>a</em></span> returned by <span class="code">dbm.open</span>. <span class="code"><em>a</em></span>’s keys and values must be strings.<sup><a data-type="noteref" href="ch12.xhtml#idm44924511774592" id="idm44924511774592-marker">3</a></sup> <span class="code"><em>s</em></span>’s keys must also be strings, but <span class="code"><em>s</em></span>’s values may be of any pickleable types. <span class="code">pickle</span> customizations (<span class="code">copyreg</span>, <span class="code">__getnewargs__</span>, <span class="code">__getstate__</span>, and <span class="code">__setstate__</span>) also apply to <span class="code">shelve</span>, as <span class="code">shelve</span> delegates serialization to <span class="code">pickle</span>. Keys and values are stored as bytes. When strings are used, they are implicitly converted to the default encoding before being stored.</p>
<p>Beware of a subtle trap when you use <span class="code">shelve</span> with mutable objects: when you operate on a mutable object held in a shelf, the changes aren’t stored back unless you assign the changed object back to the same index. For example:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">shelve</code><code>
</code><code class="n">s</code><code> </code><code class="o">=</code><code> </code><code class="n">shelve</code><code class="o">.</code><code class="n">open</code><code class="p">(</code><code class="s1">'</code><code class="s1">data</code><code class="s1">'</code><code class="p">)</code><code>
</code><code class="n">s</code><code class="p">[</code><code class="s1">'</code><code class="s1">akey</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="nb">list</code><code class="p">(</code><code class="nb">range</code><code class="p">(</code><code class="mi">4</code><code class="p">)</code><code class="p">)</code><code>
</code><code class="nb">print</code><code class="p">(</code><code class="n">s</code><code class="p">[</code><code class="s1">'</code><code class="s1">akey</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>           </code><em><code class="c1"># prints: [0, 1, 2, 3]</code></em><code>
</code><code class="n">s</code><code class="p">[</code><code class="s1">'</code><code class="s1">akey</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="mi">9</code><code class="p">)</code><code>        </code><em><code class="c1"># trying direct mutation</code></em><code>
</code><code class="nb">print</code><code class="p">(</code><code class="n">s</code><code class="p">[</code><code class="s1">'</code><code class="s1">akey</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>           </code><em><code class="c1"># doesn't "take"; prints: [0, 1, 2, 3]</code></em><code>
</code><code class="n">x</code><code> </code><code class="o">=</code><code> </code><code class="n">s</code><code class="p">[</code><code class="s1">'</code><code class="s1">akey</code><code class="s1">'</code><code class="p">]</code><code>              </code><em><code class="c1"># fetch the object</code></em><code>
</code><code class="n">x</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="mi">9</code><code class="p">)</code><code>                </code><em><code class="c1"># perform mutation</code></em><code>
</code><code class="n">s</code><code class="p">[</code><code class="s1">'</code><code class="s1">akey</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">x</code><code>              </code><em><code class="c1"># key step: store the object back!</code></em><code>
</code><code class="nb">print</code><code class="p">(</code><code class="n">s</code><code class="p">[</code><code class="s1">'</code><code class="s1">akey</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>           </code><em><code class="c1"># now it "takes", prints: [0, 1, 2, 3, 9]</code></em></pre>
<p>You can finesse this issue by passing the named argument <span class="code">writeback=</span><span class="code"><strong>True</strong></span> when you call <span class="code">shelve.open</span>, but this can seriously impair the performance of your <span class="keep-together">program</span>.</p>
<section data-pdf-bookmark="A shelving example" data-type="sect3"><div class="sect3" id="a_shelving_example">
<h3>A shelving example</h3>
<p>The following example handles the same task as the earlier <span class="code">json</span> and <span class="code">pickle</span> examples, but uses <span class="code">shelve</span> to persist lists of <span class="code">(<em>filename</em>,</span> <span class="code"><em>linenumber</em></span><span class="code">)</span> pairs:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">collections</code><code class="o">,</code><code> </code><code class="nn">fileinput</code><code class="o">,</code><code> </code><code class="nn">shelve</code><code>
</code><code class="n">word_pos</code><code> </code><code class="o">=</code><code> </code><code class="n">collections</code><code class="o">.</code><code class="n">defaultdict</code><code class="p">(</code><code class="nb">list</code><code class="p">)</code><code>
</code><strong><code class="k">for</code></strong><code> </code><code class="n">line</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">fileinput</code><code class="o">.</code><code class="n">input</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">pos</code><code> </code><code class="o">=</code><code> </code><code class="n">fileinput</code><code class="o">.</code><code class="n">filename</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">fileinput</code><code class="o">.</code><code class="n">filelineno</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><strong><code class="k">for</code></strong><code> </code><code class="n">word</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">line</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="n">word_pos</code><code class="p">[</code><code class="n">word</code><code class="p">]</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">pos</code><code class="p">)</code><code>
</code><strong><code class="k">with</code></strong><code> </code><code class="n">shelve</code><code class="o">.</code><code class="n">open</code><code class="p">(</code><code class="s1">'</code><code class="s1">indexfiles</code><code class="s1">'</code><code class="p">,</code><code class="s1">'</code><code class="s1">n</code><code class="s1">'</code><code class="p">)</code><code> </code><strong><code class="k">as</code></strong><code> </code><code class="n">sh_out</code><code class="p">:</code><code>
</code><code>    </code><code class="n">sh_out</code><code class="o">.</code><code class="n">update</code><code class="p">(</code><code class="n">word_pos</code><code class="p">)</code></pre>
<p>We must then use <span class="code">shelve</span> to read back the data stored to the DBM-like file <em>indexfiles</em>, as shown in the following example:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">sys</code><code class="o">,</code><code> </code><code class="nn">shelve</code><code class="o">,</code><code> </code><code class="nn">linecache</code><code>
</code><strong><code class="k">with</code></strong><code> </code><code class="n">shelve</code><code class="o">.</code><code class="n">open</code><code class="p">(</code><code class="s1">'</code><code class="s1">indexfiles</code><code class="s1">'</code><code class="p">)</code><code> </code><strong><code class="k">as</code></strong><code> </code><code class="n">sh_in</code><code class="p">:</code><code>
</code><strong><code>    </code><code class="k">for</code></strong><code> </code><code class="n">word</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">sys</code><code class="o">.</code><code class="n">argv</code><code class="p">[</code><code class="mi">1</code><code class="p">:</code><code class="p">]</code><code class="p">:</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="n">word</code><code> </code><strong><code class="ow">not</code><code> </code><code class="ow">in</code></strong><code> </code><code class="n">sh_in</code><code class="p">:</code><code>
</code><code>            </code><code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s1">'</code><code class="s1">Word </code><code class="si">{</code><code class="n">word</code><code class="si">!r}</code><code class="s1"> not found in index file</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>			      </code><code class="n">file</code><code class="o">=</code><code class="n">sys</code><code class="o">.</code><code class="n">stderr</code><code class="p">)</code><code>
</code><strong><code>            </code><code class="k">continue</code></strong><code>
</code><code>        </code><code class="n">places</code><code> </code><code class="o">=</code><code> </code><code class="n">sh_in</code><code class="p">[</code><code class="n">word</code><code class="p">]</code><code>
</code><code>        </code><strong><code class="k">for</code></strong><code> </code><code class="n">fname</code><code class="p">,</code><code> </code><code class="n">lineno</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">places</code><code class="p">:</code><code>
</code><code>            </code><code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s1">'</code><code class="s1">Word </code><code class="si">{</code><code class="n">word</code><code class="si">!r}</code><code class="s1"> occurs in line </code><code class="si">{</code><code class="n">lineno</code><code class="si">}</code><code class="s1">'</code><code>
</code><code>                  </code><code class="sa">f</code><code class="s1">'</code><code class="s1"> of file </code><code class="si">{</code><code class="n">fname</code><code class="si">!r}</code><code class="s1">:</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>            </code><code class="nb">print</code><code class="p">(</code><code class="n">linecache</code><code class="o">.</code><code class="n">getline</code><code class="p">(</code><code class="n">fname</code><code class="p">,</code><code> </code><code class="n">lineno</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">end</code><code class="o">=</code><code class="s1">'</code><code class="s1">'</code><code class="p">)</code></pre>
<p>These two examples are the simplest and most direct of the various equivalent pairs of examples shown throughout this section. This reflects the fact that <span class="code">shelve</span> is higher level than the modules used in previous examples.<a contenteditable="false" data-primary="" data-startref="serail12" data-type="indexterm" id="idm44924511368288"/><a contenteditable="false" data-primary="" data-startref="PADserial12" data-type="indexterm" id="idm44924511367072"/></p>
</div></section>
</div></section>
</div></section>
<section data-pdf-bookmark="DBM Modules" data-type="sect1"><div class="sect1" id="dbm_modules">
<h1>DBM Modules</h1>
<p><a href="https://oreil.ly/osARc">DBM</a>, a<a contenteditable="false" data-primary="DBM (DataBase Manager) modules" data-type="indexterm" id="DBMmod12"/><a contenteditable="false" data-primary="DataBase Manager (DBM) modules" data-type="indexterm" id="dataman12"/><a contenteditable="false" data-primary="persistence and databases" data-secondary="DBM modules" data-type="indexterm" id="PADdbm12"/><a contenteditable="false" data-primary="standard library modules" data-secondary="dbm" data-type="indexterm" id="idm44924511381504"/> longtime Unix mainstay, is a family of libraries supporting data files containing pairs of bytestrings <span class="code">(<em>key</em>,</span> <span class="code"><em>data</em></span><span class="code">)</span>. DBM offers fast fetching and storing of the data given a key, a usage pattern known as<a contenteditable="false" data-primary="keyed access" data-type="indexterm" id="idm44924511329312"/> <em>keyed access</em>. Keyed access, while nowhere near as powerful as the data access functionality of relational DBs, imposes less overhead, and it may suffice for some programs’ needs. If DBM-like files are sufficient for your purposes, with this approach you can end up with a program that is smaller and faster than one using a relational DB.</p>
<div data-type="note" epub:type="note">
<h1>DBM Databases Are Bytes-Oriented</h1>
<p>DBM databases require both keys and values to be bytes values. You will see in the example included later that the text input is explicitly encoded in UTF-8 before storage. Similarly, the inverse decoding must be performed when reading back the values.</p>
</div>
<p>DBM support in Python’s standard library is organized in a clean and elegant way: the <span class="code">dbm</span> package exposes two general functions, and within the same package live other modules supplying specific implementations.</p>
<div data-type="tip">
<h1>Berkeley DB Interfacing</h1>
<p>The<a contenteditable="false" data-primary="Berkeley DB library" data-type="indexterm" id="idm44924511324176"/> <span class="code">bsddb</span> module has been removed from the Python standard library. If you need to interface to a BSD DB archive, we recommend the excellent third-party package<a contenteditable="false" data-primary="bsddb3 package" data-type="indexterm" id="idm44924511322288"/> <a href="https://oreil.ly/xizEg">bsddb3</a>.</p>
</div>
<section data-pdf-bookmark="The dbm Package" data-type="sect2"><div class="sect2" id="the_dbm_package">
<h2>The dbm Package</h2>
<p>The <span class="code">dbm</span> package provides the top-level functions described in <a data-type="xref" href="#functions_of_the_dbm_package">Table 12-6</a>.</p>
<table class="border" id="functions_of_the_dbm_package">
<caption><span class="label">Table 12-6. </span>Functions of the <span class="code">dbm</span> package</caption>
<tbody>
<tr>
<td><span class="code">open</span></td>
<td><span class="code">open(<em>filepath</em>, flag='r', mode=0o666)</span><br/>
			Opens or creates the DBM file named by <span class="code"><em>filepath</em></span> (any path to a file) and returns a mapping object corresponding to the DBM file. When the DBM file already exists, <span class="code">open</span> uses the function <span class="code">whichdb</span> to determine which DBM submodule can handle the file. When <span class="code">open</span> creates a new DBM file, it chooses the first available <span class="code">dbm</span> submodule in the following order of preference: <span class="code">gnu</span>, <span class="code">ndbm</span>, <span class="code">dumb</span>.<br/>
<span class="code">flag</span> is a one-character string that tells <span class="code">open</span> how to open the file and whether to create it, according to the rules shown in <a data-type="xref" href="#flag_values_for_dbmdotopen">Table 12-7</a>. <span class="code">mode</span> is an integer that <span class="code">open</span> uses as the file’s permission bits if <span class="code">open</span> creates the file, as covered in <a data-type="xref" href="ch11.xhtml#creating_a_file_object_with_open">“Creating a File Object with open”</a>.
			<table class="border" id="flag_values_for_dbmdotopen">
<caption><span class="label">Table 12-7. </span>Flag values for <span class="code">dbm.open</span></caption>
<thead>
<tr>
<th>Flag</th>
<th>Read-only?</th>
<th>If file exists:</th>
<th>If file does not exist:</th>
</tr>
</thead>
<tbody>
<tr>
<td><span class="code">'r'</span></td>
<td>Yes</td>
<td>Opens the file</td>
<td>Raises error</td>
</tr>
<tr>
<td><span class="code">'w'</span></td>
<td>No</td>
<td>Opens the file</td>
<td>Raises error</td>
</tr>
<tr>
<td><span class="code">'c'</span></td>
<td>No</td>
<td>Opens the file</td>
<td>Creates the file</td>
</tr>
<tr>
<td><span class="code">'n'</span></td>
<td>No</td>
<td>Truncates the file</td>
<td>Creates the file</td>
</tr>
</tbody>
</table>
<span class="code">dbm.open</span> returns a mapping object <span class="code"><em>m</em></span> with a subset of the functionality of dictionaries (covered in <a data-type="xref" href="ch03.xhtml#dictionary_operation">“Dictionary Operations”</a>). <span class="code"><em>m</em></span> only accepts <span class="code">bytes</span> as keys and values, and the only nonspecial mapping methods <span class="code"><em>m</em></span> supplies are <span class="code"><em>m</em></span><span class="code">.get</span>, <span class="code"><em>m</em></span><span class="code">.keys</span>, and <span class="code"><em>m</em></span><span class="code">.setdefault</span>. You can bind, rebind, access, and unbind items in <span class="code"><em>m</em></span> with the same indexing syntax <span class="code"><em>m</em></span><span class="code">[<em>key</em>]</span> that you would use if <span class="code"><em>m</em></span> were a dictionary. If <span class="code">flag</span> is <span class="code">'r'</span>, <span class="code"><em>m</em></span> is read-only, so that you can only access <span class="code"><em>m</em></span>’s items, not bind, rebind, or unbind them. You can check if a string <span class="code"><em>s</em></span> is a key in <span class="code"><em>m</em></span> with the usual expression <span class="code"><em>s</em></span> <span class="code"><strong>in</strong></span> <span class="code"><em>m</em></span>; you cannot iterate directly on <span class="code"><em>m</em></span>, but you can, equivalently, iterate on <span class="code"><em>m</em></span><span class="code">.keys()</span>.<br/>
			One extra method that <span class="code"><em>m</em></span> supplies is <span class="code"><em>m</em></span><span class="code">.close</span>, with the same semantics as the <span class="code">close</span> method of a file object. Just like for file objects, you should ensure <span class="code"><em>m</em></span><span class="code">.close</span> is called when you’re done using <span class="code"><em>m</em></span>. The <span class="code"><strong>try</strong></span><span class="code">/</span><span class="code"><strong>finally</strong></span> statement (covered in <a data-type="xref" href="ch06.xhtml#trysolidusfinally">“try/finally”</a>) is one way to ensure finalization, but the <span class="code"><strong>with</strong></span> statement, covered in <a data-type="xref" href="ch06.xhtml#the_with_statement_and_context_managers">“The with Statement and Context Managers”</a>, is even better (you can use <span class="code"><strong>with</strong></span>, since <span class="code"><em>m</em></span> is a context manager).</td>
</tr>
<tr>
<td><span class="code">whichdb</span></td>
<td colspan="3"><span class="code">whichdb(<em>filepath</em>)</span><br/>
			Opens and reads the file specified by <span class="code"><em>filepath</em></span> to discover which <span class="code">dbm</span> submodule created the file. <span class="code">whichdb</span> returns <span class="code"><strong>None</strong></span> when the file does not exist or cannot be opened and read. It returns <span class="code">''</span> when the file exists and can be opened and read, but it is not possible to determine which <span class="code">dbm</span> submodule created the file (typically, this means that the file is not a DBM file). If it can find out which module can read the DBM-like file, <span class="code">whichdb</span> returns a string that names a <span class="code">dbm</span> submodule, such as <span class="code">'dbm.ndbm'</span>, <span class="code">'dbm.dumb'</span>, or <span class="code">'dbm.gdbm'</span>.</td>
</tr>
</tbody>
</table>
<p>In addition to these two top-level functions, the <span class="code">dbm</span> package contains specific modules, such as <span class="code">ndbm</span>, <span class="code">gnu</span>, and <span class="code">dumb</span>, that provide various implementations of DBM functionality, which you normally access only via the these top-level functions. Third-party packages can install further implementation modules in <span class="code">dbm</span>.</p>
<p>The only implementation module of the <span class="code">dbm</span> package that’s guaranteed to exist on all platforms is <span class="code">dumb</span>. <span class="code">dumb</span> has minimal DBM functionality and mediocre performance; its only advantage is that you can use it anywhere, since <span class="code">dumb</span> does not rely on any library. You don’t normally <span class="code"><strong>import</strong></span> <span class="code">dbm.dumb</span>: rather, <span class="code"><strong>import</strong></span> <span class="code">dbm</span>, and let <span class="code">dbm.open</span> supply the best DBM module available, defaulting to <span class="code">dumb</span> if no better submodule is available in the current Python installation. The only case in which you import <span class="code">dumb</span> directly is the rare one in which you need to create a DBM-like file that must be readable in any Python installation. The <span class="code">dumb</span> module supplies an <span class="code">open</span> function polymorphic to <span class="code">dbm</span>’s.</p>
</div></section>
<section data-pdf-bookmark="Examples of DBM-Like File Use" data-type="sect2"><div class="sect2" id="examples_of_dbm_like_file_use">
<h2>Examples of DBM-Like File Use</h2>
<p>DBM’s keyed access is suitable when your program needs to record persistently the equivalent of a Python dictionary, with strings as both keys and values. For example, suppose you need to analyze several text files, whose names are given as your program’s arguments, and record where each word appears in those files. In this case, the keys are words and, therefore, intrinsically strings. The data you need to record for each word is a list of <span class="code">(<em>filename</em>,</span> <span class="code"><em>linenumber</em></span><span class="code">)</span> pairs. However, you can encode the data as a string in several ways—for example, by exploiting the fact that the path separator string, <span class="code">os.pathsep</span> (covered in <a data-type="xref" href="ch11.xhtml#path_string_attributes_of_the_os_module">“Path-string attributes of the os module”</a>), does not normally appear in filenames. (More general approaches to the issue of encoding data as strings were covered in the opening section of this chapter, with the same example.) With this simplification, a program to record word positions in files might be as follows:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">collections</code><code class="o">,</code><code> </code><code class="nn">fileinput</code><code class="o">,</code><code> </code><code class="nn">os</code><code class="o">,</code><code> </code><code class="nn">dbm</code><code>
</code><code class="n">word_pos</code><code> </code><code class="o">=</code><code> </code><code class="n">collections</code><code class="o">.</code><code class="n">defaultdict</code><code class="p">(</code><code class="nb">list</code><code class="p">)</code><code>
</code><strong><code class="k">for</code></strong><code> </code><code class="n">line</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">fileinput</code><code class="o">.</code><code class="n">input</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">pos</code><code> </code><code class="o">=</code><code> </code><code class="sa">f</code><code class="s1">'</code><code class="si">{</code><code class="n">fileinput</code><code class="o">.</code><code class="n">filename</code><code class="p">(</code><code class="p">)</code><code class="si">}</code><code class="si">{</code><code class="n">os</code><code class="o">.</code><code class="n">pathsep</code><code class="si">}</code><code class="si">{</code><code class="n">fileinput</code><code class="o">.</code><code class="n">filelineno</code><code class="p">(</code><code class="p">)</code><code class="si">}</code><code class="s1">'</code><code>
</code><code>    </code><strong><code class="k">for</code></strong><code> </code><code class="n">word</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">line</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="n">word_pos</code><code class="p">[</code><code class="n">word</code><code class="p">]</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">pos</code><code class="p">)</code><code>
</code><code class="n">sep2</code><code> </code><code class="o">=</code><code> </code><code class="n">os</code><code class="o">.</code><code class="n">pathsep</code><code> </code><code class="o">*</code><code> </code><code class="mi">2</code><code>
</code><strong><code class="k">with</code></strong><code> </code><code class="n">dbm</code><code class="o">.</code><code class="n">open</code><code class="p">(</code><code class="s1">'</code><code class="s1">indexfile</code><code class="s1">'</code><code class="p">,</code><code class="s1">'</code><code class="s1">n</code><code class="s1">'</code><code class="p">)</code><code> </code><strong><code class="k">as</code></strong><code> </code><code class="n">dbm_out</code><code class="p">:</code><code>
</code><code>    </code><strong><code class="k">for</code></strong><code> </code><code class="n">word</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">word_pos</code><code class="p">:</code><code>
</code><code>        </code><code class="n">dbm_out</code><code class="p">[</code><code class="n">word</code><code class="o">.</code><code class="n">encode</code><code class="p">(</code><code class="s1">'</code><code class="s1">utf-8</code><code class="s1">'</code><code class="p">)</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">sep2</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code>
</code><code>			</code><code class="n">word_pos</code><code class="p">[</code><code class="n">word</code><code class="p">]</code><code>
</code><code>		</code><code class="p">)</code><code class="o">.</code><code class="n">encode</code><code class="p">(</code><code class="s1">'</code><code class="s1">utf-8</code><code class="s1">'</code><code class="p">)</code></pre>
<p>You can read back the data stored to the DBM-like file<a contenteditable="false" data-primary="indexfile" data-type="indexterm" id="idm44924511061616"/> <em>indexfile</em> in several ways. The following example accepts words as command-line arguments and prints the lines where the requested words<a contenteditable="false" data-primary="" data-startref="DBMmod12" data-type="indexterm" id="idm44924511064448"/><a contenteditable="false" data-primary="" data-startref="dataman12" data-type="indexterm" id="idm44924511063232"/><a contenteditable="false" data-primary="" data-startref="PADdbm12" data-type="indexterm" id="idm44924511084608"/> appear:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">sys</code><code class="o">,</code><code> </code><code class="nn">os</code><code class="o">,</code><code> </code><code class="nn">dbm</code><code class="o">,</code><code> </code><code class="nn">linecache</code><code>
</code><code>
</code><code class="n">sep</code><code> </code><code class="o">=</code><code> </code><code class="n">os</code><code class="o">.</code><code class="n">pathsep</code><code>
</code><code class="n">sep2</code><code> </code><code class="o">=</code><code> </code><code class="n">sep</code><code> </code><code class="o">*</code><code> </code><code class="mi">2</code><code>
</code><strong><code class="k">with</code></strong><code> </code><code class="n">dbm</code><code class="o">.</code><code class="n">open</code><code class="p">(</code><code class="s1">'</code><code class="s1">indexfile</code><code class="s1">'</code><code class="p">)</code><code> </code><strong><code class="k">as</code></strong><code> </code><code class="n">dbm_in</code><code class="p">:</code><code>
</code><strong><code>    </code><code class="k">for</code></strong><code> </code><code class="n">word</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">sys</code><code class="o">.</code><code class="n">argv</code><code class="p">[</code><code class="mi">1</code><code class="p">:</code><code class="p">]</code><code class="p">:</code><code>
</code><code>        </code><code class="n">e_word</code><code> </code><code class="o">=</code><code> </code><code class="n">word</code><code class="o">.</code><code class="n">encode</code><code class="p">(</code><code class="s1">'</code><code class="s1">utf-8</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>        </code><strong><code class="k">if</code></strong><code> </code><code class="n">e_word</code><code> </code><strong><code class="ow">not</code></strong><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">dbm_in</code><code class="p">:</code><code>
</code><code>            </code><code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s1">'</code><code class="s1">Word </code><code class="si">{</code><code class="n">word</code><code class="si">!r}</code><code class="s1"> not found in index file</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>                  </code><code class="n">file</code><code class="o">=</code><code class="n">sys</code><code class="o">.</code><code class="n">stderr</code><code class="p">)</code><code>
</code><code>            </code><strong><code class="k">continue</code></strong><code>
</code><code>        </code><code class="n">places</code><code> </code><code class="o">=</code><code> </code><code class="n">dbm_in</code><code class="p">[</code><code class="n">e_word</code><code class="p">]</code><code class="o">.</code><code class="n">decode</code><code class="p">(</code><code class="s1">'</code><code class="s1">utf-8</code><code class="s1">'</code><code class="p">)</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="n">sep2</code><code class="p">)</code><code>
</code><code>        </code><strong><code class="k">for</code></strong><code> </code><code class="n">place</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">places</code><code class="p">:</code><code>
</code><code>            </code><code class="n">fname</code><code class="p">,</code><code> </code><code class="n">lineno</code><code> </code><code class="o">=</code><code> </code><code class="n">place</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="n">sep</code><code class="p">)</code><code>
</code><code>            </code><code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s1">'</code><code class="s1">Word </code><code class="si">{</code><code class="n">word</code><code class="si">!r}</code><code class="s1"> occurs in line </code><code class="si">{</code><code class="n">lineno</code><code class="si">}</code><code class="s1">'</code><code>
</code><code>                  </code><code class="sa">f</code><code class="s1">'</code><code class="s1"> of file </code><code class="si">{</code><code class="n">fname</code><code class="si">!r}</code><code class="s1">:</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>            </code><code class="nb">print</code><code class="p">(</code><code class="n">linecache</code><code class="o">.</code><code class="n">getline</code><code class="p">(</code><code class="n">fname</code><code class="p">,</code><code> </code><code class="nb">int</code><code class="p">(</code><code class="n">lineno</code><code class="p">)</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">end</code><code class="o">=</code><code class="s1">'</code><code class="s1">'</code><code class="p">)</code></pre>
</div></section>
</div></section>
<section data-pdf-bookmark="The Python Database API (DBAPI)" data-type="sect1"><div class="sect1" id="the_python_database_api_left_parenthesi">
<h1>The Python Database API (DBAPI)</h1>
<p>As<a contenteditable="false" data-primary="DBAPI" data-see="Database API" data-type="indexterm" id="idm44924510847120"/><a contenteditable="false" data-primary="Python Database API 2.0 standard (DBAPI)" data-see="Database API" data-type="indexterm" id="idm44924510845904"/><a contenteditable="false" data-primary="persistence and databases" data-secondary="Python Database API 2.0 standard (DBAPI)" data-type="indexterm" id="PADdstand12"/> we mentioned earlier, the Python standard library does not come with an RDBMS interface (except for <span class="code">sqlite3</span>, covered in <a data-type="xref" href="#sqlite">“SQLite”</a>, which is a rich implementation, not just an interface). Many third-party modules let your Python programs access specific DBs. Such modules mostly follow the Python Database API 2.0 standard, aka the DBAPI, as specified in <a href="https://oreil.ly/-yhzm">PEP 249</a>.</p>
<p>After<a contenteditable="false" data-primary="Database API 2.0 standard (DBAPI)" data-secondary="importing DBAPI-compliant modules" data-type="indexterm" id="idm44924510865696"/> importing any DBAPI-compliant module, you can call the module’s <span class="code">connect</span> function with DB-specific parameters. <span class="code">connect</span> returns <span class="code"><em>x</em></span>, an instance of <span class="code">Connection</span>, which represents a connection to the DB. <span class="code"><em>x</em></span> supplies <span class="code">commit</span> and <span class="code">rollback</span> methods to deal with transactions, a <span class="code">close</span> method to call as soon as you’re done with the DB, and a <span class="code">cursor</span> method to return <span class="code"><em>c</em></span>, an instance of <span class="code">Cursor</span>. <span class="code"><em>c</em></span> supplies the methods and attributes used for DB operations. A DBAPI-compliant module also supplies exception classes, descriptive attributes, factory functions, and type-description attributes.</p>
<section data-pdf-bookmark="Exception Classes" data-type="sect2"><div class="sect2" id="exception_classes">
<h2>Exception Classes</h2>
<p>A DBAPI-compliant module<a contenteditable="false" data-primary="Database API 2.0 standard (DBAPI)" data-secondary="exception classes" data-type="indexterm" id="idm44924510792400"/><a contenteditable="false" data-primary="exception classes" data-type="indexterm" id="idm44924510791184"/> supplies the exception classes <span class="code">Warning</span>, <span class="code">Error</span>, and several subclasses of <span class="code">Error</span>. <span class="code">Warning</span> indicates anomalies such as data truncation on insertion. <span class="code">Error</span>’s subclasses indicate various kinds of errors that your program can encounter when dealing with the DB and the DBAPI-compliant module that interfaces to it. Generally, your code uses a statement of the form:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="k">try</code></strong><code class="p">:</code><code>
</code><code>    </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code>
</code><strong><code class="k">except</code></strong><code> </code><code class="n">module</code><code class="o">.</code><code class="n">Error</code><code> </code><strong><code class="k">as</code></strong><code> </code><code class="n">err</code><code class="p">:</code><code>
</code><code>    </code><code class="o">.</code><code class="o">.</code><code class="o">.</code></pre>
<p>to trap all DB-related errors that you need to handle without terminating.</p>
</div></section>
<section data-pdf-bookmark="Thread Safety" data-type="sect2"><div class="sect2" id="thread_safety">
<h2>Thread Safety</h2>
<p>When<a contenteditable="false" data-primary="Database API 2.0 standard (DBAPI)" data-secondary="thread safety" data-type="indexterm" id="idm44924510769568"/><a contenteditable="false" data-primary="thread safety" data-type="indexterm" id="idm44924510768192"/> a DBAPI-compliant module has a <span class="code">threadsafety</span> attribute greater than <span class="code">0</span>, the module is asserting some level of thread safety for DB interfacing. Rather than relying on this, it’s usually safer, and always more portable, to ensure that a single thread has exclusive access to any given external resource, such as a DB, as outlined in <a data-type="xref" href="ch15.xhtml#threaded_program_architecture">“Threaded Program Architecture”</a>.</p>
</div></section>
<section data-pdf-bookmark="Parameter Style" data-type="sect2"><div class="sect2" id="parameter_style">
<h2>Parameter Style</h2>
<p>A<a contenteditable="false" data-primary="Database API 2.0 standard (DBAPI)" data-secondary="parameter style" data-type="indexterm" id="idm44924510737616"/><a contenteditable="false" data-primary="parameter style (DBAPI-compliant)" data-type="indexterm" id="idm44924510736400"/> DBAPI-compliant module has an attribute called <span class="code">paramstyle</span> to identify the style of markers used as placeholders for parameters. Insert such markers in SQL statement strings that you pass to methods of <span class="code">Cursor</span> instances, such as the method <span class="code">execute</span>, to use runtime-determined parameter values. Say, for example, that you need to fetch the rows of DB table <span class="code"><em>ATABLE</em></span> where field <span class="code"><em>AFIELD</em></span> equals the current value of Python variable <span class="code"><em>x</em></span>. Assuming the cursor instance is named <span class="code"><em>c</em></span>, you <em>could</em> theoretically (but very ill-advisedly!) perform this task with Python’s string formatting:</p>
<pre data-code-language="python" data-type="programlisting">
<code class="n">c</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="sa">f</code><code class="s1">'SELECT * FROM ATABLE WHERE AFIELD=</code><code class="si">{</code><code class="n">x</code><code class="si">!r}</code><code class="s1">'</code><code class="p">)</code></pre>
<div data-type="warning" epub:type="warning">
<h1>Avoid SQL Query String Formatting: Use Parameter Substitution</h1>
<p>String formatting<a contenteditable="false" data-primary="strings" data-secondary="string formatting" data-type="indexterm" id="idm44924510719456"/> is <em>not</em> the recommended approach. It generates a different string for each value of <span class="code"><em>x</em></span>, requiring statements to be parsed and prepared anew each time; it also opens up the possibility of security weaknesses, such as<a contenteditable="false" data-primary="SQL injection attacks" data-type="indexterm" id="idm44924510716768"/> <a href="https://oreil.ly/hpUlv">SQL injection</a> vulnerabilities. With<a contenteditable="false" data-primary="parameter substitution" data-type="indexterm" id="idm44924510714848"/> parameter substitution, you pass to <span class="code">execute</span> a single statement string, with a placeholder instead of the parameter value. This lets <span class="code">execute</span> parse and prepare the statement just once, for better performance; more importantly, parameter substitution improves solidity and security, hampering SQL injection attacks.</p>
</div>
<p>For example, when a module’s <span class="code">paramstyle</span> attribute (described next) is <span class="code">'qmark'</span>, you could express the preceding query as:</p>
<pre data-code-language="python" data-type="programlisting">
<code class="n">c</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s1">'SELECT * FROM ATABLE WHERE AFIELD=?'</code><code class="p">,</code> <code class="p">(</code><code class="n">some_value</code><code class="p">,))</code></pre>
<p>The read-only string attribute <span class="code">paramstyle</span> tells your program how it should use parameter substitution with that module. The possible values of <span class="code">paramstyle</span> are shown in <a data-type="xref" href="#possible_values_of_the_paramstyle_attri">Table 12-8</a>.</p>
<table class="border" id="possible_values_of_the_paramstyle_attri">
<caption><span class="label">Table 12-8. </span>Possible values of the <span class="code">paramstyle</span> attribute</caption>
<tbody>
<tr>
<td class="width-15"><span class="code">format</span></td>
<td>The<a contenteditable="false" data-primary="% (percent sign)" data-secondary="SQL statement placeholder" data-type="indexterm" id="idm44924510662656"/><a contenteditable="false" data-primary="percent sign (%)" data-secondary="SQL statement placeholder" data-type="indexterm" id="idm44924510661280"/> marker is <span class="code">%s</span>, as in old-style string formatting (always with <span class="code">s</span>: never use other type indicator letters, whatever the data’s type). A query looks like:
			<pre data-code-language="python" data-type="programlisting">
<code class="n">c</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s1">'SELECT * FROM ATABLE WHERE AFIELD=</code><code class="si">%s</code><code class="s1">'</code><code class="p">,</code> 
          <code class="p">(</code><code class="n">some_value</code><code class="p">,))</code></pre>
</td>
</tr>
<tr>
<td><span class="code">named</span></td>
<td>The marker is <span class="code">:</span><span class="code"><em>name</em></span>, and parameters are named. A query looks like:
			<pre data-code-language="python" data-type="programlisting">
<code class="n">c</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s1">'SELECT * FROM ATABLE WHERE AFIELD=:x'</code><code class="p">,</code> 
          <code class="p">{</code><code class="s1">'x'</code><code class="p">:</code><code class="n">some_value</code><code class="p">})</code></pre>
</td>
</tr>
<tr>
<td><span class="code">numeric</span></td>
<td>The marker is <span class="code">:n</span>, giving the parameter’s number, 1 and up. A query looks like:
			<pre data-code-language="python" data-type="programlisting">
<code class="n">c</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s1">'SELECT * FROM ATABLE WHERE AFIELD=:1'</code><code class="p">,</code> 
          <code class="p">(</code><code class="n">some_value</code><code class="p">,))</code></pre>
</td>
</tr>
<tr>
<td><span class="code">pyformat</span></td>
<td>The marker is <span class="code">%(<em>name</em>)s</span>, and parameters are named. Always use <span class="code">s</span>: never use other type indicator letters, whatever the data’s type. A query looks like:
			<pre data-code-language="python" data-type="programlisting">
<code class="n">c</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s1">'SELECT * FROM ATABLE WHERE AFIELD=</code><code class="si">%(x)s</code><code class="s1">'</code><code class="p">,</code>
          <code class="p">{</code><code class="s1">'x'</code><code class="p">:</code><code class="n">some_value</code><code class="p">})</code></pre>
</td>
</tr>
<tr>
<td><span class="code">qmark</span></td>
<td>The marker is <span class="code">?</span>. A query looks like:
			<pre data-code-language="python" data-type="programlisting">
<code class="n">c</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s1">'SELECT * FROM ATABLE WHERE AFIELD=?'</code><code class="p">,</code> <code class="p">(</code><code class="n">x</code><code class="p">,))</code></pre>
</td>
</tr>
</tbody>
</table>
<p>When parameters are named (i.e., when <span class="code">paramstyle</span> is <span class="code">'pyformat'</span> or <span class="code">'named'</span>), the second argument of the <span class="code">execute</span> method is a mapping. Otherwise, the second argument is a sequence.</p>
<div data-type="note" epub:type="note">
<h1>format and pyformat Only Accept Type Indicator s</h1>
<p>The <em>only</em> valid type indicator letter for <span class="code">format</span> or <span class="code">pyformat</span> is <span class="code">s</span>; neither accepts any other type indicator—for example, never use <span class="code">%d</span> or <span class="code">%(<em>name</em>)d</span>. Use<a contenteditable="false" data-primary="%s character" data-type="indexterm" id="idm44924510487584"/> <span class="code">%s</span> or <span class="code">%(<em>name</em>)s</span> for all parameter substitutions, regardless of the type of the data.</p>
</div>
</div></section>
<section data-pdf-bookmark="Factory Functions" data-type="sect2"><div class="sect2" id="factory_functions">
<h2>Factory Functions</h2>
<p>Parameters<a contenteditable="false" data-primary="Database API 2.0 standard (DBAPI)" data-secondary="factory functions" data-type="indexterm" id="idm44924510462160"/><a contenteditable="false" data-primary="factory functions (DBAPI-compliant)" data-type="indexterm" id="idm44924510460528"/> passed to the DB via placeholders must typically be of the right type: this means Python numbers (integers or floating-point values), strings (bytes or Unicode), and <span class="code"><strong>None</strong></span> to represent SQL <span class="code">NULL</span>. There is no type universally used to represent dates, times, and binary large objects (BLOBs). A DBAPI-compliant module supplies factory functions to build such objects. The types used for this purpose by most DBAPI-compliant modules are those supplied by the <span class="code">datetime</span> module (covered in <a data-type="xref" href="ch13.xhtml#time_operations">Chapter 13</a>), and strings or buffer types for BLOBs. The factory functions specified by the DBAPI are listed in <a data-type="xref" href="#dbapi_factory_functions">Table 12-9</a>. (The <span class="code">*FromTicks</span> methods take an integer timestamp <span class="code"><em>s</em></span> representing the number of seconds since the epoch of module <span class="code">time</span>, covered in <a data-type="xref" href="ch13.xhtml#time_operations">Chapter 13</a>.)</p>
<table class="border" id="dbapi_factory_functions">
<caption><span class="label">Table 12-9. </span>DBAPI factory functions</caption>
<tbody>
<tr>
<td><span class="code">Binary</span></td>
<td><span class="code">Binary(<em>string</em>)</span><br/>
			Returns an object representing the given <span class="code"><em>string</em></span> of bytes as a BLOB.</td>
</tr>
<tr>
<td><span class="code">Date</span></td>
<td><span class="code">Date(<em>year</em>,</span> <span class="code"><em>month</em></span><span class="code">,</span> <span class="code"><em>day</em></span><span class="code">)</span><br/>
			Returns an object representing the specified date.</td>
</tr>
<tr>
<td><span class="code">DateFromTicks</span></td>
<td><span class="code">DateFromTicks(<em>s</em>)</span><br/>
			Returns an object representing the date for integer timestamp <span class="code"><em>s</em></span>. For example, <span class="code">DateFromTicks(time.time())</span> means “today.”</td>
</tr>
<tr>
<td><span class="code">Time</span></td>
<td><span class="code">Time(<em>hour</em>,</span> <span class="code"><em>minute</em></span><span class="code">,</span> <span class="code"><em>second</em></span><span class="code">)</span><br/>
			Returns an object representing the specified time.</td>
</tr>
<tr>
<td><span class="code">TimeFromTicks</span></td>
<td><span class="code">TimeFromTicks(<em>s</em>)</span><br/>
			Returns an object representing the time for integer timestamp <span class="code"><em>s</em></span>. For example, <span class="code">TimeFromTicks(time.time())</span> means “the current time of day.”</td>
</tr>
<tr>
<td><span class="code">Timestamp</span></td>
<td><span class="code">Timestamp(<em>year</em>,</span> <span class="code"><em>month</em></span><span class="code">,</span> <span class="code"><em>day</em></span><span class="code">,</span> <span class="code"><em>hour</em></span><span class="code">,</span> <span class="code"><em>minute</em></span><span class="code">,</span> <span class="code"><em>second</em></span><span class="code">)</span><br/>
			Returns an object representing the specified date and time.</td>
</tr>
<tr>
<td><span class="code">TimestampFromTicks</span></td>
<td><span class="code">TimestampFromTicks(<em>s</em>)</span><br/>
			Returns an object representing the date and time for integer timestamp <span class="code"><em>s</em></span>. For example, <span class="code">TimestampFromTicks(time.time())</span> is the current date and time.</td>
</tr>
</tbody>
</table>
</div></section>
<section data-pdf-bookmark="Type Description Attributes" data-type="sect2"><div class="sect2" id="type_description_attributes">
<h2>Type Description Attributes</h2>
<p>A<a contenteditable="false" data-primary="Database API 2.0 standard (DBAPI)" data-secondary="type description attributes" data-type="indexterm" id="idm44924510409664"/> <span class="code">Cursor</span> instance’s <span class="code">description</span> attribute describes the types and other characteristics of each column of the <span class="code">SELECT</span> query you last executed on that cursor. Each column’s <em>type</em> (the second item of the tuple describing the column) equals one of the following attributes of the DBAPI-compliant module:</p>
<table class="border">
<tbody>
<tr>
<td><span class="code">BINARY</span></td>
<td>Describes columns containing BLOBs</td>
</tr>
<tr>
<td><span class="code">DATETIME</span></td>
<td>Describes columns containing dates, times, or both</td>
</tr>
<tr>
<td><span class="code">NUMBER</span></td>
<td>Describes columns containing numbers of any kind</td>
</tr>
<tr>
<td><span class="code">ROWID</span></td>
<td>Describes columns containing a row-identification number</td>
</tr>
<tr>
<td><span class="code">STRING</span></td>
<td>Describes columns containing text of any kind</td>
</tr>
</tbody>
</table>
<p>A cursor’s description, and in particular each column’s type, is mostly useful for introspection about the DB your program is working with. Such introspection can help you write general modules and work with tables using different schemas, including schemas that may not be known at the time you are writing your code.</p>
</div></section>
<section data-pdf-bookmark="The connect Function" data-type="sect2"><div class="sect2" id="the_connect_function">
<h2>The connect Function</h2>
<p>A<a contenteditable="false" data-primary="Database API 2.0 standard (DBAPI)" data-secondary="connect function" data-type="indexterm" id="idm44924510393536"/><a contenteditable="false" data-primary="connect function (DBAPI-compliant modules)" data-type="indexterm" id="idm44924510392160"/> DBAPI-compliant module’s <span class="code">connect</span> function accepts arguments that depend on the kind of DB and the specific module involved. The DBAPI standard recommends that <span class="code">connect</span> accept named arguments. In particular, <span class="code">connect</span> should at least accept optional arguments with the following names:</p>
<table class="border">
<tbody>
<tr>
<td><span class="code">database</span></td>
<td>Name of the specific database to connect to</td>
</tr>
<tr>
<td><span class="code">dsn</span></td>
<td>Name of the data source to use for the connection</td>
</tr>
<tr>
<td><span class="code">host</span></td>
<td>Hostname on which the database is running</td>
</tr>
<tr>
<td><span class="code">password</span></td>
<td>Password to use for the connection</td>
</tr>
<tr>
<td><span class="code">user</span></td>
<td>Username to use for the connection</td>
</tr>
</tbody>
</table>
</div></section>
<section data-pdf-bookmark="Connection Objects" data-type="sect2"><div class="sect2" id="connection_objects">
<h2>Connection Objects</h2>
<p>A<a contenteditable="false" data-primary="connection objects (DBAPI-compliant modules)" data-type="indexterm" id="idm44924510376592"/><a contenteditable="false" data-primary="Database API 2.0 standard (DBAPI)" data-secondary="connection objects" data-type="indexterm" id="idm44924510375392"/> DBAPI-compliant module’s <span class="code">connect</span> function returns an object <span class="code"><em>x</em></span> that is an instance of the class <span class="code">Connection</span>. <span class="code"><em>x</em></span> supplies the methods listed in <a data-type="xref" href="#methods_of_an_instance_x_of_class_conne">Table 12-10</a>.</p>
<table class="border" id="methods_of_an_instance_x_of_class_conne">
<caption><span class="label">Table 12-10. </span>Methods of an instance <span class="code">x</span> of class <span class="code">Connection</span></caption>
<tbody>
<tr>
<td class="width-20"><span class="code">close</span></td>
<td><span class="code"><em>x</em></span><span class="code">.close()</span><br/>
			Terminates the DB connection and releases all related resources. Call <span class="code">close</span> as soon as you’re done with the DB. Keeping DB connections open needlessly can be a serious resource drain on the system.</td>
</tr>
<tr>
<td><span class="code">commit</span></td>
<td><span class="code"><em>x</em></span><span class="code">.commit()</span><br/>
			Commits the current transaction in the DB. If the DB does not support transactions, <span class="code"><em>x</em></span><span class="code">.commit()</span> is an innocuous no-op.</td>
</tr>
<tr>
<td><span class="code">cursor</span></td>
<td><span class="code"><em>x</em></span><span class="code">.cursor()</span><br/>
			Returns a new instance of the class <span class="code">Cursor</span> (covered in the following section).</td>
</tr>
<tr>
<td><span class="code">rollback</span></td>
<td><span class="code"><em>x</em></span><span class="code">.rollback()</span><br/>
			Rolls back the current transaction in the DB. If the DB does not support transactions, <span class="code"><em>x</em></span><span class="code">.rollback()</span> raises an exception. The DBAPI recommends that, for DBs that do not support transactions, the class <span class="code">Connection</span> supplies no <span class="code">rollback</span> method, so that <span class="code"><em>x</em></span><span class="code">.rollback()</span> raises <span class="code">AttributeError</span>: you can test whether transactions are supported with <span class="code">hasattr(<em>x</em>,</span> <span class="code">'rollback')</span>.</td>
</tr>
</tbody>
</table>
</div></section>
<section data-pdf-bookmark="Cursor Objects" data-type="sect2"><div class="sect2" id="cursor_objects">
<h2>Cursor Objects</h2>
<p>A<a contenteditable="false" data-primary="Database API 2.0 standard (DBAPI)" data-secondary="cursor objects" data-type="indexterm" id="idm44924510341216"/><a contenteditable="false" data-primary="cursor objects (DBAPI-compliant)" data-type="indexterm" id="idm44924510339840"/> Connection instance provides a <span class="code">cursor</span> method that returns an object <span class="code"><em>c</em></span> that is an instance of the class <span class="code">Cursor</span>. A SQL cursor represents the set of results of a query and lets you work with the records in that set, in sequence, one at a time. A cursor as modeled by the DBAPI is a richer concept, since it’s the only way your program executes SQL queries in the first place. On the other hand, a DBAPI cursor allows you only to advance in the sequence of results (some relational DBs, but not all, also provide higher-functionality cursors that are able to go backward as well as forward), and does not support the SQL clause <span class="code">WHERE CURRENT OF CURSOR</span>. These limitations of DBAPI cursors enable DBAPI-compliant modules to provide DBAPI cursors even on<a contenteditable="false" data-primary="relational DB management system (RDBMS)" data-type="indexterm" id="idm44924510335504"/><a contenteditable="false" data-primary="RDBMS (relational DB management system)" data-type="indexterm" id="idm44924510334336"/> RDBMSs that supply no real SQL cursors at all. An instance <em><span class="code">c</span></em> of the class <span class="code">Cursor</span> supplies many attributes and methods; the most frequently used ones are shown in <a data-type="xref" href="#commonly_used_attributes_and_methods_of">Table 12-11</a>.</p>
<table class="border pagebreak-before less_space" id="commonly_used_attributes_and_methods_of">
<caption><span class="label">Table 12-11. </span>Commonly used attributes and methods of an instance <span class="code">c</span> of class <span class="code">Cursor</span></caption>
<tbody>
<tr>
<td class="width-15"><span class="code">close</span></td>
<td><span class="code"><em>c</em></span><span class="code">.close()</span><br/>
			Closes the cursor and releases all related resources.</td>
</tr>
<tr>
<td><span class="code">description</span></td>
<td>A read-only attribute that is a sequence of seven-item tuples, one per column in the last query executed:<br/>
<span class="code">name</span>, <span class="code">typecode</span>, <span class="code">displaysize</span>, <span class="code">internalsize</span>, <span class="code">precision</span>, <span class="code">scale</span>,<br/> <span class="code">nullable</span><br/>
<span class="code"><em>c</em></span><span class="code">.description</span> is <span class="code"><strong>None</strong></span> if the last operation on <span class="code"><em>c</em></span> was not a <span class="code">SELECT</span> query or returned no usable description of the columns involved. A cursor’s description is mostly useful for introspection about the DB your program is working with. Such introspection can help you write general modules that are able to work with tables using different schemas, including schemas that may not be fully known at the time you are writing your code.</td>
</tr>
<tr>
<td><span class="code">execute</span></td>
<td><span class="code"><em>c</em></span><span class="code">.execute(<em>statement</em>, parameters=<strong>None</strong>)</span><br/>
			Executes a SQL <span class="code"><em>statement</em></span> string on the DB with the given <span class="code">parameters</span><em>.</em> <span class="code">parameters</span> is a sequence when the module’s <span class="code">paramstyle</span> is <span class="code">'format'</span>, <span class="code">'numeric'</span>, or <span class="code">'qmark'</span>, and a mapping when <span class="code">paramstyle</span> is <span class="code">'named'</span> or <span class="code">'pyformat'</span>. Some DBAPI modules require the sequences to be specifically tuples.</td>
</tr>
<tr>
<td><span class="code">executemany</span></td>
<td><span class="code"><em>c</em></span><span class="code">.executemany(<em>statement</em>,</span> <span class="code"><em>*parameters</em></span><span class="code">)</span><br/>
			Executes a SQL <span class="code"><em>statement</em></span> on the DB, once for each item of the given <span class="code"><em>parameters</em></span>. <span class="code"><em>parameters</em></span> is a sequence of sequences when the module’s <span class="code">paramstyle</span> is <span class="code">'format'</span>, <span class="code">'numeric'</span>, or <span class="code">'qmark'</span>, and a sequence of mappings when <span class="code">paramstyle</span> is <span class="code">'named'</span> or <span class="code">'pyformat'</span>. For example, when <span class="code">paramstyle</span> is <span class="code">'qmark'</span>, the statement:
			<pre data-code-language="python" data-type="programlisting">
<code class="n">c</code><code class="o">.</code><code class="n">executemany</code><code class="p">(</code><code class="s1">'UPDATE atable SET x=? '</code>
              <code class="s1">'WHERE y=?'</code><code class="p">,(</code><code class="mi">12</code><code class="p">,</code><code class="mi">23</code><code class="p">),(</code><code class="mi">23</code><code class="p">,</code><code class="mi">34</code><code class="p">))</code></pre>
			is equivalent to—but faster than—the two statements:

			<pre data-code-language="python" data-type="programlisting">
<code class="n">c</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s1">'UPDATE atable SET x=12 WHERE y=23'</code><code class="p">)</code>
<code class="n">c</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s1">'UPDATE atable SET x=23 WHERE y=34'</code><code class="p">)</code></pre>
</td>
</tr>
<tr>
<td><span class="code">fetchall</span></td>
<td><span class="code">c.fetchall()</span><br/>
			Returns all remaining rows from the last query as a sequence of tuples. Raises an exception if the last operation was not a <span class="code">SELECT</span>.</td>
</tr>
<tr>
<td><span class="code">fetchmany</span></td>
<td><span class="code">c.fetchmany(<em>n</em>)</span><br/>
			Returns up to <span class="code"><em>n</em></span> remaining rows from the last query as a sequence of tuples. Raises an exception if the last operation was not a <span class="code">SELECT</span>.</td>
</tr>
<tr>
<td><span class="code">fetchone</span></td>
<td><span class="code">c.fetchone()</span><br/>
			Returns the next row from the last query as a tuple. Raises an exception if the last operation was not a <span class="code">SELECT</span>.</td>
</tr>
<tr>
<td><span class="code">rowcount</span></td>
<td>A read-only attribute that specifies the number of rows fetched or affected by the last operation, or <span class="code">-1</span> if the module is unable to determine this value.</td>
</tr>
</tbody>
</table>
</div></section>
<section data-pdf-bookmark="DBAPI-Compliant Modules" data-type="sect2"><div class="sect2" id="dbapi_compliant_modules">
<h2>DBAPI-Compliant Modules</h2>
<p>Whatever<a contenteditable="false" data-primary="Database API 2.0 standard (DBAPI)" data-secondary="DBAPI-compliant modules" data-type="indexterm" id="DBAPIcommod12"/><a contenteditable="false" data-primary="modules" data-secondary="DBAPI-compliant modules" data-type="indexterm" id="idm44924510196832"/> relational DB you want to use, there’s at least one (often more than one) Python DBAPI-compliant module downloadable from the internet. There are so many DBs and modules, and the set of possibilities changes so constantly, that we couldn’t possibly list them all, nor (importantly) could we maintain the list over time. Rather, we recommend you start from the community-maintained <a href="https://oreil.ly/ubKe7">wiki page</a>, which has at least a fighting chance to be complete and up-to-date at any time.</p>
<p>What follows is therefore only a very short, time-specific list of a very few DBAPI-compliant modules that, at the time of writing, are very popular and interface to very popular open source DBs:</p>
<dl>
<dt>ODBC modules</dt>
<dd>Open Database Connectivity (ODBC)<a contenteditable="false" data-primary="Open DataBase Connectivity (ODBC)" data-type="indexterm" id="idm44924510192816"/> is a standard way to connect to many different DBs, including a few not supported by other DBAPI-compliant modules. For an ODBC-compliant DBAPI-compliant module with a liberal open source license, use <a href="https://oreil.ly/MNAt9"><span class="code">pyodbc</span></a>; for a commercially supported one, use <a href="https://oreil.ly/hPUU0">mxODBC</a>.</dd>
<dt>MySQL modules</dt>
<dd>MySQL<a contenteditable="false" data-primary="MySQL modules" data-type="indexterm" id="idm44924510188944"/> is a popular open source<a contenteditable="false" data-primary="RDBMS (relational DB management system)" data-type="indexterm" id="idm44924510187680"/><a contenteditable="false" data-primary="relational DB management system (RDBMS)" data-type="indexterm" id="idm44924510186608"/> RDBMS, purchased by Oracle in 2010. Oracle’s “official” DBAPI-compliant interface to it is <a href="https://oreil.ly/iWzpg"><span class="code">mysql-connector-python</span></a>. The MariaDB project also provides a DBAPI-compliant interface, <a href="https://oreil.ly/zmCLT"><span class="code">mariadb</span></a>, connecting to both MySQL and MariaDB (a GPL-licensed fork).</dd>
<dt>PostgreSQL modules</dt>
<dd>PostgreSQL <a contenteditable="false" data-primary="PostgreSQL modules" data-type="indexterm" id="idm44924510182256"/>is another popular open source RDBMS. A widely used DBAPI-compliant interface to it is <a href="https://oreil.ly/pXc-t"><span class="code">psycopg3</span></a>, a rationalized rewrite and extension of the hallowed <a href="https://oreil.ly/gOTn7"><span class="code">psycopg2</span></a> <span class="keep-together">package</span>.</dd>
</dl>
</div></section>
<section data-pdf-bookmark="SQLite" data-type="sect2"><div class="sect2" id="sqlite">
<h2>SQLite</h2>
<p><a href="http://www.sqlite.org">SQLite</a> is<a contenteditable="false" data-primary="SQLite library (sqlite3 module)" data-type="indexterm" id="sqlite12"/><a contenteditable="false" data-primary="standard library modules" data-secondary="sqlite3" data-type="indexterm" id="SLMsqlite12"/><a contenteditable="false" data-primary="Database API 2.0 standard (DBAPI)" data-secondary="SQLite" data-type="indexterm" id="idm44924510172416"/> a C-coded library that implements a relational DB within a single file, or even in memory for sufficiently small and transient cases. Python’s standard library supplies the package <span class="code">sqlite3</span>, which is a DBAPI-compliant interface to SQLite.</p>
<p>SQLite has rich advanced functionality, with many options you can choose; <span class="code">sqlite3</span> offers access to much of that functionality, plus further possibilities to make interoperation between your Python code and the underlying DB smoother and more natural. We don’t have the space in this book to cover every nook and cranny of these two powerful software systems; instead, we focus on the subset of functions that are most commonly used and most useful. For a greater level of detail, including examples and tips on best practices, see the documentation for <a href="https://oreil.ly/-6LhJ">SQLite</a> and <a href="https://oreil.ly/S6VE1"><span class="code">sqlite3</span></a>, and Jay Kreibich’s <a class="orm:hideurl" href="https://learning.oreilly.com/library/view/using-sqlite/9781449394592"><em>Using SQLite</em></a> (O’Reilly).</p>
<p>Among others, the <span class="code">sqlite3</span> package supplies the functions in <a data-type="xref" href="#some_useful_functions_of_the_sqlitethre">Table 12-12</a>.</p>
<table class="border" id="some_useful_functions_of_the_sqlitethre">
<caption><span class="label">Table 12-12. </span>Some useful functions of the <span class="code">sqlite3</span> module</caption>
<tbody>
<tr>
<td><span class="code">connect</span></td>
<td><span class="code">connect(<em>filepath</em>, timeout=5.0, detect_types=0, isolation_level='', check_same_thread=<strong>True</strong>, factory=Connection, cached_statements=100, uri=<strong>False</strong>)</span><br/>
			Connects to the SQLite DB in the file named by <span class="code"><em>filepath</em></span> (creating it if necessary) and returns an instance of the <span class="code">Connection</span> class (or subclass thereof passed as <span class="code">factory</span>). To create an in-memory DB, pass <span class="code">':memory:'</span> as the first argument, <span class="code"><em>filepath</em></span>.<br/>
			If <span class="code"><strong>True</strong></span>, the <span class="code">uri</span> argument activates SQLite’s <a href="https://oreil.ly/S2h8r">URI functionality</a>, allowing a few extra options to be passed along with the filepath via the <span class="code"><em>filepath</em></span> argument.<br/>
<span class="code">timeout</span> is the number of seconds to wait before raising an exception if another connection is keeping the DB locked in a transaction.<br/>
<span class="code">sqlite3</span> directly supports only the following SQLite native types, converting them to the indicated Python types:
			<ul>
<li><span class="code">BLOB</span>: Converted to <span class="code">bytes</span></li>
<li><span class="code">INTEGER</span>: Converted to <span class="code">int</span></li>
<li><span class="code">NULL</span>: Converted to <span class="code"><strong>None</strong></span></li>
<li><span class="code">REAL</span>: Converted to <span class="code">float</span></li>
<li><span class="code">TEXT</span>: Depends on the <span class="code">text_factory</span> attribute of the <span class="code">Connection</span> instance, covered in <a data-type="xref" href="#additional_methods_and_attributes_of_th">Table 12-13</a>; by default, <span class="code">str</span></li>
</ul>
			Any other type name is treated as <span class="code">TEXT</span> unless properly detected and passed through a converter registered with the function <span class="code">register_converter</span>, covered later in this table. To allow type name detection, pass as <span class="code">detect_types</span> either of the constants <span class="code">PARSE_COLNAMES</span> or <span class="code">PARSE_DECLTYPES</span>, supplied by the <span class="code">sqlite3</span> package (or both, joining them with the <span class="code">|</span> bitwise OR operator).<br/>
			When you pass <span class="code">detect_types=sqlite3.PARSE_COLNAMES</span>, the type name is taken from the name of the column in the SQL <span class="code">SELECT</span> statement that retrieves the column; for example, a column retrieved as <span class="code"><em>foo</em></span> <span class="code">AS [</span><span class="code"><em>foo</em></span> <span class="code">CHAR(10)]</span> has a type name of <span class="code">CHAR</span>.<br/>
			When you pass <span class="code">detect_types=sqlite3.PARSE_DECLTYPES</span>, the type name is taken from the declaration of the column in the original <span class="code">CREATE TABLE</span> or <span class="code">ALTER TABLE</span> SQL statement that added the column; for example, a column declared as <span class="code"><em>foo</em></span> <span class="code">CHAR(10)</span> has a type name of <span class="code">CHAR</span>.<br/>
			When you pass <span class="code">detect_types=sqlite3.PARSE_COLNAMES | sqlite3.PARSE_DECLTYPES</span>, both mechanisms are used, with precedence given to the column name when it has at least two words (the second word gives the type name in this case), falling back to the type that was given for that column at declaration (the first word of the declaration type gives the type name in this case).<br/>
<span class="code">isolation_level</span> lets you exercise some control over how SQLite processes transactions; it can be <span class="code">''</span> (the default), <span class="code"><strong>None</strong></span> (to use <em>autocommit</em> mode), or one of the three strings <span class="code keep-together">‘DEFERRED’</span>, <span class="code">'EXCLUSIVE'</span>, or <span class="code">'IMMEDIATE'</span>. The <a href="https://oreil.ly/IuKIz">SQLite online docs</a> cover the details of <a href="https://oreil.ly/AnFtn">types of transactions</a> and their relation to the various levels of <a href="https://oreil.ly/cpWkt">file locking</a> that SQLite intrinsically performs.</td>
</tr>
<tr>
<td><span class="code">connect</span><br/>
<em>(cont.)</em></td>
<td>By default, a connection object can be used only in the Python thread that created it, to avoid accidents that could easily corrupt the DB due to minor bugs in your program (minor bugs are, alas, common in multithreaded programming). If you’re entirely confident about your threads’ use of locks and other synchronization mechanisms, and you need to reuse a connection object among multiple threads, you can pass <span class="code">check_same_thread=</span><span class="code"><strong>False</strong></span>. <span class="code">sqlite3</span> will then perform no checks, trusting your assertion that you know what you’re doing and that your multithreading architecture is 100% bug-free—good luck!<br/>
<span class="code">cached_statements</span> is the number of SQL statements that <span class="code">sqlite3</span> caches in a parsed and prepared state, to avoid the overhead of parsing them repeatedly. You can pass in a value lower than the default <span class="code">100</span> to save a little memory, or a larger one if your application uses a dazzling variety of SQL statements.</td>
</tr>
<tr>
<td><span class="code">r⁠e⁠g⁠i⁠s⁠t⁠e⁠r⁠_​a⁠d⁠a⁠p⁠t⁠e⁠r</span></td>
<td><span class="code">register_adapter(<em>type</em>,</span> <span class="code"><em>callable</em></span><span class="code">)</span><br/>
			Registers <span class="code"><em>callable</em></span> as the <em>adapter</em> from any object of Python type <span class="code"><em>type</em></span> to a corresponding value of one of the few Python types that <span class="code">sqlite3</span> handles directly: <span class="code">int</span>, <span class="code">float</span>, <span class="code">str</span>, and <span class="code">bytes</span>. <span class="code"><em>callable</em></span> must accept a single argument, the value to adapt, and return a value of a type that <span class="code">sqlite3</span> handles directly.</td>
</tr>
<tr>
<td><span class="code">r⁠e⁠g⁠i⁠s⁠t⁠e⁠r⁠_​c⁠o⁠n⁠v⁠e⁠r⁠t⁠e⁠r</span></td>
<td><span class="code">register_converter(<em>typename</em>,</span> <span class="code"><em>callable</em></span><span class="code">)</span><br/>
			Registers <span class="code"><em>callable</em></span> as the <em>converter</em> from any value identified in SQL as being of type <span class="code"><em>typename</em></span> (see the description of the connect function’s <span class="code">detect_types</span> parameter for an explanation of how the type name is identified) to a corresponding Python object. <span class="code"><em>callable</em></span> must accept a single argument, the string form of the value obtained from SQL, and return the corresponding Python object. The <span class="code"><em>typename</em></span> matching is case-sensitive.</td>
</tr>
</tbody>
</table>
<p>In addition, <span class="code">sqlite3</span> supplies the classes <span class="code">Connection</span>, <span class="code">Cursor</span>, and <span class="code">Row</span>. Each can be subclassed for further customization; however, this is an advanced topic that we do not cover further in this book. The <span class="code">Cursor</span> class is a standard DBAPI cursor class, except for an extra convenience method, <span class="code">executescript</span>, accepting a single argument, a string of multiple statements separated by <span class="code">;</span> (no parameters). The other two classes are covered in the following sections.</p>
<section data-pdf-bookmark="The sqlite3.Connection class" data-type="sect3"><div class="sect3" id="the_sqlitethreedotconnection_class">
<h3>The sqlite3.Connection class</h3>
<p>In<a contenteditable="false" data-primary="sqlite3.Connection class" data-type="indexterm" id="idm44924510077904"/> addition to the methods common to all <span class="code">Connection</span> classes of DBAPI-compliant modules, covered in <a data-type="xref" href="#connection_objects">“Connection Objects”</a>, <span class="code">sqlite3.Connection</span> supplies the methods and attributes in <a data-type="xref" href="#additional_methods_and_attributes_of_th">Table 12-13</a>.</p>
<table class="border" id="additional_methods_and_attributes_of_th">
<caption><span class="label">Table 12-13. </span>Additional methods and attributes of the <span class="code">sqlite3.Connection</span> class</caption>
<tbody>
<tr>
<td><span class="code">crea⁠t⁠e⁠_​a⁠g⁠g⁠regate</span></td>
<td><span class="code">create_aggregate(<em>name</em>,</span> <span class="code"><em>num_params</em></span><span class="code">,</span> <span class="code"><em>aggregate_class</em></span><span class="code">)</span><br/>
<span class="code"><em>aggregate_class</em></span> must be a class supplying two instance methods: <span class="code">step</span>, accepting exactly <span class="code"><em>num_param</em></span> arguments, and <span class="code"><em>finalize</em></span>, accepting no arguments and returning the final result of the aggregate, a value of a type natively supported by <span class="code">sqlite3</span>. The aggregate function can be used in SQL statements by the given <span class="code"><em>name</em></span>.</td>
</tr>
<tr>
<td><span class="code">c⁠r⁠e⁠a⁠t⁠e⁠_​c⁠o⁠l⁠l⁠a⁠t⁠i⁠o⁠n</span></td>
<td><span class="code">crea⁠t⁠e⁠_​c⁠o⁠l⁠lation(<em>name</em>,</span> <span class="code"><em>callable</em></span><span class="code">)</span><br/>
<span class="code"><em>callable</em></span> must accept two bytestring arguments (encoded in <span class="code">'utf-8'</span>) and return <span class="code">-1</span> if the first must be considered “less than” the second, <span class="code">1</span> if it must be considered “greater than,” and <span class="code">0</span> if it must be considered “equal,” for the purposes of this comparison. Such a collation can be named by the given <span class="code"><em>name</em></span> in a SQL <span class="code">ORDER BY</span> clause in a <span class="code">SELECT</span> statement.</td>
</tr>
<tr>
<td><span class="code">crea⁠t⁠e⁠_​f⁠u⁠n⁠ction</span></td>
<td><span class="code">create_function(<em>name</em>,</span> <span class="code"><em>num_params</em></span><span class="code">,</span> <span class="code"><em>func</em></span><span class="code">)</span><br/>
<span class="code"><em>func</em></span> must accept exactly <span class="code"><em>num_params</em></span> arguments and return a value of a type natively supported by <span class="code">sqlite3</span>; such a user-defined function can be used in SQL statements by the given <span class="code"><em>name</em></span>.</td>
</tr>
<tr>
<td><span class="code">interrupt</span></td>
<td><span class="code">interrupt()</span><br/>
			Call from any other thread to abort all queries executing on this connection (raising an exception in the thread using the connection).</td>
</tr>
<tr>
<td><span class="code">isolati⁠o⁠n⁠_​l⁠e⁠v⁠el</span></td>
<td>A read-only attribute that’s the value given as the <span class="code">isolation_level</span> parameter to the <span class="code">connect</span> function.</td>
</tr>
<tr>
<td><span class="code">iterdump</span></td>
<td><span class="code">iterdump()</span><br/>
			Returns an iterator that yields strings: the SQL statements that build the current DB from scratch, including both the schema and contents. Useful, for example, to persist an in-memory DB to disk for future reuse.</td>
</tr>
<tr>
<td><span class="code">row_factory</span></td>
<td>A callable that accepts the cursor and the original row as a tuple, and returns an object to use as the real result row. A common idiom is <span class="code"><em>x</em></span><span class="code">.row_factory=sqlite3.Row</span>, to use the highly optimized Row class covered in the following section, supplying both index-based and case-insensitive name-based access to columns with negligible overhead.</td>
</tr>
<tr>
<td><span class="code">text_factory</span></td>
<td>A callable that accepts a single bytestring parameter and returns the object to use for that <span class="code">TEXT</span> column value—by default, <span class="code">str</span>, but you can set it to any similar callable.</td>
</tr>
<tr>
<td><span class="code">total_changes</span></td>
<td>The total number of rows that have been modified, inserted, or deleted since the connection was created.</td>
</tr>
</tbody>
</table>
<p>A <span class="code">Connection</span> object can also be used as a context manager, to automatically commit database updates or roll back if an exception occurs; however, you will need to call <span class="code">Connection.close()</span> explicitly to close the connection in this case.</p>
</div></section>
<section data-pdf-bookmark="The sqlite3.Row class" data-type="sect3"><div class="sect3" id="the_sqlitethreedotrow_class">
<h3>The sqlite3.Row class</h3>
<p><span class="code">sqlite3</span> also supplies the class <span class="code">Row</span>. A <span class="code">Row</span> object is mostly like a <span class="code">tuple</span> but also supplies the method <span class="code">keys</span>, returning a list of column names, and supports indexing by a column name as an alternative to indexing by column number.</p>
</div></section>
<section class="pagebreak-before" data-pdf-bookmark="A sqlite3 example" data-type="sect3"><div class="sect3" id="a_sqlitethree_example">
<h3 class="less_space">A sqlite3 example</h3>
<p>The following example handles the same task as the examples shown earlier in the chapter, but uses <span class="code">sqlite3</span> for persistence, without creating the index in memory:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">fileinput</code><code class="o">,</code><code> </code><code class="nn">sqlite3</code><code>
</code><code class="n">connect</code><code> </code><code class="o">=</code><code> </code><code class="n">sqlite3</code><code class="o">.</code><code class="n">connect</code><code class="p">(</code><code class="s1">'</code><code class="s1">database.db</code><code class="s1">'</code><code class="p">)</code><code>
</code><code class="n">cursor</code><code> </code><code class="o">=</code><code> </code><code class="n">connect</code><code class="o">.</code><code class="n">cursor</code><code class="p">(</code><code class="p">)</code><code>
</code><strong><code class="k">with</code></strong><code> </code><code class="n">connect</code><code class="p">:</code><code>
</code><code>    </code><code class="n">cursor</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s1">'</code><code class="s1">CREATE TABLE IF NOT EXISTS Words </code><code class="s1">'</code><code>
</code><code>                   </code><code class="s1">'</code><code class="s1">(Word TEXT, File TEXT, Line INT)</code><code class="s1">'</code><code class="p">)</code><code>
</code><strong><code>    </code><code class="k">for</code></strong><code> </code><code class="n">line</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">fileinput</code><code class="o">.</code><code class="n">input</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="n">f</code><code class="p">,</code><code> </code><code class="n">l</code><code> </code><code class="o">=</code><code> </code><code class="n">fileinput</code><code class="o">.</code><code class="n">filename</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">fileinput</code><code class="o">.</code><code class="n">filelineno</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="n">cursor</code><code class="o">.</code><code class="n">executemany</code><code class="p">(</code><code class="s1">'</code><code class="s1">INSERT INTO Words VALUES (:w, :f, :l)</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>            </code><code class="p">[</code><code class="p">{</code><code class="s1">'</code><code class="s1">w</code><code class="s1">'</code><code class="p">:</code><code class="n">w</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">f</code><code class="s1">'</code><code class="p">:</code><code class="n">f</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">l</code><code class="s1">'</code><code class="p">:</code><code class="n">l</code><code class="p">}</code><code> </code><strong><code class="k">for</code></strong><code> </code><code class="n">w</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">line</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="p">)</code><code class="p">]</code><code class="p">)</code><code>
</code><code class="n">connect</code><code class="o">.</code><code class="n">close</code><code class="p">(</code><code class="p">)</code></pre>
<p>We can then use <span class="code">sqlite3</span> to read back the data stored in the DB file <em>database.db</em>, as shown in the following<a contenteditable="false" data-primary="" data-startref="DBAPIcommod12" data-type="indexterm" id="idm44924509883632"/><a contenteditable="false" data-primary="" data-startref="sqlite12" data-type="indexterm" id="idm44924509882320"/><a contenteditable="false" data-primary="" data-startref="PADdstand12" data-type="indexterm" id="idm44924509902656"/><a contenteditable="false" data-primary="" data-startref="SLMsqlite12" data-type="indexterm" id="idm44924509901280"/> example:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">sys</code><code class="o">,</code><code> </code><code class="nn">sqlite3</code><code class="o">,</code><code> </code><code class="nn">linecache</code><code>
</code><code class="n">connect</code><code> </code><code class="o">=</code><code> </code><code class="n">sqlite3</code><code class="o">.</code><code class="n">connect</code><code class="p">(</code><code class="s1">'</code><code class="s1">database.db</code><code class="s1">'</code><code class="p">)</code><code>
</code><code class="n">cursor</code><code> </code><code class="o">=</code><code> </code><code class="n">connect</code><code class="o">.</code><code class="n">cursor</code><code class="p">(</code><code class="p">)</code><code>
</code><strong><code class="k">for</code></strong><code> </code><code class="n">word</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">sys</code><code class="o">.</code><code class="n">argv</code><code class="p">[</code><code class="mi">1</code><code class="p">:</code><code class="p">]</code><code class="p">:</code><code>
</code><code>    </code><code class="n">cursor</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s1">'</code><code class="s1">SELECT File, Line FROM Words </code><code class="s1">'</code><code>
</code><code>                   </code><code class="s1">'</code><code class="s1">WHERE Word=?</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="p">[</code><code class="n">word</code><code class="p">]</code><code class="p">)</code><code>
</code><code>    </code><code class="n">places</code><code> </code><code class="o">=</code><code> </code><code class="n">cursor</code><code class="o">.</code><code class="n">fetchall</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><strong><code class="k">if</code><code> </code><code class="ow">not</code></strong><code> </code><code class="n">places</code><code class="p">:</code><code>
</code><code>         </code><code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s1">'</code><code class="s1">Word </code><code class="si">{</code><code class="n">word</code><code class="si">!r}</code><code class="s1"> not found in index file</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>               </code><code class="n">file</code><code class="o">=</code><code class="n">sys</code><code class="o">.</code><code class="n">stderr</code><code class="p">)</code><code>
</code><strong><code>         </code><code class="k">continue</code></strong><code>
</code><code>    </code><strong><code class="k">for</code></strong><code> </code><code class="n">fname</code><code class="p">,</code><code> </code><code class="n">lineno</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">places</code><code class="p">:</code><code>
</code><code>        </code><code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s1">'</code><code class="s1">Word </code><code class="si">{</code><code class="n">word</code><code class="si">!r}</code><code class="s1"> occurs in line </code><code class="si">{</code><code class="n">lineno</code><code class="si">}</code><code class="s1">'</code><code>
</code><code>              </code><code class="sa">f</code><code class="s1">'</code><code class="s1"> of file </code><code class="si">{</code><code class="n">fname</code><code class="si">!r}</code><code class="s1">:</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>        </code><code class="nb">print</code><code class="p">(</code><code class="n">linecache</code><code class="o">.</code><code class="n">getline</code><code class="p">(</code><code class="n">fname</code><code class="p">,</code><code> </code><code class="n">lineno</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">end</code><code class="o">=</code><code class="s1">'</code><code class="s1">'</code><code class="p">)</code><code>
</code><code class="n">connect</code><code class="o">.</code><code class="n">close</code><code class="p">(</code><code class="p">)</code></pre>
</div></section>
</div></section>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="ch01fn106"><sup><a href="ch12.xhtml#ch01fn106-marker">1</a></sup> In fact, “CSV” is something of a misnomer, since some dialects use tabs or other characters rather than commas as the field separator. It might be easier to think of them as “delimiter-separated values.”</p><p data-type="footnote" id="ch01fn109"><sup><a href="ch12.xhtml#ch01fn109-marker">2</a></sup> Consider the third-party package <a href="https://oreil.ly/mU15t"><span class="code">dill</span></a> if you need to extend <span class="code">pickle</span> in this and other aspects.</p><p data-type="footnote" id="idm44924511774592"><sup><a href="ch12.xhtml#idm44924511774592-marker">3</a></sup> <span class="code">dbm</span> keys and values must be bytes; <span class="code">shelve</span> will accept bytes or <span class="code">str</span> and encode the strings transparently.</p></div></div></section></div></body></html>