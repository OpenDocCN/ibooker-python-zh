<html><head></head><body><section data-pdf-bookmark="Chapter 2. Getting Started with Ray (Locally)" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch02">
<h1><span class="label">Chapter 2. </span>Getting Started with Ray (Locally)</h1>


<p>As we’ve discussed, Ray is useful for managing resources from a single computer up to a cluster. It is simpler to get started with a local installation, which leverages the parallelism of multicore/multi-CPU machines. Even when deploying to a cluster, you’ll want to have Ray installed locally for development. Once you’ve installed Ray, we’ll show you how to make and call your first asynchronous parallelized function and store state in an actor.</p>
<div data-type="tip"><h6>Tip</h6>
<p>If you are in a hurry, you can also use <a href="https://oreil.ly/7YUbX">Gitpod on the 
<span class="keep-together">book’s GitHub repo</span></a> to get a web environment 
<span class="keep-together">with the examples,</span> or check out <a href="https://oreil.ly/UacuZ">Anyscale’s managed Ray</a>.</p>
</div>






<section data-pdf-bookmark="Installation" data-type="sect1"><div class="sect1" id="idm45354787569056">
<h1>Installation</h1>

<p>Installing<a data-primary="Ray" data-secondary="installing" data-type="indexterm" id="idm45354787567488"/><a data-primary="installing" data-secondary="Ray" data-type="indexterm" id="idm45354787566480"/> Ray, even on a single machine, can range from relatively straightforward to fairly complicated. Ray publishes wheels to the Python Package Index (PyPI) following a normal release cadence as well as in nightly releases. These wheels are currently available for only x86 users, so ARM users will mostly need to build Ray from source.<sup><a data-type="noteref" href="ch02.html#idm45354787565408" id="idm45354787565408-marker">1</a></sup></p>
<div data-type="tip"><h6>Tip</h6>
<p>M1 ARM users on macOS can use the x86 packages with Rosetta. Some performance degradation occurs, but it’s a much simpler setup. To use the x86s package, install Anaconda for macOS.</p>
</div>








<section data-pdf-bookmark="Installing for x86 and M1 ARM" data-type="sect2"><div class="sect2" id="idm45354787563536">
<h2>Installing for x86 and M1 ARM</h2>

<p>Most <a data-primary="Ray" data-secondary="installing" data-tertiary="in Conda environment" data-tertiary-sortas="conda environment" data-type="indexterm" id="idm45354787561968"/><a data-primary="installing" data-secondary="Ray" data-tertiary="in Conda environment" data-tertiary-sortas="conda environment" data-type="indexterm" id="idm45354787560416"/><a data-primary="Conda environments, installing Ray in" data-type="indexterm" id="idm45354786465232"/><a data-primary="x86, installing Ray" data-type="indexterm" id="idm45354786464544"/><a data-primary="M1 ARM, installing Ray" data-type="indexterm" id="idm45354786463872"/><a data-primary="Ray" data-secondary="installing" data-tertiary="with pip command" data-tertiary-sortas="pip command" data-type="indexterm" id="idm45354786463200"/><a data-primary="installing" data-secondary="Ray" data-tertiary="with pip command" data-tertiary-sortas="pip command" data-type="indexterm" id="idm45354786461712"/><a data-primary="pip command, installing Ray" data-type="indexterm" id="idm45354786460224"/>users can run <code>pip install -U ray</code> to automatically install Ray from PyPI. When you go to distribute your computation on multiple machines, it’s often easier to have been working in a Conda environment so you can match Python versions with your cluster and know your package dependencies. The commands in <a data-type="xref" href="#ex_ray_conda">Example 2-1</a> set up a fresh Conda environment with Python and install Ray with minimal dependencies.</p>
<div data-type="example" id="ex_ray_conda">
<h5><span class="label">Example 2-1. </span><a href="https://oreil.ly/rxdEC">Installing Ray inside a Conda environment</a></h5>

<pre data-type="programlisting">conda create -n ray python=3.7  mamba -y
conda activate ray
# In a Conda env this won't be auto-installed with Ray, so add them
pip install jinja2 python-dateutil cloudpickle packaging pygments \
    psutil nbconvert ray</pre></div>
</div></section>








<section data-pdf-bookmark="Installing (from Source) for ARM" data-type="sect2"><div class="sect2" id="idm45354786455584">
<h2>Installing (from Source) for ARM</h2>

<p>For<a data-primary="Ray" data-secondary="installing" data-tertiary="from source" data-tertiary-sortas="source" data-type="indexterm" id="ray-installing-source"/><a data-primary="installing" data-secondary="Ray" data-tertiary="from source" data-tertiary-sortas="source" data-type="indexterm" id="install-ray-source"/><a data-primary="source, installing Ray from" data-type="indexterm" id="source-install-ray"/><a data-primary="ARM, installing Ray for" data-type="indexterm" id="arm-install-ray"/> ARM users or any users with a system architecture that does not have a prebuilt wheel available, you will need to build Ray from the source. On our ARM Ubuntu system, we need to install additional packages, as shown in <a data-type="xref" href="#debian_ray_arms_pkgs">Example 2-2</a>.</p>
<div data-type="example" id="debian_ray_arms_pkgs">
<h5><span class="label">Example 2-2. </span><a href="https://oreil.ly/k97Lt">Installing Ray from source</a></h5>

<pre data-type="programlisting">sudo apt-get install -y git tzdata bash libhdf5-dev curl pkg-config wget \
  cmake build-essential zlib1g-dev zlib1g openssh-client gnupg unzip libunwind8 \
  libunwind-dev openjdk-11-jdk git
# Depending on Debian version
sudo apt-get install -y libhdf5-100 || sudo apt-get install -y libhdf5-103
# Install bazelisk to install bazel (needed for Ray's CPP code)
# See https://github.com/bazelbuild/bazelisk/releases
# On Linux ARM
BAZEL=bazelisk-linux-arm64
# On Mac ARM
# BAZEL=bazelisk-darwin-arm64
wget -q https://github.com/bazelbuild/bazelisk/releases/download/v1.10.1/${BAZEL} \
  -O /tmp/bazel
chmod a+x /tmp/bazel
sudo mv /tmp/bazel /usr/bin/bazel
# Install node, needed for the UI
curl -fsSL https://deb.nodesource.com/setup_16.x | sudo bash -
sudo apt-get install -y nodejs</pre></div>

<p>If you are an M1 Mac user who doesn’t want to use Rosetta, you’ll need to install some dependencies. You can install them with Homebrew and <code>pip</code>, as shown in <a data-type="xref" href="#m1_ray_arms_pkgs">Example 2-3</a>.</p>
<div data-type="example" id="m1_ray_arms_pkgs">
<h5><span class="label">Example 2-3. </span><a href="https://oreil.ly/4KDxL">Installing extra dependencies needed on the M1</a></h5>

<pre data-type="programlisting">brew install bazelisk wget python@3.8 npm
# Make sure Homebrew Python is used before system Python
export PATH=$(brew --prefix)/opt/python@3.8/bin/:$PATH
echo "export PATH=$(brew --prefix)/opt/python@3.8/bin/:$PATH" &gt;&gt; ~/.zshrc
echo "export PATH=$(brew --prefix)/opt/python@3.8/bin/:$PATH" &gt;&gt; ~/.bashrc
# Install some libraries vendored incorrectly by Ray for ARM
pip3 install --user psutil cython colorama</pre></div>

<p>You need to build some of the Ray components separately because they are written in different languages. This does make installation more complicated, but you can follow the steps in <a data-type="xref" href="#build_ray">Example 2-4</a>.</p>
<div class="example-margin-5" data-type="example" id="build_ray">
<h5><span class="label">Example 2-4. </span><a href="https://oreil.ly/k97Lt">Installing the build tools for Ray’s native build toolchain</a></h5>

<pre data-type="programlisting">git clone https://github.com/ray-project/ray.git
cd ray
# Build the Ray UI
pushd python/ray/new_dashboard/client; npm install &amp;&amp; npm ci &amp;&amp; npm run build; popd
# Specify a specific bazel version as newer ones sometimes break.
export USE_BAZEL_VERSION=4.2.1
cd python
# Mac ARM USERS ONLY: clean up the vendored files
rm -rf ./thirdparty_files
# Install in edit mode or build a wheel
pip install -e .
# python setup.py bdist_wheel</pre></div>
<div data-type="tip"><h6>Tip</h6>
<p>The slowest part of the build is compiling the C++ code, which can easily take up to an hour even on modern machines. If you have a cluster with numerous ARM machines, building a wheel once and reusing it on your cluster is often<a data-primary="Ray" data-secondary="installing" data-startref="ray-installing-source" data-tertiary="from source" data-tertiary-sortas="source" data-type="indexterm" id="idm45354787619376"/><a data-primary="installing" data-secondary="Ray" data-startref="install-ray-source" data-tertiary="from source" data-tertiary-sortas="source" data-type="indexterm" id="idm45354787617584"/><a data-primary="source, installing Ray from" data-startref="source-install-ray" data-type="indexterm" id="idm45354787615824"/><a data-primary="ARM, installing Ray for" data-startref="arm-install-ray" data-type="indexterm" id="idm45354787614816"/> worthwhile.</p>
</div>
</div></section>
</div></section>






<section data-pdf-bookmark="Hello Worlds" data-type="sect1"><div class="sect1" id="idm45354787613488">
<h1>Hello Worlds</h1>

<p>Now that you have Ray installed, it’s time to learn about some of the Ray APIs. We’ll cover these APIs in more detail later, so don’t get too hung up on the details now.</p>








<section data-pdf-bookmark="Ray Remote (Task/Futures) Hello World" data-type="sect2"><div class="sect2" id="idm45354787611600">
<h2>Ray Remote (Task/Futures) Hello World</h2>

<p class="pagebreak-after">One of <a data-primary="remote functions" data-secondary="creating" data-type="indexterm" id="remote-function-create"/><a data-primary="remote futures, returning" data-type="indexterm" id="remote-future-return"/><a data-primary="returning remote futures" data-type="indexterm" id="return-remote-future"/><a data-primary="functions" data-see="remote functions" data-type="indexterm" id="idm45354787606464"/>the core building blocks of Ray is that of remote functions, which return futures. The term <em>remote</em> here indicates <em>remote to our main process</em>, and can be on the same or a different machine.</p>

<p>To understand this better, you can write a function that returns the location where it is running. Ray distributes work among multiple processes and, when in distributed mode, multiple hosts. A local (non-Ray) version of this function is shown in 
<span class="keep-together"><a data-type="xref" href="#ex_local_fun">Example 2-5</a></span>.</p>
<div data-type="example" id="ex_local_fun">
<h5><span class="label">Example 2-5. </span><a href="https://oreil.ly/perip">A local (regular) function</a></h5>

<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">hi</code><code class="p">():</code>
    <code class="kn">import</code> <code class="nn">os</code>
    <code class="kn">import</code> <code class="nn">socket</code>
    <code class="k">return</code> <code class="sa">f</code><code class="s2">"Running on </code><code class="si">{</code><code class="n">socket</code><code class="o">.</code><code class="n">gethostname</code><code class="p">()</code><code class="si">}</code><code class="s2"> in pid </code><code class="si">{</code><code class="n">os</code><code class="o">.</code><code class="n">getpid</code><code class="p">()</code><code class="si">}</code><code class="s2">"</code></pre></div>

<p>You can use <a data-primary="ray.remote" data-type="indexterm" id="idm45354785177600"/>the <code>ray.remote</code> decorator to create a remote function. Calling remote functions is a bit different from calling local ones and is done by calling <code>.remote</code> on the function. Ray will immediately return a future when you call a remote function instead of blocking for the result. You can<a data-primary="ray.get" data-type="indexterm" id="idm45354785176096"/> use <code>ray.get</code> to get the values returned in those futures. To convert <a data-type="xref" href="#ex_local_fun">Example 2-5</a> to a remote function, all you need to do is use the <code>ray.remote</code> decorator, as shown in <a data-type="xref" href="#ex_remote_fun">Example 2-6</a>.</p>
<div class="example-margin-7" data-type="example" id="ex_remote_fun">
<h5><span class="label">Example 2-6. </span><a href="https://oreil.ly/perip">Turning the previous function into a remote function</a></h5>

<pre data-code-language="python" data-type="programlisting"><code class="nd">@ray</code><code class="o">.</code><code class="n">remote</code>
<code class="k">def</code> <code class="nf">remote_hi</code><code class="p">():</code>
    <code class="kn">import</code> <code class="nn">os</code>
    <code class="kn">import</code> <code class="nn">socket</code>
    <code class="k">return</code> <code class="sa">f</code><code class="s2">"Running on </code><code class="si">{</code><code class="n">socket</code><code class="o">.</code><code class="n">gethostname</code><code class="p">()</code><code class="si">}</code><code class="s2"> in pid </code><code class="si">{</code><code class="n">os</code><code class="o">.</code><code class="n">getpid</code><code class="p">()</code><code class="si">}</code><code class="s2">"</code>
<code class="n">future</code> <code class="o">=</code> <code class="n">remote_hi</code><code class="o">.</code><code class="n">remote</code><code class="p">()</code>
<code class="n">ray</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">future</code><code class="p">)</code></pre></div>

<p>When you run these two examples, you’ll see that the first is executed in the same process, and that Ray schedules the second one in another process. When we run the two examples, we get <code>Running on jupyter-holdenk in pid 33</code> and <code>Running on jupyter-holdenk in pid 173</code>, <a data-primary="remote functions" data-secondary="creating" data-startref="remote-function-create" data-type="indexterm" id="idm45354787663824"/><a data-primary="remote futures, returning" data-startref="remote-future-return" data-type="indexterm" id="idm45354787662704"/><a data-primary="returning remote futures" data-startref="return-remote-future" data-type="indexterm" id="idm45354787661792"/>respectively.</p>










<section data-pdf-bookmark="Sleepy task" data-type="sect3"><div class="sect3" id="idm45354787660624">
<h3>Sleepy task</h3>

<p>An <a data-primary="remote functions" data-secondary="parallelizing" data-type="indexterm" id="remote-function-parallel"/><a data-primary="parallelizing remote functions" data-type="indexterm" id="parallel-remote-function"/>easy (although artificial) way to understand how remote futures can help is by making an intentionally slow function (in our case, <code>slow_task</code>) and having Python compute in regular function calls and Ray remote calls. See <a data-type="xref" href="#sleepy_task">Example 2-7</a>.</p>
<div class="example-margin-5 pagebreak-before less_space" data-type="example" id="sleepy_task">
<h5><span class="label">Example 2-7. </span><a href="https://oreil.ly/perip">Using Ray to parallelize an intentionally slow function</a></h5>

<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">timeit</code>

<code class="k">def</code> <code class="nf">slow_task</code><code class="p">(</code><code class="n">x</code><code class="p">):</code>
    <code class="kn">import</code> <code class="nn">time</code>
    <code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mi">2</code><code class="p">)</code> <code class="c1"># Do something sciency/business</code>
    <code class="k">return</code> <code class="n">x</code>

<code class="nd">@ray</code><code class="o">.</code><code class="n">remote</code>
<code class="k">def</code> <code class="nf">remote_task</code><code class="p">(</code><code class="n">x</code><code class="p">):</code>
    <code class="k">return</code> <code class="n">slow_task</code><code class="p">(</code><code class="n">x</code><code class="p">)</code>

<code class="n">things</code> <code class="o">=</code> <code class="nb">range</code><code class="p">(</code><code class="mi">10</code><code class="p">)</code>

<code class="n">very_slow_result</code> <code class="o">=</code> <code class="nb">map</code><code class="p">(</code><code class="n">slow_task</code><code class="p">,</code> <code class="n">things</code><code class="p">)</code>
<code class="n">slowish_result</code> <code class="o">=</code> <code class="nb">map</code><code class="p">(</code><code class="k">lambda</code> <code class="n">x</code><code class="p">:</code> <code class="n">remote_task</code><code class="o">.</code><code class="n">remote</code><code class="p">(</code><code class="n">x</code><code class="p">),</code> <code class="n">things</code><code class="p">)</code>

<code class="n">slow_time</code> <code class="o">=</code> <code class="n">timeit</code><code class="o">.</code><code class="n">timeit</code><code class="p">(</code><code class="k">lambda</code><code class="p">:</code> <code class="nb">list</code><code class="p">(</code><code class="n">very_slow_result</code><code class="p">),</code> <code class="n">number</code><code class="o">=</code><code class="mi">1</code><code class="p">)</code>
<code class="n">fast_time</code> <code class="o">=</code> <code class="n">timeit</code><code class="o">.</code><code class="n">timeit</code><code class="p">(</code><code class="k">lambda</code><code class="p">:</code> <code class="nb">list</code><code class="p">(</code><code class="n">ray</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="nb">list</code><code class="p">(</code><code class="n">slowish_result</code><code class="p">))),</code> <code class="n">number</code><code class="o">=</code><code class="mi">1</code><code class="p">)</code>
<code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s2">"In sequence </code><code class="si">{</code><code class="n">slow_time</code><code class="si">}</code><code class="s2">, in parallel </code><code class="si">{</code><code class="n">fast_time</code><code class="si">}</code><code class="s2">"</code><code class="p">)</code></pre></div>

<p>When you run this code, you’ll see that by using Ray remote functions, your code is able to execute multiple remote functions at the same time. While you can do this without Ray by using <code>multiprocessing</code>, Ray handles all of the details for you and can also eventually scale up to multiple<a data-primary="remote functions" data-secondary="parallelizing" data-startref="remote-function-parallel" data-type="indexterm" id="idm45354787330976"/><a data-primary="parallelizing remote functions" data-startref="parallel-remote-function" data-type="indexterm" id="idm45354784128176"/> machines.</p>
</div></section>










<section data-pdf-bookmark="Nested and chained tasks" data-type="sect3"><div class="sect3" id="idm45354784126944">
<h3>Nested and chained tasks</h3>

<p>Ray is <a data-primary="remote functions" data-secondary="nested/chained tasks" data-type="indexterm" id="remote-function-nestchain"/><a data-primary="nested tasks" data-type="indexterm" id="nested-tasks"/><a data-primary="chained tasks" data-type="indexterm" id="chain-task"/>notable in the distributed processing world for allowing nested and chained tasks. Launching more tasks inside other tasks can make certain kinds of recursive algorithms easier to implement.</p>

<p>One of the more straightforward examples using nested tasks is a<a data-primary="web crawlers" data-type="indexterm" id="webcrawl"/> web crawler. In the web crawler, each page we visit can launch multiple additional visits to the links on that page, as shown in <a data-type="xref" href="#nested_task">Example 2-8</a>.</p>
<div data-type="example" id="nested_task">
<h5><span class="label">Example 2-8. </span><a href="https://oreil.ly/perip">Web crawler with nested tasks</a></h5>

<pre data-code-language="python" data-type="programlisting"><code class="nd">@ray</code><code class="o">.</code><code class="n">remote</code>
<code class="k">def</code> <code class="nf">crawl</code><code class="p">(</code><code class="n">url</code><code class="p">,</code> <code class="n">depth</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code> <code class="n">maxdepth</code><code class="o">=</code><code class="mi">1</code><code class="p">,</code> <code class="n">maxlinks</code><code class="o">=</code><code class="mi">4</code><code class="p">):</code>
    <code class="n">links</code> <code class="o">=</code> <code class="p">[]</code>
    <code class="n">link_futures</code> <code class="o">=</code> <code class="p">[]</code>
    <code class="kn">import</code> <code class="nn">requests</code>
    <code class="kn">from</code> <code class="nn">bs4</code> <code class="kn">import</code> <code class="n">BeautifulSoup</code>
    <code class="k">try</code><code class="p">:</code>
        <code class="n">f</code> <code class="o">=</code> <code class="n">requests</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">url</code><code class="p">)</code>
        <code class="n">links</code> <code class="o">+=</code> <code class="p">[(</code><code class="n">url</code><code class="p">,</code> <code class="n">f</code><code class="o">.</code><code class="n">text</code><code class="p">)]</code>
        <code class="k">if</code> <code class="p">(</code><code class="n">depth</code> <code class="o">&gt;</code> <code class="n">maxdepth</code><code class="p">):</code>
            <code class="k">return</code> <code class="n">links</code> <code class="c1"># base case</code>
        <code class="n">soup</code> <code class="o">=</code> <code class="n">BeautifulSoup</code><code class="p">(</code><code class="n">f</code><code class="o">.</code><code class="n">text</code><code class="p">,</code> <code class="s1">'html.parser'</code><code class="p">)</code>
        <code class="n">c</code> <code class="o">=</code> <code class="mi">0</code>
        <code class="k">for</code> <code class="n">link</code> <code class="ow">in</code> <code class="n">soup</code><code class="o">.</code><code class="n">find_all</code><code class="p">(</code><code class="s1">'a'</code><code class="p">):</code>
            <code class="k">try</code><code class="p">:</code>
                <code class="n">c</code> <code class="o">=</code> <code class="n">c</code> <code class="o">+</code> <code class="mi">1</code>
                <code class="n">link_futures</code> <code class="o">+=</code> <code class="p">[</code><code class="n">crawl</code><code class="o">.</code><code class="n">remote</code><code class="p">(</code><code class="n">link</code><code class="p">[</code><code class="s2">"href"</code><code class="p">],</code> <code class="n">depth</code><code class="o">=</code><code class="p">(</code><code class="n">depth</code><code class="o">+</code><code class="mi">1</code><code class="p">),</code>
                                   <code class="n">maxdepth</code><code class="o">=</code><code class="n">maxdepth</code><code class="p">)]</code>
                <code class="c1"># Don't branch too much; we're still in local mode and the web is big</code>
                <code class="k">if</code> <code class="n">c</code> <code class="o">&gt;</code> <code class="n">maxlinks</code><code class="p">:</code>
                    <code class="k">break</code>
            <code class="k">except</code><code class="p">:</code>
                <code class="k">pass</code>
        <code class="k">for</code> <code class="n">r</code> <code class="ow">in</code> <code class="n">ray</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">link_futures</code><code class="p">):</code>
            <code class="n">links</code> <code class="o">+=</code> <code class="n">r</code>
        <code class="k">return</code> <code class="n">links</code>
    <code class="k">except</code> <code class="n">requests</code><code class="o">.</code><code class="n">exceptions</code><code class="o">.</code><code class="n">InvalidSchema</code><code class="p">:</code>
        <code class="k">return</code> <code class="p">[]</code> <code class="c1"># Skip nonweb links</code>
    <code class="k">except</code> <code class="n">requests</code><code class="o">.</code><code class="n">exceptions</code><code class="o">.</code><code class="n">MissingSchema</code><code class="p">:</code>
        <code class="k">return</code> <code class="p">[]</code> <code class="c1"># Skip nonweb links</code>

<code class="n">ray</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">crawl</code><code class="o">.</code><code class="n">remote</code><code class="p">(</code><code class="s2">"http://holdenkarau.com/"</code><code class="p">))</code></pre></div>

<p>Many other systems require that all tasks launch on a central coordinator node. Even those that support launching tasks in a nested fashion still usually depend on a central<a data-primary="remote functions" data-secondary="nested/chained tasks" data-startref="remote-function-nestchain" data-type="indexterm" id="idm45354784272128"/><a data-primary="nested tasks" data-startref="nested-tasks" data-type="indexterm" id="idm45354784271040"/><a data-primary="chained tasks" data-startref="chain-task" data-type="indexterm" id="idm45354784270160"/><a data-primary="web crawlers" data-startref="webcrawl" data-type="indexterm" id="idm45354784680272"/> scheduler.</p>
</div></section>
</div></section>








<section data-pdf-bookmark="Data Hello World" data-type="sect2"><div class="sect2" id="idm45354784679072">
<h2>Data Hello World</h2>

<p>Ray has<a data-primary="datasets" data-secondary="creating" data-type="indexterm" id="dataset-create"/> a somewhat limited dataset API for working with structured data. Apache Arrow<a data-primary="Apache Arrow" data-secondary="Datasets API" data-type="indexterm" id="idm45354784676096"/><a data-primary="Arrow" data-secondary="Datasets API" data-type="indexterm" id="idm45354784675152"/><a data-primary="aggregations" data-secondary="on datasets" data-secondary-sortas="datasets" data-type="indexterm" id="aggregate-dataset"/> powers Ray’s Datasets API. Arrow is a column-oriented, language-independent format with some popular operations. Many popular tools support Arrow, allowing easy transfer between them (such as Spark, Ray, Dask, and 
<span class="keep-together">TensorFlow).</span></p>

<p>Ray only recently added keyed aggregations on datasets with version 1.9. The most popular distributed data example is a word count, which requires aggregates. Instead of using these, we can perform embarrassingly parallel tasks, such as map transformations, by constructing a dataset of web pages, shown in <a data-type="xref" href="#ds_hello">Example 2-9</a>.</p>
<div data-type="example" id="ds_hello">
<h5><span class="label">Example 2-9. </span><a href="https://oreil.ly/perip">Constructing a dataset of web pages</a></h5>

<pre data-code-language="python" data-type="programlisting"><code class="c1"># Create a dataset of URL objects. We could also load this from a text file</code>
<code class="c1"># with ray.data.read_text()</code>
<code class="n">urls</code> <code class="o">=</code> <code class="n">ray</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">from_items</code><code class="p">([</code>
    <code class="s2">"https://github.com/scalingpythonml/scalingpythonml"</code><code class="p">,</code>
    <code class="s2">"https://github.com/ray-project/ray"</code><code class="p">])</code>

<code class="k">def</code> <code class="nf">fetch_page</code><code class="p">(</code><code class="n">url</code><code class="p">):</code>
    <code class="kn">import</code> <code class="nn">requests</code>
    <code class="n">f</code> <code class="o">=</code> <code class="n">requests</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">url</code><code class="p">)</code>
    <code class="k">return</code> <code class="n">f</code><code class="o">.</code><code class="n">text</code>

<code class="n">pages</code> <code class="o">=</code> <code class="n">urls</code><code class="o">.</code><code class="n">map</code><code class="p">(</code><code class="n">fetch_page</code><code class="p">)</code>
<code class="c1"># Look at a page to make sure it worked</code>
<code class="n">pages</code><code class="o">.</code><code class="n">take</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code></pre></div>

<p>Ray 1.9 <a data-primary="GroupedDataset" data-type="indexterm" id="idm45354786071008"/>added <code>GroupedDataset</code> for supporting various kinds of aggregations. By calling <code>groupby</code> with either a column name or a function that returns a key, you get a <code>GroupedDataset</code>. <code>GroupedDataset</code> has built-in support for <code>count</code>, <code>max</code>, <code>min</code>, and other common aggregations. You can use <code>GroupedDataset</code> to extend <a data-type="xref" href="#ds_hello">Example 2-9</a> into a word-count example, as shown in <a data-type="xref" href="#ds_wc">Example 2-10</a>.</p>
<div data-type="example" id="ds_wc">
<h5><span class="label">Example 2-10. </span><a href="https://oreil.ly/perip">Converting a dataset of web pages into words</a></h5>

<pre data-code-language="python" data-type="programlisting"><code class="n">words</code> <code class="o">=</code> <code class="n">pages</code><code class="o">.</code><code class="n">flat_map</code><code class="p">(</code><code class="k">lambda</code> <code class="n">x</code><code class="p">:</code> <code class="n">x</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="s2">" "</code><code class="p">))</code><code class="o">.</code><code class="n">map</code><code class="p">(</code><code class="k">lambda</code> <code class="n">w</code><code class="p">:</code> <code class="p">(</code><code class="n">w</code><code class="p">,</code> <code class="mi">1</code><code class="p">))</code>
<code class="n">grouped_words</code> <code class="o">=</code> <code class="n">words</code><code class="o">.</code><code class="n">groupby</code><code class="p">(</code><code class="k">lambda</code> <code class="n">wc</code><code class="p">:</code> <code class="n">wc</code><code class="p">[</code><code class="mi">0</code><code class="p">])</code></pre></div>

<p>When you need to go beyond the built-in operations, Ray supports custom aggregations, provided you implement its interface. We will cover more on datasets, including aggregate functions, in <a data-type="xref" href="ch09.html#ch09">Chapter 9</a>.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Ray<a data-primary="Ray" data-secondary="blocking evaluation in" data-type="indexterm" id="idm45354784749536"/><a data-primary="blocking evaluation" data-type="indexterm" id="idm45354784748528"/> uses <em>blocking evaluation</em> for its Dataset API. When you call a function on a Ray dataset, it will wait until it completes the result instead of returning a future. The rest of the Ray Core API uses futures.</p>
</div>

<p>If you want a full-featured DataFrame API, you can convert your Ray dataset into Dask. <a data-type="xref" href="ch09.html#ch09">Chapter 9</a> covers how to use Dask for more complex operations. If you are interested in learning more about Dask, check out <a class="orm:hideurl" href="https://oreil.ly/LKMlO"><em>Scaling Python with Dask</em></a> (O’Reilly), which Holden coauthored with <a data-primary="datasets" data-secondary="creating" data-startref="dataset-create" data-type="indexterm" id="idm45354784744720"/><a data-primary="aggregations" data-secondary="on datasets" data-secondary-sortas="datasets" data-startref="aggregate-dataset" data-type="indexterm" id="idm45354784743536"/>Mika Kimmins.</p>
</div></section>








<section data-pdf-bookmark="Actor Hello World" data-type="sect2"><div class="sect2" id="idm45354784741792">
<h2>Actor Hello World</h2>

<p>One of <a data-primary="actors" data-see="remote actors; virtual actors" data-type="indexterm" id="idm45354784740224"/><a data-primary="remote actors" data-secondary="reasons for using" data-type="indexterm" id="actor-reasons"/>the unique parts of Ray is its emphasis on actors. Actors give you tools to manage the execution state, which is one of the more challenging parts of scaling systems. Actors send and receive messages, updating their state in response. These messages can come from other actors, programs, or your main execution thread with the Ray client.</p>

<p>For every actor, Ray starts a dedicated process. Each actor has a mailbox of messages waiting to be processed. When you call an actor, Ray adds a message to the corresponding mailbox, which allows Ray to serialize message processing, thus avoiding expensive distributed locks. Actors can return values in response to messages, so when you send a message to an actor, Ray immediately returns a future so you can fetch the value when the actor is done processing your message.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45354786832768">
<h5>Actor Uses and History</h5>
<p>Actors have a long history before Ray and were introduced in 1973. The actor model is an excellent solution to concurrency with state and can replace complicated locking structures. Some other notable implementations of actors are Akka in Scala and Erlang.</p>

<p>The actor model can be used for everything from real-world systems like email, to Internet of Things (IoT) applications like tracking temperature, to flight booking. A common use case for Ray actors is managing state (e.g., weights) while performing distributed ML without requiring expensive locking.<sup><a data-type="noteref" href="ch02.html#idm45354786831024" id="idm45354786831024-marker">2</a></sup></p>

<p>The actor model has challenges with multiple events that need to be processed in order and rolled back as a group. A classic example is banking, where transactions need to touch multiple accounts and be rolled back as<a data-primary="remote actors" data-secondary="reasons for using" data-startref="actor-reasons" data-type="indexterm" id="idm45354786830080"/> a group.</p>
</div></aside>

<p>Ray actors are<a data-primary="remote actors" data-secondary="creating" data-type="indexterm" id="idm45354786828160"/> created and called similarly to remote functions but use Python classes, which gives the actor a place to store state. You can see this in action by modifying the classic “Hello World” example to greet you in sequence, as shown in <a data-type="xref" href="#actor_hello_world">Example 2-11</a>.</p>
<div data-type="example" id="actor_hello_world">
<h5><span class="label">Example 2-11. </span><a href="https://oreil.ly/perip">Actor Hello World</a></h5>

<pre data-code-language="python" data-type="programlisting"><code class="nd">@ray</code><code class="o">.</code><code class="n">remote</code>
<code class="k">class</code> <code class="nc">HelloWorld</code><code class="p">(</code><code class="nb">object</code><code class="p">):</code>
    <code class="k">def</code> <code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">value</code> <code class="o">=</code> <code class="mi">0</code>
    <code class="k">def</code> <code class="nf">greet</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">value</code> <code class="o">+=</code> <code class="mi">1</code>
        <code class="k">return</code> <code class="sa">f</code><code class="s2">"Hi user #</code><code class="si">{</code><code class="bp">self</code><code class="o">.</code><code class="n">value</code><code class="si">}</code><code class="s2">"</code>

<code class="c1"># Make an instance of the actor</code>
<code class="n">hello_actor</code> <code class="o">=</code> <code class="n">HelloWorld</code><code class="o">.</code><code class="n">remote</code><code class="p">()</code>

<code class="c1"># Call the actor</code>
<code class="nb">print</code><code class="p">(</code><code class="n">ray</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">hello_actor</code><code class="o">.</code><code class="n">greet</code><code class="o">.</code><code class="n">remote</code><code class="p">()))</code>
<code class="nb">print</code><code class="p">(</code><code class="n">ray</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">hello_actor</code><code class="o">.</code><code class="n">greet</code><code class="o">.</code><code class="n">remote</code><code class="p">()))</code></pre></div>

<p>This example is fairly basic; it lacks any fault tolerance or concurrency within each actor. We’ll explore those more in <a data-type="xref" href="ch04.html#ch04">Chapter 4</a>.</p>
</div></section>
</div></section>






<section data-pdf-bookmark="Conclusion" data-type="sect1"><div class="sect1" id="idm45354787613152">
<h1>Conclusion</h1>

<p>In this chapter, you installed Ray on your local machine and used many of its core APIs. For the most part, you can continue to run the examples we’ve picked for this book in local mode. Naturally, local mode can limit your scale or take longer to run.</p>

<p>In the next chapter, we’ll look at some of the core concepts behind Ray. One of the concepts (fault tolerance) will be easier to illustrate with a cluster or cloud. So if you have access to a cloud account or a cluster, now would be an excellent time to jump over to <a data-type="xref" href="app02.html#appB">Appendix B</a> and look at the deployment options.</p>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="idm45354787565408"><sup><a href="ch02.html#idm45354787565408-marker">1</a></sup> As ARM grows in popularity, Ray is more likely to add ARM wheels, so this is hopefully temporary.</p><p data-type="footnote" id="idm45354786831024"><sup><a href="ch02.html#idm45354786831024-marker">2</a></sup> Actors are still more expensive than lock-free remote functions, which can be scaled horizontally. For example, lots of workers calling the same actor to update model weights will still be slower than embarrassingly parallel operations.</p></div></div></section></body></html>