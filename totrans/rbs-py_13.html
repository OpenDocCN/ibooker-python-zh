<html><head></head><body>
<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 11. Defining Your Interfaces" class="preface"><div class="preface" id="api">
<h1 class="calibre10" id="calibre_pb_0"><span class="calibre">Chapter 11. </span>Defining Your Interfaces</h1>


<p class="author1">You have learned how to create your own user-defined types, but creating them is just half the battle.<a data-type="indexterm" data-primary="APIs" data-secondary="defining your interfaces" id="idm45644739427384" class="calibre5"/> Now developers have to actually use your types. To do this, they use your type’s API. This is the set of types and related functions, along with any external functions, that a developer interacts with to use your code.</p>

<p class="author1">Once you get your types in front of users, those types will be used (and abused) in ways that you never thought of. And once the developers depend on your types, it will be hard to change their behavior.<a data-type="indexterm" data-primary="Paradox of Code Interfaces" id="idm45644739425464" class="calibre5"/> This gives rise to what I call the <em class="calibre6">Paradox of Code Interfaces</em>:</p>
<blockquote class="pcalibre2 calibre28 pcalibre1">
<p class="calibre29">You have one chance to get your interface right, but you won’t know it’s right until it’s used.</p></blockquote>

<p class="author1">As soon as developers use the types you create, they come to depend on the behavior that those types encompass. If you try to make a backward-incompatible change, you potentially break all calling code. The riskiness in changing your interface is proportional to the amount of outside code depending on it.</p>

<p class="author1">This paradox doesn’t apply if you control all the code that depends on your type; you can change it. But as soon as that type hits production, and people start using it, you’ll find it difficult to change. In a large codebase, where robustness and maintainability matter, coordinating the change and buy-in needed to make a sweeping change is costly. It becomes near impossible if your type is used by entities outside your organizational control, such as open source libraries or platform SDKs. This quickly leads to code that is difficult to work with, and code that is difficult to work with will slow developers down.</p>

<p class="author1">What’s worse is that you won’t truly know if an interface is natural to use until enough people depend on it, giving rise to the paradox. How can you even begin to design an interface if you don’t know how it will be used? Sure, you know how <em class="calibre6">you</em> would use the interface, and that’s a great start, but you have an implicit bias when creating the interface. What feels natural to you won’t feel natural to everyone else. Your goal is for your users to do the right things (and avoid the wrong things) with minimal effort. Ideally, the users should not need to do anything extra to use your interface correctly.</p>

<p class="author1">I don’t have a silver bullet for you; there is no foolproof way of writing an interface that meets everyone’s needs on the first try. Instead, I’ll talk about some principles you can apply to give you the best chance. For the cases where you need to make changes to an existing API, you’ll learn mitigation strategies. Your API is a first impression for other developers; make it count.</p>
</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 11. Defining Your Interfaces" class="preface">
<div class="preface" id="api">
<div data-type="note" epub:type="note" class="calibre21"><h1 class="calibre38" id="calibre_pb_1">Discussion Topic</h1>
<p class="author1">What interfaces are hard to use in your codebase? Look for common errors that people make when using your types. Also look for parts of your interface that are rarely invoked, especially if you feel like they are useful. Why don’t users call these useful functions? Discuss what costs appear when developers encounter these hard-to-use interfaces.</p>
</div>






</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 11. Defining Your Interfaces" class="preface">
<div class="preface" id="api">
<section data-type="sect1" data-pdf-bookmark="Natural Interface Design" class="preface"><div class="preface" id="idm45644739417336">
<h1 class="calibre12" id="calibre_pb_2">Natural Interface Design</h1>

<p class="author1">Your goal, tough as it may seem, is to make your interface appear natural to use.<a data-type="indexterm" data-primary="APIs" data-secondary="natural interface design" id="ix_APInat" class="calibre5"/> In other words, you want to reduce friction for the callers of your code.<a data-type="indexterm" data-primary="hard-to-use code, characteristics of" id="idm45644739414312" class="calibre5"/> When code is hard to use, the following happens:</p>
<dl class="calibre13">
<dt class="calibre14">Duplicated functionality</dt>
<dd class="calibre15">
<p class="calibre16">Some developers who find your types hard to use will write their own types, duplicating functionality. It may be healthy for different ideas to compete on a large scale (like competing open source projects), but it is not healthy for that divergence to be present in your codebase. Developers are presented with a multitude of types, not sure which one to use. With their attention split, their wires will get crossed and they will make mistakes, which creates bugs, which costs money. Also, if you want to add anything to one of these types, you need to add them in all the places the functionality has diverged, or you’ll create bugs, which costs money.</p>
</dd>
<dt class="calibre14">Broken mental model</dt>
<dd class="calibre15">
<p class="calibre16">Developers build up a mental model of the code they work with. If certain types are difficult to reason about, that mental model breaks. Developers will misuse your types, causing subtle bugs. Perhaps they don’t call methods in the order that you require. Perhaps they miss calling a method that they should have. Perhaps they just misunderstand what the code is doing and pass the wrong information to it. Any of these will introduce fragility into your codebase.</p>
</dd>
<dt class="calibre14">Reduced testing</dt>
<dd class="calibre15">
<p class="calibre16">Code that is hard to use is hard to test.<a data-type="indexterm" data-primary="testing" data-secondary="reduced, for code that's hard to test" id="idm45644739473976" class="calibre5"/> It doesn’t matter if it’s a complicated interface, a large chain of dependencies, or involved interactions; if you can’t easily test the code, fewer tests will be written. The fewer tests that are written, the fewer bugs you’ll catch when things change. It is very frustrating to deal with tests breaking in subtle ways every time a seemingly unrelated change is made.</p>
</dd>
</dl>

<p class="author1">Hard-to-use code will make your codebase unhealthy. You must take special care when designing your interfaces. Try to adhere to this rule of thumb from Scott <span class="calibre">Meyers</span>:</p>
<blockquote class="pcalibre2 calibre28 pcalibre1">
<p class="calibre29">Make interfaces easy to use correctly and hard to use incorrectly.<sup class="calibre11"><a data-type="noteref" id="idm45644739470600-marker" href="part0015_split_009.html#idm45644739470600" class="calibre5">1</a></sup></p></blockquote>

<p class="author1">You want developers to find your type easy to use, as if everything behaved as expected (this is a subtle restatement of the Law of Least Surprise, as mentioned in <a data-type="xref" href="part0003_split_000.html#intro" class="calibre5">Chapter 1</a>). <a data-type="indexterm" data-primary="Law of Least Surprise" id="idm45644739468168" class="calibre5"/>Furthermore, you also want to prevent users from using your types the wrong way. It is your job to think about all the behaviors that you should support <span class="calibre">and forbid</span> in your interface. To do this, you need to get into the heads of your <span class="calibre">collaborators</span>.</p>








</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 11. Defining Your Interfaces" class="preface">
<div class="preface" id="api">
<section data-type="sect1" data-pdf-bookmark="Natural Interface Design" class="preface">
<div class="preface" id="idm45644739417336">
<section data-type="sect2" data-pdf-bookmark="Thinking Like a User" class="preface"><div class="preface" id="idm45644739465688">
<h2 class="calibre34" id="calibre_pb_3">Thinking Like a User</h2>

<p class="author1">It’s tricky to think like a user, for you have been bestowed with the Curse of Knowledge.<a data-type="indexterm" data-primary="APIs" data-secondary="natural interface design" data-tertiary="thinking like a user" id="idm45644739463976" class="calibre5"/><a data-type="indexterm" data-primary="users, thinking like" id="idm45644739462712" class="calibre5"/> No arcane hex or mystical spell causes this; it is a by-product of your time with the codebase. As you build out ideas, you become so intimately familiar with them that it can blind you to how new users perceive your code. The first step to dealing with cognitive biases is to acknowledge them. From that point, you can take biases into account as you try to get into your users’ mindspace. Here are some useful strategies you can employ.</p>










<section data-type="sect3" data-pdf-bookmark="Test-driven development" class="preface"><div class="preface" id="idm45644739461320">
<h3 class="calibre44">Test-driven development</h3>

<p class="author1"><em class="calibre6">Test-driven development</em> (TDD), formulated <a data-type="indexterm" data-primary="APIs" data-secondary="natural interface design" data-tertiary="test-driven development" id="idm45644739459496" class="calibre5"/><a data-type="indexterm" data-primary="test-driven development (TDD)" id="idm45644739458200" class="calibre5"/>by Kent Beck in the early 2000s, is a popular framework for testing your code.<sup class="calibre11"><a data-type="noteref" id="idm45644739457384-marker" href="part0015_split_009.html#idm45644739457384" class="calibre5">2</a></sup> TDD revolves around a simple loop:</p>

<ul class="printings">
<li class="calibre9">
<p class="author1">Add a failing test.</p>
</li>
<li class="calibre9">
<p class="author1">Write just enough code to pass that test.</p>
</li>
<li class="calibre9">
<p class="author1">Refactor.</p>
</li>
</ul>

<p class="author1">There are entire books written about TDD, so I won’t go into too much detail about the mechanics.<sup class="calibre11"><a data-type="noteref" id="idm45644739452664-marker" href="part0015_split_009.html#idm45644739452664" class="calibre5">3</a></sup> However, the intent of TDD is <em class="calibre6">fabulous</em> for understanding how to use a type.</p>

<p class="author1">Many developers think that test-<em class="calibre6">driven</em> development (writing tests first) has similar benefits to test-<em class="calibre6">after</em> development (writing tests second). In both cases, you have tested code, right? When simplified to this degree, TDD doesn’t seem worth the effort.</p>

<p class="author1">However, this is an unfortunate oversimplification. The confusion stems from thinking of TDD as a testing methodology, when in fact, it is a <em class="calibre6">design methodology</em>. The tests are important, but they are merely a by-product of the methodology. The true value lies in how tests help design your interface.</p>

<p class="author1">With TDD, you are able to see how calling code looks before you write the implementation. Since you write the test first, you are given a chance to pause and ask yourself if how you interact with your types feels frictionless. If you find yourself making confusing function calls, building up long chains of dependencies, or having to write tests in a fixed order, you are experiencing red flags that should alert you that the type you’re building is too complicated. In these cases, reevaluate or refactor your interface. How great is it that you can simplify this code before you even write it?</p>

<p class="author1">As an additional benefit, your tests serve as a form of documentation. Other developers will want to know how to use your code, especially the parts that are not described in top-level documentation. A good set of comprehensive unit tests provides working documentation of exactly how to use your type; you want them to leave a good first impression. Just as your code is a single source of truth for the behavior in your system, your tests are the single source of truth for interacting with your code.</p>
</div></section>













<section data-type="sect3" data-pdf-bookmark="README-driven development" class="preface"><div class="preface" id="idm45644739445224">
<h3 class="calibre44">README-driven development</h3>

<p class="author1">Similar to TDD, README-driven development (RDD), <a href="https://oreil.ly/qd16A" class="calibre5">coined by Tom Preston-Werner</a>, is another design methodology aimed at catching hard-to-use code before it’s written.<a data-type="indexterm" data-primary="APIs" data-secondary="natural interface design" data-tertiary="README-driven development" id="idm45644739442952" class="calibre5"/><a data-type="indexterm" data-primary="README-driven development (RDD)" id="idm45644739441656" class="calibre5"/> The goal with RDD is to distill your top-level ideas and most important interactions with your code into a single document that lives in your project: a README file. This is a great way to formulate how different parts of your code interact, and might provide higher level patterns for users to <span class="calibre">follow</span>.</p>

<p class="author1">RDD boasts some of the following benefits:</p>

<ul class="printings">
<li class="calibre9">
<p class="author1">No need to create every level of documentation up front, like you would in a Waterfall methodology.</p>
</li>
<li class="calibre9">
<p class="author1">A README is often the first thing a developer sees; RDD gives you a chance to craft the best first impression you can.</p>
</li>
<li class="calibre9">
<p class="author1">It is easier to change the documentation based on team discussion than it is to change written code.</p>
</li>
<li class="calibre9">
<p class="author1">You don’t need to use the README to explain poor code decisions; instead, the code needs to morph to support the ideal use cases.</p>
</li>
</ul>

<p class="author1">Remember, you are only successful in building maintainable software if future developers can actually maintain it. Give them every chance you can to succeed and craft them an experience starting at your documentation.</p>
</div></section>













<section data-type="sect3" data-pdf-bookmark="Usability testing" class="preface"><div class="preface" id="idm45644739855192">
<h3 class="calibre44">Usability testing</h3>

<p class="author1">Ultimately, you are trying to think about how your users think.<a data-type="indexterm" data-primary="APIs" data-secondary="natural interface design" data-tertiary="usability testing" id="idm45644739853624" class="calibre5"/><a data-type="indexterm" data-primary="usability testing" id="idm45644739852408" class="calibre5"/><a data-type="indexterm" data-primary="user experience (UX)" id="idm45644739851736" class="calibre5"/> There is a whole discipline dedicated to this very task: user experience (UX). UX is another area where there are countless books available, so I’ll just focus on one strategy that has done me wonders in simplifying code: usability testing.</p>

<p class="author1">Usability testing is the process of actively asking your users what they think of your product. It sounds so simple, doesn’t it? In order to think about how your users will behave, just ask them. The simplest thing you can do is talk to potential users (in this case, other developers), but it’s easy to overlook.</p>

<p class="author1">It’s incredibly easy to get started with usability testing through hallway testing. As you design your interface, just grab the first person to walk down your hallway and ask them to give feedback on your design. This is a great low-cost way of learning pain points. Don’t take this advice too literally though. Feel free to expand beyond whoever you see in a hallway and ask teammates, peers, or testers to evaluate your <span class="calibre">interface</span>.</p>

<p class="author1">However, for interfaces that will be used by a much broader audience (such as the interface of a popular open source library), you may want something a tad more formal. In these cases, usability testing involves placing your prospective users in front of the interface that you’re writing. You give them a set of tasks to complete, and then observe. Your role is not to teach them or lead them through the exercises, but to see where they struggle and where they excel. Learn from their struggles; they are showing areas that are definitively hard to use.</p>
<div data-type="tip" class="calibre21"><h6 class="calibre22">Tip</h6>
<p class="author1">Usability testing is a great task for the more junior members on your team. Their curse of knowledge won’t be as strong as with the senior members, and they will be more likely to evaluate the design with a fresh set of eyes.</p>
</div>
</div></section>



</div></section>





</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 11. Defining Your Interfaces" class="preface">
<div class="preface" id="api">
<section data-type="sect1" data-pdf-bookmark="Natural Interactions" class="preface"><div class="preface" id="idm45644739845880">
<h1 class="calibre12" id="calibre_pb_4">Natural Interactions</h1>

<p class="author1">Donald Norman describes a mapping as<a data-type="indexterm" data-primary="APIs" data-secondary="natural interface design" data-startref="ix_APInat" id="idm45644739844472" class="calibre5"/><a data-type="indexterm" data-primary="APIs" data-secondary="natural interactions" id="ix_APInatint" class="calibre5"/> a relationship between “controls and their movements with results in the real world.” That mapping is natural if it “takes advantage of physical analogies and cultural standards, [leading] to immediate understanding.”<sup class="calibre11"><a data-type="noteref" id="idm45644739841848-marker" href="part0015_split_009.html#idm45644739841848" class="calibre5">4</a></sup> This is what you strive for when you write an interface. You want that immediate understanding to eliminate confusion.</p>

<p class="author1">The “controls and their movements” in this case are the functions and types that make up your interface. The “results in the real world” represent the behavior of the code. For this to feel natural, the operations have to agree with the mental model of the user. This is what Donald Norman means when talking about “physical analogies and cultural standards.” You must connect with the readers of your code in a way that they understand, drawing on their experiences and knowledge. The best way to do this is mapping your domain and other common knowledge into your code.</p>

<p class="author1">When designing an interface, you need to think through the entire life cycle of a user’s interactions and ask yourself if the entirety of it maps to what a user unfamiliar with your code would understand. Model your interface such that it is easy to comprehend for someone who knows the domain well, even if they aren’t familiar with code. As you do this, your interface becomes intuitive, which lessens the chances of developers making mistakes.</p>








</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 11. Defining Your Interfaces" class="preface">
<div class="preface" id="api">
<section data-type="sect1" data-pdf-bookmark="Natural Interactions" class="preface">
<div class="preface" id="idm45644739845880">
<section data-type="sect2" data-pdf-bookmark="Natural Interfaces in Action" class="preface"><div class="preface" id="idm45644739838536">
<h2 class="calibre34" id="calibre_pb_5">Natural Interfaces in Action</h2>

<p class="author1">For this chapter, you’re going to design an interface for part of an automated grocery pick-up service. A user scans their recipes using their smartphone, and the app will automatically figure out what ingredients are required. After the user confirms the order, the app queries local grocery stores for ingredient availability and schedules delivery. <a data-type="xref" href="part0015_split_005.html#figure_11_1" class="calibre5">Figure 11-1</a> provides a representation of this workflow.</p>

<p class="author1">I’m going to focus on the specific interface for building up an order given a set of <span class="calibre">recipes</span>.</p>

<figure class="calibre36"><div id="figure_11_1" class="figure">
<img src="../images/00015.gif" alt="Workflow for automated grocery delivery app" class="calibre40"/>
<h6 class="calibre37"><span class="calibre">Figure 11-1. </span>Workflow for automated grocery delivery app</h6>
</div></figure>

<p class="author1">To represent a recipe, I’ll modify parts of the <code class="calibre17">Recipe</code> <code class="calibre17">dataclass</code> from <a data-type="xref" href="part0013_split_000.html#dataclasses" class="calibre5">Chapter 9</a>:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="k">from</code> <code class="nn">dataclasses</code> <code class="k">import</code> <code class="n">dataclass</code>
<code class="k">from</code> <code class="nn">enum</code> <code class="k">import</code> <code class="n">auto</code><code class="calibre17">,</code> <code class="n">Enum</code>

<code class="k">from</code> <code class="nn">grocery.measure</code> <code class="k">import</code> <code class="n">ImperialMeasure</code>

<code class="nd">@dataclass</code><code class="calibre17">(</code><code class="n">frozen</code><code class="calibre17">=</code><code class="nb">True</code><code class="calibre17">)</code>
<code class="k">class</code> <code class="nc">Ingredient</code><code class="calibre17">:</code>
    <code class="n">name</code><code class="calibre17">:</code> <code class="nb">str</code>
    <code class="n">brand</code><code class="calibre17">:</code> <code class="nb">str</code>
    <code class="n">amount</code><code class="calibre17">:</code> <code class="nb">float</code> <code class="calibre17">=</code> <code class="mi">1</code>
    <code class="n">units</code><code class="calibre17">:</code> <code class="n">ImperialMeasure</code> <code class="calibre17">=</code> <code class="n">ImperialMeasure</code><code class="calibre17">.</code><code class="n">CUP</code>

<code class="nd">@dataclass</code>
<code class="k">class</code> <code class="nc">Recipe</code><code class="calibre17">:</code>
    <code class="n">name</code><code class="calibre17">:</code> <code class="nb">str</code>
    <code class="n">ingredients</code><code class="calibre17">:</code> <code class="nb">list</code><code class="calibre17">[</code><code class="n">Ingredient</code><code class="calibre17">]</code>
    <code class="n">servings</code><code class="calibre17">:</code> <code class="nb">int</code></pre>

<p class="author1">The codebase also has functions and types to retrieve local grocery store inventory:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="k">import</code> <code class="nn">decimal</code>
<code class="k">from</code> <code class="nn">dataclasses</code> <code class="k">import</code> <code class="n">dataclass</code>
<code class="k">from</code> <code class="nn">typing</code> <code class="k">import</code> <code class="n">Iterable</code>

<code class="k">from</code> <code class="nn">grocery.geospatial</code> <code class="k">import</code> <code class="n">Coordinates</code>
<code class="k">from</code> <code class="nn">grocery.measure</code> <code class="k">import</code> <code class="n">ImperialMeasure</code>

<code class="nd">@dataclass</code><code class="calibre17">(</code><code class="n">frozen</code><code class="calibre17">=</code><code class="nb">True</code><code class="calibre17">)</code>
<code class="k">class</code> <code class="nc">Store</code><code class="calibre17">:</code>
    <code class="n">coordinates</code><code class="calibre17">:</code> <code class="n">Coordinates</code>
    <code class="n">name</code><code class="calibre17">:</code> <code class="nb">str</code>


<code class="nd">@dataclass</code><code class="calibre17">(</code><code class="n">frozen</code><code class="calibre17">=</code><code class="nb">True</code><code class="calibre17">)</code>
<code class="k">class</code> <code class="nc">Item</code><code class="calibre17">:</code>
    <code class="n">name</code><code class="calibre17">:</code> <code class="nb">str</code>
    <code class="n">brand</code><code class="calibre17">:</code> <code class="nb">str</code>
    <code class="n">measure</code><code class="calibre17">:</code> <code class="n">ImperialMeasure</code>
    <code class="n">price_in_cents</code><code class="calibre17">:</code> <code class="n">decimal</code><code class="calibre17">.</code><code class="n">Decimal</code>
    <code class="n">amount</code><code class="calibre17">:</code> <code class="nb">float</code>

<code class="n">Inventory</code> <code class="calibre17">=</code> <code class="nb">dict</code><code class="calibre17">[</code><code class="n">Store</code><code class="calibre17">,</code> <code class="n">List</code><code class="calibre17">[</code><code class="n">Item</code><code class="calibre17">]]</code>
<code class="k">def</code> <code class="nf">get_grocery_inventory</code><code class="calibre17">()</code> <code class="calibre17">-&gt;</code> <code class="n">Inventory</code><code class="calibre17">:</code>
    <code class="c"># reach out to APIs and populate the dictionary</code>
    <code class="c"># ... snip ...</code>

<code class="k">def</code> <code class="nf">reserve_items</code><code class="calibre17">(</code><code class="n">store</code><code class="calibre17">:</code> <code class="n">Store</code><code class="calibre17">,</code> <code class="n">items</code><code class="calibre17">:</code> <code class="n">Iterable</code><code class="calibre17">[</code><code class="n">Item</code><code class="calibre17">])</code> <code class="calibre17">-&gt;</code> <code class="nb">bool</code><code class="calibre17">:</code>
    <code class="c"># ... snip ...</code>

<code class="k">def</code> <code class="nf">unreserve_items</code><code class="calibre17">(</code><code class="n">store</code><code class="calibre17">:</code> <code class="n">Store</code><code class="calibre17">,</code> <code class="n">items</code><code class="calibre17">:</code> <code class="n">Iterable</code><code class="calibre17">[</code><code class="n">Item</code><code class="calibre17">])</code> <code class="calibre17">-&gt;</code> <code class="nb">bool</code><code class="calibre17">:</code>
    <code class="c"># ... snip ...</code>

<code class="k">def</code> <code class="nf">order_items</code><code class="calibre17">(</code><code class="n">store</code><code class="calibre17">:</code> <code class="n">Store</code><code class="calibre17">,</code> <code class="n">item</code><code class="calibre17">:</code> <code class="n">items</code><code class="calibre17">:</code> <code class="n">Iterable</code><code class="calibre17">[</code><code class="n">Item</code><code class="calibre17">])</code> <code class="calibre17">-&gt;</code> <code class="nb">bool</code><code class="calibre17">:</code>
    <code class="c"># ... snip ...</code></pre>

<p class="author1">The other developers in the codebase have already set up the code to figure out the recipes from smartphone scans, but now they need to generate the ingredient list to order from each grocery store. That’s where you come in. Here’s what they have so far:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="n">recipes</code><code class="calibre17">:</code> <code class="n">List</code><code class="calibre17">[</code><code class="n">Recipe</code><code class="calibre17">]</code> <code class="calibre17">=</code> <code class="n">get_recipes_from_scans</code><code class="calibre17">()</code>

<code class="c"># We need to do something here to get the order</code>
<code class="n">order</code> <code class="calibre17">=</code> <code class="err">????</code>
<code class="c"># the user can make changes if needed</code>
<code class="n">display_order</code><code class="calibre17">(</code><code class="n">order</code><code class="calibre17">)</code> <code class="c"># TODO once we know what an order is</code>
<code class="n">wait_for_user_order_confirmation</code><code class="calibre17">()</code>
<code class="k">if</code> <code class="n">order</code><code class="calibre17">.</code><code class="n">is_confirmed</code><code class="calibre17">():</code>
    <code class="n">grocery_inventory</code> <code class="calibre17">=</code> <code class="n">get_grocery_inventory</code><code class="calibre17">()</code>
    <code class="c"># HELP, what do we do with ingredients now that we have grocery inventory</code>
    <code class="n">grocery_list</code> <code class="calibre17">=</code>  <code class="err">????</code>
    <code class="c"># HELP we need to do some reservation of ingredients so others</code>
    <code class="c"># don't take them</code>
    <code class="n">wait_for_user_grocery_confirmation</code><code class="calibre17">(</code><code class="n">grocery_list</code><code class="calibre17">)</code>
    <code class="c"># HELP - actually order the ingredients ????</code>
    <code class="n">deliver_ingredients</code><code class="calibre17">(</code><code class="n">grocery_list</code><code class="calibre17">)</code></pre>

<p class="author1">Your goal is to fill in the blanks marked <code class="calibre17">HELP</code> or <code class="calibre17">????</code>. I want you to get in the habit of deliberately designing your interface before you start coding. How would you describe the purpose of the code to a nontechnical product manager or marketing agent? Take a few minutes before looking at the following code: how do you want a user to interact with your interface?</p>

<p class="author1">Here’s what I came up with (there are plenty of ways to solve this; it’s OK if you have something vastly different):</p>
<ol class="calibre30">
<li value="1" class="calibre31">
<p class="author1">For each recipe received, grab all the ingredients and aggregate them together. This becomes an <code class="calibre17">Order</code>.</p>
</li>
<li value="2" class="calibre31">
<p class="author1">An <code class="calibre17">Order</code> is a list of ingredients, and the user can add/remove ingredients as needed. However, once confirmed, the <code class="calibre17">Order</code> should not be changeable.</p>
</li>
<li value="3" class="calibre31">
<p class="author1">Once the order is confirmed, take all the ingredients and figure out what stores have the items available. This is a <code class="calibre17">Grocery List</code>.</p>
</li>
<li value="4" class="calibre31">
<p class="author1">A <code class="calibre17">Grocery List</code> contains a list of stores and the items to pick up from each store. Each item is reserved at the store until the app places the order. Items may come from different stores; the app tries to find the cheapest item that matches.</p>
</li>
<li value="5" class="calibre31">
<p class="author1">Once the user confirms the <code class="calibre17">GroceryList</code>, place the order. Grocery items are unreserved and set for delivery.</p>
</li>
<li value="6" class="calibre31">
<p class="author1">The order is delivered to the user’s home.</p>
</li>

</ol>
<div data-type="note" epub:type="note" class="calibre21"><h6 class="calibre22">Note</h6>
<p class="author1">Isn’t it amazing that you can come up with an implementation without having to know exactly how <code class="calibre17">get_recipe_from_scans</code> or <code class="calibre17">get_grocery_inventory</code> is implemented? This is the beauty of having types to describe domain concepts: if these were represented by tuples or dictionaries (or with no type annotations, which makes me shudder), you’d have to go digging through the codebase finding out what data you were dealing with.</p>
</div>

<p class="author1">That description of the interface contained no code concepts; it was all described in a way that is familiar to workers in the grocery domain. When designing an interface, you want to map as naturally to the domain as you can.</p>

<p class="author1">Let’s start with the order handling by creating a class:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="k">from</code> <code class="nn">typing</code> <code class="k">import</code> <code class="n">Iterable</code><code class="calibre17">,</code> <code class="n">Optional</code>
<code class="k">from</code> <code class="nn">copy</code> <code class="k">import</code> <code class="n">deepcopy</code>
<code class="k">class</code> <code class="nc">Order</code><code class="calibre17">:</code>
    <code class="sd">''' An Order class that represents a list of ingredients '''</code>
    <code class="k">def</code> <code class="calibre17">__init__</code><code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">,</code> <code class="n">recipes</code><code class="calibre17">:</code> <code class="n">Iterable</code><code class="calibre17">[</code><code class="n">Recipe</code><code class="calibre17">]):</code>
        <code class="nb">self</code><code class="calibre17">.</code><code class="n">__ingredients</code><code class="calibre17">:</code> <code class="nb">set</code><code class="calibre17">[</code><code class="n">Ingredient</code><code class="calibre17">]</code> <code class="calibre17">=</code> <code class="nb">set</code><code class="calibre17">()</code>
        <code class="k">for</code> <code class="n">recipe</code> <code class="calibre19">in</code> <code class="n">recipes</code><code class="calibre17">:</code>
            <code class="k">for</code> <code class="n">ingredient</code> <code class="calibre19">in</code> <code class="n">recipe</code><code class="calibre17">.</code><code class="n">ingredients</code><code class="calibre17">:</code>
                <code class="nb">self</code><code class="calibre17">.</code><code class="n">add_ingredient</code><code class="calibre17">(</code><code class="n">ingredient</code><code class="calibre17">)</code>

    <code class="k">def</code> <code class="nf">get_ingredients</code><code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">)</code> <code class="calibre17">-&gt;</code> <code class="nb">list</code><code class="calibre17">[</code><code class="n">Ingredient</code><code class="calibre17">]:</code>
        <code class="sd">''' Return a alphabetically sorted list of ingredients '''</code>
        <code class="c"># return a copy so that users won't inadvertently mess with</code>
        <code class="c"># our internal data</code>
        <code class="k">return</code> <code class="nb">sorted</code><code class="calibre17">(</code><code class="n">deepcopy</code><code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">.</code><code class="n">__ingredients</code><code class="calibre17">),</code>
                        <code class="n">key</code><code class="calibre17">=</code><code class="k">lambda</code> <code class="n">ing</code><code class="calibre17">:</code> <code class="n">ing</code><code class="calibre17">.</code><code class="n">name</code><code class="calibre17">)</code>

       <code class="k">def</code> <code class="nf">_get_matching_ingredient</code><code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">,</code>
                                 <code class="n">ingredient</code><code class="calibre17">:</code> <code class="n">Ingredient</code><code class="calibre17">)</code> <code class="calibre17">-&gt;</code> <code class="n">Optional</code><code class="calibre17">[</code><code class="n">Ingredient</code><code class="calibre17">]:</code>
        <code class="k">try</code><code class="calibre17">:</code>
            <code class="k">return</code> <code class="nb">next</code><code class="calibre17">(</code><code class="n">ing</code> <code class="k">for</code> <code class="n">ing</code> <code class="calibre19">in</code> <code class="nb">self</code><code class="calibre17">.</code><code class="n">__ingredients</code> <code class="k">if</code>
                        <code class="calibre17">((</code><code class="n">ing</code><code class="calibre17">.</code><code class="n">name</code><code class="calibre17">,</code> <code class="n">ing</code><code class="calibre17">.</code><code class="n">brand</code><code class="calibre17">)</code> <code class="calibre17">==</code>
                         <code class="calibre17">(</code><code class="n">ingredient</code><code class="calibre17">.</code><code class="n">name</code><code class="calibre17">,</code> <code class="n">ingredient</code><code class="calibre17">.</code><code class="n">brand</code><code class="calibre17">)))</code>
        <code class="k">except</code> <code class="ne">StopIteration</code><code class="calibre17">:</code>
            <code class="k">return</code> <code class="nb">None</code>

    <code class="k">def</code> <code class="nf">add_ingredient</code><code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">,</code> <code class="n">ingredient</code><code class="calibre17">:</code> <code class="n">Ingredient</code><code class="calibre17">):</code>
        <code class="sd">''' adds the ingredient if it's not already added,</code>
<code class="sd">            or increases the amount if it has</code>
<code class="sd">        '''</code>
        <code class="n">target_ingredient</code> <code class="calibre17">=</code> <code class="nb">self</code><code class="calibre17">.</code><code class="n">_get_matching_ingredient</code><code class="calibre17">(</code><code class="n">ingredient</code><code class="calibre17">)</code>
        <code class="k">if</code> <code class="n">target_ingredient</code> <code class="calibre19">is</code> <code class="nb">None</code><code class="calibre17">:</code>
            <code class="c"># ingredient for the first time - add it</code>
            <code class="nb">self</code><code class="calibre17">.</code><code class="n">__ingredients</code><code class="calibre17">.</code><code class="n">add</code><code class="calibre17">(</code><code class="n">ingredient</code><code class="calibre17">)</code>
        <code class="k">else</code><code class="calibre17">:</code>
            <code class="c"># add ingredient to existing set</code>
            <code class="err">????</code></pre>

<p class="author1">Not too bad of a start. If I look at the first step of my description above, it matches pretty closely to the code. I am getting the ingredients from each recipe and aggregating them together in a set. I’m having some trouble with how I want to represent adding ingredients to the set I’m already tracking, but I’ll come back to this in a bit, I promise.</p>

<p class="author1">For now, I want to make sure that I am properly representing the invariant of an <code class="calibre17">Order</code>. If the order is confirmed, a user should not be able to modify anything inside it. I’ll change the <code class="calibre17">Order</code> class to do the following:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="c"># create a new exception type so that users can explicitly catch this error</code>
<code class="k">class</code> <code class="nc">OrderAlreadyFinalizedError</code><code class="calibre17">(</code><code class="ne">RuntimeError</code><code class="calibre17">):</code>
    <code class="c"># inheriting from RuntimeError to allow users to provide a message</code>
    <code class="c"># when raising this exception</code>
    <code class="k">pass</code>

<code class="k">class</code> <code class="nc">Order</code><code class="calibre17">:</code>
    <code class="sd">''' An Order class that represents a list of ingredients</code>
<code class="sd">        Once confirmed, it cannot be modified</code>
<code class="sd">     '''</code>
    <code class="k">def</code> <code class="calibre17">__init__</code><code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">,</code> <code class="n">recipes</code><code class="calibre17">:</code> <code class="n">Iterable</code><code class="calibre17">[</code><code class="n">Recipe</code><code class="calibre17">]):</code>
        <code class="nb">self</code><code class="calibre17">.</code><code class="n">__confirmed</code> <code class="calibre17">=</code> <code class="nb">False</code>
        <code class="c"># ... snip ...</code>

    <code class="c"># ... snip ...</code>

    <code class="k">def</code> <code class="nf">add_ingredient</code><code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">,</code> <code class="n">ingredient</code><code class="calibre17">:</code> <code class="n">Ingredient</code><code class="calibre17">):</code>
        <code class="nb">self</code><code class="calibre17">.</code><code class="n">__disallow_modification_if_confirmed</code><code class="calibre17">()</code>
        <code class="c"># ... snip ...</code>


    <code class="k">def</code> <code class="nf">__disallow_modification_if_confirmed</code><code class="calibre17">():</code>
        <code class="k">if</code> <code class="nb">self</code><code class="calibre17">.</code><code class="n">__confirmed</code><code class="calibre17">:</code>
            <code class="k">raise</code> <code class="n">OrderAlreadyFinalizedError</code><code class="calibre17">(</code><code class="s">'Order is confirmed -'</code>
                                             <code class="s">' changing it is not allowed'</code><code class="calibre17">)</code>

    <code class="k">def</code> <code class="nf">confirm</code><code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">):</code>
        <code class="nb">self</code><code class="calibre17">.</code><code class="n">__confirmed</code> <code class="calibre17">=</code> <code class="nb">True</code>

    <code class="k">def</code> <code class="nf">unconfirm</code><code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">):</code>
        <code class="nb">self</code><code class="calibre17">.</code><code class="n">__confirmed</code> <code class="calibre17">=</code> <code class="nb">False</code>

    <code class="k">def</code> <code class="nf">is_confirmed</code><code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">):</code>
        <code class="k">return</code> <code class="nb">self</code><code class="calibre17">.</code><code class="n">__confirmed</code></pre>

<p class="author1">Now I have the first two items on my list represented in code, and the code mirrors the description pretty closely. By using a type to represent the <code class="calibre17">Order</code>, I have created an interface for the calling code to operate with. You can construct an order with <code class="calibre17">order = Order(recipes)</code> and then use that order to add ingredients, change the amount of existing ingredients, and handle confirmation logic.</p>

<p class="author1">The only thing that is missing is that <code class="calibre17">????</code> when adding an ingredient that I’m already tracking (such as adding an extra 3 cups of flour). My first instinct was to just add the amounts together, but that won’t work if the units of measure are different, such as adding 1 cup of olive oil to 1 tablespoon. Neither 2 tablespoons nor 2 cups is the right answer.</p>

<p class="author1">I could do type conversions right here in the code, but that doesn’t feel natural. What I really want to do is do something like <code class="calibre17">already_tracked_ingredient += new_ingredient</code>. But doing that gives me an exception:</p>
<pre class="calibre35">TypeError: unsupported operand type(s) for +=: 'Ingredient' and 'Ingredient'</pre>

<p class="author1">However, this is achievable; I just have to use a little Python magic to make it so.</p>
</div></section>













</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 11. Defining Your Interfaces" class="preface">
<div class="preface" id="api">
<section data-type="sect1" data-pdf-bookmark="Natural Interactions" class="preface">
<div class="preface" id="idm45644739845880">
<section data-type="sect2" data-pdf-bookmark="Magic Methods" class="preface"><div class="preface" id="idm45644738360952">
<h2 class="calibre34" id="calibre_pb_6">Magic Methods</h2>

<p class="author1"><em class="calibre6">Magic methods</em> allow you to define custom behavior when built-in operations are invoked in Python.<a data-type="indexterm" data-primary="APIs" data-secondary="natural interactions" data-tertiary="magic methods" id="idm45644738553400" class="calibre5"/><a data-type="indexterm" data-primary="magic methods" id="idm45644738552264" class="calibre5"/><a data-type="indexterm" data-primary="dunder (double underscore) methods" id="idm45644738551592" class="calibre5"/> A magic method is prefixed and suffixed by two underscores. Because of this, they are sometimes called <em class="calibre6">dunder</em> methods (or <em class="calibre6">double underscore</em> methods).<a data-type="indexterm" data-primary="underscores" data-secondary="double underscores surrounding magic methods" id="idm45644738549720" class="calibre5"/> You’ve already seen them in earlier chapters:</p>

<ul class="printings">
<li class="calibre9">
<p class="author1">In <a data-type="xref" href="part0014_split_000.html#classes" class="calibre5">Chapter 10</a>, I used<a data-type="indexterm" data-primary="__init__ method" data-seealso="constructors" data-primary-sortas="init" id="idm45644738546536" class="calibre5"/> the <code class="calibre17">__init__</code> method to construct a class. <code class="calibre17">__init__</code> gets called whenever a class is constructed.</p>
</li>
<li class="calibre9">
<p class="author1">In <a data-type="xref" href="part0013_split_000.html#dataclasses" class="calibre5">Chapter 9</a>, I used <code class="calibre17">__lt__</code>, <code class="calibre17">__gt__</code>, and others to<a data-type="indexterm" data-primary="__lt method__" data-primary-sortas="lt" id="idm45644738541576" class="calibre5"/><a data-type="indexterm" data-primary="__gt__ method" data-primary-sortas="gt" id="idm45644738540568" class="calibre5"/> define what happens when two objects were compared with &lt; or &gt;, respectively.</p>
</li>
<li class="calibre9">
<p class="author1">In <a data-type="xref" href="part0008_split_000.html#collections" class="calibre5">Chapter 5</a>, I introduced <code class="calibre17">__getitem__</code> for intercepting <a data-type="indexterm" data-primary="__getitem__ method" data-primary-sortas="getitem" id="idm45644738537288" class="calibre5"/>calls to indexing with brackets such as <code class="calibre17">recipes['Stromboli']</code>.</p>
</li>
</ul>

<p class="author1">I can use the magic method <code class="calibre17">__add__</code> to control<a data-type="indexterm" data-primary="__add__ method" data-primary-sortas="add" id="idm45644738534584" class="calibre5"/> behavior for addition:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="nd">@dataclass</code><code class="calibre17">(</code><code class="n">frozen</code><code class="calibre17">=</code><code class="nb">True</code><code class="calibre17">)</code>
<code class="k">class</code> <code class="nc">Ingredient</code><code class="calibre17">:</code>
    <code class="n">name</code><code class="calibre17">:</code> <code class="nb">str</code>
    <code class="n">brand</code><code class="calibre17">:</code> <code class="nb">str</code>
    <code class="n">amount</code><code class="calibre17">:</code> <code class="nb">float</code> <code class="calibre17">=</code> <code class="mi">1</code>
    <code class="n">units</code><code class="calibre17">:</code> <code class="n">ImperialMeasure</code> <code class="calibre17">=</code> <code class="n">ImperialMeasure</code><code class="calibre17">.</code><code class="n">CUP</code>

    <code class="k">def</code> <code class="calibre17">__add__</code><code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">,</code> <code class="n">rhs</code><code class="calibre17">:</code> <code class="n">Ingredient</code><code class="calibre17">):</code>
        <code class="c"># make sure we are adding the same ingredient</code>
        <code class="k">assert</code> <code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">.</code><code class="n">name</code><code class="calibre17">,</code> <code class="nb">self</code><code class="calibre17">.</code><code class="n">brand</code><code class="calibre17">)</code> <code class="calibre17">==</code> <code class="calibre17">(</code><code class="n">rhs</code><code class="calibre17">.</code><code class="n">name</code><code class="calibre17">,</code> <code class="n">rhs</code><code class="calibre17">.</code><code class="n">brand</code><code class="calibre17">)</code>
        <code class="c"># build up conversion chart (lhs, rhs): multiplication factor</code>
        <code class="n">conversion</code><code class="calibre17">:</code> <code class="nb">dict</code><code class="calibre17">[</code><code class="nb">tuple</code><code class="calibre17">[</code><code class="n">ImperialMeasure</code><code class="calibre17">,</code> <code class="n">ImperialMeasure</code><code class="calibre17">],</code> <code class="nb">float</code><code class="calibre17">]</code> <code class="calibre17">=</code> <code class="calibre17">{</code>
            <code class="calibre17">(</code><code class="n">ImperialMeasure</code><code class="calibre17">.</code><code class="n">CUP</code><code class="calibre17">,</code> <code class="n">ImperialMeasure</code><code class="calibre17">.</code><code class="n">CUP</code><code class="calibre17">):</code> <code class="mi">1</code><code class="calibre17">,</code>
            <code class="calibre17">(</code><code class="n">ImperialMeasure</code><code class="calibre17">.</code><code class="n">CUP</code><code class="calibre17">,</code> <code class="n">ImperialMeasure</code><code class="calibre17">.</code><code class="n">TABLESPOON</code><code class="calibre17">):</code> <code class="mi">16</code><code class="calibre17">,</code>
            <code class="calibre17">(</code><code class="n">ImperialMeasure</code><code class="calibre17">.</code><code class="n">CUP</code><code class="calibre17">,</code> <code class="n">ImperialMeasure</code><code class="calibre17">.</code><code class="n">TEASPOON</code><code class="calibre17">):</code> <code class="mi">48</code><code class="calibre17">,</code>
            <code class="calibre17">(</code><code class="n">ImperialMeasure</code><code class="calibre17">.</code><code class="n">TABLESPOON</code><code class="calibre17">,</code> <code class="n">ImperialMeasure</code><code class="calibre17">.</code><code class="n">CUP</code><code class="calibre17">):</code> <code class="mi">1</code><code class="calibre17">/</code><code class="mi">16</code><code class="calibre17">,</code>
            <code class="calibre17">(</code><code class="n">ImperialMeasure</code><code class="calibre17">.</code><code class="n">TABLESPOON</code><code class="calibre17">,</code> <code class="n">ImperialMeasure</code><code class="calibre17">.</code><code class="n">TABLESPOON</code><code class="calibre17">):</code> <code class="mi">1</code><code class="calibre17">,</code>
            <code class="calibre17">(</code><code class="n">ImperialMeasure</code><code class="calibre17">.</code><code class="n">TABLESPOON</code><code class="calibre17">,</code> <code class="n">ImperialMeasure</code><code class="calibre17">.</code><code class="n">TEASPOON</code><code class="calibre17">):</code> <code class="mi">3</code><code class="calibre17">,</code>
            <code class="calibre17">(</code><code class="n">ImperialMeasure</code><code class="calibre17">.</code><code class="n">TEASPOON</code><code class="calibre17">,</code> <code class="n">ImperialMeasure</code><code class="calibre17">.</code><code class="n">CUP</code><code class="calibre17">):</code> <code class="mi">1</code><code class="calibre17">/</code><code class="mi">48</code><code class="calibre17">,</code>
            <code class="calibre17">(</code><code class="n">ImperialMeasure</code><code class="calibre17">.</code><code class="n">TEASPOON</code><code class="calibre17">,</code> <code class="n">ImperialMeasure</code><code class="calibre17">.</code><code class="n">TABLESPOON</code><code class="calibre17">):</code> <code class="mi">1</code><code class="calibre17">/</code><code class="mi">3</code><code class="calibre17">,</code>
            <code class="calibre17">(</code><code class="n">ImperialMeasure</code><code class="calibre17">.</code><code class="n">TEASPOON</code><code class="calibre17">,</code> <code class="n">ImperialMeasure</code><code class="calibre17">.</code><code class="n">TEASPOON</code><code class="calibre17">):</code> <code class="mi">1</code>
        <code class="calibre17">}</code>

        <code class="k">return</code> <code class="n">Ingredient</code><code class="calibre17">(</code><code class="n">rhs</code><code class="calibre17">.</code><code class="n">name</code><code class="calibre17">,</code>
                          <code class="n">rhs</code><code class="calibre17">.</code><code class="n">brand</code><code class="calibre17">,</code>
                          <code class="n">rhs</code><code class="calibre17">.</code><code class="n">amount</code> <code class="calibre17">+</code> <code class="nb">self</code><code class="calibre17">.</code><code class="n">amount</code> <code class="calibre17">*</code> <code class="n">conversion</code><code class="calibre17">[(</code><code class="n">rhs</code><code class="calibre17">.</code><code class="n">units</code><code class="calibre17">,</code>
                                                                 <code class="nb">self</code><code class="calibre17">.</code><code class="n">units</code><code class="calibre17">)],</code>
                          <code class="n">rhs</code><code class="calibre17">.</code><code class="n">units</code><code class="calibre17">)</code></pre>

<p class="author1">Now with the <code class="calibre17">__add__</code> method defined, I can add ingredients together with the <code class="calibre17">+</code> operator. The <code class="calibre17">add_ingredient</code> method can look like the following:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="k">def</code> <code class="nf">add_ingredient</code><code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">,</code> <code class="n">ingredient</code><code class="calibre17">:</code> <code class="n">Ingredient</code><code class="calibre17">):</code>
    <code class="sd">'''Adds the ingredient if it's not already added,</code>
<code class="sd">       or increases the amount if it has '''</code>

    <code class="n">target_ingredient</code> <code class="calibre17">=</code> <code class="nb">self</code><code class="calibre17">.</code><code class="n">_get_matching_ingredient</code><code class="calibre17">(</code><code class="n">ingredient</code><code class="calibre17">)</code>
    <code class="k">if</code> <code class="n">target_ingredient</code> <code class="calibre19">is</code> <code class="nb">None</code><code class="calibre17">:</code>
        <code class="c"># ingredient for the first time - add it</code>
        <code class="nb">self</code><code class="calibre17">.</code><code class="n">__ingredients</code><code class="calibre17">.</code><code class="n">add</code><code class="calibre17">(</code><code class="n">ingredient</code><code class="calibre17">)</code>
    <code class="k">else</code><code class="calibre17">:</code>
        <code class="c"># add ingredient to existing set</code>
        <code class="n">target_ingredient</code> <code class="calibre17">+=</code> <code class="n">ingredient</code></pre>

<p class="author1">I can now express the idea of adding ingredients naturally. It doesn’t stop here, either. I can define subtraction, or multiplication/division (for scaling serving numbers), or comparison. It is far easier for users to understand your codebase when such natural operations are available. Just about every operation in Python has a magic method backing it. There are so many that I can’t even begin to enumerate them all. <a data-type="indexterm" data-primary="magic methods" data-secondary="common, in Python" id="idm45644738022856" class="calibre5"/>However, some common methods are listed in <a data-type="xref" href="part0015_split_006.html#table_11-2" class="calibre5">Table 11-1</a>.</p>
<table id="table_11-2" class="calibre45">
<caption class="calibre46"><span class="calibre">Table 11-1. </span>Common magic methods in Python</caption>
<thead class="calibre47">
<tr class="calibre48">
<th class="calibre49">Magic method</th>
<th class="calibre49">Used for</th>
</tr>
</thead>
<tbody class="calibre50">
<tr class="calibre48">
<td class="calibre51"><p class="author1"><code class="calibre52">__add__</code>, <code class="calibre52">__sub__</code>, <code class="calibre52">__mul__</code>, <code class="calibre52">__div__</code></p></td>
<td class="calibre51"><p class="author1">Arithmetic operations (add, subtract, multiply, divide)</p></td>
</tr>
<tr class="calibre53">
<td class="calibre51"><p class="author1"><code class="calibre52">__bool__</code></p></td>
<td class="calibre51"><p class="author1">Implicitly converting
 to Boolean for <code class="calibre52">if &lt;expression&gt;</code> checks</p></td>
</tr>
<tr class="calibre48">
<td class="calibre51"><p class="author1"><code class="calibre52">__and__</code>, <code class="calibre52">__or__</code></p></td>
<td class="calibre51"><p class="author1">Logical operations (<code class="calibre52">and</code> and <code class="calibre52">or</code>)</p></td>
</tr>
<tr class="calibre53">
<td class="calibre51"><p class="author1"><code class="calibre52">__getattr__</code>, <code class="calibre52">__setattr__</code>, <code class="calibre52">__delattr__</code></p></td>
<td class="calibre51"><p class="author1">Attribute access (such as <code class="calibre52">obj.name</code> or <code class="calibre52">del obj.name</code>)</p></td>
</tr>
<tr class="calibre48">
<td class="calibre51"><p class="author1"><code class="calibre52">__le__</code>, <code class="calibre52">__lt__</code>, <code class="calibre52">__eq__</code>, <code class="calibre52">__ne__</code>, <code class="calibre52">__gt__</code>, <code class="calibre52">__ge__</code></p></td>
<td class="calibre51"><p class="author1">Comparision (<code class="calibre52">&lt;=</code>, <code class="calibre52">&lt;</code>, <code class="calibre52">==</code>, <code class="calibre52">!=</code>, <code class="calibre52">&gt;</code>, <code class="calibre52">&gt;=</code>)</p></td>
</tr>
<tr class="calibre53">
<td class="calibre51"><p class="author1"><code class="calibre52">__str__</code>, <code class="calibre52">__repr__</code></p></td>
<td class="calibre51"><p class="author1">Converting to string (str()) or reproducible (repr()) forms</p></td>
</tr>
</tbody>
</table>

<p class="author1">If you want to learn more, check out the Python documentation regarding the <a href="https://oreil.ly/jHBaZ" class="calibre5">data model</a>.</p>
</div></section>













</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 11. Defining Your Interfaces" class="preface">
<div class="preface" id="api">
<section data-type="sect1" data-pdf-bookmark="Natural Interactions" class="preface">
<div class="preface" id="idm45644739845880">
<section data-type="sect2" data-pdf-bookmark="Magic Methods" class="preface">
<div class="preface" id="idm45644738360952">
<div data-type="note" epub:type="note" class="calibre21"><h1 class="calibre38" id="calibre_pb_7">Discussion Topic</h1>
<p class="author1">What are some types in your codebase that could benefit from a more natural mapping? Discuss where magic methods might make sense, and where they might not.</p>
</div>
</div></section>













</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 11. Defining Your Interfaces" class="preface">
<div class="preface" id="api">
<section data-type="sect1" data-pdf-bookmark="Natural Interactions" class="preface">
<div class="preface" id="idm45644739845880">
<section data-type="sect2" data-pdf-bookmark="Context Managers" class="preface"><div class="preface" id="idm45644738554568">
<h2 class="calibre34" id="calibre_pb_8">Context Managers</h2>

<p class="author1">Your code can now handle orders, but it’s time to fill in the other half: the grocery list handling.<a data-type="indexterm" data-primary="APIs" data-secondary="natural interactions" data-tertiary="context managers" id="ix_APInatintCM" class="calibre5"/><a data-type="indexterm" data-primary="context managers" id="ix_ctxtmgr" class="calibre5"/> I want you to take a break from reading and think about filling in the blanks of the grocery list handling code. Take what you learned from the last section and create an interface that naturally maps to the written description of the problem.</p>

<p class="author1">Here’s a reminder of the grocery list handling:</p>
<ol class="calibre30">
<li value="1" class="calibre31">
<p class="author1">A <code class="calibre17">Grocery List</code> contains a list of stores and the items to pick up from each store. Each item is reserved at the store until the app places the order. Items may come from different stores; the app tries to find the cheapest item that matches.</p>
</li>
<li value="2" class="calibre31">
<p class="author1">Once the user confirms the <code class="calibre17">GroceryList</code>, place the order. Grocery items are unreserved and set for delivery.</p>
</li>

</ol>

<p class="author1">From a calling code perspective, here’s what I have:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="n">order</code> <code class="calibre17">=</code> <code class="n">Order</code><code class="calibre17">(</code><code class="n">recipes</code><code class="calibre17">)</code>
<code class="c"># the user can make changes if needed</code>
<code class="n">display_order</code><code class="calibre17">(</code><code class="n">order</code><code class="calibre17">)</code>
<code class="n">wait_for_user_order_confirmation</code><code class="calibre17">()</code>
<code class="k">if</code> <code class="n">order</code><code class="calibre17">.</code><code class="n">is_confirmed</code><code class="calibre17">():</code>
    <code class="n">grocery_inventory</code> <code class="calibre17">=</code> <code class="n">get_grocery_inventory</code><code class="calibre17">()</code>
    <code class="n">grocery_list</code> <code class="calibre17">=</code>  <code class="n">GroceryList</code><code class="calibre17">(</code><code class="n">order</code><code class="calibre17">,</code> <code class="n">grocery_inventory</code><code class="calibre17">)</code>
    <code class="n">grocery_list</code><code class="calibre17">.</code><code class="n">reserve_items_from_stores</code><code class="calibre17">()</code>
    <code class="n">wait_for_user_grocery_confirmation</code><code class="calibre17">(</code><code class="n">grocery_list</code><code class="calibre17">)</code>
    <code class="k">if</code> <code class="n">grocery_list</code><code class="calibre17">.</code><code class="n">is_confirmed</code><code class="calibre17">():</code>
        <code class="n">grocery_list</code><code class="calibre17">.</code><code class="n">order_and_unreserve_items</code><code class="calibre17">()</code>
        <code class="n">deliver_ingredients</code><code class="calibre17">(</code><code class="n">grocery_list</code><code class="calibre17">)</code>
    <code class="k">else</code><code class="calibre17">:</code>
        <code class="n">grocery_list</code><code class="calibre17">.</code><code class="n">unreserve_items</code><code class="calibre17">()</code></pre>

<p class="author1">Given this grocery list interface, this is certainly easy to use (if I do say so myself). It’s clear what the code is doing, and if making the interface intuitive were the full story, I’d be golden. But I forgot the other half of Scott Meyers’s quote.  I forgot to make the code <em class="calibre6">hard to use incorrectly</em>.</p>

<p class="author1">Take a look again. What happens if the user doesn’t confirm their order? What if some exception were thrown while waiting? If this were to happen, I would never unreserve the items, leaving them reserved in perpetuity. Sure, I could hope that calling code would always try to catch an exception, but that’s easy to forget to do. In fact, it’d be quite easy to use incorrectly, wouldn’t you agree?</p>
<div data-type="tip" class="calibre21"><h6 class="calibre22">Tip</h6>
<p class="author1">You can’t only focus on the happy path, which is the execution of the code when everything goes as planned. Your interface must also handle all the possible ways problems can arise.</p>
</div>

<p class="author1">Wanting to automatically invoke some sort of function when you are done with an operation is a common case in Python. File open/close, session authenticate/logout, database command batching/submission; these are all examples where you want to always make sure to invoke the second operation, regardless of what the previous code did. If you don’t, you often leak resources or otherwise tie up the system.</p>

<p class="author1">Chances are, you’ve actually run across how to handle this: using a <code class="calibre17">with</code> block.</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="k">with</code> <code class="nb">open</code><code class="calibre17">(</code><code class="n">filename</code><code class="calibre17">,</code> <code class="s">"r"</code><code class="calibre17">)</code> <code class="k">as</code> <code class="n">handle</code><code class="calibre17">:</code>
    <code class="k">print</code><code class="calibre17">(</code><code class="n">handle</code><code class="calibre17">.</code><code class="n">read</code><code class="calibre17">())</code>
<code class="c"># at this point, the with block has ended, closing the file handle</code></pre>

<p class="author1">This is something you learn early on in your Python journey as a best practice. As soon as the <code class="calibre17">with</code> block is finished (when the code returns to the original indent level of the <code class="calibre17">with</code> statement), Python closes the opened file. This is a convenient way of making sure that an operation occurs, even with no explicit user interaction. This is the key you need to making your grocery list interface hard to use incorrectly—what if you could make the grocery list unreserve items automatically, regardless of what path the code takes?</p>

<p class="author1">To do this, you need to employ a <em class="calibre6">context manager</em>, which is a Python construct that lets you take advantage of <code class="calibre17">with</code> blocks. <a data-type="indexterm" data-primary="with blocks" id="idm45644737928904" class="calibre5"/>Using a context manager, I can make our grocery list code much more fault-tolerant:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="k">from</code> <code class="nn">contextlib</code> <code class="k">import</code> <code class="n">contextmanager</code>

<code class="nd">@contextmanager</code>
<code class="k">def</code> <code class="nf">create_grocery_list</code><code class="calibre17">(</code><code class="n">order</code><code class="calibre17">:</code> <code class="n">Order</code><code class="calibre17">,</code> <code class="n">inventory</code><code class="calibre17">:</code> <code class="n">Inventory</code><code class="calibre17">):</code>
    <code class="n">grocery_list</code> <code class="calibre17">=</code> <code class="n">_GroceryList</code><code class="calibre17">(</code><code class="n">order</code><code class="calibre17">,</code> <code class="n">inventory</code><code class="calibre17">)</code>
    <code class="k">try</code><code class="calibre17">:</code>
        <code class="k">yield</code> <code class="n">grocery_list</code>
    <code class="k">finally</code><code class="calibre17">:</code>
        <code class="k">if</code> <code class="n">grocery_list</code><code class="calibre17">.</code><code class="n">has_reserved_items</code><code class="calibre17">():</code>
            <code class="n">grocery_list</code><code class="calibre17">.</code><code class="n">unreserve_items</code><code class="calibre17">()</code></pre>

<p class="author1">Any function decorated with <code class="calibre17">@contextmanager</code> will be usable alongside a <code class="calibre17">with</code> block.<a data-type="indexterm" data-primary="@contextmanager decorator" id="idm45644737817416" class="calibre5"/> I construct a <code class="calibre17">_GroceryList</code> (notice how it’s private, so nobody should be creating a grocery list in ways other than <code class="calibre17">create_grocery_list</code>), then <em class="calibre6">yield</em> it.<a data-type="indexterm" data-primary="yielding a value" id="idm45644737815288" class="calibre5"/> Yielding a value interrupts this function, returning the value yielded to the calling code. The user can then use it like so:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="c"># ... snip ...</code>
<code class="k">if</code> <code class="n">order</code><code class="calibre17">.</code><code class="n">is_confirmed</code><code class="calibre17">():</code>
    <code class="n">grocery_inventory</code> <code class="calibre17">=</code> <code class="n">get_grocery_inventory</code><code class="calibre17">()</code>
    <code class="k">with</code> <code class="n">create_grocery_list</code><code class="calibre17">(</code><code class="n">order</code><code class="calibre17">,</code> <code class="n">grocery_inventory</code><code class="calibre17">)</code> <code class="k">as</code> <code class="n">grocery_list</code><code class="calibre17">:</code>
        <code class="n">grocery_list</code><code class="calibre17">.</code><code class="n">reserve_items_from_stores</code><code class="calibre17">()</code>
        <code class="n">wait_for_user_grocery_confirmation</code><code class="calibre17">(</code><code class="n">grocery_list</code><code class="calibre17">)</code>
        <code class="n">grocery_list</code><code class="calibre17">.</code><code class="n">order_and_unreserve_items</code><code class="calibre17">()</code>
        <code class="n">deliver_ingredients</code><code class="calibre17">(</code><code class="n">grocery_list</code><code class="calibre17">)</code></pre>

<p class="author1">The yielded value becomes <code class="calibre17">grocery_list</code> in the example above. When the <code class="calibre17">with</code> block exits, execution is returned to the context manager, right after the yield statement. It doesn’t matter if an exception is thrown, or if the <code class="calibre17">with</code> block finishes normally; because I wrapped our yield in a <code class="calibre17">try...finally block</code>, the grocery list will always clear any reserved items.</p>

<p class="author1">This is how you can effectively force a user to clean up after themselves. You are eliminating an entire class of errors that can happen when you use context managers—the errors of omission.<a data-type="indexterm" data-primary="errors" data-secondary="eliminating errors of omission with context managers" id="idm45644737752168" class="calibre5"/> Errors of omission are so easy to make; you literally have to do nothing. Instead, a context manager lets users do the right thing, even when they do nothing. It’s a sure sign of a robust codebase when a user can do the right thing without even knowing it.</p>
<div data-type="warning" epub:type="warning" class="calibre23"><h6 class="calibre24">Warning</h6>
<p class="author1">Context managers will not finish if the program is forcibly closed, such as a force kill from the operating system or a power loss. Context managers are just a tool to keep developers from forgetting to clean up after themselves; make sure your system can still handle things outside a developer’s control.<a data-type="indexterm" data-primary="APIs" data-secondary="natural interactions" data-tertiary="context managers" data-startref="ix_APInatintCM" id="idm45644737749400" class="calibre5"/><a data-type="indexterm" data-primary="context managers" data-startref="ix_ctxtmgr" id="idm45644737747880" class="calibre5"/><a data-type="indexterm" data-primary="APIs" data-secondary="natural interactions" data-startref="ix_APInatint" id="idm45644737746936" class="calibre5"/></p>
</div>
</div></section>





</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 11. Defining Your Interfaces" class="preface">
<div class="preface" id="api">
<section data-type="sect1" data-pdf-bookmark="Closing Thoughts" class="preface"><div class="preface" id="idm45644737993560">
<h1 class="calibre12" id="calibre_pb_9">Closing Thoughts</h1>

<p class="author1">You can create all the types in the world, but if other developers can’t use them without error, your codebase will suffer. Just like a house needs a strong foundation to stand upon, the types you create and vocabulary you surround them with need to be rock solid for your codebase to be healthy. When you have natural interfaces to your code, future developers will be able to reach for these types and build new features effortlessly. Have empathy for those future developers, and design your types with care.</p>

<p class="author1">You’ll need to think through the domain concepts your types represent, and how users interact with those types. By building a natural mapping, you tie real-world operations to your codebase. The interfaces you build should feel intuitive; remember, they should be easy to use correctly and hard to use incorrectly. Use every trick and tip at your disposal, from proper naming to magic methods to context managers.</p>

<p class="author1">In the next chapter, I’m going to cover how types relate to one another when you create subtypes. Subtypes are a way of specializing a type’s interface; they allow for extension without modifying the original types. Any modification to existing code is a potential regression, so being able to create new types without changing old ones can significantly reduce erratic behavior.</p>
</div></section>







<div data-type="footnotes" class="calibre25"><p data-type="footnote" id="idm45644739470600" class="calibre26"><sup class="calibre27"><a href="part0015_split_002.html#idm45644739470600-marker" class="calibre5">1</a></sup> Kevlin Henney and Scott Meyers. “Make Interfaces Easy to Use Correctly and Hard to Use Incorrectly.” Chap. 55 in <em class="calibre6">97 Things Every Programmer Should Know: Collective Wisdom from the Experts</em>. Sebastopol: O’Reilly Media, 2010.</p><p data-type="footnote" id="idm45644739457384" class="calibre26"><sup class="calibre27"><a href="part0015_split_003.html#idm45644739457384-marker" class="calibre5">2</a></sup> Kent Beck. <em class="calibre6">Test Driven Development: By Example</em>. Upper Saddle River, NJ: Addison-Wesley Professional, 2002.</p><p data-type="footnote" id="idm45644739452664" class="calibre26"><sup class="calibre27"><a href="part0015_split_003.html#idm45644739452664-marker" class="calibre5">3</a></sup> I  recommend <a href="https://oreil.ly/PJARR" class="calibre5"><em class="calibre6">Test-Driven Development with Python</em></a> by Harry Percival (O’Reilly, 2017) if you’d like more <span class="calibre">information</span>.</p><p data-type="footnote" id="idm45644739841848" class="calibre26"><sup class="calibre27"><a href="part0015_split_004.html#idm45644739841848-marker" class="calibre5">4</a></sup> This is from <em class="calibre6">Design of Everyday Things</em> by Donald Norman (Basic Books). This classic book is essential to anyone wanting to get into a UX mindset.</p></div></div></section></body></html>