<html><head></head><body><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 4. 20 Asyncio Libraries You Aren&#x2019;t Using (But&#x2026;Oh, Never Mind)"><div class="chapter" id="idm46363027999656">
<h1><span class="label">Chapter 4. </span>20 Asyncio Libraries You Aren’t Using (But…Oh, Never Mind)</h1>


<p>In this chapter, we look at case studies using the new
Python features for async programming.<a data-type="indexterm" data-primary="asyncio libraries" id="ix_asylib"/><a data-type="indexterm" data-primary="libraries" data-secondary="asyncio" data-seealso="asyncio libraries" id="idm46363027314248"/> We’ll be making use of several
third-party libraries, as you will in your own projects.</p>

<p>The title of this chapter is a play on the
title of a previous book I wrote called
<a href="https://oreil.ly/HLsvb"><em>20
Python Libraries You Aren’t Using (But Should)</em></a> (O’Reilly). Many of those
libraries will also be useful in your <code>asyncio</code>-based applications,
but this chapter focuses on libraries that have been
designed specifically for the new async features in Python.<a data-type="indexterm" data-primary="Hattingh, Caleb" id="idm46363027311032"/><a data-type="indexterm" data-primary="20 Python Libraries You Aren't Using (But Should)" data-primary-sortas="Twenty" id="idm46363027310360"/></p>

<p>It is difficult to present <code>asyncio</code>-based code in short snippets. As
you have seen in all the previous code samples in the book, I’ve
tried to make each example a complete, runnable program, because
application lifetime management is a core consideration for
using async programming correctly.</p>

<p>For this reason, most of the case studies in this chapter will be
somewhat larger, in terms of lines of code, than is usual for such a
book. My goal in using this approach is to make the case studies more
useful by giving you a “whole view” of an async program rather than leaving
you to figure out how detached fragments might fit together.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Some of the code samples in this chapter compromise on
style in order to save space. I like PEP8 as much as the next Pythonista,
but practicality beats purity!</p>
</div>






<section data-type="sect1" data-pdf-bookmark="Streams (Standard Library)"><div class="sect1" id="idm46363027306152">
<h1>Streams (Standard Library)</h1>

<p>Before looking at third-party libraries, let’s begin with the standard
library.<a data-type="indexterm" data-primary="streams API" id="ix_strms"/><a data-type="indexterm" data-primary="asyncio libraries" data-secondary="streams standard library" id="ix_asylibstrm"/> The <a href="https://oreil.ly/mnMZD">streams API</a>
is the high-level interface offered for async socket programming, and as
the following case study will show, it’s pretty easy to use. However,
application design remains complex simply because of the nature of the domain.</p>

<p>The following case study shows an implementation of a message broker,
with an initial naive design followed by a more considered design. Neither
should be considered production-ready; my goal is to help you think
about the various aspects of concurrent network programming that need to
be taken into account when designing such applications.</p>








<section data-type="sect2" data-pdf-bookmark="Case Study: A Message Queue"><div class="sect2" id="idm46363027300408">
<h2>Case Study: A Message Queue</h2>

<p>A <em>message queue service</em> is a backend application that receives connections
from other applications <a data-type="indexterm" data-primary="message queues" data-secondary="message queue case study" id="ix_messqucs"/><a data-type="indexterm" data-primary="asyncio libraries" data-secondary="streams standard library" data-tertiary="message queue case study" id="ix_asylibstrmmqcs"/><a data-type="indexterm" data-primary="streams API" data-secondary="message queue case study" id="ix_strmsmqcs"/>and passes messages between those connected
services, often <a data-type="indexterm" data-primary="publish/subscribe messaging model" id="idm46363027293576"/>referred to as <em>publishers</em> and <em>subscribers</em>. Subscribers
typically listen to specific channels for messages, and usually it is possible
to configure the message distribution in different channels<a data-type="indexterm" data-primary="subscribers" id="idm46363027291720"/> in two ways:
messages can be distributed to all subscribers on a channel
(<em>pub-sub</em>), or a different message can go to each subscriber one at a
time (<em>point-to-point</em>).<a data-type="indexterm" data-primary="queues" data-seealso="message queues" id="idm46363027290088"/></p>

<p>Recently, I worked on a project that involved using
<a href="https://oreil.ly/yiaK0">ActiveMQ</a> as a message broker for
microservices intercommunication.<a data-type="indexterm" data-primary="message queues" data-secondary="message queue case study" data-tertiary="server or broker" id="idm46363027288136"/> At a basic level, such a broker
(server):</p>

<ul>
<li>
<p>Maintains persistent socket connections to multiple clients</p>
</li>
<li>
<p>Receives messages from clients with a target <em>channel name</em></p>
</li>
<li>
<p>Delivers those messages to all <em>other</em> clients subscribed to that
same channel name</p>
</li>
</ul>

<p>I recall wondering how hard it might be to create such an
application. As an added touch, ActiveMQ can perform both models
of message distribution, and the two models are generally differentiated
by the channel name:</p>

<ul>
<li>
<p>Channel names with the prefix <code>/topic</code> (e.g., <code>/topic/customer/registration</code>)
are managed with the <a href="https://oreil.ly/y6cYr">pub-sub</a>
pattern, where all channel subscribers get all messages.</p>
</li>
<li>
<p>Channel names with the prefix <code>/queue</code> are handled with the
<a href="http://bit.ly/2CeNbxr">point-to-point</a>
model, in which messages on a channel are distributed between channel
subscribers in a round-robin fashion: each subscriber gets a unique
message.</p>
</li>
</ul>

<p>In our case study, we will build a toy message broker with these basic
features. The first issue we must address<a data-type="indexterm" data-primary="message queues" data-secondary="message queue case study" data-tertiary="message protocol, read and write capabilities" id="idm46363027276712"/> is that TCP is not a
message-based protocol: we just get streams of bytes on the wire. We
need to create our own protocol for the structure of messages, and the
simplest protocol is to prefix each message with a size header,
followed by a message payload of that size. The utility
library in <a data-type="xref" href="#msgproto">Example 4-1</a> provides <em>read</em> and <em>write</em> capabilities for such messages.</p>
<div id="msgproto" data-type="example">
<h5><span class="label">Example 4-1. </span>Message protocol: read and write</h5>

<pre data-type="programlisting" data-code-language="python3"><code class="c1"># msgproto.py</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">asyncio</code><code> </code><code class="k">import</code><code> </code><code class="n">StreamReader</code><code class="p">,</code><code> </code><code class="n">StreamWriter</code><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">read_msg</code><code class="p">(</code><code class="n">stream</code><code class="p">:</code><code> </code><code class="n">StreamReader</code><code class="p">)</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="nb">bytes</code><code class="p">:</code><code>
</code><code>    </code><code class="n">size_bytes</code><code> </code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="n">stream</code><code class="o">.</code><code class="n">readexactly</code><code class="p">(</code><code class="mi">4</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO1-1" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO1-1"><img src="assets/1.png" alt="1"/></a><code>
</code><code>    </code><code class="n">size</code><code> </code><code class="o">=</code><code> </code><code class="nb">int</code><code class="o">.</code><code class="n">from_bytes</code><code class="p">(</code><code class="n">size_bytes</code><code class="p">,</code><code> </code><code class="n">byteorder</code><code class="o">=</code><code class="s1">'</code><code class="s1">big</code><code class="s1">'</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO1-2" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO1-2"><img src="assets/2.png" alt="2"/></a><code>
</code><code>    </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="n">stream</code><code class="o">.</code><code class="n">readexactly</code><code class="p">(</code><code class="n">size</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO1-3" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO1-3"><img src="assets/3.png" alt="3"/></a><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">data</code><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">send_msg</code><code class="p">(</code><code class="n">stream</code><code class="p">:</code><code> </code><code class="n">StreamWriter</code><code class="p">,</code><code> </code><code class="n">data</code><code class="p">:</code><code> </code><code class="nb">bytes</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">size_bytes</code><code> </code><code class="o">=</code><code> </code><code class="nb">len</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code class="o">.</code><code class="n">to_bytes</code><code class="p">(</code><code class="mi">4</code><code class="p">,</code><code> </code><code class="n">byteorder</code><code class="o">=</code><code class="s1">'</code><code class="s1">big</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>    </code><code class="n">stream</code><code class="o">.</code><code class="n">writelines</code><code class="p">(</code><code class="p">[</code><code class="n">size_bytes</code><code class="p">,</code><code> </code><code class="n">data</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO1-4" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO1-4"><img src="assets/4.png" alt="4"/></a><code>
</code><code>    </code><code class="k">await</code><code> </code><code class="n">stream</code><code class="o">.</code><code class="n">drain</code><code class="p">(</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO1-1" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO1-1"><img src="assets/1.png" alt="1"/></a></dt>
<dd><p>Get the first 4 bytes. This is the size prefix.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO1-2" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO1-2"><img src="assets/2.png" alt="2"/></a></dt>
<dd><p>Those 4 bytes must be converted into an integer.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO1-3" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO1-3"><img src="assets/3.png" alt="3"/></a></dt>
<dd><p>Now we know the payload size, so we read that off the stream.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO1-4" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO1-4"><img src="assets/4.png" alt="4"/></a></dt>
<dd><p><em>Write</em> is the inverse of <em>read</em>: first we send the length of the data,
encoded as 4 bytes, and thereafter the data.</p></dd>
</dl></div>

<p>Now that we have a rudimentary message protocol, we can focus on the
message broker <a data-type="indexterm" data-primary="message queues" data-secondary="message queue case study" data-tertiary="server or broker" id="idm46363026885704"/>application in <a data-type="xref" href="#msgserver">Example 4-2</a>.</p>
<div id="msgserver" data-type="example">
<h5><span class="label">Example 4-2. </span>A 40-line prototype server</h5>

<pre data-type="programlisting" data-code-language="python3"><code class="c1"># mq_server.py</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">asyncio</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">asyncio</code><code> </code><code class="k">import</code><code> </code><code class="n">StreamReader</code><code class="p">,</code><code> </code><code class="n">StreamWriter</code><code class="p">,</code><code> </code><code class="n">gather</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">collections</code><code> </code><code class="k">import</code><code> </code><code class="n">deque</code><code class="p">,</code><code> </code><code class="n">defaultdict</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">typing</code><code> </code><code class="k">import</code><code> </code><code class="n">Deque</code><code class="p">,</code><code> </code><code class="n">DefaultDict</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">msgproto</code><code> </code><code class="k">import</code><code> </code><code class="n">read_msg</code><code class="p">,</code><code> </code><code class="n">send_msg</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-1" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-1"><img src="assets/1.png" alt="1"/></a><code>
</code><code>
</code><code class="n">SUBSCRIBERS</code><code class="p">:</code><code> </code><code class="n">DefaultDict</code><code class="p">[</code><code class="nb">bytes</code><code class="p">,</code><code> </code><code class="n">Deque</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">defaultdict</code><code class="p">(</code><code class="n">deque</code><code class="p">)</code><code> </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-2" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-2"><img src="assets/2.png" alt="2"/></a><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">client</code><code class="p">(</code><code class="n">reader</code><code class="p">:</code><code> </code><code class="n">StreamReader</code><code class="p">,</code><code> </code><code class="n">writer</code><code class="p">:</code><code> </code><code class="n">StreamWriter</code><code class="p">)</code><code class="p">:</code><code>
</code><code>  </code><code class="n">peername</code><code> </code><code class="o">=</code><code> </code><code class="n">writer</code><code class="o">.</code><code class="n">get_extra_info</code><code class="p">(</code><code class="s1">'</code><code class="s1">peername</code><code class="s1">'</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-3" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-3"><img src="assets/3.png" alt="3"/></a><code>
</code><code>  </code><code class="n">subscribe_chan</code><code> </code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="n">read_msg</code><code class="p">(</code><code class="n">reader</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-4" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-4"><img src="assets/4.png" alt="4"/></a><code>
</code><code>  </code><code class="n">SUBSCRIBERS</code><code class="p">[</code><code class="n">subscribe_chan</code><code class="p">]</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">writer</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-5" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-5"><img src="assets/5.png" alt="5"/></a><code>
</code><code>  </code><code class="nb">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">Remote </code><code class="si">{peername}</code><code class="s1"> subscribed to </code><code class="si">{subscribe_chan}</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>  </code><code class="k">try</code><code class="p">:</code><code>
</code><code>    </code><code class="k">while</code><code> </code><code class="n">channel_name</code><code> </code><code class="p">:</code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="n">read_msg</code><code class="p">(</code><code class="n">reader</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-6" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-6"><img src="assets/6.png" alt="6"/></a><code>
</code><code>      </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="n">read_msg</code><code class="p">(</code><code class="n">reader</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-7" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-7"><img src="assets/7.png" alt="7"/></a><code>
</code><code>      </code><code class="nb">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">Sending to </code><code class="si">{channel_name}</code><code class="s1">: </code><code class="si">{data[:19]}</code><code class="s1">...</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>      </code><code class="n">conns</code><code> </code><code class="o">=</code><code> </code><code class="n">SUBSCRIBERS</code><code class="p">[</code><code class="n">channel_name</code><code class="p">]</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-8" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-8"><img src="assets/8.png" alt="8"/></a><code>
</code><code>      </code><code class="k">if</code><code> </code><code class="n">conns</code><code> </code><code class="ow">and</code><code> </code><code class="n">channel_name</code><code class="o">.</code><code class="n">startswith</code><code class="p">(</code><code class="s-Affix">b</code><code class="s1">'</code><code class="s1">/queue</code><code class="s1">'</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-9" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-9"><img src="assets/9.png" alt="9"/></a><code>
</code><code>          </code><code class="n">conns</code><code class="o">.</code><code class="n">rotate</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-10" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-10"><img src="assets/10.png" alt="10"/></a><code>
</code><code>          </code><code class="n">conns</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="n">conns</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="p">]</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-11" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-11"><img src="assets/11.png" alt="11"/></a><code>
</code><code>      </code><code class="k">await</code><code> </code><code class="n">gather</code><code class="p">(</code><code class="o">*</code><code class="p">[</code><code class="n">send_msg</code><code class="p">(</code><code class="n">c</code><code class="p">,</code><code> </code><code class="n">data</code><code class="p">)</code><code> </code><code class="k">for</code><code> </code><code class="n">c</code><code> </code><code class="ow">in</code><code> </code><code class="n">conns</code><code class="p">]</code><code class="p">)</code><code> </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-12" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-12"><img src="assets/12.png" alt="12"/></a><code>
</code><code>  </code><code class="k">except</code><code> </code><code class="n">asyncio</code><code class="o">.</code><code class="n">CancelledError</code><code class="p">:</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">Remote </code><code class="si">{peername}</code><code class="s1"> closing connection.</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>    </code><code class="n">writer</code><code class="o">.</code><code class="n">close</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="k">await</code><code> </code><code class="n">writer</code><code class="o">.</code><code class="n">wait_closed</code><code class="p">(</code><code class="p">)</code><code>
</code><code>  </code><code class="k">except</code><code> </code><code class="n">asyncio</code><code class="o">.</code><code class="n">IncompleteReadError</code><code class="p">:</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">Remote </code><code class="si">{peername}</code><code class="s1"> disconnected</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>  </code><code class="k">finally</code><code class="p">:</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">Remote </code><code class="si">{peername}</code><code class="s1"> closed</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>    </code><code class="n">SUBSCRIBERS</code><code class="p">[</code><code class="n">subscribe_chan</code><code class="p">]</code><code class="o">.</code><code class="n">remove</code><code class="p">(</code><code class="n">writer</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-13" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-13"><img src="assets/13.png" alt="13"/></a><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">main</code><code class="p">(</code><code class="o">*</code><code class="n">args</code><code class="p">,</code><code> </code><code class="o">*</code><code class="o">*</code><code class="n">kwargs</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">server</code><code> </code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="n">asyncio</code><code class="o">.</code><code class="n">start_server</code><code class="p">(</code><code class="o">*</code><code class="n">args</code><code class="p">,</code><code> </code><code class="o">*</code><code class="o">*</code><code class="n">kwargs</code><code class="p">)</code><code>
</code><code>    </code><code class="k">async</code><code> </code><code class="k">with</code><code> </code><code class="n">server</code><code class="p">:</code><code>
</code><code>        </code><code class="k">await</code><code> </code><code class="n">server</code><code class="o">.</code><code class="n">serve_forever</code><code class="p">(</code><code class="p">)</code><code>
</code><code>
</code><code class="k">try</code><code class="p">:</code><code>
</code><code>    </code><code class="n">asyncio</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="n">main</code><code class="p">(</code><code class="n">client</code><code class="p">,</code><code> </code><code class="n">host</code><code class="o">=</code><code class="s1">'</code><code class="s1">127.0.0.1</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">port</code><code class="o">=</code><code class="mi">25000</code><code class="p">)</code><code class="p">)</code><code>
</code><code class="k">except</code><code> </code><code class="ne">KeyboardInterrupt</code><code class="p">:</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">Bye!</code><code class="s1">'</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-1" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-1"><img src="assets/1.png" alt="1"/></a></dt>
<dd><p>Imports from our <em>msgproto.py</em> module.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-2" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-2"><img src="assets/2.png" alt="2"/></a></dt>
<dd><p>A global collection of currently active subscribers. Every time a client
connects, they must first send a channel name they’re subscribing to. A
deque will hold all the subscribers for a particular channel.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-3" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-3"><img src="assets/3.png" alt="3"/></a></dt>
<dd><p>The <code>client()</code> coroutine function will produce a long-lived
coroutine for each new connection. Think of it as a callback for
the TCP server started in <code>main()</code>. On this line, I’ve shown how
the host and port of the remote peer can be obtained, for example, for logging.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-4" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-4"><img src="assets/4.png" alt="4"/></a></dt>
<dd><p>Our protocol for clients is the following:</p>

<ul>
<li>
<p>On first connect, a client <em>must</em> send a message containing the channel to
subscribe to (here, <code>subscribe_chan</code>).</p>
</li>
<li>
<p>Thereafter, for the life of the connection, a client sends a message to
a channel by first sending a message containing the destination
channel name, <span class="keep-together">followed</span> by a message containing the data. Our broker will
send such data messages to every client subscribed to that channel name.</p>
</li>
</ul></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-5" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-5"><img src="assets/5.png" alt="5"/></a></dt>
<dd><p>Add the <code>StreamWriter</code> instance to the global collection of subscribers.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-6" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-6"><img src="assets/6.png" alt="6"/></a></dt>
<dd><p>An infinite loop, waiting for data from this client. The first message
from a client must be the destination channel name.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-7" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-7"><img src="assets/7.png" alt="7"/></a></dt>
<dd><p>Next comes the actual data to distribute to the channel.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-8" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-8"><img src="assets/8.png" alt="8"/></a></dt>
<dd><p>Get the deque of subscribers on the target channel.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-9" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-9"><img src="assets/9.png" alt="9"/></a></dt>
<dd><p>Some special handling if the channel name begins with the magic word
<code>/queue</code>: in this case, we send the data to <em>only one</em> of the subscribers,
not all of them. This can be used for sharing work between a bunch of
workers, rather than the usual pub-sub notification scheme, where all
subscribers on a channel get all the <span class="keep-together">messages</span>.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-10" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-10"><img src="assets/10.png" alt="10"/></a></dt>
<dd><p>Here is why we use a deque and not a list: rotation of the deque is
how we keep track of which client is next in line for <code>/queue</code> distribution.
This seems expensive until you realize that a single deque rotation is an
O(1) operation.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-11" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-11"><img src="assets/11.png" alt="11"/></a></dt>
<dd><p>Target only whichever client is first; this changes after every rotation.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-12" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-12"><img src="assets/12.png" alt="12"/></a></dt>
<dd><p>Create a list of coroutines for sending the message to each writer,
and then unpack these into <code>gather()</code> so we can wait for all of the sending
to complete.</p>

<p>This line is a bad flaw in our program, but it
may not be obvious why: though it may be true that all of the sending
to each subscriber will happen
concurrently, what happens if we have one very slow client? In this
case, the <code>gather()</code> will finish only when the slowest subscriber has
received its data. We can’t receive any more data from the sending
client until all these <code>send_msg()</code> coroutines finish. This slows all message
distribution to the speed of the slowest subscriber.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-13" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO2-13"><img src="assets/13.png" alt="13"/></a></dt>
<dd><p>When leaving the <code>client()</code> coroutine, we make sure to remove
ourselves from the global <code>SUBSCRIBERS</code> collection. Unfortunately, this is
an O(<em>n</em>) operation, which can be a little expensive for very large <em>n</em>. A
different data structure would fix this, but for now we console ourselves
with the knowledge that connections are intended to be long-lived—thus, there should be
few disconnection events—and <em>n</em> is unlikely to be very large (say ~10,000 as
a rough order-of-magnitude estimate), and this code is at least easy to
understand.</p></dd>
</dl></div>

<p>So that’s our server; now we need clients, and then we can show some
output. For demonstration purposes, I’ll make two kinds of clients: a
<em>sender</em> and a <em>listener</em>. The server doesn’t differentiate; all
clients are the same.<a data-type="indexterm" data-primary="message queues" data-secondary="message queue case study" data-tertiary="listener or client" id="idm46363026342408"/> The distinction between sender and listener
behavior is only for educational purposes. <a data-type="xref" href="#listener">Example 4-3</a> shows the code
for the listener application.</p>
<div id="listener" data-type="example">
<h5><span class="label">Example 4-3. </span>Listener: a toolkit for listening for messages on our message broker</h5>

<pre data-type="programlisting" data-code-language="python3"><code class="c1"># mq_client_listen.py</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">asyncio</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">argparse</code><code class="o">,</code><code> </code><code class="nn">uuid</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">msgproto</code><code> </code><code class="k">import</code><code> </code><code class="n">read_msg</code><code class="p">,</code><code> </code><code class="n">send_msg</code><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">main</code><code class="p">(</code><code class="n">args</code><code class="p">)</code><code class="p">:</code><code>
</code><code>  </code><code class="n">me</code><code> </code><code class="o">=</code><code> </code><code class="n">uuid</code><code class="o">.</code><code class="n">uuid4</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">hex</code><code class="p">[</code><code class="p">:</code><code class="mi">8</code><code class="p">]</code><code> </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO3-1" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO3-1"><img src="assets/1.png" alt="1"/></a><code>
</code><code>  </code><code class="nb">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">Starting up </code><code class="si">{me}</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>  </code><code class="n">reader</code><code class="p">,</code><code> </code><code class="n">writer</code><code> </code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="n">asyncio</code><code class="o">.</code><code class="n">open_connection</code><code class="p">(</code><code>
</code><code>    </code><code class="n">args</code><code class="o">.</code><code class="n">host</code><code class="p">,</code><code> </code><code class="n">args</code><code class="o">.</code><code class="n">port</code><code class="p">)</code><code> </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO3-2" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO3-2"><img src="assets/2.png" alt="2"/></a><code>
</code><code>  </code><code class="nb">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">I am </code><code class="s1">{</code><code class="s1">writer.get_extra_info(</code><code class="s1">"</code><code class="s1">sockname</code><code class="s1">"</code><code class="s1">)}</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>  </code><code class="n">channel</code><code> </code><code class="o">=</code><code> </code><code class="n">args</code><code class="o">.</code><code class="n">listen</code><code class="o">.</code><code class="n">encode</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO3-3" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO3-3"><img src="assets/3.png" alt="3"/></a><code>
</code><code>  </code><code class="k">await</code><code> </code><code class="n">send_msg</code><code class="p">(</code><code class="n">writer</code><code class="p">,</code><code> </code><code class="n">channel</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO3-4" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO3-4"><img src="assets/4.png" alt="4"/></a><code>
</code><code>  </code><code class="k">try</code><code class="p">:</code><code>
</code><code>    </code><code class="k">while</code><code> </code><code class="n">data</code><code> </code><code class="p">:</code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="n">read_msg</code><code class="p">(</code><code class="n">reader</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO3-5" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO3-5"><img src="assets/5.png" alt="5"/></a><code>
</code><code>      </code><code class="nb">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">Received by </code><code class="si">{me}</code><code class="s1">: </code><code class="si">{data[:20]}</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">Connection ended.</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>  </code><code class="k">except</code><code> </code><code class="n">asyncio</code><code class="o">.</code><code class="n">IncompleteReadError</code><code class="p">:</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">Server closed.</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>  </code><code class="k">finally</code><code class="p">:</code><code>
</code><code>    </code><code class="n">writer</code><code class="o">.</code><code class="n">close</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="k">await</code><code> </code><code class="n">writer</code><code class="o">.</code><code class="n">wait_closed</code><code class="p">(</code><code class="p">)</code><code>
</code><code>
</code><code>
</code><code class="k">if</code><code> </code><code class="nv-Magic">__name__</code><code> </code><code class="o">==</code><code> </code><code class="s1">'</code><code class="s1">__main__</code><code class="s1">'</code><code class="p">:</code><code>
</code><code>  </code><code class="n">parser</code><code> </code><code class="o">=</code><code> </code><code class="n">argparse</code><code class="o">.</code><code class="n">ArgumentParser</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO3-6" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO3-6"><img src="assets/6.png" alt="6"/></a><code>
</code><code>  </code><code class="n">parser</code><code class="o">.</code><code class="n">add_argument</code><code class="p">(</code><code class="s1">'</code><code class="s1">--host</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">default</code><code class="o">=</code><code class="s1">'</code><code class="s1">localhost</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>  </code><code class="n">parser</code><code class="o">.</code><code class="n">add_argument</code><code class="p">(</code><code class="s1">'</code><code class="s1">--port</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">default</code><code class="o">=</code><code class="mi">25000</code><code class="p">)</code><code>
</code><code>  </code><code class="n">parser</code><code class="o">.</code><code class="n">add_argument</code><code class="p">(</code><code class="s1">'</code><code class="s1">--listen</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">default</code><code class="o">=</code><code class="s1">'</code><code class="s1">/topic/foo</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>  </code><code class="k">try</code><code class="p">:</code><code>
</code><code>    </code><code class="n">asyncio</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="n">main</code><code class="p">(</code><code class="n">parser</code><code class="o">.</code><code class="n">parse_args</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code>
</code><code>  </code><code class="k">except</code><code> </code><code class="ne">KeyboardInterrupt</code><code class="p">:</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">Bye!</code><code class="s1">'</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO3-1" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO3-1"><img src="assets/1.png" alt="1"/></a></dt>
<dd><p>The <code>uuid</code> standard library module is a convenient way of creating an
“identity” for this listener.<a data-type="indexterm" data-primary="uuid standard library module" id="idm46363026006072"/> If you start up multiple instances,
each will have its own identity, and you’ll be able to track what is
happening in the logs.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO3-2" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO3-2"><img src="assets/2.png" alt="2"/></a></dt>
<dd><p>Open a connection to the server.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO3-3" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO3-3"><img src="assets/3.png" alt="3"/></a></dt>
<dd><p>The channel to subscribe to is an input parameter, captured in
<code>args.listen</code>. Encode it into bytes before sending.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO3-4" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO3-4"><img src="assets/4.png" alt="4"/></a></dt>
<dd><p>By our protocol rules (as discussed in the broker code analysis
previously), the first thing to do after connecting is to
send the channel name to subscribe to.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO3-5" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO3-5"><img src="assets/5.png" alt="5"/></a></dt>
<dd><p>This loop does nothing else but wait for data to appear on
the socket.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO3-6" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO3-6"><img src="assets/6.png" alt="6"/></a></dt>
<dd><p>The command-line arguments for this program make it easy to point to a host, a
port, and a channel name to listen to.</p></dd>
</dl></div>

<p>The code for the other client, the sender program shown in <a data-type="xref" href="#sender">Example 4-4</a>, is similar in structure to
the listener module.<a data-type="indexterm" data-primary="message queues" data-secondary="message queue case study" data-tertiary="sender" id="idm46363026024392"/></p>
<div id="sender" data-type="example">
<h5><span class="label">Example 4-4. </span>Sender: a toolkit for sending data to our message broker</h5>

<pre data-type="programlisting" data-code-language="python3"><code class="c1"># mq_client_sender.py</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">asyncio</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">argparse</code><code class="o">,</code><code> </code><code class="nn">uuid</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">itertools</code><code> </code><code class="k">import</code><code> </code><code class="n">count</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">msgproto</code><code> </code><code class="k">import</code><code> </code><code class="n">send_msg</code><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">main</code><code class="p">(</code><code class="n">args</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">me</code><code> </code><code class="o">=</code><code> </code><code class="n">uuid</code><code class="o">.</code><code class="n">uuid4</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">hex</code><code class="p">[</code><code class="p">:</code><code class="mi">8</code><code class="p">]</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-1" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-1"><img src="assets/1.png" alt="1"/></a><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">Starting up </code><code class="si">{me}</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>    </code><code class="n">reader</code><code class="p">,</code><code> </code><code class="n">writer</code><code> </code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="n">asyncio</code><code class="o">.</code><code class="n">open_connection</code><code class="p">(</code><code>
</code><code>        </code><code class="n">host</code><code class="o">=</code><code class="n">args</code><code class="o">.</code><code class="n">host</code><code class="p">,</code><code> </code><code class="n">port</code><code class="o">=</code><code class="n">args</code><code class="o">.</code><code class="n">port</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-2" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-2"><img src="assets/2.png" alt="2"/></a><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">I am </code><code class="s1">{</code><code class="s1">writer.get_extra_info(</code><code class="s1">"</code><code class="s1">sockname</code><code class="s1">"</code><code class="s1">)}</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="n">channel</code><code> </code><code class="o">=</code><code> </code><code class="s-Affix">b</code><code class="s1">'</code><code class="s1">/null</code><code class="s1">'</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-3" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-3"><img src="assets/3.png" alt="3"/></a><code>
</code><code>    </code><code class="k">await</code><code> </code><code class="n">send_msg</code><code class="p">(</code><code class="n">writer</code><code class="p">,</code><code> </code><code class="n">channel</code><code class="p">)</code><code> </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-4" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-4"><img src="assets/4.png" alt="4"/></a><code>
</code><code>
</code><code>    </code><code class="n">chan</code><code> </code><code class="o">=</code><code> </code><code class="n">args</code><code class="o">.</code><code class="n">channel</code><code class="o">.</code><code class="n">encode</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-5" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-5"><img src="assets/5.png" alt="5"/></a><code>
</code><code>    </code><code class="k">try</code><code class="p">:</code><code>
</code><code>        </code><code class="k">for</code><code> </code><code class="n">i</code><code> </code><code class="ow">in</code><code> </code><code class="n">count</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-6" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-6"><img src="assets/6.png" alt="6"/></a><code>
</code><code>            </code><code class="k">await</code><code> </code><code class="n">asyncio</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="n">args</code><code class="o">.</code><code class="n">interval</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-7" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-7"><img src="assets/7.png" alt="7"/></a><code>
</code><code>            </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="s-Affix">b</code><code class="s1">'</code><code class="s1">X</code><code class="s1">'</code><code class="o">*</code><code class="n">args</code><code class="o">.</code><code class="n">size</code><code> </code><code class="ow">or</code><code> </code><code class="n">f</code><code class="s1">'</code><code class="s1">Msg </code><code class="si">{i}</code><code class="s1"> from </code><code class="si">{me}</code><code class="s1">'</code><code class="o">.</code><code class="n">encode</code><code class="p">(</code><code class="p">)</code><code>
</code><code>            </code><code class="k">try</code><code class="p">:</code><code>
</code><code>                </code><code class="k">await</code><code> </code><code class="n">send_msg</code><code class="p">(</code><code class="n">writer</code><code class="p">,</code><code> </code><code class="n">chan</code><code class="p">)</code><code>
</code><code>                </code><code class="k">await</code><code> </code><code class="n">send_msg</code><code class="p">(</code><code class="n">writer</code><code class="p">,</code><code> </code><code class="n">data</code><code class="p">)</code><code> </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-8" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-8"><img src="assets/8.png" alt="8"/></a><code>
</code><code>            </code><code class="k">except</code><code> </code><code class="ne">OSError</code><code class="p">:</code><code>
</code><code>                </code><code class="nb">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">Connection ended.</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>                </code><code class="k">break</code><code>
</code><code>    </code><code class="k">except</code><code> </code><code class="n">asyncio</code><code class="o">.</code><code class="n">CancelledError</code><code class="p">:</code><code>
</code><code>        </code><code class="n">writer</code><code class="o">.</code><code class="n">close</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="k">await</code><code> </code><code class="n">writer</code><code class="o">.</code><code class="n">wait_closed</code><code class="p">(</code><code class="p">)</code><code>
</code><code>
</code><code class="k">if</code><code> </code><code class="nv-Magic">__name__</code><code> </code><code class="o">==</code><code> </code><code class="s1">'</code><code class="s1">__main__</code><code class="s1">'</code><code class="p">:</code><code>
</code><code>  </code><code class="n">parser</code><code> </code><code class="o">=</code><code> </code><code class="n">argparse</code><code class="o">.</code><code class="n">ArgumentParser</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-9" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-9"><img src="assets/9.png" alt="9"/></a><code>
</code><code>  </code><code class="n">parser</code><code class="o">.</code><code class="n">add_argument</code><code class="p">(</code><code class="s1">'</code><code class="s1">--host</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">default</code><code class="o">=</code><code class="s1">'</code><code class="s1">localhost</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>  </code><code class="n">parser</code><code class="o">.</code><code class="n">add_argument</code><code class="p">(</code><code class="s1">'</code><code class="s1">--port</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">default</code><code class="o">=</code><code class="mi">25000</code><code class="p">,</code><code> </code><code class="nb">type</code><code class="o">=</code><code class="nb">int</code><code class="p">)</code><code>
</code><code>  </code><code class="n">parser</code><code class="o">.</code><code class="n">add_argument</code><code class="p">(</code><code class="s1">'</code><code class="s1">--channel</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">default</code><code class="o">=</code><code class="s1">'</code><code class="s1">/topic/foo</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>  </code><code class="n">parser</code><code class="o">.</code><code class="n">add_argument</code><code class="p">(</code><code class="s1">'</code><code class="s1">--interval</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">default</code><code class="o">=</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="nb">type</code><code class="o">=</code><code class="nb">float</code><code class="p">)</code><code>
</code><code>  </code><code class="n">parser</code><code class="o">.</code><code class="n">add_argument</code><code class="p">(</code><code class="s1">'</code><code class="s1">--size</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">default</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="nb">type</code><code class="o">=</code><code class="nb">int</code><code class="p">)</code><code>
</code><code>  </code><code class="k">try</code><code class="p">:</code><code>
</code><code>    </code><code class="n">asyncio</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="n">main</code><code class="p">(</code><code class="n">parser</code><code class="o">.</code><code class="n">parse_args</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code>
</code><code>  </code><code class="k">except</code><code> </code><code class="ne">KeyboardInterrupt</code><code class="p">:</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">Bye!</code><code class="s1">'</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-1" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-1"><img src="assets/1.png" alt="1"/></a></dt>
<dd><p>As with the listener, claim an identity.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-2" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-2"><img src="assets/2.png" alt="2"/></a></dt>
<dd><p>Reach out and make a connection.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-3" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-3"><img src="assets/3.png" alt="3"/></a></dt>
<dd><p>According to our protocol rules, the first thing to do after connecting
to the server is to give the name of the channel to subscribe to; however,
since we are a sender, we don’t really care about subscribing to any channels.
Nevertheless, the protocol requires it, so just provide a null channel to
subscribe to (we won’t actually listen for anything).</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-4" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-4"><img src="assets/4.png" alt="4"/></a></dt>
<dd><p>Send the channel to subscribe to.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-5" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-5"><img src="assets/5.png" alt="5"/></a></dt>
<dd><p>The command-line parameter <code>args.channel</code> provides the channel <em>to which</em>
we want to send messages. It must be converted to bytes first
before <span class="keep-together">sending</span>.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-6" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-6"><img src="assets/6.png" alt="6"/></a></dt>
<dd><p>Using <code>itertools.count()</code> is like a <code>while True</code> loop, except that we get
an iteration variable to use. We use this in the debugging messages since
it makes it a bit easier to track which message got sent from where.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-7" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-7"><img src="assets/7.png" alt="7"/></a></dt>
<dd><p>The delay between sent messages is an input parameter,
<code>args.interval</code>. The next line generates the message payload. It’s
either a bytestring of specified size (<code>args.size</code>) or a
descriptive message. This flexibility is just for testing.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-8" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-8"><img src="assets/8.png" alt="8"/></a></dt>
<dd><p>Note that <em>two</em> messages are sent here: the first is the
destination channel name, and the second is
the payload.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-9" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO4-9"><img src="assets/9.png" alt="9"/></a></dt>
<dd><p>As with the listener, there are a bunch of command-line options for
tweaking the sender: <code>channel</code> determines the target channel to send to,
while <code>interval</code> controls the delay between sends. The <code>size</code> parameter
controls the size of each message payload.</p></dd>
</dl></div>

<p>We now have a broker, a listener, and a sender; it’s time to see some output.
To produce the following code snippets, I started up the server,
then two listeners, and then a sender. Then, after a few messages had been
sent, I stopped the server with Ctrl-C.<a data-type="indexterm" data-primary="message queues" data-secondary="message queue case study" data-tertiary="server or broker output" id="idm46363025631976"/> The server output is shown
in <a data-type="xref" href="#brokeoutput">Example 4-5</a>, the sender output in <a data-type="xref" href="#senderoutput">Example 4-6</a>, and the
listener output in Examples <a data-type="xref" data-xrefstyle="select:labelnumber" href="#listeneroutput">4-7</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="#listener2output">4-8</a>.</p>
<div id="brokeoutput" data-type="example">
<h5><span class="label">Example 4-5. </span>Message broker (server) output</h5>
<pre data-type="programlisting">
$ <strong>mq_server.py</strong>
Remote ('127.0.0.1', 55382) subscribed to b'/queue/blah'
Remote ('127.0.0.1', 55386) subscribed to b'/queue/blah'
Remote ('127.0.0.1', 55390) subscribed to b'/null'
Sending to b'/queue/blah': b'Msg 0 from 6b5a8e1d'...
Sending to b'/queue/blah': b'Msg 1 from 6b5a8e1d'...
Sending to b'/queue/blah': b'Msg 2 from 6b5a8e1d'...
Sending to b'/queue/blah': b'Msg 3 from 6b5a8e1d'...
Sending to b'/queue/blah': b'Msg 4 from 6b5a8e1d'...
Sending to b'/queue/blah': b'Msg 5 from 6b5a8e1d'...
^CBye!
Remote ('127.0.0.1', 55382) closing connection.
Remote ('127.0.0.1', 55382) closed
Remote ('127.0.0.1', 55390) closing connection.
Remote ('127.0.0.1', 55390) closed
Remote ('127.0.0.1', 55386) closing connection.
Remote ('127.0.0.1', 55386) closed
</pre></div>
<div id="senderoutput" data-type="example">
<h5><span class="label">Example 4-6. </span>Sender (client) output</h5>
<pre data-type="programlisting">
$ <strong>mq_client_sender.py --channel /queue/blah</strong>
Starting up 6b5a8e1d
I am ('127.0.0.1', 55390)
Connection ended.
</pre></div>
<div id="listeneroutput" data-type="example">
<h5><span class="label">Example 4-7. </span>Listener 1 (client) output</h5>
<pre data-type="programlisting">
$ <strong>mq_client_listen.py --listen /queue/blah</strong>
Starting up 9ae04690
I am ('127.0.0.1', 55382)
Received by 9ae04690: b'Msg 1 from 6b5a8e1d'
Received by 9ae04690: b'Msg 3 from 6b5a8e1d'
Received by 9ae04690: b'Msg 5 from 6b5a8e1d'
Server closed.
</pre></div>
<div id="listener2output" data-type="example">
<h5><span class="label">Example 4-8. </span>Listener 2 (client) output</h5>
<pre data-type="programlisting">
$ <strong>mq_client_listen.py --listen /queue/blah</strong>
Starting up bd4e3baa
I am ('127.0.0.1', 55386)
Received by bd4e3baa: b'Msg 0 from 6b5a8e1d'
Received by bd4e3baa: b'Msg 2 from 6b5a8e1d'
Received by bd4e3baa: b'Msg 4 from 6b5a8e1d'
Server closed.
</pre></div>

<p>Our toy message broker works. The code is also pretty easy to understand,
given such a complex problem domain, but unfortunately, the design of the
broker code itself is problematic.</p>

<p>The problem is that, for a particular client, we send messages to
subscribers in the same coroutine as where new messages are
received. This means that if any subscriber is slow to consume what
we’re sending, it might take a long time for that <code>await gather(...)</code> line
in <a data-type="xref" href="#msgserver">Example 4-2</a> to complete, and we cannot receive and process more messages
while we wait.</p>

<p>Instead, we need to decouple the receiving of messages from the
sending of messages. In the next case study, we refactor
our code to do exactly that.<a data-type="indexterm" data-primary="message queues" data-secondary="message queue case study" data-startref="ix_messqucs" id="idm46363025508920"/><a data-type="indexterm" data-primary="asyncio libraries" data-secondary="streams standard library" data-tertiary="message queue case study" data-startref="ix_asylibstrmmqcs" id="idm46363025507704"/><a data-type="indexterm" data-primary="streams API" data-secondary="message queue case study" data-startref="ix_strmsmqcs" id="idm46363025506280"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Case Study: Improving the Message Queue"><div class="sect2" id="idm46363027299464">
<h2>Case Study: Improving the Message Queue</h2>

<p>In this case study, we improve the design of our toy message broker.
The listener and sender programs remain as is.<a data-type="indexterm" data-primary="asyncio libraries" data-secondary="streams standard library" data-tertiary="improving the message queue case study" id="ix_asylibstrmimpmq"/><a data-type="indexterm" data-primary="streams API" data-secondary="improving the message queue case study" id="ix_strmsimpmq"/><a data-type="indexterm" data-primary="message queues" data-secondary="improving the message queue case study" id="ix_messquimpcs"/> The specific improvement in the new broker design is to decouple sending and receiving messages; this will resolve
the problem where a slow subscriber would also slow down receiving new messages,
as discussed in the previous section. The new code,
shown in <a data-type="xref" href="#msgserverbetter">Example 4-9</a>, is a bit longer but not <span class="keep-together">terribly so.</span></p>
<div id="msgserverbetter" data-type="example">
<h5><span class="label">Example 4-9. </span>Message broker: improved design</h5>

<pre data-type="programlisting" data-code-language="python3"><code class="c1"># mq_server_plus.py</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">asyncio</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">asyncio</code><code> </code><code class="k">import</code><code> </code><code class="n">StreamReader</code><code class="p">,</code><code> </code><code class="n">StreamWriter</code><code class="p">,</code><code> </code><code class="n">Queue</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">collections</code><code> </code><code class="k">import</code><code> </code><code class="n">deque</code><code class="p">,</code><code> </code><code class="n">defaultdict</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">contextlib</code><code> </code><code class="k">import</code><code> </code><code class="n">suppress</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">typing</code><code> </code><code class="k">import</code><code> </code><code class="n">Deque</code><code class="p">,</code><code> </code><code class="n">DefaultDict</code><code class="p">,</code><code> </code><code class="n">Dict</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">msgproto</code><code> </code><code class="k">import</code><code> </code><code class="n">read_msg</code><code class="p">,</code><code> </code><code class="n">send_msg</code><code>
</code><code>
</code><code class="n">SUBSCRIBERS</code><code class="p">:</code><code> </code><code class="n">DefaultDict</code><code class="p">[</code><code class="nb">bytes</code><code class="p">,</code><code> </code><code class="n">Deque</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">defaultdict</code><code class="p">(</code><code class="n">deque</code><code class="p">)</code><code>
</code><code class="n">SEND_QUEUES</code><code class="p">:</code><code> </code><code class="n">DefaultDict</code><code class="p">[</code><code class="n">StreamWriter</code><code class="p">,</code><code> </code><code class="n">Queue</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">defaultdict</code><code class="p">(</code><code class="n">Queue</code><code class="p">)</code><code>
</code><code class="n">CHAN_QUEUES</code><code class="p">:</code><code> </code><code class="n">Dict</code><code class="p">[</code><code class="nb">bytes</code><code class="p">,</code><code> </code><code class="n">Queue</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="p">{</code><code class="p">}</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-1" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-1"><img src="assets/1.png" alt="1"/></a><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">client</code><code class="p">(</code><code class="n">reader</code><code class="p">:</code><code> </code><code class="n">StreamReader</code><code class="p">,</code><code> </code><code class="n">writer</code><code class="p">:</code><code> </code><code class="n">StreamWriter</code><code class="p">)</code><code class="p">:</code><code>
</code><code>  </code><code class="n">peername</code><code> </code><code class="o">=</code><code> </code><code class="n">writer</code><code class="o">.</code><code class="n">get_extra_info</code><code class="p">(</code><code class="s1">'</code><code class="s1">peername</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>  </code><code class="n">subscribe_chan</code><code> </code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="n">read_msg</code><code class="p">(</code><code class="n">reader</code><code class="p">)</code><code>
</code><code>  </code><code class="n">SUBSCRIBERS</code><code class="p">[</code><code class="n">subscribe_chan</code><code class="p">]</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">writer</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-2" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-2"><img src="assets/2.png" alt="2"/></a><code>
</code><code>  </code><code class="n">send_task</code><code> </code><code class="o">=</code><code> </code><code class="n">asyncio</code><code class="o">.</code><code class="n">create_task</code><code class="p">(</code><code>
</code><code>      </code><code class="n">send_client</code><code class="p">(</code><code class="n">writer</code><code class="p">,</code><code> </code><code class="n">SEND_QUEUES</code><code class="p">[</code><code class="n">writer</code><code class="p">]</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-3" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-3"><img src="assets/3.png" alt="3"/></a><code>
</code><code>  </code><code class="nb">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">Remote </code><code class="si">{peername}</code><code class="s1"> subscribed to </code><code class="si">{subscribe_chan}</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>  </code><code class="k">try</code><code class="p">:</code><code>
</code><code>    </code><code class="k">while</code><code> </code><code class="n">channel_name</code><code> </code><code class="p">:</code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="n">read_msg</code><code class="p">(</code><code class="n">reader</code><code class="p">)</code><code class="p">:</code><code>
</code><code>      </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="n">read_msg</code><code class="p">(</code><code class="n">reader</code><code class="p">)</code><code>
</code><code>      </code><code class="k">if</code><code> </code><code class="n">channel_name</code><code> </code><code class="ow">not</code><code> </code><code class="ow">in</code><code> </code><code class="n">CHAN_QUEUES</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-4" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-4"><img src="assets/4.png" alt="4"/></a><code>
</code><code>        </code><code class="n">CHAN_QUEUES</code><code class="p">[</code><code class="n">channel_name</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">Queue</code><code class="p">(</code><code class="n">maxsize</code><code class="o">=</code><code class="mi">10</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-5" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-5"><img src="assets/5.png" alt="5"/></a><code>
</code><code>        </code><code class="n">asyncio</code><code class="o">.</code><code class="n">create_task</code><code class="p">(</code><code class="n">chan_sender</code><code class="p">(</code><code class="n">channel_name</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-6" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-6"><img src="assets/6.png" alt="6"/></a><code>
</code><code>      </code><code class="k">await</code><code> </code><code class="n">CHAN_QUEUES</code><code class="p">[</code><code class="n">channel_name</code><code class="p">]</code><code class="o">.</code><code class="n">put</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-7" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-7"><img src="assets/7.png" alt="7"/></a><code>
</code><code>  </code><code class="k">except</code><code> </code><code class="n">asyncio</code><code class="o">.</code><code class="n">CancelledError</code><code class="p">:</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">Remote </code><code class="si">{peername}</code><code class="s1"> connection cancelled.</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>  </code><code class="k">except</code><code> </code><code class="n">asyncio</code><code class="o">.</code><code class="n">IncompleteReadError</code><code class="p">:</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">Remote </code><code class="si">{peername}</code><code class="s1"> disconnected</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>  </code><code class="k">finally</code><code class="p">:</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">Remote </code><code class="si">{peername}</code><code class="s1"> closed</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>    </code><code class="k">await</code><code> </code><code class="n">SEND_QUEUES</code><code class="p">[</code><code class="n">writer</code><code class="p">]</code><code class="o">.</code><code class="n">put</code><code class="p">(</code><code class="kc">None</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-8" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-8"><img src="assets/8.png" alt="8"/></a><code>
</code><code>    </code><code class="k">await</code><code> </code><code class="n">send_task</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-9" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-9"><img src="assets/9.png" alt="9"/></a><code>
</code><code>    </code><code class="k">del</code><code> </code><code class="n">SEND_QUEUES</code><code class="p">[</code><code class="n">writer</code><code class="p">]</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-10" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-10"><img src="assets/10.png" alt="10"/></a><code>
</code><code>    </code><code class="n">SUBSCRIBERS</code><code class="p">[</code><code class="n">subscribe_chan</code><code class="p">]</code><code class="o">.</code><code class="n">remove</code><code class="p">(</code><code class="n">writer</code><code class="p">)</code><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">send_client</code><code class="p">(</code><code class="n">writer</code><code class="p">:</code><code> </code><code class="n">StreamWriter</code><code class="p">,</code><code> </code><code class="n">queue</code><code class="p">:</code><code> </code><code class="n">Queue</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-11" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-11"><img src="assets/11.png" alt="11"/></a><code>
</code><code>    </code><code class="k">while</code><code> </code><code class="kc">True</code><code class="p">:</code><code>
</code><code>        </code><code class="k">try</code><code class="p">:</code><code>
</code><code>            </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="n">queue</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="k">except</code><code> </code><code class="n">asyncio</code><code class="o">.</code><code class="n">CancelledError</code><code class="p">:</code><code>
</code><code>            </code><code class="k">continue</code><code>
</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="ow">not</code><code> </code><code class="n">data</code><code class="p">:</code><code>
</code><code>            </code><code class="k">break</code><code>
</code><code>
</code><code>        </code><code class="k">try</code><code class="p">:</code><code>
</code><code>            </code><code class="k">await</code><code> </code><code class="n">send_msg</code><code class="p">(</code><code class="n">writer</code><code class="p">,</code><code> </code><code class="n">data</code><code class="p">)</code><code>
</code><code>        </code><code class="k">except</code><code> </code><code class="n">asyncio</code><code class="o">.</code><code class="n">CancelledError</code><code class="p">:</code><code>
</code><code>            </code><code class="k">await</code><code> </code><code class="n">send_msg</code><code class="p">(</code><code class="n">writer</code><code class="p">,</code><code> </code><code class="n">data</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="n">writer</code><code class="o">.</code><code class="n">close</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="k">await</code><code> </code><code class="n">writer</code><code class="o">.</code><code class="n">wait_closed</code><code class="p">(</code><code class="p">)</code><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">chan_sender</code><code class="p">(</code><code class="n">name</code><code class="p">:</code><code> </code><code class="nb">bytes</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="k">with</code><code> </code><code class="n">suppress</code><code class="p">(</code><code class="n">asyncio</code><code class="o">.</code><code class="n">CancelledError</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="k">while</code><code> </code><code class="kc">True</code><code class="p">:</code><code>
</code><code>            </code><code class="n">writers</code><code> </code><code class="o">=</code><code> </code><code class="n">SUBSCRIBERS</code><code class="p">[</code><code class="n">name</code><code class="p">]</code><code>
</code><code>            </code><code class="k">if</code><code> </code><code class="ow">not</code><code> </code><code class="n">writers</code><code class="p">:</code><code>
</code><code>                </code><code class="k">await</code><code> </code><code class="n">asyncio</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code>
</code><code>                </code><code class="k">continue</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-12" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-12"><img src="assets/12.png" alt="12"/></a><code>
</code><code>            </code><code class="k">if</code><code> </code><code class="n">name</code><code class="o">.</code><code class="n">startswith</code><code class="p">(</code><code class="s-Affix">b</code><code class="s1">'</code><code class="s1">/queue</code><code class="s1">'</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-13" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-13"><img src="assets/13.png" alt="13"/></a><code>
</code><code>                </code><code class="n">writers</code><code class="o">.</code><code class="n">rotate</code><code class="p">(</code><code class="p">)</code><code>
</code><code>                </code><code class="n">writers</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="n">writers</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="p">]</code><code>
</code><code>            </code><code class="k">if</code><code> </code><code class="ow">not</code><code> </code><code class="p">(</code><code class="n">msg</code><code> </code><code class="p">:</code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="n">CHAN_QUEUES</code><code class="p">[</code><code class="n">name</code><code class="p">]</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code> </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-14" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-14"><img src="assets/14.png" alt="14"/></a><code>
</code><code>                </code><code class="k">break</code><code>
</code><code>            </code><code class="k">for</code><code> </code><code class="n">writer</code><code> </code><code class="ow">in</code><code> </code><code class="n">writers</code><code class="p">:</code><code>
</code><code>                </code><code class="k">if</code><code> </code><code class="ow">not</code><code> </code><code class="n">SEND_QUEUES</code><code class="p">[</code><code class="n">writer</code><code class="p">]</code><code class="o">.</code><code class="n">full</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>                    </code><code class="nb">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">Sending to </code><code class="si">{name}</code><code class="s1">: </code><code class="si">{msg[:19]}</code><code class="s1">...</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>                    </code><code class="k">await</code><code> </code><code class="n">SEND_QUEUES</code><code class="p">[</code><code class="n">writer</code><code class="p">]</code><code class="o">.</code><code class="n">put</code><code class="p">(</code><code class="n">msg</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-15" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-15"><img src="assets/15.png" alt="15"/></a><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">main</code><code class="p">(</code><code class="o">*</code><code class="n">args</code><code class="p">,</code><code> </code><code class="o">*</code><code class="o">*</code><code class="n">kwargs</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">server</code><code> </code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="n">asyncio</code><code class="o">.</code><code class="n">start_server</code><code class="p">(</code><code class="o">*</code><code class="n">args</code><code class="p">,</code><code> </code><code class="o">*</code><code class="o">*</code><code class="n">kwargs</code><code class="p">)</code><code>
</code><code>    </code><code class="k">async</code><code> </code><code class="k">with</code><code> </code><code class="n">server</code><code class="p">:</code><code>
</code><code>        </code><code class="k">await</code><code> </code><code class="n">server</code><code class="o">.</code><code class="n">serve_forever</code><code class="p">(</code><code class="p">)</code><code>
</code><code class="k">try</code><code class="p">:</code><code>
</code><code>    </code><code class="n">asyncio</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="n">main</code><code class="p">(</code><code class="n">client</code><code class="p">,</code><code> </code><code class="n">host</code><code class="o">=</code><code class="s1">'</code><code class="s1">127.0.0.1</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">port</code><code class="o">=</code><code class="mi">25000</code><code class="p">)</code><code class="p">)</code><code>
</code><code class="k">except</code><code> </code><code class="ne">KeyboardInterrupt</code><code class="p">:</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">Bye!</code><code class="s1">'</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-1" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-1"><img src="assets/1.png" alt="1"/></a></dt>
<dd><p>In the previous implementation, there were only
<code>SUBSCRIBERS</code>; now there are <code>SEND_QUEUES</code> and <code>CHAN_QUEUES</code> as global
collections. This is a consequence of completely decoupling the <em>receiving</em>
and <em>sending</em> of data. <code>SEND_QUEUES</code> has one queue entry for each
client connection: all data that must be sent to that client must be placed
onto that queue. (If you peek ahead, the <code>send_client()</code> coroutine will pull
data off <code>SEND_QUEUES</code> and send it.)</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-2" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-2"><img src="assets/2.png" alt="2"/></a></dt>
<dd><p>Up until this point in the <code>client()</code> coroutine function, the code
is the same as in the simple server: the subscribed channel name is received,
and we add the <span class="keep-together"><code>StreamWriter</code></span> instance for the new client
to the global <code>SUBSCRIBERS</code> collection.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-3" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-3"><img src="assets/3.png" alt="3"/></a></dt>
<dd><p>This is new: we create a long-lived
task that will do all the sending of data to this client. The task
will run independently as a separate coroutine and will pull messages off the
supplied queue, <code>SEND_QUEUES[writer]</code>, for sending.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-4" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-4"><img src="assets/4.png" alt="4"/></a></dt>
<dd><p>Now we’re inside the loop where we receive data. Remember
that we always receive two messages: one for the destination channel name, and one
for the data. We’re going to create a new, dedicated <code>Queue</code> for every
destination channel, and that’s what <code>CHAN_QUEUES</code> is for: when any client wants to
push data to a channel, we’re going
to put that data onto the appropriate queue and then go immediately back to
listening for more data. This approach decouples the distribution of
messages from the receiving of messages from this client.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-5" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-5"><img src="assets/5.png" alt="5"/></a></dt>
<dd><p>If there isn’t already a queue for the target channel, make one.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-6" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-6"><img src="assets/6.png" alt="6"/></a></dt>
<dd><p>Create a dedicated and long-lived task for that channel. The coroutine
<code>chan_sender()</code> will be responsible for taking data off the channel queue
and distributing that data to subscribers.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-7" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-7"><img src="assets/7.png" alt="7"/></a></dt>
<dd><p>Place the newly received data onto the specific channel’s queue. If the queue fills up, we’ll wait here until there is space for the
new data. Waiting here means we won’t be reading any new data off the socket,
which means that the client will have to wait on sending new data into the
socket on its side. This isn’t necessarily a bad thing, since it
communicates so-called <em>back-pressure</em> to this client.
(Alternatively, you could choose to drop messages
here if the use case is OK with that.)</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-8" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-8"><img src="assets/8.png" alt="8"/></a></dt>
<dd><p>When the connection is closed, it’s time to clean up. The long-lived
task we created for sending data to this client, <code>send_task</code>, can be
shut down by placing <code>None</code> onto its queue, <code>SEND_QUEUES[writer]</code> (check the
code for <code>send_client()</code>). It’s important to use a value on the queue, rather
than outright cancellation, because there may already be data on that queue
and we want that data to be sent out before <code>send_client()</code> is ended.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-9" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-9"><img src="assets/9.png" alt="9"/></a></dt>
<dd><p>Wait for that sender task to finish…</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-10" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-10"><img src="assets/10.png" alt="10"/></a></dt>
<dd><p>…then remove the entry in the <code>SEND_QUEUES</code> collection (and in the next
line, we also remove the <code>sock</code> from the <code>SUBSCRIBERS</code> collection as before).</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-11" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-11"><img src="assets/11.png" alt="11"/></a></dt>
<dd><p>The <code>send_client()</code> coroutine function is very nearly a textbook example
of pulling work off a queue. Note how the coroutine will exit only if <code>None</code> is
placed onto the queue. Note also how we suppress <code>CancelledError</code> <em>inside</em>
the loop: this is because we want this task to be closed only by receiving
a <code>None</code> on the queue. This way, all pending data on the queue can be
sent out before shutdown.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-12" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-12"><img src="assets/12.png" alt="12"/></a></dt>
<dd><p><code>chan_sender()</code> is the distribution logic for a channel: it sends data
from a dedicated channel <code>Queue</code> instance to all the subscribers on that
channel. But what happens if there are no subscribers for this channel yet?
We’ll just wait a bit and try again. (Note, though, that the queue for
this channel, <code>CHAN_QUEUES[name]</code>, will keep filling up.)</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-13" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-13"><img src="assets/13.png" alt="13"/></a></dt>
<dd><p>As in our previous broker implementation, we do something
special for channels
whose name begins with <code>/queue</code>: we rotate the deque and send only to
the first entry. This acts like a crude load-balancing system because each
subscriber gets different messages off the same queue. For all other channels,
all subscribers get all the messages.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-14" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-14"><img src="assets/14.png" alt="14"/></a></dt>
<dd><p>We’ll wait here for data on the queue, and
exit if <code>None</code> is received. Currently, this isn’t triggered anywhere
(so these <code>chan_sender()</code>
coroutines live forever), but if logic were added to clean up these channel
tasks after, say, some period of inactivity, that’s how it would be done.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-15" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO5-15"><img src="assets/15.png" alt="15"/></a></dt>
<dd><p>Data has been received, so it’s time to send to subscribers. We do not do the sending here: instead, we place the data onto each
subscriber’s own send queue. This decoupling is necessary to make sure
that a slow subscriber doesn’t slow down anyone else receiving data. And
furthermore, if the subscriber is so slow that their send queue fills up,
we don’t put that data on their queue; i.e., it is lost.</p></dd>
</dl></div>

<p>The preceding design produces the same output as the earlier, simplistic
implementation, but now we can be sure that a slow listener will not
interfere with message distribution to other listeners.</p>

<p>These two case studies show a progression in thinking around the
design of a message distribution system. A key aspect was the
realization that sending and receiving data might be best handled in
separate coroutines, depending on the use case. In such instances,
queues can be very useful for moving data between those different
coroutines and for providing buffering to decouple them.</p>

<p>The more important goal of these case studies was to show how the streams API
in <code>asyncio</code> makes it very easy to build socket-based applications.<a data-type="indexterm" data-primary="asyncio libraries" data-secondary="streams standard library" data-tertiary="improving the message queue case study" data-startref="ix_asylibstrmimpmq" id="idm46363025166312"/><a data-type="indexterm" data-primary="streams API" data-secondary="improving the message queue case study" data-startref="ix_strmsimpmq" id="idm46363025164856"/><a data-type="indexterm" data-primary="message queues" data-secondary="improving the message queue case study" data-startref="ix_messquimpcs" id="idm46363025163672"/><a data-type="indexterm" data-primary="asyncio libraries" data-secondary="streams standard library" data-startref="ix_asylibstrm" id="idm46363025162488"/><a data-type="indexterm" data-primary="streams API" data-startref="ix_strms" id="idm46363025161304"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Twisted"><div class="sect1" id="idm46363025091144">
<h1>Twisted</h1>

<p>The <a href="https://oreil.ly/Y3dY2">Twisted</a> project predates—dramatically—the
<code>asyncio</code> standard library, and has been flying the
flag of async programming in Python for around 14 years now.<a data-type="indexterm" data-primary="Twisted" id="ix_Twst"/><a data-type="indexterm" data-primary="asyncio libraries" data-secondary="Twisted" id="ix_asylibTw"/> The project
provides not only the basic building blocks, like an event loop, but also
primitives like <em>deferreds</em> that are a bit like the futures in <code>asyncio</code>.
The design of <code>asyncio</code> has been heavily influenced by Twisted and the
extensive experience of its leaders and maintainers.</p>

<p>Note that <a href="https://oreil.ly/J0ezC"><code>asyncio</code> does <em>not</em> replace Twisted</a>.
Twisted includes high-quality implementations of a huge number of internet
protocols, including not only the usual HTTP but also XMPP, NNTP, IMAP, SSH,
IRC, and FTP (both servers and clients). And the list goes on: DNS? Check.
SMTP? Check. POP3? Check. The availability of these excellent internet protocol implementations continues to make Twisted compelling.</p>

<p>At the code level, the main<a data-type="indexterm" data-primary="Twisted" data-secondary="main difference between asyncio and" id="idm46363025073944"/> difference between Twisted and
<code>asyncio</code>, apart from history and historical context, is that for a
long time Python lacked language support <a data-type="indexterm" data-primary="coroutines" data-secondary="Twisted and" id="idm46363025072376"/>for coroutines, and this
meant that Twisted and projects like it had to figure out ways of
dealing with asynchronicity that worked with standard Python syntax.</p>

<p>For most of Twisted’s history, <em>callbacks</em> were the means by which
async programming<a data-type="indexterm" data-primary="callbacks" id="idm46363025070072"/> was done, with all the nonlinear complexity that entails;
however, when it became possible to use generators as makeshift coroutines, it
suddenly<a data-type="indexterm" data-primary="Twisted" data-secondary="inline callbacks" id="idm46363025106024"/> became possible to lay out code in Twisted in a linear fashion
using <a data-type="indexterm" data-primary="@defer.inlineCallbacks decorator" id="idm46363025104952"/>its <code>@defer.inlineCallbacks</code> decorator, as shown in <a data-type="xref" href="#twistedinline">Example 4-10</a>.</p>
<div id="twistedinline" data-type="example">
<h5><span class="label">Example 4-10. </span>Even more Twisted with inlined callbacks</h5>

<pre data-type="programlisting" data-code-language="python3"><code class="nd">@defer</code><code class="o">.</code><code class="n">inlineCallbacks</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO6-1" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO6-1"><img src="assets/1.png" alt="1"/></a><code>
</code><code class="k">def</code><code> </code><code class="nf">f</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="k">yield</code><code>
</code><code>    </code><code class="n">defer</code><code class="o">.</code><code class="n">returnValue</code><code class="p">(</code><code class="mi">123</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO6-2" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO6-2"><img src="assets/2.png" alt="2"/></a><code>
</code><code>
</code><code class="nd">@defer</code><code class="o">.</code><code class="n">inlineCallbacks</code><code>
</code><code class="k">def</code><code> </code><code class="nf">my_coro_func</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">value</code><code> </code><code class="o">=</code><code> </code><code class="k">yield</code><code> </code><code class="n">f</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO6-3" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO6-3"><img src="assets/3.png" alt="3"/></a><code>
</code><code>    </code><code class="k">assert</code><code> </code><code class="n">value</code><code> </code><code class="o">==</code><code> </code><code class="mi">123</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO6-1" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO6-1"><img src="assets/1.png" alt="1"/></a></dt>
<dd><p>Ordinarily, Twisted requires creating instances of <code>Deferred</code> and
adding callbacks to those instances as the method of constructing async
programs.<a data-type="indexterm" data-primary="Deferred instances, adding callbacks to" id="idm46363025170600"/> A few years ago, the <code>@inlineCallbacks</code> decorator <a data-type="indexterm" data-primary="@inlineCallbacks decorator" id="idm46363025169384"/>was added, which
repurposes generators as coroutines.<a data-type="indexterm" data-primary="generators" data-secondary="repurposing as coroutines" id="idm46363025168552"/><a data-type="indexterm" data-primary="coroutines" data-secondary="repurposing generators as" id="idm46363025121544"/></p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO6-2" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO6-2"><img src="assets/2.png" alt="2"/></a></dt>
<dd><p>While <code>@inlineCallbacks</code> <em>did</em> allow you to write code that was linear
in appearance (unlike callbacks), some hacks were required, such as this
call to <code>defer.returnValue()</code>, which is<a data-type="indexterm" data-primary="defer.returnValue function" id="idm46363025116728"/> how you have to return values from
<span class="keep-together"><code>@inlineCallbacks</code></span> coroutines.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO6-3" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO6-3"><img src="assets/3.png" alt="3"/></a></dt>
<dd><p>Here we can see the <code>yield</code> that makes<a data-type="indexterm" data-primary="yield keyword" id="idm46363025060168"/> this function a generator. For
<span class="keep-together"><code>@inlineCallbacks</code></span> to work, there must be at least one <code>yield</code> present
in the function being decorated.</p></dd>
</dl></div>

<p>Since native coroutines appeared in Python 3.5, the Twisted team
(and <a href="https://atleastfornow.net">Amber Brown</a> in particular) have been
working to add support for running Twisted on the <code>asyncio</code> event loop.<a data-type="indexterm" data-primary="native coroutines" data-secondary="and support for running Twisted in asyncio event loops" id="idm46363025056680"/><a data-type="indexterm" data-primary="Brown, Amber" id="idm46363025055704"/><a data-type="indexterm" data-primary="coroutines" data-secondary="native" data-tertiary="and support for running Twisted in asyncio event loops" id="idm46363025055032"/><a data-type="indexterm" data-primary="event loops" data-secondary="running Twisted in asyncio loops" id="idm46363025053848"/></p>

<p>This is an ongoing effort, and my goal in this section is not to convince
you to create all your applications as Twisted-<code>asyncio</code> hybrids, but rather
to make you aware that work is currently being done to provide significant
interoperability between the two.</p>

<p>For those of you with experience using Twisted, <a data-type="xref" href="#twistedasyncio">Example 4-11</a>
might be jarring.<a data-type="indexterm" data-primary="Twisted" data-secondary="support for asyncio in" id="idm46363025159480"/></p>
<div id="twistedasyncio" data-type="example">
<h5><span class="label">Example 4-11. </span>Support for asyncio in Twisted</h5>

<pre data-type="programlisting" data-code-language="python3"><code class="c1"># twisted_asyncio.py</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">time</code><code> </code><code class="k">import</code><code> </code><code class="n">ctime</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">twisted</code><code class="nn">.</code><code class="nn">internet</code><code> </code><code class="k">import</code><code> </code><code class="n">asyncioreactor</code><code>
</code><code class="n">asyncioreactor</code><code class="o">.</code><code class="n">install</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO7-1" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO7-1"><img src="assets/1.png" alt="1"/></a><code>
</code><code class="kn">from</code><code> </code><code class="nn">twisted</code><code class="nn">.</code><code class="nn">internet</code><code> </code><code class="k">import</code><code> </code><code class="n">reactor</code><code class="p">,</code><code> </code><code class="n">defer</code><code class="p">,</code><code> </code><code class="n">task</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO7-2" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO7-2"><img src="assets/2.png" alt="2"/></a><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">main</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO7-3" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO7-3"><img src="assets/3.png" alt="3"/></a><code>
</code><code>    </code><code class="k">for</code><code> </code><code class="n">i</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="mi">5</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="nb">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">{</code><code class="s1">ctime()} Hello </code><code class="si">{i}</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>        </code><code class="k">await</code><code> </code><code class="n">task</code><code class="o">.</code><code class="n">deferLater</code><code class="p">(</code><code class="n">reactor</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="k">lambda</code><code class="p">:</code><code> </code><code class="kc">None</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO7-4" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO7-4"><img src="assets/4.png" alt="4"/></a><code>
</code><code>
</code><code class="n">defer</code><code class="o">.</code><code class="n">ensureDeferred</code><code class="p">(</code><code class="n">main</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO7-5" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO7-5"><img src="assets/5.png" alt="5"/></a><code>
</code><code class="n">reactor</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO7-6" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO7-6"><img src="assets/6.png" alt="6"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO7-1" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO7-1"><img src="assets/1.png" alt="1"/></a></dt>
<dd><p>This is how you tell Twisted to use the <code>asyncio</code> event loop as its
main <code>reactor</code>. <a data-type="indexterm" data-primary="reactors" id="idm46363024370632"/>Note that this line <em>must</em> come before the <code>reactor</code> is imported
from <span class="keep-together"><code>twisted.internet</code></span> on the following line.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO7-2" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO7-2"><img src="assets/2.png" alt="2"/></a></dt>
<dd><p>Anyone familiar with Twisted programming will recognize these imports.
We don’t have space to cover them in depth here, but in a nutshell, the <code>reactor</code> is
the <code>Twisted</code> version of the <code>asyncio</code> <em>loop</em>, and <code>defer</code> and <code>task</code> are
namespaces for tools to work with scheduling coroutines.<a data-type="indexterm" data-primary="coroutines" data-secondary="scheduling in Twisted" id="idm46363024388088"/></p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO7-3" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO7-3"><img src="assets/3.png" alt="3"/></a></dt>
<dd><p>Seeing <code>async def</code> here, in a Twisted program, looks odd,
but this <a data-type="indexterm" data-primary="async def keywords in Twisted" id="idm46363024335912"/>is indeed what the new support for <code>async/await</code>
gives us: the ability to use native coroutines directly in Twisted programs.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO7-4" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO7-4"><img src="assets/4.png" alt="4"/></a></dt>
<dd><p>In the older <code>@inlineCallbacks</code> world, you <a data-type="indexterm" data-primary="await keyword" data-secondary="using in Twisted" id="idm46363024331960"/>would have used
<code>yield from</code> here, but now we can use <code>await</code>, the same as in <code>asyncio</code> code.
The other<a data-type="indexterm" data-primary="deferLater function" id="idm46363024329832"/> part of this line, <code>deferLater()</code>, is an alternative way to do the
same thing as <span class="keep-together"><code>asyncio.sleep(1)</code></span>. We <code>await</code> a future where, after one second,
a do-nothing callback will fire.<a data-type="indexterm" data-primary="futures" data-secondary="awaiting in Twisted" id="idm46363024327576"/></p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO7-5" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO7-5"><img src="assets/5.png" alt="5"/></a></dt>
<dd><p><code>ensureDeferred()</code> is a Twisted version of scheduling a coroutine.<a data-type="indexterm" data-primary="ensureDeferred function" id="idm46363024324376"/> This
would be analogous to <code>loop.create_task()</code> or <span class="keep-together"><code>asyncio.ensure_future()</code></span>.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO7-6" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO7-6"><img src="assets/6.png" alt="6"/></a></dt>
<dd><p>Running the <code>reactor</code> is the same as <code>loop.run_forever()</code> in <span class="keep-together"><code>asyncio</code></span>.</p></dd>
</dl></div>

<p>Running this script produces the following output:</p>
<pre data-type="programlisting">
$ <strong>twisted_asyncio.py</strong>
Mon Oct 16 16:19:49 2019 Hello 0
Mon Oct 16 16:19:50 2019 Hello 1
Mon Oct 16 16:19:51 2019 Hello 2
Mon Oct 16 16:19:52 2019 Hello 3
Mon Oct 16 16:19:53 2019 Hello 4
</pre>

<p>There’s much more to learn about Twisted. In particular, it’s well
worth your time to go through the list of networking protocols it implements.
There is still some work to be done, but the future looks very bright for interoperation between Twisted and <code>asyncio</code>.</p>

<p><code>asyncio</code> has been designed in such a way that we can look forward to
a future where it will be possible to incorporate code from many
async frameworks, such as Twisted and Tornado, into a single
application, with all code running on the same event loop.<a data-type="indexterm" data-primary="Twisted" data-startref="ix_Twst" id="idm46363024315512"/><a data-type="indexterm" data-primary="asyncio libraries" data-secondary="Twisted" data-startref="ix_asylibTw" id="idm46363024314664"/></p>
</div></section>













<section data-type="sect1" class="less_space pagebreak-before" data-pdf-bookmark="The Janus Queue"><div class="sect1" id="idm46363025090616">
<h1>The Janus Queue</h1>

<p>The Janus queue (installed with <code>pip install janus</code>) provides a
solution for communication between threads and coroutines.<a data-type="indexterm" data-primary="queues" data-secondary="Janus queue library" id="ix_queJan"/><a data-type="indexterm" data-primary="asyncio libraries" data-secondary="Janus queue" id="ix_asylibJq"/><a data-type="indexterm" data-primary="coroutines" data-secondary="communication with threads via Janus queue" id="ix_corocomm"/><a data-type="indexterm" data-primary="threads" data-secondary="communication with coroutines via Janus queue" id="ix_thrdcomm"/><a data-type="indexterm" data-primary="Janus queue" id="ix_Janqu"/> In the
Python standard library, there are two kinds of queues:</p>
<dl>
<dt><code>queue.Queue</code></dt>
<dd>
<p>A <em>blocking</em> queue, commonly used for communication
and buffering between threads<a data-type="indexterm" data-primary="blocking queue" id="idm46363024304456"/></p>
</dd>
<dt><code>asyncio.Queue</code></dt>
<dd>
<p>An <code>async</code>-compatible queue, commonly used for
communication and buffering between coroutines<a data-type="indexterm" data-primary="async-compatible queue" id="idm46363024302184"/></p>
</dd>
</dl>

<p>Unfortunately, neither is useful for communication between threads
and coroutines! This is where Janus comes in: it is a single
queue that exposes both APIs, a blocking one <em>and</em> an async one.
<a data-type="xref" href="#janusex">Example 4-12</a> generates data from inside a thread, places that data on a
queue, and then consumes that data from a coroutine.</p>
<div id="janusex" data-type="example">
<h5><span class="label">Example 4-12. </span>Connecting coroutines and threads with a Janus queue</h5>

<pre data-type="programlisting" data-code-language="python3"><code class="c1"># janus_demo.py</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">asyncio</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">random</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">time</code><code>
</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">janus</code><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">main</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">loop</code><code> </code><code class="o">=</code><code> </code><code class="n">asyncio</code><code class="o">.</code><code class="n">get_running_loop</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="n">queue</code><code> </code><code class="o">=</code><code> </code><code class="n">janus</code><code class="o">.</code><code class="n">Queue</code><code class="p">(</code><code class="n">loop</code><code class="o">=</code><code class="n">loop</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO8-1" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO8-1"><img src="assets/1.png" alt="1"/></a><code>
</code><code>    </code><code class="n">future</code><code> </code><code class="o">=</code><code> </code><code class="n">loop</code><code class="o">.</code><code class="n">run_in_executor</code><code class="p">(</code><code class="kc">None</code><code class="p">,</code><code> </code><code class="n">data_source</code><code class="p">,</code><code> </code><code class="n">queue</code><code class="p">)</code><code>
</code><code>    </code><code class="k">while</code><code> </code><code class="p">(</code><code class="n">data</code><code> </code><code class="p">:</code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="n">queue</code><code class="o">.</code><code class="n">async_q</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code> </code><code class="ow">is</code><code> </code><code class="ow">not</code><code> </code><code class="kc">None</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO8-2" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO8-2"><img src="assets/2.png" alt="2"/></a><code>
</code><code>        </code><code class="nb">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">Got </code><code class="si">{data}</code><code class="s1"> off queue</code><code class="s1">'</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO8-3" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO8-3"><img src="assets/3.png" alt="3"/></a><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">Done.</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>
</code><code class="k">def</code><code> </code><code class="nf">data_source</code><code class="p">(</code><code class="n">queue</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="k">for</code><code> </code><code class="n">i</code><code> </code><code class="ow">in</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="mi">10</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="n">r</code><code> </code><code class="o">=</code><code> </code><code class="n">random</code><code class="o">.</code><code class="n">randint</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">4</code><code class="p">)</code><code>
</code><code>        </code><code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="n">r</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO8-4" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO8-4"><img src="assets/4.png" alt="4"/></a><code>
</code><code>        </code><code class="n">queue</code><code class="o">.</code><code class="n">sync_q</code><code class="o">.</code><code class="n">put</code><code class="p">(</code><code class="n">r</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO8-5" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO8-5"><img src="assets/5.png" alt="5"/></a><code>
</code><code>    </code><code class="n">queue</code><code class="o">.</code><code class="n">sync_q</code><code class="o">.</code><code class="n">put</code><code class="p">(</code><code class="kc">None</code><code class="p">)</code><code>
</code><code>
</code><code class="n">asyncio</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="n">main</code><code class="p">(</code><code class="p">)</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO8-1" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO8-1"><img src="assets/1.png" alt="1"/></a></dt>
<dd><p>Create a Janus queue. Note that just like an <code>asyncio.Queue</code>, the
Janus queue will be associated with a specific event loop. As
usual, if you don’t provide the <code>loop</code> parameter, the standard
<code>get_event_loop()</code> call will be used internally.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO8-2" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO8-2"><img src="assets/2.png" alt="2"/></a></dt>
<dd><p>Our <code>main()</code> coroutine function simply waits for data on a
queue. This line will suspend until there is data, exactly until there is data, exactly like calling <code>get()</code> on an <code>asyncio.Queue</code> instance.
The queue object has two <em>faces</em>: this one is called
<code>async_q</code> and provides the async-compatible queue API.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO8-3" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO8-3"><img src="assets/3.png" alt="3"/></a></dt>
<dd><p>Print a message.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO8-4" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO8-4"><img src="assets/4.png" alt="4"/></a></dt>
<dd><p>Inside the <code>data_source()</code> function, a random <code>int</code> is generated,
which is used both as a sleep duration and a data value.
Note that the <code>time.sleep()</code> call is blocking, so this function
must be executed in a thread.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO8-5" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO8-5"><img src="assets/5.png" alt="5"/></a></dt>
<dd><p>Place the data onto the Janus queue. This shows the other
<em>face</em> of the Janus queue: <code>sync_q</code>, which provides the standard,
blocking <code>Queue</code> API.</p></dd>
</dl></div>

<p>Here’s the output:</p>
<pre data-type="programlisting">
$ <strong>&lt;name&gt;</strong>
Got 2 off queue
Got 4 off queue
Got 4 off queue
Got 2 off queue
Got 3 off queue
Got 4 off queue
Got 1 off queue
Got 1 off queue
Got 0 off queue
Got 4 off queue
Done.
</pre>

<p>If you can, it’s better to aim for having short executor jobs, and
in these cases, a queue (for communication) won’t be necessary. This
isn’t always possible, though, and in such situations, the Janus
queue can be the most convenient solution to buffer and distribute
data between threads and coroutines.<a data-type="indexterm" data-primary="queues" data-secondary="Janus queue library" data-startref="ix_queJan" id="idm46363024067448"/><a data-type="indexterm" data-primary="asyncio libraries" data-secondary="Janus queue" data-startref="ix_asylibJq" id="idm46363024066360"/><a data-type="indexterm" data-primary="coroutines" data-secondary="communication with threads via Janus queue" data-startref="ix_corocomm" id="idm46363024065272"/><a data-type="indexterm" data-primary="threads" data-secondary="communication with coroutines via Janus queue" data-startref="ix_thrdcomm" id="idm46363024064184"/><a data-type="indexterm" data-primary="Janus queue" data-startref="ix_Janqu" id="idm46363024063096"/></p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="aiohttp"><div class="sect1" id="idm46363024062120">
<h1>aiohttp</h1>

<p><code>aiohttp</code> brings all things HTTP to <code>asyncio</code>, including support for
HTTP clients and servers, as well as WebSocket support.<a data-type="indexterm" data-primary="asyncio libraries" data-secondary="aiohttp" id="ix_asylibaioHT"/><a data-type="indexterm" data-primary="HTTP, aiohttp library" id="ix_HTTPaio"/><a data-type="indexterm" data-primary="aiohttp" id="ix_aioHT"/> Let’s jump
straight into code examples, starting with simplicity itself:
“Hello World.”</p>








<section data-type="sect2" class="less_space pagebreak-before" data-pdf-bookmark="Case Study: Hello World"><div class="sect2" id="idm46363024057304">
<h2>Case Study: Hello World</h2>

<p><a data-type="xref" href="#aiohttpminimal">Example 4-13</a> shows a minimal web server using <code>aiohttp</code>.</p>
<div id="aiohttpminimal" data-type="example">
<h5><span class="label">Example 4-13. </span>Minimal aiohttp example</h5>

<pre data-type="programlisting" data-code-language="python3"><code class="kn">from</code><code> </code><code class="nn">aiohttp</code><code> </code><code class="k">import</code><code> </code><code class="n">web</code><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">hello</code><code class="p">(</code><code class="n">request</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">web</code><code class="o">.</code><code class="n">Response</code><code class="p">(</code><code class="n">text</code><code class="o">=</code><code class="s2">"</code><code class="s2">Hello, world</code><code class="s2">"</code><code class="p">)</code><code>
</code><code>
</code><code class="n">app</code><code> </code><code class="o">=</code><code> </code><code class="n">web</code><code class="o">.</code><code class="n">Application</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO9-1" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO9-1"><img src="assets/1.png" alt="1"/></a><code>
</code><code class="n">app</code><code class="o">.</code><code class="n">router</code><code class="o">.</code><code class="n">add_get</code><code class="p">(</code><code class="s1">'</code><code class="s1">/</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">hello</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO9-2" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO9-2"><img src="assets/2.png" alt="2"/></a><code>
</code><code class="n">web</code><code class="o">.</code><code class="n">run_app</code><code class="p">(</code><code class="n">app</code><code class="p">,</code><code> </code><code class="n">port</code><code class="o">=</code><code class="mi">8080</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO9-3" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO9-3"><img src="assets/3.png" alt="3"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO9-1" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO9-1"><img src="assets/1.png" alt="1"/></a></dt>
<dd><p>An <code>Application</code> instance is created.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO9-2" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO9-2"><img src="assets/2.png" alt="2"/></a></dt>
<dd><p>A route is created, with the target coroutine <code>hello()</code> given as the
handler.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO9-3" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO9-3"><img src="assets/3.png" alt="3"/></a></dt>
<dd><p>The web application is run.</p></dd>
</dl></div>

<p>Observe that there is no mention of loops, tasks, or futures in this code: the
developers of the <code>aiohttp</code> framework have hidden all that away from us,
leaving a very clean API. This is going to be common in most frameworks
that build on top of <code>asyncio</code>, which has been designed to allow framework
designers to choose only the bits they need, and encapsulate them in
their preferred API.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Case Study: Scraping the News"><div class="sect2" id="scrapingthenews">
<h2>Case Study: Scraping the News</h2>

<p><code>aiohttp</code> can be used both as a server and a<a data-type="indexterm" data-primary="aiohttp" data-secondary="news scraper case study" id="ix_aioHTnscs"/><a data-type="indexterm" data-primary="news scraper case study (aiohttp)" id="ix_newscr"/> client library,
like the very popular (but blocking!)
<a href="https://oreil.ly/E2s9d"><code>requests</code></a> library. I wanted to
showcase <code>aiohttp</code> by using an example that incorporates both features.<a data-type="indexterm" data-primary="HTML" data-secondary="returned in news scraper case study" id="ix_HTMLnews"/></p>

<p>In this case study, we’ll implement a website that does web scraping behind
the scenes. The application will scrape two news websites and combine the
headlines into one page of results. Here is the strategy:</p>
<ol>
<li>
<p>A browser client makes a web request to <em>http://localhost:8080/news</em>.</p>
</li>
<li>
<p>Our web server receives the request, and then on the backend fetches
HTML data from multiple news websites.</p>
</li>
<li>
<p>Each page’s data is scraped for headlines.</p>
</li>
<li>
<p>The headlines are sorted and formatted into the response HTML that
we send back to the browser client.</p>
</li>

</ol>

<p><a data-type="xref" href="#scraper-image">Figure 4-1</a> shows the output.</p>

<figure><div id="scraper-image" class="figure">
<img src="assets/uaip_0401.png" alt="uaip 0401"/>
<h6><span class="label">Figure 4-1. </span>The final product of our news scraper: headlines from CNN are shown in one color, and Al Jazeera in another</h6>
</div></figure>

<p>Web scraping has become quite difficult nowadays. For example, if you try
<code>requests.get('http://edition.cnn.com')</code>, you’re going to find that the
response contains very little usable data! It has become increasingly
necessary to be able to execute JavaScript locally in order to obtain data,
because many sites use JavaScript to load their actual content.<a data-type="indexterm" data-primary="JavaScript, rendering" id="idm46363023936152"/> The process
of executing such JavaScript to produce the final, complete HTML output
is called <em>rendering</em>.<a data-type="indexterm" data-primary="rendering" id="idm46363023934920"/></p>

<p>To accomplish<a data-type="indexterm" data-primary="Splash (JavaScript rendering service)" id="idm46363023933704"/> rendering, we use a neat project called
<a href="https://oreil.ly/1IAie">Splash</a>, which describes
itself as a “JavaScript rendering service.” It can run in a
<a href="https://www.docker.com">Docker</a> container and provides an API for rendering
other sites. <a data-type="indexterm" data-primary="Docker containers" id="idm46363023931720"/>Internally, it uses a (JavaScript-capable)
WebKit engine to fully load and render a website. This is what
we’ll use to obtain website data.  Our <code>aiohttp</code> server, shown in
<a data-type="xref" href="#exscraper">Example 4-14</a>, will call this Splash API to obtain the page data.</p>
<div data-type="tip"><h6>Tip</h6>
<p>To obtain and run the <a data-type="indexterm" data-primary="Splash (JavaScript rendering service)" data-secondary="obtaining and running Splash container" id="idm46363023928952"/>Splash container, run these commands in your
shell:</p>
<pre data-type="programlisting">
$ <strong>docker pull scrapinghub/splash</strong>
$ <strong>docker run --rm -p 8050:8050 scrapinghub/splash</strong>
</pre>

<p>Our server backend will call the Splash API at <em>http://localhost:8050</em>.</p>
</div>
<div id="exscraper" data-type="example">
<h5><span class="label">Example 4-14. </span>Code for the news scraper</h5>

<pre data-type="programlisting" data-code-language="python3"><code class="kn">from</code><code> </code><code class="nn">asyncio</code><code> </code><code class="k">import</code><code> </code><code class="n">gather</code><code class="p">,</code><code> </code><code class="n">create_task</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">string</code><code> </code><code class="k">import</code><code> </code><code class="n">Template</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">aiohttp</code><code> </code><code class="k">import</code><code> </code><code class="n">web</code><code class="p">,</code><code> </code><code class="n">ClientSession</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">bs4</code><code> </code><code class="k">import</code><code> </code><code class="n">BeautifulSoup</code><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">news</code><code class="p">(</code><code class="n">request</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-1" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-1"><img src="assets/1.png" alt="1"/></a><code>
</code><code>    </code><code class="n">sites</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code>
</code><code>        </code><code class="p">(</code><code class="s1">'</code><code class="s1">http://edition.cnn.com</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">cnn_articles</code><code class="p">)</code><code class="p">,</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-2" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-2"><img src="assets/2.png" alt="2"/></a><code>
</code><code>        </code><code class="p">(</code><code class="s1">'</code><code class="s1">http://www.aljazeera.com</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">aljazeera_articles</code><code class="p">)</code><code class="p">,</code><code>
</code><code>    </code><code class="p">]</code><code>
</code><code>    </code><code class="n">tasks</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="n">create_task</code><code class="p">(</code><code class="n">news_fetch</code><code class="p">(</code><code class="o">*</code><code class="n">s</code><code class="p">)</code><code class="p">)</code><code> </code><code class="k">for</code><code> </code><code class="n">s</code><code> </code><code class="ow">in</code><code> </code><code class="n">sites</code><code class="p">]</code><code> </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-3" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-3"><img src="assets/3.png" alt="3"/></a><code>
</code><code>    </code><code class="k">await</code><code> </code><code class="n">gather</code><code class="p">(</code><code class="o">*</code><code class="n">tasks</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-4" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-4"><img src="assets/4.png" alt="4"/></a><code>
</code><code>
</code><code>    </code><code class="n">items</code><code> </code><code class="o">=</code><code> </code><code class="p">{</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-5" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-5"><img src="assets/5.png" alt="5"/></a><code>
</code><code>        </code><code class="n">text</code><code class="p">:</code><code> </code><code class="p">(</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-6" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-6"><img src="assets/6.png" alt="6"/></a><code>
</code><code>            </code><code class="n">f</code><code class="s1">'</code><code class="s1">&lt;div class=</code><code class="s1">"</code><code class="s1">box </code><code class="si">{kind}</code><code class="s1">"</code><code class="s1">&gt;</code><code class="s1">'</code><code>
</code><code>            </code><code class="n">f</code><code class="s1">'</code><code class="s1">&lt;span&gt;</code><code class="s1">'</code><code>
</code><code>            </code><code class="n">f</code><code class="s1">'</code><code class="s1">&lt;a href=</code><code class="s1">"</code><code class="si">{href}</code><code class="s1">"</code><code class="s1">&gt;</code><code class="si">{text}</code><code class="s1">&lt;/a&gt;</code><code class="s1">'</code><code>
</code><code>            </code><code class="n">f</code><code class="s1">'</code><code class="s1">&lt;/span&gt;</code><code class="s1">'</code><code>
</code><code>            </code><code class="n">f</code><code class="s1">'</code><code class="s1">&lt;/div&gt;</code><code class="s1">'</code><code>
</code><code>        </code><code class="p">)</code><code>
</code><code>        </code><code class="k">for</code><code> </code><code class="n">task</code><code> </code><code class="ow">in</code><code> </code><code class="n">tasks</code><code> </code><code class="k">for</code><code> </code><code class="n">href</code><code class="p">,</code><code> </code><code class="n">text</code><code class="p">,</code><code> </code><code class="n">kind</code><code> </code><code class="ow">in</code><code> </code><code class="n">task</code><code class="o">.</code><code class="n">result</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code>    </code><code class="n">content</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">'</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="n">items</code><code class="p">[</code><code class="n">x</code><code class="p">]</code><code> </code><code class="k">for</code><code> </code><code class="n">x</code><code> </code><code class="ow">in</code><code> </code><code class="nb">sorted</code><code class="p">(</code><code class="n">items</code><code class="p">)</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="n">page</code><code> </code><code class="o">=</code><code> </code><code class="n">Template</code><code class="p">(</code><code class="nb">open</code><code class="p">(</code><code class="s1">'</code><code class="s1">index.html</code><code class="s1">'</code><code class="p">)</code><code class="o">.</code><code class="n">read</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-7" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-7"><img src="assets/7.png" alt="7"/></a><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">web</code><code class="o">.</code><code class="n">Response</code><code class="p">(</code><code>
</code><code>        </code><code class="n">body</code><code class="o">=</code><code class="n">page</code><code class="o">.</code><code class="n">safe_substitute</code><code class="p">(</code><code class="n">body</code><code class="o">=</code><code class="n">content</code><code class="p">)</code><code class="p">,</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-8" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-8"><img src="assets/8.png" alt="8"/></a><code>
</code><code>        </code><code class="n">content_type</code><code class="o">=</code><code class="s1">'</code><code class="s1">text/html</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>    </code><code class="p">)</code><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">news_fetch</code><code class="p">(</code><code class="n">url</code><code class="p">,</code><code> </code><code class="n">postprocess</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">proxy_url</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code>
</code><code>        </code><code class="n">f</code><code class="s1">'</code><code class="s1">http://localhost:8050/render.html?</code><code class="s1">'</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-9" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-9"><img src="assets/9.png" alt="9"/></a><code>
</code><code>        </code><code class="n">f</code><code class="s1">'</code><code class="s1">url=</code><code class="si">{url}</code><code class="s1">&amp;timeout=60&amp;wait=1</code><code class="s1">'</code><code>
</code><code>    </code><code class="p">)</code><code>
</code><code>    </code><code class="k">async</code><code> </code><code class="k">with</code><code> </code><code class="n">ClientSession</code><code class="p">(</code><code class="p">)</code><code> </code><code class="k">as</code><code> </code><code class="n">session</code><code class="p">:</code><code>
</code><code>        </code><code class="k">async</code><code> </code><code class="k">with</code><code> </code><code class="n">session</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">proxy_url</code><code class="p">)</code><code> </code><code class="k">as</code><code> </code><code class="n">resp</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-10" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-10"><img src="assets/10.png" alt="10"/></a><code>
</code><code>            </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="n">resp</code><code class="o">.</code><code class="n">read</code><code class="p">(</code><code class="p">)</code><code>
</code><code>            </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code class="o">.</code><code class="n">decode</code><code class="p">(</code><code class="s1">'</code><code class="s1">utf-8</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">postprocess</code><code class="p">(</code><code class="n">url</code><code class="p">,</code><code> </code><code class="n">data</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-11" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-11"><img src="assets/11.png" alt="11"/></a><code>
</code><code>
</code><code class="k">def</code><code> </code><code class="nf">cnn_articles</code><code class="p">(</code><code class="n">url</code><code class="p">,</code><code> </code><code class="n">page_data</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-12" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-12"><img src="assets/12.png" alt="12"/></a><code>
</code><code>    </code><code class="n">soup</code><code> </code><code class="o">=</code><code> </code><code class="n">BeautifulSoup</code><code class="p">(</code><code class="n">page_data</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">lxml</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">match</code><code class="p">(</code><code class="n">tag</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="p">(</code><code>
</code><code>            </code><code class="n">tag</code><code class="o">.</code><code class="n">text</code><code> </code><code class="ow">and</code><code> </code><code class="n">tag</code><code class="o">.</code><code class="n">has_attr</code><code class="p">(</code><code class="s1">'</code><code class="s1">href</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>            </code><code class="ow">and</code><code> </code><code class="n">tag</code><code class="p">[</code><code class="s1">'</code><code class="s1">href</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">startswith</code><code class="p">(</code><code class="s1">'</code><code class="s1">/</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>            </code><code class="ow">and</code><code> </code><code class="n">tag</code><code class="p">[</code><code class="s1">'</code><code class="s1">href</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">endswith</code><code class="p">(</code><code class="s1">'</code><code class="s1">.html</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>            </code><code class="ow">and</code><code> </code><code class="n">tag</code><code class="o">.</code><code class="n">find</code><code class="p">(</code><code class="n">class_</code><code class="o">=</code><code class="s1">'</code><code class="s1">cd__headline-text</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>        </code><code class="p">)</code><code>
</code><code>    </code><code class="n">headlines</code><code> </code><code class="o">=</code><code> </code><code class="n">soup</code><code class="o">.</code><code class="n">find_all</code><code class="p">(</code><code class="n">match</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-13" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-13"><img src="assets/13.png" alt="13"/></a><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="p">[</code><code class="p">(</code><code class="n">url</code><code> </code><code class="o">+</code><code> </code><code class="n">hl</code><code class="p">[</code><code class="s1">'</code><code class="s1">href</code><code class="s1">'</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">hl</code><code class="o">.</code><code class="n">text</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">cnn</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>            </code><code class="k">for</code><code> </code><code class="n">hl</code><code> </code><code class="ow">in</code><code> </code><code class="n">headlines</code><code class="p">]</code><code>
</code><code>
</code><code class="k">def</code><code> </code><code class="nf">aljazeera_articles</code><code class="p">(</code><code class="n">url</code><code class="p">,</code><code> </code><code class="n">page_data</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-14" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-14"><img src="assets/14.png" alt="14"/></a><code>
</code><code>    </code><code class="n">soup</code><code> </code><code class="o">=</code><code> </code><code class="n">BeautifulSoup</code><code class="p">(</code><code class="n">page_data</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">lxml</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">match</code><code class="p">(</code><code class="n">tag</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="p">(</code><code>
</code><code>            </code><code class="n">tag</code><code class="o">.</code><code class="n">text</code><code> </code><code class="ow">and</code><code> </code><code class="n">tag</code><code class="o">.</code><code class="n">has_attr</code><code class="p">(</code><code class="s1">'</code><code class="s1">href</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>            </code><code class="ow">and</code><code> </code><code class="n">tag</code><code class="p">[</code><code class="s1">'</code><code class="s1">href</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">startswith</code><code class="p">(</code><code class="s1">'</code><code class="s1">/news</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>            </code><code class="ow">and</code><code> </code><code class="n">tag</code><code class="p">[</code><code class="s1">'</code><code class="s1">href</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">endswith</code><code class="p">(</code><code class="s1">'</code><code class="s1">.html</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>        </code><code class="p">)</code><code>
</code><code>    </code><code class="n">headlines</code><code> </code><code class="o">=</code><code> </code><code class="n">soup</code><code class="o">.</code><code class="n">find_all</code><code class="p">(</code><code class="n">match</code><code class="p">)</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="p">[</code><code class="p">(</code><code class="n">url</code><code> </code><code class="o">+</code><code> </code><code class="n">hl</code><code class="p">[</code><code class="s1">'</code><code class="s1">href</code><code class="s1">'</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">hl</code><code class="o">.</code><code> </code><code class="n">text</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">aljazeera</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>            </code><code class="k">for</code><code> </code><code class="n">hl</code><code> </code><code class="ow">in</code><code> </code><code class="n">headlines</code><code class="p">]</code><code>
</code><code>
</code><code class="n">app</code><code> </code><code class="o">=</code><code> </code><code class="n">web</code><code class="o">.</code><code class="n">Application</code><code class="p">(</code><code class="p">)</code><code>
</code><code class="n">app</code><code class="o">.</code><code class="n">router</code><code class="o">.</code><code class="n">add_get</code><code class="p">(</code><code class="s1">'</code><code class="s1">/news</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">news</code><code class="p">)</code><code>
</code><code class="n">web</code><code class="o">.</code><code class="n">run_app</code><code class="p">(</code><code class="n">app</code><code class="p">,</code><code> </code><code class="n">port</code><code class="o">=</code><code class="mi">8080</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-1" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-1"><img src="assets/1.png" alt="1"/></a></dt>
<dd><p>The <code>news()</code> function is the handler for the <em>/news</em> URL on our server.
It returns the HTML page showing all the headlines.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-2" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-2"><img src="assets/2.png" alt="2"/></a></dt>
<dd><p>Here, we have only two news websites to be scraped: CNN and Al Jazeera.
More could easily be added, but then additional postprocessors
would also have to be added, just like the <code>cnn_articles()</code> and
<code>aljazeera_articles()</code> functions that are customized to extract
headline data.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-3" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-3"><img src="assets/3.png" alt="3"/></a></dt>
<dd><p>For each news site, we create a task to fetch and process the HTML
page data for its front page.  Note that we unpack the tuple (<code>(*s)</code>)
since the <code>news_fetch()</code> coroutine function takes both the URL and the postprocessing
function as parameters.  Each <code>news_fetch()</code> call will return a <em>list of tuples</em>
as headline results, in the form <em><code>&lt;article URL&gt;</code></em>, <em><code>&lt;article title&gt;</code></em>.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-4" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-4"><img src="assets/4.png" alt="4"/></a></dt>
<dd><p>All the tasks are gathered together into a single <code>Future</code>
(<code>gather()</code> returns a future representing the state of all the tasks
being gathered), and
then we immediately <code>await</code> the completion of that future.
This line will suspend until the future completes.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-5" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-5"><img src="assets/5.png" alt="5"/></a></dt>
<dd><p>Since all the <code>news_fetch()</code> tasks are now complete, we collect all
of the results into a dictionary. Note how nested comprehensions are used
to iterate over tasks, and then over the list of tuples returned by
each task. We also use <em>f-strings</em> to substitute data directly, including
even the kind of page, which will be used in CSS to color the <code>div</code>
background.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-6" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-6"><img src="assets/6.png" alt="6"/></a></dt>
<dd><p>In this dictionary, the <em>key</em> is the headline title,
and the <em>value</em> is an HTML string for a <code>div</code> that will be displayed in our
result page.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-7" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-7"><img src="assets/7.png" alt="7"/></a></dt>
<dd><p>Our web server is going to return HTML. We’re loading HTML data from
a local file called <em>index.html</em>. This file is presented in
<a data-type="xref" href="app02.html#corobot">Example B-1</a> if you want to re-create the case study yourself.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-8" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-8"><img src="assets/8.png" alt="8"/></a></dt>
<dd><p>We substitute the collected headline <code>div</code> into the template and return
the page to the browser client. This generates the page shown
in <a data-type="xref" href="#scraper-image">Figure 4-1</a>.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-9" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-9"><img src="assets/9.png" alt="9"/></a></dt>
<dd><p>Here, inside the <code>news_fetch()</code> coroutine function, we have a tiny
template for hitting the Splash API (which, for me, is running in a
local Docker container on port 8050). This demonstrates how <code>aiohttp</code>
can be used as an HTTP client.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-10" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-10"><img src="assets/10.png" alt="10"/></a></dt>
<dd><p>The standard way is to create a <code>ClientSession()</code> instance, and
then use the <code>get()</code> method on the session instance to perform the REST
call. In the next line, the response data is obtained. Note that
because we’re always operating on coroutines, with <code>async with</code> and <code>await</code>,
this coroutine will never block: we’ll be able to handle many thousands of
these requests, even though this operation (<code>news_fetch()</code>) might be
relatively slow since we’re doing web calls internally.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-11" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-11"><img src="assets/11.png" alt="11"/></a></dt>
<dd><p>After the data is obtained, we call the postprocessing function.
For CNN, it’ll be <code>cnn_articles()</code>, and for Al Jazeera it’ll
be <code>aljazeera_articles()</code>.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-12" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-12"><img src="assets/12.png" alt="12"/></a></dt>
<dd><p>We have space only for a brief look at the postprocessing. After
getting the page data, we use the Beautiful Soup 4 library for extracting
headlines.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-13" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-13"><img src="assets/13.png" alt="13"/></a></dt>
<dd><p>The <code>match()</code> function will return all matching tags (I’ve manually
checked the HTML source of these news websites to figure out which
combination of filters extracts the best tags), and then we return a
list of tuples matching the format <em><code>&lt;article URL&gt;</code></em>, <em><code>&lt;article title&gt;</code></em>.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-14" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO10-14"><img src="assets/14.png" alt="14"/></a></dt>
<dd><p>This is the analogous postprocessor for Al Jazeera. The <code>match()</code>
condition is slightly different, but it is otherwise the same as the CNN one.</p></dd>
</dl></div>

<p class="pagebreak-before">Generally, you’ll find that <code>aiohttp</code> has a simple API and
“stays out of your way” while you develop your applications.</p>

<p>In the next section, we’ll look at using ZeroMQ with <code>asyncio</code>, which has
the curious effect of making socket programming quite enjoyable.<a data-type="indexterm" data-primary="HTML" data-secondary="returned in news scraper case study" data-startref="ix_HTMLnews" id="idm46363023604216"/><a data-type="indexterm" data-primary="news scraper case study (aiohttp)" data-startref="ix_newscr" id="idm46363023126888"/><a data-type="indexterm" data-primary="aiohttp" data-secondary="news scraper case study" data-startref="ix_aioHTnscs" id="idm46363023125928"/><a data-type="indexterm" data-primary="asyncio libraries" data-secondary="aiohttp" data-startref="ix_asylibaioHT" id="idm46363023124712"/><a data-type="indexterm" data-primary="HTTP, aiohttp library" data-startref="ix_HTTPaio" id="idm46363023769832"/><a data-type="indexterm" data-primary="aiohttp" data-startref="ix_aioHT" id="idm46363023768888"/><a data-type="indexterm" data-primary="ZeroMQ" id="ix_ZMQ"/><a data-type="indexterm" data-primary="0MQ" data-see="ZeroMQ" id="idm46363023767000"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="ØMQ (ZeroMQ)"><div class="sect1" id="idm46363023394296">
<h1>ØMQ (ZeroMQ)</h1>
<blockquote>
  <p>Programming is a science dressed up as art, because most of us don’t
understand the physics of software and it’s rarely, if ever, taught.
The physics of software is not algorithms, data structures, languages,
and abstractions. These are just tools we make, use, and throw away.
The real physics of software is the physics of people. Specifically,
it’s about our limitations when it comes to complexity and our desire
to work together to solve large problems in pieces. This is the
science of programming: make building blocks that people can
understand and use easily, and people will work together to solve the
very largest problems.</p>
<p data-type="attribution">Pieter Hintjens, <em>ZeroMQ: Messaging for Many Applications</em></p>
</blockquote>

<p>ØMQ (or <a href="http://zeromq.org">ZeroMQ</a>) is a popular
language-agnostic library for networking applications: it provides
“smart” sockets.<a data-type="indexterm" data-primary="asyncio libraries" data-secondary="ZeroMQ" id="ix_asylibZMQ"/><a data-type="indexterm" data-primary="sockets" data-secondary="smart sockets in ZeroMQ" id="idm46363023858824"/> When you create ØMQ sockets in code, they resemble
regular sockets, with recognizable method names like <code>recv()</code> and
<code>send()</code> and so on—but internally these sockets handle some of the
more annoying and tedious tasks required for working with conventional
sockets.<a data-type="indexterm" data-primary="Hintjens, Pieter" id="idm46363023310696"/></p>

<p>One of the features it provides is management of message passing, so you
don’t have to invent your own protocol and count bytes on the wire to
figure out when all the bytes for a particular message have arrived—you
simply send whatever you consider to be a “message,” and the whole thing
arrives on the other end intact.</p>

<p>Another great feature is automatic reconnection logic. If the server
goes down and comes back up later, the client ØMQ socket will
<em>automatically</em> reconnect. And even better, messages your code sends
into the socket will be buffered during the disconnected period, so
they will all still be sent out when the server returns.  These are
some of the reasons ØMQ is sometimes referred to as
<a href="https://oreil.ly/oQE4x"><em>brokerless</em> messaging</a>: it provides some of the features of message broker software
directly in the socket objects themselves.<a data-type="indexterm" data-primary="brokerless messaging" id="idm46363023307048"/></p>

<p>ØMQ sockets are already implemented as asynchronous internally (so
they can maintain many thousands of concurrent connections, even when
used in threaded code), but this is hidden from us behind the ØMQ
API. Nevertheless, support for Asyncio has been added to the
<a href="https://oreil.ly/N8w7J">PyZMQ</a> Python bindings for the ØMQ
library, and in this section we’re going to look at several examples
of how you might incorporate these smart sockets into your Python
applications.</p>








<section data-type="sect2" data-pdf-bookmark="Case Study: Multiple Sockets"><div class="sect2" id="idm46363023436328">
<h2>Case Study: Multiple Sockets</h2>

<p>Here’s a head-scratcher: if ØMQ provides sockets that are already
asynchronous, in a way that is usable with threading, what is the point
of using ØMQ with <code>asyncio</code>? The answer is cleaner code.<a data-type="indexterm" data-primary="ZeroMQ" data-secondary="multiple sockets case study" id="ix_ZMQmscs"/><a data-type="indexterm" data-primary="asyncio libraries" data-secondary="ZeroMQ" data-tertiary="multiple sockets case study" id="ix_asylibZMQmscs"/><a data-type="indexterm" data-primary="sockets" data-secondary="multiple sockets case study in ZeroMQ" id="ix_scktscs"/></p>

<p>To demonstrate, let’s look at a tiny case study in which you use
multiple ØMQ sockets in the same application. First, <a data-type="xref" href="#zmqtrad">Example 4-15</a>
shows the blocking version (this example is taken from the <a href="https://oreil.ly/qXAj8">zguide</a>,
the official guide for ØMQ).</p>
<div id="zmqtrad" data-type="example">
<h5><span class="label">Example 4-15. </span>The traditional ØMQ approach</h5>

<pre data-type="programlisting" data-code-language="python3"><code class="c1"># poller.py</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">zmq</code><code>
</code><code>
</code><code class="n">context</code><code> </code><code class="o">=</code><code> </code><code class="n">zmq</code><code class="o">.</code><code class="n">Context</code><code class="p">(</code><code class="p">)</code><code>
</code><code class="n">receiver</code><code> </code><code class="o">=</code><code> </code><code class="n">context</code><code class="o">.</code><code class="n">socket</code><code class="p">(</code><code class="n">zmq</code><code class="o">.</code><code class="n">PULL</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO11-1" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO11-1"><img src="assets/1.png" alt="1"/></a><code>
</code><code class="n">receiver</code><code class="o">.</code><code class="n">connect</code><code class="p">(</code><code class="s2">"</code><code class="s2">tcp://localhost:5557</code><code class="s2">"</code><code class="p">)</code><code>
</code><code>
</code><code class="n">subscriber</code><code> </code><code class="o">=</code><code> </code><code class="n">context</code><code class="o">.</code><code class="n">socket</code><code class="p">(</code><code class="n">zmq</code><code class="o">.</code><code class="n">SUB</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO11-2" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO11-2"><img src="assets/2.png" alt="2"/></a><code>
</code><code class="n">subscriber</code><code class="o">.</code><code class="n">connect</code><code class="p">(</code><code class="s2">"</code><code class="s2">tcp://localhost:5556</code><code class="s2">"</code><code class="p">)</code><code>
</code><code class="n">subscriber</code><code class="o">.</code><code class="n">setsockopt_string</code><code class="p">(</code><code class="n">zmq</code><code class="o">.</code><code class="n">SUBSCRIBE</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>
</code><code class="n">poller</code><code> </code><code class="o">=</code><code> </code><code class="n">zmq</code><code class="o">.</code><code class="n">Poller</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO11-3" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO11-3"><img src="assets/3.png" alt="3"/></a><code>
</code><code class="n">poller</code><code class="o">.</code><code class="n">register</code><code class="p">(</code><code class="n">receiver</code><code class="p">,</code><code> </code><code class="n">zmq</code><code class="o">.</code><code class="n">POLLIN</code><code class="p">)</code><code>
</code><code class="n">poller</code><code class="o">.</code><code class="n">register</code><code class="p">(</code><code class="n">subscriber</code><code class="p">,</code><code> </code><code class="n">zmq</code><code class="o">.</code><code class="n">POLLIN</code><code class="p">)</code><code>
</code><code>
</code><code class="k">while</code><code> </code><code class="kc">True</code><code class="p">:</code><code>
</code><code>    </code><code class="k">try</code><code class="p">:</code><code>
</code><code>        </code><code class="n">socks</code><code> </code><code class="o">=</code><code> </code><code class="nb">dict</code><code class="p">(</code><code class="n">poller</code><code class="o">.</code><code class="n">poll</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO11-4" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO11-4"><img src="assets/4.png" alt="4"/></a><code>
</code><code>    </code><code class="k">except</code><code> </code><code class="ne">KeyboardInterrupt</code><code class="p">:</code><code>
</code><code>        </code><code class="k">break</code><code>
</code><code>
</code><code>    </code><code class="k">if</code><code> </code><code class="n">receiver</code><code> </code><code class="ow">in</code><code> </code><code class="n">socks</code><code class="p">:</code><code>
</code><code>        </code><code class="n">message</code><code> </code><code class="o">=</code><code> </code><code class="n">receiver</code><code class="o">.</code><code class="n">recv_json</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="nb">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">Via PULL: </code><code class="si">{message}</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="k">if</code><code> </code><code class="n">subscriber</code><code> </code><code class="ow">in</code><code> </code><code class="n">socks</code><code class="p">:</code><code>
</code><code>        </code><code class="n">message</code><code> </code><code class="o">=</code><code> </code><code class="n">subscriber</code><code class="o">.</code><code class="n">recv_json</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="nb">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">Via SUB: </code><code class="si">{message}</code><code class="s1">'</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO11-1" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO11-1"><img src="assets/1.png" alt="1"/></a></dt>
<dd><p>ØMQ sockets have <em>types</em>. This is a <code>PULL</code> socket.<a data-type="indexterm" data-primary="PULL sockets" id="idm46363022882472"/> You can think
of it as a <em>receive-only</em> kind of socket that will be fed by some other
<em>send-only</em> socket, which will be a <code>PUSH</code> type.<a data-type="indexterm" data-primary="PUSH sockets" id="idm46363022880520"/></p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO11-2" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO11-2"><img src="assets/2.png" alt="2"/></a></dt>
<dd><p>The <code>SUB</code> socket is another kind of receive-only socket, and it
will be fed a <code>PUB</code> socket which is send-only.<a data-type="indexterm" data-primary="PUB sockets" id="idm46363022871992"/><a data-type="indexterm" data-primary="SUB sockets" id="idm46363022871288"/></p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO11-3" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO11-3"><img src="assets/3.png" alt="3"/></a></dt>
<dd><p>If you need to move data between multiple sockets in a threaded ØMQ application, you’re
going to need a <em>poller</em>. <a data-type="indexterm" data-primary="poller loop" id="idm46363022867720"/><a data-type="indexterm" data-primary="threading" data-secondary="moving data between multiple sockets in threaded ZMP application" id="idm46363022866984"/>This is because these sockets are not thread-safe,
so you cannot <code>recv()</code> on different sockets in different threads.<sup><a data-type="noteref" id="idm46363022865560-marker" href="ch04.html#idm46363022865560">1</a></sup></p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO11-4" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO11-4"><img src="assets/4.png" alt="4"/></a></dt>
<dd><p>It works similarly to the <code>select()</code> system call. The poller will
unblock when there is data ready to be received on one of the registered
sockets, and then it’s up to you to pull the data off and do something
with it. The big <code>if</code> block is how you detect the correct socket.</p></dd>
</dl></div>

<p>Using a poller loop plus an explicit socket-selection block makes
the code look a little clunky, but this approach avoids thread-safety problems by guaranteeing the same socket is not used from different threads.</p>

<p><a data-type="xref" href="#zmqsrv">Example 4-16</a> shows the server code.</p>
<div id="zmqsrv" data-type="example">
<h5><span class="label">Example 4-16. </span>Server code</h5>

<pre data-type="programlisting" data-code-language="python3"><code class="c1"># poller_srv.py</code>
<code class="kn">import</code> <code class="nn">zmq</code><code class="o">,</code> <code class="nn">itertools</code><code class="o">,</code> <code class="nn">time</code>

<code class="n">context</code> <code class="o">=</code> <code class="n">zmq</code><code class="o">.</code><code class="n">Context</code><code class="p">()</code>
<code class="n">pusher</code> <code class="o">=</code> <code class="n">context</code><code class="o">.</code><code class="n">socket</code><code class="p">(</code><code class="n">zmq</code><code class="o">.</code><code class="n">PUSH</code><code class="p">)</code>
<code class="n">pusher</code><code class="o">.</code><code class="n">bind</code><code class="p">(</code><code class="s2">"tcp://*:5557"</code><code class="p">)</code>

<code class="n">publisher</code> <code class="o">=</code> <code class="n">context</code><code class="o">.</code><code class="n">socket</code><code class="p">(</code><code class="n">zmq</code><code class="o">.</code><code class="n">PUB</code><code class="p">)</code>
<code class="n">publisher</code><code class="o">.</code><code class="n">bind</code><code class="p">(</code><code class="s2">"tcp://*:5556"</code><code class="p">)</code>

<code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="n">itertools</code><code class="o">.</code><code class="n">count</code><code class="p">():</code>
    <code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
    <code class="n">pusher</code><code class="o">.</code><code class="n">send_json</code><code class="p">(</code><code class="n">i</code><code class="p">)</code>
    <code class="n">publisher</code><code class="o">.</code><code class="n">send_json</code><code class="p">(</code><code class="n">i</code><code class="p">)</code></pre></div>

<p>This code is not important for the discussion, but briefly:
there’s a <code>PUSH</code> socket and a <code>PUB</code> socket, as I said earlier,
and a loop inside that sends data to both sockets every second. Here’s sample output from <em>poller.py</em> (note: <em>both</em> programs must be running):</p>
<pre data-type="programlisting">
$ <strong>poller.py</strong>
Via PULL: 0
Via SUB: 0
Via PULL: 1
Via SUB: 1
Via PULL: 2
Via SUB: 2
Via PULL: 3
Via SUB: 3
</pre>

<p>The code works; however, our interest here is not whether the code runs,
but rather whether <code>asyncio</code> has anything to offer for the structure of
<em>poller.py</em>. The key thing to understand is that our
<code>asyncio</code> code is going to run in a single thread, which means that
it’s fine to handle different sockets in different <em>coroutines</em>—and
indeed, this is exactly what we’ll do.<a data-type="indexterm" data-primary="coroutines" data-secondary="handling different in ZeroMQ sockets" id="idm46363022771976"/></p>

<p>Of course,
<a href="http://bit.ly/2sPCihI">someone
had to do the hard work</a>  to add support <a data-type="indexterm" data-primary="pyzmq library" id="idm46363022769928"/>for coroutines into <code>pyzmq</code>
(the Python client library for ØMQ) itself for this to work, so it
wasn’t free. But we can take advantage of that hard work to improve on
the “traditional” code structure, as shown in <a data-type="xref" href="#cleansep">Example 4-17</a>.</p>
<div id="cleansep" data-type="example">
<h5><span class="label">Example 4-17. </span>Clean separation with asyncio</h5>

<pre data-type="programlisting" data-code-language="python3"><code class="c1"># poller_aio.py</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">asyncio</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">zmq</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">zmq</code><code class="nn">.</code><code class="nn">asyncio</code><code> </code><code class="k">import</code><code> </code><code class="n">Context</code><code>
</code><code>
</code><code class="n">context</code><code> </code><code class="o">=</code><code> </code><code class="n">Context</code><code class="p">(</code><code class="p">)</code><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">do_receiver</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">receiver</code><code> </code><code class="o">=</code><code> </code><code class="n">context</code><code class="o">.</code><code class="n">socket</code><code class="p">(</code><code class="n">zmq</code><code class="o">.</code><code class="n">PULL</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO12-1" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO12-1"><img src="assets/1.png" alt="1"/></a><code>
</code><code>    </code><code class="n">receiver</code><code class="o">.</code><code class="n">connect</code><code class="p">(</code><code class="s2">"</code><code class="s2">tcp://localhost:5557</code><code class="s2">"</code><code class="p">)</code><code>
</code><code>    </code><code class="k">while</code><code> </code><code class="n">message</code><code> </code><code class="p">:</code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="n">receiver</code><code class="o">.</code><code class="n">recv_json</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO12-2" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO12-2"><img src="assets/2.png" alt="2"/></a><code>
</code><code>        </code><code class="nb">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">Via PULL: </code><code class="si">{message}</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">do_subscriber</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">subscriber</code><code> </code><code class="o">=</code><code> </code><code class="n">context</code><code class="o">.</code><code class="n">socket</code><code class="p">(</code><code class="n">zmq</code><code class="o">.</code><code class="n">SUB</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO12-3" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO12-3"><img src="assets/3.png" alt="3"/></a><code>
</code><code>    </code><code class="n">subscriber</code><code class="o">.</code><code class="n">connect</code><code class="p">(</code><code class="s2">"</code><code class="s2">tcp://localhost:5556</code><code class="s2">"</code><code class="p">)</code><code>
</code><code>    </code><code class="n">subscriber</code><code class="o">.</code><code class="n">setsockopt_string</code><code class="p">(</code><code class="n">zmq</code><code class="o">.</code><code class="n">SUBSCRIBE</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>    </code><code class="k">while</code><code> </code><code class="n">message</code><code> </code><code class="p">:</code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="n">subscriber</code><code class="o">.</code><code class="n">recv_json</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO12-4" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO12-4"><img src="assets/4.png" alt="4"/></a><code>
</code><code>        </code><code class="nb">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">Via SUB: </code><code class="si">{message}</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">main</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="k">await</code><code> </code><code class="n">asyncio</code><code class="o">.</code><code class="n">gather</code><code class="p">(</code><code>
</code><code>        </code><code class="n">do_receiver</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code>
</code><code>        </code><code class="n">do_subscriber</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code>
</code><code>    </code><code class="p">)</code><code>
</code><code>
</code><code class="n">asyncio</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="n">main</code><code class="p">(</code><code class="p">)</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO12-1" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO12-1"><img src="assets/1.png" alt="1"/></a></dt>
<dd><p>This code sample does the same as <a data-type="xref" href="#zmqtrad">Example 4-15</a>, except that now we’re taking advantage
of coroutines to restructure everything. Now we can deal with each
socket in isolation. I’ve created two coroutine functions, one for
each socket; this one is for the <code>PULL</code> socket.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO12-2" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO12-2"><img src="assets/2.png" alt="2"/></a></dt>
<dd><p>I’m using the <code>asyncio</code> support in <code>pyzmq</code>, which means that all
<code>send()</code> and <code>recv()</code> calls must use the <code>await</code> keyword. The <code>Poller</code> no
longer appears anywhere, because it’s been integrated into the <code>asyncio</code>
event loop itself.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO12-3" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO12-3"><img src="assets/3.png" alt="3"/></a></dt>
<dd><p>This is the handler for the <code>SUB</code> socket. The structure is very similar
to the <code>PULL</code> socket’s handler, but that need not have been the case. If
more complex logic had been required, I’d have been able to easily add
it here, fully encapsulated within the <code>SUB</code>-handler code only.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO12-4" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO12-4"><img src="assets/4.png" alt="4"/></a></dt>
<dd><p>Again, the <code>asyncio</code>-compatible sockets require the <code>await</code> keyword to
send and receive.<a data-type="indexterm" data-primary="await keyword" data-secondary="in asyncio-compatible sockets in ZMQ" id="idm46363022495368"/></p></dd>
</dl></div>

<p>The output is the same as before, so I won’t show it.</p>

<p>The use of coroutines has, in my opinion, a staggeringly positive effect
on the code layout in these examples. In real production code with
lots of ØMQ sockets, the coroutine handlers for each could
even be in separate files, providing more opportunities for better code
structure. And even for programs with a single read/write socket, it is
very easy to use separate coroutines for reading and writing, if necessary.</p>

<p>The improved code looks a lot like threaded code, and indeed, for the
specific example shown here, the same refactor will work for threading:
run blocking <code>do_receiver()</code> and <code>do_subscriber()</code> functions in
separate threads. But do you really want to deal with even the <em>potential</em>
for race conditions, especially as your application grows in features
and complexity over time?</p>

<p>There is lots to explore here, and as I said before, these magic
sockets are a lot of fun to play with. In the next case study, we’ll look
at a more practical use of ØMQ.<a data-type="indexterm" data-primary="ZeroMQ" data-secondary="multiple sockets case study" data-startref="ix_ZMQmscs" id="idm46363022490920"/><a data-type="indexterm" data-primary="asyncio libraries" data-secondary="ZeroMQ" data-tertiary="multiple sockets case study" data-startref="ix_asylibZMQmscs" id="idm46363022489832"/><a data-type="indexterm" data-primary="sockets" data-secondary="multiple sockets case study in ZeroMQ" data-startref="ix_scktscs" id="idm46363022488504"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Case Study: Application Performance Monitoring"><div class="sect2" id="appmon">
<h2>Case Study: Application Performance Monitoring</h2>

<p>With the modern, containerized, microservice-based deployment practices of
today, some things that used to <a data-type="indexterm" data-primary="asyncio libraries" data-secondary="ZeroMQ" data-tertiary="application performance monitoring case study" id="ix_asylibZMQAPM"/><a data-type="indexterm" data-primary="application performance monitoring (APM) case study (ZeroMQ)" id="ix_APMcs"/><a data-type="indexterm" data-primary="ZeroMQ" data-secondary="application performance monitoring case study" id="ix_ZMQAPMcs"/>be trivial, such as monitoring your apps’
CPU and memory usage, have become somewhat more complicated than just
running <code>top</code>. Several commercial products have emerged over the last few years to deal with these problems, but their cost can be prohibitive for small startup teams and hobbyists.</p>

<p>In this case study, I’ll exploit ØMQ and <code>asyncio</code> to build a
toy prototype for distributed application monitoring.  Our design has
three parts:</p>
<dl>
<dt>Application layer</dt>
<dd>
<p>This layer contains all our applications. Examples might be a “customers”
microservice, a “bookings” microservice, an “emailer” microservice, and so on.
I will add a ØMQ “transmitting” socket to each of our applications. This
socket will send performance metrics to a central server.</p>
</dd>
<dt>Collection layer</dt>
<dd>
<p>The central server will expose a ØMQ socket to collect the data from all the
running application instances. The server will also serve a web page to show
performance graphs over time and will live-stream the data as it
comes in.</p>
</dd>
<dt>Visualization layer</dt>
<dd>
<p>This is the web page being served. We’ll display the collected data in a set
of charts, and the charts will live-update in real time. To simplify the code
samples, I will use the convenient <a href="http://smoothiecharts.org">Smoothie Charts</a>
JavaScript library, which provides all the necessary client-side features.</p>
</dd>
</dl>

<p>The backend app (application layer) that produces metrics is shown
in <a data-type="xref" href="#applayer">Example 4-18</a>.</p>
<div id="applayer" data-type="example">
<h5><span class="label">Example 4-18. </span>The application layer: producing metrics</h5>

<pre data-type="programlisting" data-code-language="python3"><code class="kn">import</code><code> </code><code class="nn">argparse</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">asyncio</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">random</code><code> </code><code class="k">import</code><code> </code><code class="n">randint</code><code class="p">,</code><code> </code><code class="n">uniform</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">datetime</code><code> </code><code class="k">import</code><code> </code><code class="n">datetime</code><code> </code><code class="k">as</code><code> </code><code class="n">dt</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">datetime</code><code> </code><code class="k">import</code><code> </code><code class="n">timezone</code><code> </code><code class="k">as</code><code> </code><code class="n">tz</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">contextlib</code><code> </code><code class="k">import</code><code> </code><code class="n">suppress</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">zmq</code><code class="o">,</code><code> </code><code class="nn">zmq</code><code class="nn">.</code><code class="nn">asyncio</code><code class="o">,</code><code> </code><code class="nn">psutil</code><code>
</code><code>
</code><code class="n">ctx</code><code> </code><code class="o">=</code><code> </code><code class="n">zmq</code><code class="o">.</code><code class="n">asyncio</code><code class="o">.</code><code class="n">Context</code><code class="p">(</code><code class="p">)</code><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">stats_reporter</code><code class="p">(</code><code class="n">color</code><code class="p">:</code><code> </code><code class="nb">str</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-1" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-1"><img src="assets/1.png" alt="1"/></a><code>
</code><code>    </code><code class="n">p</code><code> </code><code class="o">=</code><code> </code><code class="n">psutil</code><code class="o">.</code><code class="n">Process</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="n">sock</code><code> </code><code class="o">=</code><code> </code><code class="n">ctx</code><code class="o">.</code><code class="n">socket</code><code class="p">(</code><code class="n">zmq</code><code class="o">.</code><code class="n">PUB</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-2" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-2"><img src="assets/2.png" alt="2"/></a><code>
</code><code>    </code><code class="n">sock</code><code class="o">.</code><code class="n">setsockopt</code><code class="p">(</code><code class="n">zmq</code><code class="o">.</code><code class="n">LINGER</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">)</code><code>
</code><code>    </code><code class="n">sock</code><code class="o">.</code><code class="n">connect</code><code class="p">(</code><code class="s1">'</code><code class="s1">tcp://localhost:5555</code><code class="s1">'</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-3" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-3"><img src="assets/3.png" alt="3"/></a><code>
</code><code>    </code><code class="k">with</code><code> </code><code class="n">suppress</code><code class="p">(</code><code class="n">asyncio</code><code class="o">.</code><code class="n">CancelledError</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-4" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-4"><img src="assets/4.png" alt="4"/></a><code>
</code><code>        </code><code class="k">while</code><code> </code><code class="kc">True</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-5" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-5"><img src="assets/5.png" alt="5"/></a><code>
</code><code>            </code><code class="k">await</code><code> </code><code class="n">sock</code><code class="o">.</code><code class="n">send_json</code><code class="p">(</code><code class="nb">dict</code><code class="p">(</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-6" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-6"><img src="assets/6.png" alt="6"/></a><code>
</code><code>                </code><code class="n">color</code><code class="o">=</code><code class="n">color</code><code class="p">,</code><code>
</code><code>                </code><code class="n">timestamp</code><code class="o">=</code><code class="n">dt</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="n">tz</code><code class="o">=</code><code class="n">tz</code><code class="o">.</code><code class="n">utc</code><code class="p">)</code><code class="o">.</code><code class="n">isoformat</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-7" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-7"><img src="assets/7.png" alt="7"/></a><code>
</code><code>                </code><code class="n">cpu</code><code class="o">=</code><code class="n">p</code><code class="o">.</code><code class="n">cpu_percent</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code>
</code><code>                </code><code class="n">mem</code><code class="o">=</code><code class="n">p</code><code class="o">.</code><code class="n">memory_full_info</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">rss</code><code> </code><code class="o">/</code><code> </code><code class="mi">1024</code><code> </code><code class="o">/</code><code> </code><code class="mi">1024</code><code>
</code><code>            </code><code class="p">)</code><code class="p">)</code><code>
</code><code>            </code><code class="k">await</code><code> </code><code class="n">asyncio</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code>
</code><code>    </code><code class="n">sock</code><code class="o">.</code><code class="n">close</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-8" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-8"><img src="assets/8.png" alt="8"/></a><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">main</code><code class="p">(</code><code class="n">args</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">asyncio</code><code class="o">.</code><code class="n">create_task</code><code class="p">(</code><code class="n">stats_reporter</code><code class="p">(</code><code class="n">args</code><code class="o">.</code><code class="n">color</code><code class="p">)</code><code class="p">)</code><code>
</code><code>    </code><code class="n">leak</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="p">]</code><code>
</code><code>    </code><code class="k">with</code><code> </code><code class="n">suppress</code><code class="p">(</code><code class="n">asyncio</code><code class="o">.</code><code class="n">CancelledError</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="k">while</code><code> </code><code class="kc">True</code><code class="p">:</code><code>
</code><code>            </code><code class="nb">sum</code><code class="p">(</code><code class="nb">range</code><code class="p">(</code><code class="n">randint</code><code class="p">(</code><code class="mi">1</code><code class="n">_000</code><code class="p">,</code><code> </code><code class="mi">10</code><code class="n">_000_000</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-9" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-9"><img src="assets/9.png" alt="9"/></a><code>
</code><code>            </code><code class="k">await</code><code> </code><code class="n">asyncio</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="n">uniform</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">)</code><code class="p">)</code><code>
</code><code>            </code><code class="n">leak</code><code> </code><code class="o">+</code><code class="o">=</code><code> </code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code> </code><code class="o">*</code><code> </code><code class="n">args</code><code class="o">.</code><code class="n">leak</code><code>
</code><code>
</code><code class="k">if</code><code> </code><code class="nv-Magic">__name__</code><code> </code><code class="o">==</code><code> </code><code class="s1">'</code><code class="s1">__main__</code><code class="s1">'</code><code class="p">:</code><code>
</code><code>    </code><code class="n">parser</code><code> </code><code class="o">=</code><code> </code><code class="n">argparse</code><code class="o">.</code><code class="n">ArgumentParser</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="n">parser</code><code class="o">.</code><code class="n">add_argument</code><code class="p">(</code><code class="s1">'</code><code class="s1">--color</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="nb">type</code><code class="o">=</code><code class="nb">str</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-10" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-10"><img src="assets/10.png" alt="10"/></a><code>
</code><code>    </code><code class="n">parser</code><code class="o">.</code><code class="n">add_argument</code><code class="p">(</code><code class="s1">'</code><code class="s1">--leak</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="nb">type</code><code class="o">=</code><code class="nb">int</code><code class="p">,</code><code> </code><code class="n">default</code><code class="o">=</code><code class="mi">0</code><code class="p">)</code><code>
</code><code>    </code><code class="n">args</code><code> </code><code class="o">=</code><code> </code><code class="n">parser</code><code class="o">.</code><code class="n">parse_args</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="k">try</code><code class="p">:</code><code>
</code><code>        </code><code class="n">asyncio</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="n">main</code><code class="p">(</code><code class="n">args</code><code class="p">)</code><code class="p">)</code><code>
</code><code>    </code><code class="k">except</code><code> </code><code class="ne">KeyboardInterrupt</code><code class="p">:</code><code>
</code><code>        </code><code class="nb">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">Leaving...</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>        </code><code class="n">ctx</code><code class="o">.</code><code class="n">term</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-11" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-11"><img src="assets/11.png" alt="11"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-1" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-1"><img src="assets/1.png" alt="1"/></a></dt>
<dd><p>This coroutine function will run as a long-lived coroutine, continually
sending out data to the server process.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-2" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-2"><img src="assets/2.png" alt="2"/></a></dt>
<dd><p>Create a ØMQ socket. As you know, there are different flavors of socket; this one is
a <code>PUB</code> type, which allows one-way messages to be sent to another
ØMQ socket. This socket has—as the ØMQ guide says—superpowers. It will
automatically handle all reconnection and buffering logic for us.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-3" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-3"><img src="assets/3.png" alt="3"/></a></dt>
<dd><p>Connect to the server.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-4" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-4"><img src="assets/4.png" alt="4"/></a></dt>
<dd><p>Our shutdown sequence is driven by <code>KeyboardInterrupt</code>, farther down.
When that signal is received, all the tasks will be cancelled.<a data-type="indexterm" data-primary="KeyboardInterrupt" data-secondary="in ZeroMQ application performance monitoring case study" id="idm46363022023784"/><a data-type="indexterm" data-primary="CancelledError exception" data-secondary="handling in ZeroMQ application performance monitoring study" id="idm46363022022840"/> Here I handle the
raised <code>CancelledError</code> with the handy <code>suppress()</code> context manager from
the <code>contextlib</code> standard library module.<a data-type="indexterm" data-primary="contextlib standard library" id="idm46363022065864"/><a data-type="indexterm" data-primary="suppress context manager" id="idm46363022065192"/></p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-5" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-5"><img src="assets/5.png" alt="5"/></a></dt>
<dd><p>Iterate forever, sending out data to the server.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-6" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-6"><img src="assets/6.png" alt="6"/></a></dt>
<dd><p>Since ØMQ knows how to work with complete messages, and not just chunks
off a bytestream, it opens the door to a bunch of useful wrappers around the
usual <code>sock.send()</code> idiom: here, I use one of those helper methods,
<code>send_json()</code>, which will automatically serialize the argument into JSON.
This allows us to use a <code>dict()</code> directly.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-7" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-7"><img src="assets/7.png" alt="7"/></a></dt>
<dd><p>A reliable way to transmit datetime information is via the ISO 8601
format. This is especially true if you have to pass datetime data between
software written in different languages, since the vast majority of language
implementations will be able to work with this standard.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-8" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-8"><img src="assets/8.png" alt="8"/></a></dt>
<dd><p>To end up here, we must have received the <code>CancelledError</code> exception
resulting from task cancellation. The ØMQ socket must be closed to allow
program <span class="keep-together">shutdown</span>.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-9" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-9"><img src="assets/9.png" alt="9"/></a></dt>
<dd><p>The <code>main()</code> function symbolizes the actual microservice application.
Fake work is produced with this sum over random numbers, just to give us
some nonzero data to view in the visualization layer a bit later.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-10" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-10"><img src="assets/10.png" alt="10"/></a></dt>
<dd><p>I’m going to create multiple instances of this application, so it
will be convenient to be able to distinguish between them (later, in the
graphs) with a <code>--color</code> parameter.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-11" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO13-11"><img src="assets/11.png" alt="11"/></a></dt>
<dd><p>Finally, the ØMQ context can be terminated.</p></dd>
</dl></div>

<p>The primary point of interest is the <code>stats_reporter()</code> function. This
is what streams out metrics data (collected by the useful <code>psutil</code>
library). The rest of the code can be assumed to be a typical microservice
application.<a data-type="indexterm" data-primary="microservices" data-secondary="in ZeroMQ application performance monitoring case study" id="idm46363021966712"/></p>

<p>The server code in <a data-type="xref" href="#metserver">Example 4-19</a> collects all the data and serves it to
a web client.</p>
<div id="metserver" data-type="example">
<h5><span class="label">Example 4-19. </span>The collection layer: this server collects process stats</h5>

<pre data-type="programlisting" data-code-language="python3"><code class="c1"># metric-server.py</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">asyncio</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">contextlib</code><code> </code><code class="k">import</code><code> </code><code class="n">suppress</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">zmq</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">zmq</code><code class="nn">.</code><code class="nn">asyncio</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">aiohttp</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">aiohttp</code><code> </code><code class="k">import</code><code> </code><code class="n">web</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">aiohttp_sse</code><code> </code><code class="k">import</code><code> </code><code class="n">sse_response</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">weakref</code><code> </code><code class="k">import</code><code> </code><code class="n">WeakSet</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">json</code><code>
</code><code>
</code><code class="c1"># zmq.asyncio.install()</code><code>
</code><code class="n">ctx</code><code> </code><code class="o">=</code><code> </code><code class="n">zmq</code><code class="o">.</code><code class="n">asyncio</code><code class="o">.</code><code class="n">Context</code><code class="p">(</code><code class="p">)</code><code>
</code><code class="n">connections</code><code> </code><code class="o">=</code><code> </code><code class="n">WeakSet</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-1" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-1"><img src="assets/1.png" alt="1"/></a><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">collector</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">sock</code><code> </code><code class="o">=</code><code> </code><code class="n">ctx</code><code class="o">.</code><code class="n">socket</code><code class="p">(</code><code class="n">zmq</code><code class="o">.</code><code class="n">SUB</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-2" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-2"><img src="assets/2.png" alt="2"/></a><code>
</code><code>    </code><code class="n">sock</code><code class="o">.</code><code class="n">setsockopt_string</code><code class="p">(</code><code class="n">zmq</code><code class="o">.</code><code class="n">SUBSCRIBE</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">'</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-3" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-3"><img src="assets/3.png" alt="3"/></a><code>
</code><code>    </code><code class="n">sock</code><code class="o">.</code><code class="n">bind</code><code class="p">(</code><code class="s1">'</code><code class="s1">tcp://*:5555</code><code class="s1">'</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-4" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-4"><img src="assets/4.png" alt="4"/></a><code>
</code><code>    </code><code class="k">with</code><code> </code><code class="n">suppress</code><code class="p">(</code><code class="n">asyncio</code><code class="o">.</code><code class="n">CancelledError</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="k">while</code><code> </code><code class="n">data</code><code> </code><code class="p">:</code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="n">sock</code><code class="o">.</code><code class="n">recv_json</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-5" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-5"><img src="assets/5.png" alt="5"/></a><code>
</code><code>            </code><code class="nb">print</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code>
</code><code>            </code><code class="k">for</code><code> </code><code class="n">q</code><code> </code><code class="ow">in</code><code> </code><code class="n">connections</code><code class="p">:</code><code>
</code><code>                </code><code class="k">await</code><code> </code><code class="n">q</code><code class="o">.</code><code class="n">put</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-6" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-6"><img src="assets/6.png" alt="6"/></a><code>
</code><code>    </code><code class="n">sock</code><code class="o">.</code><code class="n">close</code><code class="p">(</code><code class="p">)</code><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">feed</code><code class="p">(</code><code class="n">request</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-7" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-7"><img src="assets/7.png" alt="7"/></a><code>
</code><code>    </code><code class="n">queue</code><code> </code><code class="o">=</code><code> </code><code class="n">asyncio</code><code class="o">.</code><code class="n">Queue</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="n">connections</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="n">queue</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-8" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-8"><img src="assets/8.png" alt="8"/></a><code>
</code><code>    </code><code class="k">with</code><code> </code><code class="n">suppress</code><code class="p">(</code><code class="n">asyncio</code><code class="o">.</code><code class="n">CancelledError</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="k">async</code><code> </code><code class="k">with</code><code> </code><code class="n">sse_response</code><code class="p">(</code><code class="n">request</code><code class="p">)</code><code> </code><code class="k">as</code><code> </code><code class="n">resp</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-9" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-9"><img src="assets/9.png" alt="9"/></a><code>
</code><code>            </code><code class="k">while</code><code> </code><code class="n">data</code><code> </code><code class="p">:</code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="n">queue</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-10" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-10"><img src="assets/10.png" alt="10"/></a><code>
</code><code>                </code><code class="nb">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">sending data:</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">data</code><code class="p">)</code><code>
</code><code>                </code><code class="n">resp</code><code class="o">.</code><code class="n">send</code><code class="p">(</code><code class="n">json</code><code class="o">.</code><code class="n">dumps</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-11" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-11"><img src="assets/11.png" alt="11"/></a><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">resp</code><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">index</code><code class="p">(</code><code class="n">request</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-12" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-12"><img src="assets/12.png" alt="12"/></a><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">aiohttp</code><code class="o">.</code><code class="n">web</code><code class="o">.</code><code class="n">FileResponse</code><code class="p">(</code><code class="s1">'</code><code class="s1">./charts.html</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">start_collector</code><code class="p">(</code><code class="n">app</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-13" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-13"><img src="assets/13.png" alt="13"/></a><code>
</code><code>    </code><code class="n">app</code><code class="p">[</code><code class="s1">'</code><code class="s1">collector</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">app</code><code class="o">.</code><code class="n">loop</code><code class="o">.</code><code class="n">create_task</code><code class="p">(</code><code class="n">collector</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">stop_collector</code><code class="p">(</code><code class="n">app</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">Stopping collector...</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>    </code><code class="n">app</code><code class="p">[</code><code class="s1">'</code><code class="s1">collector</code><code class="s1">'</code><code class="p">]</code><code class="o">.</code><code class="n">cancel</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-14" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-14"><img src="assets/14.png" alt="14"/></a><code>
</code><code>    </code><code class="k">await</code><code> </code><code class="n">app</code><code class="p">[</code><code class="s1">'</code><code class="s1">collector</code><code class="s1">'</code><code class="p">]</code><code>
</code><code>    </code><code class="n">ctx</code><code class="o">.</code><code class="n">term</code><code class="p">(</code><code class="p">)</code><code>
</code><code>
</code><code class="k">if</code><code> </code><code class="nv-Magic">__name__</code><code> </code><code class="o">==</code><code> </code><code class="s1">'</code><code class="s1">__main__</code><code class="s1">'</code><code class="p">:</code><code>
</code><code>    </code><code class="n">app</code><code> </code><code class="o">=</code><code> </code><code class="n">web</code><code class="o">.</code><code class="n">Application</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="n">app</code><code class="o">.</code><code class="n">router</code><code class="o">.</code><code class="n">add_route</code><code class="p">(</code><code class="s1">'</code><code class="s1">GET</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">/</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">index</code><code class="p">)</code><code>
</code><code>    </code><code class="n">app</code><code class="o">.</code><code class="n">router</code><code class="o">.</code><code class="n">add_route</code><code class="p">(</code><code class="s1">'</code><code class="s1">GET</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">/feed</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">feed</code><code class="p">)</code><code>
</code><code>    </code><code class="n">app</code><code class="o">.</code><code class="n">on_startup</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">start_collector</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-15" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-15"><img src="assets/15.png" alt="15"/></a><code>
</code><code>    </code><code class="n">app</code><code class="o">.</code><code class="n">on_cleanup</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">stop_collector</code><code class="p">)</code><code>
</code><code>    </code><code class="n">web</code><code class="o">.</code><code class="n">run_app</code><code class="p">(</code><code class="n">app</code><code class="p">,</code><code> </code><code class="n">host</code><code class="o">=</code><code class="s1">'</code><code class="s1">127.0.0.1</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">port</code><code class="o">=</code><code class="mi">8088</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-1" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-1"><img src="assets/1.png" alt="1"/></a></dt>
<dd><p>One half of this program will receive data from other applications, and
the other half will provide data to browser clients via <em>server-sent events</em> (SSEs).
I use a <span class="keep-together"><code>WeakSet()</code></span> to keep track of all the currently connected web clients.
Each connected client will have an associated <code>Queue()</code> instance, so this
<code>connections</code> identifier is really a set of queues.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-2" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-2"><img src="assets/2.png" alt="2"/></a></dt>
<dd><p>Recall that in the application layer, I used a <code>zmq.PUB</code> socket; here
in the collection layer, I use its partner, the <code>zmq.SUB</code> socket type. This
ØMQ socket can only receive, not send.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-3" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-3"><img src="assets/3.png" alt="3"/></a></dt>
<dd><p>For the <code>zmq.SUB</code> socket type, providing a subscription
name is required, but for our purposes, we’ll just take everything that comes in—hence
the empty topic name.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-4" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-4"><img src="assets/4.png" alt="4"/></a></dt>
<dd><p>I <em>bind</em> the <code>zmq.SUB</code> socket. Think about that for second. In
pub-sub configurations, you usually have to make the <em>pub</em> end the server
(<code>bind()</code>) and the <em>sub</em> end the client (<code>connect()</code>). ØMQ is different:
either end can be the server. For our use case, this is important, because
each of our application-layer instances will be connecting to the same
collection server domain name, and not the other way around.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-5" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-5"><img src="assets/5.png" alt="5"/></a></dt>
<dd><p>The support for <code>asyncio</code> in <code>pyzmq</code> allows us to <code>await</code> data from
our connected apps. And not only that, but the incoming data will be
automatically deserialized from JSON (yes, this means <code>data</code> is a <code>dict()</code>).</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-6" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-6"><img src="assets/6.png" alt="6"/></a></dt>
<dd><p>Recall that our <code>connections</code> set holds a queue for every connected
web client. Now that data has been received, it’s time to send it to all
the clients: the data is placed onto each queue.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-7" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-7"><img src="assets/7.png" alt="7"/></a></dt>
<dd><p>The <code>feed()</code> coroutine function will create coroutines for each
connected web client. Internally, <a href="https://mzl.la/2omEs3t">server-sent events</a> are used to
push data to the web clients.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-8" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-8"><img src="assets/8.png" alt="8"/></a></dt>
<dd><p>As described earlier, each web client will have its own <code>queue</code> instance,
in order to receive data from the <code>collector()</code> coroutine. The <code>queue</code>
instance is added to the <code>connections</code> set, but because <code>connections</code> is
a <em>weak</em> set, the entry will automatically be removed from
<code>connections</code> when the <code>queue</code> goes out of scope—i.e., when a web client
disconnects. <a href="https://oreil.ly/fRmdu">Weakrefs</a> are great for simplifying these kinds of bookkeeping tasks.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-9" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-9"><img src="assets/9.png" alt="9"/></a></dt>
<dd><p>The <code>aiohttp_sse</code> package<a data-type="indexterm" data-primary="aiohttp_sse package" id="idm46363021395336"/> provides the <code>sse_response()</code> context
manager. This gives us a scope inside which to push data to the web client.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-10" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-10"><img src="assets/10.png" alt="10"/></a></dt>
<dd><p>We remain connected to the web client, and wait for data on this
specific client’s queue.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-11" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-11"><img src="assets/11.png" alt="11"/></a></dt>
<dd><p>As soon as the data comes in (inside <code>collector()</code>), it will be sent
to the connected web client. Note that I reserialize the <code>data</code> dict here.
An optimization to this code would be to avoid deserializing
JSON in <code>collector()</code>, and instead use <code>sock.recv_string()</code> to avoid
the serialization round trip. Of course, in a real scenario, you might want
to deserialize in the collector, and perform some validation on the
data before sending it to the browser client. So many choices!</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-12" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-12"><img src="assets/12.png" alt="12"/></a></dt>
<dd><p>The <code>index()</code> endpoint is the primary page load, and here we serve
a static file called <em>charts.html</em>.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-13" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-13"><img src="assets/13.png" alt="13"/></a></dt>
<dd><p>The <code>aiohttp</code> library provides facilities for us to hook in additional
long-lived coroutines we might need. With the <code>collector()</code> coroutine,
we have exactly that situation, so I create a startup coroutine,
<code>start_collector()</code>, and a shutdown coroutine. These will be called during
specific phases of <code>aiohttp</code>’s startup and shutdown sequence. Note that
I add the collector task to the <code>app</code> itself, which implements a mapping
protocol so that you can use it like a dict.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-14" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-14"><img src="assets/14.png" alt="14"/></a></dt>
<dd><p>I obtain our <code>collector()</code> coroutine off the
<code>app</code> identifier and call <code>cancel()</code> on that.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-15" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO14-15"><img src="assets/15.png" alt="15"/></a></dt>
<dd><p>Finally, you can see where the custom startup and shutdown coroutines
are hooked in: the <code>app</code> instance provides hooks to which our custom
coroutines may be appended.</p></dd>
</dl></div>

<p>All that remains is the visualization layer, shown in <a data-type="xref" href="#vislayer">Example 4-20</a>. I’m using the
<a href="http://smoothiecharts.org">Smoothie Charts library</a><a data-type="indexterm" data-primary="Smoothie Charts library" id="idm46363021373304"/> to generate scrolling
charts, and the complete HTML for our main (and only) web page,
<em>charts.html</em>, is provided in the <a data-type="xref" href="app02.html#corobot">Example B-1</a>. There is
too much HTML, CSS, and JavaScript to present in this section, but I do
want to highlight a few points about how the server-sent events are handled
in JavaScript in the browser client.</p>
<div id="vislayer" data-type="example">
<h5><span class="label">Example 4-20. </span>The visualization layer, which is a fancy way of saying “the browser”</h5>

<pre data-type="programlisting" data-code-language="javascript"><code class="o">&lt;</code><code class="nx">snip</code><code class="o">&gt;</code><code>
</code><code class="kd">var</code><code> </code><code class="nx">evtSource</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="nx">EventSource</code><code class="p">(</code><code class="s2">"/feed"</code><code class="p">)</code><code class="p">;</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO15-1" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO15-1"><img src="assets/1.png" alt="1"/></a><code>
</code><code class="nx">evtSource</code><code class="p">.</code><code class="nx">onmessage</code><code> </code><code class="o">=</code><code> </code><code class="kd">function</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code><code> </code><code class="p">{</code><code>
    </code><code class="kd">var</code><code> </code><code class="nx">obj</code><code> </code><code class="o">=</code><code> </code><code class="nx">JSON</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">e</code><code class="p">.</code><code class="nx">data</code><code class="p">)</code><code class="p">;</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO15-2" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO15-2"><img src="assets/2.png" alt="2"/></a><code>
    </code><code class="k">if</code><code> </code><code class="p">(</code><code class="o">!</code><code class="p">(</code><code class="nx">obj</code><code class="p">.</code><code class="nx">color</code><code> </code><code class="k">in</code><code> </code><code class="nx">cpu</code><code class="p">)</code><code class="p">)</code><code> </code><code class="p">{</code><code>
        </code><code class="nx">add_timeseries</code><code class="p">(</code><code class="nx">cpu</code><code class="p">,</code><code> </code><code class="nx">cpu_chart</code><code class="p">,</code><code> </code><code class="nx">obj</code><code class="p">.</code><code class="nx">color</code><code class="p">)</code><code class="p">;</code><code>
    </code><code class="p">}</code><code>
    </code><code class="k">if</code><code> </code><code class="p">(</code><code class="o">!</code><code class="p">(</code><code class="nx">obj</code><code class="p">.</code><code class="nx">color</code><code> </code><code class="k">in</code><code> </code><code class="nx">mem</code><code class="p">)</code><code class="p">)</code><code> </code><code class="p">{</code><code>
        </code><code class="nx">add_timeseries</code><code class="p">(</code><code class="nx">mem</code><code class="p">,</code><code> </code><code class="nx">mem_chart</code><code class="p">,</code><code> </code><code class="nx">obj</code><code class="p">.</code><code class="nx">color</code><code class="p">)</code><code class="p">;</code><code>
    </code><code class="p">}</code><code>
    </code><code class="nx">cpu</code><code class="p">[</code><code class="nx">obj</code><code class="p">.</code><code class="nx">color</code><code class="p">]</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code>
        </code><code class="nb">Date</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">obj</code><code class="p">.</code><code class="nx">timestamp</code><code class="p">)</code><code class="p">,</code><code> </code><code class="nx">obj</code><code class="p">.</code><code class="nx">cpu</code><code class="p">)</code><code class="p">;</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO15-3" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO15-3"><img src="assets/3.png" alt="3"/></a><code>
    </code><code class="nx">mem</code><code class="p">[</code><code class="nx">obj</code><code class="p">.</code><code class="nx">color</code><code class="p">]</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code>
        </code><code class="nb">Date</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">obj</code><code class="p">.</code><code class="nx">timestamp</code><code class="p">)</code><code class="p">,</code><code> </code><code class="nx">obj</code><code class="p">.</code><code class="nx">mem</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="p">}</code><code class="p">;</code><code>
</code><code class="o">&lt;</code><code class="nx">snip</code><code class="o">&gt;</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO15-1" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO15-1"><img src="assets/1.png" alt="1"/></a></dt>
<dd><p>Create a new <code>EventSource()</code> instance on the <em>/feed</em> URL.  The browser
will connect to <em>/feed</em> on our server,  (<em>metric_server.py</em>). Note that
the browser will automatically try to reconnect if the connection is lost.
Server-sent events are often overlooked, but in many situations their simplicity makes them preferable to WebSockets.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO15-2" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO15-2"><img src="assets/2.png" alt="2"/></a></dt>
<dd><p>The <code>onmessage</code> event will fire every time the server sends data. Here
the data is parsed as JSON.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO15-3" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO15-3"><img src="assets/3.png" alt="3"/></a></dt>
<dd><p>The <code>cpu</code> identifier is a mapping of a color to a
<code>TimeSeries()</code> instance (for more on this, see <a data-type="xref" href="app02.html#corobot">Example B-1</a>). Here, we obtain that time series and append data
to it. We also obtain the timestamp and parse it to get the correct
format required by the chart.</p></dd>
</dl></div>

<p>Now we can run the code. To get the whole show moving, a bunch of
command-line instructions are required, the first of which is to start up
the data collector process:</p>
<pre data-type="programlisting">
$ <strong>metric-server.py</strong>
======== Running on http://127.0.0.1:8088 ========
(Press CTRL+C to quit)
</pre>

<p>The next step is to start up all the
microservice instances.<a data-type="indexterm" data-primary="microservices" data-secondary="starting up in ZeroMQ application performance monitoring study" id="idm46363021063512"/> These will send their CPU and
memory usage metrics to the collector. Each will be identified by a different
color, which is specified on the command line. Note how two of the microservices
are told to leak some memory:</p>
<pre data-type="programlisting">
$ <strong>backend-app.py --color red &amp;</strong>
$ <strong>backend-app.py --color blue --leak 10000 &amp;</strong>
$ <strong>backend-app.py --color green --leak 100000 &amp;</strong>
</pre>

<p><a data-type="xref" href="#appmonshot">Figure 4-2</a> shows our final product in a browser. You’ll have to take my word
for it that the graphs really do animate. You’ll notice in the
preceding command lines that I added some memory leakage to blue, and a lot to
green.  I even had to restart the green service a few times to
prevent it from climbing over 100 MB.</p>

<figure class="width-90"><div id="appmonshot" class="figure">
<img src="assets/uaip_0402.png" alt="uaip 0402"/>
<h6><span class="label">Figure 4-2. </span>We’d better get an SRE on green ASAP!</h6>
</div></figure>

<p>What is especially interesting about this project is this: <em>any</em> of
the running instances in any part of this stack can be restarted, and
no reconnect-handling code is necessary. The ØMQ sockets, along
with the <code>EventSource()</code> JavaScript instance in the browser, magically reconnect
and pick up where they left off.</p>

<p>In the next section, we turn our attention to databases and to how <code>asyncio</code>
might be used to design a system for cache invalidation.<a data-type="indexterm" data-primary="asyncio libraries" data-secondary="ZeroMQ" data-tertiary="application performance monitoring case study" data-startref="ix_asylibZMQAPM" id="idm46363021193016"/><a data-type="indexterm" data-primary="application performance monitoring (APM) case study (ZeroMQ)" data-startref="ix_APMcs" id="idm46363021191528"/><a data-type="indexterm" data-primary="ZeroMQ" data-secondary="application performance monitoring case study" data-startref="ix_ZMQAPMcs" id="idm46363021190616"/><a data-type="indexterm" data-primary="asyncio libraries" data-secondary="ZeroMQ" data-startref="ix_asylibZMQ" id="idm46363021189432"/><a data-type="indexterm" data-primary="ZeroMQ" data-startref="ix_ZMQ" id="idm46363021188216"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="asyncpg and Sanic"><div class="sect1" id="idm46363022486824">
<h1>asyncpg and Sanic</h1>

<p>The <a href="https://oreil.ly/yGdNh"><code>asyncpg</code> library</a> provides client
access to the PostgreSQL database, but differentiates itself<a data-type="indexterm" data-primary="asyncpg and Sanic" id="ix_asypgSan"/> from other
<code>asyncio</code>-compatible Postgres client <span class="keep-together">libraries with</span> its emphasis on speed.
<code>asyncpg</code> is authored by <a href="https://twitter.com/1st1">Yury Selivanov</a>, one of the
core <code>asyncio</code> Python developers, who is also the author of the uvloop project.<a data-type="indexterm" data-primary="Selivanov, Yury" id="idm46363021219432"/><a data-type="indexterm" data-primary="PostgreSQL database, access to with asyncpg" id="idm46363021218728"/>
It has no third-party dependencies, although
<a href="http://cython.org">Cython</a> is required if you’re installing from source.<a data-type="indexterm" data-primary="Cython" id="idm46363021217304"/></p>

<p><code>asyncpg</code> achieves its speed by working directly against the
PostgreSQL binary protocol, and other advantages to this low-level approach
include support for
<a href="http://bit.ly/2sMNlIz">prepared statements</a>
and <a href="http://bit.ly/2Chr0H5">scrollable cursors</a>.</p>

<p>We’ll be looking at a case study using <code>asyncpg</code> for cache
invalidation, but before that it will be useful to get a basic understanding
of the API <code>asyncpg</code> provides. For all of the code in this section, we’ll
need a running instance of PostgreSQL. This is most easily done
with Docker, using the following command:</p>
<pre data-type="programlisting">
$ <strong>docker run -d --rm -p 55432:5432 postgres</strong>
</pre>

<p>Note that I’ve exposed port 55432 rather than the default, 5432, just in
case you already have a running instance of the database on the default
port. <a data-type="xref" href="#asyncpgdemo">Example 4-21</a> briefly demonstrates how to use <code>asyncpg</code>
to talk to PostgreSQL.</p>
<div id="asyncpgdemo" data-type="example">
<h5><span class="label">Example 4-21. </span>Basic demo of asyncpg</h5>

<pre data-type="programlisting" data-code-language="python3"><code class="c1"># asyncpg-basic.py</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">asyncio</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">asyncpg</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">datetime</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">util</code><code> </code><code class="k">import</code><code> </code><code class="n">Database</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO16-1" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO16-1"><img src="assets/1.png" alt="1"/></a><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">main</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="k">async</code><code> </code><code class="k">with</code><code> </code><code class="n">Database</code><code class="p">(</code><code class="s1">'</code><code class="s1">test</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">owner</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code><code> </code><code class="k">as</code><code> </code><code class="n">conn</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO16-2" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO16-2"><img src="assets/2.png" alt="2"/></a><code>
</code><code>        </code><code class="k">await</code><code> </code><code class="n">demo</code><code class="p">(</code><code class="n">conn</code><code class="p">)</code><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">demo</code><code class="p">(</code><code class="n">conn</code><code class="p">:</code><code> </code><code class="n">asyncpg</code><code class="o">.</code><code class="n">Connection</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="k">await</code><code> </code><code class="n">conn</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s1">'''</code><code class="s1">
</code><code class="s1">        CREATE TABLE users(</code><code class="s1">
</code><code class="s1">            id serial PRIMARY KEY,</code><code class="s1">
</code><code class="s1">            name text,</code><code class="s1">
</code><code class="s1">            dob date</code><code class="s1">
</code><code class="s1">        )</code><code class="s1">'''</code><code>
</code><code>    </code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO16-3" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO16-3"><img src="assets/3.png" alt="3"/></a><code>
</code><code>
</code><code>    </code><code class="n">pk</code><code> </code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="n">conn</code><code class="o">.</code><code class="n">fetchval</code><code class="p">(</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO16-4" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO16-4"><img src="assets/4.png" alt="4"/></a><code>
</code><code>        </code><code class="s1">'</code><code class="s1">INSERT INTO users(name, dob) VALUES($1, $2) </code><code class="s1">'</code><code>
</code><code>        </code><code class="s1">'</code><code class="s1">RETURNING id</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">Bob</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">datetime</code><code class="o">.</code><code class="n">date</code><code class="p">(</code><code class="mi">1984</code><code class="p">,</code><code> </code><code class="mi">3</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">)</code><code>
</code><code>    </code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">get_row</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO16-5" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO16-5"><img src="assets/5.png" alt="5"/></a><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="k">await</code><code> </code><code class="n">conn</code><code class="o">.</code><code class="n">fetchrow</code><code class="p">(</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO16-6" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO16-6"><img src="assets/6.png" alt="6"/></a><code>
</code><code>            </code><code class="s1">'</code><code class="s1">SELECT * FROM users WHERE name = $1</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>            </code><code class="s1">'</code><code class="s1">Bob</code><code class="s1">'</code><code>
</code><code>        </code><code class="p">)</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">After INSERT:</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="k">await</code><code> </code><code class="n">get_row</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO16-7" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO16-7"><img src="assets/7.png" alt="7"/></a><code>
</code><code>
</code><code>    </code><code class="k">await</code><code> </code><code class="n">conn</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code>
</code><code>        </code><code class="s1">'</code><code class="s1">UPDATE users SET dob = $1 WHERE id=1</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>        </code><code class="n">datetime</code><code class="o">.</code><code class="n">date</code><code class="p">(</code><code class="mi">1985</code><code class="p">,</code><code> </code><code class="mi">3</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO16-8" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO16-8"><img src="assets/8.png" alt="8"/></a><code>
</code><code>    </code><code class="p">)</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">After UPDATE:</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="k">await</code><code> </code><code class="n">get_row</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="k">await</code><code> </code><code class="n">conn</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code>
</code><code>        </code><code class="s1">'</code><code class="s1">DELETE FROM users WHERE id=1</code><code class="s1">'</code><code>
</code><code>    </code><code class="p">)</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">After DELETE:</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="k">await</code><code> </code><code class="n">get_row</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>
</code><code>
</code><code class="k">if</code><code> </code><code class="nv-Magic">__name__</code><code> </code><code class="o">==</code><code> </code><code class="s1">'</code><code class="s1">__main__</code><code class="s1">'</code><code class="p">:</code><code>
</code><code>    </code><code class="n">asyncio</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="n">main</code><code class="p">(</code><code class="p">)</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO16-1" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO16-1"><img src="assets/1.png" alt="1"/></a></dt>
<dd><p>I’ve hidden some boilerplate away in a tiny <code>util</code> module to
simplify things and keep the core message.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO16-2" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO16-2"><img src="assets/2.png" alt="2"/></a></dt>
<dd><p>The <code>Database</code> class gives us a context manager that will create a
new database for us—in this, case named <code>test</code>—and will destroy that
database when the context manager exits.  This turns out to be very
useful when experimenting with ideas in code. Because no state is carried
over between experiments, you start from a clean database every time.
Note that this is an <code>async with</code> context manager; we’ll talk more about
that later, but for now, the focal area of this demo is what happens
inside the <code>demo()</code> coroutine.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO16-3" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO16-3"><img src="assets/3.png" alt="3"/></a></dt>
<dd><p>The <code>Database</code> context manager has provided us with a <code>Connection</code>
instance, which is immediately used to create a new table, <code>users</code>.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO16-4" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO16-4"><img src="assets/4.png" alt="4"/></a></dt>
<dd><p>I use <code>fetchval()</code> to insert a new record. While I could have used <code>execute()</code>
to do the insertion, the benefit of using <code>fetchval()</code>
is that I can obtain the <code>id</code> of the newly inserted record, which
I store in the <code>pk</code> identifier.<br/></p>

<p>Note that I use <em>parameters</em> (<code>$1</code> and <code>$2</code>) for passing data to the SQL
query. <em>Never</em> use string interpolation or concatenation to build queries,
as this is a security risk!</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO16-5" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO16-5"><img src="assets/5.png" alt="5"/></a></dt>
<dd><p>In the remainder of this demo, I’m going to be manipulating data in
the <code>users</code> table, so here I make a new utility coroutine function that fetches
a record in the table. This will be called several times.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO16-6" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO16-6"><img src="assets/6.png" alt="6"/></a></dt>
<dd><p>When <em>retrieving</em> data, it is far more useful to use the <code>fetch</code>-based
methods, because these will return <code>Record</code> objects. <code>asyncpg</code> will
automatically cast datatypes to the most appropriate types for Python.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO16-7" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO16-7"><img src="assets/7.png" alt="7"/></a></dt>
<dd><p>I immediately use the <code>get_row()</code> helper to display the newly inserted
record.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO16-8" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO16-8"><img src="assets/8.png" alt="8"/></a></dt>
<dd><p>I modify data by using the <code>UPDATE</code> command for SQL. It’s a tiny
modification: the year value in the date of birth is changed by one year.  As
before, this is performed with the connection’s <code>execute()</code> method. The
remainder of the code demo follows the same structure as seen so far, and
a <code>DELETE</code>, followed by another <code>print()</code>, happens a few lines down.</p></dd>
</dl></div>

<p>Here’s the output of running this script:</p>
<pre data-type="programlisting">
$ <strong>asyncpg-basic.py</strong>
After INSERT: &lt;Record id=1 name='Bob' dob=datetime.date(1984, 3, 1)&gt;
After UPDATE: &lt;Record id=1 name='Bob' dob=datetime.date(1985, 3, 1)&gt;
After DELETE: None
</pre>

<p>Note how the date value retrieved in our <code>Record</code>
object has been converted to a Python <code>date</code> object: <code>asyncpg</code> has
automatically converted the datatype from the SQL type to its Python
counterpart. A large table of
<a href="http://bit.ly/2sQszaQ">type
conversions</a> in the <code>asyncpg</code> documentation describes
all the type mappings that are built into the library.</p>

<p>The preceding code is very simple, perhaps even crudely so if you’re used to
the convenience of object-relational mappers (ORMs) like SQLAlchemy or the
Django web framework’s built-in ORM. At the end of this chapter, I mention
several third-party libraries that provide access to ORMs or ORM-like
features for <code>asyncpg</code>.</p>

<p><a data-type="xref" href="#dbobject">Example 4-22</a> shows my boilerplate <code>Database</code> object in the <code>utils</code>
module; you may find it useful to make something similar for your own
experiments.</p>
<div id="dbobject" data-type="example">
<h5><span class="label">Example 4-22. </span>Useful tooling for your asyncpg experiments</h5>

<pre data-type="programlisting" data-code-language="python3"><code class="c1"># util.py</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">argparse</code><code class="o">,</code><code> </code><code class="nn">asyncio</code><code class="o">,</code><code> </code><code class="nn">asyncpg</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">asyncpg</code><code class="nn">.</code><code class="nn">pool</code><code> </code><code class="k">import</code><code> </code><code class="n">Pool</code><code>
</code><code>
</code><code class="n">DSN</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">postgresql://</code><code class="si">{user}</code><code class="s1">@</code><code class="si">{host}</code><code class="s1">:</code><code class="si">{port}</code><code class="s1">'</code><code>
</code><code class="n">DSN_DB</code><code> </code><code class="o">=</code><code> </code><code class="n">DSN</code><code> </code><code class="o">+</code><code> </code><code class="s1">'</code><code class="s1">/</code><code class="si">{name}</code><code class="s1">'</code><code>
</code><code class="n">CREATE_DB</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">CREATE DATABASE </code><code class="si">{name}</code><code class="s1">'</code><code>
</code><code class="n">DROP_DB</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">DROP DATABASE </code><code class="si">{name}</code><code class="s1">'</code><code>
</code><code>
</code><code class="k">class</code><code> </code><code class="nc">Database</code><code class="p">:</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">name</code><code class="p">,</code><code> </code><code class="n">owner</code><code class="o">=</code><code class="kc">False</code><code class="p">,</code><code> </code><code class="o">*</code><code class="o">*</code><code class="n">kwargs</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">params</code><code> </code><code class="o">=</code><code> </code><code class="nb">dict</code><code class="p">(</code><code>
</code><code>            </code><code class="n">user</code><code class="o">=</code><code class="s1">'</code><code class="s1">postgres</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">host</code><code class="o">=</code><code class="s1">'</code><code class="s1">localhost</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>            </code><code class="n">port</code><code class="o">=</code><code class="mi">55432</code><code class="p">,</code><code> </code><code class="n">name</code><code class="o">=</code><code class="n">name</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO17-1" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO17-1"><img src="assets/1.png" alt="1"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">params</code><code class="o">.</code><code class="n">update</code><code class="p">(</code><code class="n">kwargs</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">pool</code><code class="p">:</code><code> </code><code class="n">Pool</code><code> </code><code class="o">=</code><code> </code><code class="kc">None</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">owner</code><code> </code><code class="o">=</code><code> </code><code class="n">owner</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">listeners</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="p">]</code><code>
</code><code>
</code><code>    </code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">connect</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="n">Pool</code><code class="p">:</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">owner</code><code class="p">:</code><code>
</code><code>            </code><code class="k">await</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">server_command</code><code class="p">(</code><code>
</code><code>                </code><code class="n">CREATE_DB</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="o">*</code><code class="o">*</code><code class="bp">self</code><code class="o">.</code><code class="n">params</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO17-2" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO17-3"><img src="assets/3.png" alt="3"/></a><code>
</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">pool</code><code> </code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="n">asyncpg</code><code class="o">.</code><code class="n">create_pool</code><code class="p">(</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO17-3" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO17-4"><img src="assets/4.png" alt="4"/></a><code>
</code><code>            </code><code class="n">DSN_DB</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="o">*</code><code class="o">*</code><code class="bp">self</code><code class="o">.</code><code class="n">params</code><code class="p">)</code><code class="p">)</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">pool</code><code>
</code><code>
</code><code>    </code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">disconnect</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="sd">"""Destroy the database"""</code><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">pool</code><code class="p">:</code><code>
</code><code>            </code><code class="n">releases</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="bp">self</code><code class="o">.</code><code class="n">pool</code><code class="o">.</code><code class="n">release</code><code class="p">(</code><code class="n">conn</code><code class="p">)</code><code>
</code><code>                        </code><code class="k">for</code><code> </code><code class="n">conn</code><code> </code><code class="ow">in</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">listeners</code><code class="p">]</code><code>
</code><code>            </code><code class="k">await</code><code> </code><code class="n">asyncio</code><code class="o">.</code><code class="n">gather</code><code class="p">(</code><code class="o">*</code><code class="n">releases</code><code class="p">)</code><code>
</code><code>            </code><code class="k">await</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">pool</code><code class="o">.</code><code class="n">close</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO17-4" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO17-5"><img src="assets/5.png" alt="5"/></a><code>
</code><code>        </code><code class="k">if</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">owner</code><code class="p">:</code><code>
</code><code>            </code><code class="k">await</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">server_command</code><code class="p">(</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO17-5" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO17-6"><img src="assets/6.png" alt="6"/></a><code>
</code><code>                </code><code class="n">DROP_DB</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="o">*</code><code class="o">*</code><code class="bp">self</code><code class="o">.</code><code class="n">params</code><code class="p">)</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">__aenter__</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="n">Pool</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO17-6" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO17-2"><img src="assets/2.png" alt="2"/></a><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="k">await</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">connect</code><code class="p">(</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">__aexit__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="o">*</code><code class="n">exc</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="k">await</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">disconnect</code><code class="p">(</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">server_command</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">cmd</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO17-7" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO17-7"><img src="assets/7.png" alt="7"/></a><code>
</code><code>        </code><code class="n">conn</code><code> </code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="n">asyncpg</code><code class="o">.</code><code class="n">connect</code><code class="p">(</code><code>
</code><code>            </code><code class="n">DSN</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="o">*</code><code class="o">*</code><code class="bp">self</code><code class="o">.</code><code class="n">params</code><code class="p">)</code><code class="p">)</code><code>
</code><code>        </code><code class="k">await</code><code> </code><code class="n">conn</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">cmd</code><code class="p">)</code><code>
</code><code>        </code><code class="k">await</code><code> </code><code class="n">conn</code><code class="o">.</code><code class="n">close</code><code class="p">(</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">add_listener</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">channel</code><code class="p">,</code><code> </code><code class="n">callback</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO17-8" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO17-8"><img src="assets/8.png" alt="8"/></a><code>
</code><code>        </code><code class="n">conn</code><code class="p">:</code><code> </code><code class="n">asyncpg</code><code class="o">.</code><code class="n">Connection</code><code> </code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">pool</code><code class="o">.</code><code class="n">acquire</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="k">await</code><code> </code><code class="n">conn</code><code class="o">.</code><code class="n">add_listener</code><code class="p">(</code><code class="n">channel</code><code class="p">,</code><code> </code><code class="n">callback</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">listeners</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">conn</code><code class="p">)</code><code>
</code><code>
</code><code class="k">if</code><code> </code><code class="nv-Magic">__name__</code><code> </code><code class="o">==</code><code> </code><code class="s1">'</code><code class="s1">__main__</code><code class="s1">'</code><code class="p">:</code><code>
</code><code>    </code><code class="n">parser</code><code> </code><code class="o">=</code><code> </code><code class="n">argparse</code><code class="o">.</code><code class="n">ArgumentParser</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="n">parser</code><code class="o">.</code><code class="n">add_argument</code><code class="p">(</code><code class="s1">'</code><code class="s1">--cmd</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">choices</code><code class="o">=</code><code class="p">[</code><code class="s1">'</code><code class="s1">create</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">drop</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>
</code><code>    </code><code class="n">parser</code><code class="o">.</code><code class="n">add_argument</code><code class="p">(</code><code class="s1">'</code><code class="s1">--name</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="nb">type</code><code class="o">=</code><code class="nb">str</code><code class="p">)</code><code>
</code><code>    </code><code class="n">args</code><code> </code><code class="o">=</code><code> </code><code class="n">parser</code><code class="o">.</code><code class="n">parse_args</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="n">d</code><code> </code><code class="o">=</code><code> </code><code class="n">Database</code><code class="p">(</code><code class="n">args</code><code class="o">.</code><code class="n">name</code><code class="p">,</code><code> </code><code class="n">owner</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code><code>
</code><code>    </code><code class="k">if</code><code> </code><code class="n">args</code><code class="o">.</code><code class="n">cmd</code><code> </code><code class="o">==</code><code> </code><code class="s1">'</code><code class="s1">create</code><code class="s1">'</code><code class="p">:</code><code>
</code><code>        </code><code class="n">asyncio</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="n">d</code><code class="o">.</code><code class="n">connect</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>
</code><code>    </code><code class="k">elif</code><code> </code><code class="n">args</code><code class="o">.</code><code class="n">cmd</code><code> </code><code class="o">==</code><code> </code><code class="s1">'</code><code class="s1">drop</code><code class="s1">'</code><code class="p">:</code><code>
</code><code>        </code><code class="n">asyncio</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="n">d</code><code class="o">.</code><code class="n">disconnect</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>
</code><code>    </code><code class="k">else</code><code class="p">:</code><code>
</code><code>        </code><code class="n">parser</code><code class="o">.</code><code class="n">print_help</code><code class="p">(</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO17-1" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO17-1"><img src="assets/1.png" alt="1"/></a></dt>
<dd><p>The <code>Database</code> class is just a fancy context manager for creating
and deleting a database from a PostgreSQL instance. The database name
is passed into the <span class="keep-together">constructor</span>.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO17-2" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO17-6"><img src="assets/2.png" alt="2"/></a></dt>
<dd><p>(Note: The sequence of callouts in the code is intentionally different
from this list.) This is an <em>asynchronous</em> context manager. Instead of the usual
<code>__enter__()</code> and <code>__exit__()</code> methods, I use their
<code>__aenter__()</code> and <code>__aexit__()</code> <span class="keep-together">counterparts.</span></p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO17-3" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO17-2"><img src="assets/3.png" alt="3"/></a></dt>
<dd><p>Here, in the entering side,
I’ll create the new database and return a connection to that new
database. <code>server_command()</code> is another helper method defined a few lines down.
I use it to run the command for creating our new database.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO17-4" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO17-3"><img src="assets/4.png" alt="4"/></a></dt>
<dd><p>I then make a connection to the newly created database. Note that I’ve
hardcoded several details about the connection: this is intentional, as I
wanted to keep the code samples small. You could easily generalize this
by making fields for the username, hostname, and port.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO17-5" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO17-4"><img src="assets/5.png" alt="5"/></a></dt>
<dd><p>In the exiting side of the context manager, I close the connection
and…</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO17-6" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO17-5"><img src="assets/6.png" alt="6"/></a></dt>
<dd><p>…destroy the database.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO17-7" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO17-7"><img src="assets/7.png" alt="7"/></a></dt>
<dd><p>For completeness, this is our utility method for running commands
against the PostgreSQL server itself. It creates a connection for that
purpose, runs the given command, and exits.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO17-8" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO17-8"><img src="assets/8.png" alt="8"/></a></dt>
<dd><p>This function creates a long-lived socket connection to the database that will listen for events. This mechanism will be featured in the upcoming case study.</p></dd>
</dl></div>
<div data-type="caution"><h6>Caution</h6>
<p>In point 8 for the preceding code, I created a dedicated connection for each
channel I want to listen on. This is expensive since it means
that a PostgreSQL worker will be completely tied up for every channel
being listened to. A much better design would be to use one connection for
multiple channels. Once you have worked through this example, try
to modify the code to use a single connection for multiple channel
listeners.</p>
</div>

<p>Now that you have an understanding of the basic building blocks of <code>asyncpg</code>,
we can explore it further with a really fun case study: using PostgreSQL’s built-in
support for sending event notifications to perform cache invalidation!</p>








<section data-type="sect2" data-pdf-bookmark="Case Study: Cache Invalidation"><div class="sect2" id="asyncpg_cs">
<h2>Case Study: Cache Invalidation</h2>
<blockquote>
<p>There are two hard things in computer science: cache invalidation,
naming things, and off-by-one errors.</p>
<p data-type="attribution">Phil Karlton</p>
</blockquote>

<p>It is common in web services <a data-type="indexterm" data-primary="cache invalidation case study with asyncpg and Sanic" id="ix_cacheinv"/><a data-type="indexterm" data-primary="asyncpg and Sanic" data-secondary="cache invalidation case study" id="ix_asypgSancics"/>and web applications that the persistence
layer, i.e., the backing database (DB), becomes the performance bottleneck
sooner than any other part of the stack. The application layer can usually be
scaled horizontally by running more instances, whereas it’s trickier to
do that with a database.</p>

<p>This is why it’s common practice to look at design options that can
limit excessive interaction with the database. The most common option
is to use <em>caching</em> to “remember” previously fetched database results
and replay them when asked, thus avoiding subsequent calls to the DB
for the same information.</p>

<p>However, what happens if one of your app instances writes new data to
the database while another app instance is still returning the old,
stale data from its internal cache? This is a classic <em>cache
invalidation</em> problem, and it can be very difficult to resolve in
a robust way.</p>

<p>Our attack strategy is as follows:</p>
<ol>
<li>
<p>Each app instance has an in-memory cache of DB queries.</p>
</li>
<li>
<p>When one writes new data to the database, the database alerts all
of the connected app instances of the new data.</p>
</li>
<li>
<p>Each app instance then updates its internal cache accordingly.</p>
</li>

</ol>

<p>This case study will highlight how PostgreSQL, with its
built-in support for event updates via the
<a href="http://bit.ly/2EP9yeJ"><code>LISTEN</code></a>
and
<a href="http://bit.ly/2BN5lp1"><code>NOTIFY</code></a>
commands, can simply <em>tell us</em> when its data has changed.</p>

<p><code>asyncpg</code> already has support for the <code>LISTEN</code>/<code>NOTIFY</code> API.
This feature of PostgreSQL allows your app to subscribe to events on a
named channel and to post events to named channels. PostgreSQL can almost become a lighter version of
<a href="https://oreil.ly/jvDgm">RabbitMQ</a> or
<a href="https://oreil.ly/yiaK0">ActiveMQ</a>!</p>

<p>This case study has more moving parts than usual, and that makes it awkward
to present in the usual linear format. Instead, we’ll begin by looking at the
final product, and work backward toward the underlying implementation.</p>

<p>Our app provides a JSON-based API server for managing the favorite
dishes of patrons at our robotic restaurant. The backing database will
have only one table, <code>patron</code>, with only two fields: <code>name</code> and <code>fav_dish</code>.
Our API will allow the usual set of four operations: <em>create</em>, <em>read</em>,
<em>update</em>, and <em>delete</em> (CRUD).</p>

<p>The following is a sample interaction with our API using <code>curl</code>, illustrating
how to create a new entry in our database (I haven’t yet shown how to start up the server running on <em>localhost:8000</em>; that will come later):</p>

<pre data-type="programlisting">$ curl -d '{"name": "Carol", "fav_dish": "SPAM Bruschetta"}' \
    -H "Content-Type: application/json" \
    -X POST \
    http://localhost:8000/patron
{"msg":"ok","id":37}</pre>

<p>The <code>-d</code> parameter is for data,<sup><a data-type="noteref" id="idm46363020071448-marker" href="ch04.html#idm46363020071448">2</a></sup> <code>-H</code> is for the HTTP headers, <code>-X</code>
is for the HTTP request method (alternatives include <code>GET</code>, <code>DELETE</code>, <code>PUT</code>,
and a few others), and the URL is for our API server. We’ll get to the code
for that shortly.</p>

<p>In the output, we see that the creation was <code>ok</code>, and the <code>id</code> being returned
is the primary key of the new record in the database.</p>

<p>In the next few shell snippets, we’ll run through the other three operations:
<em>read</em>, <em>update</em>, and <em>delete</em>. We can read the patron record we just created with this command:</p>

<pre data-type="programlisting">$ curl -X GET http://localhost:8000/patron/37</pre>

<pre data-type="programlisting">{"id":37,"name":"Carol","fav_dish":"SPAM Bruschetta"}</pre>

<p>Reading the data is pretty straightforward. Note that the <code>id</code> of
the desired record must be supplied in the URL.</p>

<p class="pagebreak-before">Next, we’ll update the record and check the results:</p>

<pre data-type="programlisting">$ curl -d '{"name": "Eric", "fav_dish": "SPAM Bruschetta"}' \
    -H "Content-Type: application/json" \
    -X PUT \
    http://localhost:8000/patron/37
$ curl -X GET http://localhost:8000/patron/37
{"msg":"ok"}
{"id":37,"name":"Eric","fav_dish":"SPAM Bruschetta"}</pre>

<p>Updating a resource is similar to creating one,
with two key differences:</p>

<ul>
<li>
<p>The HTTP request method (<code>-X</code>) is <code>PUT</code>, not <code>POST</code>.</p>
</li>
<li>
<p>The URL now requires the <code>id</code> field to specify which resource to update.</p>
</li>
</ul>

<p>Finally, we can delete the record and verify its deletion with the following commands:</p>

<pre data-type="programlisting">$ curl -X DELETE http://localhost:8000/patron/37
$ curl -X GET http://localhost:8000/patron/37
{"msg":"ok"}
null</pre>

<p>As you can see, <code>null</code> is returned when you try to
<code>GET</code> a record that doesn’t exist.</p>

<p>So far this all looks quite ordinary, but our objective is not only to
make a CRUD API—we want to look at cache invalidation. So, let’s turn
our attention toward the cache. Now that we have a basic
understanding of our app’s API, we can look at the application logs to
see timing data for each request: this will tell us which requests are
cached, and which hit the DB.</p>

<p>When the server is first started up, the cache is empty; it’s a memory
cache, after all. We’re going to start up our server, and then in a
separate shell run two <code>GET</code> requests in quick succession:</p>

<pre data-type="programlisting">$ curl -X GET http://localhost:8000/patron/29
$ curl -X GET http://localhost:8000/patron/29
{"id":29,"name":"John Cleese","fav_dish":"Gravy on Toast"}
{"id":29,"name":"John Cleese","fav_dish":"Gravy on Toast"}</pre>

<p class="pagebreak-before">We expect that the first time we retrieve our record, there’s
going to be a cache miss, and the second time, a hit.<a data-type="indexterm" data-primary="asyncpg and Sanic" data-secondary="API server running on localhost:8000" id="idm46363019884680"/> We can see evidence
of this in the log for the API server itself (the first Sanic web server, running on <em>localhost:8000</em>):</p>

<pre data-type="programlisting">$ sanic_demo.py
2019-09-29 16:20:33 - (sanic)[DEBUG]:
                 ▄▄▄▄▄
        ▀▀▀██████▄▄▄       _______________
      ▄▄▄▄▄  █████████▄  /                 \
     ▀▀▀▀█████▌ ▀▐▄ ▀▐█ |   Gotta go fast!  |
   ▀▀█████▄▄ ▀██████▄██ | _________________/
   ▀▄▄▄▄▄  ▀▀█▄▀█════█▀ |/
        ▀▀▀▄  ▀▀███ ▀       ▄▄
     ▄███▀▀██▄████████▄ ▄▀▀▀▀▀▀█▌
   ██▀▄▄▄██▀▄███▀ ▀▀████      ▄██
▄▀▀▀▄██▄▀▀▌████▒▒▒▒▒▒███     ▌▄▄▀
▌    ▐▀████▐███▒▒▒▒▒▐██▌
▀▄▄▄▄▀   ▀▀████▒▒▒▒▄██▀
          ▀▀█████████▀
        ▄▄██▀██████▀█
      ▄██▀     ▀▀▀  █
     ▄█             ▐▌
 ▄▄▄▄█▌              ▀█▄▄▄▄▀▀▄
▌     ▐                ▀▀▄▄▄▀
 ▀▀▄▄▀

2019-09-29 16:20:33 (sanic): Goin' Fast @ http://0.0.0.0:8000
2019-09-29 16:20:33 (sanic): Starting worker [10366]  <a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO18-1" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO18-1"><img src="assets/1.png" alt="1"/></a>
2019-09-29 16:25:27 (perf): id=37 Cache miss  <a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO18-2" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO18-2"><img src="assets/2.png" alt="2"/></a>
2019-09-29 16:25:27 (perf): get Elapsed: 4.26 ms <a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO18-3" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO18-3"><img src="assets/3.png" alt="3"/></a>
2019-09-29 16:25:27 (perf): get Elapsed: 0.04 ms <a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO18-4" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO18-4"><img src="assets/4.png" alt="4"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO18-1" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO18-1"><img src="assets/1.png" alt="1"/></a></dt>
<dd><p>Everything up to this line is the default <code>sanic</code> startup log
message.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO18-2" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO18-2"><img src="assets/2.png" alt="2"/></a></dt>
<dd><p>As described, the first <code>GET</code> results in a cache miss because the
server has only just started.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO18-3" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO18-3"><img src="assets/3.png" alt="3"/></a></dt>
<dd><p>This is from our first <code>curl -X GET</code>. I’ve added some timing
functionality to the API endpoints. Here we can see that
the handler for the <code>GET</code> request took ~4 ms.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO18-4" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO18-4"><img src="assets/4.png" alt="4"/></a></dt>
<dd><p>The second <code>GET</code> returns data from the cache, and the much faster (100x faster!)
timing data.</p></dd>
</dl>

<p>So far, nothing unusual. Many web apps use caching in this way.</p>

<p>Now let’s start up a second app instance on port 8001 (the first
instance was on port 8000):</p>
<pre data-type="programlisting">
$ <strong>sanic_demo.py --port 8001</strong>
&lt;snip&gt;
2017-10-02 08:09:56 - (sanic): Goin' Fast @ http://0.0.0.0:8001
2017-10-02 08:09:56 - (sanic): Starting worker [385]
</pre>

<p>Both instances, of course, connect to the same database. Now, with
both API server instances running, let’s modify the data for patron
<em>John</em>, who clearly lacks sufficient Spam in his diet. Here we perform an <code>UPDATE</code> against the first app instance at port 8000:</p>

<pre data-type="programlisting">$ curl -d '{"name": "John Cleese", "fav_dish": "SPAM on toast"}' \
    -H "Content-Type: application/json" \
    -X PUT \
    http://localhost:8000/patron/29
{"msg":"ok"}</pre>

<p>Immediately after this update event on only one of the app instances, <em>both</em>
API servers, 8000 and 8001, report the event in their respective
logs:</p>

<pre data-type="programlisting">2019-10-02 08:35:49 - (perf)[INFO]: Got DB event:
{
    "table": "patron",
    "id": 29,
    "type": "UPDATE",
    "data": {
        "old": {
            "id": 29,
            "name": "John Cleese",
            "fav_dish": "Gravy on Toast"
        },
        "new": {
            "id": 29,
            "name": "John Cleese",
            "fav_dish": "SPAM on toast"
        },
        "diff": {
            "fav_dish": "SPAM on toast"
        }
    }
}</pre>

<p>The database has reported the update event back to both app instances.
We haven’t done any requests against app instance 8001 yet, though—does
this mean that the new data is already cached there?</p>

<p>To check, we can do a <code>GET</code> on the second server, at port 8001:</p>

<pre data-type="programlisting">$ curl -X GET http://localhost:8001/patron/29
{"id":29,"name":"John Cleese","fav_dish":"SPAM on toast"}</pre>

<p>The timing info in the log output shows that we do indeed obtain the data directly from the cache, even though this is our first request:</p>

<pre data-type="programlisting">2019-10-02 08:46:45 - (perf)[INFO]: get Elapsed: 0.04 ms</pre>

<p>The upshot is that when the database changes, <em>all connected app
instances</em> get notified, allowing them to update their caches.</p>

<p>With this explanation out of the way, we can now look at the
<code>asyncpg</code> code implementation required to make our cache invalidation
actually work. The basic design for the server code shown in <a data-type="xref" href="#sanicdemo">Example 4-23</a> is the following:</p>
<ol>
<li>
<p>We have a simple web API using the new, <code>asyncio</code>-compatible
<a href="https://oreil.ly/q5eA4">Sanic web framework</a>.<a data-type="indexterm" data-primary="Sanic web framework" data-secondary="API server with" id="idm46363020584040"/></p>
</li>
<li>
<p>The data will be stored in a backend PostgreSQL instance, but the API
will be served via multiple instances of the web API app servers.</p>
</li>
<li>
<p>The app servers will cache data from the database.</p>
</li>
<li>
<p>The app servers will subscribe to events via <code>asyncpg</code> in specific tables
on the DB, and will receive update notifications when the data in the DB
table has been changed. This allows the app servers to update their
individual in-memory caches.</p>
</li>

</ol>
<div id="sanicdemo" data-type="example">
<h5><span class="label">Example 4-23. </span>API server with Sanic</h5>

<pre data-type="programlisting" data-code-language="python3"><code class="c1"># sanic_demo.py</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">argparse</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">sanic</code><code> </code><code class="k">import</code><code> </code><code class="n">Sanic</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">sanic</code><code class="nn">.</code><code class="nn">views</code><code> </code><code class="k">import</code><code> </code><code class="n">HTTPMethodView</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">sanic</code><code class="nn">.</code><code class="nn">response</code><code> </code><code class="k">import</code><code> </code><code class="n">json</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">util</code><code> </code><code class="k">import</code><code> </code><code class="n">Database</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-1" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-1"><img src="assets/1.png" alt="1"/></a><code>
</code><code class="kn">from</code><code> </code><code class="nn">perf</code><code> </code><code class="k">import</code><code> </code><code class="n">aelapsed</code><code class="p">,</code><code> </code><code class="n">aprofiler</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-2" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-2"><img src="assets/2.png" alt="2"/></a><code>
</code><code class="kn">import</code><code> </code><code class="nn">model</code><code>
</code><code>
</code><code class="n">app</code><code> </code><code class="o">=</code><code> </code><code class="n">Sanic</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-3" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-3"><img src="assets/3.png" alt="3"/></a><code>
</code><code>
</code><code class="nd">@aelapsed</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">new_patron</code><code class="p">(</code><code class="n">request</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-4" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-4"><img src="assets/4.png" alt="4"/></a><code>
</code><code>    </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">request</code><code class="o">.</code><code class="n">json</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-5" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-5"><img src="assets/5.png" alt="5"/></a><code>
</code><code>    </code><code class="nb">id</code><code> </code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="n">model</code><code class="o">.</code><code class="n">add_patron</code><code class="p">(</code><code class="n">app</code><code class="o">.</code><code class="n">pool</code><code class="p">,</code><code> </code><code class="n">data</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-6" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-6"><img src="assets/6.png" alt="6"/></a><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">json</code><code class="p">(</code><code class="nb">dict</code><code class="p">(</code><code class="n">msg</code><code class="o">=</code><code class="s1">'</code><code class="s1">ok</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="nb">id</code><code class="o">=</code><code class="nb">id</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-7" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-7"><img src="assets/7.png" alt="7"/></a><code>
</code><code>
</code><code class="k">class</code><code> </code><code class="nc">PatronAPI</code><code class="p">(</code><code class="n">HTTPMethodView</code><code class="p">,</code><code> </code><code class="n">metaclass</code><code class="o">=</code><code class="n">aprofiler</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-8" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-8"><img src="assets/8.png" alt="8"/></a><code>
</code><code>    </code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">get</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">request</code><code class="p">,</code><code> </code><code class="nb">id</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="n">model</code><code class="o">.</code><code class="n">get_patron</code><code class="p">(</code><code class="n">app</code><code class="o">.</code><code class="n">pool</code><code class="p">,</code><code> </code><code class="nb">id</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-9" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-9"><img src="assets/9.png" alt="9"/></a><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">json</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">put</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">request</code><code class="p">,</code><code> </code><code class="nb">id</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">request</code><code class="o">.</code><code class="n">json</code><code>
</code><code>        </code><code class="n">ok</code><code> </code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="n">model</code><code class="o">.</code><code class="n">update_patron</code><code class="p">(</code><code class="n">app</code><code class="o">.</code><code class="n">pool</code><code class="p">,</code><code> </code><code class="nb">id</code><code class="p">,</code><code> </code><code class="n">data</code><code class="p">)</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">json</code><code class="p">(</code><code class="nb">dict</code><code class="p">(</code><code class="n">msg</code><code class="o">=</code><code class="s1">'</code><code class="s1">ok</code><code class="s1">'</code><code> </code><code class="k">if</code><code> </code><code class="n">ok</code><code> </code><code class="k">else</code><code> </code><code class="s1">'</code><code class="s1">bad</code><code class="s1">'</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-10" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-10"><img src="assets/10.png" alt="10"/></a><code>
</code><code>
</code><code>    </code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">delete</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">request</code><code class="p">,</code><code> </code><code class="nb">id</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="n">ok</code><code> </code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="n">model</code><code class="o">.</code><code class="n">delete_patron</code><code class="p">(</code><code class="n">app</code><code class="o">.</code><code class="n">pool</code><code class="p">,</code><code> </code><code class="nb">id</code><code class="p">)</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">json</code><code class="p">(</code><code class="nb">dict</code><code class="p">(</code><code class="n">msg</code><code class="o">=</code><code class="s1">'</code><code class="s1">ok</code><code class="s1">'</code><code> </code><code class="k">if</code><code> </code><code class="n">ok</code><code> </code><code class="k">else</code><code> </code><code class="s1">'</code><code class="s1">bad</code><code class="s1">'</code><code class="p">)</code><code class="p">)</code><code>
</code><code>
</code><code class="nd">@app</code><code class="o">.</code><code class="n">listener</code><code class="p">(</code><code class="s1">'</code><code class="s1">before_server_start</code><code class="s1">'</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-11" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-11"><img src="assets/11.png" alt="11"/></a><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">db_connect</code><code class="p">(</code><code class="n">app</code><code class="p">,</code><code> </code><code class="n">loop</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">app</code><code class="o">.</code><code class="n">db</code><code> </code><code class="o">=</code><code> </code><code class="n">Database</code><code class="p">(</code><code class="s1">'</code><code class="s1">restaurant</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">owner</code><code class="o">=</code><code class="kc">False</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-12" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-12"><img src="assets/12.png" alt="12"/></a><code>
</code><code>    </code><code class="n">app</code><code class="o">.</code><code class="n">pool</code><code> </code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="n">app</code><code class="o">.</code><code class="n">db</code><code class="o">.</code><code class="n">connect</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-13" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-13"><img src="assets/13.png" alt="13"/></a><code>
</code><code>    </code><code class="k">await</code><code> </code><code class="n">model</code><code class="o">.</code><code class="n">create_table_if_missing</code><code class="p">(</code><code class="n">app</code><code class="o">.</code><code class="n">pool</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-14" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-14"><img src="assets/14.png" alt="14"/></a><code>
</code><code>    </code><code class="k">await</code><code> </code><code class="n">app</code><code class="o">.</code><code class="n">db</code><code class="o">.</code><code class="n">add_listener</code><code class="p">(</code><code class="s1">'</code><code class="s1">chan_patron</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">model</code><code class="o">.</code><code class="n">db_event</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-15" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-15"><img src="assets/15.png" alt="15"/></a><code>
</code><code>
</code><code class="nd">@app</code><code class="o">.</code><code class="n">listener</code><code class="p">(</code><code class="s1">'</code><code class="s1">after_server_stop</code><code class="s1">'</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-16" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-16"><img src="assets/16.png" alt="16"/></a><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">db_disconnect</code><code class="p">(</code><code class="n">app</code><code class="p">,</code><code> </code><code class="n">loop</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="k">await</code><code> </code><code class="n">app</code><code class="o">.</code><code class="n">db</code><code class="o">.</code><code class="n">disconnect</code><code class="p">(</code><code class="p">)</code><code>
</code><code>
</code><code class="k">if</code><code> </code><code class="nv-Magic">__name__</code><code> </code><code class="o">==</code><code> </code><code class="s2">"</code><code class="s2">__main__</code><code class="s2">"</code><code class="p">:</code><code>
</code><code>    </code><code class="n">parser</code><code> </code><code class="o">=</code><code> </code><code class="n">argparse</code><code class="o">.</code><code class="n">ArgumentParser</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="n">parser</code><code class="o">.</code><code class="n">add_argument</code><code class="p">(</code><code class="s1">'</code><code class="s1">--port</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="nb">type</code><code class="o">=</code><code class="nb">int</code><code class="p">,</code><code> </code><code class="n">default</code><code class="o">=</code><code class="mi">8000</code><code class="p">)</code><code>
</code><code>    </code><code class="n">args</code><code> </code><code class="o">=</code><code> </code><code class="n">parser</code><code class="o">.</code><code class="n">parse_args</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="n">app</code><code class="o">.</code><code class="n">add_route</code><code class="p">(</code><code>
</code><code>        </code><code class="n">new_patron</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">/patron</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">methods</code><code class="o">=</code><code class="p">[</code><code class="s1">'</code><code class="s1">POST</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-17" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-17"><img src="assets/17.png" alt="17"/></a><code>
</code><code>    </code><code class="n">app</code><code class="o">.</code><code class="n">add_route</code><code class="p">(</code><code>
</code><code>        </code><code class="n">PatronAPI</code><code class="o">.</code><code class="n">as_view</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">/patron/&lt;id:int&gt;</code><code class="s1">'</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-18" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-18"><img src="assets/18.png" alt="18"/></a><code>
</code><code>    </code><code class="n">app</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="n">host</code><code class="o">=</code><code class="s2">"</code><code class="s2">0.0.0.0</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">port</code><code class="o">=</code><code class="n">args</code><code class="o">.</code><code class="n">port</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-1" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-1"><img src="assets/1.png" alt="1"/></a></dt>
<dd><p>The <code>Database</code> utility helper, as described earlier. This will
provide the methods required to connect to the database.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-2" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-2"><img src="assets/2.png" alt="2"/></a></dt>
<dd><p>Two more tools I’ve cobbled together to log the elapsed time
of each API endpoint. I used this in the previous discussion to detect
when a <code>GET</code> was being returned from the cache. The implementations for
<code>aelapsed()</code> and <code>aprofiler()</code> are not important for this case study, but you
can obtain them in <a data-type="xref" href="app02.html#corobot">Example B-1</a>.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-3" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-3"><img src="assets/3.png" alt="3"/></a></dt>
<dd><p>We create the main Sanic app instance.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-4" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-4"><img src="assets/4.png" alt="4"/></a></dt>
<dd><p>This coroutine function is for creating new patron entries. In an
<code>add_route()</code> call toward the bottom of the code,
<code>new_patron()</code> is associated with the endpoint <code>/patron</code>, only for the
<code>POST</code> HTTP method.  The <code>@aelapsed</code> decorator is not part of the Sanic
API: it’s my own invention, merely to log out timings for each call.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-5" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-5"><img src="assets/5.png" alt="5"/></a></dt>
<dd><p>Sanic provides immediate deserialization of received JSON data by
using the <code>.json</code> attribute on the <code>request</code> object.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-6" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-6"><img src="assets/6.png" alt="6"/></a></dt>
<dd><p>The <code>model</code> module, which I imported, is the <em>model</em> for our
<code>patron</code> table in the database. I’ll go through that in more detail
in the next code listing; for now, just understand that all the
database queries and SQL are in this <code>model</code> module. Here I’m
passing the connection pool for the database, and the same pattern is used
for all the interaction with the database model in this function and
in the <code>PatronAPI</code> class further down.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-7" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-7"><img src="assets/7.png" alt="7"/></a></dt>
<dd><p>A new primary key, <code>id</code>, will be created, and this is returned back
to the caller as JSON.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-8" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-8"><img src="assets/8.png" alt="8"/></a></dt>
<dd><p>While creation is handled in the <code>new_patron()</code> function, all
other interactions are handled in this <em>class-based view</em>, which is
a convenience provided by Sanic. <span class="keep-together">All the methods in this class are
associated with the same URL,</span> <span class="keep-together"><code>/patron/&lt;id:int&gt;</code>,</span> which you can see
in the <code>add_route()</code> function near the bottom. Note that the
<code>id</code> URL parameter will be passed to each of the methods, and this
parameter is required for all three endpoints.</p>

<p>You can safely ignore the <code>metaclass</code> argument: all it does is wrap
each method with the <code>@aelapsed</code> decorator so that timings will be
printed in the logs. Again, this is not part of the Sanic API; it’s my own invention for logging timing data.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-9" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-9"><img src="assets/9.png" alt="9"/></a></dt>
<dd><p>As before, model interaction is performed inside the <code>model</code> module.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-10" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-10"><img src="assets/10.png" alt="10"/></a></dt>
<dd><p>If the model reports failure for doing the update, I modify
the response data. I’ve included this for readers who have not
yet seen Python’s version of the <em>ternary operator</em>.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-11" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-11"><img src="assets/11.png" alt="11"/></a></dt>
<dd><p>The <code>@app.listener</code> decorators are hooks provided by Sanic
to give you a place to add extra actions during the startup and
shutdown sequence. This one, <code>before_server_start</code>, is invoked before
the API server is started up. This seems like a good place to
initialize our database connection.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-12" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-12"><img src="assets/12.png" alt="12"/></a></dt>
<dd><p>Use the <code>Database</code> helper to create a connection to our
PostgreSQL instance. The DB we’re connecting to is <code>restaurant</code>.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-13" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-13"><img src="assets/13.png" alt="13"/></a></dt>
<dd><p>Obtain a connection pool to our database.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-14" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-14"><img src="assets/14.png" alt="14"/></a></dt>
<dd><p>Use our model (for the <code>patron</code> table) to create the table if
it’s missing.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-15" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-15"><img src="assets/15.png" alt="15"/></a></dt>
<dd><p>Use our model to create a dedicated_listener for database
events, listening on <span class="keep-together">the channel</span> <code>chan_patron</code>. The
callback function for these events is <code>model.db_event()</code>, which I’ll
go through in the next listing. The callback will be called every
time the database updates the channel.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-16" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-16"><img src="assets/16.png" alt="16"/></a></dt>
<dd><p><code>after_server_stop</code> is the hook for tasks that must happen
during shutdown. Here we disconnect from the database.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-17" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-17"><img src="assets/17.png" alt="17"/></a></dt>
<dd><p>This <code>add_route()</code> call  sends <code>POST</code> requests for the <code>/patron</code> URL
to the <code>new_patron()</code> coroutine function.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-18" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO19-18"><img src="assets/18.png" alt="18"/></a></dt>
<dd><p>This <code>add_route()</code> call sends <em>all</em> requests for the <code>/patron/&lt;id:int&gt;</code> URL
to the <code>PatronAPI</code> class-based view. The method names in that class
determine which one is called: a <code>GET</code> HTTP request will call
the <code>PatronAPI.get()</code> method, and so on.</p></dd>
</dl></div>

<p>The preceding code contains all the HTTP handling for our server,
as well as startup and shutdown tasks like setting up a connection
pool to the database and, crucially, setting up a <code>db-event</code> listener
on the <code>chan_patron</code> channel on the DB server.<a data-type="indexterm" data-primary="asyncpg and Sanic" data-secondary="DB model for patron table" id="idm46363019199064"/></p>

<p><a data-type="xref" href="#sanicdbmodel">Example 4-24</a> presents the model for the <code>patron</code> table in the database.</p>
<div id="sanicdbmodel" data-type="example">
<h5><span class="label">Example 4-24. </span>DB model for the “patron” table</h5>

<pre data-type="programlisting" data-code-language="python3"><code class="c1"># model.py</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">logging</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">json</code><code> </code><code class="k">import</code><code> </code><code class="n">loads</code><code class="p">,</code><code> </code><code class="n">dumps</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">triggers</code><code> </code><code class="k">import</code><code> </code><code class="p">(</code><code>
</code><code>    </code><code class="n">create_notify_trigger</code><code class="p">,</code><code> </code><code class="n">add_table_triggers</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-1" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-1"><img src="assets/1.png" alt="1"/></a><code>
</code><code class="kn">from</code><code> </code><code class="nn">boltons</code><code class="nn">.</code><code class="nn">cacheutils</code><code> </code><code class="k">import</code><code> </code><code class="n">LRU</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-2" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-2"><img src="assets/2.png" alt="2"/></a><code>
</code><code>
</code><code class="n">logger</code><code> </code><code class="o">=</code><code> </code><code class="n">logging</code><code class="o">.</code><code class="n">getLogger</code><code class="p">(</code><code class="s1">'</code><code class="s1">perf</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>
</code><code class="n">CREATE_TABLE</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="s1">'</code><code class="s1">CREATE TABLE IF NOT EXISTS patron(</code><code class="s1">'</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-3" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-3"><img src="assets/3.png" alt="3"/></a><code>
</code><code>                </code><code class="s1">'</code><code class="s1">id serial PRIMARY KEY, name text, </code><code class="s1">'</code><code>
</code><code>                </code><code class="s1">'</code><code class="s1">fav_dish text)</code><code class="s1">'</code><code class="p">)</code><code>
</code><code class="n">INSERT</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="s1">'</code><code class="s1">INSERT INTO patron(name, fav_dish) </code><code class="s1">'</code><code>
</code><code>          </code><code class="s1">'</code><code class="s1">VALUES ($1, $2) RETURNING id</code><code class="s1">'</code><code class="p">)</code><code>
</code><code class="n">SELECT</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">SELECT * FROM patron WHERE id = $1</code><code class="s1">'</code><code>
</code><code class="n">UPDATE</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">UPDATE patron SET name=$1, fav_dish=$2 WHERE id=$3</code><code class="s1">'</code><code>
</code><code class="n">DELETE</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">DELETE FROM patron WHERE id=$1</code><code class="s1">'</code><code>
</code><code class="n">EXISTS</code><code> </code><code class="o">=</code><code> </code><code class="s2">"</code><code class="s2">SELECT to_regclass(</code><code class="s2">'</code><code class="s2">patron</code><code class="s2">'</code><code class="s2">)</code><code class="s2">"</code><code>
</code><code>
</code><code class="n">CACHE</code><code> </code><code class="o">=</code><code> </code><code class="n">LRU</code><code class="p">(</code><code class="n">max_size</code><code class="o">=</code><code class="mi">65536</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-4" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-4"><img src="assets/4.png" alt="4"/></a><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">add_patron</code><code class="p">(</code><code class="n">conn</code><code class="p">,</code><code> </code><code class="n">data</code><code class="p">:</code><code> </code><code class="nb">dict</code><code class="p">)</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="nb">int</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-5" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-5"><img src="assets/5.png" alt="5"/></a><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="k">await</code><code> </code><code class="n">conn</code><code class="o">.</code><code class="n">fetchval</code><code class="p">(</code><code>
</code><code>        </code><code class="n">INSERT</code><code class="p">,</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">name</code><code class="s1">'</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">fav_dish</code><code class="s1">'</code><code class="p">]</code><code class="p">)</code><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">update_patron</code><code class="p">(</code><code class="n">conn</code><code class="p">,</code><code> </code><code class="nb">id</code><code class="p">:</code><code> </code><code class="nb">int</code><code class="p">,</code><code> </code><code class="n">data</code><code class="p">:</code><code> </code><code class="nb">dict</code><code class="p">)</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="nb">bool</code><code class="p">:</code><code>
</code><code>    </code><code class="n">result</code><code> </code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="n">conn</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-6" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-6"><img src="assets/6.png" alt="6"/></a><code>
</code><code>        </code><code class="n">UPDATE</code><code class="p">,</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">name</code><code class="s1">'</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s1">'</code><code class="s1">fav_dish</code><code class="s1">'</code><code class="p">]</code><code class="p">,</code><code> </code><code class="nb">id</code><code class="p">)</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">result</code><code> </code><code class="o">==</code><code> </code><code class="s1">'</code><code class="s1">UPDATE 1</code><code class="s1">'</code><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">delete_patron</code><code class="p">(</code><code class="n">conn</code><code class="p">,</code><code> </code><code class="nb">id</code><code class="p">:</code><code> </code><code class="nb">int</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-7" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-7"><img src="assets/7.png" alt="7"/></a><code>
</code><code>    </code><code class="n">result</code><code> </code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="n">conn</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">DELETE</code><code class="p">,</code><code> </code><code class="nb">id</code><code class="p">)</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">result</code><code> </code><code class="o">==</code><code> </code><code class="s1">'</code><code class="s1">DELETE 1</code><code class="s1">'</code><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">get_patron</code><code class="p">(</code><code class="n">conn</code><code class="p">,</code><code> </code><code class="nb">id</code><code class="p">:</code><code> </code><code class="nb">int</code><code class="p">)</code><code> </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="nb">dict</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-8" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-8"><img src="assets/8.png" alt="8"/></a><code>
</code><code>    </code><code class="k">if</code><code> </code><code class="nb">id</code><code> </code><code class="ow">not</code><code> </code><code class="ow">in</code><code> </code><code class="n">CACHE</code><code class="p">:</code><code>
</code><code>        </code><code class="n">logger</code><code class="o">.</code><code class="n">info</code><code class="p">(</code><code class="n">f</code><code class="s1">'</code><code class="s1">id=</code><code class="si">{id}</code><code class="s1"> Cache miss</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>        </code><code class="n">record</code><code> </code><code class="o">=</code><code> </code><code class="k">await</code><code> </code><code class="n">conn</code><code class="o">.</code><code class="n">fetchrow</code><code class="p">(</code><code class="n">SELECT</code><code class="p">,</code><code> </code><code class="nb">id</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-9" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-9"><img src="assets/9.png" alt="9"/></a><code>
</code><code>        </code><code class="n">CACHE</code><code class="p">[</code><code class="nb">id</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">record</code><code> </code><code class="ow">and</code><code> </code><code class="nb">dict</code><code class="p">(</code><code class="n">record</code><code class="o">.</code><code class="n">items</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">CACHE</code><code class="p">[</code><code class="nb">id</code><code class="p">]</code><code>
</code><code>
</code><code class="k">def</code><code> </code><code class="nf">db_event</code><code class="p">(</code><code class="n">conn</code><code class="p">,</code><code> </code><code class="n">pid</code><code class="p">,</code><code> </code><code class="n">channel</code><code class="p">,</code><code> </code><code class="n">payload</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-10" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-10"><img src="assets/10.png" alt="10"/></a><code>
</code><code>    </code><code class="n">event</code><code> </code><code class="o">=</code><code> </code><code class="n">loads</code><code class="p">(</code><code class="n">payload</code><code class="p">)</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-11" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-11"><img src="assets/11.png" alt="11"/></a><code>
</code><code>    </code><code class="n">logger</code><code class="o">.</code><code class="n">info</code><code class="p">(</code><code class="s1">'</code><code class="s1">Got DB event:</code><code class="se">\n</code><code class="s1">'</code><code> </code><code class="o">+</code><code> </code><code class="n">dumps</code><code class="p">(</code><code class="n">event</code><code class="p">,</code><code> </code><code class="n">indent</code><code class="o">=</code><code class="mi">4</code><code class="p">)</code><code class="p">)</code><code>
</code><code>    </code><code class="nb">id</code><code> </code><code class="o">=</code><code> </code><code class="n">event</code><code class="p">[</code><code class="s1">'</code><code class="s1">id</code><code class="s1">'</code><code class="p">]</code><code>
</code><code>    </code><code class="k">if</code><code> </code><code class="n">event</code><code class="p">[</code><code class="s1">'</code><code class="s1">type</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">==</code><code> </code><code class="s1">'</code><code class="s1">INSERT</code><code class="s1">'</code><code class="p">:</code><code>
</code><code>        </code><code class="n">CACHE</code><code class="p">[</code><code class="nb">id</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">event</code><code class="p">[</code><code class="s1">'</code><code class="s1">data</code><code class="s1">'</code><code class="p">]</code><code>
</code><code>    </code><code class="k">elif</code><code> </code><code class="n">event</code><code class="p">[</code><code class="s1">'</code><code class="s1">type</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">==</code><code> </code><code class="s1">'</code><code class="s1">UPDATE</code><code class="s1">'</code><code class="p">:</code><code>
</code><code>        </code><code class="n">CACHE</code><code class="p">[</code><code class="nb">id</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">event</code><code class="p">[</code><code class="s1">'</code><code class="s1">data</code><code class="s1">'</code><code class="p">]</code><code class="p">[</code><code class="s1">'</code><code class="s1">new</code><code class="s1">'</code><code class="p">]</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-12" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-12"><img src="assets/12.png" alt="12"/></a><code>
</code><code>    </code><code class="k">elif</code><code> </code><code class="n">event</code><code class="p">[</code><code class="s1">'</code><code class="s1">type</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">==</code><code> </code><code class="s1">'</code><code class="s1">DELETE</code><code class="s1">'</code><code class="p">:</code><code>
</code><code>        </code><code class="n">CACHE</code><code class="p">[</code><code class="nb">id</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="kc">None</code><code>
</code><code>
</code><code class="k">async</code><code> </code><code class="k">def</code><code> </code><code class="nf">create_table_if_missing</code><code class="p">(</code><code class="n">conn</code><code class="p">)</code><code class="p">:</code><code>  </code><a class="co" id="co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-13" href="#callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-13"><img src="assets/13.png" alt="13"/></a><code>
</code><code>    </code><code class="k">if</code><code> </code><code class="ow">not</code><code> </code><code class="k">await</code><code> </code><code class="n">conn</code><code class="o">.</code><code class="n">fetchval</code><code class="p">(</code><code class="n">EXISTS</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="k">await</code><code> </code><code class="n">conn</code><code class="o">.</code><code class="n">fetchval</code><code class="p">(</code><code class="n">CREATE_TABLE</code><code class="p">)</code><code>
</code><code>        </code><code class="k">await</code><code> </code><code class="n">create_notify_trigger</code><code class="p">(</code><code>
</code><code>            </code><code class="n">conn</code><code class="p">,</code><code> </code><code class="n">channel</code><code class="o">=</code><code class="s1">'</code><code class="s1">chan_patron</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>        </code><code class="k">await</code><code> </code><code class="n">add_table_triggers</code><code class="p">(</code><code>
</code><code>            </code><code class="n">conn</code><code class="p">,</code><code> </code><code class="n">table</code><code class="o">=</code><code class="s1">'</code><code class="s1">patron</code><code class="s1">'</code><code class="p">)</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-1" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-1"><img src="assets/1.png" alt="1"/></a></dt>
<dd><p>You have to add triggers to the database in order to get
notifications when data changes. I’ve created these handy helpers
to create the trigger function itself (with <code>create_notify_trigger</code>)
and to add the trigger to a specific table (with <code>add_table_triggers</code>).
The SQL required to do this is somewhat out of scope for this book,
but it’s still crucial to understanding how this case study works. I’ve
included the annotated code for these triggers in
<a href="app02.html#corobot">Appendix B</a>.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-2" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-2"><img src="assets/2.png" alt="2"/></a></dt>
<dd><p>The third-party <code>boltons</code> package provides a bunch of useful tools,
not the least of which is the <code>LRU</code> cache, a more versatile option than the
<code>@lru_cache</code> decorator in the <code>functools</code> standard library module.<sup><a data-type="noteref" id="idm46363021245640-marker" href="ch04.html#idm46363021245640">3</a></sup></p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-3" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-3"><img src="assets/3.png" alt="3"/></a></dt>
<dd><p>This block of text holds all the SQL for the standard
CRUD operations. Note that I’m using native
PostgreSQL syntax for the parameters: <code>$1</code>, <code>$2</code>, and so on. There is
nothing novel here, and it won’t be discussed further.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-4" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-4"><img src="assets/4.png" alt="4"/></a></dt>
<dd><p>Create the cache for this app instance.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-5" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-5"><img src="assets/5.png" alt="5"/></a></dt>
<dd><p>I called this function from the
Sanic module inside the <code>new_patron()</code> endpoint for adding new patrons.
Inside the function, I use the <code>fetchval()</code> method to insert new data.
Why <code>fetchval()</code> and not <code>execute()</code>? Because <code>fetchval()</code> returns
the primary key of the new inserted record!<sup><a data-type="noteref" id="idm46363020825512-marker" href="ch04.html#idm46363020825512">4</a></sup></p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-6" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-6"><img src="assets/6.png" alt="6"/></a></dt>
<dd><p>Update an existing record. When this succeeds, PostgreSQL will
return <code>UPDATE 1</code>, so I use that as a check to verify that the update
succeeded.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-7" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-7"><img src="assets/7.png" alt="7"/></a></dt>
<dd><p>Deletion is very similar to updating.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-8" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-8"><img src="assets/8.png" alt="8"/></a></dt>
<dd><p>This is the read operation.  This is the only part of our CRUD
interface that cares about the cache. Think about that for a second:
we don’t update the cache when doing an insert, update, or delete. This
is because we rely on the async notification from the database (via
the installed triggers) to update the cache if any data is changed.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-9" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-9"><img src="assets/9.png" alt="9"/></a></dt>
<dd><p>Of course, we do still want to use the cache after the first <code>GET</code>.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-10" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-10"><img src="assets/10.png" alt="10"/></a></dt>
<dd><p>The <code>db_event()</code> function is the callback that <code>asyncpg</code> will make
when there are events on our DB notification channel, <code>chan_patron</code>.
This specific parameter list is required by <code>asyncpg</code>. <code>conn</code> is the connection
on which the event was sent, <code>pid</code> is the process ID of the PostgreSQL
instance that sent the event, <code>channel</code> is the name of the channel
(which in this case will be <code>chan_patron</code>), and the payload is the
data being sent on the channel.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-11" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-11"><img src="assets/11.png" alt="11"/></a></dt>
<dd><p>Deserialize the JSON data to a dict.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-12" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-12"><img src="assets/12.png" alt="12"/></a></dt>
<dd><p>The cache population is generally quite straightforward, but
note that update events contain both new and old data, so we need
to make sure to cache the new data only.</p></dd>
<dt><a class="co" id="callout_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-13" href="#co_20_asyncio_libraries_you_aren__8217_t_using__but__8230_oh__never_mind__CO20-13"><img src="assets/13.png" alt="13"/></a></dt>
<dd><p>This is a small utility function I’ve made to easily re-create
a table if it’s missing. This is really useful if you need to do this
frequently—such as when writing the code samples for this book!</p>

<p>This is also where the database notification triggers are created
and added to our <code>patron</code> table. See <a data-type="xref" href="app02.html#corobot">Example B-1</a>
for annotated listing of these functions.</p></dd>
</dl></div>

<p>That brings us to the end of this case study. We’ve seen how Sanic
makes it very simple to create an API server, and we’ve seen how
to use <code>asyncpg</code> for performing queries via a connection pool,
 and how to use PostgreSQL’s async notification features to receive
callbacks over a dedicated, long-lived database connection.</p>

<p>Many <a data-type="indexterm" data-primary="object-relational mappers (ORMs)" id="idm46363041163288"/>people prefer to use object-relational mappers to work
with databases, and in this area, <a href="https://www.sqlalchemy.org">SQLAlchemy</a>
is the leader. <a data-type="indexterm" data-primary="SQLAlchemy database ORM library" id="idm46363041161336"/>There is growing support for using SQLAlchemy together with <code>asyncpg</code>
in third-party libraries like <a href="https://oreil.ly/TAKwC"><code>asyncpgsa</code></a>
and <a href="https://oreil.ly/a4qOR">GINO</a>. Another popular ORM,
<a href="https://oreil.ly/pl0Gn">Peewee</a>, is given support for
<code>asyncio</code> through the <a href="https://oreil.ly/76dzO"><code>aiopeewee</code></a>
package.<a data-type="indexterm" data-primary="cache invalidation case study with asyncpg and Sanic" data-startref="ix_cacheinv" id="idm46363041156536"/><a data-type="indexterm" data-primary="asyncpg and Sanic" data-secondary="cache invalidation case study" data-startref="ix_asypgSancics" id="idm46363041155592"/><a data-type="indexterm" data-primary="asyncpg and Sanic" data-startref="ix_asypgSan" id="idm46363041154408"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Other Libraries and Resources"><div class="sect1" id="idm46363021187144">
<h1>Other Libraries and Resources</h1>

<p>There are many other libraries for <code>asyncio</code> not covered in this book.<a data-type="indexterm" data-primary="asyncio libraries" data-secondary="other libraries and resourcs" id="ix_asyliboth"/> To
find out more, you can check out the
<a href="https://oreil.ly/40Uf_"><code>aio-libs</code> project</a>, which<a data-type="indexterm" data-primary="aio-libs project" id="idm46363041150584"/> manages nearly 40 libraries, and the
<a href="https://oreil.ly/SsC_0">Awesome <code>asyncio</code> project</a>,
which bookmarks many other projects compatible with the <code>asyncio</code>
module.<a data-type="indexterm" data-primary="Awesome asyncio project" id="idm46363041148200"/></p>

<p>One library that bears special mention is
<a href="https://oreil.ly/6ThkG"><code>aiofiles</code></a>. <a data-type="indexterm" data-primary="aiofiles library" id="idm46363041146360"/>As you may recall from our
earlier discussions, I said that to achieve high concurrency in
Asyncio, it is vitally important that the loop never block. In this
context, our focus on blocking operations has been exclusively
network-based I/O, but it turns out that disk access is also a blocking
operation that will impact your performance at very high concurrency
levels. The solution to this is <code>aiofiles</code>, which provides a convenient
wrapper for performing disk access in a thread. This works because
Python releases the GIL during file
operations so your main thread (running the <code>asyncio</code> loop) is
unaffected.</p>

<p>The most important domain for Asyncio is going to <a data-type="indexterm" data-primary="network programming" data-secondary="most important domain for asyncio" id="idm46363041143672"/>be network programming.
For this reason, it’s not a bad idea to learn a little about socket
programming, and even after all these years, Gordon McMillan’s
<a href="http://bit.ly/2sQt2d6">“Socket Programming HOWTO”</a>,
included with the standard Python documentation, is one of the best
introductions you’ll find.<a data-type="indexterm" data-primary="McMillan, Gordon" id="idm46363041141656"/><a data-type="indexterm" data-primary="sockets" data-secondary="“Socket Programming HOWTO”" data-secondary-sortas="Socket" id="idm46363041140984"/></p>

<p>I learned Asyncio from a wide variety of sources, many of which
have already been mentioned in earlier sections. Everyone learns differently, so it’s worth exploring different types of learning materials. Here are a few others that I found useful:</p>

<ul>
<li>
<p>Robert Smallshire’s <a href="https://oreil.ly/S5jRX">“Get to Grips with Asyncio in Python 3” talk</a>, presented at NDC London in January 2017.<a data-type="indexterm" data-primary="Smallshire, Robert" id="idm46363041137368"/><a data-type="indexterm" data-primary="“Get to Grips with Asyncio in Python 3” talk" data-primary-sortas="Get to Grips" id="idm46363041136696"/> This is by far the best YouTube video on Asyncio I’ve come across. The talk may be
somewhat advanced for a beginner, but it really does give a clear
description of how Asyncio is designed.</p>
</li>
<li>
<p>Nikolay Novik’s <a href="https://oreil.ly/ufpft">“Building Apps with Asyncio” slides</a>, presented at PyCon UA 2016.<a data-type="indexterm" data-primary="“Building Apps with Asyncio” presentation" data-primary-sortas="Building Apps" id="idm46363041133896"/> The information is dense, but a lot of practical
experience is captured in these slides.<a data-type="indexterm" data-primary="Novik, Nikolay" id="idm46363041132744"/></p>
</li>
<li>
<p>Endless sessions in the Python REPL, trying things out and “seeing
what <span class="keep-together">happens</span>.”</p>
</li>
</ul>

<p>I encourage <a data-type="indexterm" data-primary="Python" data-secondary="REPL" id="idm46363041129848"/>you to continue learning, and if a concept doesn’t
stick, keep looking for new sources until you find an explanation that
works for you.<a data-type="indexterm" data-primary="asyncio libraries" data-secondary="other libraries and resourcs" data-startref="ix_asyliboth" id="idm46363041128552"/><a data-type="indexterm" data-primary="asyncio libraries" data-startref="ix_asylib" id="idm46363041127368"/></p>
</div></section>







<div data-type="footnotes"><p data-type="footnote" id="idm46363022865560"><sup><a href="ch04.html#idm46363022865560-marker">1</a></sup> Actually, you <em>can</em> as long as the sockets being used in different threads are created, used, and destroyed entirely in their own threads. It is possible but hard to do, and many people struggle to get this right. This is why the recommendation to use a single thread and a polling mechanism is so strong.</p><p data-type="footnote" id="idm46363020071448"><sup><a href="ch04.html#idm46363020071448-marker">2</a></sup> The recipe for this dish, and recipes for other fine Spam-based fare, can be found <a href="http://bit.ly/2CGymPL">on the UKTV website</a>.</p><p data-type="footnote" id="idm46363021245640"><sup><a href="ch04.html#idm46363021245640-marker">3</a></sup> Obtain <code>boltons</code> with <code>pip install boltons</code>.</p><p data-type="footnote" id="idm46363020825512"><sup><a href="ch04.html#idm46363020825512-marker">4</a></sup> You <em>also</em> need the <code>RETURNING id</code> part of the SQL, though!</p></div></div></section></body></html>