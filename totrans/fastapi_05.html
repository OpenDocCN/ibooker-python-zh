<html><head></head><body><section data-pdf-bookmark="Chapter 3. FastAPI Tour" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch03">&#13;
<h1><span class="label">Chapter 3. </span>FastAPI Tour</h1>&#13;
&#13;
<blockquote>&#13;
<p><a data-primary="FastAPI" data-type="indexterm" id="icd012"/>FastAPI is a modern, fast (high-performance)&#13;
web framework for building APIs with Python 3.6+&#13;
based on standard Python type hints.</p>&#13;
<p data-type="attribution">Sebastián Ramírez, <cite>creator of FastAPI</cite></p>&#13;
</blockquote>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Preview" data-type="sect1"><div class="sect1" id="id29">&#13;
<h1>Preview</h1>&#13;
&#13;
<p><a href="https://fastapi.tiangolo.com">FastAPI</a>&#13;
<a data-primary="FastAPI" data-secondary="defined" data-type="indexterm" id="id456"/>was announced in 2018&#13;
by&#13;
<a href="https://tiangolo.com">Sebastián Ramírez</a><a data-primary="Ramírez, Sebastián" data-type="indexterm" id="id457"/>.&#13;
It’s more modern in many senses than most Python&#13;
web frameworks—taking advantage of features that have been added&#13;
to Python 3&#13;
in the last few years.&#13;
This chapter is a quick overview of <span class="keep-together">FastAPI’s</span> main features,&#13;
with emphasis on the first things that you’ll want to know: how to handle web requests and responses.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="What Is FastAPI?" data-type="sect1"><div class="sect1" id="id176">&#13;
<h1>What Is FastAPI?</h1>&#13;
&#13;
<p>Like any web framework, FastAPI helps you build web&#13;
applications.&#13;
Every framework is designed to make some operations easier—by features, omissions, and defaults.&#13;
As the name implies, FastAPI targets development of web APIs,&#13;
although you can use it for traditional&#13;
web content applications as well.</p>&#13;
&#13;
<p><a data-primary="FastAPI" data-secondary="advantages of" data-type="indexterm" id="id458"/>The FastAPI website claims these advantages:</p>&#13;
<dl>&#13;
<dt>Performance</dt>&#13;
<dd>&#13;
<p>As fast as Node.js and Go in some cases, unusual for Python frameworks.</p>&#13;
</dd>&#13;
<dt>Faster development</dt>&#13;
<dd>&#13;
<p>No sharp edges or oddities.</p>&#13;
</dd>&#13;
<dt>Better code quality</dt>&#13;
<dd>&#13;
<p>Type hinting and models help reduce bugs.</p>&#13;
</dd>&#13;
<dt>Autogenerated documentation and test pages</dt>&#13;
<dd>&#13;
<p>Much easier than hand-editing OpenAPI descriptions.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>FastAPI uses the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Python type hints</p>&#13;
</li>&#13;
<li>&#13;
<p>Starlette for the web machinery, including async support</p>&#13;
</li>&#13;
<li>&#13;
<p>Pydantic for data definitions and validation</p>&#13;
</li>&#13;
<li>&#13;
<p>Special integration to leverage and extend the others</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>This combination makes a pleasing development environment&#13;
for web applications, especially RESTful web services.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="A FastAPI Application" data-type="sect1"><div class="sect1" id="id30">&#13;
<h1>A FastAPI Application</h1>&#13;
&#13;
<p><a data-primary="FastAPI" data-secondary="Hello? World? application" data-type="indexterm" id="icd013"/>Let’s write a teeny FastAPI application—a web service with a single endpoint.&#13;
For now, we’re in what I’ve called the Web layer,&#13;
handling only web requests and responses.&#13;
First, install the basic Python packages that we’ll be using:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a data-primary="FastAPI" data-secondary="installing" data-type="indexterm" id="id459"/>The <a href="https://fastapi.tiangolo.com">FastAPI</a> framework: <code>pip install fastapi</code></p>&#13;
</li>&#13;
<li>&#13;
<p><a data-primary="Uvicorn" data-secondary="installing" data-type="indexterm" id="id460"/>The <a href="https://www.uvicorn.org">Uvicorn</a> web server: <code>pip install uvicorn</code></p>&#13;
</li>&#13;
<li>&#13;
<p><a data-primary="HTTPie" data-secondary="installing" data-type="indexterm" id="id461"/>The <a href="https://httpie.io">HTTPie</a> text web client: <code>pip install httpie</code></p>&#13;
</li>&#13;
<li>&#13;
<p><a data-primary="Requests package" data-secondary="installing" data-type="indexterm" id="id462"/>The <a href="https://requests.readthedocs.io">Requests</a> synchronous web client package: <code>pip install requests</code></p>&#13;
</li>&#13;
<li>&#13;
<p><a data-primary="HTTPX" data-secondary="installing" data-type="indexterm" id="id463"/>The <a href="https://www.python-httpx.org">HTTPX</a> synchronous/asynchronous web client package: <code>pip install httpx</code></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Although <a data-primary="curl" data-type="indexterm" id="id464"/><a href="https://curl.se">curl</a> is the best known text web client,&#13;
I think HTTPie is easier to use.&#13;
Also, it defaults to JSON encoding and decoding,&#13;
which is a better match for FastAPI.&#13;
Later in this chapter,&#13;
you’ll see a screenshot that includes&#13;
the syntax of the curl command line needed to&#13;
access a particular endpoint.</p>&#13;
&#13;
<p>Let’s shadow an introverted web developer&#13;
in <a data-type="xref" href="#ex-3-1">Example 3-1</a>&#13;
and save this code as the file <em>hello.py</em>.</p>&#13;
<div data-type="example" id="ex-3-1">&#13;
<h5><span class="label">Example 3-1. </span>A shy endpoint (<span class="plain">hello.py</span>)</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">FastAPI</code>&#13;
&#13;
<code class="n">app</code> <code class="o">=</code> <code class="n">FastAPI</code><code class="p">()</code>&#13;
&#13;
<code class="nd">@app</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/hi"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">greet</code><code class="p">():</code>&#13;
    <code class="k">return</code> <code class="s2">"Hello? World?"</code></pre></div>&#13;
&#13;
<p>Here are some points to notice:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><code>app</code> is the top-level FastAPI object that represents the&#13;
whole web application.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>@app.get("/hi")</code> is a <a data-primary="path decorators" data-type="indexterm" id="id465"/><em>path decorator</em>.&#13;
It tells FastAPI the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>A request for the URL <code>"/hi"</code> on this server should&#13;
be directed to the following function.</p>&#13;
</li>&#13;
<li>&#13;
<p>This decorator applies only to the HTTP <code>GET</code> verb.&#13;
You can  also respond&#13;
to a <code>"/hi"</code> URL sent with the other HTTP verbs&#13;
(<code>PUT</code>, <code>POST</code>, etc.), each with a separate function.</p>&#13;
</li>&#13;
</ul>&#13;
</li>&#13;
<li>&#13;
<p><code>def greet()</code> is a <a data-primary="path functions (web endpoints)" data-type="indexterm" id="id466"/><em>path function</em>—the main <a data-primary="web endpoints (path functions)" data-type="indexterm" id="id467"/>point of contact&#13;
with HTTP requests and responses.&#13;
In this example, it has no arguments,&#13;
but the following sections show that there’s much more under&#13;
the FastAPI hood.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The next step is to run this web application in a web server.&#13;
FastAPI itself does not include a web server&#13;
but recommends Uvicorn.&#13;
You can start Uvicorn and the <span class="keep-together">FastAPI</span> web application in two ways:  externally or internally.</p>&#13;
&#13;
<p>To <a data-primary="Uvicorn" data-secondary="starting externally" data-type="indexterm" id="id468"/>start Uvicorn externally, via the command line, see <a data-type="xref" href="#ex-3-2">Example 3-2</a>.</p>&#13;
<div data-type="example" id="ex-3-2">&#13;
<h5><span class="label">Example 3-2. </span>Start Uvicorn with the command line</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>uvicorn hello:app --reload</strong></pre></div>&#13;
&#13;
<p>The <code>hello</code> refers to the <em>hello.py</em> file,&#13;
and <code>app</code> is the FastAPI variable name within it.</p>&#13;
&#13;
<p>Alternatively, you can <a data-primary="Uvicorn" data-secondary="starting internally" data-type="indexterm" id="id469"/>start Uvicorn internally&#13;
in the application itself, as in <a data-type="xref" href="#ex-3-3">Example 3-3</a>.</p>&#13;
<div data-type="example" id="ex-3-3">&#13;
<h5><span class="label">Example 3-3. </span>Start Uvicorn internally</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">FastAPI</code>&#13;
&#13;
<code class="n">app</code> <code class="o">=</code> <code class="n">FastAPI</code><code class="p">()</code>&#13;
&#13;
<code class="nd">@app</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/hi"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">greet</code><code class="p">():</code>&#13;
    <code class="k">return</code> <code class="s2">"Hello? World?"</code>&#13;
&#13;
<code class="k">if</code> <code class="vm">__name__</code> <code class="o">==</code> <code class="s2">"__main__"</code><code class="p">:</code>&#13;
    <code class="kn">import</code> <code class="nn">uvicorn</code>&#13;
    <code class="n">uvicorn</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="s2">"hello:app"</code><code class="p">,</code> <code class="n">reload</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>In either case,&#13;
that <code>reload</code> tells Uvicorn to restart the web server&#13;
if <em>hello.py</em> changes.&#13;
In this chapter, we’re going to use this automatic reloading a lot.</p>&#13;
&#13;
<p>Either case will use port 8000 on your machine&#13;
(named <code>localhost</code>) by default.&#13;
Both the external and internal methods have&#13;
<code>host</code> and <code>port</code> arguments if you’d prefer something else.</p>&#13;
&#13;
<p>Now the server has a single endpoint (<em>/hi</em>) and is ready for requests.</p>&#13;
&#13;
<p>Let’s test with multiple web clients:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>For the browser, type the URL in the top location bar.</p>&#13;
</li>&#13;
<li>&#13;
<p>For HTTPie, type the command shown (the <code>$</code> stands for whatever&#13;
command prompt you have for your system shell).</p>&#13;
</li>&#13;
<li>&#13;
<p>For Requests or HTTPX, use Python in interactive mode,&#13;
and type after the <code>&gt;&gt;&gt;</code> prompt.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>As mentioned in the Preface,&#13;
what you type is in a</p>&#13;
&#13;
<pre data-type="programlisting"><strong>bold monospaced font</strong></pre>&#13;
&#13;
<p>and the output is in a</p>&#13;
&#13;
<pre data-type="programlisting">normal monospaced font</pre>&#13;
&#13;
<p>Examples <a data-type="xref" data-xrefstyle="select:labelnumber" href="#ex-3-4">3-4</a> through&#13;
<a data-type="xref" data-xrefstyle="select:labelnumber" href="#ex-3-7">3-7</a> show different ways to test&#13;
the web server’s brand-new <em>/hi</em> endpoint.</p>&#13;
<div data-type="example" id="ex-3-4">&#13;
<h5><span class="label">Example 3-4. </span>Test <span class="plain">/hi</span> in the browser</h5>&#13;
&#13;
<pre data-type="programlisting"><strong>http://localhost:8000/hi</strong></pre></div>&#13;
<div data-type="example" id="ex-3-5">&#13;
<h5><span class="label">Example 3-5. </span>Test <span class="plain">/hi</span> with Requests</h5>&#13;
&#13;
<pre data-type="programlisting">&gt;&gt;&gt; <strong>import requests</strong>&#13;
&gt;&gt;&gt; <strong>r = requests.get("http://localhost:8000/hi")</strong>&#13;
&gt;&gt;&gt; <strong>r.json()</strong>&#13;
'Hello? World?'</pre></div>&#13;
<div data-type="example" id="ex-3-6">&#13;
<h5><span class="label">Example 3-6. </span>Test <span class="plain">/hi</span> with HTTPX, which is almost identical to Requests</h5>&#13;
&#13;
<pre data-type="programlisting">&gt;&gt;&gt; <strong>import httpx</strong>&#13;
&gt;&gt;&gt; <strong>r = httpx.get("http://localhost:8000/hi")</strong>&#13;
&gt;&gt;&gt; <strong>r.json()</strong>&#13;
'Hello? World?'</pre></div>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>It doesn’t matter if you use <a data-primary="Requests package" data-secondary="testing with" data-type="indexterm" id="id470"/>Requests or <a data-primary="HTTPX" data-secondary="testing with" data-type="indexterm" id="id471"/>HTTPX&#13;
to test FastAPI routes.&#13;
But <a data-type="xref" href="ch13.html#ch13">Chapter 13</a> shows cases where HTTPX is useful&#13;
when making other asynchronous calls.&#13;
So the rest of the examples in this chapter&#13;
use Requests.</p>&#13;
</div>&#13;
<div data-type="example" id="ex-3-7">&#13;
<h5><span class="label">Example 3-7. </span>Test <span class="plain">/hi</span> with HTTPie</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http localhost:8000/hi</strong>&#13;
HTTP/1.1 200 OK&#13;
content-length: 15&#13;
content-type: application/json&#13;
date: Thu, 30 Jun 2022 07:38:27 GMT&#13;
server: uvicorn&#13;
&#13;
"Hello? World?"</pre></div>&#13;
&#13;
<p>Use the <code>-b</code> argument in <a data-type="xref" href="#ex-3-8">Example 3-8</a>&#13;
to skip the response headers and print only the body.</p>&#13;
<div data-type="example" id="ex-3-8">&#13;
<h5><span class="label">Example 3-8. </span>Test <span class="plain">/hi</span> with HTTPie, printing only the response body</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http -b localhost:8000/hi</strong>&#13;
"Hello? World?"</pre></div>&#13;
&#13;
<p><a data-type="xref" href="#ex-3-9">Example 3-9</a> gets the full request headers as well as the response with <code>-v</code>.</p>&#13;
<div data-type="example" id="ex-3-9">&#13;
<h5><span class="label">Example 3-9. </span>Test <span class="plain">/hi</span> with HTTPie and get everything</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http -v localhost:8000/hi</strong>&#13;
GET /hi HTTP/1.1&#13;
Accept: <strong>/</strong>&#13;
Accept-Encoding: gzip, deflate&#13;
Connection: keep-alive&#13;
Host: localhost:8000&#13;
User-Agent: HTTPie/3.2.1&#13;
&#13;
&#13;
&#13;
HTTP/1.1 200 OK&#13;
content-length: 15&#13;
content-type: application/json&#13;
date: Thu, 30 Jun 2022 08:05:06 GMT&#13;
server: uvicorn&#13;
&#13;
"Hello? World?"</pre></div>&#13;
&#13;
<p>Some examples in this book show the default HTTPie output&#13;
(response headers and body),&#13;
and others show just the body<a data-primary="FastAPI" data-secondary="Hello? World? application" data-startref="icd013" data-type="indexterm" id="id472"/>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before less_space" data-pdf-bookmark="HTTP Requests" data-type="sect1"><div class="sect1" id="id31">&#13;
<h1>HTTP Requests</h1>&#13;
&#13;
<p><a data-primary="HTTP requests" data-type="indexterm" id="icd014"/><a data-type="xref" href="#ex-3-9">Example 3-9</a> <a data-primary="FastAPI" data-secondary="HTTP requests" data-type="indexterm" id="icd027"/>included only one specific request:&#13;
a <code>GET</code> request&#13;
for the <em>/hi</em> URL on the server&#13;
<code>localhost</code>, port <code>8000</code>.</p>&#13;
&#13;
<p>Web requests squirrel data in different parts&#13;
of an HTTP request,&#13;
and FastAPI lets you access them smoothly.&#13;
From the sample request in <a data-type="xref" href="#ex-3-9">Example 3-9</a>,&#13;
<a data-type="xref" href="#ex-3-10">Example 3-10</a> shows the HTTP request&#13;
that the <code>http</code> command sent to the web server.</p>&#13;
<div data-type="example" id="ex-3-10">&#13;
<h5><span class="label">Example 3-10. </span>An HTTP request</h5>&#13;
&#13;
<pre data-type="programlisting">GET /hi HTTP/1.1&#13;
Accept: <strong>/</strong>&#13;
Accept-Encoding: gzip, deflate&#13;
Connection: keep-alive&#13;
Host: localhost:8000&#13;
User-Agent: HTTPie/3.2.1</pre></div>&#13;
&#13;
<p>This request contains the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>The verb (<code>GET</code>) and path (<code>/hi</code>)</p>&#13;
</li>&#13;
<li>&#13;
<p>Any <a data-primary="query parameters" data-type="indexterm" id="id473"/><em>query parameters</em> (text after any <code>?</code>&#13;
in this case, none)</p>&#13;
</li>&#13;
<li>&#13;
<p>Other HTTP headers</p>&#13;
</li>&#13;
<li>&#13;
<p>No request body content</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>FastAPI unsquirrels these into handy definitions:</p>&#13;
<dl>&#13;
<dt><code>Header</code></dt>&#13;
<dd>&#13;
<p>The HTTP headers</p>&#13;
</dd>&#13;
<dt><code>Path</code></dt>&#13;
<dd>&#13;
<p>The URL</p>&#13;
</dd>&#13;
<dt><code>Query</code></dt>&#13;
<dd>&#13;
<p>The query parameters (after the <code>?</code> at the end of the URL)</p>&#13;
</dd>&#13;
<dt><code>Body</code></dt>&#13;
<dd>&#13;
<p>The HTTP body</p>&#13;
</dd>&#13;
</dl>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>The way that FastAPI provides data from&#13;
various parts of the HTTP requests is&#13;
one of its best features and an improvement on&#13;
how most Python web frameworks do it.&#13;
All the arguments that you need can be declared and provided&#13;
directly inside the path function,&#13;
using the definitions in the preceding list (<code>Path</code>, <code>Query</code>, etc.),&#13;
and by functions that you write.&#13;
This uses a technique called<a data-primary="dependency injection" data-type="indexterm" id="id474"/>&#13;
<em>dependency injection</em>,&#13;
which will be discussed as we go along&#13;
and expanded on in <a data-type="xref" href="ch06.html#ch06">Chapter 6</a>.</p>&#13;
</div>&#13;
&#13;
<p>Let’s make our earlier application a little more personal&#13;
by adding a parameter called <code>who</code> that addresses that plaintive&#13;
<code>Hello?</code> to someone. We’ll try different ways to pass this new parameter:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>In the URL <em>path</em></p>&#13;
</li>&#13;
<li>&#13;
<p>As a <em>query</em> parameter, after the <code>?</code> in the URL</p>&#13;
</li>&#13;
<li>&#13;
<p>In the HTTP <em>body</em></p>&#13;
</li>&#13;
<li>&#13;
<p>As an HTTP <em>header</em></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="URL Path" data-type="sect2"><div class="sect2" id="id32">&#13;
<h2>URL Path</h2>&#13;
&#13;
<p><a data-primary="HTTP requests" data-secondary="URL paths" data-type="indexterm" id="icd015"/>Edit <a data-primary="URL paths" data-type="indexterm" id="icd016"/><em>hello.py</em> in <a data-type="xref" href="#ex-3-11">Example 3-11</a>.</p>&#13;
<div data-type="example" id="ex-3-11">&#13;
<h5><span class="label">Example 3-11. </span>Return the greeting path</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">FastAPI</code>&#13;
&#13;
<code class="n">app</code> <code class="o">=</code> <code class="n">FastAPI</code><code class="p">()</code>&#13;
&#13;
<code class="nd">@app</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/hi/</code><code class="si">{who}</code><code class="s2">"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">greet</code><code class="p">(</code><code class="n">who</code><code class="p">):</code>&#13;
    <code class="k">return</code> <code class="sa">f</code><code class="s2">"Hello? </code><code class="si">{</code><code class="n">who</code><code class="si">}</code><code class="s2">?"</code></pre></div>&#13;
&#13;
<p>Once you save this change from your editor,&#13;
Uvicorn should restart.&#13;
(Otherwise, we’d create <em>hello2.py</em>, etc. and&#13;
rerun Uvicorn each time.)&#13;
If you have a typo, keep trying until you fix it,&#13;
and Uvicorn won’t give you a hard time.</p>&#13;
&#13;
<p>Adding that <code>{who}</code> in the URL (after <code>@app.get</code>)&#13;
tells FastAPI&#13;
to expect a variable named <code>who</code> at that&#13;
position in the URL.&#13;
FastAPI then assigns it to the <code>who</code> argument&#13;
in the following <code>greet()</code> function.&#13;
This shows coordination between the path decorator and the&#13;
path function.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Do not use a Python f-string for the amended URL string&#13;
(<code>"/hi/{who}"</code>) here.&#13;
The curly brackets are used by FastAPI itself&#13;
to match URL pieces as path parameters.</p>&#13;
</div>&#13;
&#13;
<p>In Examples <a data-type="xref" data-xrefstyle="select:labelnumber" href="#ex-3-12">3-12</a> through&#13;
<a data-type="xref" data-xrefstyle="select:labelnumber" href="#ex-3-14">3-14</a>,&#13;
test this modified endpoint with the various methods&#13;
discussed earlier.</p>&#13;
<div data-type="example" id="ex-3-12">&#13;
<h5><span class="label">Example 3-12. </span>Test <span class="plain">/hi/Mom</span> in the browser</h5>&#13;
&#13;
<pre data-type="programlisting"><strong>localhost:8000/hi/Mom</strong></pre></div>&#13;
<div data-type="example" id="ex-3-13">&#13;
<h5><span class="label">Example 3-13. </span>Test <span class="plain">/hi/Mom</span> with HTTPie</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http localhost:8000/hi/Mom</strong>&#13;
HTTP/1.1 200 OK&#13;
content-length: 13&#13;
content-type: application/json&#13;
date: Thu, 30 Jun 2022 08:09:02 GMT&#13;
server: uvicorn&#13;
&#13;
"Hello? Mom?"</pre></div>&#13;
<div data-type="example" id="ex-3-14">&#13;
<h5><span class="label">Example 3-14. </span>Test <span class="plain">/hi/Mom</span> with Requests</h5>&#13;
&#13;
<pre data-type="programlisting">&gt;&gt;&gt; <strong>import requests</strong>&#13;
&gt;&gt;&gt; <strong>r = requests.get("http://localhost:8000/hi/Mom")</strong>&#13;
&gt;&gt;&gt; <strong>r.json()</strong>&#13;
'Hello? Mom?'</pre></div>&#13;
&#13;
<p>In each case, the string <code>"Mom"</code> is passed as part of the URL,&#13;
passed to the <code>greet()</code> path function as the <code>who</code> variable,&#13;
and returned as part of the response.</p>&#13;
&#13;
<p>The response in each case is the JSON string&#13;
(with single or double quotes, depending on which&#13;
test client you used)<a data-primary="URL paths" data-startref="icd016" data-type="indexterm" id="id475"/>&#13;
<code>"Hello? Mom?"</code><a data-primary="HTTP requests" data-secondary="URL paths" data-startref="icd015" data-type="indexterm" id="id476"/>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Query Parameters" data-type="sect2"><div class="sect2" id="id33">&#13;
<h2>Query Parameters</h2>&#13;
&#13;
<p><a data-primary="HTTP requests" data-secondary="query parameters" data-type="indexterm" id="icd017"/><em>Query parameters</em><a data-primary="query parameters" data-type="indexterm" id="icd018"/> are the <code><em>name=value</em></code> strings&#13;
after the <code>?</code> in a URL,&#13;
separated by <code>&amp;</code> characters.&#13;
Edit <em>hello.py</em> again in <a data-type="xref" href="#ex-3-15">Example 3-15</a>.</p>&#13;
<div data-type="example" id="ex-3-15">&#13;
<h5><span class="label">Example 3-15. </span>Return the greeting query parameter</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">FastAPI</code>&#13;
&#13;
<code class="n">app</code> <code class="o">=</code> <code class="n">FastAPI</code><code class="p">()</code>&#13;
&#13;
<code class="nd">@app</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/hi"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">greet</code><code class="p">(</code><code class="n">who</code><code class="p">):</code>&#13;
    <code class="k">return</code> <code class="sa">f</code><code class="s2">"Hello? </code><code class="si">{</code><code class="n">who</code><code class="si">}</code><code class="s2">?"</code></pre></div>&#13;
&#13;
<p>The endpoint function is defined as <code>greet(who)</code> again,&#13;
but <code>{who}</code> isn’t in the URL on the previous decorator line this time,&#13;
so FastAPI now assumes that <code>who</code> is a query parameter.&#13;
Test with Examples <a data-type="xref" data-xrefstyle="select:labelnumber" href="#ex-3-16">3-16</a> and&#13;
<a data-type="xref" data-xrefstyle="select:labelnumber" href="#ex-3-17">3-17</a>.</p>&#13;
<div data-type="example" id="ex-3-16">&#13;
<h5><span class="label">Example 3-16. </span>Test <a data-type="xref" href="#ex-3-15">Example 3-15</a> with your browser</h5>&#13;
&#13;
<pre data-type="programlisting"><strong>localhost:8000/hi?who=Mom</strong></pre></div>&#13;
<div data-type="example" id="ex-3-17">&#13;
<h5><span class="label">Example 3-17. </span>Test <a data-type="xref" href="#ex-3-15">Example 3-15</a> with HTTPie</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http -b localhost:8000/hi?who=Mom</strong>&#13;
"Hello? Mom?"</pre></div>&#13;
&#13;
<p>In <a data-type="xref" href="#ex-3-18">Example 3-18</a>,&#13;
you can call&#13;
<a data-primary="HTTPie" data-secondary="calling with query parameter arguments" data-type="indexterm" id="id477"/>HTTPie with a query parameter argument&#13;
(note the <code>==</code>).</p>&#13;
<div data-type="example" id="ex-3-18">&#13;
<h5><span class="label">Example 3-18. </span>Test <a data-type="xref" href="#ex-3-15">Example 3-15</a> with HTTPie and params</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http -b localhost:8000/hi who==Mom</strong>&#13;
"Hello? Mom?"</pre></div>&#13;
&#13;
<p>You can have more than one of these arguments for HTTPie,&#13;
and it’s easier to type these as space-separated arguments.</p>&#13;
&#13;
<p>Examples <a data-type="xref" data-xrefstyle="select:labelnumber" href="#ex-3-19">3-19</a> and&#13;
<a data-type="xref" data-xrefstyle="select:labelnumber" href="#ex-3-20">3-20</a> show the same alternatives for Requests.</p>&#13;
<div data-type="example" id="ex-3-19">&#13;
<h5><span class="label">Example 3-19. </span>Test <a data-type="xref" href="#ex-3-15">Example 3-15</a> with Requests</h5>&#13;
&#13;
<pre data-type="programlisting">&gt;&gt;&gt; <strong>import requests</strong>&#13;
&gt;&gt;&gt; <strong>r = requests.get("http://localhost:8000/hi?who=Mom")</strong>&#13;
&gt;&gt;&gt; <strong>r.json()</strong>&#13;
'Hello? Mom?'</pre></div>&#13;
<div data-type="example" id="ex-3-20">&#13;
<h5><span class="label">Example 3-20. </span>Test <a data-type="xref" href="#ex-3-15">Example 3-15</a> with Requests and params</h5>&#13;
&#13;
<pre data-type="programlisting">&gt;&gt;&gt; <strong>import requests</strong>&#13;
&gt;&gt;&gt; params = {"who": "Mom"}&#13;
&gt;&gt;&gt; <strong>r = requests.get("http://localhost:8000/hi", params=params)</strong>&#13;
&gt;&gt;&gt; <strong>r.json()</strong>&#13;
'Hello? Mom?'</pre></div>&#13;
&#13;
<p>In each case, you provide the <code>"Mom"</code> string in a new way,&#13;
and get it to the path function and through to the eventual <a data-primary="query parameters" data-startref="icd018" data-type="indexterm" id="id478"/>response<a data-primary="HTTP requests" data-secondary="query parameters" data-startref="icd017" data-type="indexterm" id="id479"/>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Body" data-type="sect2"><div class="sect2" id="id34">&#13;
<h2>Body</h2>&#13;
&#13;
<p><a data-primary="HTTP requests" data-secondary="body" data-type="indexterm" id="icd019"/>We can provide path or query parameters to&#13;
a <code>GET</code> endpoint,&#13;
but not values from the request body.&#13;
In HTTP, <code>GET</code> is supposed to be&#13;
<em>idempotent</em><a data-primary="idempotency" data-type="indexterm" id="id480"/>—a computery term for <em>ask the same question, get the same answer</em>.&#13;
HTTP <code>GET</code> is supposed to only return stuff.&#13;
The request body is used to send stuff to the server&#13;
when creating (<code>POST</code>)&#13;
or updating (<code>PUT</code> or <code>PATCH</code>).&#13;
<a data-type="xref" href="ch09.html#ch09">Chapter 9</a> shows a way around this.</p>&#13;
&#13;
<p>So, in <a data-type="xref" href="#ex-3-21">Example 3-21</a>,&#13;
let’s change the endpoint from a <code>GET</code> to a&#13;
<code>POST</code>.&#13;
(Technically, we’re not creating anything,&#13;
so a <code>POST</code> isn’t kosher,&#13;
but if the RESTful Overlords sue us,&#13;
then hey, check out the cool courthouse.)</p>&#13;
<div data-type="example" id="ex-3-21">&#13;
<h5><span class="label">Example 3-21. </span>Return the greeting body</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">FastAPI</code><code class="p">,</code> <code class="n">Body</code>&#13;
&#13;
<code class="n">app</code> <code class="o">=</code> <code class="n">FastAPI</code><code class="p">()</code>&#13;
&#13;
<code class="nd">@app</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"/hi"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">greet</code><code class="p">(</code><code class="n">who</code><code class="p">:</code><code class="nb">str</code> <code class="o">=</code> <code class="n">Body</code><code class="p">(</code><code class="n">embed</code><code class="o">=</code><code class="kc">True</code><code class="p">)):</code>&#13;
    <code class="k">return</code> <code class="sa">f</code><code class="s2">"Hello? </code><code class="si">{</code><code class="n">who</code><code class="si">}</code><code class="s2">?"</code></pre></div>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>That <code>Body(embed=True)</code> is needed&#13;
to tell FastAPI that, this time,&#13;
we get the value of <code>who</code> from the JSON-formatted&#13;
request body.&#13;
The <code>embed</code> part means that it should look like <code>{"who": "Mom"}</code>&#13;
rather than just <code>"Mom"</code>.</p>&#13;
</div>&#13;
&#13;
<p>Try testing with HTTPie in <a data-type="xref" href="#ex-3-22">Example 3-22</a>,&#13;
using <code>-v</code> to show the generated&#13;
request body&#13;
(and note the single <code>=</code> parameter to indicate&#13;
JSON body data).</p>&#13;
<div data-type="example" id="ex-3-22">&#13;
<h5><span class="label">Example 3-22. </span>Test <a data-type="xref" href="#ex-3-21">Example 3-21</a> with HTTPie</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http -v localhost:8000/hi who=Mom</strong>&#13;
POST /hi HTTP/1.1&#13;
Accept: application/json, <strong>/</strong>;q=0.5&#13;
Accept-Encoding: gzip, deflate&#13;
Connection: keep-alive&#13;
Content-Length: 14&#13;
Content-Type: application/json&#13;
Host: localhost:8000&#13;
User-Agent: HTTPie/3.2.1&#13;
&#13;
&#13;
{&#13;
    "who": "Mom"&#13;
}&#13;
&#13;
&#13;
HTTP/1.1 200 OK&#13;
content-length: 13&#13;
content-type: application/json&#13;
date: Thu, 30 Jun 2022 08:37:00 GMT&#13;
server: uvicorn&#13;
&#13;
"Hello? Mom?"</pre></div>&#13;
&#13;
<p>And finally, test with Requests in <a data-type="xref" href="#ex-3-23">Example 3-23</a>,&#13;
which uses its <code>json</code> argument to pass JSON-encoded&#13;
data in the request body.<a data-primary="HTTP requests" data-secondary="body" data-startref="icd019" data-type="indexterm" id="id481"/></p>&#13;
<div data-type="example" id="ex-3-23">&#13;
<h5><span class="label">Example 3-23. </span>Test <a data-type="xref" href="#ex-3-21">Example 3-21</a> with Requests</h5>&#13;
&#13;
<pre data-type="programlisting">&gt;&gt;&gt; <strong>import requests</strong>&#13;
&gt;&gt;&gt; <strong>r = requests.post("http://localhost:8000/hi", json={"who": "Mom"})</strong>&#13;
&gt;&gt;&gt; <strong>r.json()</strong>&#13;
'Hello? Mom?'</pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="HTTP Header" data-type="sect2"><div class="sect2" id="id177">&#13;
<h2>HTTP Header</h2>&#13;
&#13;
<p><a data-primary="HTTP requests" data-secondary="headers" data-type="indexterm" id="icd020"/>Finally, let’s try passing the greeting argument&#13;
as an HTTP header&#13;
in <a data-type="xref" href="#ex-3-24">Example 3-24</a>.</p>&#13;
<div data-type="example" id="ex-3-24">&#13;
<h5><span class="label">Example 3-24. </span>Return the greeting header</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">FastAPI</code><code class="p">,</code> <code class="n">Header</code>&#13;
&#13;
<code class="n">app</code> <code class="o">=</code> <code class="n">FastAPI</code><code class="p">()</code>&#13;
&#13;
<code class="nd">@app</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"/hi"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">greet</code><code class="p">(</code><code class="n">who</code><code class="p">:</code><code class="nb">str</code> <code class="o">=</code> <code class="n">Header</code><code class="p">()):</code>&#13;
    <code class="k">return</code> <code class="sa">f</code><code class="s2">"Hello? </code><code class="si">{</code><code class="n">who</code><code class="si">}</code><code class="s2">?"</code></pre></div>&#13;
&#13;
<p>Let’s test this one just with HTTPie in <a data-type="xref" href="#ex-3-25">Example 3-25</a>.&#13;
It uses <code><em>name:value</em></code> to specify an HTTP header.</p>&#13;
<div data-type="example" id="ex-3-25">&#13;
<h5><span class="label">Example 3-25. </span>Test <a data-type="xref" href="#ex-3-24">Example 3-24</a> with HTTPie</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http -v localhost:8000/hi who:Mom</strong>&#13;
GET /hi HTTP/1.1&#13;
Accept: */\*&#13;
Accept-Encoding: gzip, deflate&#13;
Connection: keep-alive&#13;
Host: localhost:8000&#13;
User-Agent: HTTPie/3.2.1&#13;
who: Mom&#13;
&#13;
HTTP/1.1 200 OK&#13;
content-length: 13&#13;
content-type: application/json&#13;
date: Mon, 16 Jan 2023 05:14:46 GMT&#13;
server: uvicorn&#13;
&#13;
"Hello? Mom?"</pre></div>&#13;
&#13;
<p>FastAPI converts HTTP header keys to lowercase,&#13;
and converts a hyphen (<code>-</code>) to an underscore (<code>_</code>).&#13;
So you could print the value of the HTTP&#13;
<code>User-Agent</code> header like this in Examples <a data-type="xref" data-xrefstyle="select:labelnumber" href="#ex-3-26">3-26</a> and&#13;
<a data-type="xref" data-xrefstyle="select:labelnumber" href="#ex-3-27">3-27</a>.<a data-primary="HTTP requests" data-secondary="headers" data-startref="icd020" data-type="indexterm" id="id482"/></p>&#13;
<div data-type="example" id="ex-3-26">&#13;
<h5><span class="label">Example 3-26. </span>Return the <code>User-Agent</code> header (<span class="plain">hello.py</span>)</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">FastAPI</code><code class="p">,</code> <code class="n">Header</code>&#13;
&#13;
<code class="n">app</code> <code class="o">=</code> <code class="n">FastAPI</code><code class="p">()</code>&#13;
&#13;
<code class="nd">@app</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"/agent"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">get_agent</code><code class="p">(</code><code class="n">user_agent</code><code class="p">:</code><code class="nb">str</code> <code class="o">=</code> <code class="n">Header</code><code class="p">()):</code>&#13;
    <code class="k">return</code> <code class="n">user_agent</code></pre></div>&#13;
<div data-type="example" id="ex-3-27">&#13;
<h5><span class="label">Example 3-27. </span>Test the <code>User-Agent</code> header with HTTPie</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http -v localhost:8000/agent</strong>&#13;
GET /agent HTTP/1.1&#13;
Accept: */\*&#13;
Accept-Encoding: gzip, deflate&#13;
Connection: keep-alive&#13;
Host: localhost:8000&#13;
User-Agent: HTTPie/3.2.1&#13;
&#13;
&#13;
&#13;
HTTP/1.1 200 OK&#13;
content-length: 14&#13;
content-type: application/json&#13;
date: Mon, 16 Jan 2023 05:21:35 GMT&#13;
server: uvicorn&#13;
&#13;
"HTTPie/3.2.1"</pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Multiple Request Data" data-type="sect2"><div class="sect2" id="id178">&#13;
<h2>Multiple Request Data</h2>&#13;
&#13;
<p><a data-primary="HTTP requests" data-secondary="multiple request data" data-type="indexterm" id="id483"/>You can use more than one of these methods&#13;
in the same path function.&#13;
That is, you can get data from&#13;
the URL, query parameters, the HTTP body, HTTP headers,&#13;
cookies, and so on.&#13;
And you can write your own dependency functions&#13;
that process and combine them in special ways,&#13;
such as for pagination or authentication.&#13;
You’ll see some of these in <a data-type="xref" href="ch06.html#ch06">Chapter 6</a>&#13;
and in various chapters in <a data-type="xref" href="part03.html#part3">Part III</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Which Method Is Best?" data-type="sect2"><div class="sect2" id="id35">&#13;
<h2>Which Method Is Best?</h2>&#13;
&#13;
<p>Here are a few recommendations:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>When passing arguments in the URL, following&#13;
RESTful guidelines is standard practice.</p>&#13;
</li>&#13;
<li>&#13;
<p>Query strings are usually used to provide optional arguments,&#13;
like pagination.</p>&#13;
</li>&#13;
<li>&#13;
<p>The body is usually used for larger inputs,&#13;
like whole or partial models.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>In each case,&#13;
if you provide type hints in your data definitions,&#13;
your arguments will be automatically type-checked by Pydantic.&#13;
This ensures that they’re both present and <a data-primary="FastAPI" data-secondary="HTTP requests" data-startref="icd027" data-type="indexterm" id="id484"/>correct<a data-primary="HTTP requests" data-startref="icd014" data-type="indexterm" id="id485"/>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="HTTP Responses" data-type="sect1"><div class="sect1" id="id36">&#13;
<h1>HTTP Responses</h1>&#13;
&#13;
<p><a data-primary="HTTP responses" data-type="indexterm" id="icd021"/>By <a data-primary="FastAPI" data-secondary="HTTP responses" data-type="indexterm" id="icd026"/>default,&#13;
FastAPI converts whatever you return&#13;
from your endpoint function&#13;
to JSON; the HTTP&#13;
response has a header line&#13;
<code>Content-type: application/json</code>.&#13;
So, although the <code>greet()</code> function&#13;
initially returns the string <code>"Hello? World?"</code>,&#13;
<span class="keep-together">FastAPI</span> converts it to JSON.&#13;
This is one of the defaults chosen by FastAPI&#13;
to streamline API development.</p>&#13;
&#13;
<p>In this case,&#13;
the Python string <code>"Hello? World?"</code>&#13;
is converted to its equivalent JSON string <code>"Hello? World?"</code>,&#13;
which is the same darn string.&#13;
But anything that you return is converted to JSON,&#13;
whether built-in Python types or Pydantic models.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Status Code" data-type="sect2"><div class="sect2" id="id179">&#13;
<h2>Status Code</h2>&#13;
&#13;
<p>B<a data-primary="HTTP responses" data-secondary="status codes" data-type="indexterm" id="id486"/>y default, FastAPI returns a <code>200</code> status code;&#13;
exceptions raise <code>4<em>xx</em></code> codes.</p>&#13;
&#13;
<p>In the path decorator,&#13;
specify the HTTP status code that should be returned&#13;
if all goes well&#13;
(exceptions will generate their own codes and override it).&#13;
Add the code from <a data-type="xref" href="#ex-3-28">Example 3-28</a>&#13;
somewhere in your <em>hello.py</em>&#13;
(just to avoid showing the whole file again and again),&#13;
and test it with <a data-type="xref" href="#ex-3-29">Example 3-29</a>.</p>&#13;
<div data-type="example" id="ex-3-28">&#13;
<h5><span class="label">Example 3-28. </span>Specify the HTTP status code (add to <span class="plain">hello.py</span>)</h5>&#13;
&#13;
<pre data-type="programlisting">@app.get("/happy")&#13;
def happy(status_code=200):&#13;
    return ":)"</pre></div>&#13;
<div data-type="example" id="ex-3-29">&#13;
<h5><span class="label">Example 3-29. </span>Test the HTTP status code</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http localhost:8000/happy</strong>&#13;
HTTP/1.1 200 OK&#13;
content-length: 4&#13;
content-type: application/json&#13;
date: Sun, 05 Feb 2023 04:37:32 GMT&#13;
server: uvicorn&#13;
&#13;
":)"</pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Headers" data-type="sect2"><div class="sect2" id="id180">&#13;
<h2>Headers</h2>&#13;
&#13;
<p><a data-primary="HTTP responses" data-secondary="headers" data-type="indexterm" id="id487"/>You can inject HTTP response headers,&#13;
as in <a data-type="xref" href="#ex-3-30">Example 3-30</a> (you don’t need to return <code>response</code>).</p>&#13;
<div data-type="example" id="ex-3-30">&#13;
<h5><span class="label">Example 3-30. </span>Set the HTTP headers (add to <span class="plain">hello.py</span>)</h5>&#13;
&#13;
<pre data-type="programlisting">from fastapi import Response&#13;
&#13;
@app.get("/header/{name}/{value}")&#13;
def header(name: str, value: str, response:Response):&#13;
    response.headers[name] = value&#13;
    return "normal body"</pre></div>&#13;
&#13;
<p>Let’s see if it worked (<a data-type="xref" href="#ex-3-31">Example 3-31</a>).</p>&#13;
<div data-type="example" id="ex-3-31">&#13;
<h5><span class="label">Example 3-31. </span>Test the response HTTP headers</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http localhost:8000/header/marco/polo</strong>&#13;
HTTP/1.1 200 OK&#13;
content-length: 13&#13;
content-type: application/json&#13;
date: Wed, 31 May 2023 17:47:38 GMT&#13;
marco: polo&#13;
server: uvicorn&#13;
&#13;
"normal body"</pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Response Types" data-type="sect2"><div class="sect2" id="id37">&#13;
<h2>Response Types</h2>&#13;
&#13;
<p><a data-primary="HTTP responses" data-secondary="types of" data-type="indexterm" id="icd022"/>Response types&#13;
(import these classes from <code>fastapi.responses</code>)&#13;
include the <span class="keep-together">following</span>:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><code>JSONResponse</code> (the default)</p>&#13;
</li>&#13;
<li>&#13;
<p><code>HTMLResponse</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>PlainTextResponse</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>RedirectResponse</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>FileResponse</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>StreamingResponse</code></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>I’ll say more about the last two in <a data-type="xref" href="ch15.html#ch15">Chapter 15</a>.</p>&#13;
&#13;
<p>For other output formats&#13;
(also known as<a data-primary="MIME types" data-type="indexterm" id="id488"/> <em>MIME types</em>), you can use a generic <code>Response</code> class, which needs the following:</p>&#13;
<dl>&#13;
<dt><code>content</code></dt>&#13;
<dd>&#13;
<p>String or bytes</p>&#13;
</dd>&#13;
<dt><code>media_type</code></dt>&#13;
<dd>&#13;
<p>The string MIME type</p>&#13;
</dd>&#13;
<dt><code>status_code</code></dt>&#13;
<dd>&#13;
<p>HTTP integer status code</p>&#13;
</dd>&#13;
<dt><code>headers</code></dt>&#13;
<dd>&#13;
<p>A <code>dict</code> of strings<a data-primary="HTTP responses" data-secondary="types of" data-startref="icd022" data-type="indexterm" id="id489"/></p>&#13;
</dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Type Conversion" data-type="sect2"><div class="sect2" id="id181">&#13;
<h2>Type Conversion</h2>&#13;
&#13;
<p><a data-primary="HTTP responses" data-secondary="type conversion" data-type="indexterm" id="id490"/>The path function can return anything, and by default&#13;
(using <code>JSONResponse</code>),&#13;
FastAPI will convert it to a <a data-primary="JSON (JavaScript Object Notation)" data-secondary="type conversion" data-type="indexterm" id="id491"/>JSON string and return it,&#13;
with the matching HTTP response headers&#13;
<code>Content-Length</code> and <code>Content-Type</code>.&#13;
This includes any Pydantic model class.</p>&#13;
&#13;
<p>But how does it do this?&#13;
If you’ve used the Python json library,&#13;
you’ve probably seen that it raises an exception&#13;
when given some data types,&#13;
such as <code>datetime</code>.&#13;
FastAPI uses an internal function called <code>jsonable_encoder()</code>&#13;
to convert any data structure to&#13;
a “JSONable” Python data structure,&#13;
then calls the usual <code>json.dumps()</code> to turn that&#13;
into a JSON string.&#13;
<a data-type="xref" href="#ex-3-32">Example 3-32</a> shows a test that you can run with pytest.</p>&#13;
<div data-type="example" id="ex-3-32">&#13;
<h5><span class="label">Example 3-32. </span>Use <code>jsonable_encoder()</code> to avoid JSON kabooms</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">datetime</code>&#13;
<code class="kn">import</code> <code class="nn">pytest</code>&#13;
<code class="kn">from</code> <code class="nn">fastapi.encoders</code> <code class="kn">import</code> <code class="n">jsonable_encoder</code>&#13;
<code class="kn">import</code> <code class="nn">json</code>&#13;
&#13;
<code class="nd">@pytest</code><code class="o">.</code><code class="n">fixture</code>&#13;
<code class="k">def</code> <code class="nf">data</code><code class="p">():</code>&#13;
    <code class="k">return</code> <code class="n">datetime</code><code class="o">.</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">()</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_json_dump</code><code class="p">(</code><code class="n">data</code><code class="p">):</code>&#13;
    <code class="k">with</code> <code class="n">pytest</code><code class="o">.</code><code class="n">raises</code><code class="p">(</code><code class="ne">Exception</code><code class="p">):</code>&#13;
        <code class="n">_</code> <code class="o">=</code> <code class="n">json</code><code class="o">.</code><code class="n">dumps</code><code class="p">(</code><code class="n">data</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_encoder</code><code class="p">(</code><code class="n">data</code><code class="p">):</code>&#13;
    <code class="n">out</code> <code class="o">=</code> <code class="n">jsonable_encoder</code><code class="p">(</code><code class="n">data</code><code class="p">)</code>&#13;
    <code class="k">assert</code> <code class="n">out</code>&#13;
    <code class="n">json_out</code> <code class="o">=</code> <code class="n">json</code><code class="o">.</code><code class="n">dumps</code><code class="p">(</code><code class="n">out</code><code class="p">)</code>&#13;
    <code class="k">assert</code> <code class="n">json_out</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Model Types and response_model" data-type="sect2"><div class="sect2" id="id38">&#13;
<h2>Model Types and response_model</h2>&#13;
&#13;
<p><a data-primary="HTTP responses" data-secondary="model types" data-type="indexterm" id="icd024"/>It’s possible to have different classes with many of&#13;
the same fields,&#13;
except one is specialized for user input, one for output, and one&#13;
for internal use. Some reasons for these variants could include the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Remove some sensitive information from the output—like <em>deidentifying</em> personal medical data,&#13;
if you’ve encountered Health Insurance Portability and Accountability Act (HIPAA) requirements.</p>&#13;
</li>&#13;
<li>&#13;
<p>Add fields to the user input (like a creation date and time).</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p><a data-type="xref" href="#ex-3-33">Example 3-33</a> shows three related classes&#13;
for a contrived case:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><code>TagIn</code> is the class that defines what the user needs to provide&#13;
(in this case, just a string called <code>tag</code>).</p>&#13;
</li>&#13;
<li>&#13;
<p><code>Tag</code> is made from a <code>TagIn</code> and adds two fields:&#13;
<code>created</code> (when this <code>Tag</code> was created) and <code>secret</code> (an internal&#13;
string, maybe stored in a database, but never supposed to&#13;
be exposed to the world).</p>&#13;
</li>&#13;
<li>&#13;
<p><code>TagOut</code> is the class that defines what can be returned to a user&#13;
(by a lookup or search endpoint). It contains the&#13;
<code>tag</code> field from the original <code>TagIn</code> object and its derived&#13;
<code>Tag</code> object, plus the <code>created</code> field generated for <code>Tag</code>,&#13;
but not <code>secret</code>.</p>&#13;
</li>&#13;
</ul>&#13;
<div data-type="example" id="ex-3-33">&#13;
<h5><span class="label">Example 3-33. </span>Model variations (<span class="plain">model/tag.py</span>)</h5>&#13;
&#13;
<pre data-type="programlisting">from datetime import datetime&#13;
from pydantic import BaseClass&#13;
&#13;
class TagIn(BaseClass):&#13;
    tag: str&#13;
&#13;
class Tag(BaseClass):&#13;
    tag: str&#13;
    created: datetime&#13;
    secret: str&#13;
&#13;
class TagOut(BaseClass):&#13;
    tag: str&#13;
    created: datetime</pre></div>&#13;
&#13;
<p>You can return data types other than the default JSON&#13;
from a FastAPI path function in different ways.&#13;
<a data-primary="response_model argument" data-type="indexterm" id="id492"/>One method is to&#13;
use the <code>response_model</code> argument in the path decorator to goose&#13;
FastAPI to return something else.&#13;
FastAPI will drop any fields that were in the object that&#13;
you returned but are not in the object specified by&#13;
<code>response_model</code>.</p>&#13;
&#13;
<p>In <a data-type="xref" href="#ex-3-34">Example 3-34</a>, pretend that you wrote a new service module&#13;
called <em>service/tag.py</em>&#13;
with the <code>create()</code> and <code>get()</code> functions&#13;
that give this web module something to call.&#13;
Those lower-stack details don’t matter here.&#13;
The important point is the <code>get_one()</code> path function at the bottom,&#13;
and the <code>response_model=TagOut</code> in its path decorator.&#13;
That automatically changes an internal <code>Tag</code> object&#13;
to a sanitized <code>TagOut</code> object.</p>&#13;
<div data-type="example" id="ex-3-34">&#13;
<h5><span class="label">Example 3-34. </span>Return a different response type with <code>response_model</code> (<span class="plain">web/tag.py</span>)</h5>&#13;
&#13;
<pre data-type="programlisting">import datetime&#13;
from model.tag import TagIn, Tag, TagOut&#13;
import service.tag as service&#13;
&#13;
@app.post('/')&#13;
def create(tag_in: TagIn) -&gt; TagIn:&#13;
    tag: Tag = Tag(tag=tag_in.tag, created=datetime.utcnow(),&#13;
        secret="shhhh")&#13;
    service.create(tag)&#13;
    return tag_in&#13;
&#13;
@app.get('/{tag_str}', response_model=TagOut)&#13;
def get_one(tag_str: str) -&gt; TagOut:&#13;
    tag: Tag = service.get(tag_str)&#13;
    return tag</pre></div>&#13;
&#13;
<p>Even though we returned a <code>Tag</code>,&#13;
<code>response_model</code> will convert it to <a data-primary="FastAPI" data-secondary="HTTP responses" data-startref="icd026" data-type="indexterm" id="id493"/>a <a data-primary="HTTP responses" data-secondary="model types" data-startref="icd024" data-type="indexterm" id="id494"/><code>TagOut</code><a data-primary="HTTP responses" data-startref="icd021" data-type="indexterm" id="id495"/>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Automated Documentation" data-type="sect1"><div class="sect1" id="id39">&#13;
<h1>Automated Documentation</h1>&#13;
&#13;
<p>This section assumes that you’re running the web application from <a data-type="xref" href="#ex-3-21">Example 3-21</a>,&#13;
the version that sends the <code>who</code> parameter in the HTTP body&#13;
via a POST request to <em>http://localhost:8000/hi</em>.</p>&#13;
&#13;
<p><a data-primary="FastAPI" data-secondary="automated documentation" data-type="indexterm" id="icd025"/>Convince <a data-primary="automated documentation" data-type="indexterm" id="icd028"/>your browser to visit the URL&#13;
<strong><code>http://localhost:8000/docs</code></strong>.</p>&#13;
&#13;
<p>You’ll see something that starts like <a data-type="xref" href="#fig-03-1">Figure 3-1</a>&#13;
(I’ve cropped the following screenshots to emphasize&#13;
particular areas).</p>&#13;
&#13;
<figure><div class="figure" id="fig-03-1">&#13;
<img alt="Docs Page" src="assets/fapi_0301.png"/>&#13;
<h6><span class="label">Figure 3-1. </span>Generated documentation page</h6>&#13;
</div></figure>&#13;
&#13;
<p>Where did that come from?</p>&#13;
&#13;
<p>FastAPI generates an OpenAPI specification from your code,&#13;
and includes this page to display <em>and test</em>&#13;
all your endpoints.&#13;
This is just one ingredient of its secret sauce.</p>&#13;
&#13;
<p>Click the down arrow on the right side&#13;
of the green box&#13;
to open it for testing (<a data-type="xref" href="#fig-03-2">Figure 3-2</a>).</p>&#13;
&#13;
<figure><div class="figure" id="fig-03-2">&#13;
<img alt="Docs Page" src="assets/fapi_0302.png"/>&#13;
<h6><span class="label">Figure 3-2. </span>Open documentation page</h6>&#13;
</div></figure>&#13;
&#13;
<p class="pagebreak-before">Click that “Try it out” button on the right.&#13;
Now you’ll see an area that will let you enter a value&#13;
in the body section (<a data-type="xref" href="#fig-03-3">Figure 3-3</a>).</p>&#13;
&#13;
<figure><div class="figure" id="fig-03-3">&#13;
<img alt="Docs Page" src="assets/fapi_0303.png"/>&#13;
<h6><span class="label">Figure 3-3. </span>Data entry page</h6>&#13;
</div></figure>&#13;
&#13;
<p>Click that <code>"string"</code>.&#13;
Change it to <code><strong>"Cousin Eddie"</strong></code>&#13;
(keep the double quotes around it).&#13;
Then click the bottom blue Execute button.</p>&#13;
&#13;
<p>Now look at the Responses section below the Execute button (<a data-type="xref" href="#fig-03-4">Figure 3-4</a>).</p>&#13;
&#13;
<p>The “Response body” box shows that Cousin Eddie turned up.</p>&#13;
&#13;
<p>So, this is yet another way to test the site&#13;
(besides the earlier&#13;
examples using the browser, HTTPie, and Requests).</p>&#13;
&#13;
<figure><div class="figure" id="fig-03-4">&#13;
<img alt="Docs Page" src="assets/fapi_0304.png"/>&#13;
<h6><span class="label">Figure 3-4. </span>Response page</h6>&#13;
</div></figure>&#13;
&#13;
<p>By the way, as you can see in the Curl box&#13;
of the Responses display,&#13;
using curl for command-line testing&#13;
instead of HTTPie would have required more typing.&#13;
HTTPie’s automatic JSON encoding helps here.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>This automated documentation is actually a big, furry deal.&#13;
As your web service grows to hundreds of endpoints,&#13;
a documentation and testing page that’s always up-to-date&#13;
is <a data-primary="automated documentation" data-startref="icd028" data-type="indexterm" id="id496"/>helpful<a data-primary="FastAPI" data-secondary="automated documetation" data-startref="icd025" data-type="indexterm" id="id497"/>.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before less_space" data-pdf-bookmark="Complex Data" data-type="sect1"><div class="sect1" id="id40">&#13;
<h1>Complex Data</h1>&#13;
&#13;
<p>These examples showed only how to pass a single string to an endpoint.&#13;
Many endpoints, especially <code>GET</code> or <code>DELETE</code> ones,&#13;
may need no arguments at all,&#13;
or only a few simple ones, like strings and numbers.&#13;
But when creating (<code>POST</code>) or&#13;
modifying (<code>PUT</code> or <code>PATCH</code>)&#13;
a resource,&#13;
we usually need more complex data structures.&#13;
<a data-type="xref" href="ch05.html#ch05">Chapter 5</a> shows how FastAPI uses Pydantic and data models&#13;
to implement these cleanly<a data-primary="FastAPI" data-startref="icd012" data-type="indexterm" id="id498"/>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Review" data-type="sect1"><div class="sect1" id="id301">&#13;
<h1>Review</h1>&#13;
&#13;
<p>In this chapter, we used FastAPI to create a website with a single endpoint.&#13;
Multiple web clients tested it: a web browser,&#13;
the HTTPie text program, the Requests Python package,&#13;
and the HTTPX Python package.&#13;
Starting with a simple <code>GET</code> call,&#13;
request arguments went to the server via&#13;
the URL path,&#13;
a query parameter,&#13;
and an HTTP header.&#13;
Then, the HTTP body was used to send data to a <code>POST</code> endpoint.&#13;
Later, the chapter showed how to return various HTTP response types.&#13;
Finally, an automatically generated form page provided both&#13;
documentation and live forms for a fourth test client.</p>&#13;
&#13;
<p>This FastAPI overview will be expanded in <a data-type="xref" href="ch08.html#ch08">Chapter 8</a>.</p>&#13;
</div></section>&#13;
</div></section></body></html>