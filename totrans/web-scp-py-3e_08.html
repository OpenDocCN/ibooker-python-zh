<html><head></head><body><section data-pdf-bookmark="Chapter 7. Web Crawling Models" data-type="chapter" epub:type="chapter"><div class="chapter" id="c-7">&#13;
<h1><span class="label">Chapter 7. </span>Web Crawling Models</h1>&#13;
&#13;
<p>Writing clean, scalable code is difficult enough when you have control over your data and your inputs. Writing code for web crawlers, which may need to scrape and store a variety of data from diverse sets of websites that the programmer has no control over, often presents unique organizational challenges.</p>&#13;
&#13;
<p>You may be asked to collect news articles or blog posts from a variety of websites, each with different templates and layouts. One website’s <code>h1</code> tag contains the title of the article, another’s <code>h1</code> tag contains the title of the website itself, and the article title is in <code>&lt;span id="title"&gt;</code>.</p>&#13;
&#13;
<p>You may need flexible control over which websites are scraped and how they’re scraped, and a way to quickly add new websites or modify existing ones, as fast as possible without writing multiple lines of code.</p>&#13;
&#13;
<p>You may be asked to scrape product prices from different websites, with the ultimate aim of comparing prices for the same product. Perhaps these prices are in different currencies, and perhaps you’ll also need to combine this with external data from some other nonweb source.</p>&#13;
&#13;
<p>Although the applications of web crawlers are nearly endless, large scalable crawlers tend to fall into one of several patterns. By learning these patterns and recognizing the situations they apply to, you can vastly improve the maintainability and robustness of your web crawlers.</p>&#13;
&#13;
<p>This chapter focuses primarily on web crawlers that collect a limited number of “types” of data (such as restaurant reviews, news articles, company profiles) from a variety of websites and store these data types as Python objects that read and write from a database.</p>&#13;
&#13;
<section data-pdf-bookmark="Planning and Defining Objects" data-type="sect1"><div class="sect1" id="id45">&#13;
<h1>Planning and Defining Objects</h1>&#13;
&#13;
<p>One common trap of web scraping is defining <a contenteditable="false" data-primary="objects, planning and defining" data-type="indexterm" id="bjcdf"/>the data that you want to collect based entirely on what’s available in front of your eyes. For instance, if you want to collect product data, you may first look at a clothing store and decide that each product you scrape needs to have the following fields:</p>&#13;
&#13;
<ul>&#13;
	<li>&#13;
	<p>Product name</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Price</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Description</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Sizes</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Colors</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Fabric type</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Customer rating</p>&#13;
	</li>&#13;
</ul>&#13;
&#13;
<p>Looking at another website, you find that <a contenteditable="false" data-primary="SKU (stock-keeping unit)" data-type="indexterm" id="id496"/>it has SKUs (stock-keeping units, used to track and order items) listed on the page. You definitely want to collect that data as well, even if it doesn’t appear on the first site! You add this field:</p>&#13;
&#13;
<ul>&#13;
	<li>&#13;
	<p>Item SKU</p>&#13;
	</li>&#13;
</ul>&#13;
&#13;
<p>Although clothing may be a great start, you also want to make sure you can extend this crawler to other types of products. You start perusing product sections of other websites and decide you also need to collect this information:</p>&#13;
&#13;
<ul>&#13;
	<li>&#13;
	<p>Hardcover/paperback</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Matte/glossy print</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Number of customer reviews</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Link to manufacturer</p>&#13;
	</li>&#13;
</ul>&#13;
&#13;
<p>Clearly, this is an unsustainable approach. Simply adding attributes to your product type every time you see a new piece of information on a website will lead to far too many fields to keep track of. Not only that, but every time you scrape a new website, you’ll be forced to perform a detailed analysis of the fields the website has and the fields you’ve accumulated so far, and potentially add new fields (modifying your Python object type and your database structure). This will result in a messy and difficult-to-read dataset that may lead to problems using it.</p>&#13;
&#13;
<p>One of the best things you can do when deciding which data to collect is often to ignore the websites altogether. You don’t start a project that’s designed to be large and scalable by looking at a single website and saying, “What exists?” but by saying, “What do I need?” and then finding ways to seek the information that you need from there.</p>&#13;
&#13;
<p>Perhaps what you really want to do is compare product prices among multiple stores and track those product prices over time. In this case, you need enough information to uniquely identify the product, and that’s it:</p>&#13;
&#13;
<ul>&#13;
	<li>&#13;
	<p>Product title</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Manufacturer</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Product ID number (if available/relevant)</p>&#13;
	</li>&#13;
</ul>&#13;
&#13;
<p>It’s important to note that none of this information is specific to a particular store. For instance, product reviews, ratings, price, and even description are specific to the instance of that product at a particular store. That can be stored separately.</p>&#13;
&#13;
<p>Other information (colors the product comes in, what it’s made of) is specific to the product but may be sparse—it’s not applicable to every product. It’s important to take a step back and perform a checklist for each item you consider and ask yourself these questions:</p>&#13;
&#13;
<ul>&#13;
	<li>&#13;
	<p>Will this information help with the project goals? Will it be a roadblock if I don’t have it, or is it just “nice to have” but won’t ultimately impact anything?</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>If it <em>might</em> help in the future, but I’m unsure, how difficult will it be to go back and collect the data at a later time?</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Is this data redundant to data I’ve already collected?</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Does it make logical sense to store the data within this particular object? (As mentioned before, storing a description in a product doesn’t make sense if that description changes from site to site for the same product.)</p>&#13;
	</li>&#13;
</ul>&#13;
&#13;
<p>If you do decide that you need to collect the data, it’s important to ask a few more questions to then decide how to store and handle it in code:</p>&#13;
&#13;
<ul>&#13;
	<li>&#13;
	<p>Is this data sparse or dense? Will it be relevant and populated in every listing, or just a handful out of the set?</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>How large is the data?</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Especially in the case of large data, will I need to regularly retrieve it every time I run my analysis, or only on occasion?</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>How variable is this type of data? Will I regularly need to add new attributes, modify types (such as fabric patterns, which may be added frequently), or is it set in stone (shoe sizes)?</p>&#13;
	</li>&#13;
</ul>&#13;
&#13;
<p>Let’s say you plan to do some meta-analysis around product attributes and prices: for example, the number of pages a book has, or the type of fabric a piece of clothing is made of, and potentially other attributes in the future, correlated to price. You run through the questions and realize that this data is sparse (relatively few products have any one of the attributes), and that you may decide to add or remove attributes frequently. In this case, it may make sense to create a product type that looks like this:</p>&#13;
&#13;
<ul>&#13;
	<li>&#13;
	<p>Product title</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Manufacturer</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Product ID number (if available/relevant)</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Attributes (optional list or dictionary)</p>&#13;
	</li>&#13;
</ul>&#13;
&#13;
<p>And an attribute type that looks like this:</p>&#13;
&#13;
<ul>&#13;
	<li>&#13;
	<p>Attribute name</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Attribute value</p>&#13;
	</li>&#13;
</ul>&#13;
&#13;
<p>This allows you to flexibly add new product attributes over time, without requiring you to redesign your data schema or rewrite code. When deciding how to store these attributes in the database, you can write JSON to the <code>attribute</code> field, or store each attribute in a separate table with a product ID. See <a data-type="xref" href="ch09.html#c-9">Chapter 9</a> for more information about implementing these types of database models.</p>&#13;
&#13;
<p>You can apply the preceding questions to the other information you’ll need to store as well. For keeping track of the prices found for each product, you’ll likely need the following:</p>&#13;
&#13;
<ul>&#13;
	<li>&#13;
	<p>Product ID</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Store ID</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Price</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Date/timestamp when price was found</p>&#13;
	</li>&#13;
</ul>&#13;
&#13;
<p>But what if you have a situation in which the product’s attributes actually modify the price of the product? For instance, stores might charge more for a large shirt than a small one, because the large shirt requires more labor or materials. In this case, you may consider splitting the single shirt product into separate product listings for each size (so that each shirt product can be priced independently) or creating a new item type to store information about instances of a product, containing these fields:</p>&#13;
&#13;
<ul>&#13;
	<li>&#13;
	<p>Product ID</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Instance type (the size of the shirt, in this case)</p>&#13;
	</li>&#13;
</ul>&#13;
&#13;
<p>And each price would then look like this:</p>&#13;
&#13;
<ul>&#13;
	<li>&#13;
	<p>Product instance ID</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Store ID</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Price</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Date/Timestamp when price was found</p>&#13;
	</li>&#13;
</ul>&#13;
&#13;
<p>While the subject of “products and prices” may seem overly specific, the basic questions you need to ask yourself, and the logic used when designing your Python objects, apply in almost every situation.</p>&#13;
&#13;
<p>If you’re scraping news articles, you may want basic information such as:</p>&#13;
&#13;
<ul>&#13;
	<li>&#13;
	<p>Title</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Author</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Date</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Content</p>&#13;
	</li>&#13;
</ul>&#13;
&#13;
<p>But say some articles contain a “revision date,” or “related articles, or a “number of social media shares.” Do you need these? Are they relevant to your project? How do you efficiently and flexibly store the number of social media shares when not all news sites use all forms of social media, and social media sites may grow or wane in popularity over time?</p>&#13;
&#13;
<p>It can be tempting, when faced with a new project, to dive in and start writing Python to scrape websites immediately. The data model, left as an afterthought, often becomes strongly influenced by the availability and format of the data on the first website you scrape.</p>&#13;
&#13;
<p>However, the data model is the underlying foundation of all the code that uses it. A poor decision in your model can easily lead to problems writing and maintaining code down the line, or difficulty in extracting and efficiently using the resulting data. Especially when dealing with a variety of websites—both known and unknown—it becomes vital to give serious thought and planning to what, exactly, you need to collect and how you <a contenteditable="false" data-primary="objects, planning and defining" data-startref="bjcdf" data-type="indexterm" id="id497"/>need to store it.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Dealing with Different Website Layouts" data-type="sect1"><div class="sect1" id="id46">&#13;
<h1>Dealing with Different Website Layouts</h1>&#13;
&#13;
<p>One of the most impressive feats of a <a contenteditable="false" data-primary="websites" data-secondary="layouts" data-type="indexterm" id="wbstyt"/>search engine such as Google is that it manages to extract relevant and useful data from a variety of websites, having no up-front knowledge about the website structure itself. Although we, as humans, are able to immediately identify the title and main content of a page (barring instances of extremely poor web design), it is far more difficult to get a bot to do the same thing.</p>&#13;
&#13;
<p>Fortunately, in most cases of web crawling, you’re not looking to collect data from sites you’ve never seen before, but from a few, or a few dozen, websites that are pre-selected by a human. This means that you don’t need to use complicated algorithms or machine learning to detect which text on the page “looks most like a title” or which is probably the “main content.” You can determine what these elements are manually.</p>&#13;
&#13;
<p>The most obvious approach is to write a separate web crawler or page parser for each website. Each might take in a URL, string, or <code>BeautifulSoup</code> object, and return a Python object for the thing that was scraped.</p>&#13;
&#13;
<p>The following is an example of a <code>Content</code> class (representing a piece of content <span class="keep-together">on a website,</span> such as a news article) and two scraper functions that take in a <span class="keep-together"><code>BeautifulSoup</code></span> object and return an instance of <code>Content</code>:</p>&#13;
&#13;
<pre data-code-language="python" data-executable="true" data-type="programlisting">&#13;
<code class="kn">from</code> <code class="nn">bs4</code> <code class="kn">import</code> <code class="n">BeautifulSoup</code>&#13;
<code class="kn">from</code> <code class="nn">urllib.request</code> <code class="kn">import</code> <code class="n">urlopen</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">Content</code><code class="p">:</code>&#13;
    <code class="k">def</code> <code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">url</code><code class="p">,</code> <code class="n">title</code><code class="p">,</code> <code class="n">body</code><code class="p">):</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">url</code> <code class="o">=</code> <code class="n">url</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">title</code> <code class="o">=</code> <code class="n">title</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">body</code> <code class="o">=</code> <code class="n">body</code>&#13;
    &#13;
    <code class="k">def</code> <code class="nf">print</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
        <code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s1">'TITLE: </code><code class="si">{</code><code class="bp">self</code><code class="o">.</code><code class="n">title</code><code class="si">}</code><code class="s1">'</code><code class="p">)</code>&#13;
        <code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s1">'URL: </code><code class="si">{</code><code class="bp">self</code><code class="o">.</code><code class="n">url</code><code class="si">}</code><code class="s1">'</code><code class="p">)</code>&#13;
        <code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s1">'BODY: </code><code class="si">{</code><code class="bp">self</code><code class="o">.</code><code class="n">body</code><code class="si">}</code><code class="s1">'</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">scrapeCNN</code><code class="p">(</code><code class="n">url</code><code class="p">):</code>&#13;
    <code class="n">bs</code> <code class="o">=</code> <code class="n">BeautifulSoup</code><code class="p">(</code><code class="n">urlopen</code><code class="p">(</code><code class="n">url</code><code class="p">))</code>&#13;
    <code class="n">title</code> <code class="o">=</code> <code class="n">bs</code><code class="o">.</code><code class="n">find</code><code class="p">(</code><code class="s1">'h1'</code><code class="p">)</code><code class="o">.</code><code class="n">text</code>&#13;
    <code class="n">body</code> <code class="o">=</code> <code class="n">bs</code><code class="o">.</code><code class="n">find</code><code class="p">(</code><code class="s1">'div'</code><code class="p">,</code> <code class="p">{</code><code class="s1">'class'</code><code class="p">:</code> <code class="s1">'article__content'</code><code class="p">})</code><code class="o">.</code><code class="n">text</code>&#13;
    <code class="nb">print</code><code class="p">(</code><code class="s1">'body: '</code><code class="p">)</code>&#13;
    <code class="nb">print</code><code class="p">(</code><code class="n">body</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">Content</code><code class="p">(</code><code class="n">url</code><code class="p">,</code> <code class="n">title</code><code class="p">,</code> <code class="n">body</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">scrapeBrookings</code><code class="p">(</code><code class="n">url</code><code class="p">):</code>&#13;
    <code class="n">bs</code> <code class="o">=</code> <code class="n">BeautifulSoup</code><code class="p">(</code><code class="n">urlopen</code><code class="p">(</code><code class="n">url</code><code class="p">))</code>&#13;
    <code class="n">title</code> <code class="o">=</code> <code class="n">bs</code><code class="o">.</code><code class="n">find</code><code class="p">(</code><code class="s1">'h1'</code><code class="p">)</code><code class="o">.</code><code class="n">text</code>&#13;
    <code class="n">body</code> <code class="o">=</code> <code class="n">bs</code><code class="o">.</code><code class="n">find</code><code class="p">(</code><code class="s1">'div'</code><code class="p">,</code> <code class="p">{</code><code class="s1">'class'</code><code class="p">:</code> <code class="s1">'post-body'</code><code class="p">})</code><code class="o">.</code><code class="n">text</code>&#13;
    <code class="k">return</code> <code class="n">Content</code><code class="p">(</code><code class="n">url</code><code class="p">,</code> <code class="n">title</code><code class="p">,</code> <code class="n">body</code><code class="p">)</code>&#13;
&#13;
<code class="n">url</code> <code class="o">=</code> <code class="s1">'https://www.brookings.edu/research/robotic-rulemaking/'</code>&#13;
<code class="n">content</code> <code class="o">=</code> <code class="n">scrapeBrookings</code><code class="p">(</code><code class="n">url</code><code class="p">)</code>&#13;
<code class="n">content</code><code class="o">.</code><code class="n">print</code><code class="p">()</code>&#13;
&#13;
<code class="n">url</code> <code class="o">=</code> <code class="s1">'https://www.cnn.com/2023/04/03/investing/</code><code class="se">\</code>&#13;
<code class="s1">dogecoin-elon-musk-twitter/index.html'</code>&#13;
<code class="n">content</code> <code class="o">=</code> <code class="n">scrapeCNN</code><code class="p">(</code><code class="n">url</code><code class="p">)</code>&#13;
<code class="n">content</code><code class="o">.</code><code class="n">print</code><code class="p">()</code>&#13;
</pre>&#13;
&#13;
<p>As you start to add scraper functions for <a contenteditable="false" data-primary="parsing functions" data-type="indexterm" id="id498"/>additional news sites, you might notice a pattern forming. Every site’s parsing function does essentially the same thing:</p>&#13;
&#13;
<ul>&#13;
	<li>&#13;
	<p>Selects the title element and extracts the text for the title</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Selects the main content of the article</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Selects other content items as needed</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Returns a <code>Content</code> object instantiated with the strings found previously</p>&#13;
	</li>&#13;
</ul>&#13;
&#13;
<p>The only real site-dependent variables here are the CSS selectors used to obtain each piece of information. BeautifulSoup’s <code>find</code>  and <code>find_all</code> functions <a contenteditable="false" data-primary="BeautifulSoup library" data-secondary="find function" data-type="indexterm" id="id499"/><a contenteditable="false" data-primary="BeautifulSoup library" data-secondary="find_all function" data-type="indexterm" id="id500"/>take in two arguments—a tag string and a dictionary of key/value attributes—so you can pass these arguments in as parameters that define the structure of the site itself and the location of the target data.</p>&#13;
&#13;
<p>To make things even more convenient, rather than dealing with all of these tag arguments and key/value pairs, you can use the BeautifulSoup <code>select</code> function with a single string CSS selector for each piece of information you want to collect and put all of these selectors in a dictionary object:</p>&#13;
&#13;
<pre data-code-language="python" data-executable="true" data-type="programlisting">&#13;
<code class="k">class</code> <code class="nc">Content</code><code class="p">:</code>&#13;
    <code class="sd">"""</code>&#13;
<code class="sd">    Common base class for all articles/pages</code>&#13;
<code class="sd">    """</code>&#13;
    <code class="k">def</code> <code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">url</code><code class="p">,</code> <code class="n">title</code><code class="p">,</code> <code class="n">body</code><code class="p">):</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">url</code> <code class="o">=</code> <code class="n">url</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">title</code> <code class="o">=</code> <code class="n">title</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">body</code> <code class="o">=</code> <code class="n">body</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">print</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
        <code class="sd">"""</code>&#13;
<code class="sd">        Flexible printing function controls output</code>&#13;
<code class="sd">        """</code>&#13;
        <code class="nb">print</code><code class="p">(</code><code class="s1">'URL: </code><code class="si">{}</code><code class="s1">'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">url</code><code class="p">))</code>&#13;
        <code class="nb">print</code><code class="p">(</code><code class="s1">'TITLE: </code><code class="si">{}</code><code class="s1">'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">title</code><code class="p">))</code>&#13;
        <code class="nb">print</code><code class="p">(</code><code class="s1">'BODY:</code><code class="se">\n</code><code class="si">{}</code><code class="s1">'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">body</code><code class="p">))</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">Website</code><code class="p">:</code>&#13;
    <code class="sd">""" </code>&#13;
<code class="sd">    Contains information about website structure</code>&#13;
<code class="sd">    """</code>&#13;
    <code class="k">def</code> <code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">name</code><code class="p">,</code> <code class="n">url</code><code class="p">,</code> <code class="n">titleTag</code><code class="p">,</code> <code class="n">bodyTag</code><code class="p">):</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">name</code> <code class="o">=</code> <code class="n">name</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">url</code> <code class="o">=</code> <code class="n">url</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">titleTag</code> <code class="o">=</code> <code class="n">titleTag</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">bodyTag</code> <code class="o">=</code> <code class="n">bodyTag</code>&#13;
</pre>&#13;
&#13;
<p>Note that the <code>Website</code> class does not store information collected from the individual pages themselves, but stores instructions about <em>how</em> to collect that data. It doesn’t store the title “My Page Title.” It simply stores the string tag <code>h1</code> that indicates where the titles can be found. This is why the class is called <code>Website</code> (the information here pertains to the entire website) and not <code>Content</code> (which contains information from just a single page).</p>&#13;
&#13;
<p>As you write web scrapers, you may notice that you tend to do many of the same tasks over and over again. For instance: fetch the content of a page while checking for errors, get the contents of a tag, and fail gracefully if these are not found. Let’s add these to a <code>Crawler</code> class:</p>&#13;
&#13;
<pre data-code-language="python" data-executable="true" data-type="programlisting">&#13;
<code class="k">class</code> <code class="nc">Crawler</code><code class="p">:</code>&#13;
    <code class="k">def</code> <code class="nf">getPage</code><code class="p">(</code><code class="n">url</code><code class="p">):</code>&#13;
        <code class="k">try</code><code class="p">:</code>&#13;
            <code class="n">html</code> <code class="o">=</code> <code class="n">urlopen</code><code class="p">(</code><code class="n">url</code><code class="p">)</code>&#13;
        <code class="k">except</code> <code class="ne">Exception</code><code class="p">:</code>&#13;
            <code class="k">return</code> <code class="kc">None</code>&#13;
        <code class="k">return</code> <code class="n">BeautifulSoup</code><code class="p">(</code><code class="n">html</code><code class="p">,</code> <code class="s1">'html.parser'</code><code class="p">)</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">safeGet</code><code class="p">(</code><code class="n">bs</code><code class="p">,</code> <code class="n">selector</code><code class="p">):</code>&#13;
        <code class="sd">"""</code>&#13;
<code class="sd">        Utility function used to get a content string from a Beautiful Soup</code>&#13;
<code class="sd">        object and a selector. Returns an empty string if no object</code>&#13;
<code class="sd">        is found for the given selector</code>&#13;
<code class="sd">        """</code>&#13;
        <code class="n">selectedElems</code> <code class="o">=</code> <code class="n">bs</code><code class="o">.</code><code class="n">select</code><code class="p">(</code><code class="n">selector</code><code class="p">)</code>&#13;
        <code class="k">if</code> <code class="n">selectedElems</code> <code class="ow">is</code> <code class="ow">not</code> <code class="kc">None</code> <code class="ow">and</code> <code class="nb">len</code><code class="p">(</code><code class="n">selectedElems</code><code class="p">)</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">:</code>&#13;
            <code class="k">return</code> <code class="s1">'</code><code class="se">\n</code><code class="s1">'</code><code class="o">.</code><code class="n">join</code><code class="p">([</code><code class="n">elem</code><code class="o">.</code><code class="n">get_text</code><code class="p">()</code> <code class="k">for</code> <code class="n">elem</code> <code class="ow">in</code> <code class="n">selectedElems</code><code class="p">])</code>&#13;
        <code class="k">return</code> <code class="s1">''</code>&#13;
</pre>&#13;
&#13;
<p>Note that the <code>Crawler</code> class currently does not have any state. It’s simply a collection of static methods. It also seems poorly named—it doesn’t do any crawling at all! You can at least make it slightly more useful by adding a <code>getContent</code> method to it, which takes as an argument a <code>website</code> object and a URL, and returns a <code>Content</code> object:</p>&#13;
&#13;
<pre data-code-language="python" data-executable="true" data-type="programlisting">&#13;
<code class="k">class</code> <code class="nc">Crawler</code><code class="p">:</code>&#13;
&#13;
    <code class="o">...</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">getContent</code><code class="p">(</code><code class="n">website</code><code class="p">,</code> <code class="n">path</code><code class="p">):</code>&#13;
        <code class="sd">"""</code>&#13;
<code class="sd">        Extract content from a given page URL</code>&#13;
<code class="sd">        """</code>&#13;
        <code class="n">url</code> <code class="o">=</code> <code class="n">website</code><code class="o">.</code><code class="n">url</code><code class="o">+</code><code class="n">path</code>&#13;
        <code class="n">bs</code> <code class="o">=</code> <code class="n">Crawler</code><code class="o">.</code><code class="n">getPage</code><code class="p">(</code><code class="n">url</code><code class="p">)</code>&#13;
        <code class="k">if</code> <code class="n">bs</code> <code class="ow">is</code> <code class="ow">not</code> <code class="kc">None</code><code class="p">:</code>&#13;
            <code class="n">title</code> <code class="o">=</code> <code class="n">Crawler</code><code class="o">.</code><code class="n">safeGet</code><code class="p">(</code><code class="n">bs</code><code class="p">,</code> <code class="n">website</code><code class="o">.</code><code class="n">titleTag</code><code class="p">)</code>&#13;
            <code class="n">body</code> <code class="o">=</code> <code class="n">Crawler</code><code class="o">.</code><code class="n">safeGet</code><code class="p">(</code><code class="n">bs</code><code class="p">,</code> <code class="n">website</code><code class="o">.</code><code class="n">bodyTag</code><code class="p">)</code>&#13;
            <code class="k">return</code> <code class="n">Content</code><code class="p">(</code><code class="n">url</code><code class="p">,</code> <code class="n">title</code><code class="p">,</code> <code class="n">body</code><code class="p">)</code>&#13;
        <code class="k">return</code> <code class="n">Content</code><code class="p">(</code><code class="n">url</code><code class="p">,</code> <code class="s1">''</code><code class="p">,</code> <code class="s1">''</code><code class="p">)</code>&#13;
</pre>&#13;
&#13;
<p>The following shows how these <code>Content</code>, <code>website</code>, and <code>Crawler</code> classes can be used together to scrape four different websites:</p>&#13;
&#13;
<pre data-code-language="python" data-executable="true" data-type="programlisting">&#13;
<code class="n">siteData</code> <code class="o">=</code> <code class="p">[</code>&#13;
    <code class="p">[</code><code class="s1">'O</code><code class="se">\'</code><code class="s1">Reilly'</code><code class="p">,</code> <code class="s1">'https://www.oreilly.com'</code><code class="p">,</code> <code class="s1">'h1'</code><code class="p">,</code> <code class="s1">'div.title-description'</code><code class="p">],</code>&#13;
    <code class="p">[</code><code class="s1">'Reuters'</code><code class="p">,</code> <code class="s1">'https://www.reuters.com'</code><code class="p">,</code> <code class="s1">'h1'</code><code class="p">,</code> <code class="s1">'div.ArticleBodyWrapper'</code><code class="p">],</code>&#13;
    <code class="p">[</code><code class="s1">'Brookings'</code><code class="p">,</code> <code class="s1">'https://www.brookings.edu'</code><code class="p">,</code> <code class="s1">'h1'</code><code class="p">,</code> <code class="s1">'div.post-body'</code><code class="p">],</code>&#13;
    <code class="p">[</code><code class="s1">'CNN'</code><code class="p">,</code> <code class="s1">'https://www.cnn.com'</code><code class="p">,</code> <code class="s1">'h1'</code><code class="p">,</code> <code class="s1">'div.article__content'</code><code class="p">]</code>&#13;
<code class="p">]</code>&#13;
<code class="n">websites</code> <code class="o">=</code> <code class="p">[]</code>&#13;
<code class="k">for</code> <code class="n">name</code><code class="p">,</code> <code class="n">url</code><code class="p">,</code> <code class="n">title</code><code class="p">,</code> <code class="n">body</code> <code class="ow">in</code> <code class="n">siteData</code><code class="p">:</code>&#13;
    <code class="n">websites</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">Website</code><code class="p">(</code><code class="n">name</code><code class="p">,</code> <code class="n">url</code><code class="p">,</code> <code class="n">title</code><code class="p">,</code> <code class="n">body</code><code class="p">))</code>&#13;
&#13;
<code class="n">Crawler</code><code class="o">.</code><code class="n">getContent</code><code class="p">(</code>&#13;
    <code class="n">websites</code><code class="p">[</code><code class="mi">0</code><code class="p">],</code> &#13;
    <code class="s1">'/library/view/web-scraping-with/9781491910283'</code>&#13;
    <code class="p">)</code><code class="o">.</code><code class="n">print</code><code class="p">()</code>&#13;
<code class="n">Crawler</code><code class="o">.</code><code class="n">getContent</code><code class="p">(</code>&#13;
    <code class="n">websites</code><code class="p">[</code><code class="mi">1</code><code class="p">],</code>&#13;
    <code class="s1">'/article/us-usa-epa-pruitt-idUSKBN19W2D0'</code>&#13;
    <code class="p">)</code><code class="o">.</code><code class="n">print</code><code class="p">()</code>&#13;
<code class="n">Crawler</code><code class="o">.</code><code class="n">getContent</code><code class="p">(</code>&#13;
    <code class="n">websites</code><code class="p">[</code><code class="mi">2</code><code class="p">],</code>&#13;
    <code class="s1">'/blog/techtank/2016/03/01/idea-to-retire-old-methods-of-policy-education/'</code>&#13;
    <code class="p">)</code><code class="o">.</code><code class="n">print</code><code class="p">()</code>&#13;
<code class="n">Crawler</code><code class="o">.</code><code class="n">getContent</code><code class="p">(</code>&#13;
    <code class="n">websites</code><code class="p">[</code><code class="mi">3</code><code class="p">],</code> &#13;
    <code class="s1">'/2023/04/03/investing/dogecoin-elon-musk-twitter/index.html'</code>&#13;
    <code class="p">)</code><code class="o">.</code><code class="n">print</code><code class="p">()</code>&#13;
</pre>&#13;
&#13;
<p>While this new method might not seem remarkably simpler than writing a new Python function for each new website at first glance, imagine what happens when you go from a system with 4 website sources to a system with 20 or 200 sources.</p>&#13;
&#13;
<p>Each list of strings defining a new website is relatively easy to write. It doesn’t take up much space. It can be loaded from a database or a CSV file. It can be imported from a remote source or handed off to a nonprogrammer with a little frontend experience. This programmer can fill it out and add new websites to the scraper without ever having to look at a line of code.</p>&#13;
&#13;
<p>Of course, the downside is that you are giving up a certain amount of flexibility. In the first example, each website gets its own free-form function to select and parse HTML however necessary to get the end result. In the second example, each website needs to have a certain structure in which fields are guaranteed to exist, data must be clean coming out of the field, and each target field must have a unique and reliable CSS selector.</p>&#13;
&#13;
<p class="pagebreak-before">However, I believe that the power and relative flexibility of this approach more than makes up for its real or perceived shortcomings. The next section covers specific applications and expansions of this basic template so that you can, for example, deal with missing fields, collect different types of data, crawl through specific <a contenteditable="false" data-primary="websites" data-secondary="layouts" data-startref="wbstyt" data-type="indexterm" id="id501"/>parts of a website, and store more-complex information about pages.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Structuring Crawlers" data-type="sect1"><div class="sect1" id="id142">&#13;
<h1>Structuring Crawlers</h1>&#13;
&#13;
<p>Creating flexible and modifiable website <a contenteditable="false" data-primary="web crawlers" data-secondary="structure" data-type="indexterm" id="wbwlct"/>layout types doesn’t do much good if you still have to locate each link you want to scrape by hand. <a data-type="xref" href="ch06.html#c-6">Chapter 6</a> showed various automated methods of crawling through websites and finding new pages.</p>&#13;
&#13;
<p>This section shows how to incorporate these methods into a well-structured and expandable website crawler that can gather links and discover data in an automated way. I present just three basic web crawler structures here; they apply to the majority of situations that you will likely encounter when crawling sites in the wild, perhaps with a few modifications here and there. If you encounter an unusual situation with your own crawling problem, I hope that you will use these structures as inspiration to create an elegant and robust crawler design.</p>&#13;
&#13;
<section data-pdf-bookmark="Crawling Sites Through Search" data-type="sect2"><div class="sect2" id="id143">&#13;
<h2>Crawling Sites Through Search</h2>&#13;
&#13;
<p>One of the easiest ways to crawl a <a contenteditable="false" data-primary="searches" data-secondary="webcrawlers" data-type="indexterm" id="sccwut"/>website is via the same method that humans use with the search bar. Although the process of searching a website for a keyword or topic and collecting a list of search results may seem like a task with a lot of variability from site to site, several key points make this surprisingly trivial:</p>&#13;
&#13;
<ul>&#13;
	<li>&#13;
	<p>Most sites retrieve a list of search results for a particular topic by passing that topic as a string through a parameter in the URL. For example: <code>http://example.com?search=myTopic</code>. The first part of this URL can be saved as a property of the <code>Website</code> object, and the topic can simply be appended to it.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>After searching, most sites present the resulting pages as an easily identifiable list of links, usually with a convenient surrounding tag such as <code>&lt;span class="result"&gt;</code>, the exact format of which can also be stored as a property of the <code>Website</code> object.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Each <em>result link</em> is either <a contenteditable="false" data-primary="searches" data-secondary="webcrawlers" data-tertiary="result links" data-type="indexterm" id="id502"/>a relative URL (e.g., <em>/articles/page.html</em>) or an absolute URL (e.g., <em>http://example.com/articles/page.html</em>). Whether you are expecting an absolute or relative URL, it can be stored as a property of the <code>Website</code> object.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>After you’ve located and normalized the URLs on the search page, you’ve successfully reduced the problem to the example in the previous section—extracting data from a page, given a website format.</p>&#13;
	</li>&#13;
</ul>&#13;
&#13;
<p>Let’s look at an implementation of this algorithm in code. The <code>Content</code> class is much the same as in previous examples. You are adding the URL property to keep track of where the content was found:</p>&#13;
&#13;
<pre data-code-language="python" data-executable="true" data-type="programlisting">&#13;
<code class="k">class</code> <code class="nc">Content</code><code class="p">:</code>&#13;
    <code class="sd">"""Common base class for all articles/pages"""</code>&#13;
&#13;
    <code class="k">def</code> <code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">topic</code><code class="p">,</code> <code class="n">url</code><code class="p">,</code> <code class="n">title</code><code class="p">,</code> <code class="n">body</code><code class="p">):</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">topic</code> <code class="o">=</code> <code class="n">topic</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">title</code> <code class="o">=</code> <code class="n">title</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">body</code> <code class="o">=</code> <code class="n">body</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">url</code> <code class="o">=</code> <code class="n">url</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">print</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
        <code class="sd">"""</code>&#13;
<code class="sd">        Flexible printing function controls output</code>&#13;
<code class="sd">        """</code>&#13;
        <code class="nb">print</code><code class="p">(</code><code class="s1">'New article found for topic: </code><code class="si">{}</code><code class="s1">'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">topic</code><code class="p">))</code>&#13;
        <code class="nb">print</code><code class="p">(</code><code class="s1">'URL: </code><code class="si">{}</code><code class="s1">'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">url</code><code class="p">))</code>&#13;
        <code class="nb">print</code><code class="p">(</code><code class="s1">'TITLE: </code><code class="si">{}</code><code class="s1">'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">title</code><code class="p">))</code>&#13;
        <code class="nb">print</code><code class="p">(</code><code class="s1">'BODY:</code><code class="se">\n</code><code class="si">{}</code><code class="s1">'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">body</code><code class="p">))</code>    &#13;
</pre>&#13;
&#13;
<p>The <code>Website</code> class has a few new properties added to it. The <code>searchUrl</code> defines where you should go to get search results if you append the topic you are looking for. The <code>resultListing</code> defines the “box” that holds information about each result, and <span class="keep-together">the <code>resultUrl</code></span> defines the tag inside this box that will give you the exact URL for the result. The <code>absoluteUrl</code> property is a boolean that tells you whether these search results are absolute or relative URLs:</p>&#13;
&#13;
<pre data-code-language="python" data-executable="true" data-type="programlisting">&#13;
<code class="k">class</code> <code class="nc">Website</code><code class="p">:</code>&#13;
    <code class="sd">"""Contains information about website structure"""</code>&#13;
&#13;
    <code class="k">def</code> <code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">name</code><code class="p">,</code> <code class="n">url</code><code class="p">,</code> <code class="n">searchUrl</code><code class="p">,</code> <code class="n">resultListing</code><code class="p">,</code>&#13;
<code class="err">​</code>    <code class="err">​</code>    <code class="n">resultUrl</code><code class="p">,</code> <code class="n">absoluteUrl</code><code class="p">,</code> <code class="n">titleTag</code><code class="p">,</code> <code class="n">bodyTag</code><code class="p">):</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">name</code> <code class="o">=</code> <code class="n">name</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">url</code> <code class="o">=</code> <code class="n">url</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">searchUrl</code> <code class="o">=</code> <code class="n">searchUrl</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">resultListing</code> <code class="o">=</code> <code class="n">resultListing</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">resultUrl</code> <code class="o">=</code> <code class="n">resultUrl</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">absoluteUrl</code><code class="o">=</code><code class="n">absoluteUrl</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">titleTag</code> <code class="o">=</code> <code class="n">titleTag</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">bodyTag</code> <code class="o">=</code> <code class="n">bodyTag</code>&#13;
</pre>&#13;
&#13;
<p>The <code>Crawler</code> class has also expanded. It now has a <code>Website</code> object, as well as a dictionary of URLs pointing to <code>Content</code> objects, to keep track of what it has seen before. Note that the methods <code>getPage</code> and <code>safeGet</code> have not changed and are omitted here:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="k">class</code> <code class="nc">Crawler</code><code class="p">:</code>&#13;
    <code class="k">def</code> <code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">website</code><code class="p">):</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">site</code> <code class="o">=</code> <code class="n">website</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">found</code> <code class="o">=</code> <code class="p">{}</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">getContent</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">topic</code><code class="p">,</code> <code class="n">url</code><code class="p">):</code>&#13;
        <code class="sd">"""</code>&#13;
<code class="sd">        Extract content from a given page URL</code>&#13;
<code class="sd">        """</code>&#13;
        <code class="n">bs</code> <code class="o">=</code> <code class="n">Crawler</code><code class="o">.</code><code class="n">getPage</code><code class="p">(</code><code class="n">url</code><code class="p">)</code>&#13;
        <code class="k">if</code> <code class="n">bs</code> <code class="ow">is</code> <code class="ow">not</code> <code class="kc">None</code><code class="p">:</code>&#13;
            <code class="n">title</code> <code class="o">=</code> <code class="n">Crawler</code><code class="o">.</code><code class="n">safeGet</code><code class="p">(</code><code class="n">bs</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">site</code><code class="o">.</code><code class="n">titleTag</code><code class="p">)</code>&#13;
            <code class="n">body</code> <code class="o">=</code> <code class="n">Crawler</code><code class="o">.</code><code class="n">safeGet</code><code class="p">(</code><code class="n">bs</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">site</code><code class="o">.</code><code class="n">bodyTag</code><code class="p">)</code>&#13;
            <code class="k">return</code> <code class="n">Content</code><code class="p">(</code><code class="n">topic</code><code class="p">,</code> <code class="n">url</code><code class="p">,</code> <code class="n">title</code><code class="p">,</code> <code class="n">body</code><code class="p">)</code>&#13;
        <code class="k">return</code> <code class="n">Content</code><code class="p">(</code><code class="n">topic</code><code class="p">,</code> <code class="n">url</code><code class="p">,</code> <code class="s1">''</code><code class="p">,</code> <code class="s1">''</code><code class="p">)</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">search</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">topic</code><code class="p">):</code>&#13;
        <code class="sd">"""</code>&#13;
<code class="sd">        Searches a given website for a given topic and records all pages found</code>&#13;
<code class="sd">        """</code>&#13;
        <code class="n">bs</code> <code class="o">=</code> <code class="n">Crawler</code><code class="o">.</code><code class="n">getPage</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">site</code><code class="o">.</code><code class="n">searchUrl</code> <code class="o">+</code> <code class="n">topic</code><code class="p">)</code>&#13;
        <code class="n">searchResults</code> <code class="o">=</code> <code class="n">bs</code><code class="o">.</code><code class="n">select</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">site</code><code class="o">.</code><code class="n">resultListing</code><code class="p">)</code>&#13;
        <code class="k">for</code> <code class="n">result</code> <code class="ow">in</code> <code class="n">searchResults</code><code class="p">:</code>&#13;
            <code class="n">url</code> <code class="o">=</code> <code class="n">result</code><code class="o">.</code><code class="n">select</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">site</code><code class="o">.</code><code class="n">resultUrl</code><code class="p">)[</code><code class="mi">0</code><code class="p">]</code><code class="o">.</code><code class="n">attrs</code><code class="p">[</code><code class="s1">'href'</code><code class="p">]</code>&#13;
            <code class="c1"># Check to see whether it's a relative or an absolute URL</code>&#13;
            <code class="n">url</code> <code class="o">=</code> <code class="n">url</code> <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">site</code><code class="o">.</code><code class="n">absoluteUrl</code> <code class="k">else</code> <code class="bp">self</code><code class="o">.</code><code class="n">site</code><code class="o">.</code><code class="n">url</code> <code class="o">+</code> <code class="n">url</code>&#13;
            <code class="k">if</code> <code class="n">url</code> <code class="ow">not</code> <code class="ow">in</code> <code class="bp">self</code><code class="o">.</code><code class="n">found</code><code class="p">:</code>&#13;
                <code class="bp">self</code><code class="o">.</code><code class="n">found</code><code class="p">[</code><code class="n">url</code><code class="p">]</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">getContent</code><code class="p">(</code><code class="n">topic</code><code class="p">,</code> <code class="n">url</code><code class="p">)</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">found</code><code class="p">[</code><code class="n">url</code><code class="p">]</code><code class="o">.</code><code class="n">print</code><code class="p">()</code>&#13;
</pre>&#13;
&#13;
<p>You can call your Crawler like this:</p>&#13;
&#13;
<pre data-code-language="text" data-type="programlisting">&#13;
siteData = [&#13;
    ['Reuters', 'http://reuters.com',&#13;
     'https://www.reuters.com/search/news?blob=',&#13;
     'div.search-result-indiv', 'h3.search-result-title a', &#13;
      False, 'h1', 'div.ArticleBodyWrapper'],&#13;
    ['Brookings', 'http://www.brookings.edu',&#13;
     'https://www.brookings.edu/search/?s=',&#13;
        'div.article-info', 'h4.title a', True, 'h1', 'div.core-block']&#13;
]&#13;
sites = []&#13;
for name, url, search, rListing, rUrl, absUrl, tt, bt in siteData:&#13;
    sites.append(Website(name, url, search, rListing, rUrl, absUrl, tt, bt))&#13;
&#13;
crawlers = [Crawler(site) for site in sites]&#13;
topics = ['python', 'data%20science']&#13;
&#13;
for topic in topics:&#13;
    for crawler in crawlers:&#13;
        crawler.search(topic)&#13;
</pre>&#13;
&#13;
<p>As before, an array of data is created about each website: what the tags look like, what the URL is, and a name for tracking purposes. This data is then loaded into a list of <code>Website</code> objects and turned into <code>Crawler</code> objects.</p>&#13;
&#13;
<p>Then it loops through each <a contenteditable="false" data-primary="searches" data-secondary="webcrawlers" data-tertiary="loops" data-type="indexterm" id="id503"/>crawler in the <code>crawlers</code> list and crawls each particular site for each particular topic. Each time it successfully collects information about a page, it prints it to the console:</p>&#13;
&#13;
<pre data-code-language="text" data-type="programlisting">&#13;
New article found for topic: python&#13;
URL: http://reuters.com/article/idUSKCN11S04G&#13;
TITLE: Python in India demonstrates huge appetite&#13;
BODY:&#13;
By 1 Min ReadA 20 feet rock python was caught on camera ...&#13;
</pre>&#13;
&#13;
<p>Note that it loops through all topics and then loops through all websites in the inner loop. Why not do it the other way around, collecting all topics from one website and then all topics from the next website? Looping through all topics first is a way to more evenly distribute the load placed on any one web server. This is especially important if you have a list of hundreds of topics and dozens of websites. You’re not making tens of thousands of requests to one website at once; you’re making 10 requests, waiting a few minutes, making another 10 requests, waiting a few minutes, and so forth.</p>&#13;
&#13;
<p>Although the number of requests is ultimately the same either way, it’s generally better to distribute these requests over time as much as is reasonable. Paying attention to how your loops are structured <a contenteditable="false" data-primary="searches" data-secondary="webcrawlers" data-startref="sccwut" data-type="indexterm" id="id504"/>is an easy way to do this.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Crawling Sites Through Links" data-type="sect2"><div class="sect2" id="id144">&#13;
<h2>Crawling Sites Through Links</h2>&#13;
&#13;
<p><a data-type="xref" href="ch06.html#c-6">Chapter 6</a> covered some ways of identifying internal and external links on web pages and then <a contenteditable="false" data-primary="links" data-secondary="webcrawlers and" data-type="indexterm" id="lkwcwl"/>using those links to crawl across the site. In this section, you’ll combine those same basic methods into a more flexible website crawler that can follow any link matching a specific URL pattern.</p>&#13;
&#13;
<p>This type of crawler works well for projects when you want to gather all the data from a site—not just data from a specific search result or page listing. It also works well when the site’s pages may be disorganized or widely dispersed.</p>&#13;
&#13;
<p>These types of crawlers don’t require a structured method of locating links, as in the previous section on crawling through search pages, so the attributes that describe the search page aren’t required in the <code>Website</code> object. However, because the crawler isn’t given specific instructions for the locations/positions of the links it’s looking for, you do need some rules to tell it what sorts of pages to select. You provide a <code>target​Pat⁠tern</code> (regular expression for the target URLs) and leave the boolean <code>absoluteUrl</code> variable to accomplish this:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="k">class</code> <code class="nc">Website</code><code class="p">:</code>&#13;
    <code class="k">def</code> <code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">name</code><code class="p">,</code> <code class="n">url</code><code class="p">,</code> <code class="n">targetPattern</code><code class="p">,</code> <code class="n">absoluteUrl</code><code class="p">,</code> <code class="n">titleTag</code><code class="p">,</code> <code class="n">bodyTag</code><code class="p">):</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">name</code> <code class="o">=</code> <code class="n">name</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">url</code> <code class="o">=</code> <code class="n">url</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">targetPattern</code> <code class="o">=</code> <code class="n">targetPattern</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">absoluteUrl</code> <code class="o">=</code> <code class="n">absoluteUrl</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">titleTag</code> <code class="o">=</code> <code class="n">titleTag</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">bodyTag</code> <code class="o">=</code> <code class="n">bodyTag</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">Content</code><code class="p">:</code>&#13;
    <code class="k">def</code> <code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">url</code><code class="p">,</code> <code class="n">title</code><code class="p">,</code> <code class="n">body</code><code class="p">):</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">url</code> <code class="o">=</code> <code class="n">url</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">title</code> <code class="o">=</code> <code class="n">title</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">body</code> <code class="o">=</code> <code class="n">body</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">print</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
        <code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s1">'URL: </code><code class="si">{</code><code class="bp">self</code><code class="o">.</code><code class="n">url</code><code class="si">}</code><code class="s1">'</code><code class="p">)</code>&#13;
        <code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s1">'TITLE: </code><code class="si">{</code><code class="bp">self</code><code class="o">.</code><code class="n">title</code><code class="si">}</code><code class="s1">'</code><code class="p">)</code>&#13;
        <code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s1">'BODY:</code><code class="se">\n</code><code class="si">{</code><code class="bp">self</code><code class="o">.</code><code class="n">body</code><code class="si">}</code><code class="s1">'</code><code class="p">)</code>&#13;
</pre>&#13;
&#13;
<p>The <code>Content</code> class is the same one used in the first crawler example.</p>&#13;
&#13;
<p>The <code>Crawler</code> class is written to start from the home page of each site, locate internal links, and parse the content from each internal link found:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="k">class</code> <code class="nc">Crawler</code><code class="p">:</code>&#13;
    <code class="k">def</code> <code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">site</code><code class="p">):</code>&#13;
      <code class="bp">self</code><code class="o">.</code><code class="n">site</code> <code class="o">=</code> <code class="n">site</code>&#13;
      <code class="bp">self</code><code class="o">.</code><code class="n">visited</code> <code class="o">=</code> <code class="p">{}</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">getPage</code><code class="p">(</code><code class="n">url</code><code class="p">):</code>&#13;
      <code class="k">try</code><code class="p">:</code>&#13;
            <code class="n">html</code> <code class="o">=</code> <code class="n">urlopen</code><code class="p">(</code><code class="n">url</code><code class="p">)</code>&#13;
      <code class="k">except</code> <code class="ne">Exception</code> <code class="k">as</code> <code class="n">e</code><code class="p">:</code>&#13;
            <code class="nb">print</code><code class="p">(</code><code class="n">e</code><code class="p">)</code>&#13;
            <code class="k">return</code> <code class="kc">None</code>&#13;
      <code class="k">return</code> <code class="n">BeautifulSoup</code><code class="p">(</code><code class="n">html</code><code class="p">,</code> <code class="s1">'html.parser'</code><code class="p">)</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">safeGet</code><code class="p">(</code><code class="n">bs</code><code class="p">,</code> <code class="n">selector</code><code class="p">):</code>&#13;
      <code class="n">selectedElems</code> <code class="o">=</code> <code class="n">bs</code><code class="o">.</code><code class="n">select</code><code class="p">(</code><code class="n">selector</code><code class="p">)</code>&#13;
      <code class="k">if</code> <code class="n">selectedElems</code> <code class="ow">is</code> <code class="ow">not</code> <code class="kc">None</code> <code class="ow">and</code> <code class="nb">len</code><code class="p">(</code><code class="n">selectedElems</code><code class="p">)</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">:</code>&#13;
            <code class="k">return</code> <code class="s1">'</code><code class="se">\n</code><code class="s1">'</code><code class="o">.</code><code class="n">join</code><code class="p">([</code><code class="n">elem</code><code class="o">.</code><code class="n">get_text</code><code class="p">()</code> <code class="k">for</code> <code class="n">elem</code> <code class="ow">in</code> <code class="n">selectedElems</code><code class="p">])</code>&#13;
      <code class="k">return</code> <code class="s1">''</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">getContent</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">url</code><code class="p">):</code>&#13;
      <code class="sd">"""</code>&#13;
<code class="sd">      Extract content from a given page URL</code>&#13;
<code class="sd">      """</code>&#13;
      <code class="n">bs</code> <code class="o">=</code> <code class="n">Crawler</code><code class="o">.</code><code class="n">getPage</code><code class="p">(</code><code class="n">url</code><code class="p">)</code>&#13;
      <code class="k">if</code> <code class="n">bs</code> <code class="ow">is</code> <code class="ow">not</code> <code class="kc">None</code><code class="p">:</code>&#13;
          <code class="n">title</code> <code class="o">=</code> <code class="n">Crawler</code><code class="o">.</code><code class="n">safeGet</code><code class="p">(</code><code class="n">bs</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">site</code><code class="o">.</code><code class="n">titleTag</code><code class="p">)</code>&#13;
          <code class="n">body</code> <code class="o">=</code> <code class="n">Crawler</code><code class="o">.</code><code class="n">safeGet</code><code class="p">(</code><code class="n">bs</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">site</code><code class="o">.</code><code class="n">bodyTag</code><code class="p">)</code>&#13;
          <code class="k">return</code> <code class="n">Content</code><code class="p">(</code><code class="n">url</code><code class="p">,</code> <code class="n">title</code><code class="p">,</code> <code class="n">body</code><code class="p">)</code>&#13;
        <code class="k">return</code> <code class="n">Content</code><code class="p">(</code><code class="n">url</code><code class="p">,</code> <code class="s1">''</code><code class="p">,</code> <code class="s1">''</code><code class="p">)</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">crawl</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
        <code class="sd">"""</code>&#13;
<code class="sd">        Get pages from website home page</code>&#13;
<code class="sd">        """</code>&#13;
        <code class="n">bs</code> <code class="o">=</code> <code class="n">Crawler</code><code class="o">.</code><code class="n">getPage</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">site</code><code class="o">.</code><code class="n">url</code><code class="p">)</code>&#13;
        <code class="n">targetPages</code> <code class="o">=</code> <code class="n">bs</code><code class="o">.</code><code class="n">findAll</code><code class="p">(</code><code class="s1">'a'</code><code class="p">,</code> <code class="n">href</code><code class="o">=</code><code class="n">re</code><code class="o">.</code><code class="n">compile</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">site</code><code class="o">.</code><code class="n">targetPattern</code><code class="p">))</code>&#13;
        <code class="k">for</code> <code class="n">targetPage</code> <code class="ow">in</code> <code class="n">targetPages</code><code class="p">:</code>&#13;
          <code class="n">url</code> <code class="o">=</code> <code class="n">targetPage</code><code class="o">.</code><code class="n">attrs</code><code class="p">[</code><code class="s1">'href'</code><code class="p">]</code>&#13;
          <code class="n">url</code> <code class="o">=</code> <code class="n">url</code> <code class="k">if</code> <code class="bp">self</code><code class="o">.</code><code class="n">site</code><code class="o">.</code><code class="n">absoluteUrl</code> <code class="k">else</code> <code class="sa">f</code><code class="s1">'</code><code class="si">{</code><code class="bp">self</code><code class="o">.</code><code class="n">site</code><code class="o">.</code><code class="n">url</code><code class="si">}{</code><code class="n">targetPage</code><code class="si">}</code><code class="s1">'</code>&#13;
          <code class="k">if</code> <code class="n">url</code> <code class="ow">not</code> <code class="ow">in</code> <code class="bp">self</code><code class="o">.</code><code class="n">visited</code><code class="p">:</code>&#13;
                <code class="bp">self</code><code class="o">.</code><code class="n">visited</code><code class="p">[</code><code class="n">url</code><code class="p">]</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">getContent</code><code class="p">(</code><code class="n">url</code><code class="p">)</code>&#13;
                <code class="bp">self</code><code class="o">.</code><code class="n">visited</code><code class="p">[</code><code class="n">url</code><code class="p">]</code><code class="o">.</code><code class="n">print</code><code class="p">()</code>&#13;
&#13;
<code class="n">brookings</code> <code class="o">=</code> <code class="n">Website</code><code class="p">(</code>&#13;
    <code class="s1">'Brookings'</code><code class="p">,</code> <code class="s1">'https://brookings.edu'</code><code class="p">,</code> <code class="s1">'\/(research|blog)\/'</code><code class="p">,</code>&#13;
     <code class="kc">True</code><code class="p">,</code> <code class="s1">'h1'</code><code class="p">,</code> <code class="s1">'div.post-body'</code><code class="p">)</code>&#13;
<code class="n">crawler</code> <code class="o">=</code> <code class="n">Crawler</code><code class="p">(</code><code class="n">brookings</code><code class="p">)</code>&#13;
<code class="n">crawler</code><code class="o">.</code><code class="n">crawl</code><code class="p">()</code>&#13;
</pre>&#13;
&#13;
<p>As in the previous example, the <code>Website</code> object is a property of the <code>Crawler</code> object itself. This works well to store the visited pages (<code>visited</code>) in the crawler but means that a new crawler must be instantiated for each website rather than reusing the same one to crawl a list of websites.</p>&#13;
&#13;
<p>Whether you choose to make a crawler website-agnostic or choose to make the website an attribute of the crawler is a design decision that you must weigh in the context of your own specific needs. Either approach is generally fine.</p>&#13;
&#13;
<p>Another thing to note is that this crawler will get the pages from the home page, but it will not continue crawling after all those pages have been logged. You may want to write a crawler incorporating one of the patterns in this chapter and have it look for more targets on each page it visits. You can even follow all the URLs on each page (not just ones matching the target pattern) to look for URLs containing the <a contenteditable="false" data-primary="links" data-secondary="webcrawlers and" data-startref="lkwcwl" data-type="indexterm" id="id505"/>target pattern.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Crawling Multiple Page Types" data-type="sect2"><div class="sect2" id="id145">&#13;
<h2>Crawling Multiple Page Types</h2>&#13;
&#13;
<p>Unlike crawling through a predetermined set of pages, crawling through all internal links on a website can present a challenge in that you never know exactly what you’re getting. Fortunately, there are a few ways to identify the page type:</p>&#13;
&#13;
<dl>&#13;
	<dt>By the URL</dt>&#13;
	<dd>All blog posts on a website might contain a URL (<em>http://example.com/blog/title-of-post</em>, for example).</dd>&#13;
	<dt>By the presence or lack of certain fields on a site</dt>&#13;
	<dd>If a page has a date but no author name, you might categorize it as a press release. If it has a title, main image, and price but no main content, it might be a product page. </dd>&#13;
	<dt>By the presence of certain tags on the page to identify the page</dt>&#13;
	<dd>You can take advantage of tags even if you’re not collecting the data within the tags. Your crawler might look for an element such as <code>&lt;div id="related-products"&gt;</code> to identify the page as a product page, even though the crawler is not interested in the content of the related products. </dd>&#13;
</dl>&#13;
&#13;
<p>To keep track of multiple page types, you <a contenteditable="false" data-primary="Python" data-secondary="page objects" data-type="indexterm" id="id506"/>need to have multiple types of page objects in Python. This can be done in two ways.</p>&#13;
&#13;
<p>If the pages are all similar (they all have basically the same types of content), you may want to add a <code>pageType</code> attribute to your existing web-page object:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="k">class</code> <code class="nc">Website</code><code class="p">:</code>&#13;
    <code class="k">def</code> <code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">name</code><code class="p">,</code> <code class="n">url</code><code class="p">,</code> <code class="n">titleTag</code><code class="p">,</code> <code class="n">bodyTag</code><code class="p">,</code> <code class="n">pageType</code><code class="p">):</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">name</code> <code class="o">=</code> <code class="n">name</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">url</code> <code class="o">=</code> <code class="n">url</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">titleTag</code> <code class="o">=</code> <code class="n">titleTag</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">bodyTag</code> <code class="o">=</code> <code class="n">bodyTag</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">pageType</code> <code class="o">=</code> <code class="n">pageType</code>&#13;
</pre>&#13;
&#13;
<p>If you’re storing these pages in an SQL-like database, this type of pattern indicates that all these pages would probably be stored in the same table and that an extra <code>pageType</code> column would be added.</p>&#13;
&#13;
<p>If the pages/content you’re scraping are different enough from each other (they contain different types of fields), this may warrant creating new classes for each page type. Of course, some things will be common to all web pages—they will all have a URL and likely also a name or page title. This is an ideal situation in which to use subclasses:</p>&#13;
&#13;
<pre data-code-language="python" data-executable="true" data-type="programlisting">&#13;
<code class="k">class</code> <code class="nc">Product</code><code class="p">(</code><code class="n">Website</code><code class="p">):</code>&#13;
    <code class="sd">"""Contains information for scraping a product page"""</code>&#13;
    <code class="k">def</code> <code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">name</code><code class="p">,</code> <code class="n">url</code><code class="p">,</code> <code class="n">titleTag</code><code class="p">,</code> <code class="n">productNumberTag</code><code class="p">,</code> <code class="n">priceTag</code><code class="p">):</code>&#13;
        <code class="n">Website</code><code class="o">.</code><code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">name</code><code class="p">,</code> <code class="n">url</code><code class="p">,</code> <code class="n">TitleTag</code><code class="p">)</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">productNumberTag</code> <code class="o">=</code> <code class="n">productNumberTag</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">priceTag</code> <code class="o">=</code> <code class="n">priceTag</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">Article</code><code class="p">(</code><code class="n">Website</code><code class="p">):</code>&#13;
    <code class="sd">"""Contains information for scraping an article page"""</code>&#13;
    <code class="k">def</code> <code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">name</code><code class="p">,</code> <code class="n">url</code><code class="p">,</code> <code class="n">titleTag</code><code class="p">,</code> <code class="n">bodyTag</code><code class="p">,</code> <code class="n">dateTag</code><code class="p">):</code>&#13;
        <code class="n">Website</code><code class="o">.</code><code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">name</code><code class="p">,</code> <code class="n">url</code><code class="p">,</code> <code class="n">titleTag</code><code class="p">)</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">bodyTag</code> <code class="o">=</code> <code class="n">bodyTag</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">dateTag</code> <code class="o">=</code> <code class="n">dateTag</code>&#13;
</pre>&#13;
&#13;
<p>This <code>Product</code> page extends the <code>Website</code> base class and adds the attributes <code>product<span class="keep-together">Number</span></code> and <code>price</code> that apply only to products; the <code>Article</code> class adds the attributes <code>body</code> and <code>date</code>, which don’t apply to products.</p>&#13;
&#13;
<p>You can use these two classes to scrape, for example, a store website that might contain blog posts or press releases <a contenteditable="false" data-primary="web crawlers" data-secondary="structure" data-startref="wbwlct" data-type="indexterm" id="id507"/>in addition to products.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Thinking About Web Crawler Models" data-type="sect1"><div class="sect1" id="id244">&#13;
<h1>Thinking About Web Crawler Models</h1>&#13;
&#13;
<p>Collecting information from the internet can be like drinking from a fire hose. There’s a lot of stuff out there, and it’s not always clear what you need or how you need it. The first step of any large web scraping project (and even some of the small ones) should be to answer these questions.</p>&#13;
&#13;
<p>When collecting similar data across multiple domains or from multiple sources, your goal should almost always be to try to normalize it. Dealing with data with identical and comparable fields is much easier than dealing with data that is completely dependent on the format of its original source.</p>&#13;
&#13;
<p>In many cases, you should build scrapers under the assumption that more sources of data will be added to them in the future, with the goal to minimize the programming overhead required to add these new sources. Even if a website doesn’t appear to fit your model at first glance, there may be more subtle ways that it does conform. Being able to see these underlying patterns can save you time, money, and a lot of headaches in the long run.</p>&#13;
&#13;
<p>The connections between pieces of data should also not be ignored. Are you looking for information that has properties such as “type,” “size,” or “topic” that span data sources? How do you store, retrieve, and conceptualize these attributes?</p>&#13;
&#13;
<p>Software architecture is a broad and important topic that can take an entire career to master. Fortunately, software architecture for web scraping is a much more finite and manageable set of skills that can be relatively easily acquired. As you continue to scrape data, you will find the same basic patterns occurring over and over. Creating a well-structured web scraper doesn’t require a lot of arcane knowledge, but it does require taking a moment to step back and think about your project.</p>&#13;
</div></section>&#13;
</div></section></body></html>