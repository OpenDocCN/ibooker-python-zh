# 附录 A. Python 异步支持的简史

> 尽管很长一段时间以来一直是 Python 标准库的一部分，但 asyncore 模块由于其不灵活的 API 而存在根本性缺陷，无法满足现代异步网络模块的期望。
> 
> 此外，其方法过于简单，无法为开发人员提供充分利用异步网络潜力所需的所有工具。
> 
> 目前在生产中使用的最流行的解决方案涉及使用第三方库。这些通常提供令人满意的解决方案，但这些库之间缺乏兼容性，这往往使得代码库与它们使用的库非常紧密地耦合在一起。
> 
> Laurens van Houtven，[PEP 3153 (2011 年 5 月)：异步 IO 支持](https://oreil.ly/pNyro)

本附录的目标是描述 Python 中异步编程背后的一些历史，我想要表达的观点是，我们已经等待了 20 年的关键创新是*语言语法*。

许多人会对此感到惊讶，但是 Asyncio 并*不*是 Python 尝试添加异步网络编程支持的第一个尝试，如下所述。

# 在开始之初，有 asyncore

> [与 asyncore 相比，] Twisted 在几乎所有可能的方面都更好。它更具可移植性，更丰富功能，更简单，更可扩展，维护更好，文档更好，并且可以做出美味的煎蛋卷。对于所有目的而言，Asyncore 基本上已经过时了。
> 
> Glyph，约 2010 年在[Stack Overflow](https://oreil.ly/4pEeJ)
> 
> asyncore 应该真正被视为历史遗物，不应实际使用。
> 
> Jean-Paul Calderone，约 2013 年在[Stack Overflow](https://oreil.ly/oWGEZ)

支持所谓*异步特性*的功能在很久以前就添加到了 Python 中的`asyncore`模块。正如您可以从前面的引述中看到的那样，`asyncore`的接受度不高，使用率也很低。这位作者感到惊讶的是*这个模块被添加的时间*：在 Python 1.5.2 中！这是在 CPython 源代码的*Lib/asyncore.py*顶部写的：

```py
# -*- Mode: Python -*-
#   Id: asyncore.py,v 2.51 2000/09/07 22:29:26 rushing Exp
#   Author: Sam Rushing <rushing@nightmare.com>

# =============================================================
# Copyright 1996 by Sam Rushing
```

此外，Python [`asyncore`文档的第一段](https://oreil.ly/tPp8_)与今天的`asyncio`文档几乎相同：

> 此模块为编写异步套接字服务客户端和服务器提供了基本的基础设施。
> 
> 在单个处理器上使程序“同时做多件事情”有两种方法。多线程编程是最简单和最流行的方法，但还有另一种非常不同的技术，可以让你几乎享有多线程的所有优势，而不实际使用多个线程。如果你的程序主要是 I/O 绑定，这种方法确实很实用。如果你的程序是处理器绑定的，那么预先调度的线程可能是你真正需要的。然而，网络服务器很少是处理器绑定的。

1996 年，啊？显然，早在当时，Python 已经可以在单个线程中管理多个套接字事件了（事实上，在其他语言中比这个时间更早）。那么，在过去的四分之一个世纪里，是什么改变了 Asyncio 变得特别？

答案是语言语法。我们将在下一节更仔细地研究这个问题，但在结束这个回顾过去窗口之前，值得注意的是，Python 3.6 文档中关于`asyncore`（大约在 2016 年 12 月）的一个小细节：

> 源代码：Lib/asyncore.py
> 
> *自 3.6 版起已弃用*：请改用`asyncio`。

# 原生协程之路

请记住，我使用术语*Asyncio*来指代 Python 语言语法的变化，以及标准库中的新`asyncio`模块。¹ 让我们更深入地探讨这种区别。

如今，Python 中异步编程的支持有三个明显的组成部分，考虑它们何时被添加是很有趣的：

语言语法：生成器

关键字`yield`，在 Python 2.2（2001 年）中在[PEP 255](https://oreil.ly/35Czp)中添加，并在 Python 2.5（2005 年）中在[PEP 342](https://oreil.ly/UDWl_)中通过生成器对象的`send()`和`throw()`方法增强，这使得生成器首次可以用作协程。

关键字`yield from`，在 Python 3.3（2009 年）中在[PEP 380](https://oreil.ly/38jVG)中添加，使得在处理生成器的*嵌套*yield 时更加容易，特别是在生成器被用作临时协程的情况下。

语言语法：协程

关键字`async`和`await`，在 Python 3.5（2015 年）中在[PEP 492](https://oreil.ly/XJUmS)中添加，为协程作为一种独立语言特性提供了全面支持。这也意味着生成器可以再次被用作生成器，即使在协程函数内部也可以。

库模块：`asyncio`

在 Python 3.4（2012 年）中在[PEP 3156](https://oreil.ly/QKG4m)中添加，为框架设计者和最终用户开发者提供了“电池包含”支持，以处理协程和执行网络 I/O。`asyncio`中事件循环的设计旨在为其他现有的第三方框架（如 Tornado 和 Twisted）提供一个标准化的共同基础。

这三者彼此非常不同，尽管你可能会因为 Python 中这些特性的发展历史难以追踪而感到困惑，这也可以理解。

新的 `async` 和 `await` 语法对其他编程语言也产生了重大影响，比如 JavaScript、C#、Scala、Kotlin 和 Dart。

达到这一点花费了大量时间和成千上万参与 Python 项目的程序员的思考。

¹ `asyncio` 是在 Python 3.4 中添加的。
