<html><head></head><body><section data-pdf-bookmark="Chapter 9. Service Layer" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch09">&#13;
<h1><span class="label">Chapter 9. </span>Service Layer</h1>&#13;
&#13;
<blockquote>&#13;
<p>What was that middle thing?</p>&#13;
<p data-type="attribution">Otto West, <cite><em>A Fish Called Wanda</em></cite></p>&#13;
</blockquote>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Preview" data-type="sect1"><div class="sect1" id="id81">&#13;
<h1>Preview</h1>&#13;
&#13;
<p>This <a data-primary="Service layer" data-type="indexterm" id="ibd037"/>chapter expands on the Service layer—the middle thing. A leaky roof can cost a lot of money.&#13;
Leaky software isn’t as obvious&#13;
but can cost a lot of time and effort.&#13;
How can you structure your application&#13;
so that the layers don’t leak?&#13;
In particular,&#13;
what should and should not go into the&#13;
Service layer in the middle?</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Defining a Service" data-type="sect1"><div class="sect1" id="id198">&#13;
<h1>Defining a Service</h1>&#13;
&#13;
<p>The Service layer is the heart of the website,&#13;
its reason for being.&#13;
It takes requests from multiple sources,&#13;
accesses the data that is the DNA of the site,&#13;
and returns responses.</p>&#13;
&#13;
<p>Common service patterns include a combination of the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a data-primary="Service layer" data-secondary="common service patterns" data-type="indexterm" id="id651"/>Create / retrieve / change (partially or completely) / delete</p>&#13;
</li>&#13;
<li>&#13;
<p>One thing / multiple things</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>At the RESTful router layer, the nouns are <em>resources</em>.&#13;
In this book, our resources will initially include cryptids (imaginary creatures) and people (cryptid explorers).</p>&#13;
&#13;
<p>Later, it will be possible to define related resources like these:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Places</p>&#13;
</li>&#13;
<li>&#13;
<p>Events (e.g., expeditions, sightings)</p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Layout" data-type="sect1"><div class="sect1" id="id199">&#13;
<h1>Layout</h1>&#13;
&#13;
<p><a data-primary="Service layer" data-secondary="file and directory layout" data-type="indexterm" id="id652"/>Here’s <a data-primary="file and directory layout" data-secondary="Service layer" data-type="indexterm" id="id653"/>the current file and directory layout:</p>&#13;
&#13;
<pre data-type="programlisting">main.py&#13;
web&#13;
├── __init__.py&#13;
├── creature.py&#13;
├── explorer.py&#13;
service&#13;
├── __init__.py&#13;
├── creature.py&#13;
├── explorer.py&#13;
data&#13;
├── __init__.py&#13;
├── creature.py&#13;
├── explorer.py&#13;
model&#13;
├── __init__.py&#13;
├── creature.py&#13;
├── explorer.py&#13;
fake&#13;
├── __init__.py&#13;
├── creature.py&#13;
├── explorer.py&#13;
└── test</pre>&#13;
&#13;
<p>In this chapter, you’ll fiddle with files in the <em>service</em> directory.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Protection" data-type="sect1"><div class="sect1" id="id200">&#13;
<h1>Protection</h1>&#13;
&#13;
<p><a data-primary="Service layer" data-secondary="protection" data-type="indexterm" id="id654"/>One nice thing about layers is that you don’t have to worry about&#13;
everything.&#13;
The Service layer cares only about what goes into and out of the data.&#13;
As you’ll see in <a data-type="xref" href="ch11.html#ch11">Chapter 11</a>,&#13;
a higher layer (in this book, <em>Web</em>)&#13;
can handle the authentication and authorization messiness.&#13;
The functions to create, modify,&#13;
and delete should not be&#13;
wide open,&#13;
and even the&#13;
<code>get</code> functions might eventually need some limits.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Functions" data-type="sect1"><div class="sect1" id="id201">&#13;
<h1>Functions</h1>&#13;
&#13;
<p><a data-primary="Service layer" data-secondary="functions" data-type="indexterm" id="ibd038"/>Let’s start with <em>creature.py</em>.&#13;
At this point, the needs of <em>explorer.py</em> will be almost the same,&#13;
and we can borrow almost everything.&#13;
It’s so tempting to write a single service file that&#13;
handles both,&#13;
but, almost inevitably,&#13;
at some point we’ll need to handle them differently.</p>&#13;
&#13;
<p>Also at this point, the service file is&#13;
pretty much a pass-through layer.&#13;
This is a case in which a little extra structure at the start&#13;
will pay off later.&#13;
Much as you did for <em>web/creature.py</em> and <em>web/explorer.py</em>&#13;
in <a data-type="xref" href="ch08.html#ch08">Chapter 8</a>,&#13;
you’ll define service modules for both,&#13;
and hook both of them up to their&#13;
corresponding <em>fake</em> data modules&#13;
for now&#13;
(Examples <a data-type="xref" data-xrefstyle="select:labelnumber" href="#ex-9-1">9-1</a> and&#13;
<a data-type="xref" data-xrefstyle="select:labelnumber" href="#ex-9-2">9-2</a>).</p>&#13;
<div data-type="example" id="ex-9-1">&#13;
<h5><span class="label">Example 9-1. </span>An initial <span class="plain">service/creature.py</span> file</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">models.creature</code> <code class="kn">import</code> <code class="n">Creature</code>&#13;
<code class="kn">import</code> <code class="nn">fake.creature</code> <code class="k">as</code> <code class="nn">data</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">get_all</code><code class="p">()</code> <code class="o">-&gt;</code> <code class="nb">list</code><code class="p">[</code><code class="n">Creature</code><code class="p">]:</code>&#13;
    <code class="k">return</code> <code class="n">data</code><code class="o">.</code><code class="n">get_all</code><code class="p">()</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">get_one</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Creature</code> <code class="o">|</code> <code class="kc">None</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">data</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="nb">id</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">create</code><code class="p">(</code><code class="n">creature</code><code class="p">:</code> <code class="n">Creature</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Creature</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">data</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">creature</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">replace</code><code class="p">(</code><code class="nb">id</code><code class="p">,</code> <code class="n">creature</code><code class="p">:</code> <code class="n">Creature</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Creature</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">data</code><code class="o">.</code><code class="n">replace</code><code class="p">(</code><code class="nb">id</code><code class="p">,</code> <code class="n">creature</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">modify</code><code class="p">(</code><code class="nb">id</code><code class="p">,</code> <code class="n">creature</code><code class="p">:</code> <code class="n">Creature</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Creature</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">data</code><code class="o">.</code><code class="n">modify</code><code class="p">(</code><code class="nb">id</code><code class="p">,</code> <code class="n">creature</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">delete</code><code class="p">(</code><code class="nb">id</code><code class="p">,</code> <code class="n">creature</code><code class="p">:</code> <code class="n">Creature</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">bool</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">data</code><code class="o">.</code><code class="n">delete</code><code class="p">(</code><code class="nb">id</code><code class="p">)</code></pre></div>&#13;
<div data-type="example" id="ex-9-2">&#13;
<h5><span class="label">Example 9-2. </span>An initial <span class="plain">service/explorer.py</span> file</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">models.explorer</code> <code class="kn">import</code> <code class="n">Explorer</code>&#13;
<code class="kn">import</code> <code class="nn">fake.explorer</code> <code class="k">as</code> <code class="nn">data</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">get_all</code><code class="p">()</code> <code class="o">-&gt;</code> <code class="nb">list</code><code class="p">[</code><code class="n">Explorer</code><code class="p">]:</code>&#13;
    <code class="k">return</code> <code class="n">data</code><code class="o">.</code><code class="n">get_all</code><code class="p">()</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">get_one</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Explorer</code> <code class="o">|</code> <code class="kc">None</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">data</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">name</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">create</code><code class="p">(</code><code class="n">explorer</code><code class="p">:</code> <code class="n">Explorer</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Explorer</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">data</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">explorer</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">replace</code><code class="p">(</code><code class="nb">id</code><code class="p">,</code> <code class="n">explorer</code><code class="p">:</code> <code class="n">Explorer</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Explorer</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">data</code><code class="o">.</code><code class="n">replace</code><code class="p">(</code><code class="nb">id</code><code class="p">,</code> <code class="n">explorer</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">modify</code><code class="p">(</code><code class="nb">id</code><code class="p">,</code> <code class="n">explorer</code><code class="p">:</code> <code class="n">Explorer</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Explorer</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">data</code><code class="o">.</code><code class="n">modify</code><code class="p">(</code><code class="nb">id</code><code class="p">,</code> <code class="n">explorer</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">delete</code><code class="p">(</code><code class="nb">id</code><code class="p">,</code> <code class="n">explorer</code><code class="p">:</code> <code class="n">Explorer</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">bool</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">data</code><code class="o">.</code><code class="n">delete</code><code class="p">(</code><code class="nb">id</code><code class="p">)</code></pre></div>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>The syntax of the <code>get_one()</code> function’s return value&#13;
(<code>Creature | None</code>)&#13;
needs at least Python 3.9.&#13;
For earlier versions, you need<a data-primary="Service layer" data-secondary="funtions" data-startref="ibd038" data-type="indexterm" id="id655"/> <code>Optional</code>:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">typing</code> <code class="kn">import</code> <code class="n">Optional</code>&#13;
<code class="o">...</code>&#13;
<code class="k">def</code> <code class="nf">get_one</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Optional</code><code class="p">[</code><code class="n">Creature</code><code class="p">]:</code>&#13;
<code class="o">...</code></pre>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Test!" data-type="sect1"><div class="sect1" id="id202">&#13;
<h1>Test!</h1>&#13;
&#13;
<p><a data-primary="Service layer" data-secondary="testing" data-type="indexterm" id="ibd039"/>Now <a data-primary="testing" data-secondary="Service layer" data-type="indexterm" id="ibd042"/>that the codebase is filling out a bit,&#13;
it’s a good time to introduce automated tests.&#13;
(The Web tests in the previous chapter have all been manual tests.)&#13;
So let’s make some directories:</p>&#13;
<dl>&#13;
<dt>test</dt>&#13;
<dd>&#13;
<p>A top-level directory, alongside&#13;
<em>web</em>, <em>service</em>, <em>data</em>, and <em>model</em>.</p>&#13;
<dl>&#13;
<dt>unit</dt>&#13;
<dd>&#13;
<p>Exercise single functions,&#13;
but don’t cross layer boundaries.</p>&#13;
<dl>&#13;
<dt>web</dt>&#13;
<dd>&#13;
<p>Web-layer unit tests.</p>&#13;
</dd>&#13;
<dt>service</dt>&#13;
<dd>&#13;
<p>Service-layer unit tests.</p>&#13;
</dd>&#13;
<dt>data</dt>&#13;
<dd>&#13;
<p>Data-layer unit tests.</p>&#13;
</dd>&#13;
</dl>&#13;
</dd>&#13;
<dt>full</dt>&#13;
<dd>&#13;
<p>Also known as <em>end-to-end</em> or <em>contract</em>&#13;
tests, these span all layers at once.&#13;
They address the API endpoints&#13;
in the Web layer.</p>&#13;
</dd>&#13;
</dl>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>The directories have the <em>test_</em> prefix or&#13;
<em>_test</em> suffix for use by pytest,&#13;
which you’ll start to see in <a data-type="xref" href="#ex-9-4">Example 9-4</a> (which runs the test in <a data-type="xref" href="#ex-9-3">Example 9-3</a>).</p>&#13;
&#13;
<p>Before testing, a few API design choices need to be made.&#13;
What should be returned by the <code>get_one()</code> function&#13;
if a matching <code>Creature</code> or <code>Explorer</code> isn’t found?&#13;
You can return <code>None</code>, as in <a data-type="xref" href="#ex-9-2">Example 9-2</a>.&#13;
Or you could raise an exception.&#13;
None of the built-in Python exception types&#13;
deal directly with missing values:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><code>TypeError</code> may be the closest, because <code>None</code> is&#13;
a different type than <code>Creature</code>.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>ValueError</code> is more suited for the wrong value for a&#13;
given type, but I guess you could say that passing a&#13;
missing string <code>id</code> to <code>get_one(id)</code> qualifies.</p>&#13;
</li>&#13;
<li>&#13;
<p>You could define your own <code>MissingError</code> if you really want to.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Whichever method you choose, the effects will bubble up all&#13;
the way to the top layer.</p>&#13;
&#13;
<p>Let’s go with the <code>None</code> alternative&#13;
rather than the exception for now.&#13;
After all, that’s what <em>none</em> means.&#13;
<a data-type="xref" href="#ex-9-3">Example 9-3</a> is a test.</p>&#13;
<div data-type="example" id="ex-9-3">&#13;
<h5><span class="label">Example 9-3. </span>Service test <span class="plain">test/unit/service/test_creature.py</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">model.creature</code> <code class="kn">import</code> <code class="n">Creature</code>&#13;
<code class="kn">from</code> <code class="nn">service</code> <code class="kn">import</code> <code class="n">creature</code> <code class="k">as</code> <code class="n">code</code>&#13;
&#13;
<code class="n">sample</code> <code class="o">=</code> <code class="n">Creature</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s2">"yeti"</code><code class="p">,</code>&#13;
        <code class="n">country</code><code class="o">=</code><code class="s2">"CN"</code><code class="p">,</code>&#13;
        <code class="n">area</code><code class="o">=</code><code class="s2">"Himalayas"</code><code class="p">,</code>&#13;
        <code class="n">description</code><code class="o">=</code><code class="s2">"Hirsute Himalayan"</code><code class="p">,</code>&#13;
        <code class="n">aka</code><code class="o">=</code><code class="s2">"Abominable Snowman"</code><code class="p">,</code>&#13;
        <code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_create</code><code class="p">():</code>&#13;
    <code class="n">resp</code> <code class="o">=</code> <code class="n">code</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">sample</code><code class="p">)</code>&#13;
    <code class="k">assert</code> <code class="n">resp</code> <code class="o">==</code> <code class="n">sample</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_get_exists</code><code class="p">():</code>&#13;
    <code class="n">resp</code> <code class="o">=</code> <code class="n">code</code><code class="o">.</code><code class="n">get_one</code><code class="p">(</code><code class="s2">"yeti"</code><code class="p">)</code>&#13;
    <code class="k">assert</code> <code class="n">resp</code> <code class="o">==</code> <code class="n">sample</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_get_missing</code><code class="p">():</code>&#13;
    <code class="n">resp</code> <code class="o">=</code> <code class="n">code</code><code class="o">.</code><code class="n">get_one</code><code class="p">(</code><code class="s2">"boxturtle"</code><code class="p">)</code>&#13;
    <code class="k">assert</code> <code class="n">data</code> <code class="ow">is</code> <code class="kc">None</code></pre></div>&#13;
&#13;
<p>Run the test in <a data-type="xref" href="#ex-9-4">Example 9-4</a>.</p>&#13;
<div data-type="example" id="ex-9-4">&#13;
<h5><span class="label">Example 9-4. </span>Run the service test</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>pytest -v test/unit/service/test_creature.py</strong>&#13;
test_creature.py::test_create PASSED                         [ 16%]&#13;
test_creature.py::test_get_exists PASSED                     [ 50%]&#13;
test_creature.py::test_get_missing PASSED                    [ 66%]&#13;
&#13;
======================== 3 passed in 0.06s =========================</pre></div>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>In <a data-type="xref" href="ch10.html#ch10">Chapter 10</a>, <code>get_one()</code> will no longer return <code>None</code>&#13;
for a missing creature,&#13;
and the <code>test_get_missing()</code> test in <a data-type="xref" href="#ex-9-4">Example 9-4</a> would fail.&#13;
But that will be <a data-primary="testing" data-secondary="Service layer" data-startref="ibd042" data-type="indexterm" id="id656"/>fixed<a data-primary="Service layer" data-secondary="testing" data-startref="ibd039" data-type="indexterm" id="id657"/>.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Other Service-Level Stuff" data-type="sect1"><div class="sect1" id="id309">&#13;
<h1>Other Service-Level Stuff</h1>&#13;
&#13;
<p>We’re in the middle of the stack now—the part that really defines our site’s purpose.&#13;
And so far, we’ve used it only to forward web requests&#13;
to the (next chapter’s) Data layer.</p>&#13;
&#13;
<p>So far, this book has developed the site iteratively,&#13;
building a minimal base for future work.&#13;
As you learn more about what you have,&#13;
what you can do,&#13;
and what users might want, you can branch out and experiment.&#13;
Some ideas might benefit only larger sites,&#13;
but here are some technical site-helper ideas:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Logging</p>&#13;
</li>&#13;
<li>&#13;
<p>Metrics</p>&#13;
</li>&#13;
<li>&#13;
<p>Monitoring</p>&#13;
</li>&#13;
<li>&#13;
<p>Tracing</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>This section discusses each of these.&#13;
We’ll revisit these options in <a data-type="xref" href="ch13.html#troubleshooting">“Troubleshooting”</a>,&#13;
to see if they can help diagnose problems.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Logging" data-type="sect2"><div class="sect2" id="id82">&#13;
<h2>Logging</h2>&#13;
&#13;
<p><a data-primary="Service layer" data-secondary="logging" data-type="indexterm" id="id658"/>FastAPI <a data-primary="logging" data-type="indexterm" id="id659"/>logs each API call to an endpoint—including the timestamp, method, and URL—but not any data delivered via the body or headers.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Metrics, Monitoring, Observability" data-type="sect2"><div class="sect2" id="id83">&#13;
<h2>Metrics, Monitoring, Observability</h2>&#13;
&#13;
<p>If you run a website, you probably want to know how it’s doing.&#13;
For an API website,&#13;
you might want to know&#13;
which endpoints are being accessed,&#13;
how many people are visiting, and so on.&#13;
<a data-primary="Service layer" data-secondary="metrics" data-type="indexterm" id="id660"/>Statistics<a data-primary="metrics" data-type="indexterm" id="id661"/> on such factors are called&#13;
<em>metrics</em>,&#13;
and <a data-primary="Service layer" data-secondary="monitoring" data-type="indexterm" id="id662"/>the gathering of them is&#13;
<em>monitoring</em>&#13;
<a data-primary="Service layer" data-secondary="observability" data-type="indexterm" id="id663"/>or <em>observability</em>.</p>&#13;
&#13;
<p>Popular metrics tools nowadays include <a href="https://prometheus.io">Prometheus</a> for gathering metrics and <a href="https://grafana.com"><span class="keep-together">Grafana</span></a> for displaying metrics.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Tracing" data-type="sect2"><div class="sect2" id="id84">&#13;
<h2>Tracing</h2>&#13;
&#13;
<p><a data-primary="Service layer" data-secondary="tracing" data-type="indexterm" id="ibd040"/>How <a data-primary="tracing" data-type="indexterm" id="ibd043"/>well is your site performing?&#13;
It’s common for metrics to be good overall,&#13;
but with disappointing results here or there.&#13;
Or the whole site may be a mess.&#13;
Either way, it’s useful to have a tool&#13;
that measures how long an API call takes, end to end—and not just overall time, but the time for each&#13;
intermediate step.&#13;
If something’s slow, you can find the weak link in the chain.&#13;
This is <em>tracing</em>.</p>&#13;
&#13;
<p>A new open source project&#13;
has taken earlier tracing products like&#13;
<a href="https://www.jaegertracing.io">Jaeger</a> and branded them as <a href="https://opentelemetry.io">OpenTelemetry</a>.&#13;
It has a&#13;
<a href="https://oreil.ly/gyL70">Python API</a>&#13;
and at least one&#13;
<a href="https://oreil.ly/L6RXV">integration with <span class="keep-together">FastAPI</span></a>.</p>&#13;
&#13;
<p>To install and configure OpenTelemetry with Python,&#13;
follow the instructions in <a data-primary="tracing" data-startref="ibd043" data-type="indexterm" id="id664"/>the <a href="https://oreil.ly/MBgd5">OpenTelemetry Python documentation</a><a data-primary="Service layer" data-secondary="tracing" data-startref="ibd040" data-type="indexterm" id="id665"/>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Other" data-type="sect2"><div class="sect2" id="id310">&#13;
<h2>Other</h2>&#13;
&#13;
<p>These production issues will be discussed in <a data-type="xref" href="ch13.html#ch13">Chapter 13</a>.&#13;
Besides these, what about our domain—cryptids and anything&#13;
associated with them?&#13;
Besides bare details on explorers and creatures,&#13;
what else might you want to take on?&#13;
You may come up with new ideas that require changes to&#13;
the models and other layers.&#13;
Here are some ideas you might try:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Links of explorers to the creatures that they seek</p>&#13;
</li>&#13;
<li>&#13;
<p>Sighting data</p>&#13;
</li>&#13;
<li>&#13;
<p>Expeditions</p>&#13;
</li>&#13;
<li>&#13;
<p>Photos and videos</p>&#13;
</li>&#13;
<li>&#13;
<p>Sasquatch mugs and T-shirts (<a data-type="xref" href="#fig-sasquatch-mug">Figure 9-1</a>)</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<figure><div class="figure" id="fig-sasquatch-mug">&#13;
<img alt="fapi 0901" src="assets/fapi_0901.png" width="200"/>&#13;
<h6><span class="label">Figure 9-1. </span>A word from our sponsor</h6>&#13;
</div></figure>&#13;
&#13;
<p>Each of these categories will generally require one or more&#13;
new models to be defined, and new modules and functions.&#13;
Some will be added in <a data-type="xref" href="part04.html#part4">Part IV</a>,&#13;
which is a gallery of applications added to the base&#13;
built here in <a data-type="xref" href="part03.html#part3">Part III</a>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Review" data-type="sect1"><div class="sect1" id="id85">&#13;
<h1>Review</h1>&#13;
&#13;
<p>In this chapter,&#13;
you replicated some functions from the Web layer&#13;
and moved the fake data that they worked with.&#13;
The goal was to initiate the new Service layer.&#13;
So far, it’s been a cookie-cutter process,&#13;
but it will evolve and diverge after this.&#13;
The next chapter builds the final Data layer,&#13;
yielding a truly live website<a data-primary="Service layer" data-startref="ibd037" data-type="indexterm" id="id666"/>.</p>&#13;
</div></section>&#13;
</div></section></body></html>