<html><head></head><body><section data-pdf-bookmark="Chapter 15. Data in Time: Processes and Concurrency" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch_systems">&#13;
<h1><span class="label">Chapter 15. </span>Data in Time: Processes and Concurrency</h1>&#13;
&#13;
<blockquote>&#13;
<p>One thing a computer can do that most humans can’t is be sealed up in a cardboard box and sit in a warehouse.</p>&#13;
<p data-type="attribution">Jack Handey</p>&#13;
</blockquote>&#13;
&#13;
<p>This chapter and the next two are a bit more challenging&#13;
than earlier ones. In this one we cover data in time (sequential and concurrent access on a single computer), and following that we look at data in a box (storage and retrieval with special files and databases) in <a data-type="xref" href="ch16.html#ch_databases">Chapter 16</a> and then data in space (networking) in <a data-type="xref" href="ch17.html#ch_networks">Chapter 17</a>.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Programs and Processes" data-type="sect1"><div class="sect1" id="programs_processes">&#13;
<h1>Programs and Processes</h1>&#13;
&#13;
<p>When you run an individual program,&#13;
your operating system creates a single <em>process</em>.&#13;
It uses system resources (CPU, memory, disk space)&#13;
and data structures in the operating system’s <em>kernel</em>&#13;
(file and network connections, usage statistics, and so on).&#13;
A process is isolated from other processes—it can’t see what other&#13;
processes are doing or interfere with them.</p>&#13;
&#13;
<p>The operating system keeps track of all the running processes,&#13;
giving each a little time to run and then switching to another,&#13;
with the twin goals of spreading the work around fairly&#13;
and being responsive&#13;
to the user.&#13;
You can see the state of your processes with&#13;
graphical interfaces such as the Mac’s Activity Monitor (macOS),&#13;
Task Manager on Windows-based computers,&#13;
or the <code>top</code> command in Linux.</p>&#13;
&#13;
<p>You can also access process data from your own programs.&#13;
The standard library’s <code>os</code> module provides a common way of&#13;
accessing some system information.&#13;
For instance, the following functions get the <em>process ID</em>&#13;
and the <em>current working directory</em>&#13;
of the running Python interpreter:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">os</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">os</code><code class="o">.</code><code class="n">getpid</code><code class="p">()</code>&#13;
<code class="go">76051</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">os</code><code class="o">.</code><code class="n">getcwd</code><code class="p">()</code>&#13;
<code class="go">'/Users/williamlubanovic'</code></pre>&#13;
&#13;
<p>And these get my <em>user ID</em> and <em>group ID</em>:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">os</code><code class="o">.</code><code class="n">getuid</code><code class="p">()</code>&#13;
<code class="go">501</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">os</code><code class="o">.</code><code class="n">getgid</code><code class="p">()</code>&#13;
<code class="go">20</code></pre>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Create a Process with subprocess" data-type="sect2"><div class="sect2" id="subprocess">&#13;
<h2>Create a Process with subprocess</h2>&#13;
&#13;
<p><a data-primary="processes" data-secondary="creating with subprocess module" data-type="indexterm" id="idm45794981977832"/><a data-primary="subprocess module" data-type="indexterm" id="idm45794981976664"/>All of the programs that you’ve seen here so far&#13;
have been individual processes.&#13;
You can start and stop other existing programs&#13;
from Python by using the&#13;
standard library’s <code>subprocess</code> module.&#13;
<a data-primary="getoutput() function" data-type="indexterm" id="idm45794981927240"/>If you just want to run another program in a shell&#13;
and grab whatever output it created&#13;
(both standard output and standard error output),&#13;
use the <code>getoutput()</code> function.&#13;
Here, we get the output of the Unix <code>date</code> program:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">subprocess</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">ret</code> <code class="o">=</code> <code class="n">subprocess</code><code class="o">.</code><code class="n">getoutput</code><code class="p">(</code><code class="s">'date'</code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">ret</code>&#13;
<code class="go">'Sun Mar 30 22:54:37 CDT 2014'</code></pre>&#13;
&#13;
<p>You won’t get anything back until the process ends.&#13;
If you need to call something that might take a lot of time,&#13;
see the discussion on <em>concurrency</em> in <a data-type="xref" href="#concurrency">“Concurrency”</a>.&#13;
Because the argument to <code>getoutput()</code> is a string representing a&#13;
complete shell command, you can include arguments, pipes,&#13;
<code>&lt;</code> and <code>&gt;</code> I/O redirection, and so on:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">ret</code> <code class="o">=</code> <code class="n">subprocess</code><code class="o">.</code><code class="n">getoutput</code><code class="p">(</code><code class="s">'date -u'</code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">ret</code>&#13;
<code class="go">'Mon Mar 31 03:55:01 UTC 2014'</code></pre>&#13;
&#13;
<p>Piping that output string to the <code>wc</code> command counts&#13;
one line, six “words,” and 29 characters:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">ret</code> <code class="o">=</code> <code class="n">subprocess</code><code class="o">.</code><code class="n">getoutput</code><code class="p">(</code><code class="s">'date -u | wc'</code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">ret</code>&#13;
<code class="go">'       1       6      29'</code></pre>&#13;
&#13;
<p><a data-primary="check_output () function" data-type="indexterm" id="idm45794981884520"/>A variant method called <code>check_output()</code> takes a list of&#13;
the command and arguments.&#13;
By default it returns standard output only&#13;
as type bytes rather than a string,&#13;
and does not use the shell:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">ret</code> <code class="o">=</code> <code class="n">subprocess</code><code class="o">.</code><code class="n">check_output</code><code class="p">([</code><code class="s">'date'</code><code class="p">,</code> <code class="s">'-u'</code><code class="p">])</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">ret</code>&#13;
<code class="go">b'Mon Mar 31 04:01:50 UTC 2014\n'</code></pre>&#13;
&#13;
<p class="pagebreak-before"><a data-primary="getstatusoutput() function" data-type="indexterm" id="idm45794981737160"/>To show the exit status of the other program,&#13;
<code>getstatusoutput()</code> returns a tuple&#13;
with the status code and output:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">ret</code> <code class="o">=</code> <code class="n">subprocess</code><code class="o">.</code><code class="n">getstatusoutput</code><code class="p">(</code><code class="s">'date'</code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">ret</code>&#13;
<code class="go">(0, 'Sat Jan 18 21:36:23 CST 2014')</code></pre>&#13;
&#13;
<p><a data-primary="call() function" data-type="indexterm" id="idm45794981702968"/>If you don’t want to capture the output&#13;
but might want to know its exit status, use <code>call()</code>:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">ret</code> <code class="o">=</code> <code class="n">subprocess</code><code class="o">.</code><code class="n">call</code><code class="p">(</code><code class="s">'date'</code><code class="p">)</code>&#13;
<code class="go">Sat Jan 18 21:33:11 CST 2014</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">ret</code>&#13;
<code class="go">0</code></pre>&#13;
&#13;
<p>(In Unix-like systems, <code>0</code> is usually the exit status for success.)</p>&#13;
&#13;
<p>That date and time was printed to output&#13;
but not captured within our program.&#13;
So, we saved the return code as <code>ret</code>.</p>&#13;
&#13;
<p>You can run programs with arguments in two ways.&#13;
The first is to specify them in a single string.&#13;
Our sample command is <code>date -u</code>,&#13;
which prints the current date and time in UTC:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">ret</code> <code class="o">=</code> <code class="n">subprocess</code><code class="o">.</code><code class="n">call</code><code class="p">(</code><code class="s">'date -u'</code><code class="p">,</code> <code class="n">shell</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>&#13;
<code class="go">Tue Jan 21 04:40:04 UTC 2014</code></pre>&#13;
&#13;
<p>You need that <code>shell=True</code> to recognize&#13;
the command line <code>date -u</code>,&#13;
splitting it into separate strings and possibly&#13;
expanding any wildcard characters such as <code>*</code>&#13;
(we didn’t use any in this example).</p>&#13;
&#13;
<p>The second method makes a list of the arguments,&#13;
so it doesn’t need to call the shell:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">ret</code> <code class="o">=</code> <code class="n">subprocess</code><code class="o">.</code><code class="n">call</code><code class="p">([</code><code class="s">'date'</code><code class="p">,</code> <code class="s">'-u'</code><code class="p">])</code>&#13;
<code class="go">Tue Jan 21 04:41:59 UTC 2014</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Create a Process with multiprocessing" data-type="sect2"><div class="sect2" id="multiprocessing">&#13;
<h2>Create a Process with multiprocessing</h2>&#13;
&#13;
<p><a data-primary="multiprocessing module" data-type="indexterm" id="idm45794981543592"/><a data-primary="processes" data-secondary="creating with multiprocessing module" data-type="indexterm" id="idm45794981542664"/>You can run a Python function as a separate process,&#13;
or even create multiple independent processes&#13;
with the <code>multiprocessing</code> module.&#13;
The sample code in <a data-type="xref" href="#ch15_ex01">Example 15-1</a> is short and simple;&#13;
save it as <em>mp.py</em>&#13;
and then run it by typing <code>python mp.py</code>:</p>&#13;
<div data-type="example" id="ch15_ex01">&#13;
<h5><span class="label">Example 15-1. </span>mp.py</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">multiprocessing</code>&#13;
<code class="kn">import</code> <code class="nn">os</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">whoami</code><code class="p">(</code><code class="n">what</code><code class="p">):</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="s2">"Process </code><code class="si">%s</code><code class="s2"> says: </code><code class="si">%s</code><code class="s2">"</code> <code class="o">%</code> <code class="p">(</code><code class="n">os</code><code class="o">.</code><code class="n">getpid</code><code class="p">(),</code> <code class="n">what</code><code class="p">))</code>&#13;
&#13;
<code class="k">if</code> <code class="nv-Magic">__name__</code> <code class="o">==</code> <code class="s2">"__main__"</code><code class="p">:</code>&#13;
    <code class="n">whoami</code><code class="p">(</code><code class="s2">"I'm the main program"</code><code class="p">)</code>&#13;
    <code class="k">for</code> <code class="n">n</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="mi">4</code><code class="p">):</code>&#13;
        <code class="n">p</code> <code class="o">=</code> <code class="n">multiprocessing</code><code class="o">.</code><code class="n">Process</code><code class="p">(</code><code class="n">target</code><code class="o">=</code><code class="n">whoami</code><code class="p">,</code>&#13;
          <code class="n">args</code><code class="o">=</code><code class="p">(</code><code class="s2">"I'm function </code><code class="si">%s</code><code class="s2">"</code> <code class="o">%</code> <code class="n">n</code><code class="p">,))</code>&#13;
        <code class="n">p</code><code class="o">.</code><code class="n">start</code><code class="p">()</code></pre></div>&#13;
&#13;
<p>When I run this, my output looks like this:</p>&#13;
&#13;
<pre data-type="programlisting">Process 6224 says: I'm the main program&#13;
Process 6225 says: I'm function 0&#13;
Process 6226 says: I'm function 1&#13;
Process 6227 says: I'm function 2&#13;
Process 6228 says: I'm function 3</pre>&#13;
&#13;
<p>The <code>Process()</code> function spawned a new process and&#13;
ran the <code>do_this()</code>&#13;
function in it.&#13;
Because we did this in a loop that had four passes,&#13;
we generated four new processes that executed&#13;
<code>do_this()</code> and then exited.</p>&#13;
&#13;
<p>The <code>multiprocessing</code> module has more bells and whistles than&#13;
a clown on a calliope.&#13;
It’s really intended for those times when you need to&#13;
farm out some task to multiple processes&#13;
to save overall time;&#13;
for example, downloading web pages for scraping,&#13;
resizing images,&#13;
and so on.&#13;
It includes ways to queue tasks,&#13;
enable intercommunication among processes,&#13;
and wait for all the processes to finish.&#13;
<a data-type="xref" href="#concurrency">“Concurrency”</a> delves into some of these details.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Kill a Process with terminate()" data-type="sect2"><div class="sect2" id="terminate">&#13;
<h2>Kill a Process with terminate()</h2>&#13;
&#13;
<p><a data-primary="processes" data-secondary="killing" data-type="indexterm" id="idm45794981465928"/><a data-primary="terminate() function" data-type="indexterm" id="idm45794981464952"/>If you created one or more processes and want to&#13;
terminate one for some reason&#13;
(perhaps it’s stuck in a loop, or maybe you’re bored,&#13;
or you want to be an evil overlord),&#13;
use <code>terminate()</code>.&#13;
In <a data-type="xref" href="#ch15_ex1">Example 15-2</a>,&#13;
our process would count to a million,&#13;
sleeping at each step for a second,&#13;
and printing an irritating message.&#13;
However, our main program runs out of patience in five seconds&#13;
and nukes it from orbit.</p>&#13;
<div data-type="example" id="ch15_ex1">&#13;
<h5><span class="label">Example 15-2. </span>mp2.py</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">multiprocessing</code>&#13;
<code class="kn">import</code> <code class="nn">time</code>&#13;
<code class="kn">import</code> <code class="nn">os</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">whoami</code><code class="p">(</code><code class="n">name</code><code class="p">):</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="s2">"I'm </code><code class="si">%s</code><code class="s2">, in process </code><code class="si">%s</code><code class="s2">"</code> <code class="o">%</code> <code class="p">(</code><code class="n">name</code><code class="p">,</code> <code class="n">os</code><code class="o">.</code><code class="n">getpid</code><code class="p">()))</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">loopy</code><code class="p">(</code><code class="n">name</code><code class="p">):</code>&#13;
    <code class="n">whoami</code><code class="p">(</code><code class="n">name</code><code class="p">)</code>&#13;
    <code class="n">start</code> <code class="o">=</code> <code class="mi">1</code>&#13;
    <code class="n">stop</code> <code class="o">=</code> <code class="mi">1000000</code>&#13;
    <code class="k">for</code> <code class="n">num</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">start</code><code class="p">,</code> <code class="n">stop</code><code class="p">):</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="s2">"</code><code class="se">\t</code><code class="s2">Number </code><code class="si">%s</code><code class="s2"> of </code><code class="si">%s</code><code class="s2">. Honk!"</code> <code class="o">%</code> <code class="p">(</code><code class="n">num</code><code class="p">,</code> <code class="n">stop</code><code class="p">))</code>&#13;
        <code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>&#13;
&#13;
<code class="k">if</code> <code class="nv-Magic">__name__</code> <code class="o">==</code> <code class="s2">"__main__"</code><code class="p">:</code>&#13;
    <code class="n">whoami</code><code class="p">(</code><code class="s2">"main"</code><code class="p">)</code>&#13;
    <code class="n">p</code> <code class="o">=</code> <code class="n">multiprocessing</code><code class="o">.</code><code class="n">Process</code><code class="p">(</code><code class="n">target</code><code class="o">=</code><code class="n">loopy</code><code class="p">,</code> <code class="n">args</code><code class="o">=</code><code class="p">(</code><code class="s2">"loopy"</code><code class="p">,))</code>&#13;
    <code class="n">p</code><code class="o">.</code><code class="n">start</code><code class="p">()</code>&#13;
    <code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mi">5</code><code class="p">)</code>&#13;
    <code class="n">p</code><code class="o">.</code><code class="n">terminate</code><code class="p">()</code></pre></div>&#13;
&#13;
<p>When I run this program, I get the following:</p>&#13;
&#13;
<pre data-type="programlisting">I'm main, in process 97080&#13;
I'm loopy, in process 97081&#13;
    Number 1 of 1000000. Honk!&#13;
    Number 2 of 1000000. Honk!&#13;
    Number 3 of 1000000. Honk!&#13;
    Number 4 of 1000000. Honk!&#13;
    Number 5 of 1000000. Honk!</pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Get System Info with os" data-type="sect2"><div class="sect2" id="os">&#13;
<h2>Get System Info with os</h2>&#13;
&#13;
<p><a data-primary="os module" data-type="indexterm" id="idm45794981339784"/><a data-primary="processes" data-secondary="system information" data-type="indexterm" id="idm45794981339080"/>The standard <code>os</code> package provides a lot of&#13;
details on your system,&#13;
and lets you control some of it&#13;
if you run your Python script as a privileged user&#13;
(root or administrator).&#13;
Besides file and directory functions&#13;
that are covered in <a data-type="xref" href="ch14.html#ch_files">Chapter 14</a>,&#13;
it has informational functions like these&#13;
(run on an iMac):</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">os</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">os</code><code class="o">.</code><code class="n">uname</code><code class="p">()</code>&#13;
<code class="go">posix.uname_result(sysname='Darwin',</code>&#13;
<code class="go">nodename='iMac.local',</code>&#13;
<code class="go">release='18.5.0',</code>&#13;
<code class="go">version='Darwin Kernel Version 18.5.0: Mon Mar 11 20:40:32 PDT 2019;</code>&#13;
<code class="go">  root:xnu-4903.251.3~3/RELEASE_X86_64',</code>&#13;
<code class="go">machine='x86_64')</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">os</code><code class="o">.</code><code class="n">getloadavg</code><code class="p">()</code>&#13;
<code class="go">(1.794921875, 1.93115234375, 2.2587890625)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">os</code><code class="o">.</code><code class="n">cpu_count</code><code class="p">()</code>&#13;
<code class="go">4</code></pre>&#13;
&#13;
<p><a data-primary="system() function" data-type="indexterm" id="idm45794981335176"/>A useful function is <code>system()</code>,&#13;
which executes a command string&#13;
as though you typed it at a terminal:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">os</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">os</code><code class="o">.</code><code class="n">system</code><code class="p">(</code><code class="s">'date -u'</code><code class="p">)</code>&#13;
<code class="go">Tue Apr 30 13:10:09 UTC 2019</code>&#13;
<code class="go">0</code></pre>&#13;
&#13;
<p>It’s a grab bag.&#13;
See the <a href="https://oreil.ly/3r6xN">docs</a>&#13;
for interesting tidbits.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Get Process Info with psutil" data-type="sect2"><div class="sect2" id="psutil">&#13;
<h2>Get Process Info with psutil</h2>&#13;
&#13;
<p><a data-primary="processes" data-secondary="process information" data-type="indexterm" id="idm45794981288136"/><a data-primary="psutil package" data-type="indexterm" id="idm45794981287160"/>The third-party package&#13;
<a href="https://oreil.ly/pHpJD">psutil</a>&#13;
also provides system and process information for&#13;
Linux, Unix, macOS, and Windows systems.</p>&#13;
&#13;
<p>You can guess how to install it:</p>&#13;
<pre>$ <strong>pip install psutil</strong></pre>&#13;
&#13;
<p>Coverage includes the following:</p>&#13;
<dl>&#13;
<dt>System</dt>&#13;
<dd>&#13;
<p>CPU, memory, disk, network, sensors</p>&#13;
</dd>&#13;
<dt>Processes</dt>&#13;
<dd>&#13;
<p>id, parent  id, CPU, memory, open files, threads</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>We already saw (in the previous <code>os</code> discussion)&#13;
that my computer has four CPUs.&#13;
How much time (in seconds) have they been using?</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">psutil</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">psutil</code><code class="o">.</code><code class="n">cpu_times</code><code class="p">(</code><code class="bp">True</code><code class="p">)</code>&#13;
<code class="go">[scputimes(user=62306.49, nice=0.0, system=19872.71, idle=256097.64),</code>&#13;
<code class="go">scputimes(user=19928.3, nice=0.0, system=6934.29, idle=311407.28),</code>&#13;
<code class="go">scputimes(user=57311.41, nice=0.0, system=15472.99, idle=265485.56),</code>&#13;
<code class="go">scputimes(user=14399.49, nice=0.0, system=4848.84, idle=319017.87)]</code></pre>&#13;
&#13;
<p>And how busy are they now?</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">psutil</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">psutil</code><code class="o">.</code><code class="n">cpu_percent</code><code class="p">(</code><code class="bp">True</code><code class="p">)</code>&#13;
<code class="go">26.1</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">psutil</code><code class="o">.</code><code class="n">cpu_percent</code><code class="p">(</code><code class="n">percpu</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>&#13;
<code class="go">[39.7, 16.2, 50.5, 6.0]</code></pre>&#13;
&#13;
<p>You might never need this kind of data,&#13;
but it’s good to know where to look if you do.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Command Automation" data-type="sect1"><div class="sect1" id="commands">&#13;
<h1>Command Automation</h1>&#13;
&#13;
<p><a data-primary="command automation" data-type="indexterm" id="idm45794981131208"/>You often run commands from the shell&#13;
(either with manually typed commands or shell scripts),&#13;
but Python has more than one good third-party&#13;
management tool.</p>&#13;
&#13;
<p>A related topic, <em>task queues</em>,&#13;
is discussed in <a data-type="xref" href="#queues">“Queues”</a>.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Invoke" data-type="sect2"><div class="sect2" id="invoke">&#13;
<h2>Invoke</h2>&#13;
&#13;
<p><a data-primary="invoke package" data-type="indexterm" id="idm45794981094008"/>Version 1 of the <code>fabric</code> tool let you define&#13;
local and remote (networked) tasks with Python code.&#13;
The developers split this original package into&#13;
<code>fabric2</code> (remote) and <code>invoke</code> (local).</p>&#13;
&#13;
<p class="pagebreak-before">Install <code>invoke</code> by running the following:</p>&#13;
<pre>$ <strong>pip install invoke</strong></pre>&#13;
&#13;
<p>One use of <code>invoke</code> is to make functions available as&#13;
command-line arguments.&#13;
Let’s make a <em>tasks.py</em> file with the lines shown in <a data-type="xref" href="#ex1503">Example 15-3</a>.</p>&#13;
<div data-type="example" id="ex1503">&#13;
<h5><span class="label">Example 15-3. </span>tasks.py</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">invoke</code> <code class="kn">import</code> <code class="n">task</code>&#13;
&#13;
<code class="nd">@task</code>&#13;
<code class="k">def</code> <code class="nf">mytime</code><code class="p">(</code><code class="n">ctx</code><code class="p">):</code>&#13;
    <code class="kn">import</code> <code class="nn">time</code>&#13;
    <code class="n">now</code> <code class="o">=</code> <code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">()</code>&#13;
    <code class="n">time_str</code> <code class="o">=</code> <code class="n">time</code><code class="o">.</code><code class="n">asctime</code><code class="p">(</code><code class="n">time</code><code class="o">.</code><code class="n">localtime</code><code class="p">(</code><code class="n">now</code><code class="p">))</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="s2">"Local time is"</code><code class="p">,</code> <code class="n">timestr</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>(That <code>ctx</code> argument is the first argument for each&#13;
task function, but it’s used only internally by <code>invoke</code>.&#13;
It doesn’t matter what you call it,&#13;
but an argument needs to be there.)</p>&#13;
<pre>$ <strong>invoke mytime</strong>&#13;
Local time is Thu May  2 13:16:23 2019</pre>&#13;
&#13;
<p>Use the argument <code>-l</code> or <code>--list</code> to see what tasks&#13;
are available:</p>&#13;
<pre>$ <strong>invoke -l</strong>&#13;
Available tasks:&#13;
&#13;
  mytime</pre>&#13;
&#13;
<p>Tasks can have arguments,&#13;
and you can invoke multiple&#13;
tasks at one time from the command line&#13;
(similar to <code>&amp;&amp;</code> use in shell scripts).</p>&#13;
&#13;
<p>Other uses include:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Running local shell commands with the <code>run()</code> function</p>&#13;
</li>&#13;
<li>&#13;
<p>Responding to string output patterns of programs</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>This was a brief glimpse.&#13;
See the&#13;
<a href="http://docs.pyinvoke.org">docs</a>&#13;
for all the details.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Other Command Helpers" data-type="sect2"><div class="sect2" id="idm45794981095256">&#13;
<h2>Other Command Helpers</h2>&#13;
&#13;
<p>These Python packages have some similarity to <code>invoke</code>,&#13;
but one or another may be a better fit when you need it:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://click.palletsprojects.com"><code>click</code></a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="http://pydoit.org"><code>doit</code></a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="http://amoffat.github.io/sh"><code>sh</code></a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://github.com/kennethreitz/delegator.py"><code>delegator</code></a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://cgarciae.github.io/pypeln"><code>pypeln</code></a></p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Concurrency" data-type="sect1"><div class="sect1" id="concurrency">&#13;
<h1>Concurrency</h1>&#13;
&#13;
<p><a data-primary="concurrency" data-type="indexterm" id="ix_ch15-systems-asciidoc0"/>The official Python site discusses concurrency in general and&#13;
<a href="http://bit.ly/concur-lib">in the standard library</a>.&#13;
Those pages have many links to various packages and techniques; in this chapter, we show the most useful ones.</p>&#13;
&#13;
<p>In computers,&#13;
if you’re waiting for something,&#13;
it’s usually for one of two reasons:</p>&#13;
<dl>&#13;
<dt>I/O bound</dt>&#13;
<dd>&#13;
<p><a data-primary="I/O bound" data-type="indexterm" id="idm45794981004072"/>This is by far the most common.&#13;
Computer CPUs are ridiculously fast—hundreds of times faster than computer memory&#13;
and many thousands of times faster than disks or networks.</p>&#13;
</dd>&#13;
<dt>CPU bound</dt>&#13;
<dd>&#13;
<p><a data-primary="CPU bound" data-type="indexterm" id="idm45794981001896"/>The CPU keeps busy.&#13;
This happens with <em>number crunching</em> tasks such as&#13;
scientific or graphic calculations.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>Two more terms are related to concurrency:</p>&#13;
<dl>&#13;
<dt>Synchronous</dt>&#13;
<dd>&#13;
<p><a data-primary="synchronous (term)" data-type="indexterm" id="idm45794980998568"/>One thing follows the other,&#13;
like a line of goslings behind their parents.</p>&#13;
</dd>&#13;
<dt>Asynchronous</dt>&#13;
<dd>&#13;
<p><a data-primary="asynchronous (term)" data-type="indexterm" id="idm45794980996584"/>Tasks are independent,&#13;
like random geese splashing down in a pond.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>As you progress from simple systems and tasks&#13;
to real-life problems,&#13;
you’ll need at some point to deal with concurrency.&#13;
Consider a website, for example.&#13;
You can usually provide static and dynamic pages&#13;
to web clients fairly quickly.&#13;
A fraction of a second is considered interactive,&#13;
but if the display or interaction takes longer&#13;
people become impatient.&#13;
Tests by companies such as Google and Amazon showed&#13;
that traffic drops off quickly if the page loads even&#13;
a little slower.</p>&#13;
&#13;
<p>But what if you can’t help it when something takes a long time,&#13;
such as uploading a file,&#13;
resizing an image,&#13;
or querying a database?&#13;
You can’t do it within your synchronous web server code anymore,&#13;
because someone’s waiting.</p>&#13;
&#13;
<p>On a single machine,&#13;
if you want to perform multiple tasks as&#13;
fast as possible,&#13;
you want to make them independent.&#13;
Slow tasks shouldn’t block all the others.</p>&#13;
&#13;
<p>This chapter showed earlier how multiprocessing can be used&#13;
to overlap work on a single machine.&#13;
If you needed to resize an image,&#13;
your web server code could call a separate, dedicated-image resizing process to run asynchronously and concurrently.&#13;
It could scale your application horizontally&#13;
by invoking multiple resizing processes.</p>&#13;
&#13;
<p>The trick is getting them all to work with one another.&#13;
Any shared control or state means that there will be bottlenecks.&#13;
An even bigger trick is dealing with failures,&#13;
because concurrent computing is harder than regular computing.&#13;
Many more things can go wrong,&#13;
and your odds of end-to-end success are lower.</p>&#13;
&#13;
<p>All right.&#13;
What methods can help you to deal with these complexities?&#13;
Let’s begin with a good way to manage multiple tasks: <em>queues</em>.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Queues" data-type="sect2"><div class="sect2" id="queues">&#13;
<h2>Queues</h2>&#13;
&#13;
<p><a data-primary="concurrency" data-secondary="queues and" data-type="indexterm" id="idm45794980989016"/><a data-primary="queues" data-type="indexterm" id="idm45794980960904"/>A queue is like a list: things are added at one end&#13;
and taken away from the other.&#13;
The most common is referred to as <em>FIFO</em>&#13;
(first in, first out).</p>&#13;
&#13;
<p>Suppose that you’re washing dishes.&#13;
If you’re stuck with the entire job,&#13;
you need to wash each dish, dry it, and put it away.&#13;
You can do this in a number of ways.&#13;
You might wash the first dish, dry it, and then put it away.&#13;
You then repeat with the second dish, and so on.&#13;
Or, you might <em>batch</em> operations and wash all the dishes,&#13;
dry them all,&#13;
and then put them away;&#13;
this assumes you have space in your sink and drainer&#13;
for all the dishes that accumulate at each step.&#13;
These are all synchronous approaches—one worker, one thing at a time.</p>&#13;
&#13;
<p>As an alternative, you could get a helper or two.&#13;
If you’re the washer,&#13;
you can hand each cleaned dish to the dryer,&#13;
who hands each dried dish to the put-away-er.&#13;
As long as each of you works at the same pace,&#13;
you should finish much faster than by <span class="keep-together">yourself.</span></p>&#13;
&#13;
<p>However, what if you wash faster than the dryer dries?&#13;
Wet dishes either fall on the floor,&#13;
or you pile them up between you and the dryer,&#13;
or you just whistle off-key until the dryer is ready.&#13;
And if the last person is slower than the dryer,&#13;
dry dishes can end up falling on the floor,&#13;
or piling up, or the dryer does the whistling.&#13;
You have multiple workers,&#13;
but the overall task is still synchronous and can proceed&#13;
only as fast as the slowest worker.</p>&#13;
&#13;
<p><em>Many hands make light work</em>,&#13;
goes the old saying&#13;
(I always thought it was Amish,&#13;
because it makes me think of barn building).&#13;
Adding workers can build a barn or do the dishes, faster.&#13;
This involves <em>queues</em>.</p>&#13;
&#13;
<p>In general, queues transport <em>messages</em>,&#13;
which can be any kind of information.&#13;
In this case,&#13;
we’re interested in queues for distributed task management,&#13;
also known as&#13;
<em>work queues</em>,&#13;
<em>job queues</em>,&#13;
or&#13;
<em>task queues</em>.&#13;
Each dish in the sink is given&#13;
to an available washer,&#13;
who washes and hands it off to the&#13;
first available dryer,&#13;
who dries and hands it to a put-away-er.&#13;
This can be synchronous&#13;
(workers wait for a dish to handle&#13;
and another worker to whom to give it),&#13;
or asynchronous&#13;
(dishes are stacked between workers with different paces).&#13;
As long as you have enough workers,&#13;
and they keep up with the dishes,&#13;
things move a lot faster.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Processes" data-type="sect2"><div class="sect2" id="concurrency_processes">&#13;
<h2>Processes</h2>&#13;
&#13;
<p><a data-primary="concurrency" data-secondary="processes and" data-type="indexterm" id="idm45794980950456"/><a data-primary="processes" data-secondary="concurrency and" data-type="indexterm" id="idm45794980949256"/>You can implement queues in many ways.&#13;
For a single machine,&#13;
the standard library’s <code>multiprocessing</code> module&#13;
(which you saw earlier)&#13;
contains a <code>Queue</code> function.&#13;
Let’s simulate just a single washer and multiple dryer processes&#13;
(someone can put the dishes away later)&#13;
and an intermediate <code>dish_queue</code>.&#13;
Call this program <em>dishes.py</em> (<a data-type="xref" href="#ex1504">Example 15-4</a>).</p>&#13;
<div data-type="example" id="ex1504">&#13;
<h5><span class="label">Example 15-4. </span>dishes.py</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">multiprocessing</code> <code class="kn">as</code> <code class="nn">mp</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">washer</code><code class="p">(</code><code class="n">dishes</code><code class="p">,</code> <code class="n">output</code><code class="p">):</code>&#13;
    <code class="k">for</code> <code class="n">dish</code> <code class="ow">in</code> <code class="n">dishes</code><code class="p">:</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="s1">'Washing'</code><code class="p">,</code> <code class="n">dish</code><code class="p">,</code> <code class="s1">'dish'</code><code class="p">)</code>&#13;
        <code class="n">output</code><code class="o">.</code><code class="n">put</code><code class="p">(</code><code class="n">dish</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">dryer</code><code class="p">(</code><code class="nb">input</code><code class="p">):</code>&#13;
    <code class="k">while</code> <code class="bp">True</code><code class="p">:</code>&#13;
        <code class="n">dish</code> <code class="o">=</code> <code class="nb">input</code><code class="o">.</code><code class="n">get</code><code class="p">()</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="s1">'Drying'</code><code class="p">,</code> <code class="n">dish</code><code class="p">,</code> <code class="s1">'dish'</code><code class="p">)</code>&#13;
        <code class="nb">input</code><code class="o">.</code><code class="n">task_done</code><code class="p">()</code>&#13;
&#13;
<code class="n">dish_queue</code> <code class="o">=</code> <code class="n">mp</code><code class="o">.</code><code class="n">JoinableQueue</code><code class="p">()</code>&#13;
<code class="n">dryer_proc</code> <code class="o">=</code> <code class="n">mp</code><code class="o">.</code><code class="n">Process</code><code class="p">(</code><code class="n">target</code><code class="o">=</code><code class="n">dryer</code><code class="p">,</code> <code class="n">args</code><code class="o">=</code><code class="p">(</code><code class="n">dish_queue</code><code class="p">,))</code>&#13;
<code class="n">dryer_proc</code><code class="o">.</code><code class="n">daemon</code> <code class="o">=</code> <code class="bp">True</code>&#13;
<code class="n">dryer_proc</code><code class="o">.</code><code class="n">start</code><code class="p">()</code>&#13;
&#13;
<code class="n">dishes</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'salad'</code><code class="p">,</code> <code class="s1">'bread'</code><code class="p">,</code> <code class="s1">'entree'</code><code class="p">,</code> <code class="s1">'dessert'</code><code class="p">]</code>&#13;
<code class="n">washer</code><code class="p">(</code><code class="n">dishes</code><code class="p">,</code> <code class="n">dish_queue</code><code class="p">)</code>&#13;
<code class="n">dish_queue</code><code class="o">.</code><code class="n">join</code><code class="p">()</code></pre></div>&#13;
&#13;
<p>Run your new program, thusly:</p>&#13;
<pre>$ <strong>python dishes.py</strong>&#13;
Washing salad dish&#13;
Washing bread dish&#13;
Washing entree dish&#13;
Washing dessert dish&#13;
Drying salad dish&#13;
Drying bread dish&#13;
Drying entree dish&#13;
Drying dessert dish</pre>&#13;
&#13;
<p>This queue looked a lot like a simple Python iterator,&#13;
producing a series of dishes.&#13;
It actually started up separate processes&#13;
along with the communication between the washer and dryer.&#13;
I used a <code>JoinableQueue</code> and the final <code>join()</code> method&#13;
to let the washer know that all the dishes have been dried.&#13;
There are other queue types in the <code>multiprocessing</code> module,&#13;
and you can read the <a href="http://bit.ly/multi-docs">documentation</a>&#13;
for more examples.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Threads" data-type="sect2"><div class="sect2" id="threads">&#13;
<h2>Threads</h2>&#13;
&#13;
<p><a data-primary="concurrency" data-secondary="threads and" data-type="indexterm" id="ix_ch15-systems-asciidoc1"/><a data-primary="threads" data-type="indexterm" id="ix_ch15-systems-asciidoc2"/>A <em>thread</em> runs within a process with access to&#13;
everything in the process,&#13;
similar to a multiple personality.&#13;
The <code>multiprocessing</code> module&#13;
has a cousin called <code>threading</code> that uses threads&#13;
instead of processes&#13;
(actually, <code>multiprocessing</code>&#13;
was designed later as its process-based counterpart).&#13;
Let’s redo our process example with threads, as shown in <a data-type="xref" href="#ex1505">Example 15-5</a>.</p>&#13;
<div data-type="example" id="ex1505">&#13;
<h5><span class="label">Example 15-5. </span>thread1.py</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">threading</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">do_this</code><code class="p">(</code><code class="n">what</code><code class="p">):</code>&#13;
    <code class="n">whoami</code><code class="p">(</code><code class="n">what</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">whoami</code><code class="p">(</code><code class="n">what</code><code class="p">):</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="s2">"Thread </code><code class="si">%s</code><code class="s2"> says: </code><code class="si">%s</code><code class="s2">"</code> <code class="o">%</code> <code class="p">(</code><code class="n">threading</code><code class="o">.</code><code class="n">current_thread</code><code class="p">(),</code> <code class="n">what</code><code class="p">))</code>&#13;
&#13;
<code class="k">if</code> <code class="nv-Magic">__name__</code> <code class="o">==</code> <code class="s2">"__main__"</code><code class="p">:</code>&#13;
    <code class="n">whoami</code><code class="p">(</code><code class="s2">"I'm the main program"</code><code class="p">)</code>&#13;
    <code class="k">for</code> <code class="n">n</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="mi">4</code><code class="p">):</code>&#13;
        <code class="n">p</code> <code class="o">=</code> <code class="n">threading</code><code class="o">.</code><code class="n">Thread</code><code class="p">(</code><code class="n">target</code><code class="o">=</code><code class="n">do_this</code><code class="p">,</code>&#13;
          <code class="n">args</code><code class="o">=</code><code class="p">(</code><code class="s2">"I'm function </code><code class="si">%s</code><code class="s2">"</code> <code class="o">%</code> <code class="n">n</code><code class="p">,))</code>&#13;
        <code class="n">p</code><code class="o">.</code><code class="n">start</code><code class="p">()</code></pre></div>&#13;
&#13;
<p>Here’s what prints for me:</p>&#13;
&#13;
<pre data-type="programlisting">Thread &lt;_MainThread(MainThread, started 140735207346960)&gt; says: I'm the main&#13;
program&#13;
Thread &lt;Thread(Thread-1, started 4326629376)&gt; says: I'm function 0&#13;
Thread &lt;Thread(Thread-2, started 4342157312)&gt; says: I'm function 1&#13;
Thread &lt;Thread(Thread-3, started 4347412480)&gt; says: I'm function 2&#13;
Thread &lt;Thread(Thread-4, started 4342157312)&gt; says: I'm function 3</pre>&#13;
&#13;
<p>We can reproduce our process-based dish example by using threads, as shown in <a data-type="xref" href="#ex1506">Example 15-6</a>.</p>&#13;
<div data-type="example" id="ex1506">&#13;
<h5><span class="label">Example 15-6. </span>thread_dishes.py</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">threading</code><code class="o">,</code> <code class="nn">queue</code>&#13;
<code class="kn">import</code> <code class="nn">time</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">washer</code><code class="p">(</code><code class="n">dishes</code><code class="p">,</code> <code class="n">dish_queue</code><code class="p">):</code>&#13;
    <code class="k">for</code> <code class="n">dish</code> <code class="ow">in</code> <code class="n">dishes</code><code class="p">:</code>&#13;
        <code class="k">print</code> <code class="p">(</code><code class="s2">"Washing"</code><code class="p">,</code> <code class="n">dish</code><code class="p">)</code>&#13;
        <code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mi">5</code><code class="p">)</code>&#13;
        <code class="n">dish_queue</code><code class="o">.</code><code class="n">put</code><code class="p">(</code><code class="n">dish</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">dryer</code><code class="p">(</code><code class="n">dish_queue</code><code class="p">):</code>&#13;
    <code class="k">while</code> <code class="bp">True</code><code class="p">:</code>&#13;
        <code class="n">dish</code> <code class="o">=</code> <code class="n">dish_queue</code><code class="o">.</code><code class="n">get</code><code class="p">()</code>&#13;
        <code class="k">print</code> <code class="p">(</code><code class="s2">"Drying"</code><code class="p">,</code> <code class="n">dish</code><code class="p">)</code>&#13;
        <code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mi">10</code><code class="p">)</code>&#13;
        <code class="n">dish_queue</code><code class="o">.</code><code class="n">task_done</code><code class="p">()</code>&#13;
&#13;
&#13;
<code class="n">dish_queue</code> <code class="o">=</code> <code class="n">queue</code><code class="o">.</code><code class="n">Queue</code><code class="p">()</code>&#13;
<code class="k">for</code> <code class="n">n</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="mi">2</code><code class="p">):</code>&#13;
    <code class="n">dryer_thread</code> <code class="o">=</code> <code class="n">threading</code><code class="o">.</code><code class="n">Thread</code><code class="p">(</code><code class="n">target</code><code class="o">=</code><code class="n">dryer</code><code class="p">,</code> <code class="n">args</code><code class="o">=</code><code class="p">(</code><code class="n">dish_queue</code><code class="p">,))</code>&#13;
    <code class="n">dryer_thread</code><code class="o">.</code><code class="n">start</code><code class="p">()</code>&#13;
&#13;
<code class="n">dishes</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'salad'</code><code class="p">,</code> <code class="s1">'bread'</code><code class="p">,</code> <code class="s1">'entree'</code><code class="p">,</code> <code class="s1">'dessert'</code><code class="p">]</code>&#13;
<code class="n">washer</code><code class="p">(</code><code class="n">dishes</code><code class="p">,</code> <code class="n">dish_queue</code><code class="p">)</code>&#13;
<code class="n">dish_queue</code><code class="o">.</code><code class="n">join</code><code class="p">()</code></pre></div>&#13;
&#13;
<p>One difference between <code>multiprocessing</code> and&#13;
<code>threading</code> is that <code>threading</code> does not have&#13;
a <code>terminate()</code> function.&#13;
There’s no easy way to terminate a running thread,&#13;
because it can cause all sorts of problems in your code,&#13;
and possibly in the space-time continuum itself.</p>&#13;
&#13;
<p>Threads can be dangerous.&#13;
Like manual memory management in languages such as C and C++,&#13;
they can cause bugs that are extremely hard to find,&#13;
let alone fix.&#13;
To use threads, all the code in the program&#13;
(and in external libraries that it uses)&#13;
must be <em>thread safe</em>.&#13;
In the preceding example code,&#13;
the threads didn’t share any global variables,&#13;
so they could run independently without breaking anything.</p>&#13;
&#13;
<p>Imagine that you’re a paranormal investigator in a haunted house.&#13;
Ghosts roam the halls, but none are aware of the others,&#13;
and at any time, any of them can&#13;
view, add, remove, or move any of the house’s contents.</p>&#13;
&#13;
<p>You’re walking apprehensively through the house,&#13;
taking readings with your impressive instruments.&#13;
Suddenly you notice that the candlestick you passed&#13;
seconds ago is now missing.</p>&#13;
&#13;
<p>The contents of the house are like the variables in a program.&#13;
The ghosts&#13;
are threads in a process (the house).&#13;
If the ghosts only cast spectral glances at the house’s contents,&#13;
there would be no problem.&#13;
It’s like a thread reading the value of a constant or variable&#13;
without trying to change it.</p>&#13;
&#13;
<p>Yet, some unseen entity could grab your flashlight,&#13;
blow cold air down your neck,&#13;
put marbles on the stairs,&#13;
or make the fireplace come ablaze.&#13;
The <em>really</em> subtle ghosts would change things&#13;
in other rooms that you might never notice.</p>&#13;
&#13;
<p>Despite your fancy instruments,&#13;
you’d have a very hard time figuring out&#13;
who did what, how, when, and where.</p>&#13;
&#13;
<p>If you used multiple processes instead of threads,&#13;
it would be like having a number of houses&#13;
but with only one (living) person in each.&#13;
If you put your brandy in front of the fireplace,&#13;
it would still be there an hour later—some lost to evaporation, but in the same place.</p>&#13;
&#13;
<p>Threads can be useful and safe when global data is not involved.&#13;
In particular, threads are useful for&#13;
saving time while waiting for&#13;
some I/O operation to complete.&#13;
In these cases, they don’t have to fight over data,&#13;
because each has completely separate <span class="keep-together">variables.</span></p>&#13;
&#13;
<p>But threads do sometimes have good reasons to change global data.&#13;
In fact, one&#13;
common reason to launch multiple threads is to&#13;
let them divide up the&#13;
work on some data,&#13;
so a certain degree of change to the data is&#13;
expected.</p>&#13;
&#13;
<p>The usual way to share data safely is to apply a&#13;
software <em>lock</em> before modifying a variable in a thread.&#13;
This keeps the other threads out while the change is made.&#13;
It’s like having&#13;
a Ghostbuster&#13;
guard the room you want to remain unhaunted.&#13;
The trick, though, is that you need to remember to unlock it.&#13;
Plus, locks can be nested: what if another&#13;
Ghostbuster is also watching the same room, or the house itself?&#13;
The use of locks is traditional but hard to get right.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p><a data-primary="Global Interpreter Lock (GIL)" data-type="indexterm" id="idm45794980549816"/>In Python, threads do not speed up CPU-bound tasks because of an&#13;
implementation detail in the standard Python system called the&#13;
<em>Global Interpreter Lock</em> (GIL).&#13;
This exists to avoid threading problems in the Python interpreter,&#13;
and can actually make a multithreaded program slower than&#13;
its single-threaded counterpart,&#13;
or even a multi-process version.</p>&#13;
</div>&#13;
&#13;
<p>So for Python, the recommendations are as follows:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Use threads for I/O-bound problems</p>&#13;
</li>&#13;
<li>&#13;
<p>Use processes, networking, or events&#13;
(discussed in the next section) for CPU-bound problems<a data-startref="ix_ch15-systems-asciidoc2" data-type="indexterm" id="idm45794980545704"/><a data-startref="ix_ch15-systems-asciidoc1" data-type="indexterm" id="idm45794980545032"/></p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="concurrent.futures" data-type="sect2"><div class="sect2" id="concurrent_futures">&#13;
<h2>concurrent.futures</h2>&#13;
&#13;
<p><a data-primary="concurrency" data-secondary="concurrent.futures module" data-type="indexterm" id="ix_ch15-systems-asciidoc3"/><a data-primary="concurrent.futures module" data-type="indexterm" id="ix_ch15-systems-asciidoc4"/>As you’ve just seen,&#13;
using threads or multiple processes involves&#13;
a number of details.&#13;
The <code>concurrent.futures</code> module was added to&#13;
the Python 3.2 standard library&#13;
to simplify these.&#13;
It lets you schedule an asynchronous pool of workers,&#13;
using&#13;
threads (when I/O-bound) or&#13;
processes (when CPU-bound).&#13;
You get back a <em>future</em> to track their state&#13;
and collect the results.</p>&#13;
&#13;
<p><a data-type="xref" href="#ex1507">Example 15-7</a> contains a test program&#13;
that you can save as <em>cf.py</em>.&#13;
<a data-primary="calc() function" data-type="indexterm" id="idm45794980537400"/>The task function <code>calc()</code> sleeps for one second&#13;
(our way of faking being busy with something),&#13;
calculates the square root of its&#13;
argument, and returns it.&#13;
The program takes an optional command-line argument of the&#13;
number of workers to use, which defaults to 3.&#13;
It starts this number of workers in a thread pool,&#13;
then a process pool,&#13;
and then prints the elapsed times.&#13;
The <code>values</code> list contains five numbers,&#13;
sent to <code>calc()</code> one at time in a worker thread or process.</p>&#13;
<div data-type="example" id="ex1507">&#13;
<h5><span class="label">Example 15-7. </span>cf.py</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting" id="concurrent_futures_example"><code class="kn">from</code> <code class="nn">concurrent</code> <code class="kn">import</code> <code class="n">futures</code>&#13;
<code class="kn">import</code> <code class="nn">math</code>&#13;
<code class="kn">import</code> <code class="nn">time</code>&#13;
<code class="kn">import</code> <code class="nn">sys</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">calc</code><code class="p">(</code><code class="n">val</code><code class="p">):</code>&#13;
    <code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>&#13;
    <code class="n">result</code> <code class="o">=</code> <code class="n">math</code><code class="o">.</code><code class="n">sqrt</code><code class="p">(</code><code class="nb">float</code><code class="p">(</code><code class="n">val</code><code class="p">))</code>&#13;
    <code class="k">return</code> <code class="n">result</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">use_threads</code><code class="p">(</code><code class="n">num</code><code class="p">,</code> <code class="n">values</code><code class="p">):</code>&#13;
    <code class="n">t1</code> <code class="o">=</code> <code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">()</code>&#13;
    <code class="k">with</code> <code class="n">futures</code><code class="o">.</code><code class="n">ThreadPoolExecutor</code><code class="p">(</code><code class="n">num</code><code class="p">)</code> <code class="k">as</code> <code class="n">tex</code><code class="p">:</code>&#13;
        <code class="n">results</code> <code class="o">=</code> <code class="n">tex</code><code class="o">.</code><code class="n">map</code><code class="p">(</code><code class="n">calc</code><code class="p">,</code> <code class="n">values</code><code class="p">)</code>&#13;
    <code class="n">t2</code> <code class="o">=</code> <code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">()</code>&#13;
    <code class="k">return</code> <code class="n">t2</code> <code class="o">-</code> <code class="n">t1</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">use_processes</code><code class="p">(</code><code class="n">num</code><code class="p">,</code> <code class="n">values</code><code class="p">):</code>&#13;
    <code class="n">t1</code> <code class="o">=</code> <code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">()</code>&#13;
    <code class="k">with</code> <code class="n">futures</code><code class="o">.</code><code class="n">ProcessPoolExecutor</code><code class="p">(</code><code class="n">num</code><code class="p">)</code> <code class="k">as</code> <code class="n">pex</code><code class="p">:</code>&#13;
        <code class="n">results</code> <code class="o">=</code> <code class="n">pex</code><code class="o">.</code><code class="n">map</code><code class="p">(</code><code class="n">calc</code><code class="p">,</code> <code class="n">values</code><code class="p">)</code>&#13;
    <code class="n">t2</code> <code class="o">=</code> <code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">()</code>&#13;
    <code class="k">return</code> <code class="n">t2</code> <code class="o">-</code> <code class="n">t1</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">main</code><code class="p">(</code><code class="n">workers</code><code class="p">,</code> <code class="n">values</code><code class="p">):</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s2">"Using {workers} workers for {len(values)} values"</code><code class="p">)</code>&#13;
    <code class="n">t_sec</code> <code class="o">=</code> <code class="n">use_threads</code><code class="p">(</code><code class="n">workers</code><code class="p">,</code> <code class="n">values</code><code class="p">)</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s2">"Threads took {t_sec:.4f} seconds"</code><code class="p">)</code>&#13;
    <code class="n">p_sec</code> <code class="o">=</code> <code class="n">use_processes</code><code class="p">(</code><code class="n">workers</code><code class="p">,</code> <code class="n">values</code><code class="p">)</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s2">"Processes took {p_sec:.4f} seconds"</code><code class="p">)</code>&#13;
&#13;
<code class="k">if</code> <code class="nv-Magic">__name__</code> <code class="o">==</code> <code class="s1">'__main__'</code><code class="p">:</code>&#13;
    <code class="n">workers</code> <code class="o">=</code> <code class="nb">int</code><code class="p">(</code><code class="n">sys</code><code class="o">.</code><code class="n">argv</code><code class="p">[</code><code class="mi">1</code><code class="p">])</code>&#13;
    <code class="n">values</code> <code class="o">=</code> <code class="nb">list</code><code class="p">(</code><code class="nb">range</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">6</code><code class="p">))</code> <code class="c1"># 1 .. 5</code>&#13;
    <code class="n">main</code><code class="p">(</code><code class="n">workers</code><code class="p">,</code> <code class="n">values</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>Here are some results that I got:</p>&#13;
<pre>$ <strong>python cf.py 1</strong>&#13;
Using 1 workers for 5 values&#13;
Threads took 5.0736 seconds&#13;
Processes took 5.5395 seconds&#13;
$ <strong>python cf.py 3</strong>&#13;
Using 3 workers for 5 values&#13;
Threads took 2.0040 seconds&#13;
Processes took 2.0351 seconds&#13;
$ <strong>python cf.py 5</strong>&#13;
Using 5 workers for 5 values&#13;
Threads took 1.0052 seconds&#13;
Processes took 1.0444 seconds</pre>&#13;
&#13;
<p>That one-second <code>sleep()</code> forced each worker&#13;
to take a second for each calculation:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>With only one worker at a time, everything was serial,&#13;
and the total time was more than five seconds.</p>&#13;
</li>&#13;
<li>&#13;
<p>Five workers matched the size of the values being tested,&#13;
so we had an elapsed time just more than a second.</p>&#13;
</li>&#13;
<li>&#13;
<p>With three workers, we needed two runs to handle all five values,&#13;
so two seconds elapsed.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>In the program, I ignored the actual <code>results</code>&#13;
(the square roots that we calculated)&#13;
to emphasize the elapsed times.&#13;
Also, using <code>map()</code> to define the pool&#13;
causes us to wait for all workers to finish&#13;
before returning <code>results</code>.&#13;
If you wanted to get each result as it completed,&#13;
let’s try another test (call it <em>cf2.py</em>) in which each worker&#13;
returns the value and its square root as&#13;
soon as it calculates it (<a data-type="xref" href="#ex1508">Example 15-8</a>).</p>&#13;
<div data-type="example" id="ex1508">&#13;
<h5><span class="label">Example 15-8. </span>cf2.py</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">concurrent</code> <code class="kn">import</code> <code class="n">futures</code>&#13;
<code class="kn">import</code> <code class="nn">math</code>&#13;
<code class="kn">import</code> <code class="nn">sys</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">calc</code><code class="p">(</code><code class="n">val</code><code class="p">):</code>&#13;
    <code class="n">result</code> <code class="o">=</code> <code class="n">math</code><code class="o">.</code><code class="n">sqrt</code><code class="p">(</code><code class="nb">float</code><code class="p">(</code><code class="n">val</code><code class="p">))</code>&#13;
    <code class="k">return</code> <code class="n">val</code><code class="p">,</code> <code class="n">result</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">use_threads</code><code class="p">(</code><code class="n">num</code><code class="p">,</code> <code class="n">values</code><code class="p">):</code>&#13;
    <code class="k">with</code> <code class="n">futures</code><code class="o">.</code><code class="n">ThreadPoolExecutor</code><code class="p">(</code><code class="n">num</code><code class="p">)</code> <code class="k">as</code> <code class="n">tex</code><code class="p">:</code>&#13;
        <code class="n">tasks</code> <code class="o">=</code> <code class="p">[</code><code class="n">tex</code><code class="o">.</code><code class="n">submit</code><code class="p">(</code><code class="n">calc</code><code class="p">,</code> <code class="n">value</code><code class="p">)</code> <code class="k">for</code> <code class="n">value</code> <code class="ow">in</code> <code class="n">values</code><code class="p">]</code>&#13;
        <code class="k">for</code> <code class="n">f</code> <code class="ow">in</code> <code class="n">futures</code><code class="o">.</code><code class="n">as_completed</code><code class="p">(</code><code class="n">tasks</code><code class="p">):</code>&#13;
             <code class="k">yield</code> <code class="n">f</code><code class="o">.</code><code class="n">result</code><code class="p">()</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">use_processes</code><code class="p">(</code><code class="n">num</code><code class="p">,</code> <code class="n">values</code><code class="p">):</code>&#13;
    <code class="k">with</code> <code class="n">futures</code><code class="o">.</code><code class="n">ProcessPoolExecutor</code><code class="p">(</code><code class="n">num</code><code class="p">)</code> <code class="k">as</code> <code class="n">pex</code><code class="p">:</code>&#13;
        <code class="n">tasks</code> <code class="o">=</code> <code class="p">[</code><code class="n">pex</code><code class="o">.</code><code class="n">submit</code><code class="p">(</code><code class="n">calc</code><code class="p">,</code> <code class="n">value</code><code class="p">)</code> <code class="k">for</code> <code class="n">value</code> <code class="ow">in</code> <code class="n">values</code><code class="p">]</code>&#13;
        <code class="k">for</code> <code class="n">f</code> <code class="ow">in</code> <code class="n">futures</code><code class="o">.</code><code class="n">as_completed</code><code class="p">(</code><code class="n">tasks</code><code class="p">):</code>&#13;
             <code class="k">yield</code> <code class="n">f</code><code class="o">.</code><code class="n">result</code><code class="p">()</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">main</code><code class="p">(</code><code class="n">workers</code><code class="p">,</code> <code class="n">values</code><code class="p">):</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s2">"Using {workers} workers for {len(values)} values"</code><code class="p">)</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="s2">"Using threads:"</code><code class="p">)</code>&#13;
    <code class="k">for</code> <code class="n">val</code><code class="p">,</code> <code class="n">result</code> <code class="ow">in</code> <code class="n">use_threads</code><code class="p">(</code><code class="n">workers</code><code class="p">,</code> <code class="n">values</code><code class="p">):</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'{val} {result:.4f}'</code><code class="p">)</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="s2">"Using processes:"</code><code class="p">)</code>&#13;
    <code class="k">for</code> <code class="n">val</code><code class="p">,</code> <code class="n">result</code> <code class="ow">in</code> <code class="n">use_processes</code><code class="p">(</code><code class="n">workers</code><code class="p">,</code> <code class="n">values</code><code class="p">):</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s1">'{val} {result:.4f}'</code><code class="p">)</code>&#13;
&#13;
<code class="k">if</code> <code class="nv-Magic">__name__</code> <code class="o">==</code> <code class="s1">'__main__'</code><code class="p">:</code>&#13;
    <code class="n">workers</code> <code class="o">=</code> <code class="mi">3</code>&#13;
    <code class="k">if</code> <code class="nb">len</code><code class="p">(</code><code class="n">sys</code><code class="o">.</code><code class="n">argv</code><code class="p">)</code> <code class="o">&gt;</code> <code class="mi">1</code><code class="p">:</code>&#13;
        <code class="n">workers</code> <code class="o">=</code> <code class="nb">int</code><code class="p">(</code><code class="n">sys</code><code class="o">.</code><code class="n">argv</code><code class="p">[</code><code class="mi">1</code><code class="p">])</code>&#13;
    <code class="n">values</code> <code class="o">=</code> <code class="nb">list</code><code class="p">(</code><code class="nb">range</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">6</code><code class="p">))</code> <code class="c1"># 1 .. 5</code>&#13;
    <code class="n">main</code><code class="p">(</code><code class="n">workers</code><code class="p">,</code> <code class="n">values</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>Our <code>use_threads()</code> and <code>use_processes()</code>&#13;
functions are now generator functions&#13;
that call <code>yield</code> to return on each iteration.&#13;
From one run on my machine, you can see how&#13;
the workers don’t always finish&#13;
<code>1</code> through <code>5</code> in order:</p>&#13;
<pre>$ <strong>python cf2.py 5</strong>&#13;
Using 5 workers for 5 values&#13;
Using threads:&#13;
3 1.7321&#13;
1 1.0000&#13;
2 1.4142&#13;
4 2.0000&#13;
5 2.2361&#13;
Using processes:&#13;
1 1.0000&#13;
2 1.4142&#13;
3 1.7321&#13;
4 2.0000&#13;
5 2.2361</pre>&#13;
&#13;
<p>You can use <code>concurrent.futures</code> any time you&#13;
want to launch a bunch of concurrent tasks, such as the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Crawling URLs on the web</p>&#13;
</li>&#13;
<li>&#13;
<p>Processing files, such as resizing images</p>&#13;
</li>&#13;
<li>&#13;
<p>Calling service APIs</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>As usual,&#13;
the <a href="https://oreil.ly/dDdF-">docs</a>&#13;
provide additional details, but are much more technical.<a data-startref="ix_ch15-systems-asciidoc4" data-type="indexterm" id="idm45794979973480"/><a data-startref="ix_ch15-systems-asciidoc3" data-type="indexterm" id="idm45794979972760"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Green Threads and gevent" data-type="sect2"><div class="sect2" id="gevent">&#13;
<h2>Green Threads and gevent</h2>&#13;
&#13;
<p><a data-primary="concurrency" data-secondary="green threads" data-type="indexterm" id="ix_ch15-systems-asciidoc5"/><a data-primary="gevent library" data-type="indexterm" id="ix_ch15-systems-asciidoc6"/><a data-primary="green threads" data-type="indexterm" id="ix_ch15-systems-asciidoc7"/><a data-primary="threads" data-type="indexterm" id="ix_ch15-systems-asciidoc8"/>As you’ve seen, developers traditionally avoid&#13;
slow spots in programs&#13;
by running them in separate threads or processes.&#13;
The Apache web server is an example of this design.</p>&#13;
&#13;
<p><a data-primary="event-based programming" data-type="indexterm" id="idm45794979965624"/>One alternative is <em>event-based</em> programming.&#13;
An event-based program runs a central <em>event loop</em>,&#13;
doles out any tasks,&#13;
and repeats the loop.&#13;
The NGINX web server follows this design,&#13;
and is generally faster than Apache.</p>&#13;
&#13;
<p>The <code>gevent</code> library is event-based&#13;
and accomplishes a neat trick:&#13;
you write normal imperative code,&#13;
and it magically converts pieces to <em>coroutines</em>.&#13;
These are like generators&#13;
that can communicate with one another and&#13;
keep track of where they are.&#13;
<code>gevent</code> modifies many of Python’s standard objects&#13;
such as <code>socket</code>&#13;
to use its mechanism instead of blocking.&#13;
This does not work with Python add-in code&#13;
that was written in C,&#13;
as some database drivers are.</p>&#13;
&#13;
<p>You install <code>gevent</code> by using <code>pip</code>:</p>&#13;
<pre>$ <strong>pip install gevent</strong></pre>&#13;
&#13;
<p>Here’s a variation of&#13;
<a href="http://www.gevent.org">sample code at the&#13;
<code>gevent</code> website</a>.&#13;
<a data-primary="gethostbyname() function" data-type="indexterm" id="idm45794979957432"/>You’ll see the <code>socket</code> module’s <code>gethostbyname()</code> function&#13;
in the upcoming DNS section.&#13;
This function is synchronous,&#13;
so you wait (possibly many seconds)&#13;
while it chases name servers around the world to&#13;
look up that address.&#13;
But you could use the <code>gevent</code> version to&#13;
look up multiple sites independently.&#13;
Save this as <em>gevent_test.py</em> (<a data-type="xref" href="#ex1509">Example 15-9</a>).</p>&#13;
<div data-type="example" id="ex1509">&#13;
<h5><span class="label">Example 15-9. </span>gevent_test.py</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">gevent</code>&#13;
<code class="kn">from</code> <code class="nn">gevent</code> <code class="kn">import</code> <code class="n">socket</code>&#13;
<code class="n">hosts</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'www.crappytaxidermy.com'</code><code class="p">,</code> <code class="s1">'www.walterpottertaxidermy.com'</code><code class="p">,</code>&#13;
    <code class="s1">'www.antique-taxidermy.com'</code><code class="p">]</code>&#13;
<code class="n">jobs</code> <code class="o">=</code> <code class="p">[</code><code class="n">gevent</code><code class="o">.</code><code class="n">spawn</code><code class="p">(</code><code class="n">gevent</code><code class="o">.</code><code class="n">socket</code><code class="o">.</code><code class="n">gethostbyname</code><code class="p">,</code> <code class="n">host</code><code class="p">)</code> <code class="k">for</code> <code class="n">host</code> <code class="ow">in</code> <code class="n">hosts</code><code class="p">]</code>&#13;
<code class="n">gevent</code><code class="o">.</code><code class="n">joinall</code><code class="p">(</code><code class="n">jobs</code><code class="p">,</code> <code class="n">timeout</code><code class="o">=</code><code class="mi">5</code><code class="p">)</code>&#13;
<code class="k">for</code> <code class="n">job</code> <code class="ow">in</code> <code class="n">jobs</code><code class="p">:</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">job</code><code class="o">.</code><code class="n">value</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>There’s a one-line for-loop in the preceding example.&#13;
Each hostname is&#13;
submitted in turn to a <code>gethostbyname()</code> call,&#13;
but they can run&#13;
asynchronously because it’s the <code>gevent</code>&#13;
version of <code>gethostbyname()</code>.</p>&#13;
&#13;
<p>Run <em>gevent_test.py</em>:</p>&#13;
<pre>$ <strong>python gevent_test.py </strong>&#13;
66.6.44.4&#13;
74.125.142.121&#13;
78.136.12.50</pre>&#13;
&#13;
<p><code>gevent.spawn()</code> creates a <em>greenlet</em>&#13;
(also known sometimes as a&#13;
<em>green thread</em>&#13;
or a&#13;
<em>microthread</em>)&#13;
to execute each <code>gevent.socket.gethostbyname(url)</code>.</p>&#13;
&#13;
<p>The difference from a normal thread is that it doesn’t block.&#13;
If something occurred that would have blocked a normal thread,&#13;
<code>gevent</code> switches control to one of the other greenlets.</p>&#13;
&#13;
<p>The <code>gevent.joinall()</code> method waits for&#13;
all the spawned jobs to finish.&#13;
Finally,&#13;
we dump the IP addresses that we got for these hostnames.</p>&#13;
&#13;
<p>Instead of the <code>gevent</code> version of <code>socket</code>,&#13;
you can use its evocatively named&#13;
<em>monkey-patching</em> functions.&#13;
These modify standard modules such as <code>socket</code> to use greenlets&#13;
rather than calling the <code>gevent</code> version of the module.&#13;
This is useful when you want <code>gevent</code> to be applied&#13;
all the way down,&#13;
even into code that you might not be able to access.</p>&#13;
&#13;
<p>At the top of your program, add the following call:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">gevent</code> <code class="kn">import</code> <code class="n">monkey</code>&#13;
<code class="n">monkey</code><code class="o">.</code><code class="n">patch_socket</code><code class="p">()</code></pre>&#13;
&#13;
<p>This inserts the <code>gevent</code> socket everywhere&#13;
the normal <code>socket</code> is called,&#13;
anywhere in your program, even in the standard library.&#13;
Again, this works only for Python code,&#13;
not libraries written in C.</p>&#13;
&#13;
<p>Another function monkey-patches even more standard library modules:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">gevent</code> <code class="kn">import</code> <code class="n">monkey</code>&#13;
<code class="n">monkey</code><code class="o">.</code><code class="n">patch_all</code><code class="p">()</code></pre>&#13;
&#13;
<p>Use this at the top of your program to get&#13;
as many <code>gevent</code>&#13;
speedups as possible.</p>&#13;
&#13;
<p>Save this program as <em>gevent_monkey.py</em> (<a data-type="xref" href="#ex1509">Example 15-9</a>).</p>&#13;
<div data-type="example" id="ex1510">&#13;
<h5><span class="label">Example 15-10. </span>gevent_monkey.py</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">gevent</code>&#13;
<code class="kn">from</code> <code class="nn">gevent</code> <code class="kn">import</code> <code class="n">monkey</code><code class="p">;</code> <code class="n">monkey</code><code class="o">.</code><code class="n">patch_all</code><code class="p">()</code>&#13;
<code class="kn">import</code> <code class="nn">socket</code>&#13;
<code class="n">hosts</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'www.crappytaxidermy.com'</code><code class="p">,</code> <code class="s1">'www.walterpottertaxidermy.com'</code><code class="p">,</code>&#13;
    <code class="s1">'www.antique-taxidermy.com'</code><code class="p">]</code>&#13;
<code class="n">jobs</code> <code class="o">=</code> <code class="p">[</code><code class="n">gevent</code><code class="o">.</code><code class="n">spawn</code><code class="p">(</code><code class="n">socket</code><code class="o">.</code><code class="n">gethostbyname</code><code class="p">,</code> <code class="n">host</code><code class="p">)</code> <code class="k">for</code> <code class="n">host</code> <code class="ow">in</code> <code class="n">hosts</code><code class="p">]</code>&#13;
<code class="n">gevent</code><code class="o">.</code><code class="n">joinall</code><code class="p">(</code><code class="n">jobs</code><code class="p">,</code> <code class="n">timeout</code><code class="o">=</code><code class="mi">5</code><code class="p">)</code>&#13;
<code class="k">for</code> <code class="n">job</code> <code class="ow">in</code> <code class="n">jobs</code><code class="p">:</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">job</code><code class="o">.</code><code class="n">value</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>Again, run the program:</p>&#13;
<pre>$ <strong>python gevent_monkey.py</strong>&#13;
66.6.44.4&#13;
74.125.192.121&#13;
78.136.12.50</pre>&#13;
&#13;
<p>There are potential dangers when using <code>gevent</code>.&#13;
As with any event-based system,&#13;
each chunk of code that you execute should be relatively quick.&#13;
Although it’s nonblocking,&#13;
code that does a lot of work is still slow.</p>&#13;
&#13;
<p>The very idea of monkey-patching makes some people nervous.&#13;
Yet, many large sites such as Pinterest&#13;
use <code>gevent</code> to speed up their sites&#13;
significantly.&#13;
Like the fine print on a bottle of pills,&#13;
use <code>gevent</code> as directed.</p>&#13;
&#13;
<p>For more examples, see this thorough gevent&#13;
<a href="https://oreil.ly/BWR_q">tutorial</a>.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>You might also want to consider&#13;
<a href="http://www.tornadoweb.org"><code>tornado</code></a> or&#13;
<a href="http://gunicorn.org"><code>gunicorn</code></a>, two other popular event-driven frameworks.&#13;
They provide both the low-level event handling&#13;
and a fast web server.&#13;
They’re worth a look if you’d like to build a fast website&#13;
without messing with a traditional web server such as Apache.<a data-startref="ix_ch15-systems-asciidoc8" data-type="indexterm" id="idm45794979614616"/><a data-startref="ix_ch15-systems-asciidoc7" data-type="indexterm" id="idm45794979613928"/><a data-startref="ix_ch15-systems-asciidoc6" data-type="indexterm" id="idm45794979613240"/><a data-startref="ix_ch15-systems-asciidoc5" data-type="indexterm" id="idm45794979612552"/></p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="twisted" data-type="sect2"><div class="sect2" id="twisted">&#13;
<h2>twisted</h2>&#13;
&#13;
<p><a data-primary="concurrency" data-secondary="twisted framework" data-type="indexterm" id="idm45794979610232"/><a data-primary="twisted framework" data-type="indexterm" id="idm45794979609256"/><a href="http://twistedmatrix.com/trac"><code>twisted</code></a>&#13;
is an asynchronous, event-driven networking framework.&#13;
You connect functions to events&#13;
such as data received or connection closed,&#13;
and those functions are called when those events occur.&#13;
This is a <em>callback</em> design,&#13;
and&#13;
if you’ve written anything in JavaScript,&#13;
it might seem familiar.&#13;
If it’s new to you, it can seem backwards.&#13;
For some developers,&#13;
callback-based code&#13;
becomes harder to manage as the application grows.</p>&#13;
&#13;
<p>You install it by running the following:</p>&#13;
<pre>$ <strong>pip install twisted</strong></pre>&#13;
&#13;
<p><code>twisted</code> is a large package,&#13;
with support for many internet protocols on top of TCP and UDP.&#13;
To be short and simple,&#13;
we show a little knock-knock server and client,&#13;
adapted from <a href="http://bit.ly/twisted-ex">twisted examples</a>.&#13;
First, let’s look at the server, <em>knock_server.py</em>: (<a data-type="xref" href="#ex1511">Example 15-11</a>).</p>&#13;
<div data-type="example" id="ex1511">&#13;
<h5><span class="label">Example 15-11. </span>knock_server.py</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">twisted.internet</code> <code class="kn">import</code> <code class="n">protocol</code><code class="p">,</code> <code class="n">reactor</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">Knock</code><code class="p">(</code><code class="n">protocol</code><code class="o">.</code><code class="n">Protocol</code><code class="p">):</code>&#13;
    <code class="k">def</code> <code class="nf">dataReceived</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">data</code><code class="p">):</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="s1">'Client:'</code><code class="p">,</code> <code class="n">data</code><code class="p">)</code>&#13;
        <code class="k">if</code> <code class="n">data</code><code class="o">.</code><code class="n">startswith</code><code class="p">(</code><code class="s2">"Knock knock"</code><code class="p">):</code>&#13;
            <code class="n">response</code> <code class="o">=</code> <code class="s2">"Who's there?"</code>&#13;
        <code class="k">else</code><code class="p">:</code>&#13;
            <code class="n">response</code> <code class="o">=</code> <code class="n">data</code> <code class="o">+</code> <code class="s2">" who?"</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="s1">'Server:'</code><code class="p">,</code> <code class="n">response</code><code class="p">)</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">transport</code><code class="o">.</code><code class="n">write</code><code class="p">(</code><code class="n">response</code><code class="p">)</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">KnockFactory</code><code class="p">(</code><code class="n">protocol</code><code class="o">.</code><code class="n">Factory</code><code class="p">):</code>&#13;
    <code class="k">def</code> <code class="nf">buildProtocol</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">addr</code><code class="p">):</code>&#13;
        <code class="k">return</code> <code class="n">Knock</code><code class="p">()</code>&#13;
&#13;
<code class="n">reactor</code><code class="o">.</code><code class="n">listenTCP</code><code class="p">(</code><code class="mi">8000</code><code class="p">,</code> <code class="n">KnockFactory</code><code class="p">())</code>&#13;
<code class="n">reactor</code><code class="o">.</code><code class="n">run</code><code class="p">()</code></pre></div>&#13;
&#13;
<p>Now let’s take a glance at its trusty companion,&#13;
<em>knock_client.py</em> (<a data-type="xref" href="#ex1512">Example 15-12</a>).</p>&#13;
<div data-type="example" id="ex1512">&#13;
<h5><span class="label">Example 15-12. </span>knock_client.py</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">twisted.internet</code> <code class="kn">import</code> <code class="n">reactor</code><code class="p">,</code> <code class="n">protocol</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">KnockClient</code><code class="p">(</code><code class="n">protocol</code><code class="o">.</code><code class="n">Protocol</code><code class="p">):</code>&#13;
    <code class="k">def</code> <code class="nf">connectionMade</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">transport</code><code class="o">.</code><code class="n">write</code><code class="p">(</code><code class="s2">"Knock knock"</code><code class="p">)</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">dataReceived</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">data</code><code class="p">):</code>&#13;
        <code class="k">if</code> <code class="n">data</code><code class="o">.</code><code class="n">startswith</code><code class="p">(</code><code class="s2">"Who's there?"</code><code class="p">):</code>&#13;
            <code class="n">response</code> <code class="o">=</code> <code class="s2">"Disappearing client"</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">transport</code><code class="o">.</code><code class="n">write</code><code class="p">(</code><code class="n">response</code><code class="p">)</code>&#13;
        <code class="k">else</code><code class="p">:</code>&#13;
            <code class="bp">self</code><code class="o">.</code><code class="n">transport</code><code class="o">.</code><code class="n">loseConnection</code><code class="p">()</code>&#13;
            <code class="n">reactor</code><code class="o">.</code><code class="n">stop</code><code class="p">()</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">KnockFactory</code><code class="p">(</code><code class="n">protocol</code><code class="o">.</code><code class="n">ClientFactory</code><code class="p">):</code>&#13;
    <code class="n">protocol</code> <code class="o">=</code> <code class="n">KnockClient</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">main</code><code class="p">():</code>&#13;
    <code class="n">f</code> <code class="o">=</code> <code class="n">KnockFactory</code><code class="p">()</code>&#13;
    <code class="n">reactor</code><code class="o">.</code><code class="n">connectTCP</code><code class="p">(</code><code class="s2">"localhost"</code><code class="p">,</code> <code class="mi">8000</code><code class="p">,</code> <code class="n">f</code><code class="p">)</code>&#13;
    <code class="n">reactor</code><code class="o">.</code><code class="n">run</code><code class="p">()</code>&#13;
&#13;
<code class="k">if</code> <code class="nv-Magic">__name__</code> <code class="o">==</code> <code class="s1">'__main__'</code><code class="p">:</code>&#13;
    <code class="n">main</code><code class="p">()</code></pre></div>&#13;
&#13;
<p>Start the server first:</p>&#13;
<pre>$ <strong>python knock_server.py</strong></pre>&#13;
&#13;
<p>Then, start the client:</p>&#13;
<pre>$ <strong>python knock_client.py</strong></pre>&#13;
&#13;
<p>The server and client exchange messages,&#13;
and the server prints the conversation:</p>&#13;
&#13;
<pre data-type="programlisting">Client: Knock knock&#13;
Server: Who's there?&#13;
Client: Disappearing client&#13;
Server: Disappearing client who?</pre>&#13;
&#13;
<p>Our trickster client then ends,&#13;
keeping the server waiting for the punch line.</p>&#13;
&#13;
<p>If you’d like to enter the <code>twisted</code> passages,&#13;
try some of the other examples from its documentation.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="asyncio" data-type="sect2"><div class="sect2" id="asyncio">&#13;
<h2>asyncio</h2>&#13;
&#13;
<p><a data-primary="asyncio library" data-secondary="about" data-type="indexterm" id="idm45794979332440"/><a data-primary="concurrency" data-secondary="asyncio module" data-type="indexterm" id="idm45794979331240"/>Python added the <code>asyncio</code> library&#13;
in version 3.4.&#13;
It’s a way of defining concurrent code&#13;
using the new <code>async</code> and <code>await</code> capabilities.&#13;
It’s a big topic with many details.&#13;
To avoid overstuffing this chapter,&#13;
I’ve moved the discussion of <code>asyncio</code> and related&#13;
topics to <a data-type="xref" href="app03.html#app_async">Appendix C</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Redis" data-type="sect2"><div class="sect2" id="concurrency_redis">&#13;
<h2>Redis</h2>&#13;
&#13;
<p><a data-primary="concurrency" data-secondary="Redis" data-type="indexterm" id="ix_ch15-systems-asciidoc9"/><a data-primary="Redis" data-secondary="concurrency and" data-type="indexterm" id="ix_ch15-systems-asciidoc10"/>Our earlier dishwashing code examples,&#13;
using processes or threads, were run on a single machine.&#13;
Let’s take another approach to queues that can run on a single&#13;
machine or across a network.&#13;
Even with multiple singing processes and dancing threads,&#13;
sometimes one machine isn’t enough,&#13;
You can treat this section as a bridge between&#13;
single-box (one machine) and multiple-box concurrency.</p>&#13;
&#13;
<p>To try the examples in this section,&#13;
you’ll need a Redis server and its Python module.&#13;
You can see where to get them in <a data-type="xref" href="ch16.html#redis">“Redis”</a>.&#13;
In that chapter, Redis’s role is that of a database.&#13;
Here, we’re featuring its concurrency personality.</p>&#13;
&#13;
<p>A quick way to make a queue is with a Redis list.&#13;
A Redis server runs on one machine;&#13;
this can be the same one as its clients,&#13;
or another that the clients can access through a network.&#13;
In either case,&#13;
clients talk to the server via TCP,&#13;
so they’re networking.&#13;
One or more provider clients&#13;
pushes messages onto one end of the list.&#13;
One or more client workers watches this list&#13;
with a <em>blocking pop</em> operation.&#13;
If the list is empty,&#13;
they all just sit around playing cards.&#13;
As soon as a message arrives,&#13;
the first eager worker gets it.</p>&#13;
&#13;
<p>Like our earlier process- and thread-based examples,&#13;
<em>redis_washer.py</em> generates&#13;
a sequence of dishes (<a data-type="xref" href="#ex1513">Example 15-13</a>).</p>&#13;
<div data-type="example" id="ex1513">&#13;
<h5><span class="label">Example 15-13. </span>redis_washer.py</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">redis</code>&#13;
<code class="n">conn</code> <code class="o">=</code> <code class="n">redis</code><code class="o">.</code><code class="n">Redis</code><code class="p">()</code>&#13;
<code class="k">print</code><code class="p">(</code><code class="s1">'Washer is starting'</code><code class="p">)</code>&#13;
<code class="n">dishes</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'salad'</code><code class="p">,</code> <code class="s1">'bread'</code><code class="p">,</code> <code class="s1">'entree'</code><code class="p">,</code> <code class="s1">'dessert'</code><code class="p">]</code>&#13;
<code class="k">for</code> <code class="n">dish</code> <code class="ow">in</code> <code class="n">dishes</code><code class="p">:</code>&#13;
    <code class="n">msg</code> <code class="o">=</code> <code class="n">dish</code><code class="o">.</code><code class="n">encode</code><code class="p">(</code><code class="s1">'utf-8'</code><code class="p">)</code>&#13;
    <code class="n">conn</code><code class="o">.</code><code class="n">rpush</code><code class="p">(</code><code class="s1">'dishes'</code><code class="p">,</code> <code class="n">msg</code><code class="p">)</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="s1">'Washed'</code><code class="p">,</code> <code class="n">dish</code><code class="p">)</code>&#13;
<code class="n">conn</code><code class="o">.</code><code class="n">rpush</code><code class="p">(</code><code class="s1">'dishes'</code><code class="p">,</code> <code class="s1">'quit'</code><code class="p">)</code>&#13;
<code class="k">print</code><code class="p">(</code><code class="s1">'Washer is done'</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>The loop generates four messages containing a dish name,&#13;
followed by a final message that says “quit.”&#13;
It appends each message to a list called <code>dishes</code>&#13;
in the Redis server,&#13;
similar to appending to a Python list.</p>&#13;
&#13;
<p>And as soon as the first dish is ready,&#13;
<em>redis_dryer.py</em>&#13;
does its work (<a data-type="xref" href="#ex1514">Example 15-14</a>).</p>&#13;
<div data-type="example" id="ex1514">&#13;
<h5><span class="label">Example 15-14. </span>redis_dryer.py</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">redis</code>&#13;
<code class="n">conn</code> <code class="o">=</code> <code class="n">redis</code><code class="o">.</code><code class="n">Redis</code><code class="p">()</code>&#13;
<code class="k">print</code><code class="p">(</code><code class="s1">'Dryer is starting'</code><code class="p">)</code>&#13;
<code class="k">while</code> <code class="bp">True</code><code class="p">:</code>&#13;
    <code class="n">msg</code> <code class="o">=</code> <code class="n">conn</code><code class="o">.</code><code class="n">blpop</code><code class="p">(</code><code class="s1">'dishes'</code><code class="p">)</code>&#13;
    <code class="k">if</code> <code class="ow">not</code> <code class="n">msg</code><code class="p">:</code>&#13;
        <code class="k">break</code>&#13;
    <code class="n">val</code> <code class="o">=</code> <code class="n">msg</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code><code class="o">.</code><code class="n">decode</code><code class="p">(</code><code class="s1">'utf-8'</code><code class="p">)</code>&#13;
    <code class="k">if</code> <code class="n">val</code> <code class="o">==</code> <code class="s1">'quit'</code><code class="p">:</code>&#13;
        <code class="k">break</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="s1">'Dried'</code><code class="p">,</code> <code class="n">val</code><code class="p">)</code>&#13;
<code class="k">print</code><code class="p">(</code><code class="s1">'Dishes are dried'</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>This code waits for messages whose first token&#13;
is “dishes” and prints that&#13;
each one is dried.&#13;
It obeys the <em>quit</em> message by ending the loop.</p>&#13;
&#13;
<p>Start the dryer and then the washer.&#13;
Using the <code>&amp;</code> at the end puts the first program in the&#13;
<em>background</em>;&#13;
it keeps running,&#13;
but doesn’t listen to the&#13;
keyboard anymore.&#13;
This works on Linux, macOS, and Windows,&#13;
although you might see different output on the next line.&#13;
In this case (macOS),&#13;
it’s some information about the&#13;
background dryer process.&#13;
Then, we start the washer process normally&#13;
(in the <em>foreground</em>).&#13;
You’ll see the mingled output of the two processes:</p>&#13;
<pre>$ <strong>python redis_dryer.py &amp; </strong>&#13;
[2] 81691&#13;
Dryer is starting&#13;
$ <strong>python redis_washer.py</strong>&#13;
Washer is starting&#13;
Washed salad&#13;
Dried salad&#13;
Washed bread&#13;
Dried bread&#13;
Washed entree&#13;
Dried entree&#13;
Washed dessert&#13;
Washer is done&#13;
Dried dessert&#13;
Dishes are dried&#13;
[2]+  Done                    python redis_dryer.py</pre>&#13;
&#13;
<p>As soon as dish IDs started arriving at Redis from&#13;
the washer process,&#13;
our hard-working dryer process started&#13;
pulling them back out.&#13;
<a data-primary="sentinel value" data-type="indexterm" id="idm45794979137000"/><a data-primary="values" data-secondary="sentinel" data-type="indexterm" id="idm45794979098520"/>Each dish ID was a number,&#13;
except the final <em>sentinel</em> value,&#13;
the string <code>'quit'</code>.&#13;
When the dryer process read that <code>quit</code> dish ID,&#13;
it quit, and some more background process information&#13;
printed to the terminal (also system dependent).&#13;
You can use a sentinel (an otherwise invalid value)&#13;
to indicate something special from the data stream itself—in this case, that we’re done.&#13;
Otherwise, we’d need to add a lot more program logic,&#13;
such as the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Agreeing ahead of time on some maximum dish number,&#13;
which would kind of be a sentinel anyway.</p>&#13;
</li>&#13;
<li>&#13;
<p>Doing some special <em>out-of-band</em> (not in the data stream)&#13;
interprocess communication.</p>&#13;
</li>&#13;
<li>&#13;
<p>Timing out after some interval with no new data.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Let’s make a few last changes:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Create multiple <code>dryer</code> processes.</p>&#13;
</li>&#13;
<li>&#13;
<p>Add a timeout to each dryer rather than looking for a sentinel.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The new <em>redis_dryer2.py</em> is shown in <a data-type="xref" href="#ex1515">Example 15-15</a>.</p>&#13;
<div data-type="example" id="ex1515">&#13;
<h5><span class="label">Example 15-15. </span>redis_dryer2.py</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">dryer</code><code class="p">():</code>&#13;
    <code class="kn">import</code> <code class="nn">redis</code>&#13;
    <code class="kn">import</code> <code class="nn">os</code>&#13;
    <code class="kn">import</code> <code class="nn">time</code>&#13;
    <code class="n">conn</code> <code class="o">=</code> <code class="n">redis</code><code class="o">.</code><code class="n">Redis</code><code class="p">()</code>&#13;
    <code class="n">pid</code> <code class="o">=</code> <code class="n">os</code><code class="o">.</code><code class="n">getpid</code><code class="p">()</code>&#13;
    <code class="n">timeout</code> <code class="o">=</code> <code class="mi">20</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="s1">'Dryer process </code><code class="si">%s</code><code class="s1"> is starting'</code> <code class="o">%</code> <code class="n">pid</code><code class="p">)</code>&#13;
    <code class="k">while</code> <code class="bp">True</code><code class="p">:</code>&#13;
        <code class="n">msg</code> <code class="o">=</code> <code class="n">conn</code><code class="o">.</code><code class="n">blpop</code><code class="p">(</code><code class="s1">'dishes'</code><code class="p">,</code> <code class="n">timeout</code><code class="p">)</code>&#13;
        <code class="k">if</code> <code class="ow">not</code> <code class="n">msg</code><code class="p">:</code>&#13;
            <code class="k">break</code>&#13;
        <code class="n">val</code> <code class="o">=</code> <code class="n">msg</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code><code class="o">.</code><code class="n">decode</code><code class="p">(</code><code class="s1">'utf-8'</code><code class="p">)</code>&#13;
        <code class="k">if</code> <code class="n">val</code> <code class="o">==</code> <code class="s1">'quit'</code><code class="p">:</code>&#13;
            <code class="k">break</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="s1">'</code><code class="si">%s</code><code class="s1">: dried </code><code class="si">%s</code><code class="s1">'</code> <code class="o">%</code> <code class="p">(</code><code class="n">pid</code><code class="p">,</code> <code class="n">val</code><code class="p">))</code>&#13;
        <code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mf">0.1</code><code class="p">)</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="s1">'Dryer process </code><code class="si">%s</code><code class="s1"> is done'</code> <code class="o">%</code> <code class="n">pid</code><code class="p">)</code>&#13;
&#13;
<code class="kn">import</code> <code class="nn">multiprocessing</code>&#13;
<code class="n">DRYERS</code><code class="o">=</code><code class="mi">3</code>&#13;
<code class="k">for</code> <code class="n">num</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">DRYERS</code><code class="p">):</code>&#13;
    <code class="n">p</code> <code class="o">=</code> <code class="n">multiprocessing</code><code class="o">.</code><code class="n">Process</code><code class="p">(</code><code class="n">target</code><code class="o">=</code><code class="n">dryer</code><code class="p">)</code>&#13;
    <code class="n">p</code><code class="o">.</code><code class="n">start</code><code class="p">()</code></pre></div>&#13;
&#13;
<p>Start the dryer processes in the background&#13;
and then the washer process in the <span class="keep-together">foreground:</span></p>&#13;
<pre>$ <strong>python redis_dryer2.py &amp;</strong>&#13;
Dryer process 44447 is starting&#13;
Dryer process 44448 is starting&#13;
Dryer process 44446 is starting&#13;
$ <strong>python redis_washer.py</strong>&#13;
Washer is starting&#13;
Washed salad&#13;
44447: dried salad&#13;
Washed bread&#13;
44448: dried bread&#13;
Washed entree&#13;
44446: dried entree&#13;
Washed dessert&#13;
Washer is done&#13;
44447: dried dessert&#13;
</pre>&#13;
&#13;
<p>One dryer process reads the <code>quit</code> ID and quits:</p>&#13;
&#13;
<pre data-type="programlisting">Dryer process 44448 is done</pre>&#13;
&#13;
<p>After 20 seconds,&#13;
the other dryer processes get a return value of&#13;
<code>None</code> from their <code>blpop</code>&#13;
calls,&#13;
indicating that they’ve timed out.&#13;
They say their last words and exit:</p>&#13;
&#13;
<pre data-type="programlisting">Dryer process 44447 is done&#13;
Dryer process 44446 is done</pre>&#13;
&#13;
<p>After the last dryer subprocess quits,&#13;
the main dryer program ends:<a data-startref="ix_ch15-systems-asciidoc10" data-type="indexterm" id="idm45794978901496"/><a data-startref="ix_ch15-systems-asciidoc9" data-type="indexterm" id="idm45794978900824"/></p>&#13;
&#13;
<pre data-type="programlisting">[1]+  Done                    python redis_dryer2.py</pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Beyond Queues" data-type="sect2"><div class="sect2" id="queue_alternatives">&#13;
<h2>Beyond Queues</h2>&#13;
&#13;
<p>With more moving parts,&#13;
there are more possibilities for our&#13;
lovely assembly lines to be disrupted.&#13;
If we need to wash the dishes from a banquet,&#13;
do we have enough workers?&#13;
What if the dryers get drunk?&#13;
What if the sink clogs?&#13;
Worries, worries!</p>&#13;
&#13;
<p>How will you cope with it all?&#13;
Common techniques include these:</p>&#13;
<dl>&#13;
<dt><a data-primary="fire-and-forget technique" data-type="indexterm" id="idm45794978896456"/>Fire and forget</dt>&#13;
<dd>&#13;
<p>Just pass things on and don’t worry about the consequences,&#13;
even if no one is there.&#13;
That’s the dishes-on-the-floor approach.</p>&#13;
</dd>&#13;
<dt><a data-primary="request-reply technique" data-type="indexterm" id="idm45794978894360"/>Request-reply</dt>&#13;
<dd>&#13;
<p>The washer receives an acknowledgment from the dryer,&#13;
and the dryer from the put-away-er,&#13;
for each dish in the pipeline.</p>&#13;
</dd>&#13;
<dt><a data-primary="back pressure technique" data-type="indexterm" id="idm45794978892232"/><a data-primary="throttling" data-type="indexterm" id="idm45794978891528"/>Back pressure or throttling</dt>&#13;
<dd>&#13;
<p>This technique directs a fast worker to&#13;
take it easy if someone downstream can’t keep up.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>In real systems, you need to be careful&#13;
that workers are keeping up with the demand;&#13;
otherwise, you hear the dishes hitting the floor.&#13;
You might add new tasks to a <em>pending</em> list,&#13;
while some worker process pops the latest message and&#13;
adds it to a <em>working</em> list.&#13;
When the message is done, it’s removed from the working list&#13;
and added to a <em>completed</em> list.&#13;
This lets you know what tasks have failed or are taking too long.&#13;
You can do this with Redis yourself,&#13;
or use a system that someone else has already written and tested.&#13;
Some Python-based queue packages that&#13;
add this extra level of management include:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="http://www.celeryproject.org"><code>celery</code></a>&#13;
can execute distributed tasks synchronously or&#13;
asynchronously, using the methods we’ve discussed:&#13;
<code>multiprocessing</code>, <code>gevent</code>, and others.</p>&#13;
</li>&#13;
<li>&#13;
<p><a href="http://python-rq.org">rq</a>&#13;
is a Python library for job queues, also based on Redis.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p><a href="http://queues.io">Queues</a> offers a discussion of queuing software,&#13;
Python-based and otherwise.<a data-startref="ix_ch15-systems-asciidoc0" data-type="indexterm" id="idm45794978882056"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Coming Up" data-type="sect1"><div class="sect1" id="idm45794981009000">&#13;
<h1>Coming Up</h1>&#13;
&#13;
<p>In this chapter, we flowed data through processes.&#13;
In the next chapter, you’ll see how to store&#13;
and retrieve data in various file formats and databases.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Things to Do" data-type="sect1"><div class="sect1" id="idm45794978880168">&#13;
<h1>Things to Do</h1>&#13;
&#13;
<p>15.1&#13;
<a data-primary="concurrency" data-secondary="practice exercises" data-type="indexterm" id="idm45794978878840"/><a data-primary="processes" data-secondary="practice exercises" data-type="indexterm" id="idm45794978877832"/>Use <code>multiprocessing</code> to create three separate processes.&#13;
Make each one wait a random number of seconds&#13;
between zero and one,&#13;
print the current time, and then exit.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>