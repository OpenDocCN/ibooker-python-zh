<html><head></head><body><section data-pdf-bookmark="Chapter 10. Infrastructure as Code" data-type="chapter" epub:type="chapter"><div class="chapter" id="infra-as-code">&#13;
<h1><span class="label">Chapter 10. </span>Infrastructure as Code</h1>&#13;
&#13;
&#13;
<p><a data-primary="Infrastructure as Code (IaC)" data-secondary="automated infrastructure provisioning with Pulumi" data-seealso="Pulumi" data-type="indexterm" id="ix_ch10-asciidoc0"/><a data-primary="Pulumi" data-type="indexterm" id="ix_ch10-asciidoc1"/>Before<a data-primary="Infrastructure as Code (IaC)" data-secondary="about" data-type="indexterm" id="idm46691324084488"/> we had fancy DevOps titles and job descriptions, we were lowly system administrators, or sysadmins for short. Those were the dark, pre-cloud days when we had to load the trunks of our cars with bare-metal servers and drive to a colocation (colo) facility to rack the servers, wire them, attach a wheeled monitor/keyboard/mouse to them, and set them up one by one. Grig still shudders to think about the hours he spent in colos, in blinding light and freezing A/C. We had to be wizards at Bash scripting, then we graduated to Perl, and the more fortunate of us to Python. As the saying went, the internet circa 2004 was held together with duct tape and bubble gum.</p>&#13;
&#13;
<p>Somewhere during the period of 2006 to 2007, we discovered the magical world of <a data-primary="Amazon EC2" data-type="indexterm" id="idm46691324064808"/>Amazon EC2 instances. We were able to provision servers through a simple point-and-click interface, or through command-line tools. No more driving to colocation facilities, no more stacking and wiring bare-metal servers. We could go wild and launch 10 EC2 instances at a time. Or even 20! Or even 100! The sky was the limit. However, we quickly figured out that manually connecting to each EC2 instance using SSH and then setting up our applications on every instance separately was not going to scale. It was fairly easy to provision the instances themselves. What was difficult was to install the required packages for our applications, add the correct users, make sure the file permissions looked right, and finally install and configure our applications. To scratch this itch, the first generation of infrastructure automation software came into being, represented by “configuration management” tools. Puppet was the first well-known configuration management tool, released in 2005 and predated the release of Amazon EC2. Other such tools that were launched on the heels of Puppet were Chef in 2008, followed by SaltStack in 2011, and Ansible in 2012.</p>&#13;
&#13;
<p>By 2009, the world was ready to welcome the arrival of a new term: DevOps. To this day, there are competing definitions of DevOps. What is interesting is that it came into being in the tumultuous early days of infrastructure software automation. While there are important people and culture aspects to DevOps, one thing stands out in this chapter: the ability to automate the provisioning, configuration, and deployment of infrastructure and applications.</p>&#13;
&#13;
<p>By 2011, it was getting hard to keep track of all the services comprising the <a data-primary="AWS (Amazon Web Services)" data-secondary="about" data-type="indexterm" id="idm46691324061928"/>Amazon Web Services (AWS) suite. The cloud was much more complicated than raw compute power (Amazon EC2) and object storage (Amazon S3). Applications started to rely on multiple services interacting with each other, and tools were needed to help automate the provisioning of these services. Amazon didn’t wait long to fill this need, and in 2011 it started offering just such a tool: AWS CloudFormation. This was one of the first moments when we could truly say that we were able to describe our infrastructure through code. CloudFormation opened the doors to a new generation of Infrastructure as Code (IaC) tools, which were operating at the layer of the cloud infrastructure itself, underneath the layer served by the first-generation configuration management tools.</p>&#13;
&#13;
<p>By 2014, AWS had launched dozens of services. That was the year when another important tool in the world of IaC came into being: Terraform, by HashiCorp. To this day, the two most used IaC tools are CloudFormation and Terraform.</p>&#13;
&#13;
<p>Another important development in the world of IaC and DevOps was taking place sometime between late 2013 and early 2014: the release of <a data-primary="Docker" data-secondary="development" data-type="indexterm" id="idm46691324059000"/>Docker, which came to be synonymous with container technologies. Although containers had been around for a number of years, the great benefit that Docker brought to the table was that it wrapped technologies such as Linux containers and cgroups into an easy-to-use API and command-line interface (CLI) toolset that significantly lowered the barrier of entry for people who wanted to package their applications into containers that could be deployed and run wherever Docker was running. Container technologies and container orchestration platforms are discussed in detail in Chapters <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch11.html#containers-docker">11</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch12.html#containers-kubernetes">12</a>.</p>&#13;
&#13;
<p>The usage and mindshare of Docker exploded and damaged the popularity of the first-generation configuration management tools (Puppet, Chef, Ansible, SaltStack). The companies behind these tools are reeling at the moment and are all trying to stay afloat and current by reinventing themselves as cloud friendly. Before the advent of Docker, you would provision the infrastructure for your application with an IaC tool such as CloudFormation or Terraform, then deploy the application itself (code and configuration) with a configuration management tool such as Puppet, Chef, Ansible, or SaltStack. Docker suddenly made these configuration management tools obsolete, since it provided a means for you to package your application (code + configuration) in a Docker container that would then run inside the infrastructure provisioned by the IaC tools.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="A Classification of Infrastructure Automation Tools" data-type="sect1"><div class="sect1" id="idm46691324053336">&#13;
<h1>A Classification of Infrastructure Automation Tools</h1>&#13;
&#13;
<p><a data-primary="automation tools, IaC with" data-type="indexterm" id="idm46691324051768"/><a data-primary="Infrastructure as Code (IaC)" data-secondary="classification of infrastructure automation tools" data-type="indexterm" id="idm46691324051096"/>Fast-forward to 2020 and it is easy to feel lost as a DevOps practitioner when faced with the multitude of infrastructure automation tools available.</p>&#13;
&#13;
<p>One way to differentiate IaC tools is by looking at the layer at which they operate. Tools such as CloudFormation and Terraform operate at the cloud infrastructure layer. They allow you to provision cloud resources such as compute, storage, and networking, as well as various services such as databases, message queues, data analytics, and many others. Configuration management tools such as Puppet, Chef, Ansible, and SaltStack typically operate at the application layer, making sure that all the required packages are installed for your application, and that the application itself is configured correctly (although many of these tools also have modules that can provision cloud resources). Docker also operates at the application layer.</p>&#13;
&#13;
<p>Another way to compare IaC tools is by dividing them into declarative versus imperative categories. You can tell an automation tool what to do in a declarative manner where you describe the state of the system that you are trying to achieve. Puppet, CloudFormation, and Terraform operate in a declarative manner. Alternatively, you can use an automation tool in a procedural or imperative manner, where you specify the exact steps needed by the tool to achieve the desired system state. Chef and Ansible operate in an imperative manner. SaltStack can operate in both declarative and imperative manners.</p>&#13;
&#13;
<p>Let’s look at the desired state of the system as a blueprint for the construction of a building, let’s say a stadium. You use procedural tools like Chef and Ansible to build the stadium, section by section and row by row inside each section. You need to keep track of the state of the stadium and the progress of the construction. Using declarative tools such as Puppet, CloudFormation, and Terraform, you first put together the blueprint for the stadium. The tool then makes sure that the construction achieves the state depicted in the blueprint.</p>&#13;
&#13;
<p>Given this chapter’s title, we will focus the remaining discussion on IaC tools, which can be further classified along several dimensions.</p>&#13;
&#13;
<p>One dimension is the way you specify the desired state of the system. In CloudFormation, you do it with JSON or YAML syntax, while in Terraform you do it with the proprietary HashiCorp Configuration Language (HCL) syntax. In contrast, Pulumi and the AWS Cloud Development Kit (CDK) allow you to use real programming languages, including Python, for specifying the desired state of the system.</p>&#13;
&#13;
<p>Another dimension is the cloud providers supported by each tool. Since CloudFormation is an Amazon service, it stands to reason that it focuses on AWS (although one can define non-AWS resources with CloudFormation when using the custom resources feature). The same is true for the AWS CDK. In contrast, Terraform supports many cloud providers, as does Pulumi.</p>&#13;
&#13;
<p>Because this is a book about Python, we would like to mention a tool called <a href="https://oreil.ly/Zdid-">troposphere</a>, which allows you to specify CloudFormation stack templates using Python code, and then exports them to JSON or YAML. Troposphere stops at the generation of the stack templates, which means that you need to provision the stacks using CloudFormation. One other tool that also uses Python and is worth mentioning is <a href="https://oreil.ly/gBF_N">stacker</a>. It uses troposphere under the covers, but it also provisions the generated CloudFormation stack templates.</p>&#13;
&#13;
<p>The rest of this chapter shows two of these automation tools, Terraform and Pulumi, in action, each working on a common scenario, which is the deployment of a static website in Amazon S3, which is fronted by the Amazon CloudFront CDN and secured by an SSL certificate provisioned via the AWS Certificate Manager (ACM) service.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Some of the commands used in the following examples produce large amounts of output. Except for cases where it is critical to the understanding of the command, we will omit the majority of the output lines to save trees and enable you to focus better on the text.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Manual Provisioning" data-type="sect1"><div class="sect1" id="idm46691324052712">&#13;
<h1>Manual Provisioning</h1>&#13;
&#13;
<p><a data-primary="Infrastructure as Code (IaC)" data-secondary="manual provisioning" data-type="indexterm" id="idm46691324038424"/><a data-primary="manual provisioning" data-secondary="IaC" data-type="indexterm" id="idm46691324037480"/>We started by working through the scenario manually, using the AWS web-based console. Nothing like experiencing the pain of doing things manually so that you can better enjoy the results of automating tedious work!</p>&#13;
&#13;
<p>We first followed the documentation from AWS <a href="https://oreil.ly/kdv8T">website for hosting in S3</a>.</p>&#13;
&#13;
<p>We already had a domain name bought via Namecheap: devops4all.dev. We created a hosted zone in Amazon Route 53 for the domain, and pointed the name servers for this domain in Namecheap to AWS DNS servers handling the hosted domain.</p>&#13;
&#13;
<p>We provisioned two S3 buckets, one for the root URL of the site (devops4all.dev) and one for the www URL (www.devops4all.dev). The idea was to redirect requests to www to the root URL. We also went through the guide and configured the buckets for static site hosting, with the proper permissions. We uploaded an <em>index.html</em> file and a JPG image to the root S3 bucket.</p>&#13;
&#13;
<p>The next step was to provision an SSL certificate to handle both the root domain name (devops4all.dev) and any subdomain of that domain (*.devops4all.dev). For verification, we used DNS records that we added to the Route 53 hosted zone.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>The ACM certificate needs to be provisioned in the us-east-1 AWS region so that it can be used in CloudFront.</p>&#13;
</div>&#13;
&#13;
<p>We then created an AWS CloudFront CDN distribution pointing to the root S3 bucket and used the ACM certificate provisioned in the previous step. We specified that HTTP requests should be redirected to HTTPS. Once the distribution was deployed (which took approximately 15 minutes), we added Route 53 records for the root domain and the www domain as A records of type Alias pointing to the CloudFront distribution endpoint DNS name.</p>&#13;
&#13;
<p>At the end of this exercise, we were able to go to <em>http://devops4all.dev</em>, be redirected automatically to <em>https://devops4all.dev</em>, and see the home page of the site showing the image we uploaded. We also tried going to <em>http://www.devops4all.dev</em> and were redirected to <em>https://devops4all.dev</em>.</p>&#13;
&#13;
<p>The manual creation of all the AWS resources we mentioned took approximately 30 minutes. We also spent 15 minutes waiting for the CloudFront distribution propagation, for a total of 45 minutes. Note that we had done all this before, so we knew exactly what to do, with only minimal reference to the AWS guide.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>It is worth taking a moment to appreciate how easy it is these days to provision a free SSL certificate. Gone are the days when you had to wait hours or even days for the SSL certificate provider to approve your request, only after you submitted proof that your company existed. Between AWS ACM, and Let’s Encrypt, there is no excuse not to have SSL enabled on all pages of your site in 2020.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Automated Infrastructure Provisioning with Terraform" data-type="sect1"><div class="sect1" id="idm46691324039336">&#13;
<h1>Automated Infrastructure Provisioning with Terraform</h1>&#13;
&#13;
<p><a data-primary="Infrastructure as Code (IaC)" data-secondary="automated infrastructure provisioning with Terraform" data-seealso="Terraform" data-type="indexterm" id="ix_ch10-asciidoc2"/><a data-primary="Terraform" data-type="indexterm" id="ix_ch10-asciidoc3"/>We decided to use Terraform as the first IaC tool for the automation of these tasks, even though Terraform is not directly related to Python. It has several advantages, such as maturity, strong ecosystem, and multicloud provisioners.</p>&#13;
&#13;
<p>The recommended way of writing Terraform code is to use modules, which are reusable components of Terraform configuration code. There is a common <a href="https://registry.terraform.io">registry</a> of Terraform modules hosted by HashiCorp where you can search for ready-made modules that you might use for provisioning the resources you need. In this example, we will write our own modules.</p>&#13;
&#13;
<p>The version of Terraform used here is 0.12.1, which is the latest version at the time of this writing. Install it on a Mac by using <a data-primary="brew" data-type="indexterm" id="idm46691324019224"/><code>brew</code>:</p>&#13;
&#13;
<pre data-type="programlisting">$ brew install terraform</pre>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Provisioning an S3 Bucket" data-type="sect2"><div class="sect2" id="idm46691324017288">&#13;
<h2>Provisioning an S3 Bucket</h2>&#13;
&#13;
<p><a data-primary="manual provisioning" data-secondary="s3 bucket" data-type="indexterm" id="ix_ch10-asciidoc4"/><a data-primary="s3 bucket" data-secondary="provisioning" data-type="indexterm" id="ix_ch10-asciidoc5"/><a data-primary="Terraform" data-secondary="provisioning an s3 bucket" data-type="indexterm" id="ix_ch10-asciidoc6"/>Create a <em>modules</em> directory and underneath it an <em>s3</em> directory containing three files: <em>main.tf</em>, <em>variables.tf</em>, and <em>outputs.tf</em>. The <em>main.tf</em> file in the <em>s3</em> directory tells Terraform to create an S3 bucket with a specific policy. It uses a variable called <code>domain_name</code> that is declared in <em>variables.tf</em> and whose value is passed to it by the caller of this module. It outputs the DNS endpoint of the S3 bucket, which will be used by other modules as an input variable.</p>&#13;
&#13;
<p>Here are the three files in <em>modules/s3</em>:</p>&#13;
&#13;
<pre data-type="programlisting">$ cat modules/s3/main.tf&#13;
resource "aws_s3_bucket" "www" {&#13;
  bucket = "www.${var.domain_name}"&#13;
  acl = "public-read"&#13;
  policy = &lt;&lt;POLICY&#13;
{&#13;
  "Version":"2012-10-17",&#13;
  "Statement":[&#13;
    {&#13;
      "Sid":"AddPerm",&#13;
      "Effect":"Allow",&#13;
      "Principal": "*",&#13;
      "Action":["s3:GetObject"],&#13;
      "Resource":["arn:aws:s3:::www.${var.domain_name}/*"]&#13;
    }&#13;
  ]&#13;
}&#13;
POLICY&#13;
&#13;
  website {&#13;
    index_document = "index.html"&#13;
  }&#13;
}&#13;
&#13;
$ cat modules/s3/variables.tf&#13;
variable "domain_name" {}&#13;
&#13;
$ cat modules/s3/outputs.tf&#13;
output "s3_www_website_endpoint" {&#13;
  value = "${aws_s3_bucket.www.website_endpoint}"&#13;
}</pre>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>The <code>policy</code> attribute of the <code>aws_s3_bucket</code> resource above is an example of an S3 bucket policy that allows public access to the bucket. If you work with S3 buckets in an IaC context, it pays to familiarize yourself with&#13;
the <a href="https://oreil.ly/QtTYd">official AWS documentation on bucket and user policies</a>.</p>&#13;
</div>&#13;
&#13;
<p>The main Terraform script which ties together all the modules is a file called <em>main.tf</em> in the current directory:</p>&#13;
&#13;
<pre data-type="programlisting">$ cat main.tf&#13;
provider "aws" {&#13;
  region = "${var.aws_region}"&#13;
}&#13;
&#13;
module "s3" {&#13;
  source = "./modules/s3"&#13;
  domain_name = "${var.domain_name}"&#13;
}</pre>&#13;
&#13;
<p>It refers to variables that are defined in a separate file called <em>variables.tf</em>:</p>&#13;
&#13;
<pre data-type="programlisting">$ cat variables.tf&#13;
variable "aws_region" {&#13;
  default = "us-east-1"&#13;
}&#13;
&#13;
variable "domain_name" {&#13;
  default = "devops4all.dev"&#13;
}</pre>&#13;
&#13;
<p>Here is the current directory tree at this point:</p>&#13;
&#13;
<pre data-type="programlisting">|____main.tf&#13;
|____variables.tf&#13;
|____modules&#13;
| |____s3&#13;
| | |____outputs.tf&#13;
| | |____main.tf&#13;
| | |____variables.tf</pre>&#13;
&#13;
<p>The first step in running Terraform is to invoke the <a data-primary="terraform init command" data-type="indexterm" id="idm46691323997192"/><code>terraform init</code> command, which will read the contents of any module referenced by the main file.</p>&#13;
&#13;
<p>The next step is to run the <a data-primary="terraform plan command" data-type="indexterm" id="idm46691323995640"/><code>terraform plan</code> command, which creates the blueprint mentioned in the earlier discussion.</p>&#13;
&#13;
<p>To create the resources specified in the plan, run <a data-primary="terraform apply" data-type="indexterm" id="idm46691323993976"/><code>terraform apply</code>:</p>&#13;
&#13;
<pre data-type="programlisting">$ terraform apply&#13;
&#13;
An execution plan has been generated and is shown below.&#13;
Resource actions are indicated with the following symbols:&#13;
  + create&#13;
&#13;
Terraform will perform the following actions:&#13;
&#13;
  # module.s3.aws_s3_bucket.www will be created&#13;
  + resource "aws_s3_bucket" "www" {&#13;
      + acceleration_status = (known after apply)&#13;
      + acl  = "public-read"&#13;
      + arn  = (known after apply)&#13;
      + bucket  = "www.devops4all.dev"&#13;
      + bucket_domain_name  = (known after apply)&#13;
      + bucket_regional_domain_name = (known after apply)&#13;
      + force_destroy = false&#13;
      + hosted_zone_id= (known after apply)&#13;
      + id= (known after apply)&#13;
      + policy  = jsonencode(&#13;
            {&#13;
              + Statement = [&#13;
                  + {&#13;
                      + Action = [&#13;
                          + "s3:GetObject",&#13;
                        ]&#13;
                      + Effect = "Allow"&#13;
                      + Principal = "*"&#13;
                      + Resource  = [&#13;
                          + "arn:aws:s3:::www.devops4all.dev/*",&#13;
                        ]&#13;
                      + Sid = "AddPerm"&#13;
                    },&#13;
                ]&#13;
              + Version= "2012-10-17"&#13;
            }&#13;
        )&#13;
      + region  = (known after apply)&#13;
      + request_payer = (known after apply)&#13;
      + website_domain= (known after apply)&#13;
      + website_endpoint = (known after apply)&#13;
&#13;
      + versioning {&#13;
          + enabled = (known after apply)&#13;
          + mfa_delete = (known after apply)&#13;
        }&#13;
&#13;
      + website {&#13;
          + index_document = "index.html"&#13;
        }&#13;
    }&#13;
&#13;
Plan: 1 to add, 0 to change, 0 to destroy.&#13;
&#13;
Do you want to perform these actions?&#13;
  Terraform will perform the actions described above.&#13;
  Only 'yes' will be accepted to approve.&#13;
&#13;
  Enter a value: yes&#13;
&#13;
module.s3.aws_s3_bucket.www: Creating...&#13;
module.s3.aws_s3_bucket.www: Creation complete after 7s [www.devops4all.dev]&#13;
&#13;
Apply complete! Resources: 1 added, 0 changed, 0 destroyed.</pre>&#13;
&#13;
<p>At this point, check that the S3 bucket was created using the AWS web console UI.<a data-startref="ix_ch10-asciidoc6" data-type="indexterm" id="idm46691323989720"/><a data-startref="ix_ch10-asciidoc5" data-type="indexterm" id="idm46691323988920"/><a data-startref="ix_ch10-asciidoc4" data-type="indexterm" id="idm46691323988168"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Provisioning an SSL Certificate with AWS ACM" data-type="sect2"><div class="sect2" id="idm46691324016664">&#13;
<h2>Provisioning an SSL Certificate with AWS ACM</h2>&#13;
&#13;
<p><a data-primary="ACM (AWS Certificate Manager)" data-type="indexterm" id="idm46691323986184"/><a data-primary="AWS (Amazon Web Services)" data-secondary="ACM" data-type="indexterm" id="idm46691323985144"/><a data-primary="AWS Certificate Manager (ACM)" data-type="indexterm" id="idm46691323984184"/><a data-primary="manual provisioning" data-secondary="provisioning an SSL certificate with AWS ACM" data-type="indexterm" id="idm46691323983496"/><a data-primary="SSL certificate, provisioning with ACM" data-type="indexterm" id="idm46691323982456"/><a data-primary="Terraform" data-secondary="provisioning an SSL certificate with AWS ACM" data-type="indexterm" id="idm46691323981768"/>The next module is created for the provisioning of an SSL certificate using the AWS Certificate Manager service. Create a directory called <em>modules/acm</em> with three files: <em>main.tf</em>, <em>variables.tf</em>, and <em>outputs.tf</em>. The <em>main.tf</em> file in the <em>acm</em> directory tells Terraform to create an ACM SSL certificate using DNS as the validation method. It uses a variable called <code>domain_name</code> which is declared in <em>variables.tf</em> and whose value is passed to it by the caller of this module. It outputs the ARN identifier of the certificate, which will be used by other modules as an input variable.</p>&#13;
&#13;
<pre data-type="programlisting">$ cat modules/acm/main.tf&#13;
resource "aws_acm_certificate" "certificate" {&#13;
  domain_name = "*.${var.domain_name}"&#13;
  validation_method = "DNS"&#13;
  subject_alternative_names = ["*.${var.domain_name}"]&#13;
}&#13;
&#13;
$ cat modules/acm/variables.tf&#13;
variable "domain_name" {&#13;
}&#13;
&#13;
$ cat modules/acm/outputs.tf&#13;
output "certificate_arn" {&#13;
  value = "${aws_acm_certificate.certificate.arn}"&#13;
}</pre>&#13;
&#13;
<p>Add a reference to the new <code>acm</code> module in the main Terraform file:</p>&#13;
&#13;
<pre data-type="programlisting">$ cat main.tf&#13;
provider "aws" {&#13;
  region = "${var.aws_region}"&#13;
}&#13;
&#13;
module "s3" {&#13;
  source = "./modules/s3"&#13;
  domain_name = "${var.domain_name}"&#13;
}&#13;
&#13;
module "acm" {&#13;
  source = "./modules/acm"&#13;
  domain_name = "${var.domain_name}"&#13;
}</pre>&#13;
&#13;
<p>The next three steps are the same as in the S3 bucket creation sequence: <code>terraform init</code>, <code>terraform plan</code>, and <code>terraform apply</code>.</p>&#13;
&#13;
<p>Use the AWS console to add the necessary Route 53 records for the validation process. The certificate is normally validated and issued in a few minutes.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Provisioning an Amazon CloudFront Distribution" data-type="sect2"><div class="sect2" id="idm46691323971544">&#13;
<h2>Provisioning an Amazon CloudFront Distribution</h2>&#13;
&#13;
<p><a data-primary="AWS (Amazon Web Services)" data-secondary="CloudFront distribution" data-type="indexterm" id="ix_ch10-asciidoc7"/><a data-primary="manual provisioning" data-secondary="AWS CloudFront distribution" data-type="indexterm" id="ix_ch10-asciidoc8"/><a data-primary="Terraform" data-secondary="provisioning an AWS CloudFront distribution" data-type="indexterm" id="ix_ch10-asciidoc9"/>The next module is created for the provisioning of an Amazon CloudFront distribution. Create a directory called <em>modules/cloudfront</em> with three files: <em>main.tf</em>, <em>variables.tf</em>, and <em>outputs.tf</em>. The <em>main.tf</em> file in the <em>cloudfront</em> directory tells Terraform to create a CloudFront distribution resource. It uses several variables that are declared in <em>variables.tf</em> and whose values are passed to it by the caller of this module. It outputs the DNS domain name for the CloudFront endpoint and the hosted Route 53 zone ID for the CloudFront distribution, which will be used by other modules as input variables:</p>&#13;
&#13;
<pre data-type="programlisting">$ cat modules/cloudfront/main.tf&#13;
resource "aws_cloudfront_distribution" "www_distribution" {&#13;
  origin {&#13;
    custom_origin_config {&#13;
      // These are all the defaults.&#13;
      http_port= "80"&#13;
      https_port  = "443"&#13;
      origin_protocol_policy = "http-only"&#13;
      origin_ssl_protocols= ["TLSv1", "TLSv1.1", "TLSv1.2"]&#13;
    }&#13;
&#13;
    domain_name = "${var.s3_www_website_endpoint}"&#13;
    origin_id= "www.${var.domain_name}"&#13;
  }&#13;
&#13;
  enabled  = true&#13;
  default_root_object = "index.html"&#13;
&#13;
  default_cache_behavior {&#13;
    viewer_protocol_policy = "redirect-to-https"&#13;
    compress = true&#13;
    allowed_methods= ["GET", "HEAD"]&#13;
    cached_methods = ["GET", "HEAD"]&#13;
    target_origin_id = "www.${var.domain_name}"&#13;
    min_ttl  = 0&#13;
    default_ttl = 86400&#13;
    max_ttl  = 31536000&#13;
&#13;
    forwarded_values {&#13;
      query_string = false&#13;
      cookies {&#13;
        forward = "none"&#13;
      }&#13;
    }&#13;
  }&#13;
&#13;
  aliases = ["www.${var.domain_name}"]&#13;
&#13;
  restrictions {&#13;
    geo_restriction {&#13;
      restriction_type = "none"&#13;
    }&#13;
  }&#13;
&#13;
  viewer_certificate {&#13;
    acm_certificate_arn = "${var.acm_certificate_arn}"&#13;
    ssl_support_method  = "sni-only"&#13;
  }&#13;
}&#13;
&#13;
$ cat modules/cloudfront/variables.tf&#13;
variable "domain_name" {}&#13;
variable "acm_certificate_arn" {}&#13;
variable "s3_www_website_endpoint" {}&#13;
&#13;
$ cat modules/cloudfront/outputs.tf&#13;
output "domain_name" {&#13;
  value = "${aws_cloudfront_distribution.www_distribution.domain_name}"&#13;
}&#13;
&#13;
output "hosted_zone_id" {&#13;
  value = "${aws_cloudfront_distribution.www_distribution.hosted_zone_id}"&#13;
}</pre>&#13;
&#13;
<p>Add a reference to the <code>cloudfront</code> module in the main Terraform file. Pass <code>s3_www_website_endpoint</code> and <code>acm_certificate_arn</code> as input variables to the <code>cloudfront</code> module. Their values are retrieved from the outputs of the other modules, <code>s3</code> and <code>acm</code>, respectively.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p><a data-primary="Amazon Resource Name (ARN)" data-type="indexterm" id="idm46691323956408"/><a data-primary="ARN (Amazon Resource Name)" data-type="indexterm" id="idm46691323955688"/>ARN stands for Amazon Resource Name. It is a string that uniquely identifies a given AWS resource. You will see many ARN values generated and passed around as variables when you use IaC tools that operate within AWS.</p>&#13;
</div>&#13;
&#13;
<pre data-type="programlisting">$ cat main.tf&#13;
provider "aws" {&#13;
  region = "${var.aws_region}"&#13;
}&#13;
&#13;
module "s3" {&#13;
  source = "./modules/s3"&#13;
  domain_name = "${var.domain_name}"&#13;
}&#13;
&#13;
module "acm" {&#13;
  source = "./modules/acm"&#13;
  domain_name = "${var.domain_name}"&#13;
}&#13;
&#13;
module "cloudfront" {&#13;
  source = "./modules/cloudfront"&#13;
  domain_name = "${var.domain_name}"&#13;
  s3_www_website_endpoint = "${module.s3.s3_www_website_endpoint}"&#13;
  acm_certificate_arn = "${module.acm.certificate_arn}"&#13;
}</pre>&#13;
&#13;
<p>The next three steps are the usual ones for the provisioning of resources with Terraform: <code>terraform init</code>, <code>terraform plan</code>, and <span class="keep-together"><code>terraform</code></span> <code>apply</code>.</p>&#13;
&#13;
<p>The <a data-primary="terraform apply" data-type="indexterm" id="idm46691323950120"/><code>terraform apply</code> step took almost 23 minutes in this case. Provisioning an Amazon CloudFront distribution is one of&#13;
the lengthiest operations in AWS, because the distribution is being deployed globally by Amazon behind the scenes.<a data-startref="ix_ch10-asciidoc9" data-type="indexterm" id="idm46691323948776"/><a data-startref="ix_ch10-asciidoc8" data-type="indexterm" id="idm46691323948072"/><a data-startref="ix_ch10-asciidoc7" data-type="indexterm" id="idm46691323947400"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Provisioning a Route 53 DNS Record" data-type="sect2"><div class="sect2" id="idm46691323946600">&#13;
<h2>Provisioning a Route 53 DNS Record</h2>&#13;
&#13;
<p><a data-primary="manual provisioning" data-secondary="route53 DNS record" data-type="indexterm" id="idm46691323945320"/><a data-primary="route53 DNS record, provisioning" data-type="indexterm" id="idm46691323944120"/><a data-primary="Terraform" data-secondary="provisioning a Route53 DNS record" data-type="indexterm" id="idm46691323943480"/>The next module was for the creation of a Route 53 DNS record for the main domain of the site www.devops4all.dev. Create a directory called <em>modules/route53</em> with two files: <em>main.tf</em> and <em>variables.tf</em>. The <em>main.tf</em> file in the <em>route53</em> directory tells Terraform to create a Route 53 DNS record of type <code>A</code> as an alias to the DNS name of the CloudFront endpoint. It uses several variables that are declared in <em>variables.tf</em> and whose values are passed to it by the caller of this module:</p>&#13;
&#13;
<pre data-type="programlisting">$ cat modules/route53/main.tf&#13;
resource "aws_route53_record" "www" {&#13;
  zone_id = "${var.zone_id}"&#13;
  name = "www.${var.domain_name}"&#13;
  type = "A"&#13;
&#13;
  alias {&#13;
    name  = "${var.cloudfront_domain_name}"&#13;
    zone_id  = "${var.cloudfront_zone_id}"&#13;
    evaluate_target_health = false&#13;
  }&#13;
}&#13;
&#13;
$ cat modules/route53/variables.tf&#13;
variable "domain_name" {}&#13;
variable "zone_id" {}&#13;
variable "cloudfront_domain_name" {}&#13;
variable "cloudfront_zone_id" {}</pre>&#13;
&#13;
<p>Add a reference to the <code>route53</code> module in the <em>main.tf</em> Terraform file. Pass <code>zone_id</code>, <code>cloudfront_domain_name</code>, and <code>cloudfront_zone_id</code> as input variables to the <code>route53</code> module. The value of <code>zone_id</code> is declared in <em>variables.tf</em> in the current directory, while the other values are retrieved from the outputs of the <code>cloudfront</code> module:</p>&#13;
&#13;
<pre data-type="programlisting">$ cat main.tf&#13;
provider "aws" {&#13;
  region = "${var.aws_region}"&#13;
}&#13;
&#13;
module "s3" {&#13;
  source = "./modules/s3"&#13;
  domain_name = "${var.domain_name}"&#13;
}&#13;
&#13;
module "acm" {&#13;
  source = "./modules/acm"&#13;
  domain_name = "${var.domain_name}"&#13;
}&#13;
&#13;
module "cloudfront" {&#13;
  source = "./modules/cloudfront"&#13;
  domain_name = "${var.domain_name}"&#13;
  s3_www_website_endpoint = "${module.s3.s3_www_website_endpoint}"&#13;
  acm_certificate_arn = "${module.acm.certificate_arn}"&#13;
}&#13;
&#13;
module "route53" {&#13;
  source = "./modules/route53"&#13;
  domain_name = "${var.domain_name}"&#13;
  zone_id = "${var.zone_id}"&#13;
  cloudfront_domain_name = "${module.cloudfront.domain_name}"&#13;
  cloudfront_zone_id = "${module.cloudfront.hosted_zone_id}"&#13;
}&#13;
&#13;
$ cat variables.tf&#13;
variable "aws_region" {&#13;
  default = "us-east-1"&#13;
}&#13;
&#13;
variable "domain_name" {&#13;
  default = "devops4all.dev"&#13;
}&#13;
&#13;
variable "zone_id" {&#13;
  default = "ZWX18ZIVHAA5O"&#13;
}</pre>&#13;
&#13;
<p>The next three steps, which should be very familiar to you by now, are for the provisioning of resources with Terraform: <code>terraform init</code>, <code>terraform plan</code>, and <code>terraform apply</code>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Copying Static Files to S3" data-type="sect2"><div class="sect2" id="idm46691323929736">&#13;
<h2>Copying Static Files to S3</h2>&#13;
&#13;
<p><a data-primary="manual provisioning" data-secondary="copying static files to S3" data-type="indexterm" id="idm46691323928568"/><a data-primary="s3 bucket" data-secondary="copying static files to" data-type="indexterm" id="idm46691323927400"/><a data-primary="static files, copying" data-type="indexterm" id="idm46691323926456"/><a data-primary="Terraform" data-secondary="copying static files to S3" data-type="indexterm" id="idm46691323925784"/>To test the provisioning of the static website from end to end, create a simple file called <em>index.html</em> that includes a JPEG image, and copy both files to the S3 bucket previously provisioned with Terraform. Make sure that the <code>AWS_PROFILE</code> environment variable is set to a correct value already present in the <em>~/.aws/credentials</em> file:</p>&#13;
&#13;
<pre data-type="programlisting">$ echo $AWS_PROFILE&#13;
gheorghiu-net&#13;
$ aws s3 cp static_files/index.html s3://www.devops4all.dev/index.html&#13;
upload: static_files/index.html to s3://www.devops4all.dev/index.html&#13;
$ aws s3 cp static_files/devops4all.jpg s3://www.devops4all.dev/devops4all.jpg&#13;
upload: static_files/devops4all.jpg to s3://www.devops4all.dev/devops4all.jpg</pre>&#13;
&#13;
<p>Visit <a href="https://www.devops4all.dev/"><em class="hyperlink">https://www.devops4all.dev/</em></a> and verify that you can see the JPG image that was uploaded.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Deleting All AWS Resources Provisioned with Terraform" data-type="sect2"><div class="sect2" id="idm46691323920360">&#13;
<h2>Deleting All AWS Resources Provisioned with Terraform</h2>&#13;
&#13;
<p><a data-primary="manual provisioning" data-secondary="deleting all AWS resources" data-type="indexterm" id="idm46691323919080"/><a data-primary="Terraform" data-secondary="deleting all AWS resources provisioned with Terraform" data-type="indexterm" id="idm46691323918088"/>Whenever you provision cloud resources, you need to be mindful of the cost associated with them. It is very&#13;
easy to forget about them, and you may be surprised by the AWS bill you receive at the end of the month.&#13;
Make sure to delete all the resources provisioned above. Remove these resources by running&#13;
the <a data-primary="terraform destroy" data-type="indexterm" id="idm46691323916600"/><code>terraform destroy</code> command. One more thing to note is that the contents of the S3 bucket need to be removed before running <code>terraform destroy</code> because Terraform will not delete a nonempty bucket.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Before running the <code>terraform destroy</code> command, make sure you will not delete resources that might still be used in production!<a data-startref="ix_ch10-asciidoc3" data-type="indexterm" id="idm46691323913432"/><a data-startref="ix_ch10-asciidoc2" data-type="indexterm" id="idm46691323912728"/></p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Automated Infrastructure Provisioning with Pulumi" data-type="sect1"><div class="sect1" id="idm46691324025144">&#13;
<h1>Automated Infrastructure Provisioning with Pulumi</h1>&#13;
&#13;
<p>Pulumi<a data-primary="Pulumi" data-secondary="about" data-type="indexterm" id="idm46691323910200"/> is one of the new kids on the block when it comes to IaC tools. The keyword here is <em>new</em>, which means it is still somewhat rough around the edges, especially in regards&#13;
to Python support.</p>&#13;
&#13;
<p>Pulumi allows you to specify the desired state of your infrastructure by telling it which resources to&#13;
provision using real programming languages. TypeScript was the first language supported by Pulumi, but nowadays&#13;
Go and Python are also supported.</p>&#13;
&#13;
<p>It is important to understand the difference between writing infrastructure automation code in Python using Pulumi&#13;
and an AWS automation library such as Boto.</p>&#13;
&#13;
<p>With Pulumi, your Python code describes the resources that you want to be provisioned.&#13;
You are, in effect, creating the blueprint or the state discussed at the beginning of the chapter.&#13;
This makes Pulumi similar to Terraform, but the big difference is that Pulumi gives you&#13;
the full power of a programming language such as Python in terms of writing functions, loops, using variables, etc.&#13;
You are not hampered by the use of a markup language such as Terraform’s HCL. Pulumi combines the power&#13;
of a declarative approach, where you describe the desired end state, with the power of a real programming language.</p>&#13;
&#13;
<p>With an AWS automation library such as Boto, you both describe and provision individual AWS resources through&#13;
the code you write. There is no overall blueprint or state. You need to keep track of the provisioned resources&#13;
yourself, and to orchestrate their creation and removal. This is the imperative or procedural approach for automation&#13;
tools. You still get the advantage of writing Python code.</p>&#13;
&#13;
<p>To start using Pulumi, create a free account on their website pulumi.io. Then you can install the <code>pulumi</code>&#13;
command-line tool on your local machine. On a Macintosh, use Homebrew to install <code>pulumi</code>.</p>&#13;
&#13;
<p>The first command to run locally is <a data-primary="pulumi login command" data-type="indexterm" id="idm46691323903608"/><code>pulumi login</code>:</p>&#13;
&#13;
<pre data-type="programlisting">$ pulumi login&#13;
Logged into pulumi.com as griggheo (https://app.pulumi.com/griggheo)</pre>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Creating a New Pulumi Python Project for AWS" data-type="sect2"><div class="sect2" id="idm46691323901672">&#13;
<h2>Creating a New Pulumi Python Project for AWS</h2>&#13;
&#13;
<p><a data-primary="AWS (Amazon Web Services)" data-secondary="creating new Pulumi project for" data-type="indexterm" id="ix_ch10-asciidoc10"/><a data-primary="Infrastructure as Code (IaC)" data-secondary="creating new Pulumi project for AWS" data-type="indexterm" id="ix_ch10-asciidoc11"/><a data-primary="Pulumi" data-secondary="creating new project for AWS" data-type="indexterm" id="ix_ch10-asciidoc12"/>Create a directory called <em>proj1</em>, run <code>pulumi new</code> in that directory, and chose the <code>aws-python</code> template.&#13;
As part of the project creation, <code>pulumi</code> asks for the name of a stack. Call it <code>staging</code>:</p>&#13;
&#13;
<pre data-type="programlisting">$ mkdir proj1&#13;
$ cd proj1&#13;
$ pulumi new&#13;
Please choose a template: aws-python        A minimal AWS Python Pulumi program&#13;
This command will walk you through creating a new Pulumi project.&#13;
&#13;
Enter a value or leave blank to accept the (default), and press &lt;ENTER&gt;.&#13;
Press ^C at any time to quit.&#13;
&#13;
project name: (proj1)&#13;
project description: (A minimal AWS Python Pulumi program)&#13;
Created project 'proj1'&#13;
&#13;
stack name: (dev) staging&#13;
Created stack 'staging'&#13;
&#13;
aws:region: The AWS region to deploy into: (us-east-1)&#13;
Saved config&#13;
&#13;
Your new project is ready to go!&#13;
To perform an initial deployment, run the following commands:&#13;
&#13;
   1. virtualenv -p python3 venv&#13;
   2. source venv/bin/activate&#13;
   3. pip3 install -r requirements.txt&#13;
&#13;
Then, run 'pulumi up'</pre>&#13;
&#13;
<p>It is important to understand the difference between a Pulumi project and a Pulumi stack.&#13;
A project is the code you write for specifying the desired state of the system, the resources&#13;
you want Pulumi to provision. A stack is a specific deployment of the project. For example, a stack&#13;
can correspond to an environment such as development, staging, or production. In the examples that&#13;
follow, we will create two Pulumi stacks, one called <code>staging</code> that corresponds to a staging environment, and further&#13;
down the line, another stack called <code>prod</code> that corresponds to a production environment.</p>&#13;
&#13;
<p>Here are the files automatically generated by the <code>pulumi new</code> command as part of the <code>aws-python</code> template:</p>&#13;
&#13;
<pre data-type="programlisting">$ ls -la&#13;
total 40&#13;
drwxr-xr-x   7 ggheo  staff  224 Jun 13 21:43 .&#13;
drwxr-xr-x  11 ggheo  staff  352 Jun 13 21:42 ..&#13;
-rw-------   1 ggheo  staff   12 Jun 13 21:43 .gitignore&#13;
-rw-r--r--   1 ggheo  staff   32 Jun 13 21:43 Pulumi.staging.yaml&#13;
-rw-------   1 ggheo  staff   77 Jun 13 21:43 Pulumi.yaml&#13;
-rw-------   1 ggheo  staff  184 Jun 13 21:43 __main__.py&#13;
-rw-------   1 ggheo  staff   34 Jun 13 21:43 requirements.txt</pre>&#13;
&#13;
<p>Follow the instructions in the output of <code>pulumi new</code> and install <code>virtualenv</code>, then create a new <code>virtualenv</code>&#13;
environment and install the libraries specified in <span class="keep-together"><em>requirements.txt</em>:</span></p>&#13;
&#13;
<pre data-type="programlisting">$ pip3 install virtualenv&#13;
$ virtualenv -p python3 venv&#13;
$ source venv/bin/activate&#13;
(venv) pip3 install -r requirements.txt</pre>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Before provisioning any AWS resources with <code>pulumi up</code>, make sure you are using the AWS account that&#13;
you are expecting to target. One way to specify the desired AWS account is to set the <code>AWS_PROFILE</code> environment&#13;
variable in your current shell. In our case, an AWS profile called <code>gheorghiu-net</code> was already set up in&#13;
the local <em>~/.aws/credentials</em> file.</p>&#13;
</div>&#13;
&#13;
<pre data-type="programlisting">(venv) export AWS_PROFILE=gheorghiu-net</pre>&#13;
&#13;
<p>The <em>__main__.py</em> file generated by Pulumi as part of the <code>aws-python</code> template is as follows:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="err">$</code> <code class="n">cat</code> <code class="n">__main__</code><code class="o">.</code><code class="n">py</code>&#13;
<code class="kn">import</code> <code class="nn">pulumi</code>&#13;
<code class="kn">from</code> <code class="nn">pulumi_aws</code> <code class="kn">import</code> <code class="n">s3</code>&#13;
&#13;
<code class="c1"># Create an AWS resource (S3 Bucket)</code>&#13;
<code class="n">bucket</code> <code class="o">=</code> <code class="n">s3</code><code class="o">.</code><code class="n">Bucket</code><code class="p">(</code><code class="s1">'my-bucket'</code><code class="p">)</code>&#13;
&#13;
<code class="c1"># Export the name of the bucket</code>&#13;
<code class="n">pulumi</code><code class="o">.</code><code class="n">export</code><code class="p">(</code><code class="s1">'bucket_name'</code><code class="p">,</code>  <code class="n">bucket</code><code class="o">.</code><code class="n">id</code><code class="p">)</code></pre>&#13;
&#13;
<p>Clone the <a href="https://oreil.ly/SIT-v">Pulumi examples GitHub repository</a> locally, then copy <em>__main__.py</em> and the <em>www</em> directory from <em>pulumi-examples/aws-py-s3-folder</em> into the current directory.</p>&#13;
&#13;
<p>Here is the new <em>__main__.py</em> file in the current directory:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="err">$</code> <code class="n">cat</code> <code class="n">__main__</code><code class="o">.</code><code class="n">py</code>&#13;
<code class="kn">import</code> <code class="nn">json</code>&#13;
<code class="kn">import</code> <code class="nn">mimetypes</code>&#13;
<code class="kn">import</code> <code class="nn">os</code>&#13;
&#13;
<code class="kn">from</code> <code class="nn">pulumi</code> <code class="kn">import</code> <code class="n">export</code><code class="p">,</code> <code class="n">FileAsset</code>&#13;
<code class="kn">from</code> <code class="nn">pulumi_aws</code> <code class="kn">import</code> <code class="n">s3</code>&#13;
&#13;
<code class="n">web_bucket</code> <code class="o">=</code> <code class="n">s3</code><code class="o">.</code><code class="n">Bucket</code><code class="p">(</code><code class="s1">'s3-website-bucket'</code><code class="p">,</code> <code class="n">website</code><code class="o">=</code><code class="p">{</code>&#13;
    <code class="s2">"index_document"</code><code class="p">:</code> <code class="s2">"index.html"</code>&#13;
<code class="p">})</code>&#13;
&#13;
<code class="n">content_dir</code> <code class="o">=</code> <code class="s2">"www"</code>&#13;
<code class="k">for</code> <code class="nb">file</code> <code class="ow">in</code> <code class="n">os</code><code class="o">.</code><code class="n">listdir</code><code class="p">(</code><code class="n">content_dir</code><code class="p">):</code>&#13;
    <code class="n">filepath</code> <code class="o">=</code> <code class="n">os</code><code class="o">.</code><code class="n">path</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="n">content_dir</code><code class="p">,</code> <code class="nb">file</code><code class="p">)</code>&#13;
    <code class="n">mime_type</code><code class="p">,</code> <code class="n">_</code> <code class="o">=</code> <code class="n">mimetypes</code><code class="o">.</code><code class="n">guess_type</code><code class="p">(</code><code class="n">filepath</code><code class="p">)</code>&#13;
    <code class="n">obj</code> <code class="o">=</code> <code class="n">s3</code><code class="o">.</code><code class="n">BucketObject</code><code class="p">(</code><code class="nb">file</code><code class="p">,</code>&#13;
        <code class="n">bucket</code><code class="o">=</code><code class="n">web_bucket</code><code class="o">.</code><code class="n">id</code><code class="p">,</code>&#13;
        <code class="n">source</code><code class="o">=</code><code class="n">FileAsset</code><code class="p">(</code><code class="n">filepath</code><code class="p">),</code>&#13;
        <code class="n">content_type</code><code class="o">=</code><code class="n">mime_type</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">public_read_policy_for_bucket</code><code class="p">(</code><code class="n">bucket_name</code><code class="p">):</code>&#13;
    <code class="k">return</code> <code class="n">json</code><code class="o">.</code><code class="n">dumps</code><code class="p">({</code>&#13;
        <code class="s2">"Version"</code><code class="p">:</code> <code class="s2">"2012-10-17"</code><code class="p">,</code>&#13;
        <code class="s2">"Statement"</code><code class="p">:</code> <code class="p">[{</code>&#13;
            <code class="s2">"Effect"</code><code class="p">:</code> <code class="s2">"Allow"</code><code class="p">,</code>&#13;
            <code class="s2">"Principal"</code><code class="p">:</code> <code class="s2">"*"</code><code class="p">,</code>&#13;
            <code class="s2">"Action"</code><code class="p">:</code> <code class="p">[</code>&#13;
                <code class="s2">"s3:GetObject"</code>&#13;
            <code class="p">],</code>&#13;
            <code class="s2">"Resource"</code><code class="p">:</code> <code class="p">[</code>&#13;
                <code class="n">f</code><code class="s2">"arn:aws:s3:::{bucket_name}/*"</code><code class="p">,</code>&#13;
            <code class="p">]</code>&#13;
        <code class="p">}]</code>&#13;
    <code class="p">})</code>&#13;
&#13;
<code class="n">bucket_name</code> <code class="o">=</code> <code class="n">web_bucket</code><code class="o">.</code><code class="n">id</code>&#13;
<code class="n">bucket_policy</code> <code class="o">=</code> <code class="n">s3</code><code class="o">.</code><code class="n">BucketPolicy</code><code class="p">(</code><code class="s2">"bucket-policy"</code><code class="p">,</code>&#13;
    <code class="n">bucket</code><code class="o">=</code><code class="n">bucket_name</code><code class="p">,</code>&#13;
    <code class="n">policy</code><code class="o">=</code><code class="n">bucket_name</code><code class="o">.</code><code class="n">apply</code><code class="p">(</code><code class="n">public_read_policy_for_bucket</code><code class="p">))</code>&#13;
&#13;
<code class="c1"># Export the name of the bucket</code>&#13;
<code class="n">export</code><code class="p">(</code><code class="s1">'bucket_name'</code><code class="p">,</code>  <code class="n">web_bucket</code><code class="o">.</code><code class="n">id</code><code class="p">)</code>&#13;
<code class="n">export</code><code class="p">(</code><code class="s1">'website_url'</code><code class="p">,</code> <code class="n">web_bucket</code><code class="o">.</code><code class="n">website_endpoint</code><code class="p">)</code></pre>&#13;
&#13;
<p>Note the use of Python variables for <code>content_dir</code> and <code>bucket_name</code>, the use of a <code>for</code> loop, and also the use of a regular Python function<a data-primary="public_read_policy_for_bucket" data-type="indexterm" id="idm46691323840200"/> <code>public_read_policy_for_bucket</code>. It is refreshing to be able to use regular Python constructs&#13;
in IaC programs!</p>&#13;
&#13;
<p>Now it’s time to run <code>pulumi up</code> to provision the resources specified in <em>__main__.py</em>. This command&#13;
will show all the resources that will be created. Moving the current choice to <code>yes</code> will kick off the&#13;
provisioning process:</p>&#13;
&#13;
<pre data-type="programlisting">(venv) pulumi up&#13;
Previewing update (staging):&#13;
&#13;
     Type                    Name               Plan&#13;
 +   pulumi:pulumi:Stack     proj1-staging      create&#13;
 +   ├─ aws:s3:Bucket        s3-website-bucket  create&#13;
 +   ├─ aws:s3:BucketObject  favicon.png        create&#13;
 +   ├─ aws:s3:BucketPolicy  bucket-policy      create&#13;
 +   ├─ aws:s3:BucketObject  python.png         create&#13;
 +   └─ aws:s3:BucketObject  index.html         create&#13;
&#13;
Resources:&#13;
    + 6 to create&#13;
&#13;
Do you want to perform this update? yes&#13;
Updating (staging):&#13;
&#13;
     Type                    Name               Status&#13;
 +   pulumi:pulumi:Stack     proj1-staging      created&#13;
 +   ├─ aws:s3:Bucket        s3-website-bucket  created&#13;
 +   ├─ aws:s3:BucketObject  index.html         created&#13;
 +   ├─ aws:s3:BucketObject  python.png         created&#13;
 +   ├─ aws:s3:BucketObject  favicon.png        created&#13;
 +   └─ aws:s3:BucketPolicy  bucket-policy      created&#13;
&#13;
Outputs:&#13;
    bucket_name: "s3-website-bucket-8e08f8f"&#13;
    website_url: "s3-website-bucket-8e08f8f.s3-website-us-east-1.amazonaws.com"&#13;
&#13;
Resources:&#13;
    + 6 created&#13;
&#13;
Duration: 14s</pre>&#13;
&#13;
<p>Inspect the existing Pulumi stacks:</p>&#13;
&#13;
<pre data-type="programlisting">(venv) pulumi stack ls&#13;
NAME      LAST UPDATE    RESOURCE COUNT  URL&#13;
staging*  2 minutes ago  7        https://app.pulumi.com/griggheo/proj1/staging&#13;
&#13;
(venv) pulumi stack&#13;
Current stack is staging:&#13;
    Owner: griggheo&#13;
    Last updated: 3 minutes ago (2019-06-13 22:05:38.088773 -0700 PDT)&#13;
    Pulumi version: v0.17.16&#13;
Current stack resources (7):&#13;
    TYPE                              NAME&#13;
    pulumi:pulumi:Stack               proj1-staging&#13;
    pulumi:providers:aws              default&#13;
    aws:s3/bucket:Bucket              s3-website-bucket&#13;
    aws:s3/bucketPolicy:BucketPolicy  bucket-policy&#13;
    aws:s3/bucketObject:BucketObject  index.html&#13;
    aws:s3/bucketObject:BucketObject  favicon.png&#13;
    aws:s3/bucketObject:BucketObject  python.png</pre>&#13;
&#13;
<p>Inspect the outputs of the current stack:</p>&#13;
&#13;
<pre data-type="programlisting">(venv) pulumi stack output&#13;
Current stack outputs (2):&#13;
    OUTPUT       VALUE&#13;
    bucket_name  s3-website-bucket-8e08f8f&#13;
    website_url  s3-website-bucket-8e08f8f.s3-website-us-east-1.amazonaws.com</pre>&#13;
&#13;
<p>Visit the URL specified in the <code>website_url</code> output (<a href="http://s3-website-bucket-8e08f8f.s3-website-us-east-1.amazonaws.com"><em class="hyperlink">http://s3-website-bucket-8e08f8f.s3-website-us-east-1.amazonaws.com</em></a>) and make sure you can see the static site.</p>&#13;
&#13;
<p>In the sections that follow, the Pulumi project will be enhanced by specifying more AWS resources to be provisioned.&#13;
The goal is to have parity with the resources that were provisioned with Terraform: an ACM SSL certificate,&#13;
a CloudFront distribution, and a Route 53 DNS record for the site URL.<a data-startref="ix_ch10-asciidoc12" data-type="indexterm" id="idm46691323582840"/><a data-startref="ix_ch10-asciidoc11" data-type="indexterm" id="idm46691323582168"/><a data-startref="ix_ch10-asciidoc10" data-type="indexterm" id="idm46691323581496"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Creating Configuration Values for the Staging Stack" data-type="sect2"><div class="sect2" id="idm46691323900728">&#13;
<h2>Creating Configuration Values for the Staging Stack</h2>&#13;
&#13;
<p><a data-primary="configuration values, staging stack with" data-type="indexterm" id="idm46691323579800"/><a data-primary="Pulumi" data-secondary="creating configuration values for staging stack" data-type="indexterm" id="idm46691323578808"/><a data-primary="staging stack" data-type="indexterm" id="idm46691323577800"/>The current stack is <code>staging</code>. Rename the existing <em>www</em> directory to <em>www-staging</em>, then&#13;
use the <code>pulumi config set</code> command to specify two configuration values for the current <code>staging</code> stack:&#13;
<code>domain_name</code> and <code>local_webdir</code>.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>For more details on how Pulumi manages configuration values and secrets,&#13;
see <a href="https://oreil.ly/D_Cy5">the Pulumi reference documentation</a>.</p>&#13;
</div>&#13;
&#13;
<pre data-type="programlisting">(venv) mv www www-staging&#13;
(venv) pulumi config set local_webdir www-staging&#13;
(venv) pulumi config set domain_name staging.devops4all.dev</pre>&#13;
&#13;
<p>To inspect the existing configuration values for the current stack, run:</p>&#13;
&#13;
<pre data-type="programlisting">(venv) pulumi config&#13;
KEY           VALUE&#13;
aws:region    us-east-1&#13;
domain_name   staging.devops4all.dev&#13;
local_webdir  www-staging</pre>&#13;
&#13;
<p>Once the configuration values are set, use them in the Pulumi code:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">pulumi</code>&#13;
&#13;
<code class="n">config</code> <code class="o">=</code> <code class="n">pulumi</code><code class="o">.</code><code class="n">Config</code><code class="p">(</code><code class="s1">'proj1'</code><code class="p">)</code>  <code class="c1"># proj1 is project name defined in Pulumi.yaml</code>&#13;
&#13;
<code class="n">content_dir</code> <code class="o">=</code> <code class="n">config</code><code class="o">.</code><code class="n">require</code><code class="p">(</code><code class="s1">'local_webdir'</code><code class="p">)</code>&#13;
<code class="n">domain_name</code> <code class="o">=</code> <code class="n">config</code><code class="o">.</code><code class="n">require</code><code class="p">(</code><code class="s1">'domain_name'</code><code class="p">)</code></pre>&#13;
&#13;
<p>Now that the configuration values are in place; next we will provision an SSL certificate with&#13;
the AWS Certificate Manager service.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Provisioning an ACM SSL Certificate" data-type="sect2"><div class="sect2" id="idm46691323545592">&#13;
<h2>Provisioning an ACM SSL Certificate</h2>&#13;
&#13;
<p><a data-primary="ACM (AWS Certificate Manager)" data-type="indexterm" id="idm46691323544312"/><a data-primary="AWS Certificate Manager (ACM)" data-type="indexterm" id="idm46691323543640"/><a data-primary="Pulumi" data-secondary="provisioning an ACM SSL certificate" data-type="indexterm" id="idm46691323543000"/><a data-primary="SSL certificate, provisioning with ACM" data-type="indexterm" id="idm46691323542088"/>Around this point, Pulumi starts to show its rough edges when it comes to its Python SDK.&#13;
Just reading the Pulumi Python SDK reference for the <a href="https://oreil.ly/Niwaj"><code>acm</code></a> module is not sufficient to make sense of what you need to do in your Pulumi program.</p>&#13;
&#13;
<p>Fortunately, there are many Pulumi examples in TypeScript that you can take inspiration from. One such example&#13;
that illustrated our use case is <a href="https://oreil.ly/7F39c"><code>aws-ts-static-website</code></a>.</p>&#13;
&#13;
<p>Here is the TypeScript code for creating a new ACM certificate (from <a href="https://oreil.ly/mlSr1"><code>index.ts</code></a>):</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">const</code> <code class="n">certificate</code> <code class="o">=</code> <code class="n">new</code> <code class="n">aws</code><code class="o">.</code><code class="n">acm</code><code class="o">.</code><code class="n">Certificate</code><code class="p">(</code><code class="s2">"certificate"</code><code class="p">,</code> <code class="p">{</code>&#13;
    <code class="n">domainName</code><code class="p">:</code> <code class="n">config</code><code class="o">.</code><code class="n">targetDomain</code><code class="p">,</code>&#13;
    <code class="n">validationMethod</code><code class="p">:</code> <code class="s2">"DNS"</code><code class="p">,</code>&#13;
<code class="p">},</code> <code class="p">{</code> <code class="n">provider</code><code class="p">:</code> <code class="n">eastRegion</code> <code class="p">});</code></pre>&#13;
&#13;
<p>Here is the equivalent Python code that we wrote:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">pulumi_aws</code> <code class="kn">import</code> <code class="n">acm</code>&#13;
&#13;
<code class="n">cert</code> <code class="o">=</code> <code class="n">acm</code><code class="o">.</code><code class="n">Certificate</code><code class="p">(</code><code class="s1">'certificate'</code><code class="p">,</code> <code class="n">domain_name</code><code class="o">=</code><code class="n">domain_name</code><code class="p">,</code>&#13;
    <code class="n">validation_method</code><code class="o">=</code><code class="s1">'DNS'</code><code class="p">)</code></pre>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>A rule of thumb in porting Pulumi code from TypeScript to Python is that parameter names that are camelCased in TypeScript become snake_cased in Python. As you can see in the earlier example, <code>domainName</code> becomes <code>domain_name</code>&#13;
and <code>validationMethod</code> becomes <code>validation_method</code>.</p>&#13;
</div>&#13;
&#13;
<p>Our next step was to provision a Route 53 zone and in that zone a DNS validation record for the ACM SSL certificate.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Provisioning a Route 53 Zone and DNS Records" data-type="sect2"><div class="sect2" id="idm46691323469960">&#13;
<h2>Provisioning a Route 53 Zone and DNS Records</h2>&#13;
&#13;
<p><a data-primary="Pulumi" data-secondary="provisioning a Route53 zone and DNS Records" data-type="indexterm" id="ix_ch10-asciidoc13"/><a data-primary="route53 DNS record, provisioning" data-type="indexterm" id="ix_ch10-asciidoc14"/>Provisioning a new Route 53 zone with Pulumi is easy if you follow the <a href="https://oreil.ly/cU9Yj">Pulumi SDK reference for route53</a>.</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">pulumi_aws</code> <code class="kn">import</code> <code class="n">route53</code>&#13;
&#13;
<code class="n">domain_name</code> <code class="o">=</code> <code class="n">config</code><code class="o">.</code><code class="n">require</code><code class="p">(</code><code class="s1">'domain_name'</code><code class="p">)</code>&#13;
&#13;
<code class="c1"># Split a domain name into its subdomain and parent domain names.</code>&#13;
<code class="c1"># e.g. "www.example.com" =&gt; "www", "example.com".</code>&#13;
<code class="k">def</code> <code class="nf">get_domain_and_subdomain</code><code class="p">(</code><code class="n">domain</code><code class="p">):</code>&#13;
  <code class="n">names</code> <code class="o">=</code> <code class="n">domain</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="s2">"."</code><code class="p">)</code>&#13;
  <code class="k">if</code> <code class="nb">len</code><code class="p">(</code><code class="n">names</code><code class="p">)</code> <code class="o">&lt;</code> <code class="mi">3</code><code class="p">:</code>&#13;
    <code class="k">return</code><code class="p">(</code><code class="s1">''</code><code class="p">,</code> <code class="n">domain</code><code class="p">)</code>&#13;
  <code class="n">subdomain</code> <code class="o">=</code> <code class="n">names</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code>&#13;
  <code class="n">parent_domain</code> <code class="o">=</code> <code class="s2">"."</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="n">names</code><code class="p">[</code><code class="mi">1</code><code class="p">:])</code>&#13;
  <code class="k">return</code> <code class="p">(</code><code class="n">subdomain</code><code class="p">,</code> <code class="n">parent_domain</code><code class="p">)</code>&#13;
&#13;
<code class="p">(</code><code class="n">subdomain</code><code class="p">,</code> <code class="n">parent_domain</code><code class="p">)</code> <code class="o">=</code> <code class="n">get_domain_and_subdomain</code><code class="p">(</code><code class="n">domain_name</code><code class="p">)</code>&#13;
<code class="n">zone</code> <code class="o">=</code> <code class="n">route53</code><code class="o">.</code><code class="n">Zone</code><code class="p">(</code><code class="s2">"route53_zone"</code><code class="p">,</code> <code class="n">name</code><code class="o">=</code><code class="n">parent_domain</code><code class="p">)</code></pre>&#13;
&#13;
<p>The preceding snippet shows how to use a regular Python function to split the configuration value read into&#13;
the <code>domain_name</code> variable into two parts. If <code>domain_name</code> is <code>staging.devops4all.dev</code>, the function will split&#13;
it into <code>subdomain</code> (<code>staging</code>) and <span class="keep-together"><code>parent_domain</code></span> (<code>devops4all.dev</code>).</p>&#13;
&#13;
<p>The <code>parent_domain</code> variable is then used as a parameter to the constructor of the <code>zone</code> object, which tells&#13;
Pulumi to provision a <code>route53.Zone</code> resource.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Once the Route 53 zone was created, we had to point the Namecheap name servers at the name servers specified&#13;
in the DNS record for the new zone so that the zone can be publicly accessible.</p>&#13;
</div>&#13;
&#13;
<p>All was well and good so far. The next step was to create both the ACM certificate and a DNS record to validate&#13;
the certificate.</p>&#13;
&#13;
<p>We first tried to port the example TypeScript code by applying the rule of thumb of turning camelCase parameter names into snake_case.</p>&#13;
&#13;
<p>TypeScript:</p>&#13;
&#13;
<pre data-code-language="typescript" data-type="programlisting">    <code class="kr">const</code> <code class="nx">certificateValidationDomain</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">aws</code><code class="p">.</code><code class="nx">route53</code><code class="p">.</code><code class="nx">Record</code><code class="p">(</code>&#13;
        <code class="sb">`</code><code class="si">${</code><code class="nx">config</code><code class="p">.</code><code class="nx">targetDomain</code><code class="si">}</code><code class="sb">-validation`</code><code class="p">,</code> <code class="p">{</code>&#13;
        <code class="nx">name</code>: <code class="nx">certificate.domainValidationOptions</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">resourceRecordName</code><code class="p">,</code>&#13;
        <code class="nx">zoneId</code>: <code class="nx">hostedZoneId</code><code class="p">,</code>&#13;
        <code class="nx">type</code>: <code class="nx">certificate.domainValidationOptions</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">resourceRecordType</code><code class="p">,</code>&#13;
        <code class="nx">records</code><code class="o">:</code> <code class="p">[</code><code class="nx">certificate</code><code class="p">.</code><code class="nx">domainValidationOptions</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">resourceRecordValue</code><code class="p">],</code>&#13;
        <code class="nx">ttl</code>: <code class="nx">tenMinutes</code><code class="p">,</code>&#13;
    <code class="p">});</code></pre>&#13;
&#13;
<p>The first attempt at porting to Python by switching camelCase to snake_case:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">cert</code> <code class="o">=</code> <code class="n">acm</code><code class="o">.</code><code class="n">Certificate</code><code class="p">(</code><code class="s1">'certificate'</code><code class="p">,</code>&#13;
    <code class="n">domain_name</code><code class="o">=</code><code class="n">domain_name</code><code class="p">,</code> <code class="n">validation_method</code><code class="o">=</code><code class="s1">'DNS'</code><code class="p">)</code>&#13;
&#13;
<code class="n">domain_validation_options</code> <code class="o">=</code> <code class="n">cert</code><code class="o">.</code><code class="n">domain_validation_options</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code>&#13;
&#13;
<code class="n">cert_validation_record</code> <code class="o">=</code> <code class="n">route53</code><code class="o">.</code><code class="n">Record</code><code class="p">(</code>&#13;
  <code class="s1">'cert-validation-record'</code><code class="p">,</code>&#13;
  <code class="n">name</code><code class="o">=</code><code class="n">domain_validation_options</code><code class="o">.</code><code class="n">resource_record_name</code><code class="p">,</code>&#13;
  <code class="n">zone_id</code><code class="o">=</code><code class="n">zone</code><code class="o">.</code><code class="n">id</code><code class="p">,</code>&#13;
  <code class="nb">type</code><code class="o">=</code><code class="n">domain_validation_options</code><code class="o">.</code><code class="n">resource_record_type</code><code class="p">,</code>&#13;
  <code class="n">records</code><code class="o">=</code><code class="p">[</code><code class="n">domain_validation_options</code><code class="o">.</code><code class="n">resource_record_value</code><code class="p">],</code>&#13;
  <code class="n">ttl</code><code class="o">=</code><code class="mi">600</code><code class="p">)</code></pre>&#13;
&#13;
<p>No luck. <a data-primary="pulumi up" data-type="indexterm" id="idm46691323150808"/><code>pulumi up</code> shows this error:</p>&#13;
&#13;
<pre data-type="programlisting">AttributeError: 'dict' object has no attribute 'resource_record_name'</pre>&#13;
&#13;
<p>At this point, we were stumped, because the Python SDK documentation doesn’t include this level of detail. We did not know&#13;
what attributes we needed to specify for the <code>domain_validation_options</code> object.</p>&#13;
&#13;
<p>We were only able to get past this by adding the <code>domain_validation_options</code> object to the list of Pulumi exports, which are printed out by Pulumi at the end of the <code>pulumi up</code> operation:</p>&#13;
&#13;
<pre data-type="programlisting">export('domain_validation_options', domain_validation_options)</pre>&#13;
&#13;
<p>The output from <code>pulumi up</code> was:</p>&#13;
&#13;
<pre data-type="programlisting">+ domain_validation_options: {&#13;
  + domain_name        : "staging.devops4all.dev"&#13;
  + resourceRecordName : "_c5f82e0f032d0f4f6c7de17fc2c.staging.devops4all.dev."&#13;
  + resourceRecordType : "CNAME"&#13;
  + resourceRecordValue: "_08e3d475bf3aeda0c98.ltfvzjuylp.acm-validations.aws."&#13;
    }</pre>&#13;
&#13;
<p>Bingo! It turns out that the attributes of the <code>domain_validation_options</code> object are still camelCased.</p>&#13;
&#13;
<p>Here is the second attempt at porting to Python, which was successful:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">cert_validation_record</code> <code class="o">=</code> <code class="n">route53</code><code class="o">.</code><code class="n">Record</code><code class="p">(</code>&#13;
  <code class="s1">'cert-validation-record'</code><code class="p">,</code>&#13;
  <code class="n">name</code><code class="o">=</code><code class="n">domain_validation_options</code><code class="p">[</code><code class="s1">'resourceRecordName'</code><code class="p">],</code>&#13;
  <code class="n">zone_id</code><code class="o">=</code><code class="n">zone</code><code class="o">.</code><code class="n">id</code><code class="p">,</code>&#13;
  <code class="nb">type</code><code class="o">=</code><code class="n">domain_validation_options</code><code class="p">[</code><code class="s1">'resourceRecordType'</code><code class="p">],</code>&#13;
  <code class="n">records</code><code class="o">=</code><code class="p">[</code><code class="n">domain_validation_options</code><code class="p">[</code><code class="s1">'resourceRecordValue'</code><code class="p">]],</code>&#13;
  <code class="n">ttl</code><code class="o">=</code><code class="mi">600</code><code class="p">)</code></pre>&#13;
&#13;
<p>Next, specify a new type of resource to be provisioned: a certificate validation completion resource.&#13;
This causes the <code>pulumi up</code> operation to wait until ACM validates the certificate by checking the Route 53&#13;
validation record created earlier.</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">cert_validation_completion</code> <code class="o">=</code> <code class="n">acm</code><code class="o">.</code><code class="n">CertificateValidation</code><code class="p">(</code>&#13;
        <code class="s1">'cert-validation-completion'</code><code class="p">,</code>&#13;
        <code class="n">certificate_arn</code><code class="o">=</code><code class="n">cert</code><code class="o">.</code><code class="n">arn</code><code class="p">,</code>&#13;
        <code class="n">validation_record_fqdns</code><code class="o">=</code><code class="p">[</code><code class="n">cert_validation_dns_record</code><code class="o">.</code><code class="n">fqdn</code><code class="p">])</code>&#13;
&#13;
<code class="n">cert_arn</code> <code class="o">=</code> <code class="n">cert_validation_completion</code><code class="o">.</code><code class="n">certificate_arn</code></pre>&#13;
&#13;
<p>At this point, you have a fully automated way of provisioning an ACM SSL certificate and of validating it&#13;
via DNS.</p>&#13;
&#13;
<p>The next step is to provision the CloudFront distribution in front of the S3 bucket hosting the static&#13;
files for the site.<a data-startref="ix_ch10-asciidoc14" data-type="indexterm" id="idm46691322954696"/><a data-startref="ix_ch10-asciidoc13" data-type="indexterm" id="idm46691322900616"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Provisioning a CloudFront Distribution" data-type="sect2"><div class="sect2" id="idm46691323469016">&#13;
<h2>Provisioning a CloudFront Distribution</h2>&#13;
&#13;
<p><a data-primary="CloudFront distribution, provisioning" data-type="indexterm" id="idm46691322898952"/><a data-primary="Pulumi" data-secondary="provisioning a CloudFront distribution" data-type="indexterm" id="idm46691322898232"/>Use the SDK reference for the Pulumi <a href="https://oreil.ly/4n98-"><code>cloudfront</code> module</a> to figure out which constructor parameters to pass to <code>cloudfront.Distribution</code>.&#13;
Inspect the TypeScript code to know what the proper values are for those parameters.</p>&#13;
&#13;
<p>Here is the final result:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">log_bucket</code> <code class="o">=</code> <code class="n">s3</code><code class="o">.</code><code class="n">Bucket</code><code class="p">(</code><code class="s1">'cdn-log-bucket'</code><code class="p">,</code> <code class="n">acl</code><code class="o">=</code><code class="s1">'private'</code><code class="p">)</code>&#13;
&#13;
<code class="n">cloudfront_distro</code> <code class="o">=</code> <code class="n">cloudfront</code><code class="o">.</code><code class="n">Distribution</code> <code class="p">(</code> <code class="s1">'cloudfront-distro'</code><code class="p">,</code>&#13;
    <code class="n">enabled</code><code class="o">=</code><code class="bp">True</code><code class="p">,</code>&#13;
    <code class="n">aliases</code><code class="o">=</code><code class="p">[</code> <code class="n">domain_name</code> <code class="p">],</code>&#13;
    <code class="n">origins</code><code class="o">=</code><code class="p">[</code>&#13;
        <code class="p">{</code>&#13;
          <code class="s1">'originId'</code><code class="p">:</code> <code class="n">web_bucket</code><code class="o">.</code><code class="n">arn</code><code class="p">,</code>&#13;
          <code class="s1">'domainName'</code><code class="p">:</code> <code class="n">web_bucket</code><code class="o">.</code><code class="n">website_endpoint</code><code class="p">,</code>&#13;
          <code class="s1">'customOriginConfig'</code><code class="p">:</code> <code class="p">{</code>&#13;
              <code class="s1">'originProtocolPolicy'</code><code class="p">:</code> <code class="s2">"http-only"</code><code class="p">,</code>&#13;
              <code class="s1">'httpPort'</code><code class="p">:</code> <code class="mi">80</code><code class="p">,</code>&#13;
              <code class="s1">'httpsPort'</code><code class="p">:</code> <code class="mi">443</code><code class="p">,</code>&#13;
              <code class="s1">'originSslProtocols'</code><code class="p">:</code> <code class="p">[</code><code class="s2">"TLSv1.2"</code><code class="p">],</code>&#13;
            <code class="p">},</code>&#13;
        <code class="p">},</code>&#13;
    <code class="p">],</code>&#13;
&#13;
    <code class="n">default_root_object</code><code class="o">=</code><code class="s2">"index.html"</code><code class="p">,</code>&#13;
    <code class="n">default_cache_behavior</code><code class="o">=</code><code class="p">{</code>&#13;
        <code class="s1">'targetOriginId'</code><code class="p">:</code> <code class="n">web_bucket</code><code class="o">.</code><code class="n">arn</code><code class="p">,</code>&#13;
&#13;
        <code class="s1">'viewerProtocolPolicy'</code><code class="p">:</code> <code class="s2">"redirect-to-https"</code><code class="p">,</code>&#13;
        <code class="s1">'allowedMethods'</code><code class="p">:</code> <code class="p">[</code><code class="s2">"GET"</code><code class="p">,</code> <code class="s2">"HEAD"</code><code class="p">,</code> <code class="s2">"OPTIONS"</code><code class="p">],</code>&#13;
        <code class="s1">'cachedMethods'</code><code class="p">:</code> <code class="p">[</code><code class="s2">"GET"</code><code class="p">,</code> <code class="s2">"HEAD"</code><code class="p">,</code> <code class="s2">"OPTIONS"</code><code class="p">],</code>&#13;
&#13;
        <code class="s1">'forwardedValues'</code><code class="p">:</code> <code class="p">{</code>&#13;
            <code class="s1">'cookies'</code><code class="p">:</code> <code class="p">{</code> <code class="s1">'forward'</code><code class="p">:</code> <code class="s2">"none"</code> <code class="p">},</code>&#13;
            <code class="s1">'queryString'</code><code class="p">:</code> <code class="bp">False</code><code class="p">,</code>&#13;
        <code class="p">},</code>&#13;
&#13;
        <code class="s1">'minTtl'</code><code class="p">:</code> <code class="mi">0</code><code class="p">,</code>&#13;
        <code class="s1">'defaultTtl'</code><code class="p">:</code> <code class="mi">600</code><code class="p">,</code>&#13;
        <code class="s1">'maxTtl'</code><code class="p">:</code> <code class="mi">600</code><code class="p">,</code>&#13;
    <code class="p">},</code>&#13;
    <code class="n">price_class</code><code class="o">=</code><code class="s2">"PriceClass_100"</code><code class="p">,</code>&#13;
    <code class="n">custom_error_responses</code><code class="o">=</code><code class="p">[</code>&#13;
        <code class="p">{</code> <code class="s1">'errorCode'</code><code class="p">:</code> <code class="mi">404</code><code class="p">,</code> <code class="s1">'responseCode'</code><code class="p">:</code> <code class="mi">404</code><code class="p">,</code>&#13;
          <code class="s1">'responsePagePath'</code><code class="p">:</code> <code class="s2">"/404.html"</code> <code class="p">},</code>&#13;
    <code class="p">],</code>&#13;
&#13;
    <code class="n">restrictions</code><code class="o">=</code><code class="p">{</code>&#13;
        <code class="s1">'geoRestriction'</code><code class="p">:</code> <code class="p">{</code>&#13;
            <code class="s1">'restrictionType'</code><code class="p">:</code> <code class="s2">"none"</code><code class="p">,</code>&#13;
        <code class="p">},</code>&#13;
    <code class="p">},</code>&#13;
    <code class="n">viewer_certificate</code><code class="o">=</code><code class="p">{</code>&#13;
        <code class="s1">'acmCertificateArn'</code><code class="p">:</code> <code class="n">cert_arn</code><code class="p">,</code>&#13;
        <code class="s1">'sslSupportMethod'</code><code class="p">:</code> <code class="s2">"sni-only"</code><code class="p">,</code>&#13;
    <code class="p">},</code>&#13;
    <code class="n">logging_config</code><code class="o">=</code><code class="p">{</code>&#13;
        <code class="s1">'bucket'</code><code class="p">:</code> <code class="n">log_bucket</code><code class="o">.</code><code class="n">bucket_domain_name</code><code class="p">,</code>&#13;
        <code class="s1">'includeCookies'</code><code class="p">:</code> <code class="bp">False</code><code class="p">,</code>&#13;
        <code class="s1">'prefix'</code><code class="p">:</code> <code class="n">domain_name</code><code class="p">,</code>&#13;
    <code class="p">})</code></pre>&#13;
&#13;
<p>Run <a data-primary="pulumi up" data-type="indexterm" id="idm46691322892296"/><code>pulumi up</code> to provision the CloudFront distribution.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Provisioning a Route 53 DNS Record for the Site URL" data-type="sect2"><div class="sect2" id="idm46691322891112">&#13;
<h2>Provisioning a Route 53 DNS Record for the Site URL</h2>&#13;
&#13;
<p><a data-primary="route53 DNS record, provisioning" data-type="indexterm" id="idm46691322642216"/><a data-primary="site URL, route53 DNS record provisioning for" data-type="indexterm" id="idm46691322641544"/>The last step in the end-to-end provisioning of the resources for the <code>staging</code> stack was the relatively simple&#13;
task of specifying a DNS record of type <code>A</code> as an alias to the domain of the CloudFront endpoint:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">site_dns_record</code> <code class="o">=</code> <code class="n">route53</code><code class="o">.</code><code class="n">Record</code><code class="p">(</code>&#13;
        <code class="s1">'site-dns-record'</code><code class="p">,</code>&#13;
        <code class="n">name</code><code class="o">=</code><code class="n">subdomain</code><code class="p">,</code>&#13;
        <code class="n">zone_id</code><code class="o">=</code><code class="n">zone</code><code class="o">.</code><code class="n">id</code><code class="p">,</code>&#13;
        <code class="nb">type</code><code class="o">=</code><code class="s2">"A"</code><code class="p">,</code>&#13;
        <code class="n">aliases</code><code class="o">=</code><code class="p">[</code>&#13;
        <code class="p">{</code>&#13;
            <code class="s1">'name'</code><code class="p">:</code> <code class="n">cloudfront_distro</code><code class="o">.</code><code class="n">domain_name</code><code class="p">,</code>&#13;
            <code class="s1">'zoneId'</code><code class="p">:</code> <code class="n">cloudfront_distro</code><code class="o">.</code><code class="n">hosted_zone_id</code><code class="p">,</code>&#13;
            <code class="s1">'evaluateTargetHealth'</code><code class="p">:</code> <code class="bp">True</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">])</code></pre>&#13;
&#13;
<p>Run <code>pulumi up</code> as usual.</p>&#13;
&#13;
<p>Visit <a href="https://staging.devops4all.dev"><em class="hyperlink">https://staging.devops4all.dev</em></a> and see the files uploaded to S3. Go to the logging bucket in the AWS console and make sure the CloudFront logs are there.</p>&#13;
&#13;
<p>Let’s see how to deploy the same Pulumi project to a new environment, represented&#13;
by a new Pulumi stack.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Creating and Deploying a New Stack" data-type="sect2"><div class="sect2" id="idm46691322499192">&#13;
<h2>Creating and Deploying a New Stack</h2>&#13;
&#13;
<p><a data-primary="new stack, creation and deployment of" data-type="indexterm" id="ix_ch10-asciidoc15"/><a data-primary="Pulumi" data-secondary="creating/deploying a new stack" data-type="indexterm" id="ix_ch10-asciidoc16"/>We decided to modify the Pulumi program so that it does not provision a new Route 53 zone, but&#13;
instead uses the value of the zone ID for an existing zone as a configuration value.</p>&#13;
&#13;
<p>To create the <code>prod</code> stack, use the command <a data-primary="pulumi stack init" data-type="indexterm" id="idm46691322494376"/><code>pulumi stack init</code> and specify <code>prod</code> for its name:</p>&#13;
&#13;
<pre data-type="programlisting">(venv) pulumi stack init&#13;
Please enter your desired stack name: prod&#13;
Created stack 'prod'</pre>&#13;
&#13;
<p>Listing the stacks now shows the two stacks, <code>staging</code> and <code>prod</code>, with an asterisk next to <code>prod</code> signifying&#13;
that <code>prod</code> is the current stack:</p>&#13;
&#13;
<pre data-type="programlisting">(venv) pulumi stack ls&#13;
NAME     LAST UPDATE     RESOURCE COUNT  URL&#13;
prod*    n/a             n/a      https://app.pulumi.com/griggheo/proj1/prod&#13;
staging  14 minutes ago  14       https://app.pulumi.com/griggheo/proj1/staging</pre>&#13;
&#13;
<p>Now it’s time to set the proper configuration values for the <code>prod</code> stack. Use a new <code>dns_zone_id</code> configuration value, set to the ID of the zone that was already created by Pulumi when it provisioned the <code>staging</code> stack:</p>&#13;
&#13;
<pre data-type="programlisting">(venv) pulumi config set aws:region us-east-1&#13;
(venv) pulumi config set local_webdir www-prod&#13;
(venv) pulumi config set domain_name www.devops4all.dev&#13;
(venv) pulumi config set dns_zone_id Z2FTL2X8M0EBTW</pre>&#13;
&#13;
<p>Change the code to read <code>zone_id</code> from the configuration and to not create the Route 53 zone object.</p>&#13;
&#13;
<p>Run <code>pulumi up</code> to provision the AWS resources:</p>&#13;
&#13;
<pre data-type="programlisting">(venv) pulumi up&#13;
Previewing update (prod):&#13;
&#13;
     Type                            Name               Plan&#13;
     pulumi:pulumi:Stack             proj1-prod&#13;
 +   ├─ aws:cloudfront:Distribution  cloudfront-distro  create&#13;
 +   └─ aws:route53:Record           site-dns-record    create&#13;
&#13;
Resources:&#13;
    + 2 to create&#13;
    10 unchanged&#13;
&#13;
Do you want to perform this update? yes&#13;
Updating (prod):&#13;
&#13;
     Type                            Name               Status&#13;
     pulumi:pulumi:Stack             proj1-prod&#13;
 +   ├─ aws:cloudfront:Distribution  cloudfront-distro  created&#13;
 +   └─ aws:route53:Record           site-dns-record    created&#13;
&#13;
Outputs:&#13;
+ cloudfront_domain: "d3uhgbdw67nmlc.cloudfront.net"&#13;
+ log_bucket_id    : "cdn-log-bucket-53d8ea3"&#13;
+ web_bucket_id    : "s3-website-bucket-cde"&#13;
+ website_url      : "s3-website-bucket-cde.s3-website-us-east-1.amazonaws.com"&#13;
&#13;
Resources:&#13;
    + 2 created&#13;
    10 unchanged&#13;
&#13;
Duration: 18m54s</pre>&#13;
&#13;
<p>Success! The <code>prod</code> stack was fully deployed.</p>&#13;
&#13;
<p>However, the contents of the <em>www-prod</em> directory containing the static files for the site are identical at this&#13;
point to the contents of the <em>www-staging</em> directory.</p>&#13;
&#13;
<p>Modify <em>www-prod/index.html</em> to change “Hello, S3!” to “Hello, S3 production!”, then run <code>pulumi up</code> again to detect the changes and upload the modified file to S3:</p>&#13;
&#13;
<pre data-type="programlisting">(venv) pulumi up&#13;
Previewing update (prod):&#13;
&#13;
     Type                    Name        Plan       Info&#13;
     pulumi:pulumi:Stack     proj1-prod&#13;
 ~   └─ aws:s3:BucketObject  index.html  update     [diff: ~source]&#13;
&#13;
Resources:&#13;
    ~ 1 to update&#13;
    11 unchanged&#13;
&#13;
Do you want to perform this update? yes&#13;
Updating (prod):&#13;
&#13;
     Type                    Name        Status      Info&#13;
     pulumi:pulumi:Stack     proj1-prod&#13;
 ~   └─ aws:s3:BucketObject  index.html  updated     [diff: ~source]&#13;
&#13;
Outputs:&#13;
cloudfront_domain: "d3uhgbdw67nmlc.cloudfront.net"&#13;
log_bucket_id    : "cdn-log-bucket-53d8ea3"&#13;
web_bucket_id    : "s3-website-bucket-cde"&#13;
website_url      : "s3-website-bucket-cde.s3-website-us-east-1.amazonaws.com"&#13;
&#13;
Resources:&#13;
    ~ 1 updated&#13;
    11 unchanged&#13;
&#13;
Duration: 4s</pre>&#13;
&#13;
<p>Invalidate the cache of the CloudFront distribution to see the change.</p>&#13;
&#13;
<p>Visit <a href="https://www.devops4all.dev"><em class="hyperlink">https://www.devops4all.dev</em></a> and see the message: <code>Hello, S3 production!</code></p>&#13;
&#13;
<p>One caveat about IaC tools that keep track of the state of the system: there are situations when the state as seen by the tool will be different from the actual state.&#13;
In that case, it is important to synchronize the two states; otherwise, they will drift apart more and more and you will&#13;
be in the situation where you don’t dare make any more changes for fear that you will break production. It’s&#13;
not for nothing that the word <em>Code</em> is prominent in <em>Infrastructure as Code</em>. Once you commit to using an IaC tool, best practices say that you should provision all resources via code, and no longer spin up any resource manually.&#13;
It is hard to maintain this discipline, but it pays dividends in the long run<a data-startref="ix_ch10-asciidoc16" data-type="indexterm" id="idm46691322610200"/><a data-startref="ix_ch10-asciidoc15" data-type="indexterm" id="idm46691322609496"/>.<a data-startref="ix_ch10-asciidoc1" data-type="indexterm" id="idm46691322608696"/><a data-startref="ix_ch10-asciidoc0" data-type="indexterm" id="idm46691322607992"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Exercises" data-type="sect1"><div class="sect1" id="idm46691323911336">&#13;
<h1>Exercises</h1>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Provision the same set of AWS resources by using the <a href="https://aws.amazon.com/cdk">AWS Cloud Development Kit</a>.</p>&#13;
</li>&#13;
<li>&#13;
<p>Use Terraform or Pulumi to provision cloud resources from other cloud providers, such as Google Cloud Platform or Microsoft Azure.<a data-startref="ix_" data-type="indexterm" id="idm46691322603960"/><a data-startref="ix_" data-type="indexterm" id="idm46691322603256"/></p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>