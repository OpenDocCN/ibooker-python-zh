<html><head></head><body>
<div id="sbo-rt-content"><section data-pdf-bookmark="Chapter 5. Saving User Input: Testing the Database" data-type="chapter" epub:type="chapter"><div class="chapter" id="chapter_post_and_database">
<h1><span class="label">Chapter 5. </span>Saving User Input: Testing the Database</h1>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id283">
<h1>A Note for Early Release Readers</h1>
<p>With Early Release ebooks, you get books in their earliest form—the author’s raw and unedited content as they write—so you can take advantage of these technologies long before the official release of these titles.</p>
<p>This will be the 5th chapter of the final book. The GitHub repo is available at <a class="bare" href="https://github.com/hjwp/book-example"><em class="hyperlink">https://github.com/hjwp/book-example</em></a>.</p>
<p>If you have comments about how we might improve the content and/or examples in this book, or if you notice missing material within this chapter, please reach out to the author at <a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a>.</p>
</div></aside>
<p>So far we’ve managed to return a static HTML page with an input box in it.
Next we want to take the text that the user types into that input box and send it to the server,
so that we can save it somehow and display it back to her later.</p>
<p>The first time I started writing code for this chapter,
I immediately wanted to skip to what I thought was the right design:
multiple database tables for lists and list items,
a bunch of different URLs for adding new lists and items,
three new view functions,
and about half a dozen new unit tests for all of the above.
But I stopped myself.
Although I was pretty sure I was smart enough
to handle coding all those problems at once,
the point of TDD is to allow you to do one thing at a time,
when you need to.
So I decided to be deliberately short-sighted,
and at any given moment <em>only</em> do what was necessary
to get the functional tests a little further.</p>
<p><a data-primary="iterative development style" data-type="indexterm" id="id284"/>
This will be a demonstration of how TDD can support an incremental,
iterative style of development—​it
may not be the quickest route, but you do get there in the end<sup><a data-type="noteref" href="ch05.xhtml#id285" id="id285-marker">1</a></sup>.
There’s a neat side benefit,
which is that it allows me to introduce new concepts like models,
dealing with POST requests, Django template tags, and so on,
<em>one at a time</em> rather than having to dump them on you all at once.</p>
<p>None of this says that you <em>shouldn’t</em> try to think ahead, and be clever.
In the next chapter we’ll use a bit more design and up-front thinking,
and show how that fits in with TDD.
But for now let’s plough on mindlessly and just do what the tests tell us to.</p>
<section data-pdf-bookmark="Wiring Up Our Form to Send a POST Request" data-type="sect1"><div class="sect1" id="id76">
<h1>Wiring Up Our Form to Send a POST Request</h1>
<p><a data-primary="database testing" data-secondary="HTML POST requests" data-tertiary="creating" data-type="indexterm" id="DBIpostcreate05"/>
<a data-primary="POST requests" data-secondary="creating" data-type="indexterm" id="POSTcreate05"/>
<a data-primary="HTML" data-secondary="POST requests" data-tertiary="creating" data-type="indexterm" id="id286"/>
At the end of the last chapter,
the tests were telling us we weren’t able to save the user’s input:</p>
<pre data-type="programlisting">  File "...goat-book/functional_tests.py", line 40, in
test_can_start_a_todo_list
[...]
AssertionError: False is not true : New to-do item did not appear in table</pre>
<p>To get it to the server, for now we’ll use a standard HTML POST request.
A little boring, but also nice and easy to deliver—​we
can use all sorts of sexy HTML5 and JavaScript later in the book.</p>
<p>To get our browser to send a POST request, we need to do two things:</p>
<ol>
<li>
<p>Give the <code>&lt;input&gt;</code> element a <code>name=</code> attribute.</p>
</li>
<li>
<p>Wrap it in a <code>&lt;form&gt;</code> tag<sup><a data-type="noteref" href="ch05.xhtml#id287" id="id287-marker">2</a></sup>
with <code>method="POST"</code>.</p>
</li>
</ol>
<p>Let’s adjust our template at <em>lists/templates/home.xhtml</em>:</p>
<div class="sourcecode" data-type="example">
<p>lists/templates/home.xhtml (ch05l001)</p>
<pre data-code-language="html" data-type="programlisting">    <code class="p">&lt;</code><code class="nt">h1</code><code class="p">&gt;</code>Your To-Do list<code class="p">&lt;/</code><code class="nt">h1</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">form</code> <code class="na">method</code><code class="o">=</code><code class="s">"POST"</code><code class="p">&gt;</code>
      <code class="p">&lt;</code><code class="nt">input</code> <code class="na">name</code><code class="o">=</code><code class="s">"item_text"</code> <code class="na">id</code><code class="o">=</code><code class="s">"id_new_item"</code> <code class="na">placeholder</code><code class="o">=</code><code class="s">"Enter a to-do item"</code> <code class="p">/&gt;</code>
    <code class="p">&lt;/</code><code class="nt">form</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">table</code> <code class="na">id</code><code class="o">=</code><code class="s">"id_list_table"</code><code class="p">&gt;</code></pre></div>
<p>Now, running our FTs gives us a slightly cryptic, unexpected error:</p>
<pre data-type="programlisting">$ <strong>python functional_tests.py</strong>
[...]
Traceback (most recent call last):
  File "...goat-book/functional_tests.py", line 38, in
test_can_start_a_todo_list
    table = self.browser.find_element(By.ID, "id_list_table")
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: [id="id_list_table"]</pre>
<p>Oh dear, we’re now failing two lines <em>earlier</em>,
after we submit the form, but before we are able to do the assert.
Selenium seems to be unable to find our list table.
Why on Earth would that happen?
Let’s take another look at our code:</p>
<div class="sourcecode currentcontents" data-type="example">
<p>functional_tests.py</p>
<pre data-code-language="python" data-type="programlisting"><code>        </code><code class="c1"># When she hits enter, the page updates, and now the page lists</code><code>
</code><code>        </code><code class="c1"># "1: Buy peacock feathers" as an item in a to-do list table</code><code>
</code><code>        </code><code class="n">inputbox</code><code class="o">.</code><code class="n">send_keys</code><code class="p">(</code><code class="n">Keys</code><code class="o">.</code><code class="n">ENTER</code><code class="p">)</code><code>
</code><code>        </code><code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code>
</code><code>
</code><code>        </code><code class="n">table</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code class="o">.</code><code class="n">find_element</code><code class="p">(</code><code class="n">By</code><code class="o">.</code><code class="n">ID</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">id_list_table</code><code class="s2">"</code><code class="p">)</code><code>  </code><a class="co" href="#callout_saving_user_input__testing_the_database_CO1-1" id="co_saving_user_input__testing_the_database_CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code>        </code><code class="n">rows</code><code> </code><code class="o">=</code><code> </code><code class="n">table</code><code class="o">.</code><code class="n">find_elements</code><code class="p">(</code><code class="n">By</code><code class="o">.</code><code class="n">TAG_NAME</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">tr</code><code class="s2">"</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">assertTrue</code><code class="p">(</code><code>
</code><code>            </code><code class="nb">any</code><code class="p">(</code><code class="n">row</code><code class="o">.</code><code class="n">text</code><code> </code><code class="o">==</code><code> </code><code class="s2">"</code><code class="s2">1: Buy peacock feathers</code><code class="s2">"</code><code> </code><code class="k">for</code><code> </code><code class="n">row</code><code> </code><code class="ow">in</code><code> </code><code class="n">rows</code><code class="p">)</code><code class="p">,</code><code>
</code><code>            </code><code class="s2">"</code><code class="s2">New to-do item did not appear in table</code><code class="s2">"</code><code class="p">,</code><code>
</code><code>        </code><code class="p">)</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" href="#co_saving_user_input__testing_the_database_CO1-1" id="callout_saving_user_input__testing_the_database_CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Our test unexpectedly fails on this line.
How do we figure out what’s going on?</p></dd>
</dl>
</div></section>
<section data-pdf-bookmark="Debugging functional tests" data-type="sect1"><div class="sect1" id="id31">
<h1>Debugging functional tests</h1>
<p><a data-primary="functional tests (FTs)" data-secondary="debugging techniques" data-type="indexterm" id="id288"/>
<a data-primary="time.sleeps" data-type="indexterm" id="id289"/>
<a data-primary="error messages" data-seealso="troubleshooting" data-type="indexterm" id="id290"/>
<a data-primary="print statements" data-type="indexterm" id="id291"/>
<a data-primary="debugging" data-secondary="of functional tests" data-type="indexterm" id="id292"/>
When a functional test fails with an unexpected failure, there are several
things we can do to debug it:</p>
<ul>
<li>
<p>Add <code>print</code> statements, to show, for example, what the current page text is.</p>
</li>
<li>
<p>Improve the <em>error message</em> to show more info about the current state.</p>
</li>
<li>
<p>Manually visit the site yourself.</p>
</li>
<li>
<p>Use <code>time.sleep</code> to pause the test during execution so you can inspect what was happening.<sup><a data-type="noteref" href="ch05.xhtml#id293" id="id293-marker">3</a></sup></p>
</li>
</ul>
<p>We’ll look at all of these over the course of this book,
but the <code>time.sleep</code> option is the one that leaps to mind with this kind of error in an FT.
Let’s try it now.</p>
<p>Conveniently, we’ve already got a sleep just before the error occurs;
let’s just extend it a little:</p>
<div class="sourcecode" data-type="example">
<p>functional_tests.py (ch05l003)</p>
<pre data-code-language="python" data-type="programlisting">    <code class="c1"># When she hits enter, the page updates, and now the page lists</code>
    <code class="c1"># "1: Buy peacock feathers" as an item in a to-do list table</code>
    <code class="n">inputbox</code><code class="o">.</code><code class="n">send_keys</code><code class="p">(</code><code class="n">Keys</code><code class="o">.</code><code class="n">ENTER</code><code class="p">)</code>
    <code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mi">10</code><code class="p">)</code>

    <code class="n">table</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code class="o">.</code><code class="n">find_element</code><code class="p">(</code><code class="n">By</code><code class="o">.</code><code class="n">ID</code><code class="p">,</code> <code class="s2">"id_list_table"</code><code class="p">)</code></pre></div>
<p><a data-primary="debugging" data-secondary="Django DEBUG page" data-type="indexterm" id="id294"/>
Depending on how fast Selenium runs on your PC,
you may have caught a glimpse of this already,
but when we run the functional tests again,
we’ve got time to see what’s going on:
you should see a page that looks like
<a data-type="xref" href="#csrf_error_screenshot">Figure 5-1</a>, with lots of Django debug information.</p>
<figure><div class="figure" id="csrf_error_screenshot">
<img alt="Django DEBUG page showing CSRF error" height="626" src="assets/twp2_0501.png" width="904"/>
<h6><span class="label">Figure 5-1. </span>Django DEBUG page showing CSRF error</h6>
</div></figure>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id295">
<h1>Security: Surprisingly Fun!</h1>
<p><a data-primary="Cross-Site Request Forgery (CSRF)" data-type="indexterm" id="id296"/>
<a data-primary="security issues and settings" data-secondary="Cross-Site Request Forgery" data-type="indexterm" id="id297"/>
If you’ve never heard of a <em>Cross-Site Request Forgery</em> exploit, why not look it up now?
Like all security exploits, it’s entertaining to read about,
being an ingenious use of a system in unexpected ways.</p>
<p>When I went to university to get my Computer Science degree,
I signed up for the Security module out of a sense of duty:
<em>Oh well, it’ll probably be very dry and boring,
but I suppose I’d better take it.
Eat your vegetables, and so forth</em>.
It turned out to be one of the most fascinating modules of the whole course!
Absolutely full of the joy of hacking, of the particular mindset it takes
to think about how systems can be used in unintended ways.</p>
<p>I want to recommend the textbook from that course,
Ross Anderson’s <a href="https://www.cl.cam.ac.uk/~rja14/book.xhtml"> Security Engineering_</a>.
It’s quite light on pure crypto,
but it’s absolutely full of interesting discussions of unexpected topics like lock picking,
forging bank notes, inkjet printer cartridge 
<span class="keep-together">economics</span>,
and spoofing South African Air Force jets with replay attacks.
It’s a huge tome, about three inches thick,
and I promise you it’s an absolute page-turner.</p>
</div></aside>
<p><a data-primary="templates" data-secondary="tags" data-tertiary="{% csrf_token %}" data-type="indexterm" id="id298"/>
<a data-primary="{% csrf_token %}" data-type="indexterm" id="id299"/>
Django’s CSRF protection involves placing a little auto-generated unique token into each generated form,
to be able to verify that POST requests have definitely come from the form generated by the server.
So far our template has been pure HTML,
and in this step we make the first use of Django’s template magic.
To add the CSRF token we use a <em>template tag</em>,
which has the curly-bracket/percent syntax,
<code>{% ... %}</code>—famous for being the world’s most annoying two-key touch-typing
combination:</p>
<div class="sourcecode" data-type="example">
<p>lists/templates/home.xhtml (ch05l004)</p>
<pre data-code-language="html" data-type="programlisting">  <code class="p">&lt;</code><code class="nt">form</code> <code class="na">method</code><code class="o">=</code><code class="s">"POST"</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">input</code> <code class="na">name</code><code class="o">=</code><code class="s">"item_text"</code> <code class="na">id</code><code class="o">=</code><code class="s">"id_new_item"</code> <code class="na">placeholder</code><code class="o">=</code><code class="s">"Enter a to-do item"</code> <code class="p">/&gt;</code>
    {% csrf_token %}
  <code class="p">&lt;/</code><code class="nt">form</code><code class="p">&gt;</code></pre></div>
<p>Django will substitute the template tag during rendering with an <code>&lt;input type="hidden"&gt;</code>
containing the CSRF token.
Rerunning the functional test will now bring us back to our previous (expected) failure:</p>
<pre data-type="programlisting">  File "...goat-book/functional_tests.py", line 40, in
test_can_start_a_todo_list
[...]
AssertionError: False is not true : New to-do item did not appear in table</pre>
<p>Since our long <code>time.sleep</code> is still there, the test will pause on the final
screen, showing us that the new item text disappears after the form is
submitted, and the page refreshes to show an empty form again.  That’s because
we haven’t wired up our server to deal with the POST request yet—​it just
ignores it and displays the normal home page.</p>
<p><a data-primary="" data-startref="DBIpostcreate05" data-type="indexterm" id="id300"/><a data-primary="" data-startref="POSTcreate05" data-type="indexterm" id="id301"/>We
can put our normal short <code>time.sleep</code> back now though:</p>
<div class="sourcecode" data-type="example">
<p>functional_tests.py (ch05l005)</p>
<pre data-code-language="python" data-type="programlisting">    <code class="c1"># "1: Buy peacock feathers" as an item in a to-do list table</code>
    <code class="n">inputbox</code><code class="o">.</code><code class="n">send_keys</code><code class="p">(</code><code class="n">Keys</code><code class="o">.</code><code class="n">ENTER</code><code class="p">)</code>
    <code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>

    <code class="n">table</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code class="o">.</code><code class="n">find_element</code><code class="p">(</code><code class="n">By</code><code class="o">.</code><code class="n">ID</code><code class="p">,</code> <code class="s2">"id_list_table"</code><code class="p">)</code></pre></div>
</div></section>
<section data-pdf-bookmark="Processing a POST Request on the Server" data-type="sect1"><div class="sect1" id="id77">
<h1>Processing a POST Request on the Server</h1>
<p><a data-primary="database testing" data-secondary="HTML POST requests" data-tertiary="processing" data-type="indexterm" id="id302"/>
<a data-primary="POST requests" data-secondary="processing" data-type="indexterm" id="id303"/>
<a data-primary="HTML" data-secondary="POST requests" data-tertiary="processing" data-type="indexterm" id="id304"/>
Because we haven’t specified an <code>action=</code> attribute in the form,
it is submitting back to the same URL it was rendered from by default (i.e., <code>/</code>),
which is dealt with by our <code>home_page</code> function.
That’s fine for now, let’s adapt the view to be able to deal with a POST request.</p>
<p>That means a new unit test for the <code>home_page</code> view.
Open up <em>lists/tests.py</em>, and add a new method to <code>HomePageTest</code>:</p>
<div class="sourcecode" data-type="example">
<p>lists/tests.py (ch05l006)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">class</code> <code class="nc">HomePageTest</code><code class="p">(</code><code class="n">TestCase</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf">test_uses_home_template</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="n">response</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">client</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/"</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertTemplateUsed</code><code class="p">(</code><code class="n">response</code><code class="p">,</code> <code class="s2">"home.xhtml"</code><code class="p">)</code>

    <code class="k">def</code> <code class="nf">test_can_save_a_POST_request</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="n">response</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">client</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"/"</code><code class="p">,</code> <code class="n">data</code><code class="o">=</code><code class="p">{</code><code class="s2">"item_text"</code><code class="p">:</code> <code class="s2">"A new list item"</code><code class="p">})</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertContains</code><code class="p">(</code><code class="n">response</code><code class="p">,</code> <code class="s2">"A new list item"</code><code class="p">)</code></pre></div>
<p>To do a POST, we call <code>self.client.post</code>, and as you can see it takes
a <code>data</code> argument which contains the form data we want to send.
Then we check that the text from our POST request ends up in the rendered HTML.
That gives us our expected fail:</p>
<pre data-type="programlisting">$ <strong>python manage.py test</strong>
[...]
AssertionError: False is not true : Couldn't find 'A new list item' in response</pre>
<p>In (slightly exaggerated) TDD style,
we can single-mindedly do “the simplest thing that could possibly work”
to address this test failure, which is to add an <code>if</code> and a new code path for POST requests,
with a deliberately silly return value:</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch05l007)</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">django.http</code> <code class="kn">import</code> <code class="n">HttpResponse</code>
<code class="kn">from</code> <code class="nn">django.shortcuts</code> <code class="kn">import</code> <code class="n">render</code>


<code class="k">def</code> <code class="nf">home_page</code><code class="p">(</code><code class="n">request</code><code class="p">):</code>
    <code class="k">if</code> <code class="n">request</code><code class="o">.</code><code class="n">method</code> <code class="o">==</code> <code class="s2">"POST"</code><code class="p">:</code>
        <code class="k">return</code> <code class="n">HttpResponse</code><code class="p">(</code><code class="s2">"You submitted: "</code> <code class="o">+</code> <code class="n">request</code><code class="o">.</code><code class="n">POST</code><code class="p">[</code><code class="s2">"item_text"</code><code class="p">])</code>
    <code class="k">return</code> <code class="n">render</code><code class="p">(</code><code class="n">request</code><code class="p">,</code> <code class="s2">"home.xhtml"</code><code class="p">)</code></pre></div>
<p>OK that gets our unit tests passing, but it’s not really what we want.<sup><a data-type="noteref" href="ch05.xhtml#id305" id="id305-marker">4</a></sup></p>
<p>What we really want to do is add the POST submission
to the todo items table in the home page template.</p>
</div></section>
<section data-pdf-bookmark="Passing Python Variables to Be Rendered in the Template" data-type="sect1"><div class="sect1" id="id78">
<h1>Passing Python Variables to Be Rendered in the Template</h1>
<p><a data-primary="database testing" data-secondary="template syntax" data-type="indexterm" id="DTtemplate05"/>
<a data-primary="templates" data-secondary="syntax" data-type="indexterm" id="id306"/>
<a data-primary="templates" data-secondary="passing variables to" data-type="indexterm" id="id307"/></p>
<p>We’ve already had a hint of it,
and now it’s time to start to get to know the real power of the Django template syntax,
which is to pass variables from our Python view code into HTML templates.</p>
<p>Let’s start by seeing how the template syntax lets us include a Python object in our template.
The notation is <code>{{ ... }}</code>, which displays the object as a string:</p>
<div class="sourcecode small-code" data-type="example">
<p>lists/templates/home.xhtml (ch05l008)</p>
<pre data-code-language="html" data-type="programlisting"><code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code><code>
  </code><code class="p">&lt;</code><code class="nt">h1</code><code class="p">&gt;</code><code>Your To-Do list</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">h1</code><code class="p">&gt;</code><code>
  </code><code class="p">&lt;</code><code class="nt">form</code><code> </code><code class="na">method</code><code class="o">=</code><code class="s">"POST"</code><code class="p">&gt;</code><code>
    </code><code class="p">&lt;</code><code class="nt">input</code><code> </code><code class="na">name</code><code class="o">=</code><code class="s">"item_text"</code><code> </code><code class="na">id</code><code class="o">=</code><code class="s">"id_new_item"</code><code> </code><code class="na">placeholder</code><code class="o">=</code><code class="s">"Enter a to-do item"</code><code> </code><code class="p">/</code><code class="p">&gt;</code><code>
    {% csrf_token %}
  </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">form</code><code class="p">&gt;</code><code>
  </code><code class="p">&lt;</code><code class="nt">table</code><code> </code><code class="na">id</code><code class="o">=</code><code class="s">"id_list_table"</code><code class="p">&gt;</code><code>
    </code><code class="p">&lt;</code><code class="nt">tr</code><code class="p">&gt;</code><code class="p">&lt;</code><code class="nt">td</code><code class="p">&gt;</code><code>{{ new_item_text }}</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">td</code><code class="p">&gt;</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">tr</code><code class="p">&gt;</code><code>  </code><a class="co" href="#callout_saving_user_input__testing_the_database_CO2-1" id="co_saving_user_input__testing_the_database_CO2-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
  </code><code class="p">&lt;</code><code class="p">/</code><code class="nt">table</code><code class="p">&gt;</code><code>
</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">body</code><code class="p">&gt;</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" href="#co_saving_user_input__testing_the_database_CO2-1" id="callout_saving_user_input__testing_the_database_CO2-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Here’s our template variable.
<code>new_item_text</code> will be the variable name for the user input we display in the template.</p></dd>
</dl>
<p>Let’s adjust our unit test so that it checks whether we are still using the template:</p>
<div class="sourcecode" data-type="example">
<p>lists/tests.py (ch05l009)</p>
<pre data-code-language="python" data-type="programlisting">    <code class="k">def</code> <code class="nf">test_can_save_a_POST_request</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="n">response</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">client</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"/"</code><code class="p">,</code> <code class="n">data</code><code class="o">=</code><code class="p">{</code><code class="s2">"item_text"</code><code class="p">:</code> <code class="s2">"A new list item"</code><code class="p">})</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertContains</code><code class="p">(</code><code class="n">response</code><code class="p">,</code> <code class="s2">"A new list item"</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertTemplateUsed</code><code class="p">(</code><code class="n">response</code><code class="p">,</code> <code class="s2">"home.xhtml"</code><code class="p">)</code></pre></div>
<p>And that will fail as expected:</p>
<pre data-type="programlisting">AssertionError: No templates used to render the response</pre>
<p>Good, our deliberately silly return value is now no longer fooling our tests,
so we are allowed to rewrite our view, and tell it to pass the POST parameter to the template.
The <code>render</code> function takes, as its third argument, a dictionary
which maps template variable names to their values.</p>
<p>In theory we can use it for the POST case as well as the default GET case,
so let’s remove the <code>if request.method == "POST"</code> and simplify our view right down to:</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch05l010)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">home_page</code><code class="p">(</code><code class="n">request</code><code class="p">):</code>
    <code class="k">return</code> <code class="n">render</code><code class="p">(</code>
        <code class="n">request</code><code class="p">,</code>
        <code class="s2">"home.xhtml"</code><code class="p">,</code>
        <code class="p">{</code><code class="s2">"new_item_text"</code><code class="p">:</code> <code class="n">request</code><code class="o">.</code><code class="n">POST</code><code class="p">[</code><code class="s2">"item_text"</code><code class="p">]},</code>
    <code class="p">)</code></pre></div>
<p>What do the tests think?</p>
<pre data-type="programlisting">ERROR: test_uses_home_template
(lists.tests.HomePageTest.test_uses_home_template)

[...]
    {"new_item_text": request.POST["item_text"]},
                      ~~~~~~~~~~~~^^^^^^^^^^^^^
[...]
django.utils.datastructures.MultiValueDictKeyError: 'item_text'</pre>
<section data-pdf-bookmark="An Unexpected Failure" data-type="sect2"><div class="sect2" id="id32">
<h2>An Unexpected Failure</h2>
<p><a data-primary="unexpected failures" data-type="indexterm" id="id308"/>
<a data-primary="Test-Driven Development (TDD)" data-secondary="concepts" data-tertiary="unexpected failures" data-type="indexterm" id="id309"/>
Oops, an <em>unexpected failure</em>.</p>
<p>If you remember the rules for reading tracebacks,
you’ll spot that it’s actually a failure in a <em>different</em> test.
We got the actual test we were working on to pass,
but the unit tests have picked up an unexpected consequence, a regression:
we broke the code path where there is no POST request.</p>
<p>This is the whole point of having tests.
Yes, perhaps we could have predicted this would happen,
but imagine if we’d been having a bad day or weren’t paying attention:
our tests have just saved us from accidentally breaking our application,
and, because we’re using TDD, we found out immediately.
We didn’t have to wait for a QA team,
or switch to a web browser and click through our site manually,
and we can get on with fixing it straight away.
Here’s how:</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch05l011)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">home_page</code><code class="p">(</code><code class="n">request</code><code class="p">):</code>
    <code class="k">return</code> <code class="n">render</code><code class="p">(</code>
        <code class="n">request</code><code class="p">,</code>
        <code class="s2">"home.xhtml"</code><code class="p">,</code>
        <code class="p">{</code><code class="s2">"new_item_text"</code><code class="p">:</code> <code class="n">request</code><code class="o">.</code><code class="n">POST</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"item_text"</code><code class="p">,</code> <code class="s2">""</code><code class="p">)},</code>
    <code class="p">)</code></pre></div>
<p>We use <a href="http://docs.python.org/3/library/stdtypes.xhtml#dict.get"><code>dict.get</code></a> to
supply a default value, for the case where we are doing a normal GET request,
when the POST dictionary is empty.</p>
<p>The unit tests should now pass.  Let’s see what the functional tests say:</p>
<pre data-type="programlisting">AssertionError: False is not true : New to-do item did not appear in table</pre>
<div data-type="tip"><h6>Tip</h6>
<p>If your functional tests show you a different error at this point,
    or at any point in this chapter, complaining about a
    <code>StaleElementReferenceException</code>, you may need to increase the
    <code>time.sleep</code> explicit wait—​try 2 or 3 seconds instead of 1;
    then read on to the next chapter for a more robust solution.</p>
</div>
<p><a data-primary="debugging" data-secondary="improving error messages" data-type="indexterm" id="id310"/>
Hmm, not a wonderfully helpful error.
Let’s use another of our FT debugging techniques: improving the error message.
This is probably the most constructive technique,
because those improved error messages stay around to help debug any future errors:</p>
<div class="sourcecode" data-type="example">
<p>functional_tests.py (ch05l012)</p>
<pre data-code-language="python" data-type="programlisting"><code class="bp">self</code><code class="o">.</code><code class="n">assertTrue</code><code class="p">(</code>
    <code class="nb">any</code><code class="p">(</code><code class="n">row</code><code class="o">.</code><code class="n">text</code> <code class="o">==</code> <code class="s2">"1: Buy peacock feathers"</code> <code class="k">for</code> <code class="n">row</code> <code class="ow">in</code> <code class="n">rows</code><code class="p">),</code>
    <code class="sa">f</code><code class="s2">"New to-do item did not appear in table. Contents were:</code><code class="se">\n</code><code class="si">{</code><code class="n">table</code><code class="o">.</code><code class="n">text</code><code class="si">}</code><code class="s2">"</code><code class="p">,</code>
<code class="p">)</code></pre></div>
<p>That gives us a more helpful error message:</p>
<pre data-type="programlisting">AssertionError: False is not true : New to-do item did not appear in table.
Contents were:
Buy peacock feathers</pre>
<p>Actually, you know what would be even better?
Making that assertion a bit less clever!
As you may remember from <a data-type="xref" href="ch04.xhtml#chapter_philosophy_and_refactoring">Chapter 4</a>,
I was very pleased with myself for using the <code>any()</code> function,
but one of my Early Release readers (thanks, Jason!) suggested a much simpler implementation.
We can replace all four lines of the <code>assertTrue</code> with a single <code>assertIn</code>:</p>
<div class="sourcecode" data-type="example">
<p>functional_tests.py (ch05l013)</p>
<pre data-code-language="python" data-type="programlisting">    <code class="bp">self</code><code class="o">.</code><code class="n">assertIn</code><code class="p">(</code><code class="s2">"1: Buy peacock feathers"</code><code class="p">,</code> <code class="p">[</code><code class="n">row</code><code class="o">.</code><code class="n">text</code> <code class="k">for</code> <code class="n">row</code> <code class="ow">in</code> <code class="n">rows</code><code class="p">])</code></pre></div>
<p>Much better.
You should always be very worried whenever you think you’re being clever,
because what you’re probably being is <em>overcomplicated</em>.</p>
<p>Now we get the error message for free:</p>
<pre data-type="programlisting">    self.assertIn("1: Buy peacock feathers", [row.text for row in rows])
AssertionError: '1: Buy peacock feathers' not found in ['Buy peacock feathers']</pre>
<p>Consider me suitably chastened.</p>
<div data-type="tip"><h6>Tip</h6>
<p>If, instead, your FT seems to be saying the table is empty (“not found in
    ['']”), check your <code>&lt;input&gt;</code> tag—​does it have the correct
    <code>name="item_text"</code> attribute?  And does it have <code>method="POST"</code>?  Without
    them, the user’s input won’t be in the right place in <code>request.POST</code>.</p>
</div>
<p>The point is that the FT wants us to enumerate list items with a “1:” at the
beginning of the first list item.</p>
<p>The fastest way to get that to pass is with another quick “cheating” change to the template:</p>
<div class="sourcecode" data-type="example">
<p>lists/templates/home.xhtml (ch05l014)</p>
<pre data-code-language="html" data-type="programlisting">    <code class="p">&lt;</code><code class="nt">tr</code><code class="p">&gt;&lt;</code><code class="nt">td</code><code class="p">&gt;</code>1: {{ new_item_text }}<code class="p">&lt;/</code><code class="nt">td</code><code class="p">&gt;&lt;/</code><code class="nt">tr</code><code class="p">&gt;</code></pre></div>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id311">
<h1>When Should You Stop Cheating? Don’t Repeat Yourself (DRY) vs Triangulation</h1>
<p><a data-primary="Test-Driven Development (TDD)" data-secondary="concepts" data-tertiary="triangulation" data-type="indexterm" id="id312"/>
<a data-primary="triangulation" data-type="indexterm" id="id313"/>
<a data-primary="Don’t Repeat Yourself (DRY)" data-type="indexterm" id="id314"/>
<a data-primary="Test-Driven Development (TDD)" data-secondary="concepts" data-tertiary="DRY" data-type="indexterm" id="id315"/>
<a data-primary="duplication, eliminating" data-type="indexterm" id="id316"/></p>
<p>People often ask about when it’s OK to “stop cheating”,
and change from an implementation we know to be wrong,
to one we’re happy with.</p>
<p>One justification is <em>eliminate duplication</em> aka <em>Don’t Repeat Yourself</em> (DRY),
which (with some caveats) is a good guideline for any kind of code.</p>
<p>If your test uses a magic constant (like the “1:” in front of our list item),
and your application code also uses it,
some people say <em>that</em> counts as duplication, so it justifies refactoring.
Removing the magic constant from the application code usually means you have to stop cheating.</p>
<p>It’s a judgment call,
but I feel that this is stretching the definition of “repetition” a little,
so I often like to use a second technique, which is called <em>triangulation</em>:
if your tests let you get away with writing “cheating” code that you’re not happy with
(like returning a magic constant),
then <em>write another test</em> that forces you to write some better code.
That’s what we’re doing when we extend the FT
to check that we get a “2:” when inputting a <em>second</em> list item.</p>
<p>See also <a data-type="xref" href="#three_strikes_and_refactor">“Three Strikes and Refactor”</a> for a further note of caution
on applying DRY too quickly.</p>
</div></aside>
<p>Now we get to the <code>self.fail('Finish the test!')</code>.
If get rid of that and finish writing our FT,
to add the check for adding a second item to the table
(copy and paste is our friend),
we begin to see that our first cut solution really isn’t going to, um, cut it:</p>
<div class="sourcecode" data-type="example">
<p>functional_tests.py (ch05l015)</p>
<pre data-code-language="python" data-type="programlisting">    <code class="c1"># There is still a text box inviting her to add another item.</code>
    <code class="c1"># She enters "Use peacock feathers to make a fly"</code>
    <code class="c1"># (Edith is very methodical)</code>
    <code class="n">inputbox</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code class="o">.</code><code class="n">find_element</code><code class="p">(</code><code class="n">By</code><code class="o">.</code><code class="n">ID</code><code class="p">,</code> <code class="s2">"id_new_item"</code><code class="p">)</code>
    <code class="n">inputbox</code><code class="o">.</code><code class="n">send_keys</code><code class="p">(</code><code class="s2">"Use peacock feathers to make a fly"</code><code class="p">)</code>
    <code class="n">inputbox</code><code class="o">.</code><code class="n">send_keys</code><code class="p">(</code><code class="n">Keys</code><code class="o">.</code><code class="n">ENTER</code><code class="p">)</code>
    <code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>

    <code class="c1"># The page updates again, and now shows both items on her list</code>
    <code class="n">table</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code class="o">.</code><code class="n">find_element</code><code class="p">(</code><code class="n">By</code><code class="o">.</code><code class="n">ID</code><code class="p">,</code> <code class="s2">"id_list_table"</code><code class="p">)</code>
    <code class="n">rows</code> <code class="o">=</code> <code class="n">table</code><code class="o">.</code><code class="n">find_elements</code><code class="p">(</code><code class="n">By</code><code class="o">.</code><code class="n">TAG_NAME</code><code class="p">,</code> <code class="s2">"tr"</code><code class="p">)</code>
    <code class="bp">self</code><code class="o">.</code><code class="n">assertIn</code><code class="p">(</code>
        <code class="s2">"1: Buy peacock feathers"</code><code class="p">,</code>
        <code class="p">[</code><code class="n">row</code><code class="o">.</code><code class="n">text</code> <code class="k">for</code> <code class="n">row</code> <code class="ow">in</code> <code class="n">rows</code><code class="p">],</code>
    <code class="p">)</code>
    <code class="bp">self</code><code class="o">.</code><code class="n">assertIn</code><code class="p">(</code>
        <code class="s2">"2: Use peacock feathers to make a fly"</code><code class="p">,</code>
        <code class="p">[</code><code class="n">row</code><code class="o">.</code><code class="n">text</code> <code class="k">for</code> <code class="n">row</code> <code class="ow">in</code> <code class="n">rows</code><code class="p">],</code>
    <code class="p">)</code>

    <code class="c1"># Satisfied, she goes back to sleep</code></pre></div>
<p><a data-primary="" data-startref="DTtemplate05" data-type="indexterm" id="id317"/>
Sure enough, the functional tests return an error:</p>
<pre data-type="programlisting">AssertionError: '1: Buy peacock feathers' not found in ['1: Use peacock
feathers to make a fly']</pre>
</div></section>
</div></section>
<section data-pdf-bookmark="Three Strikes and Refactor" data-type="sect1"><div class="sect1" id="three_strikes_and_refactor">
<h1>Three Strikes and Refactor</h1>
<p><a data-primary="code smell" data-type="indexterm" id="id318"/>
<a data-primary="three strikes and refactor rule" data-type="indexterm" id="threestrikes05"/>
<a data-primary="refactoring" data-type="indexterm" id="refactor05"/>
But before we go further—​we’ve got a bad <em>code smell</em><sup><a data-type="noteref" href="ch05.xhtml#id319" id="id319-marker">5</a></sup>
in this FT.
We have three almost identical code blocks checking for new items in the list table.
<a data-primary="Don’t Repeat Yourself (DRY)" data-type="indexterm" id="id320"/>
When we want to apply the DRY principle,
I like to follow the mantra <em>three strikes and refactor</em>.
You can copy and paste code once,
and it may be premature to try to remove the duplication it causes,
but once you get three occurrences, it’s time to tidy up.</p>
<p>Let’s start by committing what we have so far. Even though we know our site
has a major flaw—​it can only handle one list item—​it’s still further ahead than it was.
We may have to rewrite it all, and we may not, but the rule
is that before you do any refactoring, always do a commit:</p>
<pre data-type="programlisting">$ <strong>git diff</strong>
# should show changes to functional_tests.py, home.xhtml,
# tests.py and views.py
$ <strong>git commit -a</strong></pre>
<div data-type="tip"><h6>Tip</h6>
<p>Always do a commit before embarking on a refactor.</p>
</div>
<p>Onto our functional test refactor: let’s use a helper method—​remember,
only methods that begin with <code>test_</code> will get run as tests,
so you can use other methods for your own purposes:</p>
<div class="sourcecode" data-type="example">
<p>functional_tests.py (ch05l016)</p>
<pre data-code-language="python" data-type="programlisting">    <code class="k">def</code> <code class="nf">tearDown</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code class="o">.</code><code class="n">quit</code><code class="p">()</code>

    <code class="k">def</code> <code class="nf">check_for_row_in_list_table</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">row_text</code><code class="p">):</code>
        <code class="n">table</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code class="o">.</code><code class="n">find_element</code><code class="p">(</code><code class="n">By</code><code class="o">.</code><code class="n">ID</code><code class="p">,</code> <code class="s2">"id_list_table"</code><code class="p">)</code>
        <code class="n">rows</code> <code class="o">=</code> <code class="n">table</code><code class="o">.</code><code class="n">find_elements</code><code class="p">(</code><code class="n">By</code><code class="o">.</code><code class="n">TAG_NAME</code><code class="p">,</code> <code class="s2">"tr"</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertIn</code><code class="p">(</code><code class="n">row_text</code><code class="p">,</code> <code class="p">[</code><code class="n">row</code><code class="o">.</code><code class="n">text</code> <code class="k">for</code> <code class="n">row</code> <code class="ow">in</code> <code class="n">rows</code><code class="p">])</code>

    <code class="k">def</code> <code class="nf">test_can_start_a_todo_list</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="p">[</code><code class="o">...</code><code class="p">]</code></pre></div>
<p>I like to put helper methods near the top of the class, between the <code>tearDown</code>
and the first test. Let’s use it in the FT:</p>
<div class="sourcecode" data-type="example">
<p>functional_tests.py (ch05l017)</p>
<pre data-code-language="python" data-type="programlisting">    <code class="c1"># When she hits enter, the page updates, and now the page lists</code>
    <code class="c1"># "1: Buy peacock feathers" as an item in a to-do list table</code>
    <code class="n">inputbox</code><code class="o">.</code><code class="n">send_keys</code><code class="p">(</code><code class="n">Keys</code><code class="o">.</code><code class="n">ENTER</code><code class="p">)</code>
    <code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
    <code class="bp">self</code><code class="o">.</code><code class="n">check_for_row_in_list_table</code><code class="p">(</code><code class="s2">"1: Buy peacock feathers"</code><code class="p">)</code>

    <code class="c1"># There is still a text box inviting her to add another item.</code>
    <code class="c1"># She enters "Use peacock feathers to make a fly"</code>
    <code class="c1"># (Edith is very methodical)</code>
    <code class="n">inputbox</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code class="o">.</code><code class="n">find_element</code><code class="p">(</code><code class="n">By</code><code class="o">.</code><code class="n">ID</code><code class="p">,</code> <code class="s2">"id_new_item"</code><code class="p">)</code>
    <code class="n">inputbox</code><code class="o">.</code><code class="n">send_keys</code><code class="p">(</code><code class="s2">"Use peacock feathers to make a fly"</code><code class="p">)</code>
    <code class="n">inputbox</code><code class="o">.</code><code class="n">send_keys</code><code class="p">(</code><code class="n">Keys</code><code class="o">.</code><code class="n">ENTER</code><code class="p">)</code>
    <code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>

    <code class="c1"># The page updates again, and now shows both items on her list</code>
    <code class="bp">self</code><code class="o">.</code><code class="n">check_for_row_in_list_table</code><code class="p">(</code><code class="s2">"1: Buy peacock feathers"</code><code class="p">)</code>
    <code class="bp">self</code><code class="o">.</code><code class="n">check_for_row_in_list_table</code><code class="p">(</code><code class="s2">"2: Use peacock feathers to make a fly"</code><code class="p">)</code>

    <code class="c1"># Satisfied, she goes back to sleep</code></pre></div>
<p>We run the FT again to check that it still behaves in the same way…​</p>
<pre data-type="programlisting">AssertionError: '1: Buy peacock feathers' not found in ['1: Use peacock
feathers to make a fly']</pre>
<p>Good. Now we can commit the FT refactor as its own small, atomic change:</p>
<pre data-type="programlisting">$ <strong>git diff</strong> # check the changes to functional_tests.py
$ <strong>git commit -a</strong></pre>
<p>And back to work.  If we’re ever going to handle more than one list item,
we’re going to need some kind of persistence, and databases are a stalwart
solution in this area.
<a data-primary="" data-startref="threestrikes05" data-type="indexterm" id="id321"/>
<a data-primary="" data-startref="refactor05" data-type="indexterm" id="id322"/></p>
</div></section>
<section data-pdf-bookmark="The Django ORM and Our First Model" data-type="sect1"><div class="sect1" id="id34">
<h1>The Django ORM and Our First Model</h1>
<p><a data-primary="Object-Relational Mapper (ORM)" data-type="indexterm" id="orm05"/>
<a data-primary="Django framework" data-secondary="Object-Relational Mapper (ORM)" data-type="indexterm" id="DJForm05"/>
<a data-primary="database testing" data-secondary="Object-Relational Mapper (ORM)" data-type="indexterm" id="DBTorm05"/>
An <em>Object-Relational Mapper</em> (ORM) is a layer of abstraction for data stored in a database
with tables, rows, and columns.
It lets us work with databases using familiar object-oriented metaphors which work well with code.
Classes map to database tables, attributes map to columns,
and an individual instance of the class represents a row of data in the database.</p>
<p>Django comes with an excellent ORM,
and writing a unit test that uses it is actually an excellent way of learning it,
since it exercises code by specifying how we want it to work.</p>
<p>Let’s create a new class in <em>lists/tests.py</em>:</p>
<div class="sourcecode" data-type="example">
<p>lists/tests.py (ch05l018)</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">django.test</code> <code class="kn">import</code> <code class="n">TestCase</code>
<code class="kn">from</code> <code class="nn">lists.models</code> <code class="kn">import</code> <code class="n">Item</code>


<code class="k">class</code> <code class="nc">HomePageTest</code><code class="p">(</code><code class="n">TestCase</code><code class="p">):</code>
    <code class="p">[</code><code class="o">...</code><code class="p">]</code>


<code class="k">class</code> <code class="nc">ItemModelTest</code><code class="p">(</code><code class="n">TestCase</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf">test_saving_and_retrieving_items</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="n">first_item</code> <code class="o">=</code> <code class="n">Item</code><code class="p">()</code>
        <code class="n">first_item</code><code class="o">.</code><code class="n">text</code> <code class="o">=</code> <code class="s2">"The first (ever) list item"</code>
        <code class="n">first_item</code><code class="o">.</code><code class="n">save</code><code class="p">()</code>

        <code class="n">second_item</code> <code class="o">=</code> <code class="n">Item</code><code class="p">()</code>
        <code class="n">second_item</code><code class="o">.</code><code class="n">text</code> <code class="o">=</code> <code class="s2">"Item the second"</code>
        <code class="n">second_item</code><code class="o">.</code><code class="n">save</code><code class="p">()</code>

        <code class="n">saved_items</code> <code class="o">=</code> <code class="n">Item</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">all</code><code class="p">()</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertEqual</code><code class="p">(</code><code class="n">saved_items</code><code class="o">.</code><code class="n">count</code><code class="p">(),</code> <code class="mi">2</code><code class="p">)</code>

        <code class="n">first_saved_item</code> <code class="o">=</code> <code class="n">saved_items</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code>
        <code class="n">second_saved_item</code> <code class="o">=</code> <code class="n">saved_items</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertEqual</code><code class="p">(</code><code class="n">first_saved_item</code><code class="o">.</code><code class="n">text</code><code class="p">,</code> <code class="s2">"The first (ever) list item"</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertEqual</code><code class="p">(</code><code class="n">second_saved_item</code><code class="o">.</code><code class="n">text</code><code class="p">,</code> <code class="s2">"Item the second"</code><code class="p">)</code></pre></div>
<p>You can see that creating a new record in the database
is a relatively simple matter of creating an object,
assigning some attributes, and calling a <code>.save()</code> function.
Django also gives us an API for querying the database
via a class attribute, <code>.objects</code>,
and we use the simplest possible query, <code>.all()</code>,
which retrieves all the records for that table.
The results are returned as a list-like object called a <code>QuerySet</code>,
from which we can extract individual objects,
and also call further functions, like <code>.count()</code>.
We then check the objects as saved to the database,
to check whether the right information was saved.</p>
<p><a data-primary="Django framework" data-secondary="tutorials" data-type="indexterm" id="id323"/>
Django’s ORM has many other helpful and intuitive features;
this might be a good time to skim through the
<a href="https://docs.djangoproject.com/en/4.2/intro/tutorial01/">Django tutorial</a>,
which has an excellent intro to them.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>I’ve written this unit test in a very verbose style,
    as a way of introducing the Django ORM.
    I wouldn’t recommend writing your model tests like this “in real life”,
    because it’s testing the framework, rather than testing our own code.
    We’ll actually rewrite this test to be much more concise
    in [Link to Come]
    (specifically, at [Link to Come]).</p>
</div>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id324">
<h1>Unit Tests Versus Integrated/Integration Tests, and the Database</h1>
<p><a data-primary="unit tests" data-secondary="vs. integrated tests" data-secondary-sortas="integrated tests" data-type="indexterm" id="id325"/>
<a data-primary="integrated tests" data-secondary="vs. unit tests" data-secondary-sortas="unit tests" data-type="indexterm" id="id326"/>
Some people will tell you that a “real” unit test should never touch the database,
and that the test I’ve just written should be more properly called an
“integrated” test, or “integration” test,
because it doesn’t only test our code,
but also relies on an external system—​that is, a database.</p>
<p>It’s OK to ignore this distinction for now—​we have two types of test,
the high-level functional tests which test the application from the user’s
point of view, and these lower-level tests which test it from the programmer’s
point of view.</p>
<p>We’ll come back to this topic
and talk about the differences between unit tests, integrated tests, integration tests, and more in [Link to Come],
towards the end of the book.</p>
</div></aside>
<p>Let’s try running the unit test. Here comes another unit-test/code cycle:</p>
<pre data-type="programlisting">ImportError: cannot import name 'Item' from 'lists.models'</pre>
<p>Very well, let’s give it something to import from <em>lists/models.py</em>.  We’re
feeling confident so we’ll skip the <code>Item = None</code> step, and go straight to
creating a class:</p>
<div class="sourcecode" data-type="example" id="first-django-model">
<p>lists/models.py (ch05l019)</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">django.db</code> <code class="kn">import</code> <code class="n">models</code>

<code class="c1"># Create your models here.</code>
<code class="k">class</code> <code class="nc">Item</code><code class="p">:</code>
    <code class="k">pass</code></pre></div>
<p>That gets our test as far as:</p>
<pre data-type="programlisting">[...]
  File "...goat-book/lists/tests.py", line 20, in
test_saving_and_retrieving_items
    first_item.save()
    ^^^^^^^^^^^^^^^
AttributeError: 'Item' object has no attribute 'save'</pre>
<p>To give our <code>Item</code> class a <code>save</code> method, and to make it into a real Django
model, we make it inherit from the <code>Model</code> class:</p>
<div class="sourcecode" data-type="example">
<p>lists/models.py (ch05l020)</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">django.db</code> <code class="kn">import</code> <code class="n">models</code>


<code class="k">class</code> <code class="nc">Item</code><code class="p">(</code><code class="n">models</code><code class="o">.</code><code class="n">Model</code><code class="p">):</code>
    <code class="k">pass</code></pre></div>
<section data-pdf-bookmark="Our First Database Migration" data-type="sect2"><div class="sect2" id="id35">
<h2>Our First Database Migration</h2>
<p><a data-primary="database migrations" data-type="indexterm" id="id327"/>
The next thing that happens is a huuuuge traceback,
the long and short of which is that there’s a problem with the database:</p>
<pre data-type="programlisting">django.db.utils.OperationalError: no such table: lists_item</pre>
<p>In Django, the ORM’s job is to model and read and write from database tables,
but there’s a second system that’s in charge,of actually <em>creating</em>
the tables in the database called “migrations”.
Its job is to let you to add, remove, and modify tables and columns,
based on changes you make to your <em>models.py</em> files.</p>
<p>One way to think of it is as a version control system for your database.
As we’ll see later, it comes in particularly useful
when we need to upgrade a database that’s deployed on a live server.</p>
<p>For now all we need to know is how to build our first database migration,
which we do using the <code>makemigrations</code> command:<sup><a data-type="noteref" href="ch05.xhtml#id328" id="id328-marker">6</a></sup></p>
<pre data-type="programlisting">$ <strong>python manage.py makemigrations</strong>
Migrations for 'lists':
  lists/migrations/0001_initial.py
    - Create model Item
$ <strong>ls lists/migrations</strong>
0001_initial.py  __init__.py  __pycache__</pre>
<p>If you’re curious, you can go and take a look in the migrations file,
and you’ll see it’s a representation of our additions to <em>models.py</em>.</p>
<p>In the meantime, we should find our tests get a little further.</p>
</div></section>
<section data-pdf-bookmark="The Test Gets Surprisingly Far" data-type="sect2"><div class="sect2" id="id139">
<h2>The Test Gets Surprisingly Far</h2>
<p>The test actually gets surprisingly far:</p>
<pre data-type="programlisting">$ <strong>python manage.py test</strong>
[...]
    self.assertEqual(first_saved_item.text, "The first (ever) list item")
                     ^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'Item' object has no attribute 'text'</pre>
<p>That’s a full eight lines later than the last failure—​we’ve
been all the way through saving the two <code>Item</code>s,
and we’ve checked that they’re saved in the database,
but Django just doesn’t seem to have “remembered” the <code>.text</code> attribute.</p>
<p>If you’re new to Python, you might have been surprised
that we were allowed to assign the <code>.text</code> attribute at all.
In a language like Java, you would probably get a compilation error.
Python is more relaxed.</p>
<p>Classes that inherit from <code>models.Model</code> map to tables in the database.
By default they get an auto-generated <code>id</code> attribute,
which will be a primary key column<sup><a data-type="noteref" href="ch05.xhtml#id329" id="id329-marker">7</a></sup>
in the database,
but you have to define any other columns and attributes you want explicitly;
here’s how we set up a text column:</p>
<div class="sourcecode" data-type="example">
<p>lists/models.py (ch05l022)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">class</code> <code class="nc">Item</code><code class="p">(</code><code class="n">models</code><code class="o">.</code><code class="n">Model</code><code class="p">):</code>
    <code class="n">text</code> <code class="o">=</code> <code class="n">models</code><code class="o">.</code><code class="n">TextField</code><code class="p">()</code></pre></div>
<p>Django has many other field types, like <code>IntegerField</code>, <code>CharField</code>,
<code>DateField</code>, and so on.  I’ve chosen <code>TextField</code> rather than <code>CharField</code> because
the latter requires a length restriction, which seems arbitrary at this point.
You can read more on field types in the Django
<a href="https://docs.djangoproject.com/en/4.2/intro/tutorial02/#creating-models">tutorial</a>
and in the
<a href="https://docs.djangoproject.com/en/4.2/ref/models/fields/">documentation</a>.</p>
</div></section>
<section data-pdf-bookmark="A New Field Means a New Migration" data-type="sect2"><div class="sect2" id="id36">
<h2>A New Field Means a New Migration</h2>
<p>Running the tests gives us another database error:</p>
<pre data-type="programlisting">django.db.utils.OperationalError: table lists_item has no column named text</pre>
<p>It’s because we’ve added another new field to our database, which means we need
to create another migration.  Nice of our tests to let us know!</p>
<p>Let’s try it:</p>
<pre data-type="programlisting">$ <strong>python manage.py makemigrations</strong>
It is impossible to add a non-nullable field 'text' to item without specifying
a default. This is because the database needs something to populate existing
rows.
Please select a fix:
 1) Provide a one-off default now (will be set on all existing rows with a null
value for this column)
 2) Quit and manually define a default value in models.py.
Select an option:<strong>2</strong></pre>
<p>Ah.  It won’t let us add the column without a default value.  Let’s pick option
2 and set a default in <em>models.py</em>.  I think you’ll find the syntax reasonably
self-explanatory:</p>
<div class="sourcecode" data-type="example">
<p>lists/models.py (ch05l023)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">class</code> <code class="nc">Item</code><code class="p">(</code><code class="n">models</code><code class="o">.</code><code class="n">Model</code><code class="p">):</code>
    <code class="n">text</code> <code class="o">=</code> <code class="n">models</code><code class="o">.</code><code class="n">TextField</code><code class="p">(</code><code class="n">default</code><code class="o">=</code><code class="s2">""</code><code class="p">)</code></pre></div>
<p>And now the migration should complete:</p>
<pre data-type="programlisting">$ <strong>python manage.py makemigrations</strong>
Migrations for 'lists':
  lists/migrations/0002_item_text.py
    - Add field text to item</pre>
<p>So, two new lines in <em>models.py</em>, two database migrations, and as a result,
the <code>.text</code> attribute on our model objects is now recognised as a special attribute,
so it does get saved to the database, and the tests pass…​</p>
<pre data-type="programlisting">$ <strong>python manage.py test</strong>
[...]

Ran 3 tests in 0.010s
OK</pre>
<p><a data-primary="" data-startref="orm05" data-type="indexterm" id="id330"/>
<a data-primary="" data-startref="DBTorm05" data-type="indexterm" id="id331"/>
<a data-primary="" data-startref="DJForm05" data-type="indexterm" id="id332"/>
So let’s do a commit for our first ever model!</p>
<pre data-type="programlisting">$ <strong>git status</strong> # see tests.py, models.py, and 2 untracked migrations
$ <strong>git diff</strong> # review changes to tests.py and models.py
$ <strong>git add lists</strong>
$ <strong>git commit -m "Model for list Items and associated migration"</strong></pre>
</div></section>
</div></section>
<section data-pdf-bookmark="Saving the POST to the Database" data-type="sect1"><div class="sect1" id="id37">
<h1>Saving the POST to the Database</h1>
<p><a data-primary="database testing" data-secondary="HTML POST requests" data-tertiary="saving" data-type="indexterm" id="DTpostsave05"/>
<a data-primary="HTML" data-secondary="POST requests" data-tertiary="saving" data-type="indexterm" id="HTMLpostsave05"/>
<a data-primary="POST requests" data-secondary="saving" data-type="indexterm" id="POSTsave05"/>
Let’s adjust the test for our home page POST request,
and say we want the view to save a new item to the database
instead of just passing it through to its response.
We can do that by adding three new lines to the existing test called
<code>test_can_save_a_POST_request</code>:</p>
<div class="sourcecode" data-type="example">
<p>lists/tests.py (ch05l025)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code><code> </code><code class="nf">test_can_save_a_POST_request</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">response</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">client</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"</code><code class="s2">/</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">data</code><code class="o">=</code><code class="p">{</code><code class="s2">"</code><code class="s2">item_text</code><code class="s2">"</code><code class="p">:</code><code> </code><code class="s2">"</code><code class="s2">A new list item</code><code class="s2">"</code><code class="p">}</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="bp">self</code><code class="o">.</code><code class="n">assertEqual</code><code class="p">(</code><code class="n">Item</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">count</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">)</code><code>  </code><a class="co" href="#callout_saving_user_input__testing_the_database_CO3-1" id="co_saving_user_input__testing_the_database_CO3-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code>    </code><code class="n">new_item</code><code> </code><code class="o">=</code><code> </code><code class="n">Item</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">first</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_saving_user_input__testing_the_database_CO3-2" id="co_saving_user_input__testing_the_database_CO3-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
</code><code>    </code><code class="bp">self</code><code class="o">.</code><code class="n">assertEqual</code><code class="p">(</code><code class="n">new_item</code><code class="o">.</code><code class="n">text</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">A new list item</code><code class="s2">"</code><code class="p">)</code><code>  </code><a class="co" href="#callout_saving_user_input__testing_the_database_CO3-3" id="co_saving_user_input__testing_the_database_CO3-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code>
</code><code>
</code><code>    </code><code class="bp">self</code><code class="o">.</code><code class="n">assertContains</code><code class="p">(</code><code class="n">response</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">A new list item</code><code class="s2">"</code><code class="p">)</code><code>
</code><code>    </code><code class="bp">self</code><code class="o">.</code><code class="n">assertTemplateUsed</code><code class="p">(</code><code class="n">response</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">home.xhtml</code><code class="s2">"</code><code class="p">)</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" href="#co_saving_user_input__testing_the_database_CO3-1" id="callout_saving_user_input__testing_the_database_CO3-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>We check that one new <code>Item</code> has been saved to the database.
<code>objects.count()</code> is a shorthand for <code>objects.all().count()</code>.</p></dd>
<dt><a class="co" href="#co_saving_user_input__testing_the_database_CO3-2" id="callout_saving_user_input__testing_the_database_CO3-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p><code>objects.first()</code> is the same as doing <code>objects.all()[0]</code>.</p></dd>
<dt><a class="co" href="#co_saving_user_input__testing_the_database_CO3-3" id="callout_saving_user_input__testing_the_database_CO3-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>We check that the item’s text is correct.</p></dd>
</dl>
<p><a data-primary="unit tests" data-secondary="length of" data-type="indexterm" id="id333"/>
This test is getting a little long-winded.
It seems to be testing lots of different things.
That’s another <em>code smell</em>—a
long unit test either needs to be broken into two,
or it may be an indication that the thing you’re testing is too complicated.
Let’s add that to a little to-do list of our own,
perhaps on a piece of scrap paper:</p>
<aside class="scratchpad" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id334">
<h1/>
<ul>
<li>
<p><em>Code smell: POST test is too long?</em></p>
</li>
</ul>
</div></aside>
<p>Writing it down on a scratchpad like this reassures us that we won’t forget,
so we are comfortable getting back to what we were working on.
We rerun the tests and see an expected failure:</p>
<pre data-type="programlisting">    self.assertEqual(Item.objects.count(), 1)
AssertionError: 0 != 1</pre>
<p>Let’s adjust our view:</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch05l026)</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">django.shortcuts</code> <code class="kn">import</code> <code class="n">render</code>
<code class="kn">from</code> <code class="nn">lists.models</code> <code class="kn">import</code> <code class="n">Item</code>


<code class="k">def</code> <code class="nf">home_page</code><code class="p">(</code><code class="n">request</code><code class="p">):</code>
    <code class="n">item</code> <code class="o">=</code> <code class="n">Item</code><code class="p">()</code>
    <code class="n">item</code><code class="o">.</code><code class="n">text</code> <code class="o">=</code> <code class="n">request</code><code class="o">.</code><code class="n">POST</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"item_text"</code><code class="p">,</code> <code class="s2">""</code><code class="p">)</code>
    <code class="n">item</code><code class="o">.</code><code class="n">save</code><code class="p">()</code>

    <code class="k">return</code> <code class="n">render</code><code class="p">(</code>
        <code class="n">request</code><code class="p">,</code>
        <code class="s2">"home.xhtml"</code><code class="p">,</code>
        <code class="p">{</code><code class="s2">"new_item_text"</code><code class="p">:</code> <code class="n">request</code><code class="o">.</code><code class="n">POST</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"item_text"</code><code class="p">,</code> <code class="s2">""</code><code class="p">)},</code>
    <code class="p">)</code></pre></div>
<p>I’ve coded a very naive solution and you can probably spot a very obvious problem,
which is that we’re going to be saving empty items with every request to the home page.
Let’s add that to our list of things to fix later.
You know, along with the painfully obvious fact
that we currently have no way at all of having different lists for different people.
That we’ll keep ignoring for now.</p>
<p>Remember, I’m not saying you should always ignore glaring problems like this in “real life”.
Whenever we spot problems in advance, there’s a judgement call to make
over whether to stop what you’re doing and start again, or leave them until later.
Sometimes finishing off what you’re doing is still worth it,
and sometimes the problem may be so major as to warrant a stop and rethink.</p>
<p>Let’s see how the unit tests get on…​</p>
<pre data-type="programlisting">Ran 3 tests in 0.010s

OK</pre>
<p>They pass!  Good. Let’s have a little look at our scratchpad.
I’ve added a couple of the other things that are on our mind:</p>
<aside class="scratchpad" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id335">
<h1/>
<ul>
<li>
<p><em>Don’t save blank items for every request</em></p>
</li>
<li>
<p><em>Code smell: POST test is too long?</em></p>
</li>
<li>
<p><em>Display multiple items in the table</em></p>
</li>
<li>
<p><em>Support more than one list!</em></p>
</li>
</ul>
</div></aside>
<p>Let’s start with the first scratch pad item:
<em>Don’t save blank items for every request</em>.
We could tack on an assertion to an existing test,
but it’s best to keep unit tests to testing one thing at a time,
so let’s add a new one:</p>
<div class="sourcecode" data-type="example">
<p>lists/tests.py (ch05l027)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">class</code> <code class="nc">HomePageTest</code><code class="p">(</code><code class="n">TestCase</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf">test_uses_home_template</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="p">[</code><code class="o">...</code><code class="p">]</code>

    <code class="k">def</code> <code class="nf">test_can_save_a_POST_request</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="p">[</code><code class="o">...</code><code class="p">]</code>

    <code class="k">def</code> <code class="nf">test_only_saves_items_when_necessary</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">client</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/"</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertEqual</code><code class="p">(</code><code class="n">Item</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">count</code><code class="p">(),</code> <code class="mi">0</code><code class="p">)</code></pre></div>
<p>That gives us a <code>1 != 0</code> failure.  Let’s fix it by bringing the
<code>if request.method</code> check back and putting the Item creation in there:</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch05l028)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">home_page</code><code class="p">(</code><code class="n">request</code><code class="p">):</code>
    <code class="k">if</code> <code class="n">request</code><code class="o">.</code><code class="n">method</code> <code class="o">==</code> <code class="s2">"POST"</code><code class="p">:</code>
        <code class="n">item</code> <code class="o">=</code> <code class="n">Item</code><code class="p">()</code>
        <code class="n">item</code><code class="o">.</code><code class="n">text</code> <code class="o">=</code> <code class="n">request</code><code class="o">.</code><code class="n">POST</code><code class="p">[</code><code class="s2">"item_text"</code><code class="p">]</code>
        <code class="n">item</code><code class="o">.</code><code class="n">save</code><code class="p">()</code>

    <code class="k">return</code> <code class="n">render</code><code class="p">(</code>
        <code class="n">request</code><code class="p">,</code>
        <code class="s2">"home.xhtml"</code><code class="p">,</code>
        <code class="p">{</code><code class="s2">"new_item_text"</code><code class="p">:</code> <code class="n">request</code><code class="o">.</code><code class="n">POST</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"item_text"</code><code class="p">,</code> <code class="s2">""</code><code class="p">)},</code>
    <code class="p">)</code></pre></div>
<p><a data-primary="" data-startref="DTpostsave05" data-type="indexterm" id="id336"/>
<a data-primary="" data-startref="HTMLpostsave05" data-type="indexterm" id="id337"/>
<a data-primary="" data-startref="POSTsave05" data-type="indexterm" id="id338"/>
And that gets the test passing:</p>
<pre data-type="programlisting">Ran 4 tests in 0.010s

OK</pre>
</div></section>
<section data-pdf-bookmark="Redirect After a POST" data-type="sect1"><div class="sect1" id="id79">
<h1>Redirect After a POST</h1>
<p><a data-primary="database testing" data-secondary="HTML POST requests" data-tertiary="redirect following" data-type="indexterm" id="DThtmlredirect05"/>
<a data-primary="HTML" data-secondary="POST requests" data-tertiary="redirect following" data-type="indexterm" id="HTMLpostredirect05"/>
<a data-primary="POST requests" data-secondary="redirect following" data-type="indexterm" id="POSTredirect05"/>
But, yuck, those duplicated <code>request.POST</code> accesses are making me pretty unhappy.
Thankfully we are about to have the opportunity to fix it.
A view function has two jobs: processing user input, and returning an appropriate response.
We’ve taken care of the first part, which is saving the user’s input to the database,
so now let’s work on the second part.</p>
<p><a href="https://en.wikipedia.org/wiki/Post/Redirect/Get">Always redirect after a POST</a>,
they say, so let’s do that.
Once again we change our unit test for saving a POST request:
instead of expecting a response with the item in it,
we want it to expect a redirect back to the home page.</p>
<div class="sourcecode" data-type="example">
<p>lists/tests.py (ch05l029)</p>
<pre data-code-language="python" data-type="programlisting"><code>    </code><code class="k">def</code><code> </code><code class="nf">test_can_save_a_POST_request</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="n">response</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">client</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"</code><code class="s2">/</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">data</code><code class="o">=</code><code class="p">{</code><code class="s2">"</code><code class="s2">item_text</code><code class="s2">"</code><code class="p">:</code><code> </code><code class="s2">"</code><code class="s2">A new list item</code><code class="s2">"</code><code class="p">}</code><code class="p">)</code><code>
</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">assertEqual</code><code class="p">(</code><code class="n">Item</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">count</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">)</code><code>
</code><code>        </code><code class="n">new_item</code><code> </code><code class="o">=</code><code> </code><code class="n">Item</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">first</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">assertEqual</code><code class="p">(</code><code class="n">new_item</code><code class="o">.</code><code class="n">text</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">A new list item</code><code class="s2">"</code><code class="p">)</code><code>
</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">assertRedirects</code><code class="p">(</code><code class="n">response</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">/</code><code class="s2">"</code><code class="p">)</code><code>  </code><a class="co" href="#callout_saving_user_input__testing_the_database_CO4-1" id="co_saving_user_input__testing_the_database_CO4-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">test_only_saves_items_when_necessary</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="p">[</code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code class="p">]</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" href="#co_saving_user_input__testing_the_database_CO4-1" id="callout_saving_user_input__testing_the_database_CO4-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>We no longer expect a response with HTML content rendered by a template,
so we lose the <code>assertContains</code> calls that looked at that.
Instead, we use Django’s <code>assertRedirects</code> helper
which checks that we return an HTTP 302 redirect, back to the home URL.</p></dd>
</dl>
<p>That gives us this expected failure:</p>
<pre data-type="programlisting">AssertionError: 200 != 302 : Response didn't redirect as expected: Response
code was 200 (expected 302)</pre>
<p>We can now tidy up our view substantially:</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch05l030)</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">django.shortcuts</code> <code class="kn">import</code> <code class="n">redirect</code><code class="p">,</code> <code class="n">render</code>
<code class="kn">from</code> <code class="nn">lists.models</code> <code class="kn">import</code> <code class="n">Item</code>


<code class="k">def</code> <code class="nf">home_page</code><code class="p">(</code><code class="n">request</code><code class="p">):</code>
    <code class="k">if</code> <code class="n">request</code><code class="o">.</code><code class="n">method</code> <code class="o">==</code> <code class="s2">"POST"</code><code class="p">:</code>
        <code class="n">item</code> <code class="o">=</code> <code class="n">Item</code><code class="p">()</code>
        <code class="n">item</code><code class="o">.</code><code class="n">text</code> <code class="o">=</code> <code class="n">request</code><code class="o">.</code><code class="n">POST</code><code class="p">[</code><code class="s2">"item_text"</code><code class="p">]</code>
        <code class="n">item</code><code class="o">.</code><code class="n">save</code><code class="p">()</code>
        <code class="k">return</code> <code class="n">redirect</code><code class="p">(</code><code class="s2">"/"</code><code class="p">)</code>

    <code class="k">return</code> <code class="n">render</code><code class="p">(</code>
        <code class="n">request</code><code class="p">,</code>
        <code class="s2">"home.xhtml"</code><code class="p">,</code>
        <code class="p">{</code><code class="s2">"new_item_text"</code><code class="p">:</code> <code class="n">request</code><code class="o">.</code><code class="n">POST</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"item_text"</code><code class="p">,</code> <code class="s2">""</code><code class="p">)},</code>
    <code class="p">)</code></pre></div>
<p>And the tests should now pass:</p>
<pre data-type="programlisting">Ran 4 tests in 0.010s

OK</pre>
<p>We’re at green, time for a little refactor!</p>
<p>Let’s have a look at <em>views.py</em>
and see what opportunities for improvement there might be:</p>
<div class="sourcecode currentcontents" data-type="example">
<p>lists/views.py</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code><code> </code><code class="nf">home_page</code><code class="p">(</code><code class="n">request</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="k">if</code><code> </code><code class="n">request</code><code class="o">.</code><code class="n">method</code><code> </code><code class="o">==</code><code> </code><code class="s2">"</code><code class="s2">POST</code><code class="s2">"</code><code class="p">:</code><code>
</code><code>        </code><code class="n">item</code><code> </code><code class="o">=</code><code> </code><code class="n">Item</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_saving_user_input__testing_the_database_CO5-1" id="co_saving_user_input__testing_the_database_CO5-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code>        </code><code class="n">item</code><code class="o">.</code><code class="n">text</code><code> </code><code class="o">=</code><code> </code><code class="n">request</code><code class="o">.</code><code class="n">POST</code><code class="p">[</code><code class="s2">"</code><code class="s2">item_text</code><code class="s2">"</code><code class="p">]</code><code>  </code><a class="co" href="#callout_saving_user_input__testing_the_database_CO5-1" id="co_saving_user_input__testing_the_database_CO5-2"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code>        </code><code class="n">item</code><code class="o">.</code><code class="n">save</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_saving_user_input__testing_the_database_CO5-1" id="co_saving_user_input__testing_the_database_CO5-3"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">redirect</code><code class="p">(</code><code class="s2">"</code><code class="s2">/</code><code class="s2">"</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">render</code><code class="p">(</code><code>
</code><code>        </code><code class="n">request</code><code class="p">,</code><code>
</code><code>        </code><code class="s2">"</code><code class="s2">home.xhtml</code><code class="s2">"</code><code class="p">,</code><code>
</code><code>        </code><code class="p">{</code><code class="s2">"</code><code class="s2">new_item_text</code><code class="s2">"</code><code class="p">:</code><code> </code><code class="n">request</code><code class="o">.</code><code class="n">POST</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"</code><code class="s2">item_text</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">"</code><code class="p">)</code><code class="p">}</code><code class="p">,</code><code>  </code><a class="co" href="#callout_saving_user_input__testing_the_database_CO5-2" id="co_saving_user_input__testing_the_database_CO5-4"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
</code><code>    </code><code class="p">)</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" href="#co_saving_user_input__testing_the_database_CO5-1" id="callout_saving_user_input__testing_the_database_CO5-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>There’s a quicker way to do these 3 lines with <code>.objects.create()</code></p></dd>
<dt><a class="co" href="#co_saving_user_input__testing_the_database_CO5-4" id="callout_saving_user_input__testing_the_database_CO5-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>This line doesn’t seem quite right now, in fact it won’t work at all.
Let’s make a note on our scratchpad to sort out passing list items to the template.
It’s actually closely related to “Display multiple items”,
so we’ll put it just before that one:</p></dd>
</dl>
<aside class="scratchpad" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id339">
<h1/>
<ul>
<li>
<p><em>
<span class="strikethrough line-through">Don’t save blank items for every request</span></em></p>
</li>
<li>
<p><em>Code smell: POST test is too long?</em></p>
</li>
<li>
<p><em>Pass existing list items to the template somehow</em></p>
</li>
<li>
<p><em>Display multiple items in the table</em></p>
</li>
<li>
<p><em>Support more than one list!</em></p>
</li>
</ul>
</div></aside>
<p>And here’s the refactored version of <em>views.py</em> using the <code>.objects.create()</code>
helper method that Django provides, for one-line creation of objects:</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch05l031)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">home_page</code><code class="p">(</code><code class="n">request</code><code class="p">):</code>
    <code class="k">if</code> <code class="n">request</code><code class="o">.</code><code class="n">method</code> <code class="o">==</code> <code class="s2">"POST"</code><code class="p">:</code>
        <code class="n">Item</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">text</code><code class="o">=</code><code class="n">request</code><code class="o">.</code><code class="n">POST</code><code class="p">[</code><code class="s2">"item_text"</code><code class="p">])</code>
        <code class="k">return</code> <code class="n">redirect</code><code class="p">(</code><code class="s2">"/"</code><code class="p">)</code>

    <code class="k">return</code> <code class="n">render</code><code class="p">(</code>
        <code class="n">request</code><code class="p">,</code>
        <code class="s2">"home.xhtml"</code><code class="p">,</code>
        <code class="p">{</code><code class="s2">"new_item_text"</code><code class="p">:</code> <code class="n">request</code><code class="o">.</code><code class="n">POST</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"item_text"</code><code class="p">,</code> <code class="s2">""</code><code class="p">)},</code>
    <code class="p">)</code></pre></div>
</div></section>
<section data-pdf-bookmark="Better Unit Testing Practice: Each Test Should Test One Thing" data-type="sect1"><div class="sect1" id="id38">
<h1>Better Unit Testing Practice: Each Test Should Test One Thing</h1>
<p><a data-primary="unit tests" data-secondary="testing only one thing" data-type="indexterm" id="id340"/>
<a data-primary="testing best practices" data-type="indexterm" id="id341"/>
Let’s address the “POST test is too long” code smell.</p>
<p>Good unit testing practice says that each test should only test one thing. The
reason is that it makes it easier to track down bugs.  Having multiple
assertions in a test means that, if the test fails on an early assertion, you
don’t know what the statuses of the later assertions are. As we’ll see in the next
chapter, if we ever break this view accidentally, we want to know whether it’s
the saving of objects that’s broken, or the type of response.</p>
<p>You may not always write perfect unit tests with single assertions on your
first go, but now feels like a good time to separate out our concerns:</p>
<div class="sourcecode" data-type="example">
<p>lists/tests.py (ch05l032)</p>
<pre data-code-language="python" data-type="programlisting">    <code class="k">def</code> <code class="nf">test_can_save_a_POST_request</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">client</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"/"</code><code class="p">,</code> <code class="n">data</code><code class="o">=</code><code class="p">{</code><code class="s2">"item_text"</code><code class="p">:</code> <code class="s2">"A new list item"</code><code class="p">})</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertEqual</code><code class="p">(</code><code class="n">Item</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">count</code><code class="p">(),</code> <code class="mi">1</code><code class="p">)</code>
        <code class="n">new_item</code> <code class="o">=</code> <code class="n">Item</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">first</code><code class="p">()</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertEqual</code><code class="p">(</code><code class="n">new_item</code><code class="o">.</code><code class="n">text</code><code class="p">,</code> <code class="s2">"A new list item"</code><code class="p">)</code>

    <code class="k">def</code> <code class="nf">test_redirects_after_POST</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="n">response</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">client</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"/"</code><code class="p">,</code> <code class="n">data</code><code class="o">=</code><code class="p">{</code><code class="s2">"item_text"</code><code class="p">:</code> <code class="s2">"A new list item"</code><code class="p">})</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertRedirects</code><code class="p">(</code><code class="n">response</code><code class="p">,</code> <code class="s2">"/"</code><code class="p">)</code></pre></div>
<p><a data-primary="" data-startref="HTMLpostredirect05" data-type="indexterm" id="id342"/>
<a data-primary="" data-startref="DThtmlredirect05" data-type="indexterm" id="id343"/>
<a data-primary="" data-startref="POSTredirect05" data-type="indexterm" id="id344"/>
And we should now see five tests pass instead of four:</p>
<pre data-type="programlisting">Ran 5 tests in 0.010s

OK</pre>
</div></section>
<section data-pdf-bookmark="Rendering Items in the Template" data-type="sect1"><div class="sect1" id="id39">
<h1>Rendering Items in the Template</h1>
<p><a data-primary="database testing" data-secondary="rendering items in the template" data-type="indexterm" id="DTrender05"/>
Much better!  Back to our to-do list:</p>
<aside class="scratchpad" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id345">
<h1/>
<ul>
<li>
<p><em>
<span class="strikethrough line-through">Don’t save blank items for every request</span></em></p>
</li>
<li>
<p><em>
<span class="strikethrough line-through">Code smell: POST test is too long?</span></em></p>
</li>
<li>
<p><em>Pass existing list items to the template somehow</em></p>
</li>
<li>
<p><em>Display multiple items in the table</em></p>
</li>
<li>
<p><em>Support more than one list!</em></p>
</li>
</ul>
</div></aside>
<p>Crossing things off the list is almost as satisfying as seeing tests pass!</p>
<p>The third and fourth items are the last of the “easy” ones.
Our view now does the right thing for POST requests,
it saves new list items to the database.
Now we want GET requests to load all currently existing list items,
and pass them to the template for rendering.
Let’s have a new unit test for that:</p>
<div class="sourcecode" data-type="example">
<p>lists/tests.py (ch05l033)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">class</code> <code class="nc">HomePageTest</code><code class="p">(</code><code class="n">TestCase</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf">test_uses_home_template</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="p">[</code><code class="o">...</code><code class="p">]</code>

    <code class="k">def</code> <code class="nf">test_displays_all_list_items</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="n">Item</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">text</code><code class="o">=</code><code class="s2">"itemey 1"</code><code class="p">)</code>
        <code class="n">Item</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">text</code><code class="o">=</code><code class="s2">"itemey 2"</code><code class="p">)</code>
        <code class="n">response</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">client</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/"</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertContains</code><code class="p">(</code><code class="n">response</code><code class="p">,</code> <code class="s2">"itemey 1"</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertContains</code><code class="p">(</code><code class="n">response</code><code class="p">,</code> <code class="s2">"itemey 2"</code><code class="p">)</code>

    <code class="k">def</code> <code class="nf">test_can_save_a_POST_request</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="p">[</code><code class="o">...</code><code class="p">]</code></pre></div>
<p>That fails as expected:</p>
<pre data-type="programlisting">AssertionError: False is not true : Couldn't find 'itemey 1' in response</pre>
<p><a data-primary="templates" data-secondary="tags" data-tertiary="{% for …​ endfor %}" data-type="indexterm" id="id346"/>
<a data-primary="{% for …​ endfor %}" data-type="indexterm" id="id347"/>
The Django template syntax has a tag for iterating through lists,
<code>{% for .. in .. %}</code>; we can use it like this:</p>
<div class="sourcecode" data-type="example">
<p>lists/templates/home.xhtml (ch05l034)</p>
<pre data-code-language="html" data-type="programlisting"><code class="p">&lt;</code><code class="nt">table</code> <code class="na">id</code><code class="o">=</code><code class="s">"id_list_table"</code><code class="p">&gt;</code>
  {% for item in items %}
    <code class="p">&lt;</code><code class="nt">tr</code><code class="p">&gt;&lt;</code><code class="nt">td</code><code class="p">&gt;</code>1: {{ item.text }}<code class="p">&lt;/</code><code class="nt">td</code><code class="p">&gt;&lt;/</code><code class="nt">tr</code><code class="p">&gt;</code>
  {% endfor %}
<code class="p">&lt;/</code><code class="nt">table</code><code class="p">&gt;</code></pre></div>
<p>This is one of the major strengths of the templating system. Now the template
will render with multiple <code>&lt;tr&gt;</code> rows, one for each item in the variable
<code>items</code>.  Pretty neat!  I’ll introduce a few more bits of Django template
magic as we go, but at some point you’ll want to go and read up on the rest of
them in the
<a href="https://docs.djangoproject.com/en/4.2/topics/templates/">Django docs</a>.</p>
<p>Just changing the template doesn’t get our tests to green; we need to actually
pass the items to it from our home page view:</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch05l035)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">home_page</code><code class="p">(</code><code class="n">request</code><code class="p">):</code>
    <code class="k">if</code> <code class="n">request</code><code class="o">.</code><code class="n">method</code> <code class="o">==</code> <code class="s2">"POST"</code><code class="p">:</code>
        <code class="n">Item</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">text</code><code class="o">=</code><code class="n">request</code><code class="o">.</code><code class="n">POST</code><code class="p">[</code><code class="s2">"item_text"</code><code class="p">])</code>
        <code class="k">return</code> <code class="n">redirect</code><code class="p">(</code><code class="s2">"/"</code><code class="p">)</code>

    <code class="n">items</code> <code class="o">=</code> <code class="n">Item</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">all</code><code class="p">()</code>
    <code class="k">return</code> <code class="n">render</code><code class="p">(</code><code class="n">request</code><code class="p">,</code> <code class="s2">"home.xhtml"</code><code class="p">,</code> <code class="p">{</code><code class="s2">"items"</code><code class="p">:</code> <code class="n">items</code><code class="p">})</code></pre></div>
<p>That does get the unit tests to pass…​moment of truth, will the functional
test pass?</p>
<pre data-type="programlisting">$ <strong>python functional_tests.py</strong>
[...]
AssertionError: 'To-Do' not found in 'OperationalError at /'</pre>
<p><a data-primary="" data-startref="DTrender05" data-type="indexterm" id="id348"/>
<a data-primary="debugging" data-secondary="manual visits" data-type="indexterm" id="id349"/>
Oops, apparently not.  Let’s use another functional test debugging technique,
and it’s one of the most straightforward: manually visiting the site!
Open up <em>http://localhost:8000</em> in your web browser,
and you’ll see a Django debug page saying “no such table: lists_item”, as in <a data-type="xref" href="#operationalerror">Figure 5-2</a>.</p>
<figure class="width-75"><div class="figure" id="operationalerror">
<img alt="OperationalError at / no such table: lists_item" height="617" src="assets/twp2_0502.png" width="900"/>
<h6><span class="label">Figure 5-2. </span>Another helpful debug message</h6>
</div></figure>
</div></section>
<section class="pagebreak-before less_space" data-pdf-bookmark="Creating Our Production Database with migrate" data-type="sect1"><div class="sect1" id="id40">
<h1>Creating Our Production Database with migrate</h1>
<p><a data-primary="database testing" data-secondary="production database creation" data-type="indexterm" id="DTproduction05"/>
<a data-primary="database migrations" data-type="indexterm" id="id350"/>
Another helpful error message from Django,
which is basically complaining that we haven’t set up the database properly.
How come everything worked fine in the unit tests, I hear you ask?
Because Django creates a special <em>test database</em> for unit tests;
it’s one of the magical things that Django’s <code>TestCase</code> does.</p>
<p>To set up our “real” database, we need to explicitly create it.
SQLite databases are just a file on disk,
and you’ll see in <em>settings.py</em> that Django, by default, will just put it in a file
called <em>db.sqlite3</em> in the base project directory:</p>
<div class="sourcecode currentcontents" data-type="example">
<p>superlists/settings.py</p>
<pre data-code-language="python" data-type="programlisting"><code class="p">[</code><code class="o">...</code><code class="p">]</code>
<code class="c1"># Database</code>
<code class="c1"># https://docs.djangoproject.com/en/4.2/ref/settings/#databases</code>

<code class="n">DATABASES</code> <code class="o">=</code> <code class="p">{</code>
    <code class="s2">"default"</code><code class="p">:</code> <code class="p">{</code>
        <code class="s2">"ENGINE"</code><code class="p">:</code> <code class="s2">"django.db.backends.sqlite3"</code><code class="p">,</code>
        <code class="s2">"NAME"</code><code class="p">:</code> <code class="n">BASE_DIR</code> <code class="o">/</code> <code class="s2">"db.sqlite3"</code><code class="p">,</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>
<p>We’ve told Django everything it needs to create the database,
first via <em>models.py</em> and then when we created the migrations file.
To actually apply it to creating a real database,
we use another Django Swiss Army knife <em>manage.py</em> command, <code>migrate</code>:</p>
<pre data-type="programlisting">$ <strong>python manage.py migrate</strong>
Operations to perform:
  Apply all migrations: admin, auth, contenttypes, lists, sessions
Running migrations:
  Applying contenttypes.0001_initial... OK
  Applying auth.0001_initial... OK
  Applying admin.0001_initial... OK
  Applying admin.0002_logentry_remove_auto_add... OK
  Applying admin.0003_logentry_add_action_flag_choices... OK
  Applying contenttypes.0002_remove_content_type_name... OK
  Applying auth.0002_alter_permission_name_max_length... OK
  Applying auth.0003_alter_user_email_max_length... OK
  Applying auth.0004_alter_user_username_opts... OK
  Applying auth.0005_alter_user_last_login_null... OK
  Applying auth.0006_require_contenttypes_0002... OK
  Applying auth.0007_alter_validators_add_error_messages... OK
  Applying auth.0008_alter_user_username_max_length... OK
  Applying auth.0009_alter_user_last_name_max_length... OK
  Applying auth.0010_alter_group_name_max_length... OK
  Applying auth.0011_update_proxy_permissions... OK
  Applying auth.0012_alter_user_first_name_max_length... OK
  Applying lists.0001_initial... OK
  Applying lists.0002_item_text... OK
  Applying sessions.0001_initial... OK</pre>
<p>Now we can refresh the page on <em>localhost</em>, see that our error is gone, and try
running the functional tests
again:<sup><a data-type="noteref" href="ch05.xhtml#id351" id="id351-marker">8</a></sup></p>
<pre data-type="programlisting">AssertionError: '2: Use peacock feathers to make a fly' not found in ['1: Buy
peacock feathers', '1: Use peacock feathers to make a fly']</pre>
<p>So close!  We just need to get our list numbering right.  Another awesome
Django template tag, <code>forloop.counter</code>, will help here:</p>
<div class="sourcecode" data-type="example">
<p>lists/templates/home.xhtml (ch05l036)</p>
<pre data-code-language="html" data-type="programlisting">  {% for item in items %}
    <code class="p">&lt;</code><code class="nt">tr</code><code class="p">&gt;&lt;</code><code class="nt">td</code><code class="p">&gt;</code>{{ forloop.counter }}: {{ item.text }}<code class="p">&lt;/</code><code class="nt">td</code><code class="p">&gt;&lt;/</code><code class="nt">tr</code><code class="p">&gt;</code>
  {% endfor %}</pre></div>
<p>If you try it again, you should now see the FT gets to the end:</p>
<pre data-type="programlisting">$ <strong>python functional_tests.py</strong>
.
 ---------------------------------------------------------------------
Ran 1 test in 5.036s

OK</pre>
<p>Hooray!</p>
<p>But, as it’s running, you may notice something is amiss, like in
<a data-type="xref" href="#items_left_over_from_previous_run">Figure 5-3</a>.</p>
<figure><div class="figure" id="items_left_over_from_previous_run">
<img alt="There are list items left over from the last run of the test" height="587" src="assets/twp2_0503.png" width="899"/>
<h6><span class="label">Figure 5-3. </span>There are list items left over from the last run of the test</h6>
</div></figure>
<p>Oh dear. It looks like previous runs of the test are leaving stuff lying around
in our database.  In fact, if you run the tests again, you’ll see it gets
worse:</p>
<pre class="skipme" data-type="programlisting">1: Buy peacock feathers
2: Use peacock feathers to make a fly
3: Buy peacock feathers
4: Use peacock feathers to make a fly
5: Buy peacock feathers
6: Use peacock feathers to make a fly</pre>
<p>Grrr.  We’re so close! We’re going to need some kind of automated way of
tidying up after ourselves. For now, if you feel like it, you can do it
manually, by deleting the database and re-creating it fresh with <code>migrate</code>
(you’ll need to shut down your Django server first):</p>
<pre data-type="programlisting">$ <strong>rm db.sqlite3</strong>
$ <strong>python manage.py migrate --noinput</strong></pre>
<p>And then (after restarting your server!) reassure yourself that the FT still
passes.</p>
<p>Apart from that little bug in our functional testing, we’ve got some code
that’s more or less working.  Let’s do a commit.
<a data-primary="" data-startref="DTproduction05" data-type="indexterm" id="id352"/></p>
<p>Start by doing a <strong><code>git status</code></strong> and a <strong><code>git diff</code></strong>, and you should see changes
to <em>home.xhtml</em>, <em>tests.py</em>, and <em>views.py</em>. Let’s add them:</p>
<pre data-type="programlisting">$ <strong>git add lists</strong>
$ <strong>git commit -m "Redirect after POST, and show all items in template"</strong></pre>
<div data-type="tip"><h6>Tip</h6>
<p>You might find it useful to add markers for the end of each chapter, like
    <strong><code>git tag end-of-chapter-05</code></strong>.</p>
</div>
</div></section>
<section data-pdf-bookmark="Recap" data-type="sect1"><div class="sect1" id="id41">
<h1>Recap</h1>
<p>Where are we?  How is progress on our app, and what have we learned?</p>
<ul>
<li>
<p>We’ve got a form set up to add new items to the list using POST.</p>
</li>
<li>
<p>We’ve set up a simple model in the database to save list items.</p>
</li>
<li>
<p>We’ve learned about creating database migrations, both for the
test database (where they’re applied automatically) and for the real
database (where we have to apply them manually).</p>
</li>
<li>
<p>We’ve used our first couple of Django template tags:  <code>{% csrf_token %}</code>
and the <code>{% for ... endfor %}</code> loop.</p>
</li>
<li>
<p>And we’ve used two different FT debugging techniques:
<code>time.sleep</code>s, and improving the error messages.</p>
</li>
</ul>
<p class="pagebreak-before">But we’ve got a couple of items on our own to-do list,
namely getting the FT to clean up after itself,
and perhaps more critically,
adding support for more than one list.</p>
<aside class="scratchpad" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id353">
<h1/>
<ul>
<li>
<p><em>
<span class="strikethrough line-through">Don’t save blank items for every request</span></em></p>
</li>
<li>
<p><em>
<span class="strikethrough line-through">Code smell: POST test is too long?</span></em></p>
</li>
<li>
<p><em>
<span class="strikethrough line-through">‘Pass existing list items to the template somehow</span></em></p>
</li>
<li>
<p><em>
<span class="strikethrough line-through">Display multiple items in the table</span></em></p>
</li>
<li>
<p><em>Clean up after FT runs</em></p>
</li>
<li>
<p><em>Support more than one list!</em></p>
</li>
</ul>
</div></aside>
<p>I mean, we <em>could</em> ship the site as it is, but people might find it strange
that the entire human population has to share a single to-do list.
I suppose it might get people to stop and think about
how connected we all are to one another,
how we all share a common destiny here on Spaceship Earth,
and how we must all work together to solve the global problems that we face.</p>
<p>But in practical terms, the site wouldn’t be very useful.</p>
<p>Ah well.</p>
<aside class="pagebreak-before less_space" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id354">
<h1>Useful TDD Concepts</h1><dl>
<dt>Regression</dt>
<dd>
<p>When a change unexpectedly breaks some aspect of the application which used to work.
<a data-primary="Test-Driven Development (TDD)" data-secondary="concepts" data-tertiary="regression" data-type="indexterm" id="id355"/>
<a data-primary="regression" data-type="indexterm" id="id356"/></p>
</dd>
<dt>Unexpected failure</dt>
<dd>
<p>When a test fails in a way we weren’t expecting.
This either means that we’ve made a mistake in our tests,
or that the tests have helped us find a regression,
and we need to fix something in our code.
<a data-primary="Test-Driven Development (TDD)" data-secondary="concepts" data-tertiary="unexpected failures" data-type="indexterm" id="id357"/>
<a data-primary="unexpected failures" data-type="indexterm" id="id358"/></p>
</dd>
<dt>Triangulation</dt>
<dd>
<p>Adding a test case with a new specific example for some existing code,
to justify generalising the implementation
(which may be a “cheat” until that point).
<a data-primary="Test-Driven Development (TDD)" data-secondary="concepts" data-tertiary="triangulation" data-type="indexterm" id="id359"/>
<a data-primary="triangulation" data-type="indexterm" id="id360"/></p>
</dd>
<dt>Three strikes and refactor</dt>
<dd>
<p>A rule of thumb for when to remove duplication from code.
When two pieces of code look very similar,
it often pays to wait until you see a third use case,
so that you’re more sure about what part of the code really is the common,
re-usable part to refactor out.
<a data-primary="Test-Driven Development (TDD)" data-secondary="concepts" data-tertiary="three strikes and refactor" data-type="indexterm" id="id361"/>
<a data-primary="three strikes and refactor rule" data-type="indexterm" id="id362"/></p>
</dd>
<dt>The scratchpad to-do list</dt>
<dd>
<p>A place to write down things that occur to us as we’re coding,
so that we can finish up what we’re doing and come back to them later.
<a data-primary="Test-Driven Development (TDD)" data-secondary="concepts" data-tertiary="scratchpad to-do list" data-type="indexterm" id="id363"/>
<a data-primary="scratchpad to-do list" data-type="indexterm" id="id364"/></p>
</dd>
</dl>
</div></aside>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="id285"><sup><a href="ch05.xhtml#id285-marker">1</a></sup> “Geepaw” Hill, another one of the TDD OGs, has <a href="https://www.geepawhill.org/2021/09/29/many-more-much-smaller-steps-first-sketch/">a series of blog posts</a> advocating for taking “Many More Much Smaller Steps (MMMSS)”. In this chapter I’m being unrealistically <em>short-sighted</em> for effect, so don’t do that! But Geepaw argues that in the real world, when you slice your work into tiny increments, not only do you get there in the end, but you end up delivering business value <em>faster</em>.</p><p data-type="footnote" id="id287"><sup><a href="ch05.xhtml#id287-marker">2</a></sup> Did you know that you don’t need a button to make a form submit? I can’t remember when I learned that, but readers have mentioned that it’s unusual so I thought I’d draw your attention to it.</p><p data-type="footnote" id="id293"><sup><a href="ch05.xhtml#id293-marker">3</a></sup> Another common technique for debugging tests is to use <code>breakpoint()</code> to drop into a debugger like <code>pdb</code>. This is more useful for <em>unit</em> tests rather than FTs though, because in an FT you usually can’t step into actual application code. Personally I only find debuggers useful for really fiddly algorithms, which we won’t see in this book.)</p><p data-type="footnote" id="id305"><sup><a href="ch05.xhtml#id305-marker">4</a></sup> But we <em>did</em> learn about <code>request.method</code> and <code>request.POST</code> right? I know it might seem that I’m overdoing it, but doing things in tiny little really does have a lot of advantages, and one of them is that you can really think about (or in this case, learn) one thing at a time.</p><p data-type="footnote" id="id319"><sup><a href="ch05.xhtml#id319-marker">5</a></sup> If you’ve not come across the concept, a “code smell” is something about a piece of code that makes you want to rewrite it. Jeff Atwood has <a href="https://blog.codinghorror.com/code-smells/">a compilation on his blog Coding Horror</a>. The more experience you gain as a programmer, the more fine-tuned your nose becomes to code smells…​</p><p data-type="footnote" id="id328"><sup><a href="ch05.xhtml#id328-marker">6</a></sup> If you’ve done a bit of Django before, you may be wondering about when we’re going to run “migrate” as well as “makemigrations”? Read on; that’s coming up later in the chapter.</p><p data-type="footnote" id="id329"><sup><a href="ch05.xhtml#id329-marker">7</a></sup> Database tables usually have a special column called a “primary key”, which is the unique identifier for each row in the table. It’s worth brushing up on a <em>tiny</em> bit of relational database theory, if you’re not familiar with the concept or why it’s useful. The top three articles I found when searching for “introduction to databases” all seemed pretty good, at the time of writing.</p><p data-type="footnote" id="id351"><sup><a href="ch05.xhtml#id351-marker">8</a></sup> If you get a different error at this point, try restarting your dev server—​it may have gotten confused by the changes to the database happening under its feet.</p></div></div></section></div></body></html>