<html><head></head><body>
<div id="sbo-rt-content"><section data-nutshell-tab="Threads and Processes" data-pdf-bookmark="Chapter 15. Concurrency: Threads and Processes" data-type="chapter" epub:type="chapter"><div class="chapter" id="concurrency_threads_and_processes">
<h1><span class="label">Chapter 15. </span>Concurrency: Threads and Processes</h1>
<p><em>Processes<a contenteditable="false" data-primary="processes, definition of term" data-type="indexterm" id="idm44924506400224"/></em><a contenteditable="false" data-primary="threads and processes" data-secondary="basics of" data-type="indexterm" id="idm44924506399248"/> are instances of running programs that the operating system protects from one another. Processes that want to communicate must explicitly arrange to do so via<a contenteditable="false" data-primary=" interprocess communication (IPC)" data-type="indexterm" id="idm44924506397904"/><a contenteditable="false" data-primary="IPC (interprocess communication)" data-type="indexterm" id="idm44924506396864"/> <em>interprocess communication</em> (IPC) mechanisms, and/or via files (covered in <a data-type="xref" href="ch11.xhtml#file_and_text_operations">Chapter 11</a>), databases (covered in <a data-type="xref" href="ch12.xhtml#persistence_and_databases">Chapter 12</a>), or network interfaces (covered in <a data-type="xref" href="ch18.xhtml#networking_basics">Chapter 18</a>). The general way in which processes communicate using data storage mechanisms such as files and databases is that one process writes data, and another process later reads that data back. This chapter covers programming with processes, including the Python standard library modules <span class="code">subprocess</span> and <span class="code">multiprocessing</span>; the process-related parts of the module <span class="code">os</span>, including simple IPC by means of<a contenteditable="false" data-primary="pipes" data-type="indexterm" id="idm44924506390064"/> <em>pipes</em>; a cross-platform IPC mechanism known as<a contenteditable="false" data-primary=" memory-mapped files" data-type="indexterm" id="idm44924506388384"/> <em>memory-mapped files</em>, available in the module <span class="code">mmap</span>; <span class="version">3.8+</span> and the <span class="code">multiprocessing.shared_memory</span> module.</p>
<p>A <em>thread</em> (originally called a<a contenteditable="false" data-primary="lightweight processes" data-type="indexterm" id="idm44924506383552"/> “lightweight process”) is a flow of control that shares global state (memory) with other threads inside a single process; all threads appear to execute simultaneously, although they may in fact be “taking turns” on one or more processors/cores. Threads<a contenteditable="false" data-primary="multithreading" data-type="indexterm" id="idm44924506382288"/> are far from easy to master, and multithreaded programs are often hard to test and to debug; however, as covered in <a data-type="xref" href="#should_you_use_threadingcomma_multiproc">“Threading, Multiprocessing, or Async Programming?”</a>, when used appropriately, multithreading may improve performance in comparison to single-threaded programming. This chapter covers various facilities Python provides for dealing with threads, including the <span class="code">threading</span>, <span class="code">queue</span>, and <span class="code">concurrent.futures</span> modules.</p>
<p>Another mechanism for sharing control among multiple activities within a single process is what has become known as<a contenteditable="false" data-primary=" asynchronous (async) programming" data-type="indexterm" id="idm44924506377072"/> <em>asynchronous</em> (or <em>async</em>) programming. When you are reading Python code, the presence of the<a contenteditable="false" data-primary="await keyword" data-type="indexterm" id="idm44924506374992"/><a contenteditable="false" data-primary="async keyword" data-type="indexterm" id="idm44924506373888"/> keywords <strong><span class="code">async</span></strong> and <strong><span class="code">await</span></strong> indicate it is asynchronous. Such code depends on an <em>event loop</em>, which is, broadly speaking, the equivalent of the thread switcher used within a process. When the event loop is the scheduler, each execution of an asynchronous function becomes a<a contenteditable="false" data-primary="tasks" data-type="indexterm" id="idm44924506370544"/> <em>task</em>, which roughly corresponds with a <em>thread</em> in a multithreaded program.</p>
<p>Both process scheduling and thread switching are <em>preemptive</em>, which is to say that the scheduler or switcher has control of the CPU and determines when any particular piece of code gets to run. Asynchronous programming, however, is <em>cooperative</em>: each task, once execution begins, can run for as long as it chooses before indicating to the event loop that it is prepared to give up control (usually because it is awaiting the completion of some other asynchronous task, most often an I/O-focused one).</p>
<p>Although async programming offers great flexibility to optimize certain classes of problems, it is a programming paradigm that many programmers are unfamiliar with. Because of its cooperative nature, incautious async programming can lead<a contenteditable="false" data-primary="deadlocks" data-type="indexterm" id="idm44924506366992"/> to <em>deadlocks</em>, and infinite loops can starve other tasks of processor time: figuring out how to avoid deadlocks creates significant extra cognitive load for the average programmer. We do not cover asynchronous programming, including the module <a href="https://oreil.ly/zRZKX"><span class="code">asyncio</span></a>, further in this volume, feeling that it is a complex enough topic to be well worth a book on its own.<sup><a data-type="noteref" href="ch15.xhtml#ch01fn116" id="ch01fn116-marker">1</a></sup></p>
<p>Network mechanisms are well suited for IPC, and work just as effectively between processes running on different nodes of a network as between ones that run on the same node. The <span class="code">multiprocessing</span> module supplies some mechanisms that are suitable for IPC over a network; <a data-type="xref" href="ch18.xhtml#networking_basics">Chapter 18</a> covers low-level network mechanisms that provide a basis for IPC. Other, higher-level mechanisms<a contenteditable="false" data-primary="distributed computing" data-type="indexterm" id="distcomp15"/> for <em>distributed computing</em> (<a class="orm:hideurl" href="https://www.ibm.com/docs/en/integration-bus/9.0.0?topic=corba-common-object-request-broker-architecture">CORBA</a>, <a class="orm:hideurl" href="https://whatis.techtarget.com/definition/DCOM-Distributed-Component-Object-Model#:~:text=DCOM%20(Distributed%20Component%20Object%20Model)%20is%20a%20set%20of%20Microsoft,other%20computers%20in%20a%20network.">DCOM/COM+</a>, <a class="orm:hideurl" href="https://en.wikipedia.org/wiki/Jakarta_Enterprise_Beans#:~:text=EJB%20is%20a%20server%2Dside,processing%2C%20and%20other%20web%20services">EJB</a>, <a class="orm:hideurl" href="https://en.wikipedia.org/wiki/SOAP">SOAP</a>, <a class="orm:hideurl" href="http://xmlrpc.com">XML-RPC</a>, <a class="orm:hideurl" href="https://dotnet.microsoft.com/en-us/learn/dotnet/what-is-dotnet">.NET</a>, <a class="orm:hideurl" href="https://grpc.io">gRPC</a>, etc.) can make IPC a bit easier, whether locally or remotely; however, we do not cover distributed computing in this book.</p>
<p>When multiprocessor computers arrived, the OS had to deal with more complex scheduling problems, and programmers who wanted maximum performance had to write their applications so that code could truly be executed in parallel, on different processors or cores (from the programming point of view, cores are simply processors implemented on the same piece of silicon). This requires both knowledge and discipline. The CPython implementation simplifies these issues by implementing a<a contenteditable="false" data-primary="global interpreter lock (GIL)" data-type="indexterm" id="idm44924506349536"/><a contenteditable="false" data-primary="GIL (global interpreter lock)" data-type="indexterm" id="idm44924506348464"/> <em>global interpreter lock</em> (GIL). In the absence of any action by the Python programmer, on CPython only the thread that holds the GIL is allowed access to the processor, effectively barring CPython processes from taking full advantage of multiprocessor hardware. Libraries such as <a href="https://numpy.org">NumPy</a>, which are typically required to undertake lengthy computations of compiled code that uses none of the interpreter’s facilities, arrange for their code to release the GIL during such computations. This allows effective use of multiple processors, but it isn’t a technique that you can use if all your code is in pure Python.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="should_you_use_threadingcomma_multiproc">
<h5>Threading, Multiprocessing, or Async Programming?</h5>
<p>In<a contenteditable="false" data-primary="threads and processes" data-secondary="selecting the best approach" data-type="indexterm" id="idm44924506344128"/> many cases, the best answer is “none of the above!” Each of these approaches is, at best, an optimization, and (as covered in <a data-type="xref" href="ch17.xhtml#optimization">“Optimization”</a>) optimization is often unneeded, or at least premature. Each such approach can be prone to bugs and hard to test and debug; stick with single threading as long as you possibly can, and keep things simple.</p>
<p>When you <em>do</em> need optimization, and your program is<a contenteditable="false" data-primary="programs" data-secondary="I/O-bound programs" data-type="indexterm" id="idm44924506340416"/><a contenteditable="false" data-primary="I/O-bound programs" data-type="indexterm" id="idm44924506339008"/> <em>I/O-bound</em> (meaning that it spends much time doing I/O), async programming is fastest, as long as you can make your I/O operations<a contenteditable="false" data-primary="nonblocking operations" data-type="indexterm" id="idm44924506337184"/> <em>nonblocking</em> ones. Second best, when your I/O absolutely <em>has</em> to be blocking, the <span class="code">threading</span> module can help an I/O-bound program’s <span class="keep-together">performance</span>.</p>
<p>When your program is<a contenteditable="false" data-primary="CPU-bound programs" data-type="indexterm" id="idm44924506333040"/><a contenteditable="false" data-primary="programs" data-secondary="CPU-bound programs" data-type="indexterm" id="idm44924506331936"/> <em>CPU-bound</em> (meaning that it spends much time performing computations), in CPython <span class="code">threading</span> usually does not help performance. This is because the GIL ensures that only one Python-coded thread at a time can execute (this also applies to <a href="https://www.pypy.org">PyPy</a>). C-coded extensions can “release the GIL” while they’re doing a time-consuming operation; NumPy (covered in <a data-type="xref" href="ch16.xhtml#numeric_processing">Chapter 16</a>) does so for array operations, for example. As a consequence, if your program is CPU-bound via calls to lengthy CPU operations in NumPy or other similarly optimized C-coded extension, the <span class="code">threading</span> module may help your program’s performance on a multiprocessor computer (as most computers are today).</p>
<p>When your program is CPU-bound via pure Python code and you’re using CPython or PyPy on a multiprocessor computer, the <span class="code">multiprocessing</span> module may help performance by allowing truly parallel computation. To solve problems across multiple network-connected computers (implementing distributed computing), however, you should look at the more specialized approaches and packages discussed on the <a href="https://oreil.ly/N7PHZ">Python wiki</a>, which we don’t cover in this book.<a contenteditable="false" data-primary="" data-startref="distcomp15" data-type="indexterm" id="idm44924506324864"/></p>
</div></aside>
<section data-pdf-bookmark="Threads in Python" data-type="sect1"><div class="sect1" id="threads_in_python">
<h1>Threads in Python</h1>
<p>Python<a contenteditable="false" data-primary="threads and processes" data-secondary="threads in Python" data-type="indexterm" id="idm44924506321536"/> supports multithreading on platforms that support threads, such as Windows, Linux, and just about all variants of Unix (including macOS). An action is known as<a contenteditable="false" data-primary="atomic actions" data-type="indexterm" id="idm44924506320032"/> <em>atomic</em> when it’s guaranteed that no thread switching occurs between the start and the end of the action. In practice, in CPython, operations that <em>look</em> atomic (e.g., simple assignments and accesses) mostly <em>are</em> atomic, but only when executed on built-in types (augmented and multiple assignments, however, aren’t atomic). Mostly, though, it’s <em>not</em> a good idea to rely on such “atomicity.” You might be dealing with an instance of a user-coded class rather than of a built-in type, in which there might be implicit calls to Python code that invalidate assumptions of atomicity. Further, relying on implementation-dependent atomicity may lock your code into a specific implementation, hampering future changes. You’re better-advised to use the synchronization facilities covered in the rest of this chapter, rather than relying on atomicity assumptions.</p>
<p>The key design issue in multithreading systems is how best to coordinate multiple threads. The <span class="code">threading</span> module, covered in the following section, supplies several synchronization objects. The <span class="code">queue</span> module (discussed in <a data-type="xref" href="#the_queue_module">“The queue Module”</a>) is also very useful for thread synchronization: it supplies synchronized, thread-safe queue types, handy for communication and coordination between threads. The package <span class="code">concurrent</span> (covered in <a data-type="xref" href="#the_concurrentdotfutures_module">“The concurrent.futures Module”</a>) supplies a unified interface for communication and coordination that can be implemented by pools of either threads or processes.</p>
</div></section>
<section data-pdf-bookmark="The threading Module" data-type="sect1"><div class="sect1" id="the_threading_module">
<h1>The threading Module</h1>
<p>The<a contenteditable="false" data-primary="standard library modules" data-secondary="threading" data-type="indexterm" id="idm44924506309536"/><a contenteditable="false" data-primary="threads and processes" data-secondary="threading module" data-type="indexterm" id="TAPthmod15"/><a contenteditable="false" data-primary="threading module" data-type="indexterm" id="thmod15"/> <span class="code">threading</span> module supplies multithreading functionality. The approach of <span class="code">threading</span> is to model locks and conditions as separate objects (in Java, for example, such functionality is part of every object), and threads cannot be directly controlled from the outside (thus, no priorities, groups, destruction, or stopping). All methods of objects supplied by <span class="code">threading</span> are atomic.</p>
<p><span class="code">threading</span> supplies the following thread-focused classes, all of which we’ll explore in this section: <span class="code">Thread</span>, <span class="code">Condition</span>, <span class="code">Lock</span>, <span class="code">RLock</span>, <span class="code">Event</span>, <span class="code">Semaphore</span>, <span class="code">BoundedSemaphore</span>, <span class="code">Timer</span>, and <span class="code">Barrier</span>.</p>
<p><span class="code">threading</span> also supplies a number of useful<a contenteditable="false" data-primary="threading module" data-secondary="functions of" data-type="indexterm" id="idm44924506294320"/> functions, including those listed in <a data-type="xref" href="#functions_of_the_threading_module">Table 15-1</a>.</p>
<table class="border" id="functions_of_the_threading_module">
<caption><span class="label">Table 15-1. </span>Functions of the <span class="code">threading</span> module</caption>
<tbody>
<tr>
<td class="width-15"><span class="code">active_count</span></td>
<td><span class="code">active_count()</span><br/>
			Returns an <span class="code">int</span>, the number of <span class="code">Thread</span> objects currently alive (not ones that have terminated or not yet started).</td>
</tr>
<tr>
<td><span class="code">c⁠u⁠r⁠r⁠e⁠n⁠t⁠_​t⁠h⁠r⁠e⁠a⁠d</span></td>
<td><span class="code">current_thread()</span><br/>
			Returns a <span class="code">Thread</span> object for the calling thread. If the calling thread was not created by <span class="code">threading</span>, <span class="code">current_thread</span> creates and returns a semi-dummy <span class="code">Thread</span> object with limited functionality.</td>
</tr>
<tr>
<td><span class="code">enumerate</span></td>
<td><span class="code">enumerate()</span><br/>
			Returns a <span class="code">list</span> of all <span class="code">Thread</span> objects currently alive (not ones that have terminated or not yet started).</td>
</tr>
<tr>
<td><span class="code">excepthook</span></td>
<td><span class="code">excepthook(args)</span><br/>
<span class="version">3.8+</span> Override this function to determine how in-thread exceptions are handled; see the <a href="https://oreil.ly/ylw7S">online docs</a> for details. The <span class="code">args</span> argument has attributes that allow you to access exception and thread details. <span class="version">3.10+</span> <span class="code">threading.__excepthook__</span> holds the module’s original <span class="code">threadhook</span> value.</td>
</tr>
<tr>
<td><span class="code">get_ident</span></td>
<td><span class="code">get_ident()</span><br/>
			Returns a nonzero <span class="code">int</span> as a unique identifier among all current threads. Useful to manage and track data by thread. Thread identifiers may be reused as threads exit and new threads are created.</td>
</tr>
<tr>
<td><span class="code">get_native_id</span></td>
<td><span class="code">get_native_id()</span><br/>
<span class="version">3.8+</span> Returns the native integer ID of the current thread as assigned by the operating system kernel. Available on most common operating systems.</td>
</tr>
<tr>
<td><span class="code">stack_size</span></td>
<td><span class="code">stack_size([<em>size</em>])</span><br/>
			Returns the current stack size, in bytes, used for new threads, and (when <span class="code"><em>size</em></span> is provided) establishes the value for new threads. Acceptable values for <span class="code"><em>size</em></span> are subject to platform-specific constraints, such as being at least <span class="code">32768</span> (or an even higher minimum, on some platforms), and (on some platforms) being a multiple of <span class="code">4096</span>. Passing <span class="code"><em>size</em></span> as <span class="code">0</span> is always acceptable and means “use the system’s default.” When you pass a value for <span class="code"><em>size</em></span> that is not acceptable on the current platform, <span class="code">stack_size</span> raises a <span class="code">ValueError</span> exception.</td>
</tr>
</tbody>
</table>
<section data-pdf-bookmark="Thread Objects" data-type="sect2"><div class="sect2" id="thread_objects">
<h2>Thread Objects</h2>
<p>A<a contenteditable="false" data-primary="threading module" data-secondary="Thread class" data-type="indexterm" id="idm44924506250176"/> <span class="code">Thread</span> instance <span class="code"><em>t</em></span> models a thread. You can pass a function to be used as <span class="code"><em>t</em></span>’s main function as the <span class="code"><em>target</em></span> argument when you create <span class="code"><em>t</em></span>, or you can subclass <span class="code">Thread</span> and override its <span class="code">run</span> method (you may also override <span class="code">__init__</span>, but you should not override other methods). <span class="code"><em>t</em></span> is not yet ready to run when you create it; to make <span class="code"><em>t</em></span> ready (active), call <span class="code"><em>t</em></span><span class="code">.start</span>. Once <span class="code"><em>t</em></span> is active, it terminates when its main function ends, either normally or by propagating an exception. A <span class="code">Thread</span> <span class="code"><em>t</em></span> can be a <em>daemon</em>, meaning that Python can terminate even if <span class="code"><em>t</em></span> is still active, while a normal (nondaemon) thread keeps Python alive until the thread terminates. The <span class="code">Thread</span> class supplies the constructor, properties, and methods detailed in <a data-type="xref" href="#constructorcomma_methodscomma_and_prop">Table 15-2</a>.</p>
<table class="border" id="constructorcomma_methodscomma_and_prop">
<caption><span class="label">Table 15-2. </span>Constructor, methods, and properties of the <span class="code">Thread</span> class</caption>
<tbody>
<tr>
<td><span class="code">Thread</span></td>
<td><span class="code"><strong>class</strong></span> <span class="code">Thread(name=<strong>None</strong>, target=<strong>None</strong>, args=(), kwargs={}, *,<br/> daemon=<strong>None</strong>)</span><br/>
<em>Always call</em> <span class="code"><em>Thread</em></span> <em>with named arguments</em>: the<a contenteditable="false" data-primary="Thread class (threading module)" data-type="indexterm" id="idm44924506223616"/> number and order of parameters is not guaranteed by the specification, but the parameter names are. You have two options when constructing a <span class="code">Thread</span>:
			<ul>
<li>Instantiate the class <span class="code">Thread</span> itself with a <span class="code">target</span> function (<span class="code"><em>t</em></span><span class="code">.run</span> then calls <span class="code"><em>target</em></span><span class="code">(*<em>args</em>, **<em>kwargs</em>)</span> when the thread is started).</li>
<li>Extend the <span class="code">Thread</span> class and override its <span class="code">run</span> method.</li>
</ul>
			In either case, execution will begin only when you call <span class="code"><em>t</em></span><span class="code">.start</span>. <span class="code">name</span> becomes <span class="code"><em>t</em></span>’s name. If <span class="code">name</span> is <span class="code"><strong>None</strong></span>, <span class="code">Thread</span> generates a unique name for <span class="code"><em>t</em></span>. If a subclass <span class="code"><em>T</em></span> of <span class="code">Thread</span> overrides <span class="code">__init__</span>, <span class="code"><em>T</em></span>.<span class="code">__init__</span> <em>must</em> call <span class="code">Thread.__init__</span> on <span class="code">self</span> (usually via the <span class="code">super</span> built-in function) before any other <span class="code">Thread</span> method. <span class="code">daemon</span> can be assigned a Boolean value or, if <span class="code"><strong>None</strong></span>, will take this value from the <span class="code">daemon</span> attribute of the creating thread.</td>
</tr>
<tr>
<td><span class="code">daemon</span></td>
<td><span class="code">daemon</span> is a writable Boolean property that indicates whether <span class="code"><em>t</em></span> is a daemon (i.e., the process can terminate even when <span class="code"><em>t</em></span> is still active; such a termination also ends <span class="code"><em>t</em></span>). You can assign to <span class="code"><em>t</em></span><span class="code">.daemon</span> only before calling <span class="code"><em>t</em></span><span class="code">.start</span>; assigning a true value sets <span class="code"><em>t</em></span> to be a daemon. Threads created by a daemon thread have <span class="code"><em>t</em></span><span class="code">.daemon</span> set to <span class="code"><strong>True</strong></span> by default.</td>
</tr>
<tr>
<td><span class="code">is_alive</span></td>
<td><span class="code"><em>t</em></span><span class="code">.is_alive()</span><br/>
<span class="code">is_alive</span> returns <span class="code"><strong>True</strong></span> when <span class="code"><em>t</em></span> is active (i.e., when <span class="code"><em>t</em></span><span class="code">.start</span> has executed and <span class="code"><em>t</em></span><span class="code">.run</span> has not yet terminated); otherwise, returns <span class="code"><strong>False</strong></span>.</td>
</tr>
<tr>
<td><span class="code">join</span></td>
<td><span class="code"><em>t</em></span><span class="code">.join(timeout=<strong>None</strong>)</span><br/>
<span class="code">join</span> suspends the calling thread (which must not be <span class="code"><em>t</em></span>) until <span class="code"><em>t</em></span> terminates (when <span class="code"><em>t</em></span> is already terminated, the calling thread does not suspend). <span class="code">timeout</span> is covered in <a data-type="xref" href="#timeout_parameters">“Timeout parameters”</a>. You can call <span class="code"><em>t</em></span><span class="code">.join</span> only after <span class="code"><em>t</em></span><span class="code">.start</span>. It’s OK to call <span class="code">join</span> more than once.</td>
</tr>
<tr>
<td><span class="code">name</span></td>
<td><span class="code"><em>t</em></span><span class="code">.name</span><br/>
<span class="code">name</span> is a property returning <span class="code"><em>t</em></span>’s name; assigning <span class="code">name</span> rebinds <span class="code"><em>t</em></span>’s name (<span class="code">name</span> exists only to help you debug; <span class="code">name</span> need not be unique among threads). If omitted, the thread will receive a generated name <span class="code">Thread-</span><span class="code"><em>n</em></span>, where <span class="code"><em>n</em></span> is an incrementing integer (<span class="version">3.10+</span> and if <span class="code">target</span> is specified, <span class="code">(target.__name__)</span> will be appended).</td>
</tr>
<tr>
<td><span class="code">run</span></td>
<td><span class="code"><em>t</em></span><span class="code">.run()</span><br/>
<span class="code">run</span> is the method called by <span class="code"><em>t</em></span><span class="code">.start</span> that executes <span class="code"><em>t</em></span>’s main function. Subclasses of <span class="code">Thread</span> can override <span class="code">run</span>. Unless overridden, <span class="code">run</span> calls the <span class="code"><em>target</em></span> callable passed on <span class="code"><em>t</em></span>’s creation. Do <em>not</em> call <span class="code"><em>t</em></span><span class="code">.run</span> directly; calling <span class="code"><em>t</em></span><span class="code">.run</span> is the job of <span class="code"><em>t</em></span><span class="code">.start</span>!</td>
</tr>
<tr>
<td><span class="code">start</span></td>
<td><span class="code"><em>t</em></span><span class="code">.start()</span><br/>
<span class="code">start</span> makes <span class="code"><em>t</em></span> active and arranges for <span class="code"><em>t</em></span><span class="code">.run</span> to execute in a separate thread. You must call <span class="code"><em>t</em></span><span class="code">.start</span> only once for any given <span class="code">Thread</span> object <span class="code"><em>t</em></span>; calling it again raises an exception.</td>
</tr>
</tbody>
</table>
</div></section>
<section data-pdf-bookmark="Thread Synchronization Objects" data-type="sect2"><div class="sect2" id="thread_synchronization_objects">
<h2>Thread Synchronization Objects</h2>
<p>The <span class="code">threading</span> module<a contenteditable="false" data-primary="threading module" data-secondary="thread synchronization objects" data-type="indexterm" id="idm44924506126768"/><a contenteditable="false" data-primary="synchronization objects (threads)" data-type="indexterm" id="synobj15"/> supplies several synchronization primitives (types that let threads communicate and coordinate). Each primitive type has specialized uses, discussed in the following sections.</p>
<div data-type="tip">
<h1>You May Not Need Thread Synchronization Primitives</h1>
<p>As long as you avoid having (nonqueue) global variables that change and which several threads access, <span class="code">queue</span> (covered in <a data-type="xref" href="#the_queue_module">“The queue Module”</a>) can often provide all the coordination you need, as can <span class="code">concurrent</span> (covered in <a data-type="xref" href="#the_concurrentdotfutures_module">“The concurrent.futures Module”</a>). <a data-type="xref" href="#threaded_program_architecture">“Threaded Program Architecture”</a> shows how to use <span class="code">Queue</span> objects to give your multithreaded programs simple and effective architectures, often without needing any explicit use of synchronization primitives.</p>
</div>
<section data-pdf-bookmark="Timeout parameters" data-type="sect3"><div class="sect3" id="timeout_parameters">
<h3>Timeout parameters</h3>
<p>The synchronization primitives <span class="code">Condition</span> and <span class="code">Event</span> supply <span class="code">wait</span> methods that accept an optional <span class="code">timeout</span> argument. A <span class="code">Thread</span> object’s <span class="code">join</span> method also accepts an optional <span class="code">timeout</span> argument (see <a data-type="xref" href="#constructorcomma_methodscomma_and_prop">Table 15-2</a>). Using the default <span class="code">timeout</span> value of <span class="code"><strong>None</strong></span> results in normal blocking behavior (the calling thread suspends and waits until the desired condition is met). When it is not <span class="code"><strong>None</strong></span>, a <span class="code">timeout</span> argument is a floating-point value that indicates an interval of time, in seconds (<span class="code">timeout</span> can have a fractional part, so it can indicate any time interval, even a very short one). When <span class="code">timeout</span> seconds elapse, the calling thread becomes ready again, even if the desired condition has not been met; in this case, the waiting method returns <span class="code"><strong>False</strong></span> (otherwise, the method returns <span class="code"><strong>True</strong></span>). <span class="code">timeout</span> lets you design systems that are able to overcome occasional anomalies in a few threads, and thus are more robust. However, using <span class="code">timeout</span> may slow your program down: when that matters, be sure to measure your code’s speed accurately.</p>
</div></section>
<section data-pdf-bookmark="Lock and RLock objects" data-type="sect3"><div class="sect3" id="lock_and_rlock_objects">
<h3>Lock and RLock objects</h3>
<p><span class="code">Lock</span> and <span class="code">RLock</span> objects<a contenteditable="false" data-primary="Lock objects" data-type="indexterm" id="idm44924506097184"/><a contenteditable="false" data-primary="Lock (threading module)" data-type="indexterm" id="locktm15"/> supply the same three methods, described in <a data-type="xref" href="#methods_of_an_instance_l_of_lock">Table 15-3</a>.</p>
<table class="border" id="methods_of_an_instance_l_of_lock">
<caption><span class="label">Table 15-3. </span>Methods of an instance <span class="code">L</span> of <span class="code">Lock</span></caption>
<tbody>
<tr>
<td><span class="code">acquire</span></td>
<td><span class="code"><em>L</em></span><span class="code">.acquire(blocking=<strong>True</strong>, timeout=-1)</span><br/>
			When<a contenteditable="false" data-primary="acquire (threading module)" data-type="indexterm" id="idm44924506086704"/> <span class="code"><em>L</em></span> is unlocked, or if <span class="code"><em>L</em></span> is an <span class="code">RLock</span> acquired by the same thread that’s calling <span class="code">acquire</span>, this thread immediately locks it (incrementing the internal counter if <span class="code"><em>L</em></span> is an <span class="code">RLock</span>, as described shortly) and returns <span class="code"><strong>True</strong></span>.<br/>
			When <span class="code"><em>L</em></span> is already locked and <span class="code">blocking</span> is <span class="code"><strong>False</strong></span>, <span class="code">acquire</span> immediately returns <span class="code"><strong>False</strong></span>. When <span class="code">blocking</span> is <span class="code"><strong>True</strong></span>, the calling thread is suspended until either:
			<ul>
<li>Another thread releases the lock, in which case this thread locks it and returns <span class="code"><strong>True</strong></span>.</li>
<li>The operation times out before the lock can be acquired, in which case <span class="code">acquire</span> returns <span class="code"><strong>False</strong></span>. The default <span class="code">-1</span> value never times out.</li>
</ul>
</td>
</tr>
<tr>
<td><span class="code">locked</span></td>
<td><span class="code"><em>L</em></span><span class="code">.locked()</span><br/>
			Returns<a contenteditable="false" data-primary="locked (threading module)" data-type="indexterm" id="idm44924506066096"/> <span class="code"><strong>True</strong></span> when <span class="code"><em>L</em></span> is locked; otherwise, returns <span class="code"><strong>False</strong></span>.</td>
</tr>
<tr>
<td><span class="code">release</span></td>
<td><span class="code"><em>L.</em></span><span class="code">release()</span><br/>
			Unlocks <span class="code"><em>L</em></span>, which<a contenteditable="false" data-primary="release (threading module)" data-type="indexterm" id="idm44924506058176"/> must be locked (for an <span class="code">RLock</span>, this means to decrement the lock count, which cannot go below zero—the lock can only be acquired by a new thread when the lock count is zero). When <span class="code"><em>L</em></span> is locked, any thread may call <span class="code"><em>L</em></span><span class="code">.release</span>, not just the thread that locked <span class="code"><em>L</em></span>. When more than one thread is blocked on <span class="code"><em>L</em></span> (i.e., has called <span class="code"><em>L</em></span><span class="code">.acquire</span>, found <span class="code"><em>L</em></span> locked, and is waiting for <span class="code"><em>L</em></span> to be unlocked), <span class="code">release</span> wakes up an arbitrary one of the waiting threads. The thread calling <span class="code">release</span> does not suspend: it remains ready and continues to execute.</td>
</tr>
</tbody>
</table>
<p>The following console session illustrates the automatic <span class="code">acquire</span>/<span class="code">release</span> done on locks when they are used as a context manager (as well as other data Python maintains for the lock, such as the owner thread ID and the number of times the lock’s <span class="code">acquire</span> method has been called):</p>
<pre data-code-language="python" data-type="programlisting">
<code class="o">&gt;&gt;&gt;</code> <code class="n">lock</code> <code class="o">=</code> <code class="n">threading</code><code class="o">.</code><code class="n">RLock</code><code class="p">()</code>
<code class="o">&gt;&gt;&gt;</code> <code class="nb">print</code><code class="p">(</code><code class="n">lock</code><code class="p">)</code></pre>
<pre data-type="programlisting">
<strong>&lt;unlocked _thread.RLock object owner=0 count=0 at 0x102878e00&gt;</strong></pre>
<pre data-code-language="python" data-type="programlisting">
<code class="o">&gt;&gt;</code><code class="o">&gt;</code><code> </code><strong><code class="k">with</code></strong><code> </code><code class="n">lock</code><code class="p">:</code><code>
</code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code>     </code><code class="nb">print</code><code class="p">(</code><code class="n">lock</code><code class="p">)</code><code>
</code><code class="o">.</code><code class="o">.</code><code class="o">.</code></pre>
<pre data-type="programlisting">
<strong>&lt;locked _thread.RLock object owner=4335175040 count=1 at 0x102878e00&gt;</strong></pre>
<pre data-code-language="python" data-type="programlisting">
<code class="o">&gt;&gt;&gt;</code> <code class="nb">print</code><code class="p">(</code><code class="n">lock</code><code class="p">)</code></pre>
<pre data-type="programlisting">
<strong>&lt;unlocked _thread.RLock object owner=0 count=0 at 0x102878e00&gt;</strong></pre>
<p>The semantics of an <span class="code">RLock</span> object <span class="code"><em>r</em></span> are often more convenient (except in peculiar architectures where you need threads to be able to release locks that a different thread has acquired). <span class="code">RLock</span> is a<a contenteditable="false" data-primary="reentrant locks" data-type="indexterm" id="idm44924505953632"/> <em>reentrant</em> lock, meaning that when <span class="code"><em>r</em></span> is locked, it keeps track of the<a contenteditable="false" data-primary="owning threads" data-type="indexterm" id="idm44924505951072"/> <em>owning</em> thread (i.e., the thread that locked it, which for an <span class="code">RLock</span> is also the only thread that can release it—when any other thread tries to release an <span class="code">RLock</span>, this raises a <span class="code">RuntimeError</span> exception). The owning thread can call <span class="code"><em>r</em></span><span class="code">.acquire</span> again without blocking; <span class="code"><em>r</em></span> then just increments an internal count. In a similar situation involving a <span class="code">Lock</span> object, the thread would block until some other thread releases the lock. For example, consider the following code snippet:</p>
<pre data-code-language="python" data-type="programlisting">
<code class="n">lock</code><code> </code><code class="o">=</code><code> </code><code class="n">threading</code><code class="o">.</code><code class="n">RLock</code><code class="p">(</code><code class="p">)</code><code>
</code><code class="n">global_state</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="p">]</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">recursive_function</code><code class="p">(</code><code class="n">some</code><code class="p">,</code><code> </code><code class="n">args</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><strong><code class="k">with</code></strong><code> </code><code class="n">lock</code><code class="p">:</code><code>  </code><em><code class="c1"># acquires lock, guarantees release at end</code></em><code>
</code><code>        </code><em><code class="c1"># ...modify global_state...</code></em><code>
</code><code>        </code><strong><code class="k">if</code></strong><code> </code><code class="n">more_changes_needed</code><code class="p">(</code><code class="n">global_state</code><code class="p">)</code><code class="p">:</code><code>
</code><code>            </code><code class="n">recursive_function</code><code class="p">(</code><code class="n">other</code><code class="p">,</code><code> </code><code class="n">args</code><code class="p">)</code></pre>
<p>If <span class="code">lock</span> was an instance of <span class="code">threading.Lock</span>, <span class="code">recursive_function</span> would block its calling thread when it calls itself recursively: the <span class="code"><strong>with</strong></span> statement, finding that the lock has already been acquired (even though that was done by the same thread), would block and wait…and wait. With a <span class="code">threading.RLock</span>, no such problem occurs: in this case, since the lock has already been acquired <em>by the same thread</em>, on getting acquired again it just increments its internal count and proceeds.</p>
<p>An <span class="code">RLock</span> object <span class="code"><em>r</em></span> is unlocked only when it has been released as many times as it has been acquired. An <span class="code">RLock</span> is useful to ensure exclusive access to an object when the object’s methods call each other; each method can acquire at the start, and release at the end, the same <span class="code">RLock</span> instance.</p>
<div data-type="tip">
<h1>Use with Statements to Automatically Acquire and Release Synchronization Objects</h1>
<p>Using a <span class="code"><strong>try</strong></span><span class="code">/</span><span class="code"><strong>finally</strong></span> statement (covered in <a data-type="xref" href="ch06.xhtml#trysolidusfinally">“try/finally”</a>) is one way to ensure that an acquired lock is indeed released. Using a <span class="code"><strong>with</strong></span> statement, covered in <a data-type="xref" href="ch06.xhtml#the_with_statement_and_context_managers">“The with Statement and Context Managers”</a>, is usually better: all locks, conditions, and semaphores are context managers, so an instance of any of these types can be used directly in a <span class="code"><strong>with</strong></span> clause to acquire it (implicitly with blocking) and ensure it is released at the end of the <span class="code"><strong>with</strong></span> block.<a contenteditable="false" data-primary="" data-startref="synobj15" data-type="indexterm" id="idm44924505840176"/></p>
</div>
</div></section>
<section data-pdf-bookmark="Condition objects" data-type="sect3"><div class="sect3" id="condition_objects">
<h3>Condition objects</h3>
<p>A<a contenteditable="false" data-primary="Condition objects" data-type="indexterm" id="idm44924505836896"/> <span class="code">Condition</span> object <span class="code"><em>c</em></span> wraps a <span class="code">Lock</span> or <span class="code">RLock</span> object <span class="code"><em>L</em></span>. The class <span class="code">Condition</span> exposes the constructor and methods described in <a data-type="xref" href="#constructor_and_methods_of_the_conditio">Table 15-4</a>.</p>
<table class="border" id="constructor_and_methods_of_the_conditio">
<caption><span class="label">Table 15-4. </span>Constructor and methods of the <span class="code">Condition</span> class</caption>
<tbody>
<tr>
<td><span class="code">Condition</span></td>
<td><span class="code"><strong>class</strong></span> <span class="code">Condition(lock=<strong>None</strong>)</span><br/>
			Creates<a contenteditable="false" data-primary="Condition (threading module)" data-type="indexterm" id="idm44924505823648"/> and returns a new <span class="code">Condition</span> object <span class="code"><em>c</em></span> with the lock <span class="code"><em>L</em></span> set to <span class="code">lock</span>. If <span class="code">lock</span> is <span class="code"><strong>None</strong></span>, <span class="code"><em>L</em></span> is set to a newly created <span class="code">RLock</span> object.</td>
</tr>
<tr>
<td><span class="code">acquire</span>,<br/>
<span class="code">release</span></td>
<td><span class="code"><em>c</em></span><span class="code">.acquire(blocking=<strong>True</strong>)</span>, <span class="code"><em>c</em></span><span class="code">.release()</span><br/>
			These<a contenteditable="false" data-primary="acquire (threading module)" data-type="indexterm" id="idm44924505810256"/><a contenteditable="false" data-primary="release (threading module)" data-type="indexterm" id="idm44924505809184"/> methods just call <span class="code"><em>L</em></span>’s corresponding methods. A thread must never call any other method on <span class="code"><em>c</em></span> unless the thread holds (i.e., has <span class="code">acquire</span>d) lock <span class="code"><em>L</em></span>.</td>
</tr>
<tr>
<td><span class="code">notify</span>,<br/>
<span class="code">notify_all</span></td>
<td><span class="code"><em>c</em></span><span class="code">.notify()</span>,<span class="code"> </span> <span class="code"><em>c</em></span><span class="code">.notify_all()</span><br/>
<span class="code">notify</span><a contenteditable="false" data-primary="notify (threading module)" data-type="indexterm" id="idm44924505797632"/> wakes up an arbitrary one of the threads waiting on <span class="code"><em>c</em></span>. The calling thread must hold <span class="code"><em>L</em></span> before it calls <span class="code"><em>c</em></span><span class="code">.notify</span>, and <span class="code">notify</span> does not release <span class="code"><em>L</em></span>. The awakened thread does not become ready until it can acquire <span class="code"><em>L</em></span> again. Therefore, the calling thread normally calls <span class="code">release</span> after calling <span class="code">notify</span>. <span class="code">notify_all</span> is like <span class="code">notify</span>, but wakes up <em>all</em> waiting threads, not just one.</td>
</tr>
<tr>
<td><span class="code">wait</span></td>
<td><span class="code"><em>c</em></span><span class="code">.wait(timeout=<strong>None</strong>)</span><br/>
<span class="code">wait</span><a contenteditable="false" data-primary="wait (threading module)" data-type="indexterm" id="idm44924505783440"/> releases <span class="code"><em>L</em></span>, then suspends the calling thread until some other thread calls <span class="code">notify</span> or <span class="code">notify_all</span> on <span class="code"><em>c</em></span>. The calling thread must hold <span class="code"><em>L</em></span> before it calls <span class="code"><em>c</em></span><span class="code">.wait</span>. <span class="code">timeout</span> is covered in <a data-type="xref" href="#timeout_parameters">“Timeout parameters”</a>. After a thread wakes up, either by notification or timeout, the thread becomes ready when it acquires <span class="code"><em>L</em></span> again. When <span class="code">wait</span> returns <span class="code"><strong>True</strong></span> (meaning it has exited normally, not by timeout), the calling thread is always holding <span class="code"><em>L</em></span> again.<a contenteditable="false" data-primary="" data-startref="locktm15" data-type="indexterm" id="idm44924505771696"/></td>
</tr>
</tbody>
</table>
<p>Usually, a <span class="code">Condition</span> object <span class="code"><em>c</em></span> regulates access to some global state <span class="code"><em>s</em></span> shared among threads. When a thread must wait for <span class="code"><em>s</em></span> to change, the thread loops:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="k">with</code></strong><code> </code><em><code class="n">c</code></em><code class="p">:</code><code>
</code><code>    </code><strong><code class="k">while</code><code> </code><code class="ow">not</code></strong><code> </code><code class="n">is_ok_state</code><code class="p">(</code><code class="n">s</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><em><code class="n">c</code></em><code class="o">.</code><code class="n">wait</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="n">do_some_work_using_state</code><code class="p">(</code><code class="n">s</code><code class="p">)</code></pre>
<p>Meanwhile, each thread that modifies <span class="code"><em>s</em></span> calls <span class="code">notify</span> (or <span class="code">notify_all</span> if it needs to wake up all waiting threads, not just one) each time <span class="code"><em>s</em></span> changes:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="k">with</code></strong><code> </code><em><code class="n">c</code></em><code class="p">:</code><code>
</code><code>    </code><code class="n">do_something_that_modifies_state</code><code class="p">(</code><em><code class="n">s</code></em><code class="p">)</code><code>
</code><code>    </code><em><code class="n">c</code></em><code class="o">.</code><code class="n">notify</code><code class="p">(</code><code class="p">)</code><code>    </code><em><code class="c1"># or, c.notify_all()</code></em><code>
</code><em><code class="c1"># no need to call c.release(), exiting 'with' intrinsically does that</code></em></pre>
<p>You must always acquire and release <span class="code"><em>c</em></span> around each use of <span class="code"><em>c</em></span>’s methods: doing so via a <span class="code"><strong>with</strong></span> statement makes using <span class="code">Condition</span> instances less error prone.</p>
</div></section>
<section data-pdf-bookmark="Event objects" data-type="sect3"><div class="sect3" id="event_objects">
<h3>Event objects</h3>
<p><span class="code">Event</span> objects<a contenteditable="false" data-primary="Event objects" data-type="indexterm" id="idm44924505696592"/> let any number of threads suspend and wait. All threads waiting on <span class="code">Event</span> object <span class="code"><em>e</em></span> become ready when any other thread calls <span class="code"><em>e</em></span><span class="code">.set</span>. <span class="code"><em>e</em></span> has a flag that records whether the event happened; it is initially <span class="code"><strong>False</strong></span> when <span class="code"><em>e</em></span> is created. <span class="code">Event</span> is thus a bit like a simplified <span class="code">Condition</span>. <span class="code">Event</span> objects are useful to signal one-shot changes, but brittle for more general use; in particular, relying on calls to <span class="code"><em>e</em></span><span class="code">.clear</span> is error prone. The <span class="code">Event</span> class exposes the constructor and methods in <a data-type="xref" href="#constructor_and_methods_of_the_event_cl">Table 15-5</a>.</p>
<table class="border" id="constructor_and_methods_of_the_event_cl">
<caption><span class="label">Table 15-5. </span>Constructor and methods of the <span class="code">Event</span> class</caption>
<tbody>
<tr>
<td><span class="code">Event</span></td>
<td><span class="code"><strong>class</strong></span> <span class="code">Event()</span><br/>
			Creates<a contenteditable="false" data-primary="Event (threading module)" data-type="indexterm" id="idm44924505657056"/> and returns a new <span class="code">Event</span> object <span class="code"><em>e</em></span>, with <span class="code"><em>e</em></span>’s flag set to <span class="code"><strong>False</strong></span>.</td>
</tr>
<tr>
<td><span class="code">clear</span></td>
<td><span class="code"><em>e</em></span><span class="code">.clear()</span><br/>
			Sets<a contenteditable="false" data-primary="clear (threading module)" data-type="indexterm" id="idm44924505649568"/> <span class="code"><em>e</em></span>’s flag to <span class="code"><strong>False</strong></span>.</td>
</tr>
<tr>
<td><span class="code">is_set</span></td>
<td><span class="code"><em>e</em></span><span class="code">.is_set()</span><br/>
			Returns the value of <span class="code"><em>e</em></span>’s flag: <span class="code"><strong>True</strong></span> or <span class="code"><strong>False</strong></span>.</td>
</tr>
<tr>
<td><span class="code">set</span></td>
<td><span class="code"><em>e</em></span><span class="code">.set()</span><br/>
			Sets<a contenteditable="false" data-primary="set (threading module)" data-type="indexterm" id="idm44924505637632"/> <span class="code"><em>e</em></span>’s flag to <span class="code"><strong>True</strong></span>. All threads waiting on <span class="code"><em>e</em></span>, if any, become ready to run.</td>
</tr>
<tr>
<td><span class="code">wait</span></td>
<td><span class="code"><em>e</em></span><span class="code">.wait(timeout=<strong>None</strong>)</span><br/>
			Returns<a contenteditable="false" data-primary="wait (threading module)" data-type="indexterm" id="idm44924505630224"/> immediately if <span class="code"><em>e</em></span>’s flag is <span class="code"><strong>True</strong></span>; otherwise, suspends the calling thread until some other thread calls <span class="code">set</span>. <span class="code">timeout</span> is covered in <a data-type="xref" href="#timeout_parameters">“Timeout parameters”</a>.</td>
</tr>
</tbody>
</table>
<p>The following code shows how <span class="code">Event</span> objects explicitly synchronize processing across multiple threads:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">datetime</code><code class="o">,</code><code> </code><code class="nn">random</code><code class="o">,</code><code> </code><code class="nn">threading</code><code class="o">,</code><code> </code><code class="nn">time</code><code>
</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">runner</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">starting</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>    </code><code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="n">random</code><code class="o">.</code><code class="n">randint</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">3</code><code class="p">)</code><code class="p">)</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">waiting</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>    </code><code class="n">event</code><code class="o">.</code><code class="n">wait</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s1">'</code><code class="s1">running at </code><code class="si">{</code><code class="n">datetime</code><code class="o">.</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="p">)</code><code class="si">}</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>
</code><code class="n">num_threads</code><code> </code><code class="o">=</code><code> </code><code class="mi">10</code><code>
</code><code class="n">event</code><code> </code><code class="o">=</code><code> </code><code class="n">threading</code><code class="o">.</code><code class="n">Event</code><code class="p">(</code><code class="p">)</code><code>
</code><code>
</code><code class="n">threads</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="n">threading</code><code class="o">.</code><code class="n">Thread</code><code class="p">(</code><code class="n">target</code><code class="o">=</code><code class="n">runner</code><code class="p">)</code><code> </code><strong><code class="k">for</code></strong><code> </code><code class="n">_</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="nb">range</code><code class="p">(</code><code class="n">num_threads</code><code class="p">)</code><code class="p">]</code><code>
</code><strong><code class="k">for</code></strong><code> </code><code class="n">t</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">threads</code><code class="p">:</code><code>
</code><code>    </code><code class="n">t</code><code class="o">.</code><code class="n">start</code><code class="p">(</code><code class="p">)</code><code>
</code><code>
</code><code class="n">event</code><code class="o">.</code><code class="n">set</code><code class="p">(</code><code class="p">)</code><code>
</code><code>
</code><strong><code class="k">for</code></strong><code> </code><code class="n">t</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">threads</code><code class="p">:</code><code>
</code><code>    </code><code class="n">t</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="p">)</code></pre>
</div></section>
<section data-pdf-bookmark="Semaphore and BoundedSemaphore objects" data-type="sect3"><div class="sect3" id="semaphore_and_boundedsemaphore_objects">
<h3>Semaphore and BoundedSemaphore objects</h3>
<p><em>Semaphores</em> (also known as<a contenteditable="false" data-primary="counting semaphores" data-type="indexterm" id="idm44924505478496"/> <em>counting semaphores</em>)<a contenteditable="false" data-primary="Semaphore objects" data-type="indexterm" id="idm44924505498560"/><a contenteditable="false" data-primary="BoundedSemaphore objects" data-type="indexterm" id="idm44924505497424"/> are a generalization of locks. The state of a <span class="code">Lock</span> can be seen as <span class="code"><strong>True</strong></span> or <span class="code"><strong>False</strong></span>; the state of a <span class="code">Semaphore</span> <span class="code"><em>s</em></span> is a number between <span class="code">0</span> and some <span class="code"><em>n</em></span> set when <span class="code"><em>s</em></span> is created (both bounds included). <span class="code">Semaphore</span>s can be useful to manage a fixed pool of resources—e.g., 4 printers or 20 sockets—although it’s often more robust to use <span class="code">Queue</span>s (described later in this chapter) for such purposes. The class <span class="code">BoundedSemaphore</span> is very similar, but raises <span class="code">ValueError</span> if the state ever becomes higher than the initial value: in many cases, such behavior can be a useful indicator of a bug. <a data-type="xref" href="#constructors_and_methods_of_the_semapho">Table 15-6</a> shows the constructors of the <span class="code">Semaphore</span> and <span class="code">BoundedSemaphore</span> classes and the methods exposed by an object <em>s</em> of either class.</p>
<table class="border" id="constructors_and_methods_of_the_semapho">
<caption><span class="label">Table 15-6. </span>Constructors and methods of the <span class="code">Semaphore</span> and <span class="code">BoundedSemaphore</span> classes</caption>
<tbody>
<tr>
<td><span class="code">Semaphore</span>,<br/>
<span class="code">Boun⁠d⁠e⁠d​S⁠e⁠m⁠aphore</span></td>
<td><span class="code"><strong>class</strong></span> <span class="code">Semaphore(n=1)</span>,<br/>
<span class="code"><strong>class</strong></span> <span class="code">BoundedSemaphore(n=1)</span><br/>
<span class="code">Semaphore</span><a contenteditable="false" data-primary="Semaphore (threading module)" data-type="indexterm" id="idm44924505426736"/> creates and returns a <span class="code">Semaphore</span> object <span class="code"><em>s</em></span> with the state set to <span class="code">n</span>; <span class="code">BoundedSemaphore</span><a contenteditable="false" data-primary="BoundedSemaphore (threading module)" data-type="indexterm" id="idm44924505422656"/> is very similar, except that <span class="code"><em>s</em></span><span class="code">.release</span> raises <span class="code">ValueError</span> if the state becomes higher than <span class="code">n</span>.</td>
</tr>
<tr>
<td><span class="code">acquire</span></td>
<td><span class="code"><em>s</em></span><span class="code">.acquire(blocking=<strong>True</strong>)</span><br/>
			When<a contenteditable="false" data-primary="acquire (threading module)" data-type="indexterm" id="idm44924505414704"/> <span class="code"><em>s</em></span>’s state is <span class="code">&gt;0</span>, <span class="code">acquire</span> decrements the state by <span class="code">1</span> and returns <span class="code"><strong>True</strong></span>. When <span class="code"><em>s</em></span>’s state is <span class="code">0</span> and <span class="code">blocking</span> is <span class="code"><strong>True</strong></span>, <span class="code">acquire</span> suspends the calling thread and waits until some other thread calls <span class="code"><em>s</em></span><span class="code">.release</span>. When <span class="code"><em>s</em></span>’s state is <span class="code">0</span> and <span class="code">blocking</span> is <span class="code"><strong>False</strong></span>, <span class="code">acquire</span> immediately returns <span class="code"><strong>False</strong></span>.</td>
</tr>
<tr>
<td><span class="code">release</span></td>
<td><span class="code"><em>s</em></span><span class="code">.release()</span><br/>
			When<a contenteditable="false" data-primary="release (threading module)" data-type="indexterm" id="idm44924505396864"/> <span class="code"><em>s</em></span>’s state is <span class="code">&gt;0</span>, or when the state is <span class="code">0</span> but no thread is waiting on <span class="code"><em>s</em></span>, <span class="code">release</span> increments the state by <span class="code">1</span>. When <span class="code"><em>s</em></span>’s state is <span class="code">0</span> and some threads are waiting on <span class="code"><em>s</em></span>, <span class="code">release</span> leaves <span class="code"><em>s</em></span>’s state at <span class="code">0</span> and wakes up an arbitrary one of the waiting threads. The thread that calls <span class="code">release</span> does not suspend; it remains ready and continues to execute normally.</td>
</tr>
</tbody>
</table>
</div></section>
<section data-pdf-bookmark="Timer objects" data-type="sect3"><div class="sect3" id="timer_objects">
<h3>Timer objects</h3>
<p>A <span class="code">Timer</span> object calls a specified callable, in a newly made thread, after a given delay. The class <span class="code">Timer</span> exposes the constructor and methods in <a data-type="xref" href="#constructor_and_methods_of_the_timer_cl">Table 15-7</a>.</p>
<table class="border" id="constructor_and_methods_of_the_timer_cl">
<caption><span class="label">Table 15-7. </span>Constructor and methods of the <span class="code">Timer</span> class</caption>
<tbody>
<tr>
<td><span class="code">Timer</span></td>
<td><span class="code"><strong>class</strong></span> <span class="code">Timer(<em>interval</em>,</span> <span class="code"><em>callback</em></span><span class="code">, args=<strong>None</strong>, kwargs=<strong>None</strong>)</span><br/>
			Creates<a contenteditable="false" data-primary="Timer (threading module)" data-type="indexterm" id="idm44924505372672"/> an object <span class="code"><em>t</em></span> that calls <span class="code"><em>callback</em></span><em>,</em> <span class="code"><em>interval</em></span> seconds after starting (<span class="code"><em>interval</em></span> is a floating-point number of seconds).</td>
</tr>
<tr>
<td><span class="code">cancel</span></td>
<td><span class="code"><em>t</em></span><span class="code">.cancel()</span><br/>
			Stops<a contenteditable="false" data-primary="cancel (threading module)" data-type="indexterm" id="idm44924505364624"/> the timer and cancels the execution of its action, as long as <span class="code"><em>t</em></span> is still waiting (hasn’t called its callback yet) when you call <span class="code">cancel</span>.</td>
</tr>
<tr>
<td><span class="code">start</span></td>
<td><span class="code"><em>t</em></span><span class="code">.start()</span><br/>
			Starts<a contenteditable="false" data-primary="start (threading module)" data-type="indexterm" id="idm44924505358720"/> <span class="code"><em>t</em></span>.</td>
</tr>
</tbody>
</table>
<p><span class="code">Timer</span> extends <span class="code">Thread</span> and adds the attributes <span class="code">function</span>, <span class="code">interval</span>, <span class="code">args</span>, and <span class="code">kwargs</span>.</p>
<p>A<a contenteditable="false" data-primary="except clause" data-type="indexterm" id="idm44924505350928"/> <span class="code">Timer</span> is “one-shot”: <span class="code"><em>t</em></span> calls its callback only once. To call <span class="code"><em>callback</em></span> periodically, every <span class="code"><em>interval</em></span> seconds, here’s a simple recipe—the <span class="code">Periodic</span> timer runs <span class="code"><em>callback</em></span> every <span class="code"><em>interval</em></span> seconds, stopping only when <span class="code"><em>callback</em></span> raises an exception:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="k">class</code></strong><code> </code><code class="nc">Periodic</code><code class="p">(</code><code class="n">threading</code><code class="o">.</code><code class="n">Timer</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><strong><code class="k">def</code></strong><code> </code><code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">interval</code><code class="p">,</code><code> </code><code class="n">callback</code><code class="p">,</code><code> </code><code class="n">args</code><code class="o">=</code><strong><code class="kc">None</code></strong><code class="p">,</code><code> </code><code class="n">kwargs</code><code class="o">=</code><strong><code class="kc">None</code></strong><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="nb">super</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="fm">__init__</code><code class="p">(</code><code class="n">interval</code><code class="p">,</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">_f</code><code class="p">,</code><code> </code><code class="n">args</code><code class="p">,</code><code> </code><code class="n">kwargs</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">callback</code><code> </code><code class="o">=</code><code> </code><code class="n">callback</code><code>
</code><code>
</code><code>    </code><strong><code class="k">def</code></strong><code> </code><code class="nf">_f</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="o">*</code><code class="n">args</code><code class="p">,</code><code> </code><code class="o">*</code><code class="o">*</code><code class="n">kwargs</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="n">p</code><code> </code><code class="o">=</code><code> </code><code class="nb">type</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">interval</code><code class="p">,</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">callback</code><code class="p">,</code><code> </code><code class="n">args</code><code class="p">,</code><code> </code><code class="n">kwargs</code><code class="p">)</code><code>
</code><code>        </code><code class="n">p</code><code class="o">.</code><code class="n">start</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><strong><code class="k">try</code></strong><code class="p">:</code><code>
</code><code>            </code><code class="bp">self</code><code class="o">.</code><code class="n">callback</code><code class="p">(</code><code class="o">*</code><code class="n">args</code><code class="p">,</code><code> </code><code class="o">*</code><code class="o">*</code><code class="n">kwargs</code><code class="p">)</code><code>
</code><code>        </code><strong><code class="k">except</code></strong><code> </code><code class="ne">Exception</code><code class="p">:</code><code>
</code><code>            </code><code class="n">p</code><code class="o">.</code><code class="n">cancel</code><code class="p">(</code><code class="p">)</code></pre>
</div></section>
<section data-pdf-bookmark="Barrier objects" data-type="sect3"><div class="sect3" id="barrier_objects">
<h3>Barrier objects</h3>
<p>A<a contenteditable="false" data-primary="Barrier objects" data-type="indexterm" id="idm44924505222832"/> <span class="code">Barrier</span> is a synchronization primitive allowing a certain number of threads to wait until they’ve all reached a certain point in their execution, at which point they all resume. Specifically, when a thread calls <span class="code"><em>b</em></span><span class="code">.wait</span>, it blocks until the specified number of threads have made the same call on <span class="code"><em>b</em></span>; at that time, all the threads blocked on <span class="code"><em>b</em></span> are allowed to resume.</p>
<p>The <span class="code">Barrier</span> class exposes the constructor, methods, and properties listed in <a data-type="xref" href="#constructorcomma_methodscomma_and_prope">Table 15-8</a>.</p>
<table class="border" id="constructorcomma_methodscomma_and_prope">
<caption><span class="label">Table 15-8. </span>Constructor, methods, and properties of the <span class="code">Barrier</span> class</caption>
<tbody>
<tr>
<td class="width-15"><span class="code">Barrier</span></td>
<td><span class="code"><strong>class</strong></span> <span class="code">Barrier(<em>num_threads</em>, action=<strong>None</strong>, timeout=<strong>None</strong>)</span><br/>
			Creates<a contenteditable="false" data-primary="Barrier (threading module)" data-type="indexterm" id="idm44924505169184"/> a <span class="code">Barrier</span> object <span class="code"><em>b</em></span> for <span class="code"><em>num_threads</em></span> threads. <span class="code">action</span> is a callable without arguments: if you pass this argument, it executes on any single one of the blocked threads when they are all unblocked. <span class="code">timeout</span> is covered in <a data-type="xref" href="#timeout_parameters">“Timeout parameters”</a>.</td>
</tr>
<tr>
<td><span class="code">abort</span></td>
<td><span class="code"><em>b.</em></span><span class="code">abort()</span><br/>
			Puts<a contenteditable="false" data-primary="abort (threading module)" data-type="indexterm" id="idm44924505159920"/> <span class="code">Barrier</span> <span class="code"><em>b</em></span> in the <em>broken</em> state, meaning that any thread currently waiting resumes with a <span class="code">threading.BrokenBarrierException</span> (the same exception also gets raised on any subsequent call to <span class="code"><em>b</em></span><span class="code">.wait</span>). This is an emergency action typically used when a waiting thread is suffering some abnormal termination, to avoid deadlocking the whole program.</td>
</tr>
<tr>
<td><span class="code">broken</span></td>
<td><span class="code"><em>b.</em></span><span class="code">broken</span><br/>
<span class="code"><strong>True</strong></span> when<a contenteditable="false" data-primary="broken (threading module)" data-type="indexterm" id="idm44924505150448"/> <span class="code"><em>b</em></span> is in the broken state; otherwise, <span class="code"><strong>False</strong></span>.</td>
</tr>
<tr>
<td><span class="code">n_waiting</span></td>
<td><span class="code"><em>b.</em></span><span class="code">n_waiting</span><br/>
			The number of threads currently waiting on <span class="code"><em>b</em></span>.</td>
</tr>
<tr>
<td><span class="code">parties</span></td>
<td><span class="code">parties</span><br/>
			The<a contenteditable="false" data-primary="parties (threading module)" data-type="indexterm" id="idm44924505141216"/> value passed as <span class="code"><em>num_threads</em></span> in the constructor of <span class="code"><em>b</em></span>.</td>
</tr>
<tr>
<td><span class="code">reset</span></td>
<td><span class="code"><em>b.</em></span><span class="code">reset()</span><br/>
			Returns <span class="code"><em>b</em></span> to the initial empty, nonbroken state; any thread currently waiting on <span class="code"><em>b</em></span>, however, resumes with a <span class="code">threading.BrokenBarrierException</span>.</td>
</tr>
<tr>
<td><span class="code">wait</span></td>
<td><span class="code"><em>b.</em></span><span class="code">wait()</span><br/>
			The<a contenteditable="false" data-primary="wait (threading module)" data-type="indexterm" id="idm44924505129296"/> first <span class="code"><em>b</em></span><span class="code">.parties-1</span> threads calling <span class="code"><em>b</em></span><span class="code">.wait</span> block; when the number of threads blocked on <span class="code"><em>b</em></span> is <span class="code"><em>b</em></span><span class="code">.parties-1</span> and one more thread calls <span class="code"><em>b</em></span><span class="code">.wait</span>, all the threads blocked on <span class="code"><em>b</em></span> resume. <span class="code"><em>b</em></span><span class="code">.wait</span> returns an <span class="code">int</span> to each resuming thread, all distinct and in <span class="code">range(<em>b</em>.parties)</span>, in unspecified order; threads can use this return value to determine which one should do what next (though passing <span class="code">action</span> in the <span class="code">Barrier</span>’s constructor is simpler and often sufficient).</td>
</tr>
</tbody>
</table>
<p>The following code shows how <span class="code">Barrier</span> objects synchronize processing across multiple threads (contrast this with the example code shown earlier for <span class="code">Event</span> objects):</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">datetime</code><code class="o">,</code><code> </code><code class="nn">random</code><code class="o">,</code><code> </code><code class="nn">threading</code><code class="o">,</code><code> </code><code class="nn">time</code><code>
</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">runner</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">starting</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>    </code><code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="n">random</code><code class="o">.</code><code class="n">randint</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">3</code><code class="p">)</code><code class="p">)</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">waiting</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>    </code><strong><code class="k">try</code></strong><code class="p">:</code><code>
</code><code>        </code><code class="n">my_number</code><code> </code><code class="o">=</code><code> </code><code class="n">barrier</code><code class="o">.</code><code class="n">wait</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><strong><code class="k">except</code></strong><code> </code><code class="n">threading</code><code class="o">.</code><code class="n">BrokenBarrierError</code><code class="p">:</code><code>
</code><code>        </code><code class="nb">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">Barrier abort() or reset() called, thread exiting...</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>        </code><code class="k">return</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s1">'</code><code class="s1">running (</code><code class="si">{</code><code class="n">my_number</code><code class="si">}</code><code class="s1">) at </code><code class="si">{</code><code class="n">datetime</code><code class="o">.</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="p">)</code><code class="si">}</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">announce_release</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">releasing</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>
</code><code class="n">num_threads</code><code> </code><code class="o">=</code><code> </code><code class="mi">10</code><code>
</code><code class="n">barrier</code><code> </code><code class="o">=</code><code> </code><code class="n">threading</code><code class="o">.</code><code class="n">Barrier</code><code class="p">(</code><code class="n">num_threads</code><code class="p">,</code><code> </code><code class="n">action</code><code class="o">=</code><code class="n">announce_release</code><code class="p">)</code><code>
</code><code>
</code><code class="n">threads</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="n">threading</code><code class="o">.</code><code class="n">Thread</code><code class="p">(</code><code class="n">target</code><code class="o">=</code><code class="n">runner</code><code class="p">)</code><code> </code><strong><code class="k">for</code></strong><code> </code><code class="n">_</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="nb">range</code><code class="p">(</code><code class="n">num_threads</code><code class="p">)</code><code class="p">]</code><code>
</code><strong><code class="k">for</code></strong><code> </code><code class="n">t</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">threads</code><code class="p">:</code><code>
</code><code>    </code><code class="n">t</code><code class="o">.</code><code class="n">start</code><code class="p">(</code><code class="p">)</code><code>
</code><code>
</code><strong><code class="k">for</code></strong><code> </code><code class="n">t</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">threads</code><code class="p">:</code><code>
</code><code>    </code><code class="n">t</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="p">)</code></pre>
</div></section>
</div></section>
<section data-pdf-bookmark="Thread Local Storage" data-type="sect2"><div class="sect2" id="thread_local_storage">
<h2>Thread Local Storage</h2>
<p>The<a contenteditable="false" data-primary="threading module" data-secondary="thread local storage" data-type="indexterm" id="idm44924504929440"/><a contenteditable="false" data-primary="thread local storage" data-type="indexterm" id="idm44924504932816"/> <span class="code">threading</span> module supplies the class <span class="code">local</span>, which a thread can use to obtain <em>thread-local storage</em>, also known as<a contenteditable="false" data-primary=" per-thread data" data-type="indexterm" id="idm44924504952464"/> <em>per-thread data</em>. An instance <span class="code"><em>L</em></span> of <span class="code">local</span> has <span class="keep-together">arbitrary</span> named attributes that you can set and get, stored in a dictionary <span class="code"><em>L</em></span><span class="code">.__dict__</span> that you can also access. <span class="code"><em>L</em></span> is fully thread-safe, meaning there is no problem if multiple threads simultaneously set and get attributes on <span class="code"><em>L</em></span>. Each thread that accesses <span class="code"><em>L</em></span> sees a disjoint set of attributes: any changes made in one thread have no effect in other threads. For example:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">threading</code><code>
</code><code>
</code><code class="n">L</code><code> </code><code class="o">=</code><code> </code><code class="n">threading</code><code class="o">.</code><code class="n">local</code><code class="p">(</code><code class="p">)</code><code>
</code><code class="nb">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">in main thread, setting zop to 42</code><code class="s1">'</code><code class="p">)</code><code>
</code><code class="n">L</code><code class="o">.</code><code class="n">zop</code><code> </code><code class="o">=</code><code> </code><code class="mi">42</code><code>
</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">targ</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>  </code><code class="nb">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">in subthread, setting zop to 23</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>  </code><code class="n">L</code><code class="o">.</code><code class="n">zop</code><code> </code><code class="o">=</code><code> </code><code class="mi">23</code><code>
</code><code>  </code><code class="nb">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">in subthread, zop is now</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">L</code><code class="o">.</code><code class="n">zop</code><code class="p">)</code><code>
</code><code>
</code><code class="n">t</code><code> </code><code class="o">=</code><code> </code><code class="n">threading</code><code class="o">.</code><code class="n">Thread</code><code class="p">(</code><code class="n">target</code><code class="o">=</code><code class="n">targ</code><code class="p">)</code><code>
</code><code class="n">t</code><code class="o">.</code><code class="n">start</code><code class="p">(</code><code class="p">)</code><code>
</code><code class="n">t</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="p">)</code><code>
</code><code class="nb">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">in main thread, zop is now</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">L</code><code class="o">.</code><code class="n">zop</code><code class="p">)</code><code>
</code><em><code class="c1"># prints:</code></em><code>
</code><em><code class="c1">#</code></em><code class="c1"> </code><em><code class="c1">in main thread, setting zop to 42</code></em><code>
</code><em><code class="c1">#</code></em><code class="c1"> </code><em><code class="c1">in subthread, setting zop to 23</code></em><code>
</code><em><code class="c1">#</code></em><code class="c1"> </code><em><code class="c1">in subthread, zop is now 23</code></em><code>
</code><em><code class="c1">#</code></em><code class="c1"> </code><em><code class="c1">in main thread, zop is now 42</code></em></pre>
<p>Thread-local storage makes it easier to write code meant to run in multiple threads, since you can use the same namespace (an instance of <span class="code">threading.local</span>) in multiple threads without the separate threads interfering with each other.<a contenteditable="false" data-primary="" data-startref="TAPthmod15" data-type="indexterm" id="idm44924504774240"/><a contenteditable="false" data-primary="" data-startref="thmod15" data-type="indexterm" id="idm44924504773024"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="The queue Module" data-type="sect1"><div class="sect1" id="the_queue_module">
<h1>The queue Module</h1>
<p>The<a contenteditable="false" data-primary="threads and processes" data-secondary="queue module" data-type="indexterm" id="TAPque15"/><a contenteditable="false" data-primary="queue module" data-type="indexterm" id="qmod15"/><a contenteditable="false" data-primary="standard library modules" data-secondary="queue" data-type="indexterm" id="idm44924504786448"/> <span class="code">queue</span> module supplies queue types supporting multithreaded access, with one main class <span class="code">Queue</span>, one simplified class <span class="code">SimpleQueue</span>, two subclasses of the main class (<span class="code">LifoQueue</span> and <span class="code">PriorityQueue)</span>, and two exception classes (<span class="code">Empty</span> and <span class="code">Full)</span>, described in <a data-type="xref" href="#classes_of_the_queue_module">Table 15-9</a>. The methods exposed by instances of the main class and its subclasses are detailed in <a data-type="xref" href="#methods_of_an_instance_q_of_class_queue">Table 15-10</a>.</p>
<table class="border" id="classes_of_the_queue_module">
<caption><span class="label">Table 15-9. </span>Classes of the <span class="code">queue</span> module</caption>
<tbody>
<tr>
<td><span class="code">Queue</span></td>
<td><span class="code"><strong>class</strong></span> <span class="code">Queue(maxsize=0)</span><br/>
<span class="code">Queue</span>, the main class in the module <span class="code">queue</span>, implements a first-in, first-out (FIFO) queue: the item retrieved each time is the one that was added earliest.<br/>
			When <span class="code">maxsize</span> <span class="code">&gt; 0</span>, the new <span class="code">Queue</span> instance <span class="code"><em>q</em></span> is considered full when <span class="code"><em>q</em></span> has <span class="code">maxsize</span> items. When <span class="code"><em>q</em></span> is full, a thread inserting an item with <span class="code">block=</span><span class="code"><strong>True</strong></span> suspends until another thread extracts an item. When <span class="code">maxsize</span> <span class="code">&lt;= 0</span>, <span class="code"><em>q</em></span> is never considered full and is limited in size only by available memory, like most Python containers.</td>
</tr>
<tr>
<td><span class="code">SimpleQueue</span></td>
<td><span class="code"><strong>class</strong></span> <span class="code">SimpleQueue</span><br/>
<span class="code">SimpleQueue</span> is a simplified <span class="code">Queue</span>: an unbounded FIFO queue lacking the methods <span class="code">full</span>, <span class="code">task_done</span>, and <span class="code">join</span> (see <a data-type="xref" href="#methods_of_an_instance_q_of_class_queue">Table 15-10</a>) and with the method <span class="code">put</span> ignoring its optional arguments but guaranteeing reentrancy (which makes it usable in <span class="code">__del__</span> methods and <span class="code">weakref</span> callbacks, where <span class="code">Queue.put</span> would not be).</td>
</tr>
<tr>
<td><span class="code">LifoQueue</span></td>
<td><span class="code"><strong>class</strong></span> <span class="code">LifoQueue(maxsize=0)</span><br/>
<span class="code">LifoQueue</span> is a subclass of <span class="code">Queue</span>; the only difference is that <span class="code">LifoQueue</span> implements a last-in, first-out (LIFO) queue, meaning the item retrieved each time is the most recently added one (often called a <em>stack</em>).</td>
</tr>
<tr>
<td><span class="code">PriorityQueue</span></td>
<td><span class="code"><strong>class</strong></span> <span class="code">PriorityQueue(maxsize=0)</span><br/>
<span class="code">PriorityQueue</span> is a subclass of <span class="code">Queue</span>; the only difference is that <span class="code">PriorityQueue</span> implements a <em>priority</em> queue, meaning the item retrieved each time is the smallest one currently in the queue. Since there is no way to specify ordering, you’ll typically use <span class="code">(<em>priority</em>,</span> <span class="code"><em>payload</em></span><span class="code">)</span> pairs as items, with low values of <span class="code"><em>priority</em></span> meaning earlier retrieval.</td>
</tr>
<tr>
<td><span class="code">Empty</span></td>
<td><span class="code">Empty</span> is the exception that <span class="code"><em>q</em></span><span class="code">.get(block=<strong>False</strong>)</span> raises when <span class="code"><em>q</em></span> is empty.</td>
</tr>
<tr>
<td><span class="code">Full</span></td>
<td><span class="code">Full</span> is the exception that <span class="code"><em>q</em></span><span class="code">.put(<em>x</em>, block=<strong>False</strong>)</span> raises when <span class="code"><em>q</em></span> is full.</td>
</tr>
</tbody>
</table>
<p>An instance <span class="code"><em>q</em></span> of the class <span class="code">Queue</span> (or either of its subclasses) supplies the methods listed in <a data-type="xref" href="#methods_of_an_instance_q_of_class_queue">Table 15-10</a>, all thread-safe and guaranteed to be atomic. For details on the methods exposed by an instance of <span class="code">SimpleQueue</span>, see <a data-type="xref" href="#classes_of_the_queue_module">Table 15-9</a>.</p>
<table class="border" id="methods_of_an_instance_q_of_class_queue">
<caption><span class="label">Table 15-10. </span>Methods of an instance <span class="code">q</span> of class <span class="code">Queue</span>, <span class="code">LifoQueue</span>, or <span class="code">PriorityQueue</span></caption>
<tbody>
<tr>
<td class="width-15"><span class="code">empty</span></td>
<td><span class="code"><em>q</em></span><span class="code">.empty()</span><br/>
			Returns <span class="code"><strong>True</strong></span> when <span class="code"><em>q</em></span> is empty; otherwise, returns <span class="code"><strong>False</strong></span>.</td>
</tr>
<tr>
<td><span class="code">full</span></td>
<td><span class="code"><em>q</em></span><span class="code">.full()</span><br/>
			Returns <span class="code"><strong>True</strong></span> when <span class="code"><em>q</em></span> is full; otherwise, returns <span class="code"><strong>False</strong></span>.</td>
</tr>
<tr>
<td><span class="code">get</span>,<br/>
<span class="code">get_nowait</span></td>
<td><span class="code"><em>q</em></span><span class="code">.get(block=<strong>True</strong>, timeout=<strong>None</strong>)</span>,<br/>
<span class="code"><em>q</em></span><span class="code">.get_nowait()</span><br/>
			When <span class="code">block</span> is <span class="code"><strong>False</strong></span>, <span class="code">get</span> removes and returns an item from <span class="code"><em>q</em></span> if one is available; otherwise, <span class="code">get</span> raises <span class="code">Empty</span>. When <span class="code">block</span> is <span class="code"><strong>True</strong></span> and <span class="code">timeout</span> is <span class="code"><strong>None</strong></span>, <span class="code">get</span> removes and returns an item from <span class="code"><em>q</em></span>, suspending the calling thread, if need be, until an item is available. When <span class="code">block</span> is <span class="code"><strong>True</strong></span> and <span class="code">timeout</span> is not <span class="code"><strong>None</strong></span>, <span class="code">timeout</span> must be a number <span class="code">&gt;=0</span> (which may include a fractional part to specify a fraction of a second), and <span class="code">get</span> waits for no longer than <span class="code">timeout</span> seconds (if no item is yet available by then, <span class="code">get</span> raises <span class="code">Empty</span>). <span class="code"><em>q</em></span><span class="code">.get_nowait()</span> is like <span class="code"><em>q</em></span><span class="code">.get(<strong>False</strong>)</span>, which is also like <span class="code"><em>q</em></span><span class="code">.get(timeout=0.0)</span>. <span class="code">get</span> removes and returns items: in the same order as <span class="code">put</span> inserted them (FIFO) if <span class="code"><em>q</em></span> is a direct instance of <span class="code">Queue</span> itself, in LIFO order if <span class="code"><em>q</em></span> is an instance of <span class="code">LifoQueue</span>, or in smallest-first order if <span class="code"><em>q</em></span> is an instance of <span class="code">PriorityQueue</span>.</td>
</tr>
<tr>
<td><span class="code">put</span>,<br/>
<span class="code">put_nowait</span></td>
<td><span class="code"><em>q</em></span><span class="code">.put(<em>item</em>, block=<strong>True</strong>, timeout=<strong>None</strong>)</span><br/>
<span class="code"><em>q</em></span><span class="code">.put_nowait(<em>item</em>)</span><br/>
			When <span class="code">block</span> is <span class="code"><strong>False</strong></span>, <span class="code">put</span> adds <span class="code"><em>item</em></span> to <span class="code"><em>q</em></span> if <span class="code"><em>q</em></span> is not full; otherwise, <span class="code">put</span> raises <span class="code">Full</span>. When <span class="code">block</span> is <span class="code"><strong>True</strong></span> and <span class="code">timeout</span> is <span class="code"><strong>None</strong></span>, <span class="code">put</span> adds <span class="code"><em>item</em></span> to <span class="code"><em>q</em></span>, suspending the calling thread, if need be, until <span class="code"><em>q</em></span> is not full. When <span class="code">block</span> is <span class="code"><strong>True</strong></span> and <span class="code">timeout</span> is not <span class="code"><strong>None</strong></span>, <span class="code">timeout</span> must be a number <span class="code">&gt;=0</span> (which may include a fractional part to specify a fraction of a second), and <span class="code">put</span> waits for no longer than <span class="code">timeout</span> seconds (if <span class="code"><em>q</em></span> is still full by then, <span class="code">put</span> raises <span class="code">Full</span>). <span class="code"><em>q</em></span><span class="code">.put_nowait(<em>item</em>)</span> is like <span class="code"><em>q</em></span><span class="code">.put(<em>item</em>,</span> <span class="code"><strong>False</strong></span><span class="code">)</span>, which is also like <span class="code"><em>q</em></span><span class="code">.put(<em>item</em>, timeout=0.0)</span>.</td>
</tr>
<tr>
<td><span class="code">qsize</span></td>
<td><span class="code"><em>q</em></span><span class="code">.qsize()</span><br/>
			Returns the number of items that are currently in <span class="code"><em>q</em></span>.</td>
</tr>
</tbody>
</table>
<p><span class="code"><em>q</em></span> maintains an internal, hidden count of<a contenteditable="false" data-primary="unfinished tasks (in queues)" data-type="indexterm" id="idm44924504586096"/> <em>unfinished tasks</em>, which starts at zero. Each call to <span class="code">put</span> increments the count by one. To decrement the count by one, when a worker thread has finished processing a task, it calls <span class="code"><em>q</em></span><span class="code">.task_done</span>. To synchronize on “all tasks done,” call <span class="code"><em>q</em></span><span class="code">.join</span>: when the count of unfinished tasks is nonzero, <span class="code"><em>q</em></span><span class="code">.join</span> blocks the calling thread, unblocking later when the count goes to zero; when the count of unfinished tasks is zero, <span class="code"><em>q</em></span><span class="code">.join</span> continues the calling thread.</p>
<p>You don’t have to use <span class="code">join</span> and <span class="code">task_done</span> if you prefer to coordinate threads in other ways, but they provide a simple, useful approach when you need to coordinate systems of threads using a <span class="code">Queue</span>.</p>
<p><span class="code">Queue</span><a contenteditable="false" data-primary="It’s easier to ask forgiveness than permission (EAFP)" data-type="indexterm" id="idm44924504574304"/><a contenteditable="false" data-primary="EAFP (It’s easier to ask forgiveness than permission)" data-type="indexterm" id="idm44924504573136"/> offers a good example of the idiom “It’s easier to ask forgiveness than permission” (EAFP), covered in <a data-type="xref" href="ch06.xhtml#error_checking_strategies">“Error-Checking Strategies”</a>. Due to multithreading, each nonmutating method of <span class="code"><em>q</em></span> (<span class="code">empty</span>, <span class="code">full</span>, <span class="code">qsize</span>) can only be advisory. When some other thread mutates <span class="code"><em>q</em></span>, things can change between the instant a thread gets information from a nonmutating method and the very next moment, when the thread acts on the information. Relying<a contenteditable="false" data-primary="look before you leap (LBYL)" data-type="indexterm" id="idm44924504566976"/><a contenteditable="false" data-primary="LBYL (look before you leap)" data-type="indexterm" id="idm44924504565840"/> on the “look before you leap” (LBYL) idiom is therefore futile, and fiddling with locks to try to fix things is a substantial waste of effort. Avoid fragile LBYL code, such as:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="k">if</code></strong><code> </code><em><code class="n">q</code></em><code class="o">.</code><code class="n">empty</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">no work to perform</code><code class="s1">'</code><code class="p">)</code><code>
</code><strong><code class="k">else</code></strong><code class="p">:</code><code>  </code><code class="c1"># Some other thread may now have emptied the queue!</code><code>
</code><code>    </code><em><code class="n">x</code></em><code> </code><code class="o">=</code><code> </code><em><code class="n">q</code></em><code class="o">.</code><code class="n">get_nowait</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="n">work_on</code><code class="p">(</code><em><code class="n">x</code></em><code class="p">)</code></pre>
<p>and instead use the simpler and more robust<a contenteditable="false" data-primary="" data-startref="TAPque15" data-type="indexterm" id="idm44924504525072"/><a contenteditable="false" data-primary="" data-startref="qmod15" data-type="indexterm" id="idm44924504533632"/> EAFP approach:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="k">try</code></strong><code class="p">:</code><code>
</code><code>    </code><em><code class="n">x</code></em><code> </code><code class="o">=</code><code> </code><em><code class="n">q</code></em><code class="o">.</code><code class="n">get_nowait</code><code class="p">(</code><code class="p">)</code><code>
</code><strong><code class="k">except</code></strong><code> </code><code class="n">queue</code><code class="o">.</code><code class="n">Empty</code><code class="p">:</code><code>  </code><code class="c1"># Guarantees the queue was empty when accessed</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">no work to perform</code><code class="s1">'</code><code class="p">)</code><code>
</code><strong><code class="k">else</code></strong><code class="p">:</code><code>
</code><code>    </code><code class="n">work_on</code><code class="p">(</code><em><code class="n">x</code></em><code class="p">)</code></pre>
</div></section>
<section data-pdf-bookmark="The multiprocessing Module" data-type="sect1"><div class="sect1" id="the_multiprocessing_module">
<h1>The multiprocessing Module</h1>
<p>The<a contenteditable="false" data-primary="threads and processes" data-secondary="multiprocessing module" data-type="indexterm" id="TAPmulti15"/><a contenteditable="false" data-primary="multiprocessing module" data-type="indexterm" id="multimod15"/><a contenteditable="false" data-primary="multiprocessing module" data-secondary="basics of" data-type="indexterm" id="idm44924504470768"/><a contenteditable="false" data-primary="standard library modules" data-secondary="multiprocessing" data-type="indexterm" id="idm44924504469392"/> <span class="code">multiprocessing</span> module supplies functions and classes to code pretty much as you would for multithreading, but distributing work across processes, rather than across threads: these include the class <span class="code">Process</span> (analogous to <span class="code">threading.Thread</span>) and classes for synchronization primitives (<span class="code">Lock</span>, <span class="code">RLock</span>, <span class="code">Condition</span>, <span class="code">Event</span>, <span class="code">Semaphore</span>, <span class="code">BoundedSemaphore</span>, and <span class="code">Barrier</span>—each similar to the class with the same name in the <span class="code">threading</span> module—as well as <span class="code">Queue</span> and <span class="code">JoinableQueue</span>, both similar to <span class="code">queue.Queue</span>). These classes make it easy to take code written to use <span class="code">threading</span> and port it to a version using <span class="code">multiprocessing</span> instead; just pay attention to the differences we cover in the following subsection.</p>
<p>It’s usually best to avoid sharing state among processes: use queues, instead, to explicitly pass messages among them. However, for those rare occasions in which you do need to share some state, <span class="code">multiprocessing</span> supplies classes to access shared memory (<span class="code">Value</span> and <span class="code">Array</span>), and—more flexibly (including coordination among different computers on a network) though with more overhead—a <span class="code">Process</span> subclass, <span class="code">Manager</span>, designed to hold arbitrary data and let other processes manipulate that data via <em>proxy</em> objects. We cover state sharing in <a data-type="xref" href="#sharing_state_classes_valuecomma_arrayc">“Sharing State: Classes Value, Array, and Manager”</a>.</p>
<p>When you’re writing new code, rather than porting code originally written to use <span class="code">threading</span>, you can often use different approaches supplied by <span class="code">multiprocessing</span>. The <span class="code">Pool</span> class, in particular (covered in <a data-type="xref" href="#process_pools">“Process Pools”</a>), can often simplify your code. The simplest and highest-level way to do multiprocessing is to use the <span class="code">concurrent.futures</span> module (covered in <a data-type="xref" href="#the_concurrentdotfutures_module">“The concurrent.futures Module”</a>) along with the <span class="code">ProcessPoolExecutor</span>.</p>
<p>Other highly advanced approaches, based on <span class="code">Connection</span> objects built by the <span class="code">Pipe</span> factory function or wrapped in <span class="code">Client</span> and <span class="code">Listener</span> objects, are even more flexible, but quite a bit more complex; we do not cover them further in this book. For more in-depth coverage of <span class="code">multiprocessing</span>, refer to the <a href="https://oreil.ly/mq8d1">online docs</a><sup><a data-type="noteref" href="ch15.xhtml#ch01fn117" id="ch01fn117-marker">2</a></sup> and third-party online tutorials like in <a href="https://oreil.ly/ApoV0">PyMOTW</a>.</p>
<section class="pagebreak-before" data-pdf-bookmark="Differences Between multiprocessing and threading" data-type="sect2"><div class="sect2" id="differences_between_multiprocessing_and">
<h2 class="less_space">Differences Between multiprocessing and threading</h2>
<p>You<a contenteditable="false" data-primary="multiprocessing module" data-secondary="multiprocessing versus threading" data-type="indexterm" id="idm44924504408752"/> can pretty easily port code written to use <span class="code">threading</span> into a variant using <span class="code">multiprocessing</span> instead—however, there are several differences you must consider.</p>
<section data-pdf-bookmark="Structural differences" data-type="sect3"><div class="sect3" id="structural_differences">
<h3>Structural differences</h3>
<p>All objects that you exchange between processes (for example, via a queue, or an argument to a <span class="code">Process</span>’s <span class="code">target</span> function) are serialized via <span class="code">pickle</span>, covered in <a data-type="xref" href="ch12.xhtml#the_pickle_module">“The pickle Module”</a>. Therefore, you can only exchange objects that can be thus serialized. Moreover, the serialized bytestring cannot exceed about 32 MB (depending on the platform), or else an exception is raised; therefore, there are limits to the size of objects you can exchange.</p>
<p>Especially in Windows, child processes <em>must</em> be able to import as a module the main script that’s spawning them. Therefore, be sure to guard all top-level code in the main script (meaning code that must not be executed again by child processes) with the usual <span class="code"><strong>if</strong></span> <span class="code">__name__ == '__main__'</span> idiom, covered in <a data-type="xref" href="ch07.xhtml#the_main_program">“The Main Program”</a>.</p>
<p>If a process is abruptly killed (for example, via a signal) while using a queue or holding a synchronization primitive, it won’t be able to perform proper cleanup on that queue or primitive. As a result, the queue or primitive may get corrupted, causing errors in all other processes trying to use it.</p>
</div></section>
<section data-pdf-bookmark="The Process class" data-type="sect3"><div class="sect3" id="the_process_class">
<h3>The Process class</h3>
<p>The<a contenteditable="false" data-primary="Process class (multiprocessing module)" data-type="indexterm" id="idm44924504394640"/> class <span class="code">multiprocessing.Process</span> is very similar to <span class="code">threading.Thread</span>; it supplies all the same attributes and methods (see <a data-type="xref" href="#constructorcomma_methodscomma_and_prop">Table 15-2</a>), plus a few more, listed in <a data-type="xref" href="#additional_attributes_and_methods_of_th">Table 15-11</a>. Its<a contenteditable="false" data-primary="function signatures" data-secondary="Process class (multiprocessing module)" data-type="indexterm" id="idm44924504389952"/> constructor has the following signature:</p>
<table class="border">
<tbody>
<tr>
<td class="width-10"><span class="code">Process</span></td>
<td><span class="code"><strong>class</strong></span> <span class="code">Process(name=<strong>None</strong>, target=<strong>None</strong>, args=(), kwargs={})</span><br/>
<em>Always call</em> <span class="code"><em>Process</em></span> <em>with named arguments</em>: the number and order of parameters is not guaranteed by the specification, but the parameter names are. Either instantiate the class <span class="code">Process</span> itself, passing a <span class="code">target</span> function (<span class="code"><em>p</em></span><span class="code">.run</span> then calls <span class="code"><em>target</em></span><span class="code">(*<em>args</em>, **<em>kwargs</em>)</span> when the thread is started); or, instead of passing <span class="code">target</span>, extend the <span class="code">Process</span> class and override its <span class="code">run</span> method. In either case, execution will begin only when you call <span class="code"><em>p</em></span><span class="code">.start</span>. <span class="code">name</span> becomes <span class="code"><em>p</em></span>’s name. If <span class="code">name</span> is <span class="code"><strong>None</strong></span>, <span class="code">Process</span> generates a unique name for <span class="code"><em>p</em></span>. If a subclass <span class="code"><em>P</em></span> of <span class="code">Process</span> overrides <span class="code">__init__</span>, <span class="code"><em>P</em></span>.<span class="code">__init__</span> <em>must</em> call <span class="code">Process.__init__</span> on <span class="code">self</span> (usually via the <span class="code">super</span> built-in function) before any other <span class="code">Process</span> method.</td>
</tr>
</tbody>
</table>
<table class="border" id="additional_attributes_and_methods_of_th">
<caption><span class="label">Table 15-11. </span>Additional attributes and methods of the <span class="code">Process</span> class</caption>
<tbody>
<tr>
<td class="width-15"><span class="code">authkey</span></td>
<td>The process’s authorization key, a bytestring. This is initialized to random bytes supplied by <span class="code">os.urandom</span>, but you can reassign it later if you wish. Used in the authorization handshake for advanced uses we do not cover in this book.</td>
</tr>
<tr>
<td><span class="code">close</span></td>
<td><span class="code">close()</span><br/>
			Closes a <span class="code">Process</span> instance and releases all resources associated with it. If the underlying process is still running, raises <span class="code">ValueError</span>.</td>
</tr>
<tr>
<td><span class="code">exitcode</span></td>
<td><span class="code"><strong>None</strong></span> when the process has not exited yet; otherwise, the process’s exit code. This is an <span class="code">int</span>: <span class="code">0</span> for success, <span class="code">&gt;0</span> for failure, <span class="code">&lt;0</span> when the process was killed.</td>
</tr>
<tr>
<td><span class="code">kill</span></td>
<td><span class="code">kill()</span><br/>
			Same as <span class="code">terminate</span>, but on Unix sends a <span class="code">SIGKILL</span> signal.</td>
</tr>
<tr>
<td><span class="code">pid</span></td>
<td><span class="code"><strong>None</strong></span> when the process has not started yet; otherwise, the process’s identifier as set by the operating system.</td>
</tr>
<tr>
<td><span class="code">terminate</span></td>
<td><span class="code">terminate()</span><br/>
			Kills the process (without giving it a chance to execute termination code, such as cleanup of queues and synchronization primitives; beware of the likelihood of causing errors when the process is using a queue or holding a synchronization primitive!).</td>
</tr>
</tbody>
</table>
</div></section>
<section data-pdf-bookmark="Differences in queues" data-type="sect3"><div class="sect3" id="differences_in_queues">
<h3>Differences in queues</h3>
<p>The class <span class="code">multiprocessing.Queue</span> is very similar to <span class="code">queue.Queue</span>, except that an instance <span class="code"><em>q</em></span> of <span class="code">multiprocessing.Queue</span> does <em>not</em> supply the methods <span class="code">join</span> and <span class="code">task_done</span> (described in <a data-type="xref" href="#the_queue_module">“The queue Module”</a>). When methods of <span class="code"><em>q</em></span> raise exceptions due to timeouts, they raise instances of <span class="code">queue.Empty</span> or <span class="code">queue.Full</span>. <span class="code">multiprocessing</span> has no equivalents to <span class="code">queue</span>’s <span class="code">LifoQueue</span> and <span class="code">PriorityQueue</span> classes.</p>
<p>The class <span class="code">multiprocessing.JoinableQueue</span> does supply the methods <span class="code">join</span> and <span class="code">task_done</span>, but with a semantic difference compared to <span class="code">queue.Queue</span>: with an instance <span class="code"><em>q</em></span> of <span class="code">multiprocessing.JoinableQueue</span>, the process that calls <span class="code"><em>q</em></span><span class="code">.get</span> <em>must</em> call <span class="code"><em>q</em></span><span class="code">.task_done</span> when it’s done processing that unit of work (it’s not optional, as it is when using <span class="code">queue.Queue</span>).</p>
<p>All objects you <span class="code">put</span> in multiprocessing queues must be serializable by <span class="code">pickle</span>. There may be a delay between the time you execute <span class="code">q.put</span> and the time the object is available from <span class="code">q.get</span>. Lastly, remember that an abrupt exit (crash or signal) of a process using <span class="code"><em>q</em></span> may leave <span class="code"><em>q</em></span> unusable for any other process.</p>
</div></section>
</div></section>
<section data-pdf-bookmark="Sharing State: Classes Value, Array, and Manager" data-type="sect2"><div class="sect2" id="sharing_state_classes_valuecomma_arrayc">
<h2>Sharing State: Classes Value, Array, and Manager</h2>
<p>To<a contenteditable="false" data-primary="multiprocessing module" data-secondary="sharing state" data-type="indexterm" id="idm44924504307616"/> use shared memory to hold a single primitive value in common among two or more processes, <span class="code">multiprocessing</span> supplies the class <span class="code">Value</span>, and for a fixed-length array of primitive values, it provides the class <span class="code">Array</span>. For more flexibility (including sharing nonprimitive values and “sharing” among different systems joined by a network but sharing no memory), at the cost of higher overhead, <span class="code">multiprocessing</span> supplies the class <span class="code">Manager</span>, which is a subclass of <span class="code">Process</span>. We’ll look at each of these in the following subsections.</p>
<section data-pdf-bookmark="The Value class" data-type="sect3"><div class="sect3" id="the_value_class">
<h3>The Value class</h3>
<p>The<a contenteditable="false" data-primary="Value class (multiprocessing module)" data-type="indexterm" id="idm44924504300016"/> constructor for the class <span class="code">Value</span> has the<a contenteditable="false" data-primary="function signatures" data-secondary="Value class (multiprocessing module)" data-type="indexterm" id="idm44924504298096"/> signature:</p>
<table class="border">
<tbody>
<tr>
<td><span class="code">Value</span></td>
<td><span class="code"><strong>class</strong></span> <span class="code">Value(<em>typecode</em>,</span> <span class="code"><em>*args</em></span><span class="code">,</span> <span class="code"><em>*</em></span><span class="code">, lock=<strong>True</strong>)</span><br/>
<span class="code"><em>typecode</em></span> is a string defining the primitive type of the value, just like for the <span class="code">array</span> module, covered in <a data-type="xref" href="ch16.xhtml#the_array_module">“The array Module”</a>. (Alternatively, <span class="code"><em>typecode</em></span> can be a type from the module <a contenteditable="false" data-primary="ctypes module" data-type="indexterm" id="idm44924504284272"/><span class="code">ctypes</span>, discussed in <a href="https://oreil.ly/python-nutshell-25">“ctypes” in Chapter 25</a>, but this is rarely necessary.) <span class="code"><em>args</em></span> is passed on to the type’s constructor: therefore, <span class="code"><em>args</em></span> is either absent (in which case the primitive is initialized as per its default, typically <span class="code">0</span>) or a single value, which is used to initialize the primitive.<br/>
			When <span class="code">lock</span> is <span class="code"><strong>True</strong></span> (the default), <span class="code">Value</span> makes and uses a new lock to guard the instance. Alternatively, you can pass as <span class="code">lock</span> an existing <span class="code">Lock</span> or <span class="code">RLock</span> instance. You can even pass <span class="code">lock=</span><span class="code"><strong>False</strong></span>, but that is rarely advisable: when you do, the instance is not guarded (thus, it is not synchronized among processes) and is missing the method <span class="code">get_lock</span>. If you do pass <span class="code">lock</span>, you <em>must</em> pass it as a named argument, using <span class="code">lock=</span><span class="code"><em>something</em></span>.</td>
</tr>
</tbody>
</table>
<p>An instance <span class="code"><em>v</em></span> of the class <span class="code">Value</span> supplies the method <span class="code">get_lock</span>, which returns (but neither acquires nor releases) the lock guarding <em>v</em>, and the read/write attribute <span class="code">value</span>, used to set and get <em>v</em>’s underlying primitive value.</p>
<p>To ensure atomicity of operations on <span class="code"><em>v</em></span>’s underlying primitive value, guard the operation in a <span class="code"><strong>with</strong></span> <span class="code"><em>v</em></span><span class="code">.get_lock():</span> statement. A typical example of such usage might be for augmented assignment, as in:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="k">with</code></strong><code> </code><code class="n">v</code><code class="o">.</code><code class="n">get_lock</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">v</code><code class="o">.</code><code class="n">value</code><code> </code><code class="o">+</code><code class="o">=</code><code> </code><code class="mi">1</code></pre>
<p>If any other process does an unguarded operation on that same primitive value, however—even an atomic one such as a simple assignment like <span class="code"><em>v</em></span><span class="code">.value =</span> <span class="code"><em>x</em></span>—all bets are off: the guarded operation and the unguarded one can get your system into a <em>race condition</em>.<sup><a data-type="noteref" href="ch15.xhtml#ch01fn118" id="ch01fn118-marker">3</a></sup> Play it safe: if <em>any</em> operation at all on <span class="code"><em>v</em></span><span class="code">.value</span> is not atomic (and thus needs to be guarded by being within a <span class="code"><strong>with</strong></span> <span class="code"><em>v</em></span><span class="code">.get_lock():</span> block), guard <em>all</em> operations on <span class="code"><em>v</em></span><span class="code">.value</span> by placing them within such blocks.</p>
</div></section>
<section data-pdf-bookmark="The Array class" data-type="sect3"><div class="sect3" id="the_array_class">
<h3>The Array class</h3>
<p>A<a contenteditable="false" data-primary="Array class (multiprocessing module)" data-type="indexterm" id="idm44924504211664"/> <span class="code">multiprocessing.Array</span> is a fixed-length array of primitive values, with all items of the same primitive type. The constructor for the class <span class="code">Array</span> has the<a contenteditable="false" data-primary="function signatures" data-secondary="Array class (multiprocessing module)" data-type="indexterm" id="idm44924504208896"/> signature:</p>
<table class="border">
<tbody>
<tr>
<td><span class="code">Array</span></td>
<td><span class="code"><strong>class</strong></span> <span class="code">Array(<em>typecode</em>,</span> <span class="code"><em>size_or_initializer</em></span><span class="code">,</span> <span class="code"><em>*</em></span><span class="code">, lock=<strong>True</strong>)</span><br/>
<span class="code"><em>typecode</em></span> is a string defining the primitive type of the value, just like for the module <span class="code">array</span>, as covered in <a data-type="xref" href="ch16.xhtml#the_array_module">“The array Module”</a>. (Alternatively, <span class="code"><em>typecode</em></span> can be a type from the module <a contenteditable="false" data-primary="ctypes module" data-type="indexterm" id="idm44924504195328"/><span class="code">ctypes</span>, discussed in <a href="https://oreil.ly/python-nutshell-25">“ctypes” in Chapter 25</a>, but this is rarely necessary.) <span class="code"><em>size_or_initializer</em></span> can be an iterable, used to initialize the array, or an integer used as the length of the array, in which case each item of the array is initialized to <span class="code">0</span>.<br/>
			When <span class="code">lock</span> is <span class="code"><strong>True</strong></span> (the default), <span class="code">Array</span> makes and uses a new lock to guard the instance. Alternatively, you can pass as <span class="code">lock</span> an existing <span class="code">Lock</span> or <span class="code">RLock</span> instance. You can even pass <span class="code">lock=</span><span class="code"><strong>False</strong></span>, but that is rarely advisable: when you do, the instance is not guarded (thus it is not synchronized among processes) and is missing the method <span class="code">get_lock</span>. If you do pass <span class="code">lock</span>, you <em>must</em> pass it as a named argument, using <span class="code">lock=</span><span class="code"><em>something</em></span>.</td>
</tr>
</tbody>
</table>
<p>An instance <span class="code"><em>a</em></span> of the class <span class="code">Array</span> supplies the method <span class="code">get_lock</span>, which returns (but neither acquires nor releases) the lock guarding <span class="code"><em>a</em></span>.</p>
<p><span class="code"><em>a</em></span> is accessed by indexing and slicing, and modified by assigning to an indexing or to a slice. <span class="code"><em>a</em></span> is fixed length: therefore, when you assign to a slice, you must assign an iterable of exactly the same length as the slice you’re assigning to. <span class="code"><em>a</em></span> is also iterable.</p>
<p>In the special case where <span class="code"><em>a</em></span> was built with a <span class="code"><em>typecode</em></span> of <span class="code">'c'</span>, you can also access <span class="code"><em>a</em></span><span class="code">.value</span> to get <span class="code"><em>a</em></span>’s contents as a bytestring, and you can assign to <span class="code"><em>a</em></span><span class="code">.value</span> any bytestring no longer than <span class="code">len(<em>a</em>)</span>. When <span class="code"><em>s</em></span> is a bytestring with <span class="code">len(<em>s</em>) &lt; len(<em>a</em>)</span>, <span class="code"><em>a</em></span><span class="code">.value =</span> <span class="code"><em>s</em></span> means <span class="code"><em>a</em></span><span class="code">[:len(<em>s</em>)+1]</span> <span class="code">=</span> <span class="code"><em>s</em></span> <span class="code">+ b'\0'</span>; this mirrors the representation of <span class="code">char</span> strings in the C language, terminated with a <span class="code">0</span> byte. For example:</p>
<pre data-code-language="python" data-type="programlisting">
<code class="n">a</code><code> </code><code class="o">=</code><code> </code><code class="n">multiprocessing</code><code class="o">.</code><code class="n">Array</code><code class="p">(</code><code class="s1">'</code><code class="s1">c</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="sa">b</code><code class="s1">'</code><code class="s1">four score and seven</code><code class="s1">'</code><code class="p">)</code><code>
</code><code class="n">a</code><code class="o">.</code><code class="n">value</code><code> </code><code class="o">=</code><code> </code><code class="sa">b</code><code class="s1">'</code><code class="s1">five</code><code class="s1">'</code><code>
</code><code class="nb">print</code><code class="p">(</code><code class="n">a</code><code class="o">.</code><code class="n">value</code><code class="p">)</code><code>   </code><em><code class="c1"># prints</code></em><code class="c1"> </code><em><code class="c1">b'five'</code></em><code>
</code><code class="nb">print</code><code class="p">(</code><code class="n">a</code><code class="p">[</code><code class="p">:</code><code class="p">]</code><code class="p">)</code><code>      </code><em><code class="c1"># prints</code></em><code class="c1"> </code><em><code class="c1">b'five\xOOscore and seven'</code></em></pre>
</div></section>
<section data-pdf-bookmark="The Manager class" data-type="sect3"><div class="sect3" id="the_manager_class">
<h3>The Manager class</h3>
<p><span class="code">multiprocessing.Manager</span> is<a contenteditable="false" data-primary="Manager class (multiprocessing module)" data-type="indexterm" id="idm44924504114032"/> a subclass of <span class="code">multiprocessing.Process</span>, with the same methods and attributes. In addition, it supplies methods to build an instance of any of the multiprocessing synchronization primitives, plus <span class="code">Queue</span>, <span class="code">dict</span>, <span class="code">list</span>, and <span class="code">Namespace</span>, the latter being a class that just lets you set and get arbitrary named attributes. Each of the methods has the name of the class whose instances it builds, and returns a <em>proxy</em> to such an instance, which any process can use to call methods (including special methods, such as indexing of instances of <span class="code">dict</span> or <span class="code">list</span>) on the instance held in the manager process.</p>
<p>Proxy objects pass most operators, and accesses to methods and attributes, on to the instance they proxy for; however, they don’t pass on <em>comparison</em> operators—if you need a comparison, you need to take a local copy of the proxied object. For example:</p>
<pre data-code-language="python" data-type="programlisting">
<code class="n">manager</code><code> </code><code class="o">=</code><code> </code><code class="n">multiprocessing</code><code class="o">.</code><code class="n">Manager</code><code class="p">(</code><code class="p">)</code><code>
</code><code class="n">p</code><code> </code><code class="o">=</code><code> </code><code class="n">manager</code><code class="o">.</code><code class="n">list</code><code class="p">(</code><code class="p">)</code><code>
</code><code>
</code><code class="n">p</code><code class="p">[</code><code class="p">:</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">2</code><code class="p">,</code><code> </code><code class="mi">3</code><code class="p">]</code><code>
</code><code class="nb">print</code><code class="p">(</code><code class="n">p</code><code> </code><code class="o">==</code><code> </code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">2</code><code class="p">,</code><code> </code><code class="mi">3</code><code class="p">]</code><code class="p">)</code><code>       </code><em><code class="c1"># prints</code></em><code class="c1"> </code><em><code class="c1">False</code></em><em><code class="c1">,</code></em><code class="c1"> </code><em><code class="c1"> it compares with p itself</code></em><code>
</code><code class="nb">print</code><code class="p">(</code><code class="nb">list</code><code class="p">(</code><code class="n">p</code><code class="p">)</code><code> </code><code class="o">==</code><code> </code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">2</code><code class="p">,</code><code> </code><code class="mi">3</code><code class="p">]</code><code class="p">)</code><code> </code><em><code class="c1"># prints</code></em><code class="c1"> </code><em><code class="c1">True</code></em><em><code class="c1">,</code></em><code class="c1"> </code><em><code class="c1"> it compares with copy</code></em></pre>
<p>The constructor of <span class="code">Manager</span> takes no arguments. There are advanced ways to customize <span class="code">Manager</span> subclasses to allow connections from unrelated processes (including ones on different computers connected via a network) and to supply a different set of building methods, but we do not cover them in this book. Rather, one simple, often-sufficient approach to using <span class="code">Manager</span> is to explicitly transfer to other processes the proxies it produces, typically via queues, or as arguments to a <span class="code">Process</span>’s <span class="code"><em>target</em></span> function.</p>
<p>For example, suppose there is a long-running, CPU-bound function <span class="code"><em>f</em></span> that, given a string as an argument, eventually returns a corresponding result; given a <span class="code">set</span> of strings, we want to produce a <span class="code">dict</span> with the strings as keys and the corresponding results as values. To be able to follow on which processes <span class="code"><em>f</em></span> runs, we also <span class="code">print</span> the process ID just before calling <span class="code"><em>f</em></span>. <a data-type="xref" href="#example_onefive_onedot_distributing_wor">Example 15-1</a> shows one way to do this.</p>
<div data-type="example" id="example_onefive_onedot_distributing_wor">
<h5><span class="label">Example 15-1. </span>Distributing work to multiple worker processes</h5>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">multiprocessing</code><code> </code><strong><code class="k">as</code></strong><code> </code><code class="nn">mp</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">f</code><code class="p">(</code><code class="n">s</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><em><code class="sd">"""Run a long time, and eventually return a result."""</code></em><code>
</code><strong><code>    </code><code class="kn">import</code></strong><code> </code><code class="nn">time</code><strong><code class="o">,</code></strong><code> </code><code class="nn">random</code><code>
</code><code>    </code><code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="n">random</code><code class="o">.</code><code class="n">random</code><code class="p">(</code><code class="p">)</code><code class="o">*</code><code class="mi">2</code><code class="p">)</code><code>  </code><em><code class="c1"># simulate slowness</code></em><code>
</code><code>    </code><strong><code class="k">return</code></strong><code> </code><code class="n">s</code><code class="o">+</code><code class="n">s</code><code>                     </code><em><code class="c1"># some computation or other</code></em><code>
</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">runner</code><code class="p">(</code><code class="n">s</code><code class="p">,</code><code> </code><code class="n">d</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="n">os</code><code class="o">.</code><code class="n">getpid</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">s</code><code class="p">)</code><code>
</code><code>    </code><code class="n">d</code><code class="p">[</code><code class="n">s</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">f</code><code class="p">(</code><code class="n">s</code><code class="p">)</code><code>
</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">make_dict</code><code class="p">(</code><code class="n">strings</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">mgr</code><code> </code><code class="o">=</code><code> </code><code class="n">mp</code><code class="o">.</code><code class="n">Manager</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="n">d</code><code> </code><code class="o">=</code><code> </code><code class="n">mgr</code><code class="o">.</code><code class="n">dict</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="n">workers</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="p">]</code><code>
</code><code>    </code><strong><code class="k">for</code></strong><code> </code><code class="n">s</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">strings</code><code class="p">:</code><code>
</code><code>        </code><code class="n">p</code><code> </code><code class="o">=</code><code> </code><code class="n">mp</code><code class="o">.</code><code class="n">Process</code><code class="p">(</code><code class="n">target</code><code class="o">=</code><code class="n">runner</code><code class="p">,</code><code> </code><code class="n">args</code><code class="o">=</code><code class="p">(</code><code class="n">s</code><code class="p">,</code><code> </code><code class="n">d</code><code class="p">)</code><code class="p">)</code><code>
</code><code>        </code><code class="n">p</code><code class="o">.</code><code class="n">start</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="n">workers</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">p</code><code class="p">)</code><code>
</code><code>    </code><strong><code class="k">for</code></strong><code> </code><code class="n">p</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">workers</code><code class="p">:</code><code>
</code><code>        </code><code class="n">p</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><strong><code class="k">return</code></strong><code> </code><code class="p">{</code><code class="o">*</code><code class="o">*</code><code class="n">d</code><code class="p">}</code></pre>
</div>
</div></section>
</div></section>
<section data-pdf-bookmark="Process Pools" data-type="sect2"><div class="sect2" id="process_pools">
<h2>Process Pools</h2>
<p>In<a contenteditable="false" data-primary="multiprocessing module" data-secondary="process pools" data-type="indexterm" id="idm44924503780096"/><a contenteditable="false" data-primary="process pools" data-type="indexterm" id="idm44924503783824"/><a contenteditable="false" data-primary="Pool class (multiprocessing module)" data-type="indexterm" id="idm44924503782848"/> real life, you should always avoid creating an unbounded number of worker processes, as we did in <a data-type="xref" href="#example_onefive_onedot_distributing_wor">Example 15-1</a>. Performance benefits accrue only up to the number of cores in your machine (available by calling <span class="code">multiprocessing.cpu_count</span>), or a number just below or just above this, depending on such minutiae as your platform, how CPU-bound or I/O-bound your code is, other tasks running on your computer, etc. Making many more worker processes than such an optimal number incurs substantial extra overhead without any compensating benefit.</p>
<p>As a consequence, it’s a common design pattern to start a <em>pool</em> with a limited number of worker processes, and farm out work to them. The class <span class="code">multiprocessing.Pool</span> lets you orchestrate this pattern.</p>
<section data-pdf-bookmark="The Pool class" data-type="sect3"><div class="sect3" id="the_pool_class">
<h3>The Pool class</h3>
<p>The constructor for the class <span class="code">Pool</span> has the<a contenteditable="false" data-primary="function signatures" data-secondary="Pool class (multiprocessing module)" data-type="indexterm" id="idm44924503798640"/> signature:</p>
<table class="border">
<tbody>
<tr>
<td><span class="code">Pool</span></td>
<td><span class="code"><strong>class</strong></span> <span class="code">Pool(processes=None, initializer=<strong>None</strong>, initargs=(),<br/> maxtasksperchild=<strong>None</strong>)</span><br/>
<span class="code">processes</span> is the number of processes in the pool; it defaults to the value returned by <span class="code">cpu_count</span>. When <span class="code">initializer</span> is not <span class="code"><strong>None</strong></span>, it’s a function, called at the start of each process in the pool, with <span class="code">initargs</span> as arguments, like <span class="code">initializer(*<em>initargs</em>)</span>.<br/>
			When <span class="code">maxtasksperchild</span> is not <span class="code"><strong>None</strong></span>, it’s the maximum number of tasks that can be executed in each process in the pool. When a process in the pool has executed that many tasks, it terminates, then a new process starts and joins the pool. When <span class="code">maxtasksperchild</span> is <span class="code"><strong>None</strong></span> (the default), each process lives as long as the pool.</td>
</tr>
</tbody>
</table>
<p>An instance <span class="code"><em>p</em></span> of the class <span class="code">Pool</span> supplies the methods listed in <a data-type="xref" href="#methods_of_an_instance_p_of_class_pool">Table 15-12</a> (each of them must be called only in the process that built instance <span class="code"><em>p</em></span>).</p>
<table class="border" id="methods_of_an_instance_p_of_class_pool">
<caption><span class="label">Table 15-12. </span>Methods of an instance p of class <span class="code">Pool</span></caption>
<tbody>
<tr>
<td><span class="code">apply</span></td>
<td><span class="code">apply(<em>func</em>, args=(), kwds={})</span><br/>
			In an arbitrary one of the worker processes, runs <span class="code"><em>func</em></span><span class="code">(*<em>args</em>,</span> <span class="code"><em>**kwds</em></span><span class="code">)</span>, waits for it to finish, and returns <span class="code"><em>func</em></span>’s result.</td>
</tr>
<tr>
<td><span class="code">apply_async</span></td>
<td><span class="code">apply_async(<em>func</em>, args=(), kwds={}, callback=<strong>None</strong>)</span><br/>
			In an arbitrary one of the worker processes, starts running <span class="code"><em>func</em></span><span class="code">(*<em>args</em>, **<em>kwds</em>)</span> and, without waiting for it to finish, immediately returns an <span class="code">AsyncResult</span> instance, which eventually gives <span class="code"><em>func</em></span>’s result, when that result is ready. (The <span class="code">AsyncResult</span> class is discussed in the following section.) When <span class="code">callback</span> is not <span class="code"><strong>None</strong></span>, it’s a function to call (in a new, separate thread in the process that calls <span class="code">apply_async</span>), with <span class="code"><em>func</em></span>’s result as the only argument, when that result is ready; <span class="code">callback</span> should execute rapidly, because otherwise it blocks the calling process. <span class="code">callback</span> may mutate its argument if that argument is mutable; <span class="code">callback</span>’s return value is irrelevant (so, the best, clearest style is to have it return <span class="code"><strong>None</strong></span>).</td>
</tr>
<tr>
<td><span class="code">close</span></td>
<td><span class="code">close()</span><br/>
			Sets a flag prohibiting further submissions to the pool. Worker processes terminate when they’re done with all outstanding tasks.</td>
</tr>
<tr>
<td><span class="code">imap</span></td>
<td><span class="code">imap(<em>func</em>,</span> <span class="code"><em>iterable</em></span><span class="code">, chunksize=1)</span><br/>
			Returns an iterator calling <span class="code"><em>func</em></span> on each item of <span class="code"><em>iterable</em></span>, in order. <span class="code">chunksize</span> determines how many consecutive items are sent to each process; on a very long <span class="code"><em>iterable</em></span>, a large <span class="code">chunksize</span> can improve performance. When <span class="code">chunksize</span> is <span class="code">1</span> (the default), the returned iterator has a method <span class="code">next</span> (even though the canonical name of the iterator’s method is <span class="code">__next__</span>), accepting an optional <span class="code"><em>timeout</em></span> argument (a floating-point value, in seconds) and raising <span class="code">multiprocessing.TimeoutError</span> should the result not yet be ready after <span class="code"><em>timeout</em></span> seconds.</td>
</tr>
<tr>
<td><span class="code">im⁠a⁠p⁠_​u⁠n⁠o⁠rdered</span></td>
<td><span class="code">imap_unordered(<em>func</em>,</span> <span class="code"><em>iterable</em></span><span class="code">, chunksize=1)</span><br/>
			Same as <span class="code">imap</span>, but the ordering of the results is arbitrary (this can sometimes improve performance when the order of iteration is unimportant). It is usually helpful if the function’s return value includes enough information to allow the results to be associated with the values from the iterable used to generate them.</td>
</tr>
<tr>
<td><span class="code">join</span></td>
<td><span class="code">join()</span><br/>
			Waits for all worker processes to exit. You must call <span class="code">close</span> or <span class="code">terminate</span> before you call <span class="code">join</span>.</td>
</tr>
<tr>
<td><span class="code">map</span></td>
<td><span class="code">map(<em>func</em>,</span> <span class="code"><em>iterable</em></span><span class="code">, chunksize=1)</span><br/>
			Calls <span class="code"><em>func</em></span> on each item of <span class="code"><em>iterable</em></span>, in order, in worker processes in the pool; waits for them all to finish, and returns the list of results. <span class="code">chunksize</span> determines how many consecutive items are sent to each process; on a very long <span class="code"><em>iterable</em></span>, a large <span class="code">chunksize</span> can improve performance.</td>
</tr>
<tr>
<td><span class="code">map_async</span></td>
<td><span class="code">map_async(<em>func</em>,</span> <span class="code"><em>iterable</em></span><span class="code">, chunksize=1, callback=<strong>None</strong>)</span><br/>
			Arranges for <span class="code"><em>func</em></span> to be called on each item of <span class="code"><em>iterable</em></span> in worker processes in the pool; without waiting for any of this to finish, immediately returns an <span class="code">AsyncResult</span> instance (described in the following section), which eventually gives the list of <span class="code"><em>func</em></span>’s results, when that list is ready.<br/>
			When <span class="code">callback</span> is not <span class="code"><strong>None</strong></span>, it’s a function to call (in a separate thread in the process that calls <span class="code">map_async</span>) with the list of <span class="code"><em>func</em></span>’s results, in order, as the only argument, when that list is ready; <span class="code">callback</span> should execute rapidly, since otherwise it blocks the process. <span class="code">callback</span> may mutate its list argument; <span class="code">callback</span>’s return value is irrelevant (so, best, clearest style is to have it return <span class="code"><strong>None</strong></span>).</td>
</tr>
<tr>
<td><span class="code">terminate</span></td>
<td><span class="code">terminate()</span><br/>
			Terminates all worker processes at once, without waiting for them to complete work.</td>
</tr>
</tbody>
</table>
<p>For example, here’s a <span class="code">Pool</span>-based approach to perform the same task as the code in <a data-type="xref" href="#example_onefive_onedot_distributing_wor">Example 15-1</a>:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">os</code><code class="o">,</code><code> </code><code class="nn">multiprocessing</code><code> </code><strong><code class="k">as</code></strong><code> </code><code class="nn">mp</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">f</code><code class="p">(</code><code class="n">s</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><em><code class="sd">"""Run a long time, and eventually return a result."""</code></em><code>
</code><strong><code>    </code><code class="kn">import</code></strong><code> </code><code class="nn">time</code><code class="o">,</code><code> </code><code class="nn">random</code><code>
</code><code>    </code><code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="n">random</code><code class="o">.</code><code class="n">random</code><code class="p">(</code><code class="p">)</code><code class="o">*</code><code class="mi">2</code><code class="p">)</code><code>  </code><em><code class="c1"># simulate slowness</code></em><code>
</code><code>    </code><strong><code class="k">return</code></strong><code> </code><code class="n">s</code><code class="o">+</code><code class="n">s</code><code>                     </code><em><code class="c1"># some computation or other</code></em><code>
</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">runner</code><code class="p">(</code><code class="n">s</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="n">os</code><code class="o">.</code><code class="n">getpid</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">s</code><code class="p">)</code><code>
</code><code>    </code><strong><code class="k">return</code></strong><code> </code><code class="n">s</code><code class="p">,</code><code> </code><code class="n">f</code><code class="p">(</code><code class="n">s</code><code class="p">)</code><code>
</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">make_dict</code><code class="p">(</code><code class="n">strings</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><strong><code class="k">with</code></strong><code> </code><code class="n">mp</code><code class="o">.</code><code class="n">Pool</code><code class="p">(</code><code class="p">)</code><code> </code><strong><code class="k">as</code></strong><code> </code><code class="n">pool</code><code class="p">:</code><code>
</code><code>        </code><code class="n">d</code><code> </code><code class="o">=</code><code> </code><code class="nb">dict</code><code class="p">(</code><code class="n">pool</code><code class="o">.</code><code class="n">imap_unordered</code><code class="p">(</code><code class="n">runner</code><code class="p">,</code><code> </code><code class="n">strings</code><code class="p">)</code><code class="p">)</code><code>
</code><code>        </code><strong><code class="k">return</code></strong><code> </code><code class="n">d</code></pre>
</div></section>
<section data-pdf-bookmark="The AsyncResult class" data-type="sect3"><div class="sect3" id="the_asyncresult_class">
<h3>The AsyncResult class</h3>
<p>The<a contenteditable="false" data-primary="AsyncResult class" data-type="indexterm" id="idm44924503524016"/> methods <span class="code">apply_async</span> and <span class="code">map_async</span> of the class <span class="code">Pool</span> return an instance of the class <span class="code">AsyncResult</span>. An instance <span class="code"><em>r</em></span> of the class <span class="code">AsyncResult</span> supplies the methods listed in <a data-type="xref" href="#methods_of_an_instance_r_of_class_async">Table 15-13</a>.</p>
<table class="border" id="methods_of_an_instance_r_of_class_async">
<caption><span class="label">Table 15-13. </span>Methods of an instance <span class="code">r</span> of class <span class="code">AsyncResult</span></caption>
<tbody>
<tr>
<td class="width-15"><span class="code">get</span></td>
<td><span class="code">get(timeout=<strong>None</strong>)</span><br/>
			Blocks and returns the result when ready, or re-raises the exception raised while computing the result. When <span class="code">timeout</span> is not <span class="code"><strong>None</strong></span>, it’s a floating-point value in seconds; <span class="code">get</span> raises <span class="code">multiprocessing.TimeoutError</span> should the result not yet be ready after <span class="code">timeout</span> seconds.</td>
</tr>
<tr>
<td><span class="code">ready</span></td>
<td><span class="code">ready()</span><br/>
			Does not block; returns <span class="code"><strong>True</strong></span> if the call has completed with a result or has raised an exception; otherwise, returns <span class="code"><strong>False</strong></span>.</td>
</tr>
<tr>
<td><span class="code">successful</span></td>
<td><span class="code">successful()</span><br/>
			Does not block; returns <span class="code"><strong>True</strong></span> if the result is ready and the computation did not raise an exception, or returns <span class="code"><strong>False</strong></span> if the computation raised an exception. If the result is not yet ready, <span class="code">successful</span> raises <span class="code">AssertionError</span>.</td>
</tr>
<tr>
<td><span class="code">wait</span></td>
<td><span class="code">wait(timeout=<strong>None</strong>)</span><br/>
			Blocks and waits until the result is ready. When <span class="code">timeout</span> is not <span class="code"><strong>None</strong></span>, it’s a floating-point value in seconds: <span class="code">wait</span> raises <span class="code">multiprocessing.TimeoutError</span> should the result not yet be ready after <span class="code">timeout</span> seconds.</td>
</tr>
</tbody>
</table>
</div></section>
<section data-pdf-bookmark="The ThreadPool class" data-type="sect3"><div class="sect3" id="the_threadpool_class">
<h3>The ThreadPool class</h3>
<p>The<a contenteditable="false" data-primary="ThreadPool class (multiprocessing.pool module)" data-type="indexterm" id="idm44924503468240"/> <span class="code">multiprocessing.pool</span> module also offers a class called <span class="code">ThreadPool</span>, with exactly the same interface as <span class="code">Pool</span>, implemented with multiple threads within a single process (not with multiple processes, despite the module’s name). The equivalent <span class="code">make_dict</span> code to <a data-type="xref" href="#example_onefive_onedot_distributing_wor">Example 15-1</a> using a <span class="code">ThreadPool</span> would be:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="k">def</code></strong><code> </code><code class="nf">make_dict</code><code class="p">(</code><code class="n">strings</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">num_workers</code><code class="o">=</code><code class="mi">3</code><code>
</code><code>    </code><strong><code class="k">with</code></strong><code> </code><code class="n">mp</code><code class="o">.</code><code class="n">pool</code><code class="o">.</code><code class="n">ThreadPool</code><code class="p">(</code><code class="n">num_workers</code><code class="p">)</code><code> </code><strong><code class="k">as</code></strong><code> </code><code class="n">pool</code><code class="p">:</code><code>
</code><code>        </code><code class="n">d</code><code> </code><code class="o">=</code><code> </code><code class="nb">dict</code><code class="p">(</code><code class="n">pool</code><code class="o">.</code><code class="n">imap_unordered</code><code class="p">(</code><code class="n">runner</code><code class="p">,</code><code> </code><code class="n">strings</code><code class="p">)</code><code class="p">)</code><code>
</code><code>        </code><strong><code class="k">return</code></strong><code> </code><code class="n">d</code></pre>
<p>Since a <span class="code">ThreadPool</span> uses multiple threads but is limited to running in a single process, it is most suitable for applications where the separate threads are performing overlapping I/O. As stated previously, Python threading offers little advantage when the work is primarily CPU-bound.</p>
<p>In modern Python, you should generally prefer the <span class="code">Executor</span> abstract class from the module <span class="code">concurrent</span>.<span class="code">futures</span>, covered in next section, and its two implementations, <span class="code">ThreadPoolExecutor</span> and <span class="code">ProcessPoolExecutor</span>. In particular, the <span class="code">Future</span> objects returned by <span class="code">submit</span> methods of the executor classes implemented by <span class="code">concurrent</span>.<span class="code">futures</span> are compatible with the <span class="code">asyncio</span> module (which, as previously mentioned, we do not cover in this book, but which is nevertheless a crucial part of much concurrent processing in recent versions of Python). The <span class="code">AsyncResult</span> objects returned by the methods <span class="code">apply_async</span> and <span class="code">map_async</span> of the pool classes implemented by <span class="code">multiprocessing</span> are not <span class="code">asyncio</span> compatible.<a contenteditable="false" data-primary="" data-startref="TAPmulti15" data-type="indexterm" id="idm44924503383024"/><a contenteditable="false" data-primary="" data-startref="multimod15" data-type="indexterm" id="idm44924503381712"/></p>
</div></section>
</div></section>
</div></section>
<section data-pdf-bookmark="The concurrent.futures Module" data-type="sect1"><div class="sect1" id="the_concurrentdotfutures_module">
<h1>The concurrent.futures Module</h1>
<p>The<a contenteditable="false" data-primary="threads and processes" data-secondary="concurrent.futures module" data-type="indexterm" id="TAPconmod15"/><a contenteditable="false" data-primary="concurrent.futures module" data-type="indexterm" id="conmod15"/> <span class="code">concurrent</span> package supplies a single module, <span class="code">futures</span>. <span class="code">concurrent</span>.<span class="code">futures</span> provides two classes, <span class="code">ThreadPoolExecutor</span> (using threads as workers) and <span class="code">ProcessPoolExecutor</span> (using processes as workers), which implement the same abstract interface, <span class="code">Executor</span>. Instantiate either kind of pool by calling the class with one argument, <span class="code">max_workers</span>, specifying how many threads or processes the pool should contain. You can omit <span class="code">max_workers</span> to let the system pick the number of workers.</p>
<p>An<a contenteditable="false" data-primary="Executor class (concurrent package)" data-type="indexterm" id="idm44924503368736"/> instance <span class="code"><em>e</em></span> of the <span class="code">Executor</span> class supports the methods in <a data-type="xref" href="#methods_of_an_instance_e_of_class_execu">Table 15-14</a>.</p>
<table class="border" id="methods_of_an_instance_e_of_class_execu">
<caption><span class="label">Table 15-14. </span>Methods of an instance <span class="code"><em>e</em></span> of class <span class="code">Executor</span></caption>
<tbody>
<tr>
<td class="width-15"><span class="code">map</span></td>
<td><span class="code">map(<em>func</em>,</span> <span class="code"><em>*iterables</em></span><span class="code">, timeout=<strong>None</strong>, chunksize=1)</span><br/>
			Returns an iterator <span class="code"><em>it</em></span> whose items are the results of <span class="code"><em>func</em></span> called with one argument from each of the <span class="code"><em>iterables</em></span>, in order (using multiple worker threads or processes to execute <span class="code"><em>func</em></span> in parallel). When <span class="code"><em>timeout</em></span> is not <span class="code"><strong>None</strong></span>, it’s a <span class="code">float</span> number of seconds: should <span class="code">next(<em>it</em>)</span> not produce any result in <span class="code">timeout</span> seconds, raises <span class="code">concurrent.futures.TimeoutError</span>.<br/>
			You may also optionally specify (by name, only) argument <span class="code">chunksize</span>: ignored for a <span class="code">ThreadPoolExecutor</span>; for a <span class="code">ProcessPoolExecutor</span> it sets how many items of each iterable in <span class="code"><em>iterables</em></span> are passed to each worker process.</td>
</tr>
<tr>
<td><span class="code">shutdown</span></td>
<td><span class="code">shutdown(wait=<strong>True</strong>)</span><br/>
			No more calls to <span class="code">map</span> or <span class="code">submit</span> allowed. When <span class="code">wait</span> is <span class="code"><strong>True</strong></span>, <span class="code">shutdown</span> blocks until all pending futures are done; when <span class="code"><strong>False</strong></span>, <span class="code">shutdown</span> returns immediately. In either case, the process does not terminate until all pending futures are done.</td>
</tr>
<tr>
<td><span class="code">submit</span></td>
<td><span class="code">submit(<em>func</em></span>, <span class="code"><em>*a</em></span>, <span class="code"><em>**k</em>)</span><br/>
			Ensures <span class="code"><em>func</em></span><span class="code">(*<em>a</em></span>, <span class="code"><em>**k</em>)</span> executes on an arbitrary one of the pool’s processes or threads. Does not block, but rather immediately returns a <span class="code">Future</span> instance.</td>
</tr>
</tbody>
</table>
<p>Any instance of an <span class="code">Executor</span> is also a context manager, and therefore suitable for use on a <span class="code"><strong>with</strong></span> statement (<span class="code">__exit__</span> being like <span class="code">shutdown(wait=<strong>True</strong>)</span>).</p>
<p class="pagebreak-before">For example, here’s a <span class="code">concurrent</span>-based approach to perform the same task as in <a data-type="xref" href="#example_onefive_onedot_distributing_wor">Example 15-1</a>:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">concurrent</code><code class="nn">.</code><code class="nn">futures</code><code> </code><strong><code class="k">as</code></strong><code> </code><code class="nn">cf</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">f</code><code class="p">(</code><code class="n">s</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><em><code class="sd">"""run a long time and eventually return a result"""</code></em><code>
</code><code>    </code><em><code class="c1"># ...</code></em><code class="c1"> </code><em><code class="c1">like before!</code></em><code>
</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">runner</code><code class="p">(</code><code class="n">s</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><strong><code class="k">return</code></strong><code> </code><code class="n">s</code><code class="p">,</code><code> </code><code class="n">f</code><code class="p">(</code><code class="n">s</code><code class="p">)</code><code>
</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">make_dict</code><code class="p">(</code><code class="n">strings</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><strong><code class="k">with</code></strong><code> </code><code class="n">cf</code><code class="o">.</code><code class="n">ProcessPoolExecutor</code><code class="p">(</code><code class="p">)</code><code> </code><strong><code class="k">as</code></strong><code> </code><code class="n">e</code><code class="p">:</code><code>
</code><code>        </code><code class="n">d</code><code> </code><code class="o">=</code><code> </code><code class="nb">dict</code><code class="p">(</code><code class="n">e</code><code class="o">.</code><code class="n">map</code><code class="p">(</code><code class="n">runner</code><code class="p">,</code><code> </code><code class="n">strings</code><code class="p">)</code><code class="p">)</code><code>
</code><code>    </code><strong><code class="k">return</code></strong><code> </code><code class="n">d</code></pre>
<p>The<a contenteditable="false" data-primary="Future class (concurrent.futures module)" data-type="indexterm" id="idm44924503235072"/> <span class="code">submit</span> method of an <span class="code">Executor</span> returns a <span class="code">Future</span> instance. A <span class="code">Future</span> instance <span class="code"><em>f</em></span> supplies the methods described in <a data-type="xref" href="#methods_of_an_instance_f_of_class_futur">Table 15-15</a>.</p>
<table class="border" id="methods_of_an_instance_f_of_class_futur">
<caption><span class="label">Table 15-15. </span>Methods of an instance <span class="code">f</span> of class <span class="code">Future</span></caption>
<tbody>
<tr>
<td><span class="code">add_do⁠n⁠e⁠_​c⁠a⁠l⁠lback</span></td>
<td><span class="code">add_done_callback(<em>func</em>)</span><br/>
			Adds callable <span class="code"><em>func</em></span> to <span class="code"><em>f</em></span>; <span class="code"><em>func</em></span> gets called, with <span class="code"><em>f</em></span> as the only argument, when <span class="code"><em>f</em></span> completes (i.e., is canceled, or finishes).</td>
</tr>
<tr>
<td><span class="code">cancel</span></td>
<td><span class="code">cancel()</span><br/>
			Tries canceling the call. Returns <span class="code"><strong>False</strong></span> when the call is being executed and cannot be canceled; otherwise, returns <span class="code"><strong>True</strong></span>.</td>
</tr>
<tr>
<td><span class="code">cancelled</span></td>
<td><span class="code">cancelled()</span><br/>
			Returns <span class="code"><strong>True</strong></span> if the call was successfully canceled; otherwise, returns <span class="code"><strong>False</strong></span>.</td>
</tr>
<tr>
<td><span class="code">done</span></td>
<td><span class="code">done()</span><br/>
			Returns <span class="code"><strong>True</strong></span> when the call is completed (i.e., finished, or successfully canceled).</td>
</tr>
<tr>
<td><span class="code">exception</span></td>
<td><span class="code">exception(timeout=<strong>None</strong>)</span><br/>
			Returns the exception raised by the call, or <span class="code"><strong>None</strong></span> if the call raised no exception. When <span class="code">timeout</span> is not <span class="code"><strong>None</strong></span>, it’s a <span class="code">float</span> number of seconds to wait. If the call hasn’t completed after <span class="code">timeout</span> seconds, <span class="code">exception</span> raises <span class="code">concurrent.futures.TimeoutError</span>; if the call is canceled, <span class="code">exception</span> raises <span class="code">concurrent.futures.CancelledError</span>.</td>
</tr>
<tr>
<td><span class="code">result</span></td>
<td><span class="code">result(timeout=<strong>None</strong>)</span><br/>
			Returns the call’s result. When <span class="code">timeout</span> is not <span class="code"><strong>None</strong></span>, it’s a <span class="code">float</span> number of seconds. If the call hasn’t completed within <span class="code">timeout</span> seconds, <span class="code">result</span> raises <span class="code">concurrent.futures.TimeoutError</span>; if the call is canceled, <span class="code">result</span> raises <span class="code">concurrent.futures.CancelledError</span>.</td>
</tr>
<tr>
<td><span class="code">running</span></td>
<td><span class="code">running()</span><br/>
			Returns <span class="code"><strong>True</strong></span> when the call is executing and cannot be canceled; otherwise, returns <span class="code"><strong>False</strong></span>.</td>
</tr>
</tbody>
</table>
<p class="pagebreak-before">The <span class="code">concurrent.futures</span> module also supplies two functions, detailed in <a data-type="xref" href="#functions_of_the_concurrentdotfutures_m">Table 15-16</a>.</p>
<table class="border" id="functions_of_the_concurrentdotfutures_m">
<caption><span class="label">Table 15-16. </span>Functions of the <span class="code">concurrent.futures</span> module</caption>
<tbody>
<tr>
<td class="width-20"><span class="code">a⁠s⁠_​c⁠o⁠m⁠pleted</span></td>
<td><span class="code">as_completed(<em>fs</em>, timeout=<strong>None</strong>)</span><br/>
			Returns an iterator <span class="code"><em>it</em></span> over the <span class="code">Future</span> instances that are the items of iterable <span class="code"><em>fs</em></span>. If there are duplicates in <span class="code"><em>fs</em></span>, each gets yielded just once. <span class="code"><em>it</em></span> yields one completed future at a time, in order, as they complete. If <span class="code">timeout</span> is not <span class="code"><strong>None</strong></span>, it’s a <span class="code">float</span> number of seconds; should it ever happen that no new future can yet be yielded within <span class="code">timeout</span> seconds from the previous one, <span class="code">as_completed</span> raises <span class="code">concurrent.futures.Timeout</span>.</td>
</tr>
<tr>
<td><span class="code">wait</span></td>
<td><span class="code">wait(<em>fs</em>, timeout=<strong>None</strong>, return_when=ALL_COMPLETED)</span><br/>
			Waits for the <span class="code">Future</span> instances that are the items of iterable <span class="code"><em>fs</em></span>. Returns a named 2-tuple of <span class="code">set</span>s: the first <span class="code">set</span>, named <span class="code">done</span>, contains the futures that completed (meaning that they either finished or were canceled) before <span class="code">wait</span> returned; the second <span class="code">set</span>, named <span class="code">not_done</span>, contains as-yet-uncompleted futures.<br/>
<span class="code">timeout</span>, if not <span class="code"><strong>None</strong></span>, is a <span class="code">float</span> number of seconds, the maximum time <span class="code">wait</span> lets elapse before returning (when <span class="code">timeout</span> is <span class="code"><strong>None</strong></span>, <span class="code">wait</span> returns only when <span class="code">return_when</span> is satisfied, no matter how much time elapses before that happens).<br/>
<span class="code">return_when</span> controls when, exactly, <span class="code">wait</span> returns; it must be one of three constants supplied by the module <span class="code">concurrent.futures</span>:
			<dl>
<dt class="plain"><span class="code">ALL_COMPLETED</span></dt>
<dd>Return when all futures finish or are canceled.</dd>
<dt class="plain"><span class="code">FIRST_COMPLETED</span></dt>
<dd>Return when any future finishes or is canceled.</dd>
<dt class="plain"><span class="code">FIRST_EXCEPTION</span></dt>
<dd>Return when any future raises an exception; should no future raise an exception, becomes equivalent to <span class="code">ALL_COMPLETED</span>.</dd>
</dl>
</td>
</tr>
</tbody>
</table>
<p>This version of <span class="code">make_dict</span> illustrates how to use <span class="code">concurrent.futures.as_completed</span> to process each task as it finishes (in contrast with the previous example using <span class="code">Executor.map</span>, which always returns the tasks in the order in which they<a contenteditable="false" data-primary="" data-startref="TAPconmod15" data-type="indexterm" id="idm44924503123200"/><a contenteditable="false" data-primary="" data-startref="conmod15" data-type="indexterm" id="idm44924503121744"/> were submitted):</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">concurrent</code><code class="nn">.</code><code class="nn">futures</code><code> </code><strong><code class="k">as</code></strong><code> </code><code class="nn">cf</code><code>
</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">make_dict</code><code class="p">(</code><code class="n">strings</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><strong><code class="k">with</code></strong><code> </code><code class="n">cf</code><code class="o">.</code><code class="n">ProcessPoolExecutor</code><code class="p">(</code><code class="p">)</code><code> </code><strong><code class="k">as</code></strong><code> </code><code class="n">e</code><code class="p">:</code><code>
</code><code>        </code><code class="n">futures</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="n">e</code><code class="o">.</code><code class="n">submit</code><code class="p">(</code><code class="n">runner</code><code class="p">,</code><code> </code><code class="n">s</code><code class="p">)</code><code> </code><strong><code class="k">for</code></strong><code> </code><code class="n">s</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">strings</code><code class="p">]</code><code>
</code><code>        </code><code class="n">d</code><code> </code><code class="o">=</code><code> </code><code class="nb">dict</code><code class="p">(</code><code class="n">f</code><code class="o">.</code><code class="n">result</code><code class="p">(</code><code class="p">)</code><code> </code><strong><code class="k">for</code></strong><code> </code><code class="n">f</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">cf</code><code class="o">.</code><code class="n">as_completed</code><code class="p">(</code><code class="n">futures</code><code class="p">)</code><code class="p">)</code><code>
</code><code>    </code><strong><code class="k">return</code></strong><code> </code><code class="n">d</code></pre>
</div></section>
<section data-pdf-bookmark="Threaded Program Architecture" data-type="sect1"><div class="sect1" id="threaded_program_architecture">
<h1>Threaded Program Architecture</h1>
<p>A<a contenteditable="false" data-primary="threads and processes" data-secondary="threaded program architecture" data-type="indexterm" id="TAParch15"/><a contenteditable="false" data-primary="programs" data-secondary="threaded program architecture" data-type="indexterm" id="Pthread15"/> threaded program should always try to arrange for a<a contenteditable="false" data-primary="owning threads" data-type="indexterm" id="idm44924503047648"/> <em>single</em> thread to “own” any object or subsystem that is external to the program (such as a file, a database, a GUI, or a network connection). Having multiple threads that deal with the same external object is possible, but can often create intractable problems.</p>
<p>When your threaded program must deal with some external object, devote a dedicated thread to just such dealings, and use a <span class="code">Queue</span> object from which the external-interfacing thread gets work requests that other threads post. The external-interfacing thread returns results by putting them on one or more other <span class="code">Queue</span> objects. The following example shows how to package this architecture into a general, reusable class, assuming that each unit of work on the external subsystem can be represented by a callable object:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">threading</code><code class="o">,</code><code> </code><code class="nn">queue</code><code>
</code><code>
</code><strong><code class="k">class</code></strong><code> </code><code class="nc">ExternalInterfacing</code><code class="p">(</code><code class="n">threading</code><code class="o">.</code><code class="n">Thread</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><strong><code class="k">def</code></strong><code> </code><code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">external_callable</code><code class="p">,</code><code> </code><code class="o">*</code><code class="o">*</code><code class="n">kwds</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="nb">super</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="fm">__init__</code><code class="p">(</code><code class="o">*</code><code class="o">*</code><code class="n">kwds</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">daemon</code><code> </code><code class="o">=</code><code> </code><strong><code class="kc">True</code></strong><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">external_callable</code><code> </code><code class="o">=</code><code> </code><code class="n">external_callable</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">request_queue</code><code> </code><code class="o">=</code><code> </code><code class="n">queue</code><code class="o">.</code><code class="n">Queue</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">result_queue</code><code> </code><code class="o">=</code><code> </code><code class="n">queue</code><code class="o">.</code><code class="n">Queue</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">start</code><code class="p">(</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><strong><code class="k">def</code></strong><code> </code><code class="nf">request</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="o">*</code><code class="n">args</code><code class="p">,</code><code> </code><code class="o">*</code><code class="o">*</code><code class="n">kwds</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><em><code class="sd">"""called by other threads as external_callable would be"""</code></em><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">request_queue</code><code class="o">.</code><code class="n">put</code><code class="p">(</code><code class="p">(</code><code class="n">args</code><code class="p">,</code><code> </code><code class="n">kwds</code><code class="p">)</code><code class="p">)</code><code>
</code><code>        </code><strong><code class="k">return</code></strong><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">result_queue</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><strong><code class="k">def</code></strong><code> </code><code class="nf">run</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><strong><code class="k">while</code><code> </code><code class="kc">True</code></strong><code class="p">:</code><code>
</code><code>            </code><code class="n">a</code><code class="p">,</code><code> </code><code class="n">k</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">request_queue</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="p">)</code><code>
</code><code>            </code><code class="bp">self</code><code class="o">.</code><code class="n">result_queue</code><code class="o">.</code><code class="n">put</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">external_callable</code><code class="p">(</code><code class="o">*</code><code class="n">a</code><code class="p">,</code><code> </code><code class="o">*</code><code class="o">*</code><code class="n">k</code><code class="p">)</code><code class="p">)</code></pre>
<p>Once some <span class="code">ExternalInterfacing</span> object <span class="code"><em>ei</em></span> is instantiated, any other thread may call <span class="code"><em>ei</em></span><span class="code">.request</span> just as it would call <span class="code">external_callable</span> absent such a mechanism (with or without arguments, as appropriate). The advantage of <span class="code">ExternalInterfacing</span> is that calls to <span class="code">external_callable</span> are<a contenteditable="false" data-primary="serialized calls (threading)" data-type="indexterm" id="idm44924502856416"/> <em>serialized</em>. This means that just one thread (the <span class="code">Thread</span> object bound to <span class="code"><em>ei</em></span>) performs them, in some defined sequential order, without overlap, race conditions (hard-to-debug errors that depend on which thread just happens to “get there” first), or other anomalies that might otherwise result.</p>
<p>If you need to serialize several callables together, you can pass the callable as part of the work request, rather than passing it at the initialization of the class <span class="code">ExternalInterfacing</span>, for greater generality. The following example shows this more general approach:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">threading</code><code class="o">,</code><code> </code><code class="nn">queue</code><code>
</code><code>
</code><strong><code class="k">class</code></strong><code> </code><code class="nc">Serializer</code><code class="p">(</code><code class="n">threading</code><code class="o">.</code><code class="n">Thread</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="o">*</code><code class="o">*</code><code class="n">kwds</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="nb">super</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="fm">__init__</code><code class="p">(</code><code class="o">*</code><code class="o">*</code><code class="n">kwds</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">daemon</code><code> </code><code class="o">=</code><code> </code><strong><code class="kc">True</code></strong><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">work_request_queue</code><code> </code><code class="o">=</code><code> </code><code class="n">queue</code><code class="o">.</code><code class="n">Queue</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">result_queue</code><code> </code><code class="o">=</code><code> </code><code class="n">queue</code><code class="o">.</code><code class="n">Queue</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">start</code><code class="p">(</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><strong><code class="k">def</code></strong><code> </code><code class="nf">apply</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">callable</code><code class="p">,</code><code> </code><code class="o">*</code><code class="n">args</code><code class="p">,</code><code> </code><code class="o">*</code><code class="o">*</code><code class="n">kwds</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><em><code class="sd">"""called by other threads as `callable` would be"""</code></em><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">work_request_queue</code><code class="o">.</code><code class="n">put</code><code class="p">(</code><code class="p">(</code><code class="n">callable</code><code class="p">,</code><code> </code><code class="n">args</code><code class="p">,</code><code> </code><code class="n">kwds</code><code class="p">)</code><code class="p">)</code><code>
</code><code>        </code><strong><code class="k">return</code></strong><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">result_queue</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><strong><code class="k">def</code></strong><code> </code><code class="nf">run</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><strong><code class="k">while</code><code> </code><code class="kc">True</code></strong><code class="p">:</code><code>
</code><code>            </code><code class="n">callable</code><code class="p">,</code><code> </code><code class="n">args</code><code class="p">,</code><code> </code><code class="n">kwds</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">work_request_queue</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="p">)</code><code>
</code><code>            </code><code class="bp">self</code><code class="o">.</code><code class="n">result_queue</code><code class="o">.</code><code class="n">put</code><code class="p">(</code><code class="n">callable</code><code class="p">(</code><code class="o">*</code><code class="n">args</code><code class="p">,</code><code> </code><code class="o">*</code><code class="o">*</code><code class="n">kwds</code><code class="p">)</code><code class="p">)</code></pre>
<p>Once a <span class="code">Serializer</span> object <span class="code"><em>ser</em></span> has been instantiated, any other thread may call <span class="code"><em>ser</em></span><span class="code">.apply(external_callable)</span> just as it would call <span class="code">external_callable</span> without such a mechanism (with or without further arguments, as appropriate). The <span class="code">Serializer</span> mechanism has the same advantages as <span class="code">ExternalInterfacing</span>, except that all calls to the same or different callables wrapped by a single <span class="code"><em>ser</em></span> instance are now serialized.</p>
<p>The user interface of the whole program is an external subsystem, and thus should be dealt with by a single thread—specifically, the main thread of the program (this is mandatory for some user interface toolkits, and advisable even when using other toolkits that don’t mandate it). A <span class="code">Serializer</span> thread is therefore inappropriate. Rather, the program’s main thread should deal only with user-interface issues, and farm out all actual work to<a contenteditable="false" data-primary="worker threads" data-type="indexterm" id="idm44924502646768"/> worker threads that accept work requests on a <span class="code">Queue</span> object and return results on another. A set of worker threads is generally known as a<a contenteditable="false" data-primary="thread pools" data-type="indexterm" id="idm44924502644848"/> <em>thread pool</em>. As shown in the following example, all worker threads should share a single queue of requests and a single queue of results, since the main thread is the only one to post work requests and harvest results:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">threading</code><code>
</code><code>
</code><strong><code class="k">class</code></strong><code> </code><code class="nc">Worker</code><code class="p">(</code><code class="n">threading</code><code class="o">.</code><code class="n">Thread</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">IDlock</code><code> </code><code class="o">=</code><code> </code><code class="n">threading</code><code class="o">.</code><code class="n">Lock</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="n">request_ID</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code>
</code><code>
</code><code>    </code><strong><code class="k">def</code></strong><code> </code><code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">requests_queue</code><code class="p">,</code><code> </code><code class="n">results_queue</code><code class="p">,</code><code> </code><code class="o">*</code><code class="o">*</code><code class="n">kwds</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="nb">super</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="fm">__init__</code><code class="p">(</code><code class="o">*</code><code class="o">*</code><code class="n">kwds</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">daemon</code><code> </code><code class="o">=</code><code> </code><strong><code class="kc">True</code></strong><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">request_queue</code><code> </code><code class="o">=</code><code> </code><code class="n">requests_queue</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">result_queue</code><code> </code><code class="o">=</code><code> </code><code class="n">results_queue</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">start</code><code class="p">(</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><strong><code class="k">def</code></strong><code> </code><code class="nf">perform_work</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">callable</code><code class="p">,</code><code> </code><code class="o">*</code><code class="n">args</code><code class="p">,</code><code> </code><code class="o">*</code><code class="o">*</code><code class="n">kwds</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><em><code class="sd">"""called by main thread as `callable` would be,
			   but w/o return"""</code></em><code>
</code><code>        </code><strong><code class="k">with</code></strong><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">IDlock</code><code class="p">:</code><code>
</code><code>            </code><code class="n">Worker</code><code class="o">.</code><code class="n">request_ID</code><code> </code><code class="o">+</code><code class="o">=</code><code> </code><code class="mi">1</code><code>
</code><code>            </code><code class="bp">self</code><code class="o">.</code><code class="n">request_queue</code><code class="o">.</code><code class="n">put</code><code class="p">(</code><code>
</code><code>                </code><code class="p">(</code><code class="n">Worker</code><code class="o">.</code><code class="n">request_ID</code><code class="p">,</code><code> </code><code class="n">callable</code><code class="p">,</code><code> </code><code class="n">args</code><code class="p">,</code><code> </code><code class="n">kwds</code><code class="p">)</code><code class="p">)</code><code>
</code><code>            </code><strong><code class="k">return</code></strong><code> </code><code class="n">Worker</code><code class="o">.</code><code class="n">request_ID</code><code>
</code><code>
</code><code>    </code><strong><code class="k">def</code></strong><code> </code><code class="nf">run</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><strong><code class="k">while</code><code> </code><code class="kc">True</code></strong><code class="p">:</code><code>
</code><code>            </code><code class="n">request_ID</code><code class="p">,</code><code> </code><code class="n">callable</code><code class="p">,</code><code> </code><code class="n">a</code><code class="p">,</code><code> </code><code class="n">k</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">request_queue</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="p">)</code><code>
</code><code>            </code><code class="bp">self</code><code class="o">.</code><code class="n">result_queue</code><code class="o">.</code><code class="n">put</code><code class="p">(</code><code class="p">(</code><code class="n">request_ID</code><code class="p">,</code><code> </code><code class="n">callable</code><code class="p">(</code><code class="o">*</code><code class="n">a</code><code class="p">,</code><code> </code><code class="o">*</code><code class="o">*</code><code class="n">k</code><code class="p">)</code><code class="p">)</code><code class="p">)</code></pre>
<p>The main thread creates the two queues, then instantiates worker threads, as <span class="keep-together">follows</span>:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">queue</code><code>
</code><code class="n">requests_queue</code><code> </code><code class="o">=</code><code> </code><code class="n">queue</code><code class="o">.</code><code class="n">Queue</code><code class="p">(</code><code class="p">)</code><code>
</code><code class="n">results_queue</code><code> </code><code class="o">=</code><code> </code><code class="n">queue</code><code class="o">.</code><code class="n">Queue</code><code class="p">(</code><code class="p">)</code><code>
</code><code class="n">number_of_workers</code><code> </code><code class="o">=</code><code> </code><code class="mi">5</code><code>
</code><strong><code class="k">for</code></strong><code> </code><code class="n">i</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="nb">range</code><code class="p">(</code><code class="n">number_of_workers</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">worker</code><code> </code><code class="o">=</code><code> </code><code class="n">Worker</code><code class="p">(</code><code class="n">requests_queue</code><code class="p">,</code><code> </code><code class="n">results_queue</code><code class="p">)</code></pre>
<p>Whenever the main thread needs to farm out work (execute some callable object that may take substantial time to produce results), the main thread calls <span class="code"><em>worker</em></span><span class="code">.perform_work(<em>callable</em>)</span>, much as it would call <span class="code"><em>callable</em></span> without such a mechanism (with or without further arguments, as appropriate). However, <span class="code">perform_work</span> does not return the result of the call. Instead of the results, the main thread gets an ID that identifies the work request. When the main thread needs the results, it can keep track of that ID, since the request’s results are tagged with the ID when they appear. The advantage of this mechanism is that the main thread never blocks waiting for the callable’s execution to complete, but rather becomes ready again at once and can immediately return to its main business of dealing with the user interface.</p>
<p>The main thread must arrange to check the <span class="code">results_queue</span>, since the result of each work request eventually appears there, tagged with the request’s ID, when the worker thread that took that request from the queue finishes computing the result. How the main thread arranges to check for both user interface events and the results coming back from worker threads onto the results queue depends on what user interface toolkit is used, or—if the user interface is text-based—on the platform on which the program runs.</p>
<p>A widely applicable, though not always optimal, general strategy is for the main thread to<a contenteditable="false" data-primary="polling" data-type="indexterm" id="idm44924502308896"/> <em>poll</em> (check the state of the results queue periodically). On most Unix-like platforms, the function <span class="code">alarm</span> of the module <span class="code">signal</span> allows polling. The<a contenteditable="false" data-primary="tkinter GUI toolkit" data-type="indexterm" id="idm44924502305696"/> <span class="code">tkinter</span> GUI toolkit supplies an <span class="code">after</span> method that is usable for polling. Some toolkits and platforms afford more effective strategies (such as letting a worker thread alert the main thread when it places some result on the results queue), but there is no generally available, cross-platform, cross-toolkit way to arrange for this. Therefore, the following artificial example ignores user interface events and just simulates work by evaluating random expressions, with random delays, on several worker threads, thus completing the previous<a contenteditable="false" data-primary="" data-startref="TAParch15" data-type="indexterm" id="idm44924502269440"/><a contenteditable="false" data-primary="" data-startref="Pthread15" data-type="indexterm" id="idm44924502268224"/> example:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">random</code><code class="o">,</code><code> </code><code class="nn">time</code><code class="o">,</code><code> </code><code class="nn">queue</code><code class="o">,</code><code> </code><code class="nn">operator</code><code>
</code><em><code class="c1"># copy here class Worker as defined earlier</code></em><code>
</code><code>
</code><code class="n">requests_queue</code><code> </code><code class="o">=</code><code> </code><code class="n">queue</code><code class="o">.</code><code class="n">Queue</code><code class="p">(</code><code class="p">)</code><code>
</code><code class="n">results_queue</code><code> </code><code class="o">=</code><code> </code><code class="n">queue</code><code class="o">.</code><code class="n">Queue</code><code class="p">(</code><code class="p">)</code><code>
</code><code>
</code><code class="n">number_of_workers</code><code> </code><code class="o">=</code><code> </code><code class="mi">3</code><code>
</code><code class="n">workers</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="n">Worker</code><code class="p">(</code><code class="n">requests_queue</code><code class="p">,</code><code> </code><code class="n">results_queue</code><code class="p">)</code><code>
</code><code>           </code><strong><code class="k">for</code></strong><code> </code><code class="n">i</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="nb">range</code><code class="p">(</code><code class="n">number_of_workers</code><code class="p">)</code><code class="p">]</code><code>
</code><code class="n">work_requests</code><code> </code><code class="o">=</code><code> </code><code class="p">{</code><code class="p">}</code><code>
</code><code>
</code><code class="n">operations</code><code> </code><code class="o">=</code><code> </code><code class="p">{</code><code>
</code><code>    </code><code class="s1">'</code><code class="s1">+</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="n">operator</code><code class="o">.</code><code class="n">add</code><code class="p">,</code><code>
</code><code>    </code><code class="s1">'</code><code class="s1">-</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="n">operator</code><code class="o">.</code><code class="n">sub</code><code class="p">,</code><code>
</code><code>    </code><code class="s1">'</code><code class="s1">*</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="n">operator</code><code class="o">.</code><code class="n">mul</code><code class="p">,</code><code>
</code><code>    </code><code class="s1">'</code><code class="s1">/</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="n">operator</code><code class="o">.</code><code class="n">truediv</code><code class="p">,</code><code>
</code><code>    </code><code class="s1">'</code><code class="s1">%</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="n">operator</code><code class="o">.</code><code class="n">mod</code><code class="p">,</code><code>
</code><code class="p">}</code><code>
</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">pick_a_worker</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">random</code><code class="o">.</code><code class="n">choice</code><code class="p">(</code><code class="n">workers</code><code class="p">)</code><code>
</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">make_work</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">o1</code><code> </code><code class="o">=</code><code> </code><code class="n">random</code><code class="o">.</code><code class="n">randrange</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code><code> </code><code class="mi">10</code><code class="p">)</code><code>
</code><code>    </code><code class="n">o2</code><code> </code><code class="o">=</code><code> </code><code class="n">random</code><code class="o">.</code><code class="n">randrange</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code><code> </code><code class="mi">10</code><code class="p">)</code><code>
</code><code>    </code><code class="n">op</code><code> </code><code class="o">=</code><code> </code><code class="n">random</code><code class="o">.</code><code class="n">choice</code><code class="p">(</code><code class="nb">list</code><code class="p">(</code><code class="n">operations</code><code class="p">)</code><code class="p">)</code><code>
</code><code>    </code><strong><code class="k">return</code></strong><code> </code><code class="sa">f</code><code class="s1">'</code><code class="si">{</code><code class="n">o1</code><code class="si">}</code><code class="s1"> </code><code class="si">{</code><code class="n">op</code><code class="si">}</code><code class="s1"> </code><code class="si">{</code><code class="n">o2</code><code class="si">}</code><code class="s1">'</code><code>
</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">slow_evaluate</code><code class="p">(</code><code class="n">expression_string</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="n">random</code><code class="o">.</code><code class="n">randrange</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">5</code><code class="p">)</code><code class="p">)</code><code>
</code><code>    </code><code class="n">op1</code><code class="p">,</code><code> </code><code class="n">oper</code><code class="p">,</code><code> </code><code class="n">op2</code><code> </code><code class="o">=</code><code> </code><code class="n">expression_string</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="n">arith_function</code><code> </code><code class="o">=</code><code> </code><code class="n">operations</code><code class="p">[</code><code class="n">oper</code><code class="p">]</code><code>
</code><code>    </code><strong><code class="k">return</code></strong><code> </code><code class="n">arith_function</code><code class="p">(</code><code class="nb">int</code><code class="p">(</code><code class="n">op1</code><code class="p">)</code><code class="p">,</code><code> </code><code class="nb">int</code><code class="p">(</code><code class="n">op2</code><code class="p">)</code><code class="p">)</code><code>
</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">show_results</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><strong><code class="k">while</code></strong><code> </code><strong><code class="kc">True</code></strong><code class="p">:</code><code>
</code><code>        </code><strong><code class="k">try</code></strong><code class="p">:</code><code>
</code><code>            </code><code class="n">completed_id</code><code class="p">,</code><code> </code><code class="n">results</code><code> </code><code class="o">=</code><code> </code><code class="n">results_queue</code><code class="o">.</code><code class="n">get_nowait</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><strong><code class="k">except</code></strong><code> </code><code class="n">queue</code><code class="o">.</code><code class="n">Empty</code><code class="p">:</code><code>
</code><code>            </code><strong><code class="k">return</code></strong><code>
</code><code>        </code><code class="n">work_expression</code><code> </code><code class="o">=</code><code> </code><code class="n">work_requests</code><code class="o">.</code><code class="n">pop</code><code class="p">(</code><code class="n">completed_id</code><code class="p">)</code><code>
</code><code>        </code><code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s1">'</code><code class="s1">Result </code><code class="si">{</code><code class="n">completed_id</code><code class="si">}</code><code class="s1">: </code><code class="si">{</code><code class="n">work_expression</code><code class="si">}</code><code class="s1"> -&gt; </code><code class="si">{</code><code class="n">results</code><code class="si">}</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>
</code><strong><code class="k">for</code></strong><code> </code><code class="n">i</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="nb">range</code><code class="p">(</code><code class="mi">10</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">expression_string</code><code> </code><code class="o">=</code><code> </code><code class="n">make_work</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="n">worker</code><code> </code><code class="o">=</code><code> </code><code class="n">pick_a_worker</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="n">request_id</code><code> </code><code class="o">=</code><code> </code><code class="n">worker</code><code class="o">.</code><code class="n">perform_work</code><code class="p">(</code><code class="n">slow_evaluate</code><code class="p">,</code><code> </code><code class="n">expression_string</code><code class="p">)</code><code>
</code><code>    </code><code class="n">work_requests</code><code class="p">[</code><code class="n">request_id</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">expression_string</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s1">'</code><code class="s1">Submitted request </code><code class="si">{</code><code class="n">request_id</code><code class="si">}</code><code class="s1">: </code><code class="si">{</code><code class="n">expression_string</code><code class="si">}</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>    </code><code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mf">1.0</code><code class="p">)</code><code>
</code><code>    </code><code class="n">show_results</code><code class="p">(</code><code class="p">)</code><code>
</code><code>
</code><strong><code class="k">while</code></strong><code> </code><code class="n">work_requests</code><code class="p">:</code><code>
</code><code>    </code><code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mf">1.0</code><code class="p">)</code><code>
</code><code>    </code><code class="n">show_results</code><code class="p">(</code><code class="p">)</code></pre>
</div></section>
<section data-pdf-bookmark="Process Environment" data-type="sect1"><div class="sect1" id="process_environment">
<h1>Process Environment</h1>
<p>The<a contenteditable="false" data-primary="threads and processes" data-secondary="process environments" data-type="indexterm" id="idm44924501872448"/><a contenteditable="false" data-primary="process environment" data-type="indexterm" id="idm44924501871200"/> operating system supplies each process <span class="code"><em>P</em></span> with an <em>environment</em>, a set of variables whose names are strings (most often, by convention, uppercase identifiers) and whose values are also strings. In <a data-type="xref" href="ch02.xhtml#environment_variables">“Environment Variables”</a>, we cover environment variables that affect Python’s operations. Operating system shells offer ways to examine and modify the environment via shell commands and other means mentioned in that section.</p>
<div data-type="tip">
<h1>Process Environments Are Self-Contained</h1>
<p>The environment of any process <span class="code"><em>P</em></span> is determined when <span class="code"><em>P</em></span> starts. After startup, only <span class="code"><em>P</em></span> itself can change <span class="code"><em>P</em></span>’s environment. Changes to <span class="code"><em>P</em></span>’s environment affect only <span class="code"><em>P</em></span>: the environment is <em>not</em> a means of interprocess communication. Nothing that <span class="code"><em>P</em></span> does affects the environment of <span class="code"><em>P</em></span>’s parent process (the process that started <span class="code"><em>P</em></span>), nor that of any child process <em>previously</em> started from <span class="code"><em>P</em></span> and now running, or of any process unrelated to <span class="code"><em>P</em></span>. Child processes of <span class="code"><em>P</em></span> normally get a copy of <span class="code"><em>P</em></span>’s environment as it stands at the time <span class="code"><em>P</em></span> creates that process as a starting environment. In this narrow sense, changes to <span class="code"><em>P</em></span>’s environment do affect child processes that <span class="code"><em>P</em></span> starts <em>after</em> such changes.</p>
</div>
<p>The<a contenteditable="false" data-primary="os module" data-secondary="in process environments" data-secondary-sortas="process environments" data-type="indexterm" id="idm44924501886544"/> module <span class="code">os</span> supplies the attribute <span class="code">environ</span>, a mapping that represents the current process’s environment. When Python starts, it initializes <span class="code">os.environ</span> from the process environment. Changes to <span class="code">os.environ</span> update the current process’s environment if the platform supports such updates. Keys and values in <span class="code">os.environ</span> must be strings. On Windows (but not on Unix-like platforms), keys into <span class="code">os.environ</span> are implicitly uppercased. For example, here’s how to try to determine which shell or command processor you’re running under:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">os</code><code>
</code><code class="n">shell</code><code> </code><code class="o">=</code><code> </code><code class="n">os</code><code class="o">.</code><code class="n">environ</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s1">'</code><code class="s1">COMSPEC</code><code class="s1">'</code><code class="p">)</code><code>
</code><strong><code class="k">if</code></strong><code> </code><code class="n">shell</code><code> </code><strong><code class="ow">is</code><code> </code><code class="kc">None</code></strong><code class="p">:</code><code>
</code><code>    </code><code class="n">shell</code><code> </code><code class="o">=</code><code> </code><code class="n">os</code><code class="o">.</code><code class="n">environ</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s1">'</code><code class="s1">SHELL</code><code class="s1">'</code><code class="p">)</code><code>
</code><strong><code class="k">if</code></strong><code> </code><code class="n">shell</code><code> </code><strong><code class="ow">is</code><code> </code><code class="kc">None</code></strong><code class="p">:</code><code>
</code><code>    </code><code class="n">shell</code><code> </code><code class="o">=</code><code> </code><code class="s1">'</code><code class="s1">an unknown command processor</code><code class="s1">'</code><code>
</code><code class="nb">print</code><code class="p">(</code><code class="s1">'</code><code class="s1">Running under </code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">shell</code><code class="p">)</code></pre>
<p>When a Python program changes its environment (e.g., via <span class="code">os.environ['X'] = 'Y'</span>), this does not affect the environment of the shell or command processor that started the program. As already explained—and for <strong>all</strong> programming languages, including Python—changes to a process’s environment affect only the process itself, not other processes that are currently running.</p>
</div></section>
<section data-pdf-bookmark="Running Other Programs" data-type="sect1"><div class="sect1" id="running_other_programs">
<h1>Running Other Programs</h1>
<p>You<a contenteditable="false" data-primary="threads and processes" data-secondary="running other programs" data-type="indexterm" id="TAPother15"/> can run other programs via low-level functions in the <span class="code">os</span> module, or (at a higher and usually preferable level of abstraction) with the <span class="code">subprocess</span> module.</p>
<section data-pdf-bookmark="Using the Subprocess Module" data-type="sect2"><div class="sect2" id="using_the_subprocess_module">
<h2>Using the Subprocess Module</h2>
<p>The<a contenteditable="false" data-primary="subprocess module" data-type="indexterm" id="submod15"/><a contenteditable="false" data-primary="standard library modules" data-secondary="subprocess" data-type="indexterm" id="idm44924501681952"/> <span class="code">subprocess</span> module supplies one very<a contenteditable="false" data-primary="Popen class (subprocess module)" data-type="indexterm" id="idm44924501680096"/> broad class: <span class="code">Popen</span>, which supports many diverse ways for your program to run another program. The constructor for <span class="code">Popen</span> has the<a contenteditable="false" data-primary="function signatures" data-secondary="Popen class (subprocess module)" data-type="indexterm" id="idm44924501677632"/> signature:</p>
<table class="border">
<tbody>
<tr>
<td><span class="code">Popen</span></td>
<td><span class="code"><strong>class</strong></span> <span class="code">Popen(<em>args</em>, bufsize=0, executable=<strong>None</strong>, capture_output=<strong>False</strong>, stdin=<strong>None</strong>, stdout=<strong>None</strong>, stderr=<strong>None</strong>, preexec_fn=<strong>None</strong>, close_fds=<strong>False</strong>, shell=<strong>False</strong>, cwd=<strong>None</strong>, env=<strong>None</strong>, text=<strong>None</strong>, universal_newlines=<strong>False</strong>, startupinfo=<strong>None</strong>, creationflags=0)</span><br/>
<span class="code">Popen</span> starts a subprocess to run a distinct program, and creates and returns an object <span class="code"><em>p</em></span>, representing that subprocess. The <span class="code"><em>args</em></span> mandatory argument and the many optional named arguments control all details of how the subprocess is to run.<br/>
			When any exception occurs during the subprocess creation (before the distinct program starts), <span class="code">Popen</span> re-raises that exception in the calling process with the addition of an attribute named <span class="code">child_traceback</span>, which is the Python traceback object for the subprocess. Such an exception would normally be an instance of <span class="code">OSError</span> (or possibly <span class="code">TypeError</span> or <span class="code">ValueError</span> to indicate that you’ve passed to <span class="code">Popen</span> an argument that’s invalid in type or value).</td>
</tr>
</tbody>
</table>
<div data-type="tip">
<h1>subprocess.run() is a Convenience Wrapper Function for Popen</h1>
<p>The subprocess module includes the <span class="code">run</span> function that encapsulates a <span class="code">Popen</span> instance and executes the most common processing flow on it. <span class="code">run</span> accepts the same arguments as <span class="code">Popen</span>’s constructor, runs the given command, waits for completion or timeout, and returns a <span class="code">CompletedProcess</span> instance with attributes for the return code and stdout and <span class="code">stderr</span> contents.</p>
<p>If the output of the command needs to be captured, the most common argument values would be to set the <span class="code">capture_output</span> and <span class="code">text</span> arguments to <span class="code"><strong>True</strong></span>.</p>
</div>
<section data-pdf-bookmark="What to run, and how" data-type="sect3"><div class="sect3" id="what_to_runcomma_and_how">
<h3>What to run, and how</h3>
<p><span class="code"><em>args</em></span> is a sequence of strings: the first item is the path to the program to execute, and the following items, if any, are arguments to pass to the program (<span class="code"><em>args</em></span> can also be just a string, when you don’t need to pass arguments). <span class="code">executable</span>, when not <span class="code"><strong>None</strong></span>, overrides <span class="code"><em>args</em></span> in determining which program to execute. When <span class="code">shell</span> is <span class="code"><strong>True</strong></span>, <span class="code">executable</span> specifies which shell to use to run the subprocess; when <span class="code">shell</span> is <span class="code"><strong>True</strong></span> and <span class="code">executable</span> is <span class="code"><strong>None</strong></span>, the shell used is <em>/bin/sh</em> on Unix-like systems (on Windows, it’s <span class="code">os.environ['COMSPEC']</span>).</p>
</div></section>
<section data-pdf-bookmark="Subprocess files" data-type="sect3"><div class="sect3" id="subprocess_files">
<h3>Subprocess files</h3>
<p><span class="code">stdin</span>, <span class="code">stdout</span>, and <span class="code">stderr</span> specify the subprocess’s standard input, output, and error files, respectively. Each may be <span class="code">PIPE</span>, which creates a new pipe to/from the subprocess; <span class="code"><strong>None</strong></span>, meaning that the subprocess is to use the same file as this (“parent”) process; or a file object (or file descriptor) that’s already suitably open (for reading, for standard input; for writing, for standard output and standard error). <span class="code">stderr</span> may also be <span class="code">subprocess.STDOUT</span>, meaning that the subprocess’s standard error must use the same file as its standard output.<sup><a data-type="noteref" href="ch15.xhtml#ch01fn119" id="ch01fn119-marker">4</a></sup> When <span class="code">capture_output</span> is true, you can not specify <span class="code">stdout</span>, nor <span class="code">stderr</span>: rather, behavior is just as if each was specified as <span class="code">PIPE</span>. <span class="code">bufsize</span> controls the buffering of these files (unless they’re already open), with the same semantics as the same argument to the <span class="code">open</span> function covered in <a data-type="xref" href="ch11.xhtml#creating_a_file_object_with_open">“Creating a File Object with open”</a> (the default, <span class="code">0</span>, means “unbuffered”). When <span class="code">text</span> (or its synonym <span class="code">universal_newlines</span>, provided for backward compatibility) is true, <span class="code">stdout</span> and <span class="code">stderr</span> (unless they are already open) are opened as text files; otherwise, they’re opened as binary files. When <span class="code">close_fds</span> is true, all other files (apart from standard input, output, and error) are closed in the subprocess before the subprocess’s program or shell executes.</p>
</div></section>
<section data-pdf-bookmark="Other, advanced arguments" data-type="sect3"><div class="sect3" id="othercomma_advanced_arguments">
<h3>Other, advanced arguments</h3>
<p>When <span class="code">preexec_fn</span> is not <span class="code"><strong>None</strong></span>, it must be a function or other callable object, and it gets called in the subprocess before the subprocess’s program or shell is executed (only on Unix-like systems, where the call happens after <span class="code">fork</span> and before <span class="code">exec</span>).</p>
<p>When <span class="code">cwd</span> is not <span class="code"><strong>None</strong></span>, it must be a string that gives the full path to an existing directory; the current directory gets changed to <span class="code">cwd</span> in the subprocess before the subprocess’s program or shell executes.</p>
<p>When <span class="code">env</span> is not <span class="code"><strong>None</strong></span>, it must be a mapping with strings as both keys and values, and fully defines the environment for the new process; otherwise, the new process’s environment is a copy of the environment currently active in the parent process.</p>
<p><span class="code">startupinfo</span> and <span class="code">creationflags</span> are Windows-only arguments passed to the <span class="code">CreateProcess</span> Win32 API call used to create the subprocess, for Windows-specific purposes (we do not cover them further in this book, which focuses almost exclusively on cross-platform uses of Python).</p>
</div></section>
<section data-pdf-bookmark="Attributes of subprocess.Popen instances" data-type="sect3"><div class="sect3" id="attributes_of_subprocessdotpopen_instan">
<h3>Attributes of subprocess.Popen instances</h3>
<p>An instance <span class="code"><em>p</em></span> of the class <span class="code">Popen</span> supplies the attributes listed in <a data-type="xref" href="#attributes_of_an_instance_p_of_class_po">Table 15-17</a>.</p>
<table class="border" id="attributes_of_an_instance_p_of_class_po">
<caption><span class="label">Table 15-17. </span>Attributes of an instance <span class="code"><em>p</em></span> of class <span class="code">Popen</span></caption>
<tbody>
<tr>
<td><span class="code">args</span></td>
<td><span class="code">Popen</span>’s <span class="code"><em>args</em></span> argument (string or sequence of strings).</td>
</tr>
<tr>
<td><span class="code">pid</span></td>
<td>The process ID of the subprocess.</td>
</tr>
<tr>
<td><span class="code">returncode</span></td>
<td><span class="code">None</span> to indicate that the subprocess has not yet exited; otherwise, an integer: <span class="code">0</span> for successful termination, <span class="code">&gt;0</span> for termination with an error code, or <span class="code">&lt;0</span> if the subprocess was killed by a signal.</td>
</tr>
<tr>
<td><span class="code">stderr</span>, <span class="code">stdin</span>, <span class="code">stdout</span></td>
<td>When the corresponding argument to <span class="code">Popen</span> was <span class="code">subprocess.PIPE</span>, each of these attributes is a file object wrapping the corresponding pipe; otherwise, each of these attributes is <span class="code"><strong>None</strong></span>. Use the <span class="code">communicate</span> method of <span class="code"><em>p</em></span>, rather than reading and writing to/from these file objects, to avoid possible deadlocks.</td>
</tr>
</tbody>
</table>
</div></section>
<section data-pdf-bookmark="Methods of subprocess.Popen instances" data-type="sect3"><div class="sect3" id="methods_of_subprocessdotpopen_instances">
<h3>Methods of subprocess.Popen instances</h3>
<p>An instance <span class="code"><em>p</em></span> of the class <span class="code">Popen</span> supplies the methods listed in <a data-type="xref" href="#methods_of_an_instance_p_of_class_popen">Table 15-18</a>.</p>
<table class="border" id="methods_of_an_instance_p_of_class_popen">
<caption><span class="label">Table 15-18. </span>Methods of an instance <span class="code"><em>p</em></span> of class <span class="code">Popen</span></caption>
<tbody>
<tr>
<td class="width-15"><span class="code">communicate</span></td>
<td><span class="code"><em>p</em></span><span class="code">.communicate(input=<strong>None</strong>, timeout=<strong>None</strong>)</span><br/>
			Sends the string <span class="code">input</span> as the subprocess’s standard input (when <span class="code">input</span> is not <span class="code"><strong>None</strong></span>), then reads the subprocess’s standard output and error files into in-memory strings <span class="code"><em>so</em></span> and <span class="code"><em>se</em></span> until both files are finished, and finally waits for the subprocess to terminate and returns the pair (two-item tuple) <span class="code">(<em>so</em>,</span> <span class="code"><em>se</em></span><span class="code">).</span></td>
</tr>
<tr>
<td><span class="code">poll</span></td>
<td><span class="code"><em>p</em></span><span class="code">.poll()</span><br/>
			Checks if the subprocess has terminated; returns <span class="code"><em>p</em></span><span class="code">.returncode</span> if it has; otherwise, returns <span class="code"><strong>None</strong></span>.</td>
</tr>
<tr>
<td><span class="code">wait</span></td>
<td><span class="code"><em>p</em></span><span class="code">.wait(timeout=<strong>None</strong>)</span><br/>
			Waits for the subprocess to terminate, then returns <span class="code"><em>p</em></span><span class="code">.returncode</span>. Should the subprocess not terminate within <span class="code">timeout</span> seconds, raises <span class="code">TimeoutExpired</span>.</td>
</tr>
</tbody>
</table>
</div></section>
</div></section>
<section data-pdf-bookmark="Running Other Programs with the os Module" data-type="sect2"><div class="sect2" id="running_other_programs_with_the_os_modu">
<h2>Running Other Programs with the os Module</h2>
<p>The<a contenteditable="false" data-primary="os module" data-secondary="running programs with" data-type="indexterm" id="idm44924501560432"/> best way for your program to run other processes is usually with the <span class="code">subprocess</span> module, covered in the previous section. However, the <span class="code">os</span> module (introduced in <a data-type="xref" href="ch11.xhtml#file_and_text_operations">Chapter 11</a>) also offers several lower-level ways to do this, which, in some cases, may be simpler to use.</p>
<p>The simplest way to run another program is through the function <span class="code">os.system</span>, although this offers no way to <em>control</em> the external program. The <span class="code">os</span> module also provides a number of functions whose names start with <span class="code">exec</span>. These functions offer fine-grained control. A program run by one of the<a contenteditable="false" data-primary="exec (built-in function)" data-type="indexterm" id="idm44924501553168"/> <span class="code">exec</span> functions replaces the current program (i.e., the Python interpreter) in the same process. In practice, therefore, you use the <span class="code">exec</span> functions mostly on platforms that let a process duplicate itself using <span class="code">fork</span> (i.e., Unix-like platforms). <span class="code">os</span> functions whose names start with <span class="code">spawn</span> and <span class="code">popen</span> offer intermediate simplicity and power: they are cross-platform and not quite as simple as <span class="code">system</span>, but simple enough for many purposes.</p>
<p>The <span class="code">exec</span> and<a contenteditable="false" data-primary="spawn function (os module)" data-type="indexterm" id="idm44924501545808"/> <span class="code">spawn</span> functions run a given executable file, given the executable file’s path, arguments to pass to it, and optionally an environment mapping. The <span class="code">system</span> and <span class="code">popen</span> functions execute a command, which is a string passed to a new instance of the platform’s default shell (typically <em>/bin/sh</em> on Unix, <em>cmd.exe</em> on Windows). A <em>command</em> is<a contenteditable="false" data-primary="executing system commands" data-type="indexterm" id="idm44924501541552"/><a contenteditable="false" data-primary="commands (executing system)" data-type="indexterm" id="idm44924501540576"/><a contenteditable="false" data-primary="executable files" data-type="indexterm" id="idm44924501539600"/> a more general concept than an <em>executable file</em>, as it can include shell functionality (pipes, redirection, and built-in shell commands) using the shell syntax specific to the current platform.</p>
<p><span class="code">os</span> provides the functions listed in <a data-type="xref" href="#functions_of_the_os_module_related_to_p">Table 15-19</a>.</p>
<table class="border" id="functions_of_the_os_module_related_to_p">
<caption><span class="label">Table 15-19. </span>Functions of the <span class="code">os</span> module related to processes</caption>
<tbody>
<tr>
<td class="width-15"><span class="code">execl</span>,<br/>
<span class="code">execle</span>,<br/>
<span class="code">execlp</span>,<br/>
<span class="code">execv</span>,<br/>
<span class="code">execve</span>,<br/>
<span class="code">execvp</span>,<br/>
<span class="code">execvpe</span></td>
<td><span class="code">execl(<em>path</em>, *<em>args</em>)</span>,<br/>
<span class="code">execle(<em>path</em>, *<em>args</em>)</span>,<br/>
<span class="code">execlp(<em>path</em>,<em>*args</em>)</span>,<br/>
<span class="code">execv(<em>path</em>,</span> <span class="code"><em>args</em></span><span class="code">)</span>,<br/>
<span class="code">execve(<em>path</em>,</span> <span class="code"><em>args</em></span><span class="code">,</span> <span class="code"><em>env</em></span><span class="code">)</span>,<br/>
<span class="code">execvp(<em>path</em>,</span> <span class="code"><em>args</em></span><span class="code">)</span>,<br/>
<span class="code">execvpe(<em>path</em>,</span> <span class="code"><em>args</em></span><span class="code">,</span> <span class="code"><em>env</em></span><span class="code">)</span><br/>
			Run<a contenteditable="false" data-primary="execvpe (os module)" data-type="indexterm" id="idm44924501505296"/> the executable file (program) indicated by string <span class="code"><em>path</em></span>, replacing the current program (i.e., the Python interpreter) in the current process. The distinctions encoded in the function names (after the prefix <span class="code">exec</span>) control three aspects of how the new program is found and run:
			<ul>
<li>Does <span class="code"><em>path</em></span> have to be a complete path to the program’s executable file, or can the function accept a name as the <span class="code"><em>path</em></span> argument and search for the executable in several directories, as operating system shells do? <span class="code">execlp</span>, <span class="code">execvp</span>, and <span class="code">execvpe</span> can accept a <span class="code"><em>path</em></span> argument that is just a filename rather than a complete path. In this case, the functions search for an executable file of that name in the directories listed in <span class="code">os.environ['PATH']</span>. The other functions require <span class="code"><em>path</em></span> to be a complete path to the executable file.</li>
<li>Does the function accept arguments for the new program as a single sequence argument <span class="code"><em>args</em></span>, or as separate arguments to the function? Functions whose names start with <span class="code">execv</span> take a single argument <span class="code"><em>args</em></span> that is the sequence of arguments to use for the new program. Functions whose names start with <span class="code">execl</span> take the new program’s arguments as separate arguments (<span class="code">execle</span>, in particular, uses its last argument as the environment for the new program).</li>
<li>Does the function accept the new program’s environment as an explicit mapping argument <span class="code"><em>env</em></span>, or implicitly use <span class="code">os.environ</span>? <span class="code">execle</span>, <span class="code">execve</span>, and <span class="code">execvpe</span> take an argument <span class="code"><em>env</em></span> that is a mapping to use as the new program’s environment (keys and values must be strings), while the other functions use <span class="code">os.environ</span> for this purpose.<br/>
				Each <span class="code">exec</span> function uses the first item in <span class="code"><em>args</em></span> as the name under which the new program is told it’s running (for example, <span class="code">argv[0]</span> in a C program’s <span class="code">main</span>); only <span class="code">args[1:]</span> are arguments proper to the new program.</li>
</ul>
</td>
</tr>
<tr>
<td><span class="code">popen</span></td>
<td><span class="code">popen(<em>cmd</em>, mode='r', buffering=-1)</span><br/>
			Runs<a contenteditable="false" data-primary="popen (os module)" data-type="indexterm" id="idm44924501477328"/> the string command <span class="code"><em>cmd</em></span> in a new process <span class="code"><em>P</em></span> and returns a file-like object <span class="code"><em>f</em></span> that wraps a pipe to <span class="code"><em>P</em></span>’s standard input or from <span class="code"><em>P</em></span>’s standard output (depending on <span class="code">mode</span>); <span class="code"><em>f</em></span> uses text streams in both directions rather than raw bytes. <span class="code">mode</span> and <span class="code">buffering</span> have the same meaning as for Python’s <span class="code">open</span> function, covered in <a data-type="xref" href="ch11.xhtml#creating_a_file_object_with_open">“Creating a File Object with open”</a>. When <span class="code">mode</span> is <span class="code">'r'</span> (the default), <span class="code"><em>f</em></span> is read-only and wraps <span class="code"><em>P</em></span>’s standard output. When <span class="code">mode</span> is <span class="code">'w'</span>, <span class="code"><em>f</em></span> is write-only and wraps <span class="code"><em>P</em></span>’s standard input.<br/>
			The key difference of <span class="code"><em>f</em></span> from other file-like objects is the behavior of method <span class="code"><em>f</em></span><span class="code">.close</span>. <span class="code"><em>f</em></span><span class="code">.close</span> waits for <span class="code"><em>P</em></span> to terminate and returns <strong>None</strong>, as <span class="code">close</span> methods of file-like objects normally do, when <span class="code"><em>P</em></span>’s termination is successful. However, if the operating system associates an integer error code <span class="code"><em>c</em></span> with <span class="code"><em>P</em></span>’s termination, indicating that <span class="code"><em>P</em></span>’s termination was unsuccessful, <span class="code"><em>f</em></span><span class="code">.close</span> returns <span class="code"><em>c</em></span>. On Windows systems, <span class="code">c</span> is a signed integer return code from the child process.</td>
</tr>
<tr>
<td><span class="code">spawnv</span>,<br/>
<span class="code">spawnve</span></td>
<td><span class="code">spawnv(<em>mode</em>,</span> <span class="code"><em>path</em></span><span class="code">,</span> <span class="code"><em>args</em></span><span class="code">)</span>,<br/>
<span class="code">spawnve(<em>mode</em>,</span> <span class="code"><em>path</em></span><span class="code">,</span> <span class="code"><em>args</em></span><span class="code">,</span> <span class="code"><em>env</em></span><span class="code">)</span><br/>
			These<a contenteditable="false" data-primary="spawnv function (os module)" data-type="indexterm" id="idm44924501435600"/> functions run the program indicated by <span class="code"><em>path</em></span> in a new process <span class="code"><em>P</em></span>, with the arguments passed as sequence <span class="code"><em>args</em></span>. <span class="code">spawnve</span> uses mapping <span class="code"><em>env</em></span> as <span class="code"><em>P</em></span>’s environment (both keys and values must be strings), while <span class="code">spawnv</span> uses <span class="code">os.environ</span> for this purpose. On Unix-like platforms only, there are other variations of <span class="code">os.spawn</span>, corresponding to variations of <span class="code">os.exec</span>, but <span class="code">spawnv</span> and <span class="code">spawnve</span> are the only two that also exist on Windows.<br/>
<span class="code"><em>mode</em></span> must be one of two attributes supplied by the <span class="code">os</span> module: <span class="code">os.P_WAIT</span> indicates that the calling process waits until the new process terminates, while <span class="code">os.P_NOWAIT</span> indicates that the calling process continues executing simultaneously with the new process. When <span class="code"><em>mode</em></span> is <span class="code">os.P_WAIT</span>, the function returns the termination code <span class="code"><em>c</em></span> of <span class="code"><em>P</em></span>: <span class="code">0</span> indicates successful termination, <span class="code"><em>c</em></span> <span class="code">&lt; 0</span> indicates <span class="code"><em>P</em></span> was killed by a <em>signal</em>, and <span class="code"><em>c</em></span> <span class="code">&gt; 0</span> indicates normal but unsuccessful termination. When <span class="code"><em>mode</em></span> is <span class="code">os.P_NOWAIT</span>, the function returns <span class="code"><em>P</em></span>’s process ID (or, on Windows, <span class="code"><em>P</em></span>’s process handle). There is no cross-platform way to use <span class="code"><em>P</em></span>’s ID or handle; platform-specific ways (not covered further in this book) include <span class="code">os.waitpid</span> on Unix-like platforms, and third-party extension package <a href="https://oreil.ly/dsHxn"><span class="code">pywin32</span></a> on Windows.<br/>
			For example, suppose you want your interactive program to give the user a chance to edit a text file that your program is about to read and use. You must have previously determined the full path to the user’s favorite text editor, such as <em>c:\\windows\\notepad.exe</em> on Windows or <em>/usr/bin/vim</em> on a Unix-like platform. Say that this path string is bound to the variable <span class="code">editor</span>, and the path of the text file you want to let the user edit is bound to <span class="code">textfile</span>:
			<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">os</code><code>
</code><code class="n">os</code><code class="o">.</code><code class="n">spawnv</code><code class="p">(</code><code class="n">os</code><code class="o">.</code><code class="n">P_WAIT</code><code class="p">,</code><code> </code><code class="n">editor</code><code class="p">,</code><code> </code><code class="p">(</code><code class="n">editor</code><code class="p">,</code><code> </code><code class="n">textfile</code><code class="p">)</code><code class="p">)</code></pre>
			The first item of the argument <em>args</em> is passed to the program being spawned as “the name under which the program is being invoked.” Most programs don’t look at this, so you can usually place just about any string here. Just in case the editor program does look at this special first argument (some versions of Vim, for example, do), passing the same string editor that is used as the second argument to <span class="code">os.spawnv</span> is the simplest and most effective approach.</td>
</tr>
<tr>
<td><span class="code">system</span></td>
<td><span class="code">system(<em>cmd</em>)</span><br/>
			Runs<a contenteditable="false" data-primary="system (os module)" data-type="indexterm" id="idm44924501382976"/> the string command <span class="code"><em>cmd</em></span> in a new process and returns <span class="code">0</span> when the new process terminates successfully. When the new process terminates unsuccessfully, <span class="code">system</span> returns an integer error code not equal to <span class="code">0</span>. (Exactly what error codes may be returned depends on the command you’re running: there’s no widely accepted standard for this.)<a contenteditable="false" data-primary="" data-startref="TAPother15" data-type="indexterm" id="idm44924501378720"/><a contenteditable="false" data-primary="" data-startref="submod15" data-type="indexterm" id="idm44924501352976"/></td>
</tr>
</tbody>
</table>
</div></section>
</div></section>
<section data-pdf-bookmark="The mmap Module" data-type="sect1"><div class="sect1" id="the_mmap_module">
<h1>The mmap Module</h1>
<p>The<a contenteditable="false" data-primary="threads and processes" data-secondary="mmap module" data-type="indexterm" id="TAPnmap15"/><a contenteditable="false" data-primary="mmap module" data-type="indexterm" id="nmap15"/><a contenteditable="false" data-primary="standard library modules" data-secondary="mmap" data-type="indexterm" id="idm44924501346448"/> <span class="code">mmap</span> module supplies<a contenteditable="false" data-primary="memory-mapped files" data-type="indexterm" id="idm44924501344256"/> memory-mapped file objects. An <span class="code">mmap</span> object behaves similarly to a bytestring, so you can often pass an <span class="code">mmap</span> object where a bytestring is expected. However, there are differences:</p>
<ul>
<li>
<p>An <span class="code">mmap</span> object does not supply the methods of a string object.</p>
</li>
<li>
<p>An <span class="code">mmap</span> object is mutable, like a <span class="code">bytearray</span>, while <span class="code">bytes</span> objects are <span class="keep-together">immutable</span>.</p>
</li>
<li>
<p>An <span class="code">mmap</span> object also corresponds to an open file, and behaves polymorphically to a Python file object (as covered in <a data-type="xref" href="ch11.xhtml#file_like_objects_and_polymorphism">“File-Like Objects and Polymorphism”</a>).</p>
</li>
</ul>
<p>An <span class="code">mmap</span> object <span class="code"><em>m</em></span> can be indexed or sliced, yielding bytestrings. Since <span class="code"><em>m</em></span> is mutable, you can also assign to an indexing or slicing of <span class="code"><em>m</em></span>. However, when you assign to a slice of <span class="code"><em>m</em></span>, the righthand side of the assignment statement must be a bytestring of exactly the same length as the slice you’re assigning to. Therefore, many of the useful tricks available with list slice assignment (covered in <a data-type="xref" href="ch03.xhtml#modifying_a_list">“Modifying a list”</a>) do not apply to <span class="code">mmap</span> slice assignment.</p>
<p>The <span class="code">mmap</span> module supplies a factory function, slightly different on Unix-like systems and on Windows:</p>
<table class="border">
<tbody>
<tr>
<td><span class="code">mmap</span></td>
<td><em>Windows:</em> <span class="code">mmap(<em>filedesc</em>,</span> <span class="code"><em>length</em></span><span class="code">, tagname='', access=<strong>None</strong>, offset=<strong>None</strong>)</span><br/>
<em>Unix:</em> <span class="code">mmap(<em>filedesc</em>,</span> <span class="code"><em>length</em></span><span class="code">, flags=MAP_SHARED, prot=PROT_READ|PROT_WRITE, access=<strong>None</strong>, offset=0)</span><br/>
			Creates and returns an <span class="code">mmap</span> object <span class="code"><em>m</em></span> that maps into memory the first <span class="code"><em>length</em></span> bytes of the file indicated by file descriptor <span class="code"><em>filedesc</em></span>. <span class="code"><em>filedesc</em></span> must be a file descriptor opened for both reading and writing, except, on Unix-like platforms, when the argument <span class="code">prot</span> requests only reading or only writing. (File descriptors are covered in <a data-type="xref" href="ch11.xhtml#file_descriptor_operations">“File descriptor operations”</a>.) To get an <span class="code">mmap</span> object <span class="code"><em>m</em></span> for a Python file object <span class="code"><em>f</em></span>, use <span class="code"><em>m</em></span><span class="code">=mmap.mmap(<em>f</em>.fileno()</span>, <span class="code"><em>length</em></span><span class="code">)</span>. <span class="code"><em>filedesc</em></span> can be <span class="code">-1</span> to map anonymous memory.<br/>
			On Windows, all memory mappings are readable and writable, and shared among processes, so all processes with a memory mapping on a file can see changes made by other processes. On Windows only, you can pass a string <span class="code">tagname</span> to give an explicit <em>tag name</em> for the memory mapping. This tag name lets you have several separate memory mappings on the same file, but this is rarely necessary. Calling <span class="code">mmap</span> with only two arguments has the advantage of keeping your code portable between Windows and Unix-like platforms.</td>
</tr>
<tr>
<td><span class="code">mmap</span><br/>
<em>(cont.)</em></td>
<td>On Unix-like platforms only, you can pass <span class="code">mmap.MAP_PRIVATE</span> as <span class="code">flags</span> to get a mapping that is private to your process and copy-on-write. <span class="code">mmap.MAP_SHARED</span>, the default, gets a mapping that is shared with other processes so that all processes mapping the file can see changes made by one process (the same as on Windows). You can pass <span class="code">mmap.PROT_READ</span> as the <span class="code">prot</span> argument to get a mapping that you can only read, not write. Passing <span class="code">mmap.PROT_WRITE</span> gets a mapping that you can only write, not read. The default, the bitwise OR <span class="code">mmap.PROT_READ|mmap.PROT_WRITE</span>, gets a mapping you can both read and write.<br/>
			You can pass the named argument <span class="code">access</span> instead of <span class="code">flags</span> and <span class="code">prot</span> (it’s an error to pass both <span class="code">access</span> and either or both of the other two arguments). The value for <span class="code">access</span> can be one of <span class="code">ACCESS_READ</span> (read-only), <span class="code">ACCESS_WRITE</span> (write-through, the default on Windows), or <span class="code">ACCESS_COPY</span> (copy-on-write).<br/>
			You can pass the named argument <span class="code">offset</span> to start the mapping after the beginning of the file; <span class="code">offset</span> must be an <span class="code">int</span> <span class="code">&gt;= 0</span>, a multiple of <span class="code">ALLOCATIONGRANULARITY</span> (or, on Unix, of <span class="code">PAGESIZE</span>).</td>
</tr>
</tbody>
</table>
<section data-pdf-bookmark="Methods of mmap Objects" data-type="sect2"><div class="sect2" id="methods_of_mmap_objects">
<h2>Methods of mmap Objects</h2>
<p>An <span class="code">mmap</span> object <span class="code"><em>m</em></span> supplies the methods detailed in <a data-type="xref" href="#methods_of_an_instance_m_of_mmap">Table 15-20</a>.</p>
<table class="border" id="methods_of_an_instance_m_of_mmap">
<caption><span class="label">Table 15-20. </span>Methods of an instance <span class="code">m</span> of <span class="code">mmap</span></caption>
<tbody>
<tr>
<td><span class="code">close</span></td>
<td><span class="code"><em>m</em></span><span class="code">.close()</span><br/>
			Closes <span class="code"><em>m</em></span>’s file.</td>
</tr>
<tr>
<td><span class="code">find</span></td>
<td><span class="code"><em>m</em></span><span class="code">.find(<em>sub</em>, start=0, end=<strong>None</strong>)</span><br/>
			Returns<a contenteditable="false" data-primary="find method" data-secondary="mmap module" data-type="indexterm" id="idm44924501266144"/> the lowest <span class="code"><em>i</em></span> <span class="code">&gt;= start</span> such that <span class="code"><em>sub</em></span> <span class="code">==</span> <span class="code"><em>m</em></span><span class="code">[<em>i</em>:<em>i</em>+len(<em>sub</em>)]</span> (and <span class="code"><em>i</em></span><span class="code">+len(<em>sub</em>)-1 &lt;= end</span>, when you pass <span class="code">end</span>). If no such <span class="code"><em>i</em></span> exists, <span class="code"><em>m</em></span><span class="code">.find</span> returns <span class="code">-1</span>. This is the same behavior as the <span class="code">find</span> method of <span class="code">str</span>, covered in <a data-type="xref" href="ch09.xhtml#significant_str_and_bytes_methods">Table 9-1</a>.</td>
</tr>
<tr>
<td><span class="code">flush</span></td>
<td><span class="code"><em>m</em></span><span class="code">.flush([<em>offset</em>,</span> <span class="code"><em>n</em></span><span class="code">])</span><br/>
			Ensures that all changes made to <span class="code"><em>m</em></span> exist in <span class="code"><em>m</em></span>’s file. Until you call <span class="code"><em>m</em></span><span class="code">.flush</span>, it’s unsure if the file reflects the current state of <span class="code"><em>m</em></span>. You can pass a starting byte offset <span class="code"><em>offset</em></span> and a byte count <span class="code"><em>n</em></span> to limit the flushing effect’s guarantee to a slice of <span class="code"><em>m</em></span>. Pass both arguments, or neither: it’s an error to call <span class="code"><em>m</em></span><span class="code">.flush</span> with just one argument.</td>
</tr>
<tr>
<td><span class="code">move</span></td>
<td><span class="code"><em>m</em></span><span class="code">.move(<em>dstoff</em>,</span> <span class="code"><em>srcoff</em></span><span class="code">,</span> <span class="code"><em>n</em></span><span class="code">)</span><br/>
			Like the slice assignment <span class="code"><em>m</em></span><span class="code">[<em>dstoff</em>:<em>dstoff</em>+<em>n</em>] =</span> <span class="code"><em>m</em></span><span class="code">[<em>srcoff</em>:<em>srcoff</em>+<em>n</em>]</span>, but potentially faster. The source and destination slices can overlap. Apart from such potential overlap, <span class="code">move</span> does not affect the source slice (i.e., the <span class="code">move</span> method <em>copies</em> bytes but does not <em>move</em> them, despite the method’s name).</td>
</tr>
<tr>
<td><span class="code">read</span></td>
<td><span class="code"><em>m</em></span><span class="code">.read(<em>n</em>)</span><br/>
			Reads and returns a byte string <span class="code"><em>s</em></span> containing up to <span class="code"><em>n</em></span> bytes starting from <span class="code"><em>m</em></span>’s file pointer, then advances <span class="code"><em>m</em></span>’s file pointer by <span class="code">len(<em>s</em>)</span>. If there are fewer than <span class="code"><em>n</em></span> bytes between <span class="code"><em>m</em></span>’s file pointer and <span class="code"><em>m</em></span>’s length, returns the bytes available. In particular, if <span class="code"><em>m</em></span>’s file pointer is at the end of <span class="code"><em>m</em></span>, returns the empty bytestring <span class="code">b''</span>.</td>
</tr>
<tr>
<td><span class="code">read_byte</span></td>
<td><span class="code"><em>m</em></span><span class="code">.read_byte()</span><br/>
			Returns a byte string of length <span class="code">1</span> containing the byte at <span class="code"><em>m</em></span>’s file pointer, then advances <span class="code"><em>m</em></span>’s file pointer by <span class="code">1</span>. <span class="code"><em>m</em></span><span class="code">.read_byte()</span> is similar to <span class="code"><em>m</em></span><span class="code">.read(1)</span>. However, if <span class="code"><em>m</em></span>’s file pointer is at the end of <span class="code"><em>m</em></span>, <span class="code"><em>m</em></span><span class="code">.read(1)</span> returns the empty string <span class="code">b''</span> and doesn’t advance, while <span class="code"><em>m</em></span><span class="code">.read_byte()</span> raises a <span class="code">ValueError</span> exception.</td>
</tr>
<tr>
<td><span class="code">readline</span></td>
<td><span class="code"><em>m</em></span><span class="code">.readline()</span><br/>
			Reads and returns, as a bytestring, one line from <span class="code"><em>m</em></span>’s file, from <span class="code"><em>m</em></span>’s current file pointer up to the next <span class="code">'\n'</span>, included (or up to the end of <span class="code"><em>m</em></span> if there is no <span class="code">'\n'</span>), then advances <span class="code"><em>m</em></span>’s file pointer to point just past the bytes just read. If <span class="code"><em>m</em></span>’s file pointer is at the end of <span class="code"><em>m</em></span>, <span class="code">readline</span> returns the empty string <span class="code">b''</span>.</td>
</tr>
<tr>
<td><span class="code">resize</span></td>
<td><span class="code"><em>m</em></span><span class="code">.resize(<em>n</em>)</span><br/>
			Changes the length of <span class="code"><em>m</em></span> so that <span class="code">len(<em>m</em>)</span> becomes <span class="code"><em>n</em></span>. Does not affect the size of <span class="code"><em>m</em></span>’s file. <span class="code"><em>m</em></span>’s length and the file’s size are independent. To set <span class="code"><em>m</em></span>’s length to be equal to the file’s size, call <span class="code"><em>m</em></span><span class="code">.resize(<em>m</em>.size())</span>. If <span class="code"><em>m</em></span>’s length is larger than the file’s size, <span class="code"><em>m</em></span> is padded with null bytes (<span class="code">\x00</span>).</td>
</tr>
<tr>
<td><span class="code">rfind</span></td>
<td><span class="code">rfind(sub, start=0, end=<strong>None</strong>)</span><br/>
			Returns the highest <span class="code"><em>i</em></span> <span class="code">&gt;= start</span> such that <span class="code"><em>sub</em></span> <span class="code">==</span> <span class="code"><em>m</em></span><span class="code">[<em>i</em>:<em>i</em>+len(<em>sub</em>)]</span> (and <span class="code"><em>i</em></span><span class="code">+len(<em>sub</em>)-1 &lt;= end</span>, when you pass <span class="code">end</span>). If no such <span class="code"><em>i</em></span> exists, <span class="code"><em>m</em></span><span class="code">.rfind</span> returns <span class="code">-1</span>. This is the same as the <span class="code">rfind</span> method of string objects, covered in <a data-type="xref" href="ch09.xhtml#significant_str_and_bytes_methods">Table 9-1</a>.</td>
</tr>
<tr>
<td><span class="code">seek</span></td>
<td><span class="code"><em>m</em></span><span class="code">.seek(</span><span class="code"><em>pos,</em></span> <span class="code">how=0)</span><br/>
			Sets <span class="code"><em>m</em></span>’s file pointer to the integer byte offset <span class="code"><em>pos</em></span>, relative to the position indicated by <span class="code">how</span>:
			<dl>
<dt class="plain"><span class="code">0</span> <em>or</em> <span class="code">os.SEEK_SET</span></dt>
<dd>Offset is relative to start of <span class="code"><em>m</em></span></dd>
<dt class="plain"><span class="code">1</span> <em>or</em> <span class="code">os.SEEK_CUR</span></dt>
<dd>Offset is relative to <span class="code"><em>m</em></span>’s current file pointer</dd>
<dt class="plain"><span class="code">2</span> <em>or</em> <span class="code">os.SEEK_END</span></dt>
<dd>Offset is relative to end of <span class="code"><em>m</em></span></dd>
</dl>
			A <span class="code">seek</span> trying to set <span class="code"><em>m</em></span>’s file pointer to a negative offset, or to an offset beyond <span class="code"><em>m</em></span>’s length, raises a <span class="code">ValueError</span> exception.</td>
</tr>
<tr>
<td><span class="code">size</span></td>
<td><span class="code"><em>m</em></span><span class="code">.size()</span><br/>
			Returns the length (number of bytes) of <span class="code"><em>m</em></span>’s file (not the length of <span class="code"><em>m</em></span> itself). To get the length of <span class="code"><em>m</em></span>, use <span class="code">len(<em>m</em>)</span>.</td>
</tr>
<tr>
<td><span class="code">tell</span></td>
<td><span class="code"><em>m</em></span><span class="code">.tell()</span><br/>
			Returns the current position of <span class="code"><em>m</em></span>’s file pointer, a byte offset within <span class="code"><em>m</em></span>’s file.</td>
</tr>
<tr>
<td><span class="code">write</span></td>
<td><span class="code"><em>m</em></span><span class="code">.write(<em>b</em>)</span><br/>
			Writes the bytes in bytestring <span class="code"><em>b</em></span> into <span class="code"><em>m</em></span> at the current position of <span class="code"><em>m</em></span>’s file pointer, overwriting the bytes that were there, and then advances <span class="code"><em>m</em></span>’s file pointer by <span class="code">len(<em>b</em>)</span>. If there aren’t at least <span class="code">len(<em>b</em>)</span> bytes between <span class="code"><em>m</em></span>’s file pointer and the length of <span class="code"><em>m</em></span>, <span class="code">write</span> raises a <span class="code">ValueError</span> exception.</td>
</tr>
<tr>
<td><span class="code">write_byte</span></td>
<td><span class="code"><em>m</em></span><span class="code">.write_byte(<em>byte</em>)</span><br/>
			Writes <span class="code"><em>byte</em></span>, which must be an <span class="code">int</span>, into mapping <span class="code"><em>m</em></span> at the current position of <span class="code"><em>m</em></span>’s file pointer, overwriting the byte that was there, and then advances <span class="code"><em>m</em></span>’s file pointer by <span class="code">1</span>. <span class="code"><em>m</em></span><span class="code">.write_byte(<em>x</em>)</span> is similar to <span class="code"><em>m</em></span><span class="code">.write(<em>x</em>.to_bytes(1, 'little'))</span>. However, if <span class="code"><em>m</em></span>’s file pointer is at the end of <span class="code"><em>m</em></span>, <span class="code"><em>m</em></span><span class="code">.write_byte(<em>x</em>)</span> silently does nothing, while <span class="code"><em>m</em></span><span class="code">.write(<em>x</em>.to_bytes(1, 'little'))</span> raises a <span class="code">ValueError</span> exception. Note that this is the reverse of the relationship between <span class="code">read</span> and <span class="code">read_byte</span> at end-of-file: <span class="code">write</span> and <span class="code">read_byte</span> may raise <span class="code">ValueError</span>, while <span class="code">read</span> and <span class="code">write_byte</span> never do.</td>
</tr>
</tbody>
</table>
</div></section>
<section data-pdf-bookmark="Using mmap Objects for IPC" data-type="sect2"><div class="sect2" id="using_mmap_objects_for_ipc">
<h2>Using mmap Objects for IPC</h2>
<p>Processes<a contenteditable="false" data-primary="interprocess communication (IPC)" data-type="indexterm" id="idm44924501083360"/><a contenteditable="false" data-primary="IPC (interprocess communication)" data-type="indexterm" id="idm44924501082192"/> communicate using <span class="code">mmap</span> pretty much the same way they communicate using files: one process writes data, and another process later reads the same data back. Since an <span class="code">mmap</span> object has an underlying file, you can have some processes doing I/O on the file (as covered in <a data-type="xref" href="ch11.xhtml#the_io_module">“The io Module”</a>), while others use <span class="code">mmap</span> on the same file. Choose between <span class="code">mmap</span> and I/O on file objects on the basis of convenience: functionality is the same, performance is roughly equivalent. For example, here is a simple program that repeatedly uses file I/O to make the contents of a file equal to the last line interactively typed by the user:</p>
<pre data-code-language="python" data-type="programlisting">
<code class="n">fileob</code><code> </code><code class="o">=</code><code> </code><code class="nb">open</code><code class="p">(</code><code class="s1">'</code><code class="s1">xxx</code><code class="s1">'</code><code class="p">,</code><code class="s1">'</code><code class="s1">wb</code><code class="s1">'</code><code class="p">)</code><code>
</code><strong><code class="k">while</code><code> </code><code class="kc">True</code></strong><code class="p">:</code><code>
</code><code>    </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="nb">input</code><code class="p">(</code><code class="s1">'</code><code class="s1">Enter some text:</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>    </code><code class="n">fileob</code><code class="o">.</code><code class="n">seek</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code><code>
</code><code>    </code><code class="n">fileob</code><code class="o">.</code><code class="n">write</code><code class="p">(</code><code class="n">data</code><code class="o">.</code><code class="n">encode</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>
</code><code>    </code><code class="n">fileob</code><code class="o">.</code><code class="n">truncate</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="n">fileob</code><code class="o">.</code><code class="n">flush</code><code class="p">(</code><code class="p">)</code></pre>
<p>And here is another simple program that, when run in the same directory as the former, uses <span class="code">mmap</span> (and the <span class="code">time.sleep</span> function, covered in <a data-type="xref" href="ch13.xhtml#functions_and_attributes_of_the_time_mo">Table 13-2</a>) to check every second for changes to the file and print out the file’s new contents, if there have been any<a contenteditable="false" data-primary="" data-startref="TAPnmap15" data-type="indexterm" id="idm44924501024864"/><a contenteditable="false" data-primary="" data-startref="nmap15" data-type="indexterm" id="idm44924501023520"/> changes:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">mmap</code><code class="o">,</code><code> </code><code class="nn">os</code><code class="o">,</code><code> </code><code class="nn">time</code><code>
</code><code class="n">mx</code><code> </code><code class="o">=</code><code> </code><code class="n">mmap</code><code class="o">.</code><code class="n">mmap</code><code class="p">(</code><code class="n">os</code><code class="o">.</code><code class="n">open</code><code class="p">(</code><code class="s1">'</code><code class="s1">xxx</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">os</code><code class="o">.</code><code class="n">O_RDWR</code><code class="p">)</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">)</code><code>
</code><code class="n">last</code><code> </code><code class="o">=</code><code> </code><strong><code class="kc">None</code></strong><code>
</code><strong><code class="k">while</code><code> </code><code class="kc">True</code></strong><code class="p">:</code><code>
</code><code>    </code><code class="n">mx</code><code class="o">.</code><code class="n">resize</code><code class="p">(</code><code class="n">mx</code><code class="o">.</code><code class="n">size</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>
</code><code>    </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">mx</code><code class="p">[</code><code class="p">:</code><code class="p">]</code><code>
</code><code>    </code><strong><code class="k">if</code></strong><code> </code><code class="n">data</code><code> </code><code class="o">!=</code><code> </code><code class="n">last</code><code class="p">:</code><code>
</code><code>        </code><code class="nb">print</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code>
</code><code>        </code><code class="n">last</code><code> </code><code class="o">=</code><code> </code><code class="n">data</code><code>
</code><code>    </code><code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code></pre>
</div></section>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="ch01fn116"><sup><a href="ch15.xhtml#ch01fn116-marker">1</a></sup> The best introductory work on async programming we have come across, though sadly now dated (as the async approach in Python keeps improving), is <a class="orm:hideurl" href="https://www.oreilly.com/library/view/using-asyncio-in/9781492075325/"><em>Using Asyncio in Python</em></a>, by Caleb Hattingh (O’Reilly). We recommend you also study <a href="https://oreil.ly/HkGpJ">Brad Solomon’s Asyncio walkthrough</a> on Real Python.</p><p data-type="footnote" id="ch01fn117"><sup><a href="ch15.xhtml#ch01fn117-marker">2</a></sup> The online docs include an especially helpful <a href="https://oreil.ly/6EqPh">“Programming Guidelines” section</a> that lists a number of additional practical recommendations when using the <span class="code">multiprocessing</span> module.</p><p data-type="footnote" id="ch01fn118"><sup><a href="ch15.xhtml#ch01fn118-marker">3</a></sup> A race condition is a situation in which the relative timings of different events, which are usually unpredictable, can affect the outcome of a computation…never a good thing!</p><p data-type="footnote" id="ch01fn119"><sup><a href="ch15.xhtml#ch01fn119-marker">4</a></sup> Just like <span class="code"><strong>2&gt;&amp;1</strong></span> would specify in a Unix-y shell command line.</p></div></div></section></div></body></html>