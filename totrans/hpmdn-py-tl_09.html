<html><head></head><body>
<div id="book-content">
<div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 6. Testing with pytest"><div class="chapter" id="chapter_testing">
<h1><span class="label">Chapter 6. </span>Testing with pytest</h1>

<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id289">
<h1>A Note for Early Release Readers</h1>
<p>With Early Release ebooks, you get books in their earliest form—the author’s raw and unedited content as they write—so you can take advantage of these technologies long before the official release of these titles.</p>

<p>This will be the sixth chapter of the final book. Please note that the GitHub repo will be made active later on.</p>

<p>If you have comments about how we might improve the content and/or examples in this book, or if you notice missing material within this chapter, please reach out to the author at <a href="mailto:mail@claudiojolowicz.com">mail@claudiojolowicz.com</a>.</p>
</div></aside>

<p>If you think back to when you wrote your first programs, you may recall a common
experience: You had an idea for how a program could help with a real-life task,
and spent a sizable amount of time coding it from top to bottom, only to be
confronted with screens full of disheartening error messages when you finally
ran it. Or, worse, it gave you results that were subtly wrong.</p>

<p>There are a few lessons we’ve all learned from experiences like this. One is to
start simple and keep it simple as you iterate on the program. Another lesson is
to test early and repeatedly. Initially, this may just mean to run the program
manually and validate that it does what it should. Later on, if you break the
program into smaller parts, you can test those parts in isolation and
automatically. As a side effect, the program gets easier to read and work
on, too.</p>

<p>In this chapter, I’ll talk about how testing can help you produce value early
and consistently. Good tests amount to an executable specification of the code
you own. They set you free from institutional knowledge in a team or company,
and they speed up your development by giving you immediate feedback on changes.</p>

<p>The third-party testing framework <a href="https://docs.pytest.org/">pytest</a> has become
somewhat of a de-facto standard in the Python world. Tests written with pytest
are simple and readable: you write most tests as if there was no framework,
using basic language primitives like functions and assertions. Despite its
simplicity, the framework is powerful and expressive, notably through its
concepts of test fixtures and parameterized tests. Pytest is extensible and
comes with a rich ecosystem of plugins.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Pytest originated in the PyPy project, a Python interpreter written in Python.
Early on, the PyPy developers worked on a separate standard library called
<code>std</code>, later renamed to <code>py</code>. Its testing module <code>py.test</code> became an independent
project under the name <code>pytest</code>.</p>
</div>






<section data-type="sect1" data-pdf-bookmark="Writing a Test"><div class="sect1" id="section_testing_writing">
<h1>Writing a Test</h1>

<p><a data-type="xref" href="#example_testing_wikipedia">Example 6-1</a> revisits the Wikipedia example from
<a data-type="xref" href="ch03.html#chapter_packages">Chapter 3</a>. The program is as simple as it gets—​yet it’s far from
obvious how you’d write tests for it. The <code>main</code> function has no inputs and no
outputs—​only side effects, such as writing to the standard output stream. How
would you test a function like this?</p>
<div id="example_testing_wikipedia" data-type="example">
<h5><span class="label">Example 6-1. </span>The <code>main</code> function from <code>random-wikipedia-article</code></h5>

<pre data-type="programlisting" data-code-language="python"><code class="k">def</code> <code class="nf">main</code><code class="p">():</code>
    <code class="k">with</code> <code class="n">urllib</code><code class="o">.</code><code class="n">request</code><code class="o">.</code><code class="n">urlopen</code><code class="p">(</code><code class="n">API_URL</code><code class="p">)</code> <code class="k">as</code> <code class="n">response</code><code class="p">:</code>
        <code class="n">data</code> <code class="o">=</code> <code class="n">json</code><code class="o">.</code><code class="n">load</code><code class="p">(</code><code class="n">response</code><code class="p">)</code>

    <code class="nb">print</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s2">"title"</code><code class="p">],</code> <code class="n">end</code><code class="o">=</code><code class="s2">"</code><code class="se">\n\n</code><code class="s2">"</code><code class="p">)</code>
    <code class="nb">print</code><code class="p">(</code><code class="n">textwrap</code><code class="o">.</code><code class="n">fill</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s2">"extract"</code><code class="p">]))</code></pre></div>

<p>Let’s write an <em>end-to-end test</em> that runs the program in a subprocess and
checks that it completes with non-empty output. End-to-end tests run the entire
program the way an end user would (<a data-type="xref" href="#example_testing_end_to_end">Example 6-2</a>).</p>
<div id="example_testing_end_to_end" data-type="example">
<h5><span class="label">Example 6-2. </span>A test for <code>random-wikipedia-article</code></h5>

<pre data-type="programlisting" data-code-language="python"><code class="kn">import</code> <code class="nn">subprocess</code>
<code class="kn">import</code> <code class="nn">sys</code>

<code class="k">def</code> <code class="nf">test_output</code><code class="p">():</code>
    <code class="n">args</code> <code class="o">=</code> <code class="p">[</code><code class="n">sys</code><code class="o">.</code><code class="n">executable</code><code class="p">,</code> <code class="s2">"-m"</code><code class="p">,</code> <code class="s2">"random_wikipedia_article"</code><code class="p">]</code>
    <code class="n">process</code> <code class="o">=</code> <code class="n">subprocess</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="n">args</code><code class="p">,</code> <code class="n">capture_output</code><code class="o">=</code><code class="kc">True</code><code class="p">,</code> <code class="n">check</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code>
    <code class="k">assert</code> <code class="n">process</code><code class="o">.</code><code class="n">stdout</code></pre></div>
<div data-type="tip"><h6>Tip</h6>
<p>Tests written using pytest are functions whose names start with <code>test</code>. Use the
built-in <code>assert</code> statement to check for expected behavior. Pytest rewrites the
language construct to provide rich error reporting in case of a test failure.</p>
</div>

<p>Place the contents of <a data-type="xref" href="#example_testing_end_to_end">Example 6-2</a> in the file
<em>test_main.py</em> in a <em>tests</em> directory. Include an empty
<em>__init__.py</em> file to turn the test suite into an import package. This
lets you mirror the layout of the package you’re testing,<sup><a data-type="noteref" id="id290-marker" href="ch06.html#id290">1</a></sup>
and it gives you the option to import modules with test utilities.</p>

<p>At this point, your project should be structured in the following way:</p>

<pre data-type="programlisting">random-wikipedia-article
├── pyproject.toml
├── src
│   └── random_wikipedia_article
│       ├── __init__.py
│       └── __main__.py
└── tests
    ├── __init__.py
    └── test_main.py</pre>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Managing Test Dependencies"><div class="sect1" id="section_testing_dependencies">
<h1>Managing Test Dependencies</h1>

<p>Tests must be able to import your project and its dependencies, so you need to
install pytest in your project environment. For example, add a <code>tests</code> extra to
your project:</p>

<pre data-type="programlisting" data-code-language="toml"><code class="k">[project.optional-dependencies]</code><code class="w"/>
<code class="n">tests</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">[</code><code class="s2">"pytest&gt;=8.1.1"</code><code class="p">]</code><code class="w"/></pre>

<p>You can now install pytest in the project environment:</p>
<pre data-type="programlisting">$ <strong>uv pip install -e ".[tests]"</strong></pre>

<p>Alternatively, compile a requirements file and synchronize your environment:</p>
<pre data-type="programlisting">$ <strong>uv pip compile --extra=tests pyproject.toml -o dev-requirements.txt</strong>
$ <strong>uv pip sync dev-requirements.txt</strong>
$ <strong>uv pip install -e . --no-deps</strong>
</pre>

<p>If you use Poetry, add pytest to your project using <code>poetry add</code> instead:</p>
<pre data-type="programlisting">$ <strong>poetry add --group=tests "pytest&gt;=8.1.1"</strong></pre>

<p>Please refer to these steps when I ask you to add test dependencies later in
this chapter.</p>

<p>Finally, let’s run the test suite. If you’re on Windows, activate the
environment before you run the following command.</p>
<pre data-type="programlisting">$ <strong>py -m pytest</strong>
========================= test session starts ==========================
platform darwin -- Python 3.12.2, pytest-8.1.1, pluggy-1.4.0
rootdir: ...
collected 1 item

tests/test_main.py .                                              [100%]
========================== 1 passed in 0.01s ===========================
</pre>
<div data-type="tip"><h6>Tip</h6>
<p>Use <code>py -m pytest</code> even in Poetry projects. It’s both shorter and safer than
<code>poetry run pytest</code>. If you forget to install pytest into the environment,
Poetry falls back to your global environment. (The safe variant would be <code>poetry
run python -m pytest</code>.)</p>
</div>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Designing for Testability"><div class="sect1" id="section_testing_designing">
<h1>Designing for Testability</h1>

<p>Writing finer-grained tests for the program is much harder. The API endpoint
returns a random article, so <em>which</em> title and summary should the tests expect?
Every invocation sends an HTTP request to the real Wikipedia API. Those network
roundtrips will make the test suite excruciatingly slow—​and you can only run
tests when your machine is connected to the internet.</p>

<p>Python programmers have an arsenal of tools at their disposal for situations
like this. Most of these involve some form of <em>monkey patching</em>, which replaces
functions or objects at runtime to make the code easier to test. For example,
you can capture program output by replacing <code>sys.stdout</code> with a file-like object
that writes to an internal buffer for later inspection. You can replace
<code>urlopen</code> with a function that returns canned HTTP responses of your liking.
Libraries like <code>responses</code>, <code>respx</code>, or <code>vcr.py</code> provide high-level interfaces
that monkey patch the HTTP machinery behind the scenes. More generic approaches
use the standard <code>unittest.mock</code> module or pytest’s <code>monkeypatch</code> fixture.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The term <em>monkey patch</em> for replacing code at runtime originated at Zope
Corporation. Initially, people at Zope called the technique “guerilla patching”,
since it didn’t abide by the usual rules of patch submission. People heard that
as “gorilla patch”—and soon the more carefully crafted ones came to be known as
“monkey patches”.</p>
</div>

<p>While these tools serve their purpose, I’d encourage you to focus on the root of
the problem: <a data-type="xref" href="#example_testing_wikipedia">Example 6-1</a> has no separation of concerns. A
single function serves as the application entry point, communicates with an
external API, and presents the results on the console. This makes it hard to
test its features in isolation.</p>

<p>The program also lacks abstraction, in two ways. First, it doesn’t encapsulate
implementation details when interfacing with other systems, like interacting
with the Wikipedia API or writing to the terminal. Second, its central
concept—​the Wikipedia article—​only appears as an amorphous JSON object: the
program doesn’t abstract its domain model in any way, such as by defining an
<code>Article</code> class.</p>

<p><a data-type="xref" href="#example_testing_refactored">Example 6-3</a> shows a refactoring that makes the code more
testable. While this version of the program is longer, it expresses its logic
more clearly and is more amenable to change. Good tests don’t just catch bugs:
they improve the design of your code.</p>
<div id="example_testing_refactored" data-type="example">
<h5><span class="label">Example 6-3. </span>Refactoring for testability</h5>

<pre data-type="programlisting" data-code-language="python"><code class="kn">import</code><code> </code><code class="nn">sys</code><code> </code><a class="co" id="co_testing_with_pytest_CO1-1" href="#callout_testing_with_pytest_CO1-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="kn">from</code><code> </code><code class="nn">dataclasses</code><code> </code><code class="kn">import</code><code> </code><code class="n">dataclass</code><code>
</code><code>
</code><code class="nd">@dataclass</code><code>
</code><code class="k">class</code><code> </code><code class="nc">Article</code><code class="p">:</code><code>
</code><code>    </code><code class="n">title</code><code class="p">:</code><code> </code><code class="nb">str</code><code> </code><code class="o">=</code><code> </code><code class="s2">"</code><code class="s2">"</code><code>
</code><code>    </code><code class="n">summary</code><code class="p">:</code><code> </code><code class="nb">str</code><code> </code><code class="o">=</code><code> </code><code class="s2">"</code><code class="s2">"</code><code>
</code><code>
</code><code class="k">def</code><code> </code><code class="nf">fetch</code><code class="p">(</code><code class="n">url</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="k">with</code><code> </code><code class="n">urllib</code><code class="o">.</code><code class="n">request</code><code class="o">.</code><code class="n">urlopen</code><code class="p">(</code><code class="n">url</code><code class="p">)</code><code> </code><code class="k">as</code><code> </code><code class="n">response</code><code class="p">:</code><code>
</code><code>        </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="n">json</code><code class="o">.</code><code class="n">load</code><code class="p">(</code><code class="n">response</code><code class="p">)</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">Article</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s2">"</code><code class="s2">title</code><code class="s2">"</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">data</code><code class="p">[</code><code class="s2">"</code><code class="s2">extract</code><code class="s2">"</code><code class="p">]</code><code class="p">)</code><code>
</code><code>
</code><code class="k">def</code><code> </code><code class="nf">show</code><code class="p">(</code><code class="n">article</code><code class="p">,</code><code> </code><code class="n">file</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">summary</code><code> </code><code class="o">=</code><code> </code><code class="n">textwrap</code><code class="o">.</code><code class="n">fill</code><code class="p">(</code><code class="n">article</code><code class="o">.</code><code class="n">summary</code><code class="p">)</code><code>
</code><code>    </code><code class="n">file</code><code class="o">.</code><code class="n">write</code><code class="p">(</code><code class="sa">f</code><code class="s2">"</code><code class="si">{</code><code class="n">article</code><code class="o">.</code><code class="n">title</code><code class="si">}</code><code class="se">\n</code><code class="se">\n</code><code class="si">{</code><code class="n">summary</code><code class="si">}</code><code class="se">\n</code><code class="s2">"</code><code class="p">)</code><code>
</code><code>
</code><code class="k">def</code><code> </code><code class="nf">main</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">article</code><code> </code><code class="o">=</code><code> </code><code class="n">fetch</code><code class="p">(</code><code class="n">API_URL</code><code class="p">)</code><code>
</code><code>    </code><code class="n">show</code><code class="p">(</code><code class="n">article</code><code class="p">,</code><code> </code><code class="n">sys</code><code class="o">.</code><code class="n">stdout</code><code class="p">)</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" id="callout_testing_with_pytest_CO1-1" href="#co_testing_with_pytest_CO1-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>For brevity, examples in this chapter only show imports on first use.</p></dd>
</dl>

<p>The refactoring extracts <code>fetch</code> and <code>show</code> functions from <code>main</code>. It also
defines an <code>Article</code> class as the common denominator of these functions. Let’s
see how these changes let you test the parts of the program in isolation and in
a repeatable way.</p>

<p>The <code>show</code> function accepts any file-like object. While <code>main</code> passes
<code>sys.stdout</code>, tests can pass an <code>io.StringIO</code> instance to store the output in
memory. <a data-type="xref" href="#example_testing_show">Example 6-4</a> uses this technique to check that the output
ends with a newline. The final newline ensures the output doesn’t run into the
next shell prompt.</p>
<div id="example_testing_show" data-type="example">
<h5><span class="label">Example 6-4. </span>Testing the <code>show</code> function</h5>

<pre data-type="programlisting" data-code-language="python"><code class="kn">import</code> <code class="nn">io</code>
<code class="kn">from</code> <code class="nn">random_wikipedia_article</code> <code class="kn">import</code> <code class="n">Article</code><code class="p">,</code> <code class="n">show</code>

<code class="k">def</code> <code class="nf">test_final_newline</code><code class="p">():</code>
    <code class="n">article</code> <code class="o">=</code> <code class="n">Article</code><code class="p">(</code><code class="s2">"Lorem Ipsum"</code><code class="p">,</code> <code class="s2">"Lorem ipsum dolor sit amet."</code><code class="p">)</code>
    <code class="n">file</code> <code class="o">=</code> <code class="n">io</code><code class="o">.</code><code class="n">StringIO</code><code class="p">()</code>
    <code class="n">show</code><code class="p">(</code><code class="n">article</code><code class="p">,</code> <code class="n">file</code><code class="p">)</code>
    <code class="k">assert</code> <code class="n">file</code><code class="o">.</code><code class="n">getvalue</code><code class="p">()</code><code class="o">.</code><code class="n">endswith</code><code class="p">(</code><code class="s2">"</code><code class="se">\n</code><code class="s2">"</code><code class="p">)</code></pre></div>

<p>There’s another benefit to the refactoring: The functions hide the
implementation behind an interface that only involves your problem domain—​URLs,
articles, files. This means your tests are less likely to break when you swap
out your implementation. Go ahead and change the <code>show</code> function to use Rich, as
shown in <a data-type="xref" href="#example_testing_rich">Example 6-5</a>.<sup><a data-type="noteref" id="id291-marker" href="ch06.html#id291">2</a></sup> You won’t need to adapt your tests!</p>
<div id="example_testing_rich" data-type="example">
<h5><span class="label">Example 6-5. </span>Swapping out the implementation of <code>show</code></h5>

<pre data-type="programlisting" data-code-language="python"><code class="kn">from</code> <code class="nn">rich.console</code> <code class="kn">import</code> <code class="n">Console</code>

<code class="k">def</code> <code class="nf">show</code><code class="p">(</code><code class="n">article</code><code class="p">,</code> <code class="n">file</code><code class="p">):</code>
    <code class="n">console</code> <code class="o">=</code> <code class="n">Console</code><code class="p">(</code><code class="n">file</code><code class="o">=</code><code class="n">file</code><code class="p">,</code> <code class="n">width</code><code class="o">=</code><code class="mi">72</code><code class="p">,</code> <code class="n">highlight</code><code class="o">=</code><code class="kc">False</code><code class="p">)</code>
    <code class="n">console</code><code class="o">.</code><code class="n">print</code><code class="p">(</code><code class="n">article</code><code class="o">.</code><code class="n">title</code><code class="p">,</code> <code class="n">style</code><code class="o">=</code><code class="s2">"bold"</code><code class="p">,</code> <code class="n">end</code><code class="o">=</code><code class="s2">"</code><code class="se">\n\n</code><code class="s2">"</code><code class="p">)</code>
    <code class="n">console</code><code class="o">.</code><code class="n">print</code><code class="p">(</code><code class="n">article</code><code class="o">.</code><code class="n">summary</code><code class="p">)</code></pre></div>

<p>In fact, the whole point of tests is to give you confidence that your program
still works after making changes like this. Mocks and monkey patches, on the
other hand, are brittle: They tie your test suite to implementation details,
making it increasingly hard to change your program down the road.</p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Fixtures and Parameterization"><div class="sect1" id="section_testing_fixtures">
<h1>Fixtures and Parameterization</h1>

<p>Here are some other properties of the <code>show</code> function that you might check for:</p>

<ul>
<li>
<p>It should include all the words of the title and summary.</p>
</li>
<li>
<p>There should be a blank line after the title.</p>
</li>
<li>
<p>The summary should not exceed a line length of 72 characters.</p>
</li>
</ul>

<p>Every test for the <code>show</code> function starts by setting up an output buffer. You
can use a fixture to remove this code duplication. <em>Fixtures</em> are functions
declared with the <code>pytest.fixture</code> decorator:</p>

<pre data-type="programlisting" data-code-language="python"><code class="nd">@pytest</code><code class="o">.</code><code class="n">fixture</code>
<code class="k">def</code> <code class="nf">file</code><code class="p">():</code>
    <code class="k">return</code> <code class="n">io</code><code class="o">.</code><code class="n">StringIO</code><code class="p">()</code></pre>

<p>Tests (and fixtures) can use a fixture by including a function parameter with
the same name. When pytest invokes the test function, it passes the return value
of the fixture function. Let’s rewrite <a data-type="xref" href="#example_testing_show">Example 6-4</a> to use the
fixture:</p>

<pre data-type="programlisting" data-code-language="python"><code class="k">def</code> <code class="nf">test_final_newline</code><code class="p">(</code><code class="n">file</code><code class="p">):</code>
    <code class="n">article</code> <code class="o">=</code> <code class="n">Article</code><code class="p">(</code><code class="s2">"Lorem Ipsum"</code><code class="p">,</code> <code class="s2">"Lorem ipsum dolor sit amet."</code><code class="p">)</code>
    <code class="n">show</code><code class="p">(</code><code class="n">article</code><code class="p">,</code> <code class="n">file</code><code class="p">)</code>
    <code class="k">assert</code> <code class="n">file</code><code class="o">.</code><code class="n">getvalue</code><code class="p">()</code><code class="o">.</code><code class="n">endswith</code><code class="p">(</code><code class="s2">"</code><code class="se">\n</code><code class="s2">"</code><code class="p">)</code></pre>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>If you forget to add the parameter <code>file</code> to the test function, you get a
confusing error: <code>'function' object has no attribute 'write'</code>. This happens
because the name <code>file</code> now refers to the fixture function in the same
module.<sup><a data-type="noteref" id="id292-marker" href="ch06.html#id292">3</a></sup></p>
</div>

<p>If every test used the same article, you’d likely miss some edge cases. For
example, you don’t want your program to crash if an article comes with an empty
title. <a data-type="xref" href="#example_testing_parametrize">Example 6-6</a> runs the test for a number of articles
with the <code>@pytest.mark.parametrize</code> decorator.<sup><a data-type="noteref" id="id293-marker" href="ch06.html#id293">4</a></sup></p>
<div id="example_testing_parametrize" data-type="example">
<h5><span class="label">Example 6-6. </span>Running tests against multiple articles</h5>

<pre data-type="programlisting" data-code-language="python"><code class="n">articles</code> <code class="o">=</code> <code class="p">[</code>
    <code class="n">Article</code><code class="p">(),</code>
    <code class="n">Article</code><code class="p">(</code><code class="s2">"test"</code><code class="p">),</code>
    <code class="n">Article</code><code class="p">(</code><code class="s2">"Lorem Ipsum"</code><code class="p">,</code> <code class="s2">"Lorem ipsum dolor sit amet."</code><code class="p">),</code>
    <code class="n">Article</code><code class="p">(</code>
        <code class="s2">"Lorem ipsum dolor sit amet, consectetur adipiscing elit"</code><code class="p">,</code>
        <code class="s2">"Nulla mattis volutpat sapien, at dapibus ipsum accumsan eu."</code>
    <code class="p">),</code>
<code class="p">]</code>

<code class="nd">@pytest</code><code class="o">.</code><code class="n">mark</code><code class="o">.</code><code class="n">parametrize</code><code class="p">(</code><code class="s2">"article"</code><code class="p">,</code> <code class="n">articles</code><code class="p">)</code>
<code class="k">def</code> <code class="nf">test_final_newline</code><code class="p">(</code><code class="n">article</code><code class="p">,</code> <code class="n">file</code><code class="p">):</code>
    <code class="n">show</code><code class="p">(</code><code class="n">article</code><code class="p">,</code> <code class="n">file</code><code class="p">)</code>
    <code class="k">assert</code> <code class="n">file</code><code class="o">.</code><code class="n">getvalue</code><code class="p">()</code><code class="o">.</code><code class="n">endswith</code><code class="p">(</code><code class="s2">"</code><code class="se">\n</code><code class="s2">"</code><code class="p">)</code></pre></div>

<p>If you parameterize many tests in the same way, you can create a <em>parameterized
fixture</em>, a fixture with multiple values
(<a data-type="xref" href="#example_testing_parametrized_fixture">Example 6-7</a>). As before, pytest runs the test once
for each article in <code>articles</code>.</p>
<div id="example_testing_parametrized_fixture" data-type="example">
<h5><span class="label">Example 6-7. </span>Parameterized fixture for running tests against multiple articles</h5>

<pre data-type="programlisting" data-code-language="python"><code class="nd">@pytest</code><code class="o">.</code><code class="n">fixture</code><code class="p">(</code><code class="n">params</code><code class="o">=</code><code class="n">articles</code><code class="p">)</code>
<code class="k">def</code> <code class="nf">article</code><code class="p">(</code><code class="n">request</code><code class="p">):</code>
    <code class="k">return</code> <code class="n">request</code><code class="o">.</code><code class="n">param</code>

<code class="k">def</code> <code class="nf">test_final_newline</code><code class="p">(</code><code class="n">article</code><code class="p">,</code> <code class="n">file</code><code class="p">):</code>
    <code class="n">show</code><code class="p">(</code><code class="n">article</code><code class="p">,</code> <code class="n">file</code><code class="p">)</code>
    <code class="k">assert</code> <code class="n">file</code><code class="o">.</code><code class="n">getvalue</code><code class="p">()</code><code class="o">.</code><code class="n">endswith</code><code class="p">(</code><code class="s2">"</code><code class="se">\n</code><code class="s2">"</code><code class="p">)</code></pre></div>

<p>So what did you gain here? For one thing, you don’t need to decorate each test
with <code>@pytest.mark.parametrize</code>. There’s another advantage if your tests aren’t
all in the same module: You can place fixtures in a file named <em>conftest.py</em> and
use them across your entire test suite without imports.</p>

<p>The syntax for parameterized fixtures is somewhat arcane. To keep things simple,
I like to define a small helper:</p>

<pre data-type="programlisting" data-code-language="python"><code class="k">def</code> <code class="nf">parametrized_fixture</code><code class="p">(</code><code class="o">*</code><code class="n">params</code><code class="p">):</code>
    <code class="k">return</code> <code class="n">pytest</code><code class="o">.</code><code class="n">fixture</code><code class="p">(</code><code class="n">params</code><code class="o">=</code><code class="n">params</code><code class="p">)(</code><code class="k">lambda</code> <code class="n">request</code><code class="p">:</code> <code class="n">request</code><code class="o">.</code><code class="n">param</code><code class="p">)</code></pre>

<p>Use the helper to simplify the fixture from
<a data-type="xref" href="#example_testing_parametrized_fixture">Example 6-7</a>. You can also inline the <code>articles</code>
variable from <a data-type="xref" href="#example_testing_parametrize">Example 6-6</a>:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">article</code> <code class="o">=</code> <code class="n">parametrized_fixture</code><code class="p">(</code><code class="n">Article</code><code class="p">(),</code> <code class="n">Article</code><code class="p">(</code><code class="s2">"test"</code><code class="p">),</code> <code class="o">...</code><code class="p">)</code></pre>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="sidebar_testing_unittest">
<h1>The unittest Framework</h1>
<p>The standard library includes a testing framework in the <code>unittest</code>
module—​inspired by JUnit, a Java testing library from the early days of
Test-Driven Development. Let’s rewrite the test using <code>unittest</code> and compare it
with the pytest version:</p>

<pre data-type="programlisting" data-code-language="python"><code class="kn">import</code> <code class="nn">unittest</code>

<code class="k">class</code> <code class="nc">TestShow</code><code class="p">(</code><code class="n">unittest</code><code class="o">.</code><code class="n">TestCase</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf">setUp</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">article</code> <code class="o">=</code> <code class="n">Article</code><code class="p">(</code><code class="s2">"Lorem Ipsum"</code><code class="p">,</code> <code class="s2">"Lorem ipsum dolor sit amet."</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">file</code> <code class="o">=</code> <code class="n">io</code><code class="o">.</code><code class="n">StringIO</code><code class="p">()</code>

    <code class="k">def</code> <code class="nf">test_final_newline</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="n">show</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">article</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">file</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertEqual</code><code class="p">(</code><code class="s2">"</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">file</code><code class="o">.</code><code class="n">getvalue</code><code class="p">()[</code><code class="o">-</code><code class="mi">1</code><code class="p">])</code></pre>

<p>In <code>unittest</code>, tests are methods with names that start with <code>test</code>, in a class
derived from <code>unittest.TestCase</code>. The <code>assert*</code> methods let you check for
expected properties. The <code>setUp</code> method prepares the <em>test environment</em> for each
test—​the test objects each test uses. In this case, you’re setting up an
<code>Article</code> instance and an output buffer for the <code>show</code> function.</p>

<p>Run the test suite from the project directory using the command <code>py -m unittest</code>.</p>
<pre data-type="programlisting">$ <strong>py -m unittest</strong>
.
----------------------------------------------------------------------
Ran 1 test in 0.000s

OK
</pre>

<p>Writing tests with <code>unittest</code> saves you a third-party dependency. If you’re
already familiar with a JUnit-style framework from another language, you’ll feel
right at home. But there are several problems with its design:</p>

<ul>
<li>
<p>The class tightly couples tests and the test environment. As a result, you
can’t reuse test objects as easily as with pytest fixtures.</p>
</li>
<li>
<p>The framework uses inheritance to provide shared functionality. This couples
tests with the framework plumbing, all in a single namespace and instance.</p>
</li>
<li>
<p>Placing tests in a class makes them less readable than a module with
functions.</p>
</li>
<li>
<p>The assertion methods lack expressivity and generality—​every type of check
requires a dedicated method. For example, you have <code>assertEqual</code> and
<code>assertIn</code>, but there’s no <code>assertStartsWith</code>.</p>
</li>
</ul>
</div></aside>
<div data-type="tip"><h6>Tip</h6>
<p>If you have a test suite written with <code>unittest</code>, there’s no need to rewrite it
to start using pytest—​pytest “speaks” <code>unittest</code>, too. Use pytest as a test
runner right away and you can rewrite your test suite incrementally later.</p>
</div>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Advanced Techniques for Fixtures"><div class="sect1" id="id160">
<h1>Advanced Techniques for Fixtures</h1>

<p>For the <code>fetch</code> function, tests can set up a local HTTP server and perform a
<em>roundtrip</em> check. This is shown in <a data-type="xref" href="#example_testing_fetch">Example 6-8</a>: You serve an
<code>Article</code> instance via HTTP, fetch the article from the server, and check that
the served and fetched instances are equal.</p>
<div id="example_testing_fetch" data-type="example">
<h5><span class="label">Example 6-8. </span>Testing the <code>fetch</code> function (version 1)</h5>

<pre data-type="programlisting" data-code-language="python"><code class="k">def</code> <code class="nf">test_fetch</code><code class="p">(</code><code class="n">article</code><code class="p">):</code>
    <code class="k">with</code> <code class="n">serve</code><code class="p">(</code><code class="n">article</code><code class="p">)</code> <code class="k">as</code> <code class="n">url</code><code class="p">:</code>
        <code class="k">assert</code> <code class="n">article</code> <code class="o">==</code> <code class="n">fetch</code><code class="p">(</code><code class="n">url</code><code class="p">)</code></pre></div>

<p>The <code>serve</code> helper function takes an article and returns a URL for fetching the
article. More precisely, it wraps the URL in a <em>context manager</em>, an object for
use in a <code>with</code> block. This allows <code>serve</code> to clean up after itself when you
exit the <code>with</code> block—​by shutting down the server:</p>

<pre data-type="programlisting" data-code-language="python"><code class="kn">from</code> <code class="nn">contextlib</code> <code class="kn">import</code> <code class="n">contextmanager</code>

<code class="nd">@contextmanager</code>
<code class="k">def</code> <code class="nf">serve</code><code class="p">(</code><code class="n">article</code><code class="p">):</code>
    <code class="o">...</code> <code class="c1"># start the server</code>
    <code class="k">yield</code> <code class="sa">f</code><code class="s2">"http://localhost:</code><code class="si">{</code><code class="n">server</code><code class="o">.</code><code class="n">server_port</code><code class="si">}</code><code class="s2">"</code>
    <code class="o">...</code> <code class="c1"># shut down the server</code></pre>

<p>You can implement the <code>serve</code> function using the <code>http.server</code> module from the
standard library (<a data-type="xref" href="#example_testing_serve">Example 6-9</a>). Don’t worry too much about the
details, though. Later in this chapter, I’ll introduce the <code>pytest-httpserver</code>
plugin, which will bear the brunt of the work.</p>
<div id="example_testing_serve" data-type="example">
<h5><span class="label">Example 6-9. </span>The <code>serve</code> function</h5>

<pre data-type="programlisting" data-code-language="python"><code class="kn">import</code><code> </code><code class="nn">http</code><code class="nn">.</code><code class="nn">server</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">json</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">threading</code><code>
</code><code>
</code><code class="nd">@contextmanager</code><code>
</code><code class="k">def</code><code> </code><code class="nf">serve</code><code class="p">(</code><code class="n">article</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="p">{</code><code class="s2">"</code><code class="s2">title</code><code class="s2">"</code><code class="p">:</code><code> </code><code class="n">article</code><code class="o">.</code><code class="n">title</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">extract</code><code class="s2">"</code><code class="p">:</code><code> </code><code class="n">article</code><code class="o">.</code><code class="n">summary</code><code class="p">}</code><code>
</code><code>    </code><code class="n">body</code><code> </code><code class="o">=</code><code> </code><code class="n">json</code><code class="o">.</code><code class="n">dumps</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code class="o">.</code><code class="n">encode</code><code class="p">(</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="k">class</code><code> </code><code class="nc">Handler</code><code class="p">(</code><code class="n">http</code><code class="o">.</code><code class="n">server</code><code class="o">.</code><code class="n">BaseHTTPRequestHandler</code><code class="p">)</code><code class="p">:</code><code> </code><a class="co" id="co_testing_with_pytest_CO2-1" href="#callout_testing_with_pytest_CO2-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>        </code><code class="k">def</code><code> </code><code class="nf">do_GET</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>            </code><code class="bp">self</code><code class="o">.</code><code class="n">send_response</code><code class="p">(</code><code class="mi">200</code><code class="p">)</code><code>
</code><code>            </code><code class="bp">self</code><code class="o">.</code><code class="n">send_header</code><code class="p">(</code><code class="s2">"</code><code class="s2">Content-Type</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">application/json</code><code class="s2">"</code><code class="p">)</code><code>
</code><code>            </code><code class="bp">self</code><code class="o">.</code><code class="n">send_header</code><code class="p">(</code><code class="s2">"</code><code class="s2">Content-Length</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="nb">str</code><code class="p">(</code><code class="nb">len</code><code class="p">(</code><code class="n">body</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code>
</code><code>            </code><code class="bp">self</code><code class="o">.</code><code class="n">end_headers</code><code class="p">(</code><code class="p">)</code><code>
</code><code>            </code><code class="bp">self</code><code class="o">.</code><code class="n">wfile</code><code class="o">.</code><code class="n">write</code><code class="p">(</code><code class="n">body</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="k">with</code><code> </code><code class="n">http</code><code class="o">.</code><code class="n">server</code><code class="o">.</code><code class="n">HTTPServer</code><code class="p">(</code><code class="p">(</code><code class="s2">"</code><code class="s2">localhost</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">Handler</code><code class="p">)</code><code> </code><code class="k">as</code><code> </code><code class="n">server</code><code class="p">:</code><code> </code><a class="co" id="co_testing_with_pytest_CO2-2" href="#callout_testing_with_pytest_CO2-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>        </code><code class="n">thread</code><code> </code><code class="o">=</code><code> </code><code class="n">threading</code><code class="o">.</code><code class="n">Thread</code><code class="p">(</code><code class="n">target</code><code class="o">=</code><code class="n">server</code><code class="o">.</code><code class="n">serve_forever</code><code class="p">,</code><code> </code><code class="n">daemon</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code><code> </code><a class="co" id="co_testing_with_pytest_CO2-3" href="#callout_testing_with_pytest_CO2-3"><img src="assets/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>        </code><code class="n">thread</code><code class="o">.</code><code class="n">start</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="k">yield</code><code> </code><code class="sa">f</code><code class="s2">"</code><code class="s2">http://localhost:</code><code class="si">{</code><code class="n">server</code><code class="o">.</code><code class="n">server_port</code><code class="si">}</code><code class="s2">"</code><code>
</code><code>        </code><code class="n">server</code><code class="o">.</code><code class="n">shutdown</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="n">thread</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="p">)</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" id="callout_testing_with_pytest_CO2-1" href="#co_testing_with_pytest_CO2-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>The request handler responds to every GET request with a UTF-8 encoded JSON
representation of the article.</p></dd>
<dt><a class="co" id="callout_testing_with_pytest_CO2-2" href="#co_testing_with_pytest_CO2-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>The server only accepts local connections. The operating system randomly
assigns the port number.</p></dd>
<dt><a class="co" id="callout_testing_with_pytest_CO2-3" href="#co_testing_with_pytest_CO2-3"><img src="assets/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>The server runs in a background thread. This allows control to return to the
tests.</p></dd>
</dl>

<p>Firing up and shutting down a web server for every test is expensive. Would it
help to turn the server into a fixture? At first glance, not much—​every test
gets its own instance of a fixture. However, you can instruct pytest to create a
fixture only once during the entire test session, using a <em>session-scoped
fixture</em>:</p>

<pre data-type="programlisting" data-code-language="python"><code class="nd">@pytest</code><code class="o">.</code><code class="n">fixture</code><code class="p">(</code><code class="n">scope</code><code class="o">=</code><code class="s2">"session"</code><code class="p">)</code>
<code class="k">def</code> <code class="nf">httpserver</code><code class="p">():</code>
    <code class="o">...</code></pre>

<p>That looks more promising, but how do you shut down the server when the tests
are done with it? Up to now, your fixtures have only prepared a test object and
returned it. You can’t run code after a <code>return</code> statement. However, you <em>can</em>
run code after a <code>yield</code> statement—​so pytest allows you to define a fixture as
a generator.</p>

<p>A <em>generator fixture</em> prepares a test object, yields it, and cleans up resources
at the end—​similar to a context manager. You use it in the same way as an
ordinary fixture that returns its test object. Pytest handles the setup and
teardown phases behind the scenes and calls your test function with the yielded
value.</p>

<p><a data-type="xref" href="#example_testing_httpserver_fixture">Example 6-10</a> defines the <code>httpserver</code> fixture using
the generator technique.</p>
<div id="example_testing_httpserver_fixture" data-type="example">
<h5><span class="label">Example 6-10. </span>The <code>httpserver</code> fixture</h5>

<pre data-type="programlisting" data-code-language="python"><code class="nd">@pytest</code><code class="o">.</code><code class="n">fixture</code><code class="p">(</code><code class="n">scope</code><code class="o">=</code><code class="s2">"</code><code class="s2">session</code><code class="s2">"</code><code class="p">)</code><code>
</code><code class="k">def</code><code> </code><code class="nf">httpserver</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="k">class</code><code> </code><code class="nc">Handler</code><code class="p">(</code><code class="n">http</code><code class="o">.</code><code class="n">server</code><code class="o">.</code><code class="n">BaseHTTPRequestHandler</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="k">def</code><code> </code><code class="nf">do_GET</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>            </code><code class="n">article</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">server</code><code class="o">.</code><code class="n">article</code><code> </code><a class="co" id="co_testing_with_pytest_CO3-1" href="#callout_testing_with_pytest_CO3-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>            </code><code class="n">data</code><code> </code><code class="o">=</code><code> </code><code class="p">{</code><code class="s2">"</code><code class="s2">title</code><code class="s2">"</code><code class="p">:</code><code> </code><code class="n">article</code><code class="o">.</code><code class="n">title</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">extract</code><code class="s2">"</code><code class="p">:</code><code> </code><code class="n">article</code><code class="o">.</code><code class="n">summary</code><code class="p">}</code><code>
</code><code>            </code><code class="n">body</code><code> </code><code class="o">=</code><code> </code><code class="n">json</code><code class="o">.</code><code class="n">dumps</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code class="o">.</code><code class="n">encode</code><code class="p">(</code><code class="p">)</code><code>
</code><code>            </code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code> </code><code class="c1"># as before</code><code>
</code><code>
</code><code>    </code><code class="k">with</code><code> </code><code class="n">http</code><code class="o">.</code><code class="n">server</code><code class="o">.</code><code class="n">HTTPServer</code><code class="p">(</code><code class="p">(</code><code class="s2">"</code><code class="s2">localhost</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">Handler</code><code class="p">)</code><code> </code><code class="k">as</code><code> </code><code class="n">server</code><code class="p">:</code><code>
</code><code>        </code><code class="n">thread</code><code> </code><code class="o">=</code><code> </code><code class="n">threading</code><code class="o">.</code><code class="n">Thread</code><code class="p">(</code><code class="n">target</code><code class="o">=</code><code class="n">server</code><code class="o">.</code><code class="n">serve_forever</code><code class="p">,</code><code> </code><code class="n">daemon</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code><code>
</code><code>        </code><code class="n">thread</code><code class="o">.</code><code class="n">start</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="k">yield</code><code> </code><code class="n">server</code><code>
</code><code>        </code><code class="n">server</code><code class="o">.</code><code class="n">shutdown</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="n">thread</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="p">)</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" id="callout_testing_with_pytest_CO3-1" href="#co_testing_with_pytest_CO3-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Unlike in <a data-type="xref" href="#example_testing_serve">Example 6-9</a>, there’s no <code>article</code> in scope. Instead,
the request handler accesses it from the <code>article</code> attribute on the server (see
below).</p></dd>
</dl>

<p>There’s still a missing piece: You need to define the <code>serve</code> function. The
function now depends on the <code>httpserver</code> fixture to do its work, so you can’t
just define it at the module level. Let’s move it into the test function for now
(<a data-type="xref" href="#example_testing_fetch_v2">Example 6-11</a>).</p>
<div id="example_testing_fetch_v2" data-type="example">
<h5><span class="label">Example 6-11. </span>Testing the <code>fetch</code> function (version 2)</h5>

<pre data-type="programlisting" data-code-language="python"><code class="k">def</code><code> </code><code class="nf">test_fetch</code><code class="p">(</code><code class="n">article</code><code class="p">,</code><code> </code><code class="n">httpserver</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">serve</code><code class="p">(</code><code class="n">article</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="n">httpserver</code><code class="o">.</code><code class="n">article</code><code> </code><code class="o">=</code><code> </code><code class="n">article</code><code> </code><a class="co" id="co_testing_with_pytest_CO4-1" href="#callout_testing_with_pytest_CO4-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="sa">f</code><code class="s2">"</code><code class="s2">http://localhost:</code><code class="si">{</code><code class="n">httpserver</code><code class="o">.</code><code class="n">server_port</code><code class="si">}</code><code class="s2">"</code><code>
</code><code>
</code><code>    </code><code class="k">assert</code><code> </code><code class="n">article</code><code> </code><code class="o">==</code><code> </code><code class="n">fetch</code><code class="p">(</code><code class="n">serve</code><code class="p">(</code><code class="n">article</code><code class="p">)</code><code class="p">)</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" id="callout_testing_with_pytest_CO4-1" href="#co_testing_with_pytest_CO4-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Store the article in the server, so the request handler can access it.</p></dd>
</dl>

<p>The <code>serve</code> function no longer returns a context manager, just a plain URL—​the
<code>httpserver</code> fixture handles all of the setting up and tearing down. But you can
still do better. The nested function clutters the test—​and every other test for
the <code>fetch</code> function. Instead, let’s define <code>serve</code> inside its own
fixture—​after all, fixtures can return any object, including functions
(<a data-type="xref" href="#example_testing_serve_fixture">Example 6-12</a>).</p>
<div id="example_testing_serve_fixture" data-type="example">
<h5><span class="label">Example 6-12. </span>The <code>serve</code> fixture</h5>

<pre data-type="programlisting" data-code-language="python"><code class="nd">@pytest</code><code class="o">.</code><code class="n">fixture</code><code>
</code><code class="k">def</code><code> </code><code class="nf">serve</code><code class="p">(</code><code class="n">httpserver</code><code class="p">)</code><code class="p">:</code><code> </code><a class="co" id="co_testing_with_pytest_CO5-1" href="#callout_testing_with_pytest_CO5-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">f</code><code class="p">(</code><code class="n">article</code><code class="p">)</code><code class="p">:</code><code> </code><a class="co" id="co_testing_with_pytest_CO5-2" href="#callout_testing_with_pytest_CO5-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>        </code><code class="n">httpserver</code><code class="o">.</code><code class="n">article</code><code> </code><code class="o">=</code><code> </code><code class="n">article</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="sa">f</code><code class="s2">"</code><code class="s2">http://localhost:</code><code class="si">{</code><code class="n">httpserver</code><code class="o">.</code><code class="n">server_port</code><code class="si">}</code><code class="s2">"</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">f</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" id="callout_testing_with_pytest_CO5-1" href="#co_testing_with_pytest_CO5-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>The outer function defines a <code>serve</code> fixture, which depends on <code>httpserver</code>.</p></dd>
<dt><a class="co" id="callout_testing_with_pytest_CO5-2" href="#co_testing_with_pytest_CO5-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>The inner function is the <code>serve</code> function you call in your tests.</p></dd>
</dl>

<p>Thanks to the <code>serve</code> fixture, the test function becomes a one-liner
(<a data-type="xref" href="#example_testing_fetch_fixture">Example 6-13</a>). It’s also much faster, because you only
start and stop the server once per session.</p>
<div id="example_testing_fetch_fixture" data-type="example">
<h5><span class="label">Example 6-13. </span>Testing the <code>fetch</code> function (version 3)</h5>

<pre data-type="programlisting" data-code-language="python"><code class="k">def</code> <code class="nf">test_fetch</code><code class="p">(</code><code class="n">article</code><code class="p">,</code> <code class="n">serve</code><code class="p">):</code>
    <code class="k">assert</code> <code class="n">article</code> <code class="o">==</code> <code class="n">fetch</code><code class="p">(</code><code class="n">serve</code><code class="p">(</code><code class="n">article</code><code class="p">))</code></pre></div>

<p>Your test isn’t tied to any particular HTTP client library.
<a data-type="xref" href="#example_testing_httpx">Example 6-14</a> swaps out the implementation of the <code>fetch</code> function
to use HTTPX.<sup><a data-type="noteref" id="id294-marker" href="ch06.html#id294">5</a></sup> This would have broken any test that used monkey patching—​but your
test will still pass!</p>
<div id="example_testing_httpx" data-type="example">
<h5><span class="label">Example 6-14. </span>Swapping out the implementation of <code>fetch</code></h5>

<pre data-type="programlisting" data-code-language="python"><code class="kn">import</code> <code class="nn">httpx</code>

<code class="kn">from</code> <code class="nn">importlib.metadata</code> <code class="kn">import</code> <code class="n">metadata</code>

<code class="n">USER_AGENT</code> <code class="o">=</code> <code class="s2">"</code><code class="si">{Name}</code><code class="s2">/</code><code class="si">{Version}</code><code class="s2"> (Contact: {Author-email})"</code>

<code class="k">def</code> <code class="nf">fetch</code><code class="p">(</code><code class="n">url</code><code class="p">):</code>
    <code class="n">fields</code> <code class="o">=</code> <code class="n">metadata</code><code class="p">(</code><code class="s2">"random-wikipedia-article"</code><code class="p">)</code>
    <code class="n">headers</code> <code class="o">=</code> <code class="p">{</code><code class="s2">"User-Agent"</code><code class="p">:</code> <code class="n">USER_AGENT</code><code class="o">.</code><code class="n">format_map</code><code class="p">(</code><code class="n">fields</code><code class="p">)}</code>

    <code class="k">with</code> <code class="n">httpx</code><code class="o">.</code><code class="n">Client</code><code class="p">(</code><code class="n">headers</code><code class="o">=</code><code class="n">headers</code><code class="p">,</code> <code class="n">http2</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code> <code class="k">as</code> <code class="n">client</code><code class="p">:</code>
        <code class="n">response</code> <code class="o">=</code> <code class="n">client</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">url</code><code class="p">,</code> <code class="n">follow_redirects</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code>
        <code class="n">response</code><code class="o">.</code><code class="n">raise_for_status</code><code class="p">()</code>
        <code class="n">data</code> <code class="o">=</code> <code class="n">response</code><code class="o">.</code><code class="n">json</code><code class="p">()</code>

    <code class="k">return</code> <code class="n">Article</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s2">"title"</code><code class="p">],</code> <code class="n">data</code><code class="p">[</code><code class="s2">"extract"</code><code class="p">])</code></pre></div>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Extending pytest with Plugins"><div class="sect1" id="section_testing_pytest_plugins">
<h1>Extending pytest with Plugins</h1>

<p>As you’ve seen in <a data-type="xref" href="ch03.html#section_packages_entrypoints">“Entry Points”</a>, pytest’s extensible design
lets anybody contribute pytest plugins and publish them to PyPI,<sup><a data-type="noteref" id="id295-marker" href="ch06.html#id295">6</a></sup> so a
rich ecosystem of plugins has evolved. You’ve already seen the <code>pytest-sugar</code>
plugin, which enhances pytest’s output, including adding a progress bar. In this
section, you’ll look at a few more.</p>








<section data-type="sect2" data-pdf-bookmark="The pytest-httpserver Plugin"><div class="sect2" id="id162">
<h2>The pytest-httpserver Plugin</h2>

<p>The <a href="https://pytest-httpserver.readthedocs.io/"><code>pytest-httpserver</code></a> plugin
provides an <code>httpserver</code> fixture that’s more versatile and battle-tested than
<a data-type="xref" href="#example_testing_httpserver_fixture">Example 6-10</a>. Let’s use this plugin.</p>

<p>First, add <code>pytest-httpserver</code> to your test dependencies. Next, remove the
existing <code>httpserver</code> fixture from your test module. Finally, update the <code>serve</code>
fixture to use the plugin (<a data-type="xref" href="#example_testing_serve_fixture_plugin">Example 6-15</a>).</p>
<div id="example_testing_serve_fixture_plugin" data-type="example">
<h5><span class="label">Example 6-15. </span>The <code>serve</code> fixture using <code>pytest-httpserver</code></h5>

<pre data-type="programlisting" data-code-language="python"><code class="nd">@pytest</code><code class="o">.</code><code class="n">fixture</code>
<code class="k">def</code> <code class="nf">serve</code><code class="p">(</code><code class="n">httpserver</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf">f</code><code class="p">(</code><code class="n">article</code><code class="p">):</code>
        <code class="n">json</code> <code class="o">=</code> <code class="p">{</code><code class="s2">"title"</code><code class="p">:</code> <code class="n">article</code><code class="o">.</code><code class="n">title</code><code class="p">,</code> <code class="s2">"extract"</code><code class="p">:</code> <code class="n">article</code><code class="o">.</code><code class="n">summary</code><code class="p">}</code>
        <code class="n">httpserver</code><code class="o">.</code><code class="n">expect_request</code><code class="p">(</code><code class="s2">"/"</code><code class="p">)</code><code class="o">.</code><code class="n">respond_with_json</code><code class="p">(</code><code class="n">json</code><code class="p">)</code>
        <code class="k">return</code> <code class="n">httpserver</code><code class="o">.</code><code class="n">url_for</code><code class="p">(</code><code class="s2">"/"</code><code class="p">)</code>
    <code class="k">return</code> <code class="n">f</code></pre></div>

<p><a data-type="xref" href="#example_testing_serve_fixture_plugin">Example 6-15</a> configures the server to respond to
requests to <code>"/"</code> with the JSON representation of the article. The plugin offers
much flexibility beyond this use case—​for example, you can add custom request
handlers or communicate over HTTPS.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="The pytest-xdist Plugin"><div class="sect2" id="id163">
<h2>The pytest-xdist Plugin</h2>

<p>As your test suite grows, you’ll be looking for ways to speed up test runs.
Here’s an easy way: utilize all your CPU cores. The
<a href="https://pytest-xdist.readthedocs.io/"><code>pytest-xdist</code></a> plugin spawns a worker
process on each processor and distributes tests randomly across the workers. The
randomization also helps detect hidden dependencies between your tests.</p>

<p>Add <code>pytest-xdist</code> to your test dependencies and update your environment. Use
the option <code>--numprocesses</code> or <code>-n</code> to specify the number of worker processes.
Specify <code>auto</code> to use all physical cores on your system:</p>
<pre data-type="programlisting">$ <strong>py -m pytest -n auto</strong>
</pre>
</div></section>








<section data-type="sect2" data-pdf-bookmark="The factory-boy and faker Libraries"><div class="sect2" id="id164">
<h2>The factory-boy and faker Libraries</h2>

<p>In <a data-type="xref" href="#section_testing_fixtures">“Fixtures and Parameterization”</a>, you hardcoded the articles your tests run
against. Let’s avoid this boilerplate—​it makes your tests hard to maintain.</p>

<p>Instead, the <a href="https://factoryboy.readthedocs.io/"><code>factory-boy</code></a> library lets you
create factories for test objects. You can generate batches of objects with
predictable attributes, such as by using a sequence number. Alternatively, you
can populate attributes randomly using the
<a href="https://faker.readthedocs.io/"><code>faker</code></a> library.</p>

<p>Add <code>factory-boy</code> to your test dependencies and update your environment.
<a data-type="xref" href="#example_testing_factoryboy">Example 6-16</a> defines a factory for randomized articles and
creates a batch of ten articles for the <code>article</code> fixture. (If you want to see
<code>pytest-xdist</code> in action, increase the number of articles and run pytest with
<code>-n auto</code>.)</p>
<div id="example_testing_factoryboy" data-type="example">
<h5><span class="label">Example 6-16. </span>Creating a batch of articles with <code>factory-boy</code> and <code>faker</code></h5>

<pre data-type="programlisting" data-code-language="python"><code class="kn">from</code><code> </code><code class="nn">factory</code><code> </code><code class="kn">import</code><code> </code><code class="n">Factory</code><code class="p">,</code><code> </code><code class="n">Faker</code><code>
</code><code>
</code><code class="k">class</code><code> </code><code class="nc">ArticleFactory</code><code class="p">(</code><code class="n">Factory</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="k">class</code><code> </code><code class="nc">Meta</code><code class="p">:</code><code>
</code><code>        </code><code class="n">model</code><code> </code><code class="o">=</code><code> </code><code class="n">Article</code><code> </code><a class="co" id="co_testing_with_pytest_CO6-1" href="#callout_testing_with_pytest_CO6-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>
</code><code>    </code><code class="n">title</code><code> </code><code class="o">=</code><code> </code><code class="n">Faker</code><code class="p">(</code><code class="s2">"</code><code class="s2">sentence</code><code class="s2">"</code><code class="p">)</code><code> </code><a class="co" id="co_testing_with_pytest_CO6-2" href="#callout_testing_with_pytest_CO6-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>    </code><code class="n">summary</code><code> </code><code class="o">=</code><code> </code><code class="n">Faker</code><code class="p">(</code><code class="s2">"</code><code class="s2">paragraph</code><code class="s2">"</code><code class="p">)</code><code>
</code><code>
</code><code class="n">article</code><code> </code><code class="o">=</code><code> </code><code class="n">parametrized_fixture</code><code class="p">(</code><code class="o">*</code><code class="n">ArticleFactory</code><code class="o">.</code><code class="n">build_batch</code><code class="p">(</code><code class="mi">10</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" id="co_testing_with_pytest_CO6-3" href="#callout_testing_with_pytest_CO6-3"><img src="assets/3.png" alt="3" width="12" height="12"/></a></pre></div>
<dl class="calloutlist">
<dt><a class="co" id="callout_testing_with_pytest_CO6-1" href="#co_testing_with_pytest_CO6-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Specify the class of the test objects with <code>Meta.model</code>.</p></dd>
<dt><a class="co" id="callout_testing_with_pytest_CO6-2" href="#co_testing_with_pytest_CO6-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Use a random sentence for the title and a random paragraph for the summary.</p></dd>
<dt><a class="co" id="callout_testing_with_pytest_CO6-3" href="#co_testing_with_pytest_CO6-3"><img src="assets/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Generate a batch of articles using the <code>build_batch</code> method.</p></dd>
</dl>

<p>This simplified factory doesn’t cover edge cases particularly well. For a
real-world application, you should include empty and extremely large strings, as
well as unusual characters such as control characters. Another great testing
library that lets you explore the search space of possible inputs is
<a href="https://hypothesis.readthedocs.io/"><code>hypothesis</code></a>.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Other Plugins"><div class="sect2" id="id165">
<h2>Other Plugins</h2>

<p>Pytest plugins perform a variety of functions
(<a data-type="xref" href="#table_testing_pytest_plugins">Table 6-1</a>). These include executing tests in parallel or
in random order, presenting or reporting test results in custom ways, and
integrating with frameworks and other tools. Many plugins provide useful
fixtures—​such as for interacting with external systems or creating test
doubles.<sup><a data-type="noteref" id="id296-marker" href="ch06.html#id296">7</a></sup></p>
<table id="table_testing_pytest_plugins">
<caption><span class="label">Table 6-1. </span>A selection of pytest plugins</caption>
<thead>
<tr>
<th>Plugin</th>
<th>Category</th>
<th>Description</th>
<th>Option</th>
</tr>
</thead>
<tbody>
<tr>
<td><p><code>pytest-xdist</code></p></td>
<td><p>Execution</p></td>
<td><p>Distribute tests across multiple CPUs</p></td>
<td><p><code>--numprocesses</code></p></td>
</tr>
<tr>
<td><p><code>pytest-sugar</code></p></td>
<td><p>Presentation</p></td>
<td><p>Enhance output with a progress bar</p></td>
<td/>
</tr>
<tr>
<td><p><code>pytest-icdiff</code></p></td>
<td><p>Presentation</p></td>
<td><p>Show colorized diffs on test failures</p></td>
<td/>
</tr>
<tr>
<td><p><code>anyio</code></p></td>
<td><p>Frameworks</p></td>
<td><p>Use asynchronous tests with asyncio and trio</p></td>
<td/>
</tr>
<tr>
<td><p><code>pytest-httpserver</code></p></td>
<td><p>Fake servers</p></td>
<td><p>Spawn an HTTP server with canned responses</p></td>
<td/>
</tr>
<tr>
<td><p><code>pytest-factoryboy</code></p></td>
<td><p>Fake data</p></td>
<td><p>Turn factories into fixtures</p></td>
<td/>
</tr>
<tr>
<td><p><code>pytest-datadir</code></p></td>
<td><p>Storage</p></td>
<td><p>Access static data in your test suite</p></td>
<td/>
</tr>
<tr>
<td><p><code>pytest-cov</code></p></td>
<td><p>Coverage</p></td>
<td><p>Produce coverage reports with Coverage.py</p></td>
<td><p><code>--cov</code></p></td>
</tr>
<tr>
<td><p><code>xdoctest</code></p></td>
<td><p>Documentation</p></td>
<td><p>Run code examples from docstrings</p></td>
<td><p><code>--xdoctest</code></p></td>
</tr>
<tr>
<td><p><code>typeguard</code></p></td>
<td><p>Type checking</p></td>
<td><p>Type-check your code at runtime</p></td>
<td><p><code>--typeguard-packages</code></p></td>
</tr>
</tbody>
</table>
<div data-type="tip"><h6>Tip</h6>
<p>Find each project on PyPI at
<code>https://pypi.org/project/&lt;name&gt;</code>. The project homepage
is available under <em>Project links</em> in the navigation bar.</p>
</div>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Summary"><div class="sect1" id="id166">
<h1>Summary</h1>

<p>In this chapter, you’ve learned how to test your Python projects with pytest:</p>

<ul>
<li>
<p>Tests are functions that exercise your code and check for expected behavior
using the <code>assert</code> built-in. Prefix their names—​and the names of the
containing modules—​with <code>test_</code>, and pytest will discover them automatically.</p>
</li>
<li>
<p>Fixtures are functions or generators that set up and tear down test objects;
declare them with the <code>@pytest.fixture</code> decorator. You can use a fixture in a
test by including a parameter named like the fixture.</p>
</li>
<li>
<p>Plugins for pytest can provide useful fixtures, as well as modify test
execution, enhance reporting, and much more.</p>
</li>
</ul>

<p>One of the prime characteristics of good software is that it’s easy to change,
since any piece of code used in the real world must adapt to evolving
requirements and an ever-changing environment. Tests make change easier in
several ways:</p>

<ul>
<li>
<p>They drive software design towards loosely coupled building blocks that you
can test in isolation: fewer interdependencies mean fewer barriers to change.</p>
</li>
<li>
<p>They document and enforce expected behavior. That gives you the freedom and
confidence to continuously refactor your codebase—​keeping it maintainable as
it grows and transforms.</p>
</li>
<li>
<p>They reduce the cost of change by detecting defects early. The earlier you
catch an issue, the cheaper it is to work out the root cause and develop
a fix.</p>
</li>
</ul>

<p>End-to-end tests give you high confidence that a feature works as designed—​but
they’re slow, flaky, and bad at isolating the causes of failures. Let most of
your tests be unit tests. Avoid monkey patching to break the dependencies of
your code for testability. Instead, decouple the core of your application from
I/O, external systems, and third-party frameworks. Good software design and a
solid testing strategy will keep your test suite blazingly fast and resilient to
change.</p>

<p>This chapter focuses on the tooling side of things, but there’s so much more to
good testing practices. Luckily, other people have written fantastic texts about
this topic. Here are three of my all-time favorites:</p>

<ul>
<li>
<p>Kent Beck, <em>Test-Driven Development: By Example</em> (London: Pearson, 2002).</p>
</li>
<li>
<p>Michael Feathers, <em>Working Effectively with Legacy Code</em> (London: Pearson,
2004).</p>
</li>
<li>
<p>Harry Percival and Bob Gregory,
<a href="https://learning.oreilly.com/library/view/architecture-patterns-with/9781492052197/"><em>Architecture
Patterns in Python</em></a> (Sebastopol: O’Reilly, 2020).</p>
</li>
</ul>

<p>If you want to know all about how to test with pytest, read Brian’s book:</p>

<ul>
<li>
<p>Brian Okken, <em>Python Testing with pytest: Simple, Rapid, Effective, and
Scalable</em>, Second Edition (Raleigh: The Pragmatic Bookshelf, 2022).</p>
</li>
</ul>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="id290"><sup><a href="ch06.html#id290-marker">1</a></sup> Large packages can have modules with the same name—​say, <code>gizmo.foo.registry</code> and <code>gizmo.bar.registry</code>. Under pytest’s default <a href="https://docs.pytest.org/en/7.1.x/explanation/pythonpath.html#import-modes">import mode</a>, test modules must have unique fully-qualified names—​so you must place the <code>test_registry</code> modules in separate <code>tests.foo</code> and <code>tests.bar</code> packages.</p><p data-type="footnote" id="id291"><sup><a href="ch06.html#id291-marker">2</a></sup> Remember to add Rich to your project as described in <a data-type="xref" href="ch04.html#section_dependencies_specifications">“Specifying Dependencies for a Project”</a>. If you use Poetry, refer to <a data-type="xref" href="ch05.html#section_poetry_dependencies">“Managing Dependencies”</a>.</p><p data-type="footnote" id="id292"><sup><a href="ch06.html#id292-marker">3</a></sup> My reviewer Hynek recommends a technique to avoid this pitfall and get an idiomatic <code>NameError</code> instead. The trick is to name the fixture explicitly with <code>@pytest.fixture(name="file")</code>. This lets you use a private name for the function, such as <code>_file</code>, that doesn’t collide with the parameter.</p><p data-type="footnote" id="id293"><sup><a href="ch06.html#id293-marker">4</a></sup> Note the somewhat uncommon spelling variant <em>parametrize</em> instead of <em>parameterize</em>.</p><p data-type="footnote" id="id294"><sup><a href="ch06.html#id294-marker">5</a></sup> Remember to add a dependency on <code>httpx[http2]</code> to your project.</p><p data-type="footnote" id="id295"><sup><a href="ch06.html#id295-marker">6</a></sup> The <a href="https://github.com/pytest-dev/cookiecutter-pytest-plugin">cookiecutter-pytest-plugin</a> template gives you a solid project structure for writing your own plugin.</p><p data-type="footnote" id="id296"><sup><a href="ch06.html#id296-marker">7</a></sup> <em>Test double</em> is the umbrella term for the various kinds of objects tests use in lieu of the real objects used in production code. A good overview is <a href="https://martinfowler.com/articles/mocksArentStubs.html">“Mocks Aren’t Stubs”</a> by Martin Fowler, January 2, 2007.</p></div></div></section></div>
</div>
</body></html>