<html><head></head><body><section data-pdf-bookmark="Chapter 14. MLOps and Machine learning Engineering" data-type="chapter" epub:type="chapter"><div class="chapter" id="mlengineering">&#13;
<h1><span class="label">Chapter 14. </span>MLOps and Machine learning Engineering</h1>&#13;
&#13;
&#13;
<p><a data-primary="machine learning" data-secondary="sklearn flask with Kubernetes and Docker" data-type="indexterm" id="ix_ch14-asciidoc0"/>One of the hottest job titles in 2020 is machine learning engineer. Other hot job titles include data engineer, data scientist, and machine learning scientist.  While you can be a DevOps specialist, DevOps is a behavior, and the principles of DevOps can be applied to any software project, including machine learning. Let’s look at the some core DevOps best practices: Continuous Integration, Continuous Delivery, Microservices, Infrastructure as Code, Monitoring and Logging, and Communication and Collaboration. Which of these doesn’t apply to machine learning?</p>&#13;
&#13;
<p>The more complex a software engineering project is, and machine learning is complex, the more you need DevOps principles.  Is there a better example of a Microservice than an API that does machine learning prediction?  In this chapter, let’s dive into the nitty-gritty of doing machine learning in a professional and repeatable way using a DevOps mindset.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="What Is Machine Learning?" data-type="sect1"><div class="sect1" id="idm46691318583976">&#13;
<h1>What Is Machine Learning?</h1>&#13;
&#13;
<p><a data-primary="machine learning" data-secondary="defining" data-type="indexterm" id="ix_ch14-asciidoc1"/>Machine learning is a method of using algorithms to automatically learn from data.  There are four main types:  supervised, semi-supervised, unsupervised, and <span class="keep-together">reinforcement.</span></p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Supervised Machine Learning" data-type="sect2"><div class="sect2" id="idm46691318247112">&#13;
<h2>Supervised Machine Learning</h2>&#13;
&#13;
<p><a data-primary="machine learning" data-secondary="supervised machine learning" data-type="indexterm" id="ix_ch14-asciidoc2"/><a data-primary="supervised machine learning" data-type="indexterm" id="ix_ch14-asciidoc3"/>In supervised machine learning, the correct answers are already known and labeled.  For example, if you wanted to predict height from weight, you could collect examples of people’s heights and weights.  The height would be the target and the weight would be the feature.</p>&#13;
&#13;
<p class="pagebreak-before">Let’s walk through what an example of supervised machine learning looks like:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://oreil.ly/jzWmI">Original dataset</a></p>&#13;
</li>&#13;
<li>&#13;
<p>25,000 synthetic records of heights and weights of 18-year-old children</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Ingest" data-type="sect3"><div class="sect3" id="idm46691318239544">&#13;
<h3>Ingest</h3>&#13;
&#13;
<p><a data-primary="supervised machine learning" data-secondary="ingest" data-type="indexterm" id="idm46691318238168"/><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">pandas</code> <code class="kn">as</code> <code class="nn">pd</code></pre>&#13;
&#13;
<p><code><strong>In[7]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">df</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">read_csv</code><code class="p">(</code>&#13;
  <code class="s2">"https://raw.githubusercontent.com/noahgift/</code><code class="se">\</code>&#13;
<code class="s2">  regression-concepts/master/</code><code class="se">\</code>&#13;
<code class="s2">  height-weight-25k.csv"</code><code class="p">)</code>&#13;
<code class="n">df</code><code class="o">.</code><code class="n">head</code><code class="p">()</code></pre>&#13;
&#13;
<p><code><strong>Out[7]:</strong></code></p>&#13;
<table>&#13;
&#13;
<thead>&#13;
<tr>&#13;
<th/>&#13;
<th>Index</th>&#13;
<th>Height-Inches</th>&#13;
<th>Weight-Pounds</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><code>0</code></p></td>&#13;
<td><p><code>1</code></p></td>&#13;
<td><p><code>65.78331</code></p></td>&#13;
<td><p><code>112.9925</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>1</code></p></td>&#13;
<td><p><code>2</code></p></td>&#13;
<td><p><code>71.51521</code></p></td>&#13;
<td><p><code>136.4873</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>2</code></p></td>&#13;
<td><p><code>3</code></p></td>&#13;
<td><p><code>69.39874</code></p></td>&#13;
<td><p><code>153.0269</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>3</code></p></td>&#13;
<td><p><code>4</code></p></td>&#13;
<td><p><code>68.21660</code></p></td>&#13;
<td><p><code>142.3354</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>4</code></p></td>&#13;
<td><p><code>5</code></p></td>&#13;
<td><p><code>67.78781</code></p></td>&#13;
<td><p><code>144.2971</code></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="EDA" data-type="sect3"><div class="sect3" id="idm46691318171480">&#13;
<h3>EDA</h3>&#13;
&#13;
<p><a data-primary="EDA (Exploratory Data Analysis)" data-secondary="supervised machine learning" data-type="indexterm" id="idm46691318170312"/><a data-primary="supervised machine learning" data-secondary="EDA" data-type="indexterm" id="idm46691318169400"/>Let’s look at the data and see what can be explored.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Scatterplot" data-type="sect4"><div class="sect4" id="idm46691318168168">&#13;
<h4>Scatterplot</h4>&#13;
&#13;
<p><a data-primary="scatterplot" data-type="indexterm" id="idm46691318166760"/><a data-primary="supervised machine learning" data-secondary="scatterplot" data-type="indexterm" id="idm46691318146776"/>In this example, seaborn, a popular plotting library in Python, is used to visualize the dataset.  If you need to install it, you can always install with <code>!pip install seaborn</code> in your notebook.  You can also install any other library in the section with the <code>!pip install &lt;name of package&gt;</code>.  If you are using a Colab notebook, these libraries are installed for you. See the graph for the height/weight lm plot (<a data-type="xref" href="#Figure-14-1">Figure 14-1</a>).</p>&#13;
&#13;
<p><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">seaborn</code> <code class="kn">as</code> <code class="nn">sns</code>&#13;
<code class="kn">import</code> <code class="nn">numpy</code> <code class="kn">as</code> <code class="nn">np</code></pre>&#13;
&#13;
<p><code><strong>In[9]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">sns</code><code class="o">.</code><code class="n">lmplot</code><code class="p">(</code><code class="s2">"Height-Inches"</code><code class="p">,</code> <code class="s2">"Weight-Pounds"</code><code class="p">,</code> <code class="n">data</code><code class="o">=</code><code class="n">df</code><code class="p">)</code></pre>&#13;
&#13;
<figure><div class="figure" id="Figure-14-1">&#13;
<img alt="pydo 1401" src="assets/pydo_1401.png"/>&#13;
<h6><span class="label">Figure 14-1. </span>Height/weight lm plot</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Descriptive Statistics" data-type="sect3"><div class="sect3" id="idm46691318123512">&#13;
<h3>Descriptive Statistics</h3>&#13;
&#13;
<p><a data-primary="descriptive statistics" data-type="indexterm" id="idm46691318122040"/><a data-primary="statistics, descriptive" data-type="indexterm" id="idm46691318121336"/><a data-primary="supervised machine learning" data-secondary="descriptive statistics" data-type="indexterm" id="idm46691318120664"/>Next, some descriptive statistics can be generated.</p>&#13;
&#13;
<p><code><strong>In[10]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">df</code><code class="o">.</code><code class="n">describe</code><code class="p">()</code></pre>&#13;
&#13;
<p><code><strong>Out[10]:</strong></code></p>&#13;
<table>&#13;
&#13;
<thead>&#13;
<tr>&#13;
<th/>&#13;
<th>Index</th>&#13;
<th>Height-Inches</th>&#13;
<th>Weight-Pounds</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><code>count</code></p></td>&#13;
<td><p><code>25000.000000</code></p></td>&#13;
<td><p><code>25000.000000</code></p></td>&#13;
<td><p><code>25000.000000</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>mean</code></p></td>&#13;
<td><p><code>12500.500000</code></p></td>&#13;
<td><p><code>67.993114</code></p></td>&#13;
<td><p><code>127.079421</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>std</code></p></td>&#13;
<td><p><code>7217.022701</code></p></td>&#13;
<td><p><code>1.901679</code></p></td>&#13;
<td><p><code>11.660898</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>min</code></p></td>&#13;
<td><p><code>1.000000</code></p></td>&#13;
<td><p><code>60.278360</code></p></td>&#13;
<td><p><code>78.014760</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>25%</code></p></td>&#13;
<td><p><code>6250.750000</code></p></td>&#13;
<td><p><code>66.704397</code></p></td>&#13;
<td><p><code>119.308675</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>50%</code></p></td>&#13;
<td><p><code>12500.500000</code></p></td>&#13;
<td><p><code>67.995700</code></p></td>&#13;
<td><p><code>127.157750</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>75%</code></p></td>&#13;
<td><p><code>18750.250000</code></p></td>&#13;
<td><p><code>69.272958</code></p></td>&#13;
<td><p><code>134.892850</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>max</code></p></td>&#13;
<td><p><code>25000.000000</code></p></td>&#13;
<td><p><code>75.152800</code></p></td>&#13;
<td><p><code>170.924000</code></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Kernel Density Distribution" data-type="sect3"><div class="sect3" id="idm46691318019608">&#13;
<h3>Kernel Density Distribution</h3>&#13;
&#13;
<p><a data-primary="supervised machine learning" data-secondary="kernel density distribution" data-type="indexterm" id="idm46691318018328"/>A distribution for the density plot (<a data-type="xref" href="#Figure-14-2">Figure 14-2</a>) shows how the two variables relate to each other.<a data-startref="ix_ch14-asciidoc3" data-type="indexterm" id="idm46691318016488"/><a data-startref="ix_ch14-asciidoc2" data-type="indexterm" id="idm46691318015816"/></p>&#13;
&#13;
<p><code><strong>In[11]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">sns</code><code class="o">.</code><code class="n">jointplot</code><code class="p">(</code><code class="s2">"Height-Inches"</code><code class="p">,</code> <code class="s2">"Weight-Pounds"</code><code class="p">,</code> <code class="n">data</code><code class="o">=</code><code class="n">df</code><code class="p">,</code> <code class="n">kind</code><code class="o">=</code><code class="s2">"kde"</code><code class="p">)</code></pre>&#13;
&#13;
<p><code><strong>Out[11]:</strong></code></p>&#13;
&#13;
<figure><div class="figure" id="Figure-14-2">&#13;
<img alt="pydo 1402" src="assets/pydo_1402.png"/>&#13;
<h6><span class="label">Figure 14-2. </span>Density plot</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Modeling" data-type="sect2"><div class="sect2" id="idm46691318001048">&#13;
<h2>Modeling</h2>&#13;
&#13;
<p><a data-primary="machine learning" data-secondary="modeling" data-type="indexterm" id="ix_ch14-asciidoc4"/><a data-primary="modeling, for machine learning" data-type="indexterm" id="ix_ch14-asciidoc5"/>Now let’s review modeling. Machine learning modeling is when an algorithm learns from the data. The general idea is to use previous data to predict future data.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Sklearn Regression Model" data-type="sect3"><div class="sect3" id="idm46691317991640">&#13;
<h3>Sklearn Regression Model</h3>&#13;
&#13;
<p><a data-primary="machine learning" data-secondary="sklearn regression model" data-type="indexterm" id="idm46691317990264"/><a data-primary="modeling, for machine learning" data-secondary="sklearn regression model" data-type="indexterm" id="idm46691317989320"/>First the data is extracted into features and targets, and then it is split into a train and a test set.  This allows the test set to be held aside to test the accuracy of the trained model.</p>&#13;
&#13;
<p><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">sklearn.model_selection</code> <code class="kn">import</code> <code class="n">train_test_split</code></pre>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Extract and inspect feature and target" data-type="sect4"><div class="sect4" id="idm46691317983848">&#13;
<h4>Extract and inspect feature and target</h4>&#13;
&#13;
<p><a data-primary="modeling, for machine learning" data-secondary="extract/inspect feature and target" data-type="indexterm" id="idm46691317939672"/>It is a good idea to explicitly pull out the target and feature variables and reshape them in one cell.  Afterwards you will want to check the shape to ensure it is the property dimension for doing machine learning with sklearn.</p>&#13;
&#13;
<p><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">y</code> <code class="o">=</code> <code class="n">df</code><code class="p">[</code><code class="s1">'Weight-Pounds'</code><code class="p">]</code><code class="o">.</code><code class="n">values</code> <code class="c1">#Target</code>&#13;
<code class="n">y</code> <code class="o">=</code> <code class="n">y</code><code class="o">.</code><code class="n">reshape</code><code class="p">(</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code>&#13;
<code class="n">X</code> <code class="o">=</code> <code class="n">df</code><code class="p">[</code><code class="s1">'Height-Inches'</code><code class="p">]</code><code class="o">.</code><code class="n">values</code> <code class="c1">#Feature(s)</code>&#13;
<code class="n">X</code> <code class="o">=</code> <code class="n">X</code><code class="o">.</code><code class="n">reshape</code><code class="p">(</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code></pre>&#13;
&#13;
<p><code><strong>In[14]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">y</code><code class="o">.</code><code class="n">shape</code></pre>&#13;
&#13;
<p><code><strong>Out[14]:</strong></code></p>&#13;
&#13;
<pre data-type="programlisting">(25000, 1)</pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Split the data" data-type="sect4"><div class="sect4" id="idm46691317889384">&#13;
<h4>Split the data</h4>&#13;
&#13;
<p><a data-primary="modeling, for machine learning" data-secondary="splitting data" data-type="indexterm" id="idm46691317887976"/><a data-primary="splitting data" data-type="indexterm" id="idm46691317886584"/>The data is split into an 80%/20% split.</p>&#13;
&#13;
<p><code><strong>In[15]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">X_train</code><code class="p">,</code> <code class="n">X_test</code><code class="p">,</code> <code class="n">y_train</code><code class="p">,</code> <code class="n">y_test</code> <code class="o">=</code> <code class="n">train_test_split</code><code class="p">(</code><code class="n">X</code><code class="p">,</code> <code class="n">y</code><code class="p">,</code> <code class="n">test_size</code><code class="o">=</code><code class="mf">0.2</code><code class="p">)</code>&#13;
<code class="k">print</code><code class="p">(</code><code class="n">X_train</code><code class="o">.</code><code class="n">shape</code><code class="p">,</code> <code class="n">y_train</code><code class="o">.</code><code class="n">shape</code><code class="p">)</code>&#13;
<code class="k">print</code><code class="p">(</code><code class="n">X_test</code><code class="o">.</code><code class="n">shape</code><code class="p">,</code> <code class="n">y_test</code><code class="o">.</code><code class="n">shape</code><code class="p">)</code></pre>&#13;
&#13;
<p><code><strong>Out[15]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="p">(</code><code class="mi">20000</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code> <code class="p">(</code><code class="mi">20000</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code>&#13;
<code class="p">(</code><code class="mi">5000</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code> <code class="p">(</code><code class="mi">5000</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Fit the model" data-type="sect4"><div class="sect4" id="idm46691317733224">&#13;
<h4>Fit the model</h4>&#13;
&#13;
<p><a data-primary="fitting, of machine learning model" data-type="indexterm" id="idm46691317729192"/><a data-primary="modeling, for machine learning" data-secondary="fitting model" data-type="indexterm" id="idm46691317728520"/>Now the model is fit using a LinearRegression algorithm imported via sklearn.</p>&#13;
&#13;
<p><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">sklearn.linear_model</code> <code class="kn">import</code> <code class="n">LinearRegression</code>&#13;
<code class="n">lm</code> <code class="o">=</code> <code class="n">LinearRegression</code><code class="p">()</code>&#13;
<code class="n">model</code> <code class="o">=</code> <code class="n">lm</code><code class="o">.</code><code class="n">fit</code><code class="p">(</code><code class="n">X_train</code><code class="p">,</code> <code class="n">y_train</code><code class="p">)</code>&#13;
<code class="n">y_predicted</code> <code class="o">=</code> <code class="n">lm</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">X_test</code><code class="p">)</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Print accuracy of linear regression model" data-type="sect4"><div class="sect4" id="idm46691317769608">&#13;
<h4>Print accuracy of linear regression model</h4>&#13;
&#13;
<p><a data-primary="linear regression model, print accuracy of" data-type="indexterm" id="idm46691317704680"/><a data-primary="modeling, for machine learning" data-secondary="print accuracy of linear regression model" data-type="indexterm" id="idm46691317703944"/><a data-primary="print accuracy of linear regression model" data-type="indexterm" id="idm46691317703000"/>Now the trained model can show what the accuracy is in predicting new data.  This is performed by asking for the RMSE or root mean squared error of the predicted and the test data.</p>&#13;
&#13;
<p><code><strong>In[18]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">sklearn.metrics</code> <code class="kn">import</code> <code class="n">mean_squared_error</code>&#13;
<code class="kn">from</code> <code class="nn">math</code> <code class="kn">import</code> <code class="n">sqrt</code>&#13;
&#13;
<code class="c1">#RMSE Root Mean Squared Error</code>&#13;
<code class="n">rms</code> <code class="o">=</code> <code class="n">sqrt</code><code class="p">(</code><code class="n">mean_squared_error</code><code class="p">(</code><code class="n">y_predicted</code><code class="p">,</code> <code class="n">y_test</code><code class="p">))</code>&#13;
<code class="n">rms</code></pre>&#13;
&#13;
<p><code><strong>Out[18]:</strong></code></p>&#13;
&#13;
<pre data-type="programlisting">10.282608230082417</pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before less_space" data-pdf-bookmark="Plot predicted height versus actual height" data-type="sect4"><div class="sect4" id="idm46691317685272">&#13;
<h4>Plot predicted height versus actual height</h4>&#13;
&#13;
<p><a data-primary="modeling, for machine learning" data-secondary="plot predicted versus actual height" data-type="indexterm" id="idm46691317683656"/>Now let’s plot the predicted height versus actual height (<a data-type="xref" href="#Figure-14-3">Figure 14-3</a>) to see how well this model performs at predictions.</p>&#13;
&#13;
<p><code><strong>In[19]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">matplotlib.pyplot</code> <code class="kn">as</code> <code class="nn">plt</code>&#13;
<code class="n">_</code><code class="p">,</code> <code class="n">ax</code> <code class="o">=</code> <code class="n">plt</code><code class="o">.</code><code class="n">subplots</code><code class="p">()</code>&#13;
&#13;
<code class="n">ax</code><code class="o">.</code><code class="n">scatter</code><code class="p">(</code><code class="n">x</code> <code class="o">=</code> <code class="nb">range</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="n">y_test</code><code class="o">.</code><code class="n">size</code><code class="p">),</code> <code class="n">y</code><code class="o">=</code><code class="n">y_test</code><code class="p">,</code> <code class="n">c</code> <code class="o">=</code> <code class="s1">'blue'</code><code class="p">,</code> <code class="n">label</code> <code class="o">=</code> <code class="s1">'Actual'</code><code class="p">,</code>&#13;
  <code class="n">alpha</code> <code class="o">=</code> <code class="mf">0.5</code><code class="p">)</code>&#13;
<code class="n">ax</code><code class="o">.</code><code class="n">scatter</code><code class="p">(</code><code class="n">x</code> <code class="o">=</code> <code class="nb">range</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="n">y_predicted</code><code class="o">.</code><code class="n">size</code><code class="p">),</code> <code class="n">y</code><code class="o">=</code><code class="n">y_predicted</code><code class="p">,</code> <code class="n">c</code> <code class="o">=</code> <code class="s1">'red'</code><code class="p">,</code>&#13;
  <code class="n">label</code> <code class="o">=</code> <code class="s1">'Predicted'</code><code class="p">,</code> <code class="n">alpha</code> <code class="o">=</code> <code class="mf">0.5</code><code class="p">)</code>&#13;
&#13;
<code class="n">plt</code><code class="o">.</code><code class="n">title</code><code class="p">(</code><code class="s1">'Actual Height vs Predicted Height'</code><code class="p">)</code>&#13;
<code class="n">plt</code><code class="o">.</code><code class="n">xlabel</code><code class="p">(</code><code class="s1">'Weight'</code><code class="p">)</code>&#13;
<code class="n">plt</code><code class="o">.</code><code class="n">ylabel</code><code class="p">(</code><code class="s1">'Height'</code><code class="p">)</code>&#13;
<code class="n">plt</code><code class="o">.</code><code class="n">legend</code><code class="p">()</code>&#13;
<code class="n">plt</code><code class="o">.</code><code class="n">show</code><code class="p">()</code></pre>&#13;
&#13;
<figure><div class="figure" id="Figure-14-3">&#13;
<img alt="pydo 1403" src="assets/pydo_1403.png"/>&#13;
<h6><span class="label">Figure 14-3. </span>Predicted height versus actual height</h6>&#13;
</div></figure>&#13;
&#13;
<p>This is a very simple yet powerful example of a realistic workflow for creating a machine learning model<a data-startref="ix_ch14-asciidoc5" data-type="indexterm" id="idm46691317497352"/><a data-startref="ix_ch14-asciidoc4" data-type="indexterm" id="idm46691317496648"/>.<a data-startref="ix_ch14-asciidoc1" data-type="indexterm" id="idm46691317495848"/></p>&#13;
</div></section>&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Python Machine learning Ecosystem" data-type="sect1"><div class="sect1" id="idm46691317494760">&#13;
<h1>Python Machine learning Ecosystem</h1>&#13;
&#13;
<p><a data-primary="machine learning" data-secondary="Python machine learning ecosystem" data-type="indexterm" id="ix_ch14-asciidoc6"/>Let’s take a quick look at the Python machine learning ecosystem (<a data-type="xref" href="#Figure-14-4">Figure 14-4</a>).</p>&#13;
&#13;
<p>There are really four main areas:  deep learning, sklearn, AutoML, and Spark.  In the area of deep learning, the most popular frameworks in order are:  TensorFlow/Keras, PyTorch, and MXNet.  Google is sponsoring TensorFlow, Facebook is sponsoring PyTorch, and MXNet comes from Amazon.  You will see MXNet mentioned quite a bit by Amazon SageMaker.  It is important to note that these deep learning frameworks target GPUs, giving them performance boosts over CPU targets of up to 50X.</p>&#13;
&#13;
<figure><div class="figure" id="Figure-14-4">&#13;
<img alt="pydo 1404" src="assets/pydo_1404.png"/>&#13;
<h6><span class="label">Figure 14-4. </span>Python machine learning ecosystem</h6>&#13;
</div></figure>&#13;
&#13;
<p>The sklearn ecosystem often has Pandas and Numpy in the same projects.  Sklearn also intentionally does not target GPUs. However, there is a project called Numba that does specifically target the GPU (both NVIDIA and AMD).</p>&#13;
&#13;
<p>In AutoML, two of the leaders are Uber with Ludwig and H20, with H20 AutoML. Both can save significant time developing machine learning models and can also potentially optimize existing machine learning models.</p>&#13;
&#13;
<p>Finally, there is the Spark ecosystem, which builds on the legacy of Hadoop.  Spark can target GPUs and CPUs and does so via many different platforms:  Amazon EMR, Databricks, GCP Dataproc, and more.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Deep Learning with PyTorch" data-type="sect2"><div class="sect2" id="idm46691317486312">&#13;
<h2>Deep Learning with PyTorch</h2>&#13;
&#13;
<p><a data-primary="deep learning" data-secondary="PyTorch" data-type="indexterm" id="ix_ch14-asciidoc7"/><a data-primary="machine learning" data-secondary="deep learning with PyTorch" data-type="indexterm" id="ix_ch14-asciidoc8"/><a data-primary="PyTorch" data-secondary="deep learning" data-type="indexterm" id="ix_ch14-asciidoc9"/>Now that the ecosystem for machine learning with Python has been defined, let’s take a look at porting the simple linear regression example to PyTorch and run it on a CUDA GPU. One easy way to get access to an NVIDIA GPU is to use Colab notebooks. Colab notebooks are Google-hosted, Jupyter-compatible notebooks that give the user free access to both GPUs and tensor processing units (TPUs). You can run this code <a href="https://oreil.ly/kQhKO">in a GPU</a>.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Regression with PyTorch" data-type="sect3"><div class="sect3" id="idm46691317480104">&#13;
<h3>Regression with PyTorch</h3>&#13;
&#13;
<p><a data-primary="PyTorch" data-secondary="regression" data-type="indexterm" id="idm46691317478152"/>First, convert data to <code>float32</code>.</p>&#13;
&#13;
<p><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1"># Training Data</code>&#13;
<code class="n">x_train</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">array</code><code class="p">(</code><code class="n">X_train</code><code class="p">,</code> <code class="n">dtype</code><code class="o">=</code><code class="n">np</code><code class="o">.</code><code class="n">float32</code><code class="p">)</code>&#13;
<code class="n">x_train</code> <code class="o">=</code> <code class="n">x_train</code><code class="o">.</code><code class="n">reshape</code><code class="p">(</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code>&#13;
<code class="n">y_train</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">array</code><code class="p">(</code><code class="n">y_train</code><code class="p">,</code> <code class="n">dtype</code><code class="o">=</code><code class="n">np</code><code class="o">.</code><code class="n">float32</code><code class="p">)</code>&#13;
<code class="n">y_train</code> <code class="o">=</code> <code class="n">y_train</code><code class="o">.</code><code class="n">reshape</code><code class="p">(</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code>&#13;
&#13;
<code class="c1"># Test Data</code>&#13;
<code class="n">x_test</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">array</code><code class="p">(</code><code class="n">X_test</code><code class="p">,</code> <code class="n">dtype</code><code class="o">=</code><code class="n">np</code><code class="o">.</code><code class="n">float32</code><code class="p">)</code>&#13;
<code class="n">x_test</code> <code class="o">=</code> <code class="n">x_test</code><code class="o">.</code><code class="n">reshape</code><code class="p">(</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code>&#13;
<code class="n">y_test</code> <code class="o">=</code> <code class="n">np</code><code class="o">.</code><code class="n">array</code><code class="p">(</code><code class="n">y_test</code><code class="p">,</code> <code class="n">dtype</code><code class="o">=</code><code class="n">np</code><code class="o">.</code><code class="n">float32</code><code class="p">)</code>&#13;
<code class="n">y_test</code> <code class="o">=</code> <code class="n">y_test</code><code class="o">.</code><code class="n">reshape</code><code class="p">(</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code></pre>&#13;
&#13;
<p>Note that if you are not using Colab notebooks, you may have to install PyTorch.  Also, if you use Colab notebooks, you can have an NVIDIA GPU and run this code.  If you are not using Colab, you will need to run on a platform that has a GPU.</p>&#13;
&#13;
<p><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">torch</code>&#13;
<code class="kn">from</code> <code class="nn">torch.autograd</code> <code class="kn">import</code> <code class="n">Variable</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">linearRegression</code><code class="p">(</code><code class="n">torch</code><code class="o">.</code><code class="n">nn</code><code class="o">.</code><code class="n">Module</code><code class="p">):</code>&#13;
    <code class="k">def</code> <code class="nf-Magic">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">inputSize</code><code class="p">,</code> <code class="n">outputSize</code><code class="p">):</code>&#13;
        <code class="nb">super</code><code class="p">(</code><code class="n">linearRegression</code><code class="p">,</code> <code class="bp">self</code><code class="p">)</code><code class="o">.</code><code class="nf-Magic">__init__</code><code class="p">()</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">linear</code> <code class="o">=</code> <code class="n">torch</code><code class="o">.</code><code class="n">nn</code><code class="o">.</code><code class="n">Linear</code><code class="p">(</code><code class="n">inputSize</code><code class="p">,</code> <code class="n">outputSize</code><code class="p">)</code>&#13;
&#13;
    <code class="k">def</code> <code class="nf">forward</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">x</code><code class="p">):</code>&#13;
        <code class="n">out</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">linear</code><code class="p">(</code><code class="n">x</code><code class="p">)</code>&#13;
        <code class="k">return</code> <code class="n">out</code></pre>&#13;
&#13;
<p>Now create a model with CUDA enabled (assuming you are running in Colab or on a machine with an NVIDIA GPU).</p>&#13;
&#13;
<p class="pagebreak-before"><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">inputDim</code> <code class="o">=</code> <code class="mi">1</code>        <code class="c1"># takes variable 'x'</code>&#13;
<code class="n">outputDim</code> <code class="o">=</code> <code class="mi">1</code>       <code class="c1"># takes variable 'y'</code>&#13;
<code class="n">learningRate</code> <code class="o">=</code> <code class="mf">0.0001</code>&#13;
<code class="n">epochs</code> <code class="o">=</code> <code class="mi">1000</code>&#13;
&#13;
<code class="n">model</code> <code class="o">=</code> <code class="n">linearRegression</code><code class="p">(</code><code class="n">inputDim</code><code class="p">,</code> <code class="n">outputDim</code><code class="p">)</code>&#13;
<code class="n">model</code><code class="o">.</code><code class="n">cuda</code><code class="p">()</code></pre>&#13;
&#13;
<p><code><strong>Out[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">linearRegression</code><code class="p">(</code>&#13;
  <code class="p">(</code><code class="n">linear</code><code class="p">):</code> <code class="n">Linear</code><code class="p">(</code><code class="n">in_features</code><code class="o">=</code><code class="mi">1</code><code class="p">,</code> <code class="n">out_features</code><code class="o">=</code><code class="mi">1</code><code class="p">,</code> <code class="n">bias</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>&#13;
<code class="p">)</code></pre>&#13;
&#13;
<p>Create the Stochastic Gradient Descent and Loss Function.</p>&#13;
&#13;
<p><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">criterion</code> <code class="o">=</code> <code class="n">torch</code><code class="o">.</code><code class="n">nn</code><code class="o">.</code><code class="n">MSELoss</code><code class="p">()</code>&#13;
<code class="n">optimizer</code> <code class="o">=</code> <code class="n">torch</code><code class="o">.</code><code class="n">optim</code><code class="o">.</code><code class="n">SGD</code><code class="p">(</code><code class="n">model</code><code class="o">.</code><code class="n">parameters</code><code class="p">(),</code> <code class="n">lr</code><code class="o">=</code><code class="n">learningRate</code><code class="p">)</code></pre>&#13;
&#13;
<p>Now train the model.</p>&#13;
&#13;
<p><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="k">for</code> <code class="n">epoch</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">epochs</code><code class="p">):</code>&#13;
    <code class="n">inputs</code> <code class="o">=</code> <code class="n">Variable</code><code class="p">(</code><code class="n">torch</code><code class="o">.</code><code class="n">from_numpy</code><code class="p">(</code><code class="n">x_train</code><code class="p">)</code><code class="o">.</code><code class="n">cuda</code><code class="p">())</code>&#13;
    <code class="n">labels</code> <code class="o">=</code> <code class="n">Variable</code><code class="p">(</code><code class="n">torch</code><code class="o">.</code><code class="n">from_numpy</code><code class="p">(</code><code class="n">y_train</code><code class="p">)</code><code class="o">.</code><code class="n">cuda</code><code class="p">())</code>&#13;
    <code class="n">optimizer</code><code class="o">.</code><code class="n">zero_grad</code><code class="p">()</code>&#13;
    <code class="n">outputs</code> <code class="o">=</code> <code class="n">model</code><code class="p">(</code><code class="n">inputs</code><code class="p">)</code>&#13;
    <code class="n">loss</code> <code class="o">=</code> <code class="n">criterion</code><code class="p">(</code><code class="n">outputs</code><code class="p">,</code> <code class="n">labels</code><code class="p">)</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">loss</code><code class="p">)</code>&#13;
    <code class="c1"># get gradients w.r.t to parameters</code>&#13;
    <code class="n">loss</code><code class="o">.</code><code class="n">backward</code><code class="p">()</code>&#13;
    <code class="c1"># update parameters</code>&#13;
    <code class="n">optimizer</code><code class="o">.</code><code class="n">step</code><code class="p">()</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="s1">'epoch {}, loss {}'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">epoch</code><code class="p">,</code> <code class="n">loss</code><code class="o">.</code><code class="n">item</code><code class="p">()))</code></pre>&#13;
&#13;
<p>The output over 1,000 runs is supressed to save space.</p>&#13;
&#13;
<p><code><strong>Out[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">tensor</code><code class="p">(</code><code class="mf">29221.6543</code><code class="p">,</code> <code class="n">device</code><code class="o">=</code><code class="s1">'cuda:0'</code><code class="p">,</code> <code class="n">grad_fn</code><code class="o">=&lt;</code><code class="n">MseLossBackward</code><code class="o">&gt;</code><code class="p">)</code>&#13;
<code class="n">epoch</code> <code class="mi">0</code><code class="p">,</code> <code class="n">loss</code> <code class="mf">29221.654296875</code>&#13;
<code class="n">tensor</code><code class="p">(</code><code class="mf">266.7252</code><code class="p">,</code> <code class="n">device</code><code class="o">=</code><code class="s1">'cuda:0'</code><code class="p">,</code> <code class="n">grad_fn</code><code class="o">=&lt;</code><code class="n">MseLossBackward</code><code class="o">&gt;</code><code class="p">)</code>&#13;
<code class="n">epoch</code> <code class="mi">1</code><code class="p">,</code> <code class="n">loss</code> <code class="mf">266.72515869140625</code>&#13;
<code class="n">tensor</code><code class="p">(</code><code class="mf">106.6842</code><code class="p">,</code> <code class="n">device</code><code class="o">=</code><code class="s1">'cuda:0'</code><code class="p">,</code> <code class="n">grad_fn</code><code class="o">=&lt;</code><code class="n">MseLossBackward</code><code class="o">&gt;</code><code class="p">)</code>&#13;
<code class="n">epoch</code> <code class="mi">2</code><code class="p">,</code> <code class="n">loss</code> <code class="mf">106.6842269897461</code>&#13;
<code class="o">....</code><code class="n">output</code> <code class="n">suppressed</code><code class="o">....</code>&#13;
<code class="n">epoch</code> <code class="mi">998</code><code class="p">,</code> <code class="n">loss</code> <code class="mf">105.7930908203125</code>&#13;
<code class="n">tensor</code><code class="p">(</code><code class="mf">105.7931</code><code class="p">,</code> <code class="n">device</code><code class="o">=</code><code class="s1">'cuda:0'</code><code class="p">,</code> <code class="n">grad_fn</code><code class="o">=&lt;</code><code class="n">MseLossBackward</code><code class="o">&gt;</code><code class="p">)</code>&#13;
<code class="n">epoch</code> <code class="mi">999</code><code class="p">,</code> <code class="n">loss</code> <code class="mf">105.7930908203125</code></pre>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Plot predicted height versus actual height" data-type="sect4"><div class="sect4" id="idm46691316955160">&#13;
<h4>Plot predicted height versus actual height</h4>&#13;
&#13;
<p><a data-primary="PyTorch" data-secondary="plot predicted versus actual height" data-type="indexterm" id="idm46691316839352"/>Now let’s plot the predicted height versus actual height (<a data-type="xref" href="#Figure-14-5">Figure 14-5</a>) as in the simple model.</p>&#13;
&#13;
<p><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="k">with</code> <code class="n">torch</code><code class="o">.</code><code class="n">no_grad</code><code class="p">():</code>&#13;
    <code class="n">predicted</code> <code class="o">=</code> <code class="n">model</code><code class="p">(</code><code class="n">Variable</code><code class="p">(</code><code class="n">torch</code><code class="o">.</code><code class="n">from_numpy</code><code class="p">(</code><code class="n">x_test</code><code class="p">)</code><code class="o">.</code><code class="n">cuda</code><code class="p">()))</code><code class="o">.</code><code class="n">cpu</code><code class="p">()</code><code class="o">.</code>\&#13;
      <code class="n">data</code><code class="o">.</code><code class="n">numpy</code><code class="p">()</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">predicted</code><code class="p">)</code>&#13;
&#13;
<code class="n">plt</code><code class="o">.</code><code class="n">clf</code><code class="p">()</code>&#13;
<code class="n">plt</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">x_test</code><code class="p">,</code> <code class="n">y_test</code><code class="p">,</code> <code class="s1">'go'</code><code class="p">,</code> <code class="n">label</code><code class="o">=</code><code class="s1">'Actual Height'</code><code class="p">,</code> <code class="n">alpha</code><code class="o">=</code><code class="mf">0.5</code><code class="p">)</code>&#13;
<code class="n">plt</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">x_test</code><code class="p">,</code> <code class="n">predicted</code><code class="p">,</code> <code class="s1">'--'</code><code class="p">,</code> <code class="n">label</code><code class="o">=</code><code class="s1">'Predicted Height'</code><code class="p">,</code> <code class="n">alpha</code><code class="o">=</code><code class="mf">0.5</code><code class="p">)</code>&#13;
<code class="n">plt</code><code class="o">.</code><code class="n">legend</code><code class="p">(</code><code class="n">loc</code><code class="o">=</code><code class="s1">'best'</code><code class="p">)</code>&#13;
<code class="n">plt</code><code class="o">.</code><code class="n">show</code><code class="p">()</code></pre>&#13;
&#13;
<figure><div class="figure" id="Figure-14-5">&#13;
<img alt="pydo 1405" src="assets/pydo_1405.png"/>&#13;
<h6><span class="label">Figure 14-5. </span>Predicted height versus actual height</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Print RMSE" data-type="sect4"><div class="sect4" id="idm46691316714536">&#13;
<h4>Print RMSE</h4>&#13;
&#13;
<p><a data-primary="PyTorch" data-secondary="print RMSE" data-type="indexterm" id="idm46691316713064"/>Finally, let’s print out the RMSE and compare.</p>&#13;
&#13;
<p><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1">#RMSE Root Mean Squared Error</code>&#13;
<code class="n">rms</code> <code class="o">=</code> <code class="n">sqrt</code><code class="p">(</code><code class="n">mean_squared_error</code><code class="p">(</code><code class="n">x_test</code><code class="p">,</code> <code class="n">predicted</code><code class="p">))</code>&#13;
<code class="n">rms</code></pre>&#13;
&#13;
<p><code><strong>Out[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="mf">59.19054613663507</code></pre>&#13;
&#13;
<p>It does take a little more code to do deep learning, but the concepts are the same from the sklearn model.  The big takeaway here is that GPUs are becoming an integral part of production pipelines.  Even if you aren’t doing deep learning yourself, it is helpful to have a basic awareness of the process of building GPU-based machine learning models<a data-startref="ix_ch14-asciidoc9" data-type="indexterm" id="idm46691316638520"/><a data-startref="ix_ch14-asciidoc8" data-type="indexterm" id="idm46691316637912"/><a data-startref="ix_ch14-asciidoc7" data-type="indexterm" id="idm46691316643608"/>.<a data-startref="ix_ch14-asciidoc6" data-type="indexterm" id="idm46691316642920"/></p>&#13;
</div></section>&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Cloud Machine learning Platforms" data-type="sect1"><div class="sect1" id="idm46691317479000">&#13;
<h1>Cloud Machine learning Platforms</h1>&#13;
&#13;
<p><a data-primary="cloud computing" data-secondary="machine learning platforms" data-type="indexterm" id="idm46691316641176"/><a data-primary="machine learning" data-secondary="cloud machine learning platforms" data-type="indexterm" id="idm46691316640232"/>One aspect of machine learning that is becoming ubiquitious is cloud-based machine learning platforms.  Google offers the GCP AI Platform (<a data-type="xref" href="#Figure-14-6">Figure 14-6</a>).</p>&#13;
&#13;
<figure><div class="figure" id="Figure-14-6">&#13;
<img alt="pydo 1406" src="assets/pydo_1406.png"/>&#13;
<h6><span class="label">Figure 14-6. </span>GCP AI platform</h6>&#13;
</div></figure>&#13;
&#13;
<p>The GCP platform has many high-level automation components, from data preparation to data labeling. The AWS platform offers <a data-primary="AWS (Amazon Web Services)" data-secondary="Sagemaker" data-type="indexterm" id="idm46691316653320"/>Amazon SageMaker (<a data-type="xref" href="#Figure-14-7">Figure 14-7</a>).</p>&#13;
&#13;
<figure><div class="figure" id="Figure-14-7">&#13;
<img alt="pydo 1407" src="assets/pydo_1407.png"/>&#13;
<h6><span class="label">Figure 14-7. </span>Amazon SageMaker</h6>&#13;
</div></figure>&#13;
&#13;
<p>SageMaker also has many high-level components, including training on spot instances and elastic prediction endpoints.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Machine learning Maturity Model" data-type="sect1"><div class="sect1" id="idm46691316648680">&#13;
<h1>Machine learning Maturity Model</h1>&#13;
&#13;
<p><a data-primary="machine learning" data-secondary="maturity model" data-type="indexterm" id="ix_ch14-asciidoc10"/><a data-primary="maturity model, for machine learning" data-type="indexterm" id="ix_ch14-asciidoc11"/>One of the big challenges right now is a realization that transformational change is needed in companies that want to perform machine learning.  The machine learning maturity model diagram (<a data-type="xref" href="#Figure-14-8">Figure 14-8</a>) represents some challenges and opportunities.</p>&#13;
&#13;
<figure><div class="figure" id="Figure-14-8">&#13;
<img alt="pydo 1408" src="assets/pydo_1408.png"/>&#13;
<h6><span class="label">Figure 14-8. </span>Machine learning maturity model</h6>&#13;
</div></figure>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Machine Learning Key Terminology" data-type="sect2"><div class="sect2" id="idm46691316691912">&#13;
<h2>Machine Learning Key Terminology</h2>&#13;
&#13;
<p><a data-primary="machine learning" data-secondary="key terminology" data-type="indexterm" id="idm46691316690744"/><a data-primary="maturity model, for machine learning" data-secondary="key terminology" data-type="indexterm" id="idm46691316689768"/>Let’s define some key machine learning terminology that will be helpful througout the rest of the chapter:</p>&#13;
<dl>&#13;
<dt>Machine learning</dt>&#13;
<dd>&#13;
<p><a data-primary="machine learning" data-secondary="defining" data-type="indexterm" id="idm46691316686424"/>A way of building mathmatical models based on sample or training data.</p>&#13;
</dd>&#13;
<dt>Model</dt>&#13;
<dd>&#13;
<p><a data-primary="modeling, for machine learning" data-secondary="defined" data-type="indexterm" id="idm46691316684168"/>This is what the product is in a machine learning application.  A simple example is a linear equation, i.e., a straight line that predicts the relationship between an X and a Y.</p>&#13;
</dd>&#13;
<dt>Feature</dt>&#13;
<dd>&#13;
<p><a data-primary="feature, defined" data-type="indexterm" id="idm46691316595608"/>A feature is a column in a spreadsheet that is used as a signal to create a machine learning model.  A good example is points scored per game by an NBA team.</p>&#13;
</dd>&#13;
<dt>Target</dt>&#13;
<dd>&#13;
<p><a data-primary="target, defined" data-type="indexterm" id="idm46691316593672"/>The target is the column in a spreadsheet you are trying to predict.  A good example is how many games an NBA team wins in a season.</p>&#13;
</dd>&#13;
<dt>Supersized machine learning</dt>&#13;
<dd>&#13;
<p><a data-primary="supervised machine learning" data-secondary="defined" data-type="indexterm" id="idm46691316591768"/>This is a type of machine learning that predicts future values based on known correct historical values.  A good example would be predicting the amount of NBA wins in a season by using the feature points per game.</p>&#13;
</dd>&#13;
<dt>Unsupervised machine learning</dt>&#13;
<dd>&#13;
<p><a data-primary="unsupervised machine learning" data-type="indexterm" id="idm46691316589352"/>This is a type of machine learning that works with unlabeled data.  Instead of predicting a future value, it finds hidden patterns by using tools such as clustering, which in turn could be used as labels.  A good example would be to create clusters of NBA players that have similar points, rebounds, blocks, and assists.  One cluster could be called “Tall, Top Players,” and another cluster could be called “Point guards who score a lot of points.”</p>&#13;
</dd>&#13;
<dt>Deep learning</dt>&#13;
<dd>&#13;
<p><a data-primary="deep learning" data-secondary="defined" data-type="indexterm" id="idm46691316586872"/>This is a type of machine learning that uses artificial neural networks that can be used for  supervised or unsupervised machine learning.  The most popular framework for deep learning is TensorFlow from Google.</p>&#13;
</dd>&#13;
<dt>Scikit-learn</dt>&#13;
<dd>&#13;
<p><a data-primary="Scikit-Learn" data-type="indexterm" id="idm46691316584392"/>This is one of the most popular machine learning frameworks in Python.</p>&#13;
</dd>&#13;
<dt>Pandas</dt>&#13;
<dd>&#13;
<p><a data-primary="Pandas package" data-secondary="about" data-type="indexterm" id="idm46691316582408"/>This is one of the most popular libraries for doing data manipulation and analysis.  It works well with scikit-learn and Numpy.</p>&#13;
</dd>&#13;
<dt>Numpy</dt>&#13;
<dd>&#13;
<p><a data-primary="Numpy" data-type="indexterm" id="idm46691316580008"/>This is the predominant Python library for doing low-level scientific computing.  It has support for a large, multidimensional array and has a large collection of high-level mathmatical functions.  It is used extensively with scikit-learn, Pandas, and TensorFlow.</p>&#13;
</dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Level 1:  Framing, Scope Identification, and Problem Definition" data-type="sect2"><div class="sect2" id="idm46691316687336">&#13;
<h2>Level 1:  Framing, Scope Identification, and Problem Definition</h2>&#13;
&#13;
<p><a data-primary="maturity model, for machine learning" data-secondary="level 1: framing, scope identification, and problem definition" data-type="indexterm" id="idm46691316577912"/>Let’s look at the first layer.  When implementing machine learning at a company, it is important to consider what problems need solving and how they can be framed.  One of the key reasons for failure of machine learning projects is that organizations haven’t first asked questions about what problems they need solved.</p>&#13;
&#13;
<p>A good analogy to look at is building a mobile application for a restaurant chain in San Francisco. One naive approach would be to immediately start building a native iOS and a native Android app (using two development teams).  A typical mobile team could be three full-time developers for each application.  So this means hiring six developers at around two hundred thousand dollars each. The run rate for the project is about $1.2 million a year now.  Will the mobile app deliver greater than $1.2 million in revenue each year?  If not, is there an easier alternative? Perhaps a mobile-optimized web app that uses the existing web developers in the company is a better choice.</p>&#13;
&#13;
<p>What about partnering with a company that specializes in food delivery and outsourcing this task completely?  What are the pros and cons to this approach?  The same type of thought process can and should be applied to machine learning and data science initiatives.  For example, does your company need to hire six PhD-level machine learning researchers at, say, five hundred thousand dollars a year?  What is the alternative?  A little bit of scoping and problem definition goes a long way with machine learning and can ensure a higher chance of success.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Level 2:  Continuous Delivery of Data" data-type="sect2"><div class="sect2" id="idm46691316574168">&#13;
<h2>Level 2:  Continuous Delivery of Data</h2>&#13;
&#13;
<p><a data-primary="maturity model, for machine learning" data-secondary="level 2: continuous delivery of data" data-type="indexterm" id="idm46691316572824"/>One of the fundamentals of civilization is running water.  Roman aqueducts carried water for miles to provide crowded cities with water as early as 312 B.C.  Running water enabled the infrastructure necessary for a large city to succeed.  It is estimated by UNICEF that worldwide in 2018, women and girls spend an estimated two hundred million hours daily, collecting water.  The opportunity cost is substantial; less time to spend learning, taking care of children, working, or relaxing.</p>&#13;
&#13;
<p>A popular expression is that “software is eating the world.”  A corollary to that is that all software companies, which is every company in the future, need to have a machine learning and AI strategy.  Part of that strategy is to think more seriously about continuous delivery of data.  Just like running water, “running data” saves you hours per day. One potential solution is the concept of a <em>data lake</em>, as shown in <a data-type="xref" href="#Figure-14-9">Figure 14-9</a>.</p>&#13;
&#13;
<figure><div class="figure" id="Figure-14-9">&#13;
<img alt="pydo 1409" src="assets/pydo_1409.png"/>&#13;
<h6><span class="label">Figure 14-9. </span>AWS data lake</h6>&#13;
</div></figure>&#13;
&#13;
<p class="pagebreak-before">At first glance, a data lake might seem like a solution in search of a problem, or too simple to do anything useful.  Let’s look at some of the problems it solves, though:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>You can process the data without moving it.</p>&#13;
</li>&#13;
<li>&#13;
<p>It is cheap to store data.</p>&#13;
</li>&#13;
<li>&#13;
<p>It is straightforward to create life cycle policies to archive the data.</p>&#13;
</li>&#13;
<li>&#13;
<p>It is straightforward to create life cycle policies that secure and audit the data.</p>&#13;
</li>&#13;
<li>&#13;
<p>The production systems are decoupled from data processing.</p>&#13;
</li>&#13;
<li>&#13;
<p>It can have almost infinite and elastic storage and disk I/O.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The alternative to this architecture is often an ad hoc mess equivalent to walking four hours  to a well and back simply to get some water.  Security is also a major factor in a data lake architecture, just as security is in the water supply.  By centralizing the architecture of data storage and delivery, preventing and monitoring data breaches becomes more straightforward. Here are a few ideas that may be helpful in preventing future data breaches:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Is your data encrypted at rest?  If so, who has the keys?  Are decryption events logged and audited?</p>&#13;
</li>&#13;
<li>&#13;
<p>Is your data moving out of your network logged and audited?  For example, when is it ever a good idea for your entire customer database to move outside of your network?  Why isn’t this monitored and audited?</p>&#13;
</li>&#13;
<li>&#13;
<p>Do you have periodic data security audits?  Why not?</p>&#13;
</li>&#13;
<li>&#13;
<p>Are you storing personally identifiable information (PII)?  Why?</p>&#13;
</li>&#13;
<li>&#13;
<p>You have monitoring for critical production events. Are you monitoring data security events? Why not?</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Why would we ever let data flow outside of the internal network? What if we designed critical data to be a literal square peg that couldn’t be transmitted outside of the host network without something like a nuclear launch code? Making it impossible to move data out of the environment does seem like a viable way to prevent these breaches.  What if the external network itself could only transport “round peg” packets?  Also, this could be a great “lock-in” feature for clouds providing this type of secure data lake.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Level 3:  Continuous Delivery of Clean Data" data-type="sect2"><div class="sect2" id="idm46691316552984">&#13;
<h2>Level 3:  Continuous Delivery of Clean Data</h2>&#13;
&#13;
<p><a data-primary="maturity model, for machine learning" data-secondary="level 3: continuous delivery of clean data" data-type="indexterm" id="ix_ch14-asciidoc12"/>Hopefully you are sold on the idea behind continuous delivery of data and how important it is to the success of a company’s plans for doing machine learning.  One huge improvement to continuous delivery of data is continuous delivery of clean data.  Why go through all of the trouble of delivering data that is a mess?  The recent problem of contaminated water in Flint, Michigan, comes to mind.  Around 2014, Flint changed its water source from Lake Huron and the Detroit River to the Flint River.  Officials failed to apply corrosion inhibitors, which allowed lead from aging pipes leak into the water supply.  It is also possible that the water change caused an outbreak of Legionnaires’ disease that killed 12 people and sickened another 87.</p>&#13;
&#13;
<p>One of the earliest success stories of data science involves dirty water from 1849–1854.  John Snow was able to use data visualization to identify clusters of cholera cases (<a data-type="xref" href="#Figure-14-10">Figure 14-10</a>).  This led to the discovery of the root cause of the outbreak. Sewage was being pumped directly into the drinking water supply!</p>&#13;
&#13;
<figure><div class="figure" id="Figure-14-10">&#13;
<img alt="pydo 1410" src="assets/pydo_1410.png"/>&#13;
<h6><span class="label">Figure 14-10. </span>Clusters of cholera cases</h6>&#13;
</div></figure>&#13;
&#13;
<p class="pagebreak-before">Consider the following observations:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Why isn’t data automatically processed to “clean” it?</p>&#13;
</li>&#13;
<li>&#13;
<p>Can you visualize parts of your data pipeline that have “sewage” in them?</p>&#13;
</li>&#13;
<li>&#13;
<p>How much time is your company spending on data-cleaning tasks that are 100% automatible?<a data-startref="ix_ch14-asciidoc12" data-type="indexterm" id="idm46691316542216"/></p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Level 4: Continuous Delivery of Exploratory Data Analysis" data-type="sect2"><div class="sect2" id="idm46691316541128">&#13;
<h2>Level 4: Continuous Delivery of Exploratory Data Analysis</h2>&#13;
&#13;
<p><a data-primary="EDA (Exploratory Data Analysis)" data-secondary="continuous delivery" data-type="indexterm" id="idm46691316539704"/><a data-primary="maturity model, for machine learning" data-secondary="level 4: continuous delivery of EDA" data-type="indexterm" id="idm46691316538760"/>If your only view of data science is Kaggle projects, it may seem like the whole point of data science is to generate the most accurate prediction possible.  There is more to data science and machine learning than just making predictions.  Data science is a multidisciplinary field and there are a few ways to look at it.&#13;
e&#13;
One perspective is to focus on causality.  What are the underlying features that drive the model?  Can you explain how the model is coming to the prediction it has generated?  Several Python libraries help in this regard:  ELI5, SHAP, and LIME. They all work to help explain what machine learning models are really doing.</p>&#13;
&#13;
<p>A prediction world view cares less about how you got to the answer, and more about whether the prediction is accurate.  In a cloud-native, Big Data world, this approach has merits.  Certain machine learning problems do very well with large quantities of data, such as image recognition using deep learning.  The more data and the more computational power you have, the better your prediction accuracy will be.</p>&#13;
&#13;
<p>Is what you created in production?  Why not?  If you are building machine learning models and they don’t get used, then why are you building machine learning models?</p>&#13;
&#13;
<p>What don’t you know?  What can you learn by looking at data?  Often data science is more interested in the process than the outcome.  If you are only looking for a prediction, then you may miss out on a completely different angle to the data.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Level 5:  Continuous Delivery of Traditional ML and AutoML" data-type="sect2"><div class="sect2" id="idm46691316534840">&#13;
<h2>Level 5:  Continuous Delivery of Traditional ML and AutoML</h2>&#13;
&#13;
<p><a data-primary="AutoML" data-type="indexterm" id="idm46691316533416"/><a data-primary="maturity model, for machine learning" data-secondary="level 5: continuous delivery of traditional ML and AutoML" data-type="indexterm" id="idm46691316532712"/><a data-primary="traditional machine learning, continuous delivery of" data-type="indexterm" id="idm46691316531752"/>Fighting automation is as old as human history.  The Luddite movement was a secret organization of English textile workers who destroyed textile machinary as a form of protest from 1811 to 1816.  Ultimately, protesters were shot, the rebellion was put down with legal and military might, and the path of progress kept going.</p>&#13;
&#13;
<p>If you look at the history of humanity, tools that automate tasks that humans once did are constantly being developed.  In technological unemployment, lower-skilled workers are displaced and higher-skilled workers get an increased salary.  A case in point is the systems administrator versus the DevOps professional.  Yes, some systems administrators lost their jobs, for example, workers focused on tasks such as changing hard drives out of data centers, but new, higher-paying jobs such as cloud architects appeared.</p>&#13;
&#13;
<p>It isn’t unusual to see job postings for machine learning and data science that command an annual salary of between three hundred thousand and one million dollars.  Additionally these jobs often include many components that are essentially business rules:  tweaking hyperparameters, removing null values, and distributing jobs to a cluster.  The automator’s law (something I came up with) says, “If you talk about something being automated, it will eventually be automated.”  There is a lot of talk around AutoML, so it is inevitable that large parts of machine learning will be <span class="keep-together">automated.</span></p>&#13;
&#13;
<p>This will mean that, just like other automation examples, the nature of jobs will change.  Some jobs will become even more skilled  (imagine a person who can train thousands of machine learning models a day), and some jobs will become automated because a machine can do them much better (jobs that involve tweaking values in a JSON data structure, i.e., tuning hyperparameters).</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Level 6: ML Operational Feedback Loop" data-type="sect2"><div class="sect2" id="idm46691316527144">&#13;
<h2>Level 6: ML Operational Feedback Loop</h2>&#13;
&#13;
<p><a data-primary="maturity model, for machine learning" data-secondary="level 6: ML operational feedback loop" data-type="indexterm" id="idm46691316525800"/><a data-primary="operational feedback loop" data-type="indexterm" id="idm46691316524792"/>Why develop a mobile application?  Presumably to have users on a mobile device use your application.  What about machine learning?  The point of machine learning, especially in comparison to data science or statistics, is to create a model and predict something.  If the model isn’t in production, then what is it doing?</p>&#13;
&#13;
<p>Additionally, pushing the model to production is an opportunity to learn more.  Does the model predict accurately when put into an environment where it gets new data?  Does the model have the impact expected on the users:  i.e., increasing purchases or staying on the site longer?  These valuable insights can only be obtained when the model is actually deployed into a production environment.</p>&#13;
&#13;
<p>Another important concern is scalability and repeatability.  A truly technologically mature organization can deploy software, including machine learning models, on demand.  The best practices of DevOps for ML models are required here as well: continuous deployment, microservices, monitoring, and instrumentation.</p>&#13;
&#13;
<p>One easy way to inject more of this technological maturity into your organization is to apply the same logic as you do to choosing cloud computing over a physical data center.  Rent the expertise of others and take advantage of economies of scale.<a data-startref="ix_ch14-asciidoc11" data-type="indexterm" id="idm46691316521416"/><a data-startref="ix_ch14-asciidoc10" data-type="indexterm" id="idm46691316520712"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before less_space" data-pdf-bookmark="Sklearn Flask with Kubernetes and Docker" data-type="sect1"><div class="sect1" id="idm46691316648056">&#13;
<h1>Sklearn Flask with Kubernetes and Docker</h1>&#13;
&#13;
<p><a data-primary="Docker" data-secondary="sklearn flask" data-type="indexterm" id="ix_ch14-asciidoc13"/><a data-primary="Kubernetes" data-secondary="sklearn flask" data-type="indexterm" id="ix_ch14-asciidoc14"/><a data-primary="sklearn-based machine learning model" data-type="indexterm" id="ix_ch14-asciidoc15"/><a data-primary="sklearn-based machine learning model" data-secondary="Kubernetes and Docker" data-type="indexterm" id="ix_ch14-asciidoc16"/>Let’s walk through a real-world deployment of a sklearn-based machine learning model using Docker and Kubernetes.</p>&#13;
&#13;
<p>Here is a Dockerfile.  Note, that this serves out a Flask application.  The Flask application will host the sklearn application. Note that you might want to install Hadolint, which allows you to lint a Dockerfile:  <a href="https://github.com/hadolint/hadolint"><em class="hyperlink">https://github.com/hadolint/hadolint</em></a>.</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">FROM python:3.7.3-stretch&#13;
&#13;
<code class="c"># Working Directory</code>&#13;
WORKDIR /app&#13;
&#13;
<code class="c"># Copy source code to working directory</code>&#13;
COPY . app.py /app/&#13;
&#13;
<code class="c"># Install packages from requirements.txt</code>&#13;
<code class="c"># hadolint ignore=DL3013</code>&#13;
RUN pip install --upgrade pip <code class="o">&amp;&amp;</code><code class="se">\</code>&#13;
    pip install --trusted-host pypi.python.org -r requirements.txt&#13;
&#13;
<code class="c"># Expose port 80</code>&#13;
EXPOSE 80&#13;
&#13;
<code class="c"># Run app.py at container launch</code>&#13;
CMD <code class="o">[</code><code class="s2">"python"</code>, <code class="s2">"app.py"</code><code class="o">]</code></pre>&#13;
&#13;
<p>This is the <code>Makefile</code> and it serves as a central point of the application runtime:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">setup:&#13;
  python3 -m venv ~/.python-devops&#13;
&#13;
install:&#13;
  pip install --upgrade pip <code class="o">&amp;&amp;</code><code class="se">\</code>&#13;
    pip install -r requirements.txt&#13;
&#13;
<code class="nb">test</code>:&#13;
  <code class="c">#python -m pytest -vv --cov=myrepolib tests/*.py</code>&#13;
  <code class="c">#python -m pytest --nbval notebook.ipynb</code>&#13;
&#13;
lint:&#13;
  hadolint Dockerfile&#13;
  pylint --disable<code class="o">=</code>R,C,W1203 app.py&#13;
&#13;
all: install lint <code class="nb">test</code></pre>&#13;
&#13;
<p>This is the <em>requirements.txt</em> file:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting"><code class="nv">Flask</code><code class="o">==</code>1.0.2&#13;
<code class="nv">pandas</code><code class="o">==</code>0.24.2&#13;
scikit-learn<code class="o">==</code>0.20.3</pre>&#13;
&#13;
<p>This is the <em>app.py</em> file:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">flask</code> <code class="kn">import</code> <code class="n">Flask</code><code class="p">,</code> <code class="n">request</code><code class="p">,</code> <code class="n">jsonify</code>&#13;
<code class="kn">from</code> <code class="nn">flask.logging</code> <code class="kn">import</code> <code class="n">create_logger</code>&#13;
<code class="kn">import</code> <code class="nn">logging</code>&#13;
&#13;
<code class="kn">import</code> <code class="nn">pandas</code> <code class="kn">as</code> <code class="nn">pd</code>&#13;
<code class="kn">from</code> <code class="nn">sklearn.externals</code> <code class="kn">import</code> <code class="n">joblib</code>&#13;
<code class="kn">from</code> <code class="nn">sklearn.preprocessing</code> <code class="kn">import</code> <code class="n">StandardScaler</code>&#13;
&#13;
<code class="n">app</code> <code class="o">=</code> <code class="n">Flask</code><code class="p">(</code><code class="nv-Magic">__name__</code><code class="p">)</code>&#13;
<code class="n">LOG</code> <code class="o">=</code> <code class="n">create_logger</code><code class="p">(</code><code class="n">app</code><code class="p">)</code>&#13;
<code class="n">LOG</code><code class="o">.</code><code class="n">setLevel</code><code class="p">(</code><code class="n">logging</code><code class="o">.</code><code class="n">INFO</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">scale</code><code class="p">(</code><code class="n">payload</code><code class="p">):</code>&#13;
    <code class="sd">"""Scales Payload"""</code>&#13;
&#13;
    <code class="n">LOG</code><code class="o">.</code><code class="n">info</code><code class="p">(</code><code class="n">f</code><code class="s2">"Scaling Payload: {payload}"</code><code class="p">)</code>&#13;
    <code class="n">scaler</code> <code class="o">=</code> <code class="n">StandardScaler</code><code class="p">()</code><code class="o">.</code><code class="n">fit</code><code class="p">(</code><code class="n">payload</code><code class="p">)</code>&#13;
    <code class="n">scaled_adhoc_predict</code> <code class="o">=</code> <code class="n">scaler</code><code class="o">.</code><code class="n">transform</code><code class="p">(</code><code class="n">payload</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">scaled_adhoc_predict</code>&#13;
&#13;
<code class="nd">@app.route</code><code class="p">(</code><code class="s2">"/"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">home</code><code class="p">():</code>&#13;
    <code class="n">html</code> <code class="o">=</code> <code class="s2">"&lt;h3&gt;Sklearn Prediction Home&lt;/h3&gt;"</code>&#13;
    <code class="k">return</code> <code class="n">html</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">format</code><code class="p">)</code>&#13;
&#13;
<code class="c1"># TO DO:  Log out the prediction value</code>&#13;
<code class="nd">@app.route</code><code class="p">(</code><code class="s2">"/predict"</code><code class="p">,</code> <code class="n">methods</code><code class="o">=</code><code class="p">[</code><code class="s1">'POST'</code><code class="p">])</code>&#13;
<code class="k">def</code> <code class="nf">predict</code><code class="p">():</code>&#13;
    <code class="sd">"""Performs an sklearn prediction</code>&#13;
&#13;
<code class="sd">    input looks like:</code>&#13;
<code class="sd">            {</code>&#13;
<code class="sd">    "CHAS":{</code>&#13;
<code class="sd">      "0":0</code>&#13;
<code class="sd">    },</code>&#13;
<code class="sd">    "RM":{</code>&#13;
<code class="sd">      "0":6.575</code>&#13;
<code class="sd">    },</code>&#13;
<code class="sd">    "TAX":{</code>&#13;
<code class="sd">      "0":296.0</code>&#13;
<code class="sd">    },</code>&#13;
<code class="sd">    "PTRATIO":{</code>&#13;
<code class="sd">       "0":15.3</code>&#13;
<code class="sd">    },</code>&#13;
<code class="sd">    "B":{</code>&#13;
<code class="sd">       "0":396.9</code>&#13;
<code class="sd">    },</code>&#13;
<code class="sd">    "LSTAT":{</code>&#13;
<code class="sd">       "0":4.98</code>&#13;
<code class="sd">    }</code>&#13;
&#13;
<code class="sd">    result looks like:</code>&#13;
<code class="sd">    { "prediction": [ 20.35373177134412 ] }</code>&#13;
&#13;
<code class="sd">    """</code>&#13;
&#13;
    <code class="n">json_payload</code> <code class="o">=</code> <code class="n">request</code><code class="o">.</code><code class="n">json</code>&#13;
    <code class="n">LOG</code><code class="o">.</code><code class="n">info</code><code class="p">(</code><code class="n">f</code><code class="s2">"JSON payload: {json_payload}"</code><code class="p">)</code>&#13;
    <code class="n">inference_payload</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="n">json_payload</code><code class="p">)</code>&#13;
    <code class="n">LOG</code><code class="o">.</code><code class="n">info</code><code class="p">(</code><code class="n">f</code><code class="s2">"inference payload DataFrame: {inference_payload}"</code><code class="p">)</code>&#13;
    <code class="n">scaled_payload</code> <code class="o">=</code> <code class="n">scale</code><code class="p">(</code><code class="n">inference_payload</code><code class="p">)</code>&#13;
    <code class="n">prediction</code> <code class="o">=</code> <code class="nb">list</code><code class="p">(</code><code class="n">clf</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">scaled_payload</code><code class="p">))</code>&#13;
    <code class="k">return</code> <code class="n">jsonify</code><code class="p">({</code><code class="s1">'prediction'</code><code class="p">:</code> <code class="n">prediction</code><code class="p">})</code>&#13;
&#13;
<code class="k">if</code> <code class="nv-Magic">__name__</code> <code class="o">==</code> <code class="s2">"__main__"</code><code class="p">:</code>&#13;
    <code class="n">clf</code> <code class="o">=</code> <code class="n">joblib</code><code class="o">.</code><code class="n">load</code><code class="p">(</code><code class="s2">"boston_housing_prediction.joblib"</code><code class="p">)</code>&#13;
    <code class="n">app</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="n">host</code><code class="o">=</code><code class="s1">'0.0.0.0'</code><code class="p">,</code> <code class="n">port</code><code class="o">=</code><code class="mi">80</code><code class="p">,</code> <code class="n">debug</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code></pre>&#13;
&#13;
<p>This is the <em>run_docker.sh</em> file:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting"><code class="c">#!/usr/bin/env bash</code>&#13;
&#13;
<code class="c"># Build image</code>&#13;
docker build --tag<code class="o">=</code>flasksklearn .&#13;
&#13;
<code class="c"># List docker images</code>&#13;
docker image ls&#13;
&#13;
<code class="c"># Run flask app</code>&#13;
docker run -p 8000:80 flasksklearn</pre>&#13;
&#13;
<p>This is the <em>run_kubernetes.sh</em> file:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting"><code class="c">#!/usr/bin/env bash</code>&#13;
&#13;
<code class="nv">dockerpath</code><code class="o">=</code><code class="s2">"noahgift/flasksklearn"</code>&#13;
&#13;
<code class="c"># Run in Docker Hub container with kubernetes</code>&#13;
kubectl run flaskskearlndemo<code class="se">\</code>&#13;
    --generator<code class="o">=</code>run-pod/v1<code class="se">\</code>&#13;
    --image<code class="o">=</code><code class="nv">$dockerpath</code><code class="se">\</code>&#13;
    --port<code class="o">=</code><code class="m">80</code> --labels <code class="nv">app</code><code class="o">=</code>flaskskearlndemo&#13;
&#13;
<code class="c"># List kubernetes pods</code>&#13;
kubectl get pods&#13;
&#13;
<code class="c"># Forward the container port to host</code>&#13;
kubectl port-forward flaskskearlndemo 8000:80</pre>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting"><code class="c">#!/usr/bin/env bash</code>&#13;
<code class="c"># This tags and uploads an image to Docker Hub</code>&#13;
&#13;
<code class="c">#Assumes this is built</code>&#13;
<code class="c">#docker build --tag=flasksklearn .</code>&#13;
&#13;
<code class="nv">dockerpath</code><code class="o">=</code><code class="s2">"noahgift/flasksklearn"</code>&#13;
&#13;
<code class="c"># Authenticate &amp; Tag</code>&#13;
<code class="nb">echo</code> <code class="s2">"Docker ID and Image: </code><code class="nv">$dockerpath</code><code class="s2">"</code>&#13;
docker login <code class="o">&amp;&amp;</code><code class="se">\</code>&#13;
    docker image tag flasksklearn <code class="nv">$dockerpath</code>&#13;
&#13;
<code class="c"># Push Image</code>&#13;
docker image push <code class="nv">$dockerpath</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Sklearn Flask with Kubernetes and Docker" data-type="sect1"><div class="sect1" id="idm46691316091272">&#13;
<h1>Sklearn Flask with Kubernetes and Docker</h1>&#13;
&#13;
<p>You may be asking yourself how the model got created and then “pickled” out. You can see the <a href="https://oreil.ly/_pHz-">whole notebook here</a>.</p>&#13;
&#13;
<p>First, import some libraries for machine learning:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">numpy</code>&#13;
<code class="kn">from</code> <code class="nn">numpy</code> <code class="kn">import</code> <code class="n">arange</code>&#13;
<code class="kn">from</code> <code class="nn">matplotlib</code> <code class="kn">import</code> <code class="n">pyplot</code>&#13;
<code class="kn">import</code> <code class="nn">seaborn</code> <code class="kn">as</code> <code class="nn">sns</code>&#13;
<code class="kn">import</code> <code class="nn">pandas</code> <code class="kn">as</code> <code class="nn">pd</code>&#13;
<code class="kn">from</code> <code class="nn">pandas</code> <code class="kn">import</code> <code class="n">read_csv</code>&#13;
<code class="kn">from</code> <code class="nn">pandas</code> <code class="kn">import</code> <code class="n">set_option</code>&#13;
<code class="kn">from</code> <code class="nn">sklearn.preprocessing</code> <code class="kn">import</code> <code class="n">StandardScaler</code>&#13;
<code class="kn">from</code> <code class="nn">sklearn.model_selection</code> <code class="kn">import</code> <code class="n">train_test_split</code>&#13;
<code class="kn">from</code> <code class="nn">sklearn.model_selection</code> <code class="kn">import</code> <code class="n">KFold</code>&#13;
<code class="kn">from</code> <code class="nn">sklearn.model_selection</code> <code class="kn">import</code> <code class="n">cross_val_score</code>&#13;
<code class="kn">from</code> <code class="nn">sklearn.model_selection</code> <code class="kn">import</code> <code class="n">GridSearchCV</code>&#13;
<code class="kn">from</code> <code class="nn">sklearn.linear_model</code> <code class="kn">import</code> <code class="n">LinearRegression</code>&#13;
<code class="kn">from</code> <code class="nn">sklearn.linear_model</code> <code class="kn">import</code> <code class="n">Lasso</code>&#13;
<code class="kn">from</code> <code class="nn">sklearn.linear_model</code> <code class="kn">import</code> <code class="n">ElasticNet</code>&#13;
<code class="kn">from</code> <code class="nn">sklearn.tree</code> <code class="kn">import</code> <code class="n">DecisionTreeRegressor</code>&#13;
<code class="kn">from</code> <code class="nn">sklearn.neighbors</code> <code class="kn">import</code> <code class="n">KNeighborsRegressor</code>&#13;
<code class="kn">from</code> <code class="nn">sklearn.svm</code> <code class="kn">import</code> <code class="n">SVR</code>&#13;
<code class="kn">from</code> <code class="nn">sklearn.pipeline</code> <code class="kn">import</code> <code class="n">Pipeline</code>&#13;
<code class="kn">from</code> <code class="nn">sklearn.ensemble</code> <code class="kn">import</code> <code class="n">RandomForestRegressor</code>&#13;
<code class="kn">from</code> <code class="nn">sklearn.ensemble</code> <code class="kn">import</code> <code class="n">GradientBoostingRegressor</code>&#13;
<code class="kn">from</code> <code class="nn">sklearn.ensemble</code> <code class="kn">import</code> <code class="n">ExtraTreesRegressor</code>&#13;
<code class="kn">from</code> <code class="nn">sklearn.ensemble</code> <code class="kn">import</code> <code class="n">AdaBoostRegressor</code>&#13;
<code class="kn">from</code> <code class="nn">sklearn.metrics</code> <code class="kn">import</code> <code class="n">mean_squared_error</code></pre>&#13;
&#13;
<p><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">boston_housing</code> <code class="o">=</code> <code class="s2">"https://raw.githubusercontent.com/</code><code class="se">\</code>&#13;
<code class="s2">noahgift/boston_housing_pickle/master/housing.csv"</code>&#13;
<code class="n">names</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'CRIM'</code><code class="p">,</code> <code class="s1">'ZN'</code><code class="p">,</code> <code class="s1">'INDUS'</code><code class="p">,</code> <code class="s1">'CHAS'</code><code class="p">,</code>&#13;
<code class="s1">'NOX'</code><code class="p">,</code> <code class="s1">'RM'</code><code class="p">,</code> <code class="s1">'AGE'</code><code class="p">,</code> <code class="s1">'DIS'</code><code class="p">,</code> <code class="s1">'RAD'</code><code class="p">,</code> <code class="s1">'TAX'</code><code class="p">,</code>&#13;
 <code class="s1">'PTRATIO'</code><code class="p">,</code> <code class="s1">'B'</code><code class="p">,</code> <code class="s1">'LSTAT'</code><code class="p">,</code> <code class="s1">'MEDV'</code><code class="p">]</code>&#13;
<code class="n">df</code> <code class="o">=</code> <code class="n">read_csv</code><code class="p">(</code><code class="n">boston_housing</code><code class="p">,</code>&#13;
  <code class="n">delim_whitespace</code><code class="o">=</code><code class="bp">True</code><code class="p">,</code> <code class="n">names</code><code class="o">=</code><code class="n">names</code><code class="p">)</code></pre>&#13;
&#13;
<p><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">df</code><code class="o">.</code><code class="n">head</code><code class="p">()</code></pre>&#13;
&#13;
<p><code><strong>Out[0]:</strong></code></p>&#13;
<table>&#13;
&#13;
<thead>&#13;
<tr>&#13;
<th/>&#13;
<th><code>CRIM</code></th>&#13;
<th><code>ZN</code></th>&#13;
<th><code>INDUS</code></th>&#13;
<th><code>CHAS</code></th>&#13;
<th><code>NOX</code></th>&#13;
<th><code>RM</code></th>&#13;
<th><code>AGE</code></th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><code>0</code></p></td>&#13;
<td><p><code>0.00632</code></p></td>&#13;
<td><p><code>18.0</code></p></td>&#13;
<td><p><code>2.31</code></p></td>&#13;
<td><p><code>0</code></p></td>&#13;
<td><p><code>0.538</code></p></td>&#13;
<td><p><code>6.575</code></p></td>&#13;
<td><p><code>65.2</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>1</code></p></td>&#13;
<td><p><code>0.02731</code></p></td>&#13;
<td><p><code>0.0</code></p></td>&#13;
<td><p><code>7.07</code></p></td>&#13;
<td><p><code>0</code></p></td>&#13;
<td><p><code>0.469</code></p></td>&#13;
<td><p><code>6.421</code></p></td>&#13;
<td><p><code>78.9</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>2</code></p></td>&#13;
<td><p><code>0.02729</code></p></td>&#13;
<td><p><code>0.0</code></p></td>&#13;
<td><p><code>7.07</code></p></td>&#13;
<td><p><code>0</code></p></td>&#13;
<td><p><code>0.469</code></p></td>&#13;
<td><p><code>7.185</code></p></td>&#13;
<td><p><code>61.1</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>3</code></p></td>&#13;
<td><p><code>0.03237</code></p></td>&#13;
<td><p><code>0.0</code></p></td>&#13;
<td><p><code>2.18</code></p></td>&#13;
<td><p><code>0</code></p></td>&#13;
<td><p><code>0.458</code></p></td>&#13;
<td><p><code>6.998</code></p></td>&#13;
<td><p><code>45.8</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>4</code></p></td>&#13;
<td><p><code>0.06905</code></p></td>&#13;
<td><p><code>0.0</code></p></td>&#13;
<td><p><code>2.18</code></p></td>&#13;
<td><p><code>0</code></p></td>&#13;
<td><p><code>0.458</code></p></td>&#13;
<td><p><code>7.147</code></p></td>&#13;
<td><p><code>54.2</code></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
<table>&#13;
&#13;
<thead>&#13;
<tr>&#13;
<th/>&#13;
<th><code>DIS</code></th>&#13;
<th><code>RAD</code></th>&#13;
<th><code>TAX</code></th>&#13;
<th><code>PTRATIO</code></th>&#13;
<th><code>B</code></th>&#13;
<th><code>LSTAT</code></th>&#13;
<th><code>MEDV</code></th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><code>0</code></p></td>&#13;
<td><p><code>4.0900</code></p></td>&#13;
<td><p><code>1</code></p></td>&#13;
<td><p><code>296.0</code></p></td>&#13;
<td><p><code>15.3</code></p></td>&#13;
<td><p><code>396.90</code></p></td>&#13;
<td><p><code>4.98</code></p></td>&#13;
<td><p><code>24.0</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>1</code></p></td>&#13;
<td><p><code>4.9671</code></p></td>&#13;
<td><p><code>2</code></p></td>&#13;
<td><p><code>242.0</code></p></td>&#13;
<td><p><code>17.8</code></p></td>&#13;
<td><p><code>396.90</code></p></td>&#13;
<td><p><code>9.14</code></p></td>&#13;
<td><p><code>21.6</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>2</code></p></td>&#13;
<td><p><code>4.9671</code></p></td>&#13;
<td><p><code>2</code></p></td>&#13;
<td><p><code>242.0</code></p></td>&#13;
<td><p><code>17.8</code></p></td>&#13;
<td><p><code>392.83</code></p></td>&#13;
<td><p><code>4.03</code></p></td>&#13;
<td><p><code>34.7</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>3</code></p></td>&#13;
<td><p><code>6.0622</code></p></td>&#13;
<td><p><code>3</code></p></td>&#13;
<td><p><code>222.0</code></p></td>&#13;
<td><p><code>18.7</code></p></td>&#13;
<td><p><code>394.63</code></p></td>&#13;
<td><p><code>2.94</code></p></td>&#13;
<td><p><code>33.4</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>4</code></p></td>&#13;
<td><p><code>6.0622</code></p></td>&#13;
<td><p><code>3</code></p></td>&#13;
<td><p><code>222.0</code></p></td>&#13;
<td><p><code>18.7</code></p></td>&#13;
<td><p><code>396.90</code></p></td>&#13;
<td><p><code>5.33</code></p></td>&#13;
<td><p><code>36.2</code></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="EDA" data-type="sect2"><div class="sect2" id="idm46691315668664">&#13;
<h2>EDA</h2>&#13;
&#13;
<p><a data-primary="EDA (Exploratory Data Analysis)" data-type="indexterm" id="idm46691315667384"/><a data-primary="sklearn-based machine learning model" data-secondary="EDA" data-type="indexterm" id="idm46691315666712"/>These are the features of the model:</p>&#13;
<dl>&#13;
<dt>CHAS</dt>&#13;
<dd>&#13;
<p>Charles River dummy variable (1 if tract bounds river; 0 otherwise)</p>&#13;
</dd>&#13;
<dt>RM</dt>&#13;
<dd>&#13;
<p>Average number of rooms per dwelling</p>&#13;
</dd>&#13;
<dt>TAX</dt>&#13;
<dd>&#13;
<p>Full-value property tax rate per $10,000</p>&#13;
</dd>&#13;
<dt>PTRATIO</dt>&#13;
<dd>&#13;
<p>Pupil-teacher ratio by town</p>&#13;
</dd>&#13;
<dt>Bk</dt>&#13;
<dd>&#13;
<p>The proportion of black people by town</p>&#13;
</dd>&#13;
<dt>LSTAT </dt>&#13;
<dd>&#13;
<p><code>%</code> lower status of the population</p>&#13;
</dd>&#13;
<dt>MEDV</dt>&#13;
<dd>&#13;
<p>Median value of owner-occupied homes in $1000s</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p class="pagebreak-before"><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">prices</code> <code class="o">=</code> <code class="n">df</code><code class="p">[</code><code class="s1">'MEDV'</code><code class="p">]</code>&#13;
<code class="n">df</code> <code class="o">=</code> <code class="n">df</code><code class="o">.</code><code class="n">drop</code><code class="p">([</code><code class="s1">'CRIM'</code><code class="p">,</code><code class="s1">'ZN'</code><code class="p">,</code><code class="s1">'INDUS'</code><code class="p">,</code><code class="s1">'NOX'</code><code class="p">,</code><code class="s1">'AGE'</code><code class="p">,</code><code class="s1">'DIS'</code><code class="p">,</code><code class="s1">'RAD'</code><code class="p">],</code> <code class="n">axis</code> <code class="o">=</code> <code class="mi">1</code><code class="p">)</code>&#13;
<code class="n">features</code> <code class="o">=</code> <code class="n">df</code><code class="o">.</code><code class="n">drop</code><code class="p">(</code><code class="s1">'MEDV'</code><code class="p">,</code> <code class="n">axis</code> <code class="o">=</code> <code class="mi">1</code><code class="p">)</code>&#13;
<code class="n">df</code><code class="o">.</code><code class="n">head</code><code class="p">()</code></pre>&#13;
&#13;
<p><code><strong>Out[0]:</strong></code></p>&#13;
<table>&#13;
&#13;
<thead>&#13;
<tr>&#13;
<th/>&#13;
<th><code>CHAS</code></th>&#13;
<th><code>RM</code></th>&#13;
<th><code>TAX</code></th>&#13;
<th><code>PTRATIO</code></th>&#13;
<th><code>B</code></th>&#13;
<th><code>LSTAT</code></th>&#13;
<th><code>MEDV</code></th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><code>0</code></p></td>&#13;
<td><p><code>0</code></p></td>&#13;
<td><p><code>6.575</code></p></td>&#13;
<td><p><code>296.0</code></p></td>&#13;
<td><p><code>15.3</code></p></td>&#13;
<td><p><code>396.90</code></p></td>&#13;
<td><p><code>4.98</code></p></td>&#13;
<td><p><code>24.0</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>1</code></p></td>&#13;
<td><p><code>0</code></p></td>&#13;
<td><p><code>6.421</code></p></td>&#13;
<td><p><code>242.0</code></p></td>&#13;
<td><p><code>17.8</code></p></td>&#13;
<td><p><code>396.90</code></p></td>&#13;
<td><p><code>9.14</code></p></td>&#13;
<td><p><code>21.6</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>2</code></p></td>&#13;
<td><p><code>0</code></p></td>&#13;
<td><p><code>7.185</code></p></td>&#13;
<td><p><code>242.0</code></p></td>&#13;
<td><p><code>17.8</code></p></td>&#13;
<td><p><code>392.83</code></p></td>&#13;
<td><p><code>4.03</code></p></td>&#13;
<td><p><code>34.7</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>3</code></p></td>&#13;
<td><p><code>0</code></p></td>&#13;
<td><p><code>6.998</code></p></td>&#13;
<td><p><code>222.0</code></p></td>&#13;
<td><p><code>18.7</code></p></td>&#13;
<td><p><code>394.63</code></p></td>&#13;
<td><p><code>2.94</code></p></td>&#13;
<td><p><code>33.4</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>4</code></p></td>&#13;
<td><p><code>0</code></p></td>&#13;
<td><p><code>7.147</code></p></td>&#13;
<td><p><code>222.0</code></p></td>&#13;
<td><p><code>18.7</code></p></td>&#13;
<td><p><code>396.90</code></p></td>&#13;
<td><p><code>5.33</code></p></td>&#13;
<td><p><code>36.2</code></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Modeling" data-type="sect2"><div class="sect2" id="idm46691315576136">&#13;
<h2>Modeling</h2>&#13;
&#13;
<p><a data-primary="sklearn-based machine learning model" data-secondary="modeling" data-type="indexterm" id="idm46691315574728"/>This is where the modeling occurs in the notebook. One useful strategy is to always create four main sections of a notebook:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Ingestion</p>&#13;
</li>&#13;
<li>&#13;
<p>EDA</p>&#13;
</li>&#13;
<li>&#13;
<p>Modeling</p>&#13;
</li>&#13;
<li>&#13;
<p>Conclusion</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>In this modeling section, the data is extracted from the DataFrame and passed into the sklearn <code>train_test_split</code> module which does the heavy lifting of splitting the data into training and validation data.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Split Data" data-type="sect3"><div class="sect3" id="idm46691315532680">&#13;
<h3>Split Data</h3>&#13;
&#13;
<p><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1"># Split-out validation dataset</code>&#13;
<code class="n">array</code> <code class="o">=</code> <code class="n">df</code><code class="o">.</code><code class="n">values</code>&#13;
<code class="n">X</code> <code class="o">=</code> <code class="n">array</code><code class="p">[:,</code><code class="mi">0</code><code class="p">:</code><code class="mi">6</code><code class="p">]</code>&#13;
<code class="n">Y</code> <code class="o">=</code> <code class="n">array</code><code class="p">[:,</code><code class="mi">6</code><code class="p">]</code>&#13;
<code class="n">validation_size</code> <code class="o">=</code> <code class="mf">0.20</code>&#13;
<code class="n">seed</code> <code class="o">=</code> <code class="mi">7</code>&#13;
<code class="n">X_train</code><code class="p">,</code> <code class="n">X_validation</code><code class="p">,</code> <code class="n">Y_train</code><code class="p">,</code> <code class="n">Y_validation</code> <code class="o">=</code> <code class="n">train_test_split</code><code class="p">(</code><code class="n">X</code><code class="p">,</code> <code class="n">Y</code><code class="p">,</code>&#13;
  <code class="n">test_size</code><code class="o">=</code><code class="n">validation_size</code><code class="p">,</code> <code class="n">random_state</code><code class="o">=</code><code class="n">seed</code><code class="p">)</code></pre>&#13;
&#13;
<p><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="k">for</code> <code class="n">sample</code> <code class="ow">in</code> <code class="nb">list</code><code class="p">(</code><code class="n">X_validation</code><code class="p">)[</code><code class="mi">0</code><code class="p">:</code><code class="mi">2</code><code class="p">]:</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="n">f</code><code class="s2">"X_validation {sample}"</code><code class="p">)</code></pre>&#13;
&#13;
<p><code><strong>Out[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">X_validation</code> <code class="p">[</code>  <code class="mf">1.</code>      <code class="mf">6.395</code> <code class="mf">666.</code>     <code class="mf">20.2</code>   <code class="mf">391.34</code>   <code class="mf">13.27</code> <code class="p">]</code>&#13;
<code class="n">X_validation</code> <code class="p">[</code>  <code class="mf">0.</code>      <code class="mf">5.895</code> <code class="mf">224.</code>     <code class="mf">20.2</code>   <code class="mf">394.81</code>   <code class="mf">10.56</code> <code class="p">]</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Tune Scaled GBM" data-type="sect2"><div class="sect2" id="idm46691315363816">&#13;
<h2>Tune Scaled GBM</h2>&#13;
&#13;
<p><a data-primary="sklearn-based machine learning model" data-secondary="tune scaled GBM" data-type="indexterm" id="idm46691315450968"/>This model uses several advanced techniques that you can reference in many successful Kaggle projects.  These techniques include GridSearch which can help find the optimal hyperparameters.  Note, too, that scaling of the data is peformed.  Most machine learning algorithms expect some type of scaling to create accurate <span class="keep-together">predictions.</span></p>&#13;
&#13;
<p><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1"># Test options and evaluation metric using Root Mean Square error method</code>&#13;
<code class="n">num_folds</code> <code class="o">=</code> <code class="mi">10</code>&#13;
<code class="n">seed</code> <code class="o">=</code> <code class="mi">7</code>&#13;
<code class="n">RMS</code> <code class="o">=</code> <code class="s1">'neg_mean_squared_error'</code>&#13;
<code class="n">scaler</code> <code class="o">=</code> <code class="n">StandardScaler</code><code class="p">()</code><code class="o">.</code><code class="n">fit</code><code class="p">(</code><code class="n">X_train</code><code class="p">)</code>&#13;
<code class="n">rescaledX</code> <code class="o">=</code> <code class="n">scaler</code><code class="o">.</code><code class="n">transform</code><code class="p">(</code><code class="n">X_train</code><code class="p">)</code>&#13;
<code class="n">param_grid</code> <code class="o">=</code> <code class="nb">dict</code><code class="p">(</code><code class="n">n_estimators</code><code class="o">=</code><code class="n">numpy</code><code class="o">.</code><code class="n">array</code><code class="p">([</code><code class="mi">50</code><code class="p">,</code><code class="mi">100</code><code class="p">,</code><code class="mi">150</code><code class="p">,</code><code class="mi">200</code><code class="p">,</code><code class="mi">250</code><code class="p">,</code><code class="mi">300</code><code class="p">,</code><code class="mi">350</code><code class="p">,</code><code class="mi">400</code><code class="p">]))</code>&#13;
<code class="n">model</code> <code class="o">=</code> <code class="n">GradientBoostingRegressor</code><code class="p">(</code><code class="n">random_state</code><code class="o">=</code><code class="n">seed</code><code class="p">)</code>&#13;
<code class="n">kfold</code> <code class="o">=</code> <code class="n">KFold</code><code class="p">(</code><code class="n">n_splits</code><code class="o">=</code><code class="n">num_folds</code><code class="p">,</code> <code class="n">random_state</code><code class="o">=</code><code class="n">seed</code><code class="p">)</code>&#13;
<code class="n">grid</code> <code class="o">=</code> <code class="n">GridSearchCV</code><code class="p">(</code><code class="n">estimator</code><code class="o">=</code><code class="n">model</code><code class="p">,</code> <code class="n">param_grid</code><code class="o">=</code><code class="n">param_grid</code><code class="p">,</code> <code class="n">scoring</code><code class="o">=</code><code class="n">RMS</code><code class="p">,</code> <code class="n">cv</code><code class="o">=</code><code class="n">kfold</code><code class="p">)</code>&#13;
<code class="n">grid_result</code> <code class="o">=</code> <code class="n">grid</code><code class="o">.</code><code class="n">fit</code><code class="p">(</code><code class="n">rescaledX</code><code class="p">,</code> <code class="n">Y_train</code><code class="p">)</code>&#13;
&#13;
<code class="k">print</code><code class="p">(</code><code class="s2">"Best: </code><code class="si">%f</code><code class="s2"> using </code><code class="si">%s</code><code class="s2">"</code> <code class="o">%</code> <code class="p">(</code><code class="n">grid_result</code><code class="o">.</code><code class="n">best_score_</code><code class="p">,</code> <code class="n">grid_result</code><code class="o">.</code><code class="n">best_params_</code><code class="p">))</code>&#13;
<code class="n">means</code> <code class="o">=</code> <code class="n">grid_result</code><code class="o">.</code><code class="n">cv_results_</code><code class="p">[</code><code class="s1">'mean_test_score'</code><code class="p">]</code>&#13;
<code class="n">stds</code> <code class="o">=</code> <code class="n">grid_result</code><code class="o">.</code><code class="n">cv_results_</code><code class="p">[</code><code class="s1">'std_test_score'</code><code class="p">]</code>&#13;
<code class="n">params</code> <code class="o">=</code> <code class="n">grid_result</code><code class="o">.</code><code class="n">cv_results_</code><code class="p">[</code><code class="s1">'params'</code><code class="p">]</code>&#13;
<code class="k">for</code> <code class="n">mean</code><code class="p">,</code> <code class="n">stdev</code><code class="p">,</code> <code class="n">param</code> <code class="ow">in</code> <code class="nb">zip</code><code class="p">(</code><code class="n">means</code><code class="p">,</code> <code class="n">stds</code><code class="p">,</code> <code class="n">params</code><code class="p">):</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="s2">"</code><code class="si">%f</code><code class="s2"> (</code><code class="si">%f</code><code class="s2">) with: </code><code class="si">%r</code><code class="s2">"</code> <code class="o">%</code> <code class="p">(</code><code class="n">mean</code><code class="p">,</code> <code class="n">stdev</code><code class="p">,</code> <code class="n">param</code><code class="p">))</code></pre>&#13;
&#13;
<p><code><strong>Out[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">Best</code><code class="p">:</code> <code class="o">-</code><code class="mf">11.830068</code> <code class="n">using</code> <code class="p">{</code><code class="s1">'n_estimators'</code><code class="p">:</code> <code class="mi">200</code><code class="p">}</code>&#13;
<code class="o">-</code><code class="mf">12.479635</code> <code class="p">(</code><code class="mf">6.348297</code><code class="p">)</code> <code class="k">with</code><code class="p">:</code> <code class="p">{</code><code class="s1">'n_estimators'</code><code class="p">:</code> <code class="mi">50</code><code class="p">}</code>&#13;
<code class="o">-</code><code class="mf">12.102737</code> <code class="p">(</code><code class="mf">6.441597</code><code class="p">)</code> <code class="k">with</code><code class="p">:</code> <code class="p">{</code><code class="s1">'n_estimators'</code><code class="p">:</code> <code class="mi">100</code><code class="p">}</code>&#13;
<code class="o">-</code><code class="mf">11.843649</code> <code class="p">(</code><code class="mf">6.631569</code><code class="p">)</code> <code class="k">with</code><code class="p">:</code> <code class="p">{</code><code class="s1">'n_estimators'</code><code class="p">:</code> <code class="mi">150</code><code class="p">}</code>&#13;
<code class="o">-</code><code class="mf">11.830068</code> <code class="p">(</code><code class="mf">6.559724</code><code class="p">)</code> <code class="k">with</code><code class="p">:</code> <code class="p">{</code><code class="s1">'n_estimators'</code><code class="p">:</code> <code class="mi">200</code><code class="p">}</code>&#13;
<code class="o">-</code><code class="mf">11.879805</code> <code class="p">(</code><code class="mf">6.512414</code><code class="p">)</code> <code class="k">with</code><code class="p">:</code> <code class="p">{</code><code class="s1">'n_estimators'</code><code class="p">:</code> <code class="mi">250</code><code class="p">}</code>&#13;
<code class="o">-</code><code class="mf">11.895362</code> <code class="p">(</code><code class="mf">6.487726</code><code class="p">)</code> <code class="k">with</code><code class="p">:</code> <code class="p">{</code><code class="s1">'n_estimators'</code><code class="p">:</code> <code class="mi">300</code><code class="p">}</code>&#13;
<code class="o">-</code><code class="mf">12.008611</code> <code class="p">(</code><code class="mf">6.468623</code><code class="p">)</code> <code class="k">with</code><code class="p">:</code> <code class="p">{</code><code class="s1">'n_estimators'</code><code class="p">:</code> <code class="mi">350</code><code class="p">}</code>&#13;
<code class="o">-</code><code class="mf">12.053759</code> <code class="p">(</code><code class="mf">6.453899</code><code class="p">)</code> <code class="k">with</code><code class="p">:</code> <code class="p">{</code><code class="s1">'n_estimators'</code><code class="p">:</code> <code class="mi">400</code><code class="p">}</code>&#13;
&#13;
<code class="o">/</code><code class="n">usr</code><code class="o">/</code><code class="n">local</code><code class="o">/</code><code class="n">lib</code><code class="o">/</code><code class="n">python3</code><code class="o">.</code><code class="mi">6</code><code class="o">/</code><code class="n">dist</code><code class="o">-</code><code class="n">packages</code><code class="o">/</code><code class="n">sklearn</code><code class="o">/</code><code class="n">model_selection</code><code class="o">/</code><code class="n">_search</code><code class="o">.</code><code class="n">py</code><code class="p">:</code><code class="mi">841</code><code class="p">:</code>&#13;
<code class="ne">DeprecationWarning</code><code class="p">:</code>&#13;
<code class="ne">DeprecationWarning</code><code class="p">)</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Fit Model" data-type="sect2"><div class="sect2" id="idm46691315187768">&#13;
<h2>Fit Model</h2>&#13;
&#13;
<p><a data-primary="fitting, of machine learning model" data-type="indexterm" id="idm46691315186520"/><a data-primary="sklearn-based machine learning model" data-secondary="fitting model" data-type="indexterm" id="idm46691315185848"/>This model is fit using the GradientBoostingRegressor. The final step after training the model is to fit the model and check for error using the data that was set aside.  This data is scaled and passed into the model, and the accuracy is evaluated using the metric “Mean Squared Error.”</p>&#13;
&#13;
<p><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1"># prepare the model</code>&#13;
<code class="n">scaler</code> <code class="o">=</code> <code class="n">StandardScaler</code><code class="p">()</code><code class="o">.</code><code class="n">fit</code><code class="p">(</code><code class="n">X_train</code><code class="p">)</code>&#13;
<code class="n">rescaledX</code> <code class="o">=</code> <code class="n">scaler</code><code class="o">.</code><code class="n">transform</code><code class="p">(</code><code class="n">X_train</code><code class="p">)</code>&#13;
<code class="n">model</code> <code class="o">=</code> <code class="n">GradientBoostingRegressor</code><code class="p">(</code><code class="n">random_state</code><code class="o">=</code><code class="n">seed</code><code class="p">,</code> <code class="n">n_estimators</code><code class="o">=</code><code class="mi">400</code><code class="p">)</code>&#13;
<code class="n">model</code><code class="o">.</code><code class="n">fit</code><code class="p">(</code><code class="n">rescaledX</code><code class="p">,</code> <code class="n">Y_train</code><code class="p">)</code>&#13;
<code class="c1"># transform the validation dataset</code>&#13;
<code class="n">rescaledValidationX</code> <code class="o">=</code> <code class="n">scaler</code><code class="o">.</code><code class="n">transform</code><code class="p">(</code><code class="n">X_validation</code><code class="p">)</code>&#13;
<code class="n">predictions</code> <code class="o">=</code> <code class="n">model</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">rescaledValidationX</code><code class="p">)</code>&#13;
<code class="k">print</code><code class="p">(</code><code class="s2">"Mean Squared Error: </code><code class="se">\n</code><code class="s2">"</code><code class="p">)</code>&#13;
<code class="k">print</code><code class="p">(</code><code class="n">mean_squared_error</code><code class="p">(</code><code class="n">Y_validation</code><code class="p">,</code> <code class="n">predictions</code><code class="p">))</code></pre>&#13;
&#13;
<p><code><strong>Out[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">Mean</code> <code class="n">Squared</code> <code class="n">Error</code><code class="p">:</code>&#13;
&#13;
<code class="mf">26.326748591395717</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Evaluate" data-type="sect2"><div class="sect2" id="idm46691314761320">&#13;
<h2>Evaluate</h2>&#13;
&#13;
<p><a data-primary="sklearn-based machine learning model" data-secondary="evaluating model" data-type="indexterm" id="idm46691314766632"/>One of the trickier aspects to machine learning is evaluating the model.  This example shows how you can add predictions and the original home price to the same DataFrame.  That DataFrame can be used to substract the differences.</p>&#13;
&#13;
<p><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">predictions</code><code class="o">=</code><code class="n">predictions</code><code class="o">.</code><code class="n">astype</code><code class="p">(</code><code class="nb">int</code><code class="p">)</code>&#13;
<code class="n">evaluate</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">({</code>&#13;
        <code class="s2">"Org House Price"</code><code class="p">:</code> <code class="n">Y_validation</code><code class="p">,</code>&#13;
        <code class="s2">"Pred House Price"</code><code class="p">:</code> <code class="n">predictions</code>&#13;
    <code class="p">})</code>&#13;
<code class="n">evaluate</code><code class="p">[</code><code class="s2">"difference"</code><code class="p">]</code> <code class="o">=</code> <code class="n">evaluate</code><code class="p">[</code><code class="s2">"Org House Price"</code><code class="p">]</code><code class="o">-</code><code class="n">evaluate</code><code class="p">[</code><code class="s2">"Pred House Price"</code><code class="p">]</code>&#13;
<code class="n">evaluate</code><code class="o">.</code><code class="n">head</code><code class="p">()</code></pre>&#13;
&#13;
<p>The differences are shown here.</p>&#13;
&#13;
<p><code><strong>Out[0]:</strong></code></p>&#13;
<table>&#13;
&#13;
<thead>&#13;
<tr>&#13;
<th/>&#13;
<th><code>Org house price</code></th>&#13;
<th><code>Pred house price</code></th>&#13;
<th><code>Difference</code></th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><code>0</code></p></td>&#13;
<td><p><code>21.7</code></p></td>&#13;
<td><p><code>21</code></p></td>&#13;
<td><p><code>0.7</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>1</code></p></td>&#13;
<td><p><code>18.5</code></p></td>&#13;
<td><p><code>19</code></p></td>&#13;
<td><p><code>-0.5</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>2</code></p></td>&#13;
<td><p><code>22.2</code></p></td>&#13;
<td><p><code>20</code></p></td>&#13;
<td><p><code>2.2</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>3</code></p></td>&#13;
<td><p><code>20.4</code></p></td>&#13;
<td><p><code>19</code></p></td>&#13;
<td><p><code>1.4</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>4</code></p></td>&#13;
<td><p><code>8.8</code></p></td>&#13;
<td><p><code>9</code></p></td>&#13;
<td><p><code>-0.2</code></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
&#13;
<p>Using the describe method on Pandas is a great way to see the distribution of the data.</p>&#13;
&#13;
<p><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">evaluate</code><code class="o">.</code><code class="n">describe</code><code class="p">()</code></pre>&#13;
&#13;
<p><code><strong>Out[0]:</strong></code></p>&#13;
<table>&#13;
&#13;
<thead>&#13;
<tr>&#13;
<th/>&#13;
<th><code>Org house price</code></th>&#13;
<th><code>Pred house price</code></th>&#13;
<th><code>Difference</code></th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><code>count</code></p></td>&#13;
<td><p><code>102.000000</code></p></td>&#13;
<td><p><code>102.000000</code></p></td>&#13;
<td><p><code>102.000000</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>mean</code></p></td>&#13;
<td><p><code>22.573529</code></p></td>&#13;
<td><p><code>22.117647</code></p></td>&#13;
<td><p><code>0.455882</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>std</code></p></td>&#13;
<td><p><code>9.033622</code></p></td>&#13;
<td><p><code>8.758921</code></p></td>&#13;
<td><p><code>5.154438</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>min</code></p></td>&#13;
<td><p><code>6.300000</code></p></td>&#13;
<td><p><code>8.000000</code></p></td>&#13;
<td><p><code>-34.100000</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>25%</code></p></td>&#13;
<td><p><code>17.350000</code></p></td>&#13;
<td><p><code>17.000000</code></p></td>&#13;
<td><p><code>-0.800000</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>50%</code></p></td>&#13;
<td><p><code>21.800000</code></p></td>&#13;
<td><p><code>20.500000</code></p></td>&#13;
<td><p><code>0.600000</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>75%</code></p></td>&#13;
<td><p><code>24.800000</code></p></td>&#13;
<td><p><code>25.000000</code></p></td>&#13;
<td><p><code>2.200000</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>max</code></p></td>&#13;
<td><p><code>50.000000</code></p></td>&#13;
<td><p><code>56.000000</code></p></td>&#13;
<td><p><code>22.000000</code></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="adhoc_predict" data-type="sect2"><div class="sect2" id="idm46691314760728">&#13;
<h2>adhoc_predict</h2>&#13;
&#13;
<p><a data-primary="adhoc predict" data-type="indexterm" id="idm46691314645176"/><a data-primary="sklearn-based machine learning model" data-secondary="adhoc predict" data-type="indexterm" id="idm46691314644472"/>Let’s test this prediction model to see what the workflow would be after unpickling.  When developing a web API for a machine learning model, it can be helpful to test out the sections of code that the API will perform in the notebook itself.  It is much easier to debug and create functions inside the actual notebook than struggle to create the correct functions inside a web application.</p>&#13;
&#13;
<p><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">actual_sample</code> <code class="o">=</code> <code class="n">df</code><code class="o">.</code><code class="n">head</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>&#13;
<code class="n">actual_sample</code></pre>&#13;
&#13;
<p><code><strong>Out[0]:</strong></code></p>&#13;
<table>&#13;
&#13;
<thead>&#13;
<tr>&#13;
<th/>&#13;
<th><code>CHAS</code></th>&#13;
<th><code>RM</code></th>&#13;
<th><code>TAX</code></th>&#13;
<th><code>PTRATIO</code></th>&#13;
<th><code>B</code></th>&#13;
<th><code>LSTAT</code></th>&#13;
<th><code>MEDV</code></th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><code>0</code></p></td>&#13;
<td><p><code>0</code></p></td>&#13;
<td><p><code>6.575</code></p></td>&#13;
<td><p><code>296.0</code></p></td>&#13;
<td><p><code>15.3</code></p></td>&#13;
<td><p><code>396.9</code></p></td>&#13;
<td><p><code>4.98</code></p></td>&#13;
<td><p><code>24.0</code></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
&#13;
<p><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">adhoc_predict</code> <code class="o">=</code> <code class="n">actual_sample</code><code class="p">[[</code><code class="s2">"CHAS"</code><code class="p">,</code> <code class="s2">"RM"</code><code class="p">,</code> <code class="s2">"TAX"</code><code class="p">,</code> <code class="s2">"PTRATIO"</code><code class="p">,</code> <code class="s2">"B"</code><code class="p">,</code> <code class="s2">"LSTAT"</code><code class="p">]]</code>&#13;
<code class="n">adhoc_predict</code><code class="o">.</code><code class="n">head</code><code class="p">()</code></pre>&#13;
&#13;
<p><code><strong>Out[0]:</strong></code></p>&#13;
<table>&#13;
&#13;
<thead>&#13;
<tr>&#13;
<th/>&#13;
<th><code>CHAS</code></th>&#13;
<th><code>RM</code></th>&#13;
<th><code>TAX</code></th>&#13;
<th><code>PTRATIO</code></th>&#13;
<th><code>B</code></th>&#13;
<th><code>LSTAT</code></th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><code>0</code></p></td>&#13;
<td><p><code>0</code></p></td>&#13;
<td><p><code>6.575</code></p></td>&#13;
<td><p><code>296.0</code></p></td>&#13;
<td><p><code>15.3</code></p></td>&#13;
<td><p><code>396.9</code></p></td>&#13;
<td><p><code>4.98</code></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="JSON Workflow" data-type="sect2"><div class="sect2" id="idm46691314645960">&#13;
<h2>JSON Workflow</h2>&#13;
&#13;
<p><a data-primary="JSON (Javascript Object Notation)" data-secondary="workflow" data-type="indexterm" id="idm46691314567528"/><a data-primary="sklearn-based machine learning model" data-secondary="JSON workflow" data-type="indexterm" id="idm46691314566584"/>This is a section of the notebook that is useful for debugging Flask apps.  As mentioned earlier, it is much more straightforward to develop the API code inside the machine learning project, make sure it works, then transport that code to a script.  The alternative is trying to get the exact code syntax in a software project that doesn’t have the same interactive tools that Jupyter provides.</p>&#13;
&#13;
<p><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">json_payload</code> <code class="o">=</code> <code class="n">adhoc_predict</code><code class="o">.</code><code class="n">to_json</code><code class="p">()</code>&#13;
<code class="n">json_payload</code></pre>&#13;
&#13;
<p><code><strong>Out[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="p">{</code><code class="s2">"CHAS"</code><code class="p">:{</code><code class="s2">"0"</code><code class="p">:</code><code class="mi">0</code><code class="p">},</code><code class="s2">"RM"</code><code class="p">:</code>&#13;
<code class="p">{</code><code class="s2">"0"</code><code class="p">:</code><code class="mf">6.575</code><code class="p">},</code><code class="s2">"TAX"</code><code class="p">:</code>&#13;
<code class="p">{</code><code class="s2">"0"</code><code class="p">:</code><code class="mf">296.0</code><code class="p">},</code><code class="s2">"PTRATIO"</code><code class="p">:</code>&#13;
<code class="p">{</code><code class="s2">"0"</code><code class="p">:</code><code class="mf">15.3</code><code class="p">},</code><code class="s2">"B"</code><code class="p">:{</code><code class="s2">"0"</code><code class="p">:</code><code class="mf">396.9</code><code class="p">},</code><code class="s2">"LSTAT"</code><code class="p">:</code>&#13;
<code class="p">{</code><code class="s2">"0"</code><code class="p">:</code><code class="mf">4.98</code><code class="p">}}</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Scale Input" data-type="sect2"><div class="sect2" id="idm46691314480152">&#13;
<h2>Scale Input</h2>&#13;
&#13;
<p><a data-primary="scale input, sklearn flask and" data-type="indexterm" id="idm46691314454200"/><a data-primary="sklearn-based machine learning model" data-secondary="scale input" data-type="indexterm" id="idm46691314453560"/>The data has to be scaled back to be predicted.  This workflow needed to be flushed out in the notebook instead of struggling to get it to work in a web application that will be much tougher to debug.  The section below shows the code that solves that portion of the machine learning prediction pipeline.  It can then be used to create a function in a Flask application.</p>&#13;
&#13;
<p><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">scaler</code> <code class="o">=</code> <code class="n">StandardScaler</code><code class="p">()</code><code class="o">.</code><code class="n">fit</code><code class="p">(</code><code class="n">adhoc_predict</code><code class="p">)</code>&#13;
<code class="n">scaled_adhoc_predict</code> <code class="o">=</code> <code class="n">scaler</code><code class="o">.</code><code class="n">transform</code><code class="p">(</code><code class="n">adhoc_predict</code><code class="p">)</code>&#13;
<code class="n">scaled_adhoc_predict</code></pre>&#13;
&#13;
<p><code><strong>Out[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">array</code><code class="p">([[</code><code class="mf">0.</code><code class="p">,</code> <code class="mf">0.</code><code class="p">,</code> <code class="mf">0.</code><code class="p">,</code> <code class="mf">0.</code><code class="p">,</code> <code class="mf">0.</code><code class="p">,</code> <code class="mf">0.</code><code class="p">]])</code></pre>&#13;
&#13;
<p><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="nb">list</code><code class="p">(</code><code class="n">model</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">scaled_adhoc_predict</code><code class="p">))</code></pre>&#13;
&#13;
<p><code><strong>Out[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="p">[</code><code class="mf">20.35373177134412</code><code class="p">]</code></pre>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Pickling sklearn" data-type="sect3"><div class="sect3" id="idm46691314368792">&#13;
<h3>Pickling sklearn</h3>&#13;
&#13;
<p>Next, let’s export this model.</p>&#13;
&#13;
<p><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">sklearn.externals</code> <code class="kn">import</code> <code class="n">joblib</code></pre>&#13;
&#13;
<p><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">joblib</code><code class="o">.</code><code class="n">dump</code><code class="p">(</code><code class="n">model</code><code class="p">,</code> <code class="s1">'boston_housing_prediction.joblib'</code><code class="p">)</code></pre>&#13;
&#13;
<p><code><strong>Out[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="p">[</code><code class="s1">'boston_housing_prediction.joblib'</code><code class="p">]</code></pre>&#13;
&#13;
<p><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-type="programlisting">!ls -l</pre>&#13;
&#13;
<p><code><strong>Out[0]:</strong></code></p>&#13;
&#13;
<pre data-type="programlisting">total 672&#13;
-rw-r--r-- 1 root root 681425 May  5 00:35 boston_housing_prediction.joblib&#13;
drwxr-xr-x 1 root root   4096 Apr 29 16:32 sample_data</pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Unpickle and predict" data-type="sect3"><div class="sect3" id="idm46691314368200">&#13;
<h3>Unpickle and predict</h3>&#13;
&#13;
<p><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">clf</code> <code class="o">=</code> <code class="n">joblib</code><code class="o">.</code><code class="n">load</code><code class="p">(</code><code class="s1">'boston_housing_prediction.joblib'</code><code class="p">)</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="adhoc_predict from Pickle" data-type="sect2"><div class="sect2" id="idm46691314454792">&#13;
<h2>adhoc_predict from Pickle</h2>&#13;
&#13;
<p><a data-primary="adhoc predict" data-type="indexterm" id="idm46691314281544"/><a data-primary="sklearn-based machine learning model" data-secondary="adhoc predict" data-type="indexterm" id="idm46691314280840"/><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">actual_sample2</code> <code class="o">=</code> <code class="n">df</code><code class="o">.</code><code class="n">head</code><code class="p">(</code><code class="mi">5</code><code class="p">)</code>&#13;
<code class="n">actual_sample2</code></pre>&#13;
&#13;
<p><code><strong>Out[0]:</strong></code></p>&#13;
<table>&#13;
&#13;
<thead>&#13;
<tr>&#13;
<th/>&#13;
<th><code>CHAS</code></th>&#13;
<th><code>RM</code></th>&#13;
<th><code>TAX</code></th>&#13;
<th><code>PTRATIO</code></th>&#13;
<th><code>B</code></th>&#13;
<th><code>LSTAT</code></th>&#13;
<th><code>MEDV</code></th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><code>0</code></p></td>&#13;
<td><p><code>0</code></p></td>&#13;
<td><p><code>6.575</code></p></td>&#13;
<td><p><code>296.0</code></p></td>&#13;
<td><p><code>15.3</code></p></td>&#13;
<td><p><code>396.90</code></p></td>&#13;
<td><p><code>4.98</code></p></td>&#13;
<td><p><code>24.0</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>1</code></p></td>&#13;
<td><p><code>0</code></p></td>&#13;
<td><p><code>6.421</code></p></td>&#13;
<td><p><code>242.0</code></p></td>&#13;
<td><p><code>17.8</code></p></td>&#13;
<td><p><code>396.90</code></p></td>&#13;
<td><p><code>9.14</code></p></td>&#13;
<td><p><code>21.6</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>2</code></p></td>&#13;
<td><p><code>0</code></p></td>&#13;
<td><p><code>7.185</code></p></td>&#13;
<td><p><code>242.0</code></p></td>&#13;
<td><p><code>17.8</code></p></td>&#13;
<td><p><code>392.83</code></p></td>&#13;
<td><p><code>4.03</code></p></td>&#13;
<td><p><code>34.7</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>3</code></p></td>&#13;
<td><p><code>0</code></p></td>&#13;
<td><p><code>6.998</code></p></td>&#13;
<td><p><code>222.0</code></p></td>&#13;
<td><p><code>18.7</code></p></td>&#13;
<td><p><code>394.63</code></p></td>&#13;
<td><p><code>2.94</code></p></td>&#13;
<td><p><code>33.4</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>4</code></p></td>&#13;
<td><p><code>0</code></p></td>&#13;
<td><p><code>7.147</code></p></td>&#13;
<td><p><code>222.0</code></p></td>&#13;
<td><p><code>18.7</code></p></td>&#13;
<td><p><code>396.90</code></p></td>&#13;
<td><p><code>5.33</code></p></td>&#13;
<td><p><code>36.2</code></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
&#13;
<p><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">adhoc_predict2</code> <code class="o">=</code> <code class="n">actual_sample</code><code class="p">[[</code><code class="s2">"CHAS"</code><code class="p">,</code> <code class="s2">"RM"</code><code class="p">,</code> <code class="s2">"TAX"</code><code class="p">,</code> <code class="s2">"PTRATIO"</code><code class="p">,</code> <code class="s2">"B"</code><code class="p">,</code> <code class="s2">"LSTAT"</code><code class="p">]]</code>&#13;
<code class="n">adhoc_predict2</code><code class="o">.</code><code class="n">head</code><code class="p">()</code></pre>&#13;
&#13;
<p><code><strong>Out[0]:</strong></code></p>&#13;
<table>&#13;
&#13;
<thead>&#13;
<tr>&#13;
<th/>&#13;
<th><code>CHAS</code></th>&#13;
<th><code>RM</code></th>&#13;
<th><code>TAX</code></th>&#13;
<th><code>PTRATIO</code></th>&#13;
<th><code>B</code></th>&#13;
<th><code>LSTAT</code></th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><code>0</code></p></td>&#13;
<td><p><code>0</code></p></td>&#13;
<td><p><code>6.575</code></p></td>&#13;
<td><p><code>296.0</code></p></td>&#13;
<td><p><code>15.3</code></p></td>&#13;
<td><p><code>396.9</code></p></td>&#13;
<td><p><code>4.98</code></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Scale Input" data-type="sect2"><div class="sect2" id="idm46691314095144">&#13;
<h2>Scale Input</h2>&#13;
&#13;
<p><a data-primary="scale input, sklearn flask and" data-type="indexterm" id="idm46691314093576"/><a data-primary="sklearn-based machine learning model" data-secondary="scale input" data-type="indexterm" id="idm46691314092904"/><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">scaler</code> <code class="o">=</code> <code class="n">StandardScaler</code><code class="p">()</code><code class="o">.</code><code class="n">fit</code><code class="p">(</code><code class="n">adhoc_predict2</code><code class="p">)</code>&#13;
<code class="n">scaled_adhoc_predict2</code> <code class="o">=</code> <code class="n">scaler</code><code class="o">.</code><code class="n">transform</code><code class="p">(</code><code class="n">adhoc_predict2</code><code class="p">)</code>&#13;
<code class="n">scaled_adhoc_predict2</code></pre>&#13;
&#13;
<p><code><strong>Out[0]:</strong></code></p>&#13;
&#13;
<pre data-type="programlisting">array([[0., 0., 0., 0., 0., 0.]])</pre>&#13;
&#13;
<p><code><strong>In[0]:</strong></code></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1"># Use pickle loaded model</code>&#13;
<code class="nb">list</code><code class="p">(</code><code class="n">clf</code><code class="o">.</code><code class="n">predict</code><code class="p">(</code><code class="n">scaled_adhoc_predict2</code><code class="p">))</code></pre>&#13;
&#13;
<p><code><strong>Out[0]:</strong></code></p>&#13;
&#13;
<pre data-type="programlisting">[20.35373177134412]</pre>&#13;
&#13;
<p>Finally, the pickled model is loaded back in and tested against a real dataset.<a data-startref="ix_ch14-asciidoc16" data-type="indexterm" id="idm46691314034472"/><a data-startref="ix_ch14-asciidoc15" data-type="indexterm" id="idm46691314033768"/><a data-startref="ix_ch14-asciidoc14" data-type="indexterm" id="idm46691314049736"/><a data-startref="ix_ch14-asciidoc13" data-type="indexterm" id="idm46691314049064"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Exercises" data-type="sect1"><div class="sect1" id="idm46691316098776">&#13;
<h1>Exercises</h1>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>What are some key differences between scikit-learn and PyTorch?</p>&#13;
</li>&#13;
<li>&#13;
<p>What is AutoML and why would you use it?</p>&#13;
</li>&#13;
<li>&#13;
<p>Change the scikit-learn model to use height to predict weight.</p>&#13;
</li>&#13;
<li>&#13;
<p>Run the PyTorch example in Google Colab notebooks and toggle between CPU and GPU runtimes.  Explain the performance difference if there is one.</p>&#13;
</li>&#13;
<li>&#13;
<p>What is EDA and why is it so important in a data science project?</p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Case Study Question" data-type="sect1"><div class="sect1" id="idm46691314042760">&#13;
<h1>Case Study Question</h1>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Go to the Kaggle website, take a popular notebook in Python, and convert it to a containerized Flask application that serves out predictions using the example shown in this chapter as a guide.  Now deploy this to a cloud environment via a hosted Kubernetes service such as Amazon EKS.</p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Learning Assessments" data-type="sect1"><div class="sect1" id="idm46691314000712">&#13;
<h1>Learning Assessments</h1>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Explain the different types of machine learning frameworks and ecosystems.</p>&#13;
</li>&#13;
<li>&#13;
<p>Run and debug a preexisting machine learning project in scikit-learn and PyTorch.</p>&#13;
</li>&#13;
<li>&#13;
<p>Containerize a Flask scikit-learn model.</p>&#13;
</li>&#13;
<li>&#13;
<p>Understand the production machine learning maturity model.<a data-startref="ix_ch14-asciidoc0" data-type="indexterm" id="idm46691313996152"/></p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>