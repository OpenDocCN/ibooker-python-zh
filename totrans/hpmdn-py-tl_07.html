<html><head></head><body>
<div id="book-content">
<div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 5. Managing Projects with Poetry"><div class="chapter" id="chapter_poetry">
<h1><span class="label">Chapter 5. </span>Managing Projects with Poetry</h1>

<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id283">
<h1>A Note for Early Release Readers</h1>
<p>With Early Release ebooks, you get books in their earliest form—the author’s raw and unedited content as they write—so you can take advantage of these technologies long before the official release of these titles.</p>

<p>This will be the fifth chapter of the final book. Please note that the GitHub repo will be made active later on.</p>

<p>If you have comments about how we might improve the content and/or examples in this book, or if you notice missing material within this chapter, please reach out to the author at <a href="mailto:mail@claudiojolowicz.com">mail@claudiojolowicz.com</a>.</p>
</div></aside>

<p>The preceding chapters introduced the building blocks for publishing
production-quality Python packages. So far, you’ve written a <em>pyproject.toml</em>
for a project; created an environment and installed dependencies with uv, pip,
or pip-tools; and built and published packages with <code>build</code> and Twine.</p>

<p>By standardizing project metadata and build backends, <em>pyproject.toml</em> broke the
setuptools monopoly (see <a data-type="xref" href="#sidebar_poetry_evolution">“The Evolution of Python Project Managers”</a>) and brought diversity to
the packaging ecosystem. Defining a Python package got easier, too: a single
well-specified file with great tooling support replaces the legacy boilerplate
of <em>setup.py</em> and untold configuration files.</p>

<p>Yet, some problems remain.</p>

<p>Before you can work on a <em>pyproject.toml</em>-based project, you need to research
packaging workflows, configuration files, and associated tooling. You have to
choose one of a number of available build backends
(<a data-type="xref" href="ch03.html#table_packages_build_backends">Table 3-2</a>)—and many people don’t know what those are,
let alone how to choose them. Important aspects of Python packages remain
unspecified—​for example, how project sources are laid out and which files
should go into the packaging artifacts.</p>

<p>Dependency and environment management could be easier, too. You need to
handcraft your dependency specifications and compile them with pip-tools,
cluttering your project with requirements files. And it can be hard to keep
track of the many Python environments on a typical developer system.</p>

<p>The Python project manager Poetry was addressing these problems before some of
the standards governing <em>pyproject.toml</em> took shape. Its friendly command-line
interface lets you perform most tasks related to packaging, dependencies, and
environments. Poetry brings its own standards-compliant build backend,
<code>poetry.core</code>—but you can remain blissfully unaware of this fact. It also comes
with a strict dependency resolver and locks all dependencies by default, behind
the scenes.</p>

<p>Why learn about packaging standards and low-level plumbing if Poetry abstracts
away many of these details? Because, while Poetry ventures into new territory,
it still works within the framework defined by packaging standards. Mechanisms
like dependency specifications and virtual environments power its central
features. Interoperability standards let Poetry interact with package
repositories as well as other build backends and package installers.</p>

<p>An understanding of these underlying mechanisms helps you debug situations where
Poetry’s convenient abstractions break down—​for example, when a
misconfiguration or a bug causes a package to end up in the wrong environment.
Finally, the experience of past decades teaches us that tools come and go, while
standards and algorithms are here to stay.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="sidebar_poetry_evolution">
<h1>The Evolution of Python Project Managers</h1>
<p>A decade ago, Python packaging was firmly in the hands of three tools:
setuptools, virtualenv, and pip. You’d use setuptools to create Python packages,
virtualenv to set up virtual environments, and pip to install packages into
them. Everybody did. Around 2016—​the same year that the <em>pyproject.toml</em> file
became standard—​things started to change.</p>

<p>In 2015, Thomas Kluyver began developing Flit, an alternative build tool that
could create packages and publish them to PyPI. In 2016, Donald Stufft from the
pip maintainer team started working on Pipfile, a proposed replacement for
requirements files, including a specification of lock files. In 2017, his work
led to Kenneth Reitz’s Pipenv, which allows you to manage dependencies and
environments for Python applications and deploy them in a reproducible way.
Pipenv deliberately didn’t package your application: you’d just keep a bunch of
Python modules in a Git repository.</p>

<p>Poetry, started in 2018 by Sébastien Eustace, was the first tool to provide a
unified approach to packaging, dependencies, and environments—​and quickly
became widely adopted. Two other tools follow a similarly holistic approach:
PDM, started by Frost Ming in 2019, and Hatch by Ofek Lev in 2017. Hatch has
recently grown in popularity, especially among tooling and library developers.
In 2023, they were joined by Rye, a project manager written in Rust by Armin
Ronacher. In addition, Hatch and Rye also manage Python installations,
leveraging the Python Standalone Builds project.</p>

<p>Poetry, Hatch, PDM, and Rye each give you an integrated workflow for managing
Python packages, environments, and dependencies. As such, they’ve come to be
known as <em>Python project managers</em>. Keep an eye on Astral’s uv as well!</p>
</div></aside>






<section data-type="sect1" data-pdf-bookmark="Installing Poetry"><div class="sect1" id="id136">
<h1>Installing Poetry</h1>

<p>Install Poetry globally using pipx, to keep its dependencies isolated from the
rest of the system:</p>
<pre data-type="programlisting">$ <strong>pipx install poetry</strong>
</pre>

<p>A single Poetry installation works with multiple Python versions. However,
Poetry uses its own interpreter as the default Python version. For this reason,
it’s worthwhile to install Poetry on the latest stable Python release. When
installing a new feature release of Python, reinstall Poetry like this:</p>
<pre data-type="programlisting">$ <strong>pipx reinstall --python=3.12 poetry</strong>
</pre>

<p>You can omit the <code>--python</code> option if pipx already uses the new Python version
(see <a data-type="xref" href="ch02.html#section_environments_pipx_configuration">“Configuring Pipx”</a>).</p>

<p>When a prerelease of Poetry becomes available, you can install it side-by-side
with the stable version:</p>
<pre data-type="programlisting">$ <strong>pipx install poetry --suffix=@preview --pip-args=--pre</strong>
</pre>

<p>Above, I’ve used the <code>--suffix</code> option to rename the command so you can invoke
it as <code>poetry@preview</code>, while keeping <code>poetry</code> as the stable version. The
<code>--pip-args</code> option lets you pass options to pip, like <code>--pre</code> for including
prereleases.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Poetry also comes with an
<a href="https://python-poetry.org/docs/#installing-with-the-official-installer">official
installer</a>, which you can download and run with Python. It’s not as flexible as
pipx, but it provides a readily available alternative:</p>
<pre data-type="programlisting">$ <strong>curl -sSL https://install.python-poetry.org | python3 -</strong></pre>
</div>

<p>Upgrade Poetry periodically to receive improvements and bugfixes:</p>
<pre data-type="programlisting">$ <strong>pipx upgrade poetry</strong>
</pre>

<p>Type <code>poetry</code> on its own to check your installation of Poetry. Poetry prints its
version and usage to the terminal, including a useful listing of all available
subcommands.</p>
<pre data-type="programlisting">$ <strong>poetry</strong>
</pre>

<p>Having successfully installed Poetry, you may want to enable tab completion for
your shell. Use the command <code>poetry help completions</code> for shell-specific
instructions. For example, the following commands enable tab completion in the
Bash shell:</p>
<pre data-type="programlisting">$ <strong>poetry completions bash &gt;&gt; ~/.bash_completion</strong>
$ <strong>echo ". ~/.bash_completion" &gt;&gt; ~/.bashrc</strong>
</pre>

<p>Restart your shell for the changes to take effect.</p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Creating a Project"><div class="sect1" id="section_poetry_creating">
<h1>Creating a Project</h1>

<p>You can create a new project using the command <code>poetry new</code>. As an example, I’ll
use the <code>random-wikipedia-article</code> project from previous chapters. Run the
following command in the parent directory where you want to keep your new
project:</p>
<pre data-type="programlisting">$ <strong>poetry new --src random-wikipedia-article</strong>
</pre>

<p>After running this command, you’ll see that Poetry created a project directory
named <em>random-wikipedia-article</em>, with the following structure:</p>

<pre data-type="programlisting">random-wikipedia-article
├── README.md
├── pyproject.toml
├── src
│   └── random_wikipedia_article
│       └── __init__.py
└── tests
    └── __init__.py</pre>

<p>The <code>--src</code> option instructs Poetry to place the import package in a
subdirectory named <em>src</em> rather than directly in the project directory.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="sidebar_src_layout">
<h1>The <em>src</em> Layout</h1>
<p>Until a few years ago, package authors placed the import package directly in the
project directory. These days, a project layout with <em>src</em>, <em>tests</em>, and <em>docs</em>
directories at the top is becoming more common.</p>

<p>Keeping the import package tucked away under <em>src</em> has practical advantages.
During development, the current directory often appears at the start of
<code>sys.path</code>. Without an <em>src</em> layout, you may be importing your project from its
source code, not from the package you’ve installed in the project environment.
In the worst case, your tests could fail to detect issues in a release you’re
about to publish.</p>

<p>On the other hand, whenever you <em>want</em> to execute the source code itself,
editable installs achieve this by design. With an <em>src</em> layout, packaging tools
can implement editable installs by adding the <em>src</em> directory to
<code>sys.path</code>—without the side effect of making unrelated Python files importable.</p>
</div></aside>

<p>Let’s take a look at the generated <em>pyproject.toml</em>
(<a data-type="xref" href="#example_poetry_pyproject_toml">Example 5-1</a>):</p>
<div id="example_poetry_pyproject_toml" data-type="example">
<h5><span class="label">Example 5-1. </span>A pyproject.toml file for Poetry</h5>

<pre data-type="programlisting" data-code-language="toml"><code class="k">[tool.poetry]</code><code class="w"/>
<code class="n">name</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"random-wikipedia-article"</code><code class="w"/>
<code class="n">version</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"0.1.0"</code><code class="w"/>
<code class="n">description</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">""</code><code class="w"/>
<code class="n">authors</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">[</code><code class="s2">"Your Name &lt;you@example.com&gt;"</code><code class="p">]</code><code class="w"/>
<code class="n">readme</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"README.md"</code><code class="w"/>
<code class="n">packages</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">[{</code><code class="n">include</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="s2">"random_wikipedia_article"</code><code class="p">,</code><code class="w"> </code><code class="n">from</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="s2">"src"</code><code class="p">}]</code><code class="w"/>

<code class="k">[tool.poetry.dependencies]</code><code class="w"/>
<code class="n">python</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"^3.12"</code><code class="w"/>

<code class="k">[build-system]</code><code class="w"/>
<code class="n">requires</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">[</code><code class="s2">"poetry-core"</code><code class="p">]</code><code class="w"/>
<code class="n">build-backend</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"poetry.core.masonry.api"</code><code class="w"/></pre></div>

<p>Poetry has created a standard <code>build-system</code> table with its build backend,
<code>poetry.core</code>. This means anybody can install your project from source using pip
or uv—​no need to set up, or even know about, the Poetry project manager.
Similarly, you can build packages using any standard build frontend, such as
<code>build</code>:</p>
<pre data-type="programlisting">$ <strong>pipx run build</strong>
* Creating venv isolated environment...
* Installing packages in isolated environment... (poetry-core)
* Getting build dependencies for sdist...
* Building sdist...
* Building wheel from sdist
* Creating venv isolated environment...
* Installing packages in isolated environment... (poetry-core)
* Getting build dependencies for wheel...
* Building wheel...
Successfully built random_wikipedia_article-0.1.0.tar.gz
 and random_wikipedia_article-0.1.0-py3-none-any.whl
</pre>








<section data-type="sect2" data-pdf-bookmark="The Project Metadata"><div class="sect2" id="id138">
<h2>The Project Metadata</h2>

<p>You may be surprised to see the project metadata appear under <code>tool.poetry</code>
instead of the familiar <code>project</code> table (see
<a data-type="xref" href="ch03.html#section_packages_project_metadata">“Project Metadata”</a>). The Poetry project plans to support the
project metadata standard in its next major release.<sup><a data-type="noteref" id="id284-marker" href="ch05.html#id284">1</a></sup> As you can see in <a data-type="xref" href="#table_poetry_metadata">Table 5-1</a>, most fields have
the same name and a similar syntax and meaning.</p>

<p><a data-type="xref" href="#example_poetry_metadata">Example 5-2</a> fills in the metadata for the project. I’ve
highlighted some differences from <a data-type="xref" href="ch03.html#example_packages_pyproject_toml_large">Example 3-4</a>.
(You’ll use the command-line interface to add the dependencies later.)</p>
<div id="example_poetry_metadata" data-type="example">
<h5><span class="label">Example 5-2. </span>Metadata for a Poetry project</h5>

<pre data-type="programlisting" data-code-language="toml"><code class="k">[</code><code class="k">tool</code><code class="k">.</code><code class="k">poetry</code><code class="k">]</code><code class="w">
</code><code class="n">name</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">random-wikipedia-article</code><code class="s2">"</code><code class="w">
</code><code class="n">version</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">0.1.0</code><code class="s2">"</code><code class="w">
</code><code class="n">description</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">Display extracts from random Wikipedia articles</code><code class="s2">"</code><code class="w">
</code><code class="n">keywords</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">[</code><code class="s2">"</code><code class="s2">wikipedia</code><code class="s2">"</code><code class="p">]</code><code class="w">
</code><code class="n">license</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">MIT</code><code class="s2">"</code><code class="w"> </code><a class="co" id="co_managing_projects_with_poetry_CO1-1" href="#callout_managing_projects_with_poetry_CO1-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a><code class="w">
</code><code class="n">classifiers</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">[</code><code class="w">
    </code><code class="s2">"</code><code class="s2">License :: OSI Approved :: MIT License</code><code class="s2">"</code><code class="p">,</code><code class="w">
    </code><code class="s2">"</code><code class="s2">Development Status :: 3 - Alpha</code><code class="s2">"</code><code class="p">,</code><code class="w">
    </code><code class="s2">"</code><code class="s2">Environment :: Console</code><code class="s2">"</code><code class="p">,</code><code class="w">
    </code><code class="s2">"</code><code class="s2">Topic :: Games/Entertainment :: Fortune Cookies</code><code class="s2">"</code><code class="p">,</code><code class="w">
</code><code class="p">]</code><code class="w">
</code><code class="n">authors</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">[</code><code class="s2">"</code><code class="s2">Your Name &lt;you@example.com&gt;</code><code class="s2">"</code><code class="p">]</code><code class="w"> </code><a class="co" id="co_managing_projects_with_poetry_CO1-2" href="#callout_managing_projects_with_poetry_CO1-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a><code class="w">
</code><code class="n">readme</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">README.md</code><code class="s2">"</code><code class="w"> </code><a class="co" id="co_managing_projects_with_poetry_CO1-3" href="#callout_managing_projects_with_poetry_CO1-3"><img src="assets/3.png" alt="3" width="12" height="12"/></a><code class="w">
</code><code class="n">homepage</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">https://yourname.dev/projects/random-wikipedia-article</code><code class="s2">"</code><code class="w"> </code><a class="co" id="co_managing_projects_with_poetry_CO1-4" href="#callout_managing_projects_with_poetry_CO1-4"><img src="assets/4.png" alt="4" width="12" height="12"/></a><code class="w">
</code><code class="n">repository</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">https://github.com/yourname/random-wikipedia-article</code><code class="s2">"</code><code class="w">
</code><code class="n">documentation</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">https://readthedocs.io/random-wikipedia-article</code><code class="s2">"</code><code class="w">
</code><code class="n">packages</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">[</code><code class="p">{</code><code class="n">include</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">random_wikipedia_article</code><code class="s2">"</code><code class="p">,</code><code class="w"> </code><code class="n">from</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">src</code><code class="s2">"</code><code class="p">}</code><code class="p">]</code><code class="w">

</code><code class="k">[</code><code class="k">tool</code><code class="k">.</code><code class="k">poetry</code><code class="k">.</code><code class="k">dependencies</code><code class="k">]</code><code class="w">
</code><code class="n">python</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">&gt;=3.10</code><code class="s2">"</code><code class="w"> </code><a class="co" id="co_managing_projects_with_poetry_CO1-5" href="#callout_managing_projects_with_poetry_CO1-5"><img src="assets/5.png" alt="5" width="12" height="12"/></a><code class="w">

</code><code class="k">[</code><code class="k">tool</code><code class="k">.</code><code class="k">poetry</code><code class="k">.</code><code class="k">urls</code><code class="k">]</code><code class="w">
</code><code class="n">Issues</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">https://github.com/yourname/random-wikipedia-article/issues</code><code class="s2">"</code><code class="w">

</code><code class="k">[</code><code class="k">tool</code><code class="k">.</code><code class="k">poetry</code><code class="k">.</code><code class="k">scripts</code><code class="k">]</code><code class="w">
</code><code class="n">random-wikipedia-article</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"</code><code class="s2">random_wikipedia_article:main</code><code class="s2">"</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" id="callout_managing_projects_with_poetry_CO1-1" href="#co_managing_projects_with_poetry_CO1-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>The <code>license</code> field is a string with a SPDX identifier, not a table.</p></dd>
<dt><a class="co" id="callout_managing_projects_with_poetry_CO1-2" href="#co_managing_projects_with_poetry_CO1-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>The <code>authors</code> field contains strings in the format <code>"name &lt;email&gt;"</code>, not
tables. Poetry pre-populates the field with your name and email from Git.</p></dd>
<dt><a class="co" id="callout_managing_projects_with_poetry_CO1-3" href="#co_managing_projects_with_poetry_CO1-3"><img src="assets/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>The <code>readme</code> field is a string with the file path. You can also specify
multiple files as an array of strings, such as <em>README.md</em> and <em>CHANGELOG.md</em>.
Poetry concatenates them with a blank line in between.</p></dd>
<dt><a class="co" id="callout_managing_projects_with_poetry_CO1-4" href="#co_managing_projects_with_poetry_CO1-4"><img src="assets/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Poetry has dedicated fields for some project URLs, namely its homepage,
repository, and documentation; for other URLs, there’s also a generic <code>urls</code>
table.</p></dd>
<dt><a class="co" id="callout_managing_projects_with_poetry_CO1-5" href="#co_managing_projects_with_poetry_CO1-5"><img src="assets/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>The <code>python</code> entry in <code>dependencies</code> lets you declare compatible Python
versions. For this project, you require Python 3.10 or later.</p></dd>
</dl>
<table id="table_poetry_metadata">
<caption><span class="label">Table 5-1. </span>Metadata fields in <code>tool.poetry</code></caption>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
<th><code>project</code> field</th>
</tr>
</thead>
<tbody>
<tr>
<td><p><code>name</code></p></td>
<td><p>string</p></td>
<td><p>The project name</p></td>
<td><p><code>name</code></p></td>
</tr>
<tr>
<td><p><code>version</code></p></td>
<td><p>string</p></td>
<td><p>The version of the project</p></td>
<td><p><code>version</code></p></td>
</tr>
<tr>
<td><p><code>description</code></p></td>
<td><p>string</p></td>
<td><p>A short description of the project</p></td>
<td><p><code>description</code></p></td>
</tr>
<tr>
<td><p><code>keywords</code></p></td>
<td><p>array of strings</p></td>
<td><p>A list of keywords for the project</p></td>
<td><p><code>keywords</code></p></td>
</tr>
<tr>
<td><p><code>readme</code></p></td>
<td><p>string or array of strings</p></td>
<td><p>A file or list of files with the project description</p></td>
<td><p><code>readme</code></p></td>
</tr>
<tr>
<td><p><code>license</code></p></td>
<td><p>string</p></td>
<td><p>A SPDX license identifier, or “Proprietary”</p></td>
<td><p><code>license</code></p></td>
</tr>
<tr>
<td><p><code>authors</code></p></td>
<td><p>array of strings</p></td>
<td><p>The list of authors</p></td>
<td><p><code>authors</code></p></td>
</tr>
<tr>
<td><p><code>maintainers</code></p></td>
<td><p>array of strings</p></td>
<td><p>The list of maintainers</p></td>
<td><p><code>maintainers</code></p></td>
</tr>
<tr>
<td><p><code>classifiers</code></p></td>
<td><p>array of strings</p></td>
<td><p>A list of classifiers describing the project</p></td>
<td><p><code>classifiers</code></p></td>
</tr>
<tr>
<td><p><code>homepage</code></p></td>
<td><p>string</p></td>
<td><p>The URL of the project homepage</p></td>
<td><p><code>urls</code></p></td>
</tr>
<tr>
<td><p><code>repository</code></p></td>
<td><p>string</p></td>
<td><p>The URL of the project repository</p></td>
<td><p><code>urls</code></p></td>
</tr>
<tr>
<td><p><code>documentation</code></p></td>
<td><p>string</p></td>
<td><p>The URL of the project documentation</p></td>
<td><p><code>urls</code></p></td>
</tr>
<tr>
<td><p><code>urls</code></p></td>
<td><p>table of strings</p></td>
<td><p>The project URLs</p></td>
<td><p><code>urls</code></p></td>
</tr>
<tr>
<td><p><code>dependencies</code></p></td>
<td><p>array of strings or tables</p></td>
<td><p>The list of required third-party packages</p></td>
<td><p><code>dependencies</code></p></td>
</tr>
<tr>
<td><p><code>extras</code></p></td>
<td><p>table of arrays of strings</p></td>
<td><p>Named lists of optional third-party packages</p></td>
<td><p><code>optional-dependencies</code></p></td>
</tr>
<tr>
<td><p><code>groups</code></p></td>
<td><p>table of arrays of strings</p></td>
<td><p>Named lists of development dependencies</p></td>
<td><p><em>none</em></p></td>
</tr>
<tr>
<td><p><code>scripts</code></p></td>
<td><p>table of strings or tables</p></td>
<td><p>Entry-point scripts</p></td>
<td><p><code>scripts</code></p></td>
</tr>
<tr>
<td><p><code>plugins</code></p></td>
<td><p>table of tables of strings</p></td>
<td><p>Entry point groups</p></td>
<td><p><code>entry-points</code></p></td>
</tr>
</tbody>
</table>

<p>Some <code>project</code> fields have no direct equivalent under <code>tool.poetry</code>:</p>

<ul>
<li>
<p>There’s no <code>requires-python</code> field; instead, you specify the required Python
version in the <code>dependencies</code> table, using the <code>python</code> key.</p>
</li>
<li>
<p>There’s no dedicated field for GUI scripts; use <code>plugins.gui_scripts</code> instead.</p>
</li>
<li>
<p>There’s no <code>dynamic</code> field—​all metadata is Poetry-specific, so declaring
dynamic fields wouldn’t make much sense.</p>
</li>
</ul>

<p>Before we move on, let’s check that the <em>pyproject.toml</em> file is valid. Poetry
provides a convenient command to validate the TOML file against its
configuration schema:</p>
<pre data-type="programlisting">$ <strong>poetry check</strong>
All set!
</pre>
</div></section>








<section data-type="sect2" data-pdf-bookmark="The Package Contents"><div class="sect2" id="id139">
<h2>The Package Contents</h2>

<p>Poetry allows you to specify which files and directories to include in the
distribution—​a feature still missing from the <em>pyproject.toml</em> standards
(<a data-type="xref" href="#table_poetry_contents">Table 5-2</a>).</p>
<table id="table_poetry_contents">
<caption><span class="label">Table 5-2. </span>Package content fields in <code>tool.poetry</code></caption>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><p><code>packages</code></p></td>
<td><p>array of tables</p></td>
<td><p>Patterns for modules to include in the distribution</p></td>
</tr>
<tr>
<td><p><code>include</code></p></td>
<td><p>array of strings or tables</p></td>
<td><p>Patterns for files to include in the distribution</p></td>
</tr>
<tr>
<td><p><code>exclude</code></p></td>
<td><p>array of strings or tables</p></td>
<td><p>Patterns for files to exclude from the distribution</p></td>
</tr>
</tbody>
</table>

<p>Each table under <code>packages</code> has an <code>include</code> key with a file or directory. You
can use <code>*</code> and <code>**</code> wildcards in their names and paths, respectively. The
<code>from</code> key allows you to include modules from subdirectories such as <em>src</em>.
Finally, you can use the <code>format</code> key to restrict modules to a specific
distribution format; valid values are <code>sdist</code> and <code>wheel</code>.</p>

<p>The <code>include</code> and <code>exclude</code> fields allow you to list other files to include in,
or exclude from, the distribution. Poetry seeds the <code>exclude</code> field using the
<em>.gitignore</em> file, if present. Instead of a string, you can also use a table
with <code>path</code> and <code>format</code> keys for sdist-only or wheel-only files.
<a data-type="xref" href="#example_poetry_sdist_with_tests">Example 5-3</a> shows how to include the test suite in
source distributions.</p>
<div id="example_poetry_sdist_with_tests" data-type="example">
<h5><span class="label">Example 5-3. </span>Including the test suite in source distributions</h5>

<pre data-type="programlisting" data-code-language="toml"><code class="n">packages</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">[{</code><code class="n">include</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="s2">"random_wikipedia_article"</code><code class="p">,</code><code class="w"> </code><code class="n">from</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="s2">"src"</code><code class="p">}]</code><code class="w"/>
<code class="n">include</code><code class="w">  </code><code class="o">=</code><code class="w"> </code><code class="p">[{</code><code class="n">path</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="s2">"tests"</code><code class="p">,</code><code class="w"> </code><code class="n">format</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="s2">"sdist"</code><code class="p">}]</code><code class="w"/></pre></div>
</div></section>








<section data-type="sect2" data-pdf-bookmark="The Source Code"><div class="sect2" id="id140">
<h2>The Source Code</h2>

<p>Copy the contents of <a data-type="xref" href="#example_poetry_wikipedia_full">Example 5-4</a> into the
<em>__init__.py</em> file in the new project.</p>
<div id="example_poetry_wikipedia_full" data-type="example">
<h5><span class="label">Example 5-4. </span>The source code for <code>random-wikipedia-article</code></h5>

<pre data-type="programlisting" data-code-language="python"><code class="kn">import</code> <code class="nn">httpx</code>
<code class="kn">from</code> <code class="nn">rich.console</code> <code class="kn">import</code> <code class="n">Console</code>

<code class="kn">from</code> <code class="nn">importlib.metadata</code> <code class="kn">import</code> <code class="n">metadata</code>

<code class="n">API_URL</code> <code class="o">=</code> <code class="s2">"https://en.wikipedia.org/api/rest_v1/page/random/summary"</code>
<code class="n">USER_AGENT</code> <code class="o">=</code> <code class="s2">"</code><code class="si">{Name}</code><code class="s2">/</code><code class="si">{Version}</code><code class="s2"> (Contact: {Author-email})"</code>

<code class="k">def</code> <code class="nf">main</code><code class="p">():</code>
    <code class="n">fields</code> <code class="o">=</code> <code class="n">metadata</code><code class="p">(</code><code class="s2">"random-wikipedia-article"</code><code class="p">)</code>
    <code class="n">headers</code> <code class="o">=</code> <code class="p">{</code><code class="s2">"User-Agent"</code><code class="p">:</code> <code class="n">USER_AGENT</code><code class="o">.</code><code class="n">format_map</code><code class="p">(</code><code class="n">fields</code><code class="p">)}</code>

    <code class="k">with</code> <code class="n">httpx</code><code class="o">.</code><code class="n">Client</code><code class="p">(</code><code class="n">headers</code><code class="o">=</code><code class="n">headers</code><code class="p">,</code> <code class="n">http2</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code> <code class="k">as</code> <code class="n">client</code><code class="p">:</code>
        <code class="n">response</code> <code class="o">=</code> <code class="n">client</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">API_URL</code><code class="p">,</code> <code class="n">follow_redirects</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code>
        <code class="n">response</code><code class="o">.</code><code class="n">raise_for_status</code><code class="p">()</code>
        <code class="n">data</code> <code class="o">=</code> <code class="n">response</code><code class="o">.</code><code class="n">json</code><code class="p">()</code>

    <code class="n">console</code> <code class="o">=</code> <code class="n">Console</code><code class="p">(</code><code class="n">width</code><code class="o">=</code><code class="mi">72</code><code class="p">,</code> <code class="n">highlight</code><code class="o">=</code><code class="kc">False</code><code class="p">)</code>
    <code class="n">console</code><code class="o">.</code><code class="n">print</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s2">"title"</code><code class="p">],</code> <code class="n">style</code><code class="o">=</code><code class="s2">"bold"</code><code class="p">,</code> <code class="n">end</code><code class="o">=</code><code class="s2">"</code><code class="se">\n\n</code><code class="s2">"</code><code class="p">)</code>
    <code class="n">console</code><code class="o">.</code><code class="n">print</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s2">"extract"</code><code class="p">])</code></pre></div>

<p>You’ve declared an entry-point script in the <code>scripts</code> section in
<em>pyproject.toml</em>, so users can invoke the application as
<code>random-wikipedia-article</code>. If you’d like to also allow users to invoke the
program with <code>py -m random_wikipedia_article</code>, create a <em>__main__.py</em>
module next to <em>__init__.py</em> as shown in <a data-type="xref" href="ch03.html#example_packages_main">Example 3-3</a>.</p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Managing Dependencies"><div class="sect1" id="section_poetry_dependencies">
<h1>Managing Dependencies</h1>

<p>Let’s add the dependencies for <code>random-wikipedia-article</code>, starting with Rich,
the console output library:</p>
<pre data-type="programlisting">$ <strong>poetry add rich</strong>
Using version ^13.7.1 for rich

Updating dependencies
Resolving dependencies... (0.2s)

Package operations: 4 installs, 0 updates, 0 removals

  - Installing mdurl (0.1.2)
  - Installing markdown-it-py (3.0.0)
  - Installing pygments (2.17.2)
  - Installing rich (13.7.1)

Writing lock file
</pre>

<p>If you inspect <em>pyproject.toml</em> after running this command, you’ll find that
Poetry has added Rich to the <code>dependencies</code> table
(<a data-type="xref" href="#example_poetry_dependencies_rich">Example 5-5</a>):</p>
<div id="example_poetry_dependencies_rich" data-type="example">
<h5><span class="label">Example 5-5. </span>The <code>dependencies</code> table after adding Rich</h5>

<pre data-type="programlisting" data-code-language="toml"><code class="k">[tool.poetry.dependencies]</code><code class="w"/>
<code class="n">python</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"&gt;=3.10"</code><code class="w"/>
<code class="n">rich</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"^13.7.1"</code><code class="w"/></pre></div>

<p>Poetry also installs the package into an environment for the project. If you
already have a virtual environment in <em>.venv</em>, Poetry uses that. Otherwise, it
creates a virtual environment in a shared location (see
<a data-type="xref" href="#section_poetry_environments">“Managing Environments”</a>).</p>








<section data-type="sect2" data-pdf-bookmark="Caret Constraints"><div class="sect2" id="id142">
<h2>Caret Constraints</h2>

<p>The caret (<code>^</code>) is a Poetry-specific extension to version specifiers, borrowed
from npm, the package manager for Node.js. <em>Caret constraints</em> allow releases
with the given minimum version, except those that may contain breaking changes
according to the <a href="https://semver.org">Semantic Versioning</a> standard. After
<code>1.0.0</code>, a caret constraint allows patch and minor releases, but no major
releases. Before <code>1.0.0</code>, only patch releases are allowed—​in the <code>0.*</code> era,
minor releases are allowed to introduce breaking changes.</p>

<p>Caret constraints are similar to <em>tilde constraints</em> (see
<a data-type="xref" href="ch04.html#section_dependencies_version_specifiers">“Version Specifiers”</a>), but the latter only allow the last
version segment to increase. For example, the following constraints are
equivalent:</p>

<pre data-type="programlisting" data-code-language="toml"><code class="n">rich</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"^13.7.1"</code><code class="w"/>
<code class="n">rich</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"&gt;=13.7.1,&lt;14"</code><code class="w"/></pre>

<p>On the other hand, tilde constraints typically exclude minor releases:</p>

<pre data-type="programlisting" data-code-language="toml"><code class="n">rich</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"~13.7.1"</code><code class="w"/>
<code class="n">rich</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"&gt;=13.7.1,==13.7.*"</code><code class="w"/></pre>

<p>Caret constraints put an upper bound on the version. As explained in
<a data-type="xref" href="ch04.html#sidebar_dependencies_upper_version_bounds">“Upper Version Bounds in Python”</a>, you should avoid upper bounds if
you can. Add Rich with only a lower bound instead:</p>
<pre data-type="programlisting">$ <strong>poetry add "rich&gt;=13.7.1"</strong></pre>

<p>You can use this command to remove upper bounds from existing caret constraints,
as well.<sup><a data-type="noteref" id="id285-marker" href="ch05.html#id285">2</a></sup> If you
specified extras or markers when you first added the dependency, you’ll need to
specify them again.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id286">
<h1>Should You Cap Dependencies?</h1>
<p>It’s unfortunate that Poetry adds upper bounds to dependencies by default. For
libraries, the practice prevents downstream users from receiving fixes and
improvements, since constraints aren’t scoped to the packages that introduce
them, as in Node.js. Many open source projects don’t have the resources to
backport fixes to past releases. For applications, lock files provide a better
way to achieve reliable deployments.</p>

<p>The situation is similar but worse for the Python requirement. Excluding Python
4 by default will cause disruption across the ecosystem when the core Python
team eventually releases a new major version. It’s unlikely that Python 4 will
come anywhere near Python 3 in terms of incompatible changes. Poetry’s
constraint is contagious in the sense that dependent packages must also
introduce it. And it’s impossible for Python package installers to satisfy—​they
can’t downgrade the environment to an earlier version of Python.</p>

<p>Whenever possible, replace caret constraints with lower bounds (<code>&gt;=</code>),
especially for Python itself. After editing <em>pyproject.toml</em>, refresh the lock
file using the command <code>poetry lock --no-update</code>.</p>
</div></aside>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Extras and Environment Markers"><div class="sect2" id="id143">
<h2>Extras and Environment Markers</h2>

<p>Let’s add the other dependency of <code>random-wikipedia-article</code>, the HTTP client
library <code>httpx</code>. Like in <a data-type="xref" href="ch04.html#chapter_dependencies">Chapter 4</a>, you’ll activate the <code>http2</code>
extra for HTTP/2 support.</p>
<pre data-type="programlisting">$ <strong>poetry add "httpx&gt;=0.27.0" --extras=http2</strong></pre>

<p>Poetry updates the <em>pyproject.toml</em> file accordingly:</p>

<pre data-type="programlisting" data-code-language="toml"><code class="k">[tool.poetry.dependencies]</code><code class="w"/>
<code class="n">python</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"&gt;=3.10"</code><code class="w"/>
<code class="n">rich</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"&gt;=13.7.1"</code><code class="w"/>
<code class="n">httpx</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">{</code><code class="n">version</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="s2">"&gt;=0.27.0"</code><code class="p">,</code><code class="w"> </code><code class="n">extras</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="p">[</code><code class="s2">"http2"</code><code class="p">]}</code><code class="w"/></pre>

<p>The project requires a recent Python version, so it doesn’t require the
<code>importlib-metadata</code> backport. If you had to support Python versions before 3.8,
here’s how you’d add the library for those versions:</p>
<pre data-type="programlisting">$ <strong>poetry add "importlib-metadata&gt;=7.0.2" --python="&lt;3.8"</strong></pre>

<p>Besides <code>--python</code>, the <code>poetry add</code> command supports a <code>--platform</code> option to
restrict dependencies to a specific operating system, such as Windows. This
option accepts a platform identifier in the format used by the standard
<code>sys.platform</code> attribute: <code>linux</code>, <code>darwin</code>, <code>win32</code>. For other environment
markers, edit <em>pyproject.toml</em> and use the <code>markers</code> property in the TOML table
for the dependency:</p>

<pre data-type="programlisting" data-code-language="toml"><code class="k">[tool.poetry.dependencies]</code><code class="w"/>
<code class="n">awesome</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">{</code><code class="n">version</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="s2">"&gt;=1"</code><code class="p">,</code><code class="w"> </code><code class="n">markers</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="s2">"implementation_name == 'pypy'"</code><code class="p">}</code><code class="w"/></pre>
</div></section>








<section data-type="sect2" data-pdf-bookmark="The Lock File"><div class="sect2" id="id144">
<h2>The Lock File</h2>

<p>Poetry records the current version of each dependency in a file named
<em>poetry.lock</em>, including SHA256 hashes for its packaging artifacts. If you take
a peek inside the file, you’ll notice TOML stanzas for <code>rich</code> and <code>httpx</code>, as
well as their direct and indirect dependencies. <a data-type="xref" href="#example_poetry_lockfile_rich">Example 5-6</a>
shows a simplified version of Rich’s lock entry.</p>
<div id="example_poetry_lockfile_rich" data-type="example">
<h5><span class="label">Example 5-6. </span>The TOML stanza for Rich in <em>poetry.lock</em> (simplified)</h5>

<pre data-type="programlisting" data-code-language="toml"><code class="k">[[package]]</code><code class="w"/>
<code class="n">name</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"rich"</code><code class="w"/>
<code class="n">version</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"13.7.1"</code><code class="w"/>
<code class="n">python-versions</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"&gt;=3.7.0"</code><code class="w"/>
<code class="n">dependencies</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">{</code><code class="n">markdown-it-py</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="s2">"&gt;=2.2.0"</code><code class="p">,</code><code class="w"> </code><code class="n">pygments</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="s2">"&gt;=2.13.0,&lt;3.0.0"</code><code class="p">}</code><code class="w"/>
<code class="n">files</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">[</code><code class="w"/>
<code class="w">    </code><code class="p">{</code><code class="n">file</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="s2">"rich-13.7.1-py3-none-any.whl"</code><code class="p">,</code><code class="w"> </code><code class="n">hash</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="s2">"sha256:4edbae3..."</code><code class="p">},</code><code class="w"/>
<code class="w">    </code><code class="p">{</code><code class="n">file</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="s2">"rich-13.7.1.tar.gz"</code><code class="p">,</code><code class="w"> </code><code class="n">hash</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="s2">"sha256:9be308c..."</code><code class="p">},</code><code class="w"/>
<code class="p">]</code><code class="w"/></pre></div>

<p>Use the command <code>poetry show</code> to display the locked dependencies in the
terminal. Here’s what the output looked like after I added Rich:</p>
<pre data-type="programlisting">$ <strong>poetry show</strong>
markdown-it-py 3.0.0  Python port of markdown-it. Markdown parsing, done right!
mdurl          0.1.2  Markdown URL utilities
pygments       2.17.2 Pygments is a syntax highlighting package written in Python.
rich           13.7.1 Render rich text, tables, progress bars, ...
</pre>

<p>You can also display the dependencies as a tree to visualize their relationship:</p>
<pre data-type="programlisting">$ <strong>poetry show --tree</strong>
rich 13.7.1 Render rich text, tables, progress bars, ...
├── markdown-it-py &gt;=2.2.0
│   └── mdurl &gt;=0.1,&lt;1.0
└── pygments &gt;=2.13.0,&lt;3.0.0
</pre>

<p>If you edit <em>pyproject.toml</em> yourself, remember to update the lock file to
reflect your changes:</p>
<pre data-type="programlisting">$ <strong>poetry lock --no-update</strong>
Resolving dependencies... (0.1s)

Writing lock file
</pre>

<p>Without the <code>--no-update</code> option, Poetry upgrades each locked dependency to the
latest version covered by its constraint.</p>

<p>You can check if the <em>poetry.lock</em> file is consistent with <em>pyproject.toml</em>:</p>
<pre data-type="programlisting">$ <strong>poetry check --lock</strong>
</pre>

<p>Resolving dependencies up front lets you deploy applications in a reliable and
reproducible manner. It also gives developers in a team a common baseline and
makes checks more deterministic—​avoiding surprises in continuous integration
(CI). You should commit <em>poetry.lock</em> to source control to reap these benefits.</p>

<p>Poetry’s lock file is designed to work across operating systems and Python
interpreters. Having a single environment-independent, or “universal”, lock file
is beneficial if your code must run in diverse environments, or if you’re an
open source maintainer with contributors from all over the world.</p>

<p>By contrast, compiled requirements files quickly become unwieldy. If your
project supports Windows, macOS, and Linux on the four most recent feature
versions of Python, you’ll need to manage a dozen requirements files. Adding
another processor architecture or Python implementation only makes things worse.</p>

<p>Universal lock files come at a price, however. Poetry re-resolves dependencies
when it installs the packages into an environment. Its lock file is essentially
a shrunken world view: it records every package the project might require in a
given environment. By contrast, compiled requirements are an exact image of an
environment. This makes them more amenable to auditing and more attractive for
secure deployments.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Updating Dependencies"><div class="sect2" id="id145">
<h2>Updating Dependencies</h2>

<p>You can update all dependencies in the lock file to their latest versions using
a single command:</p>
<pre data-type="programlisting">$ <strong>poetry update</strong>
</pre>

<p>You can also provide a specific direct or indirect dependency to update:</p>
<pre data-type="programlisting">$ <strong>poetry update rich</strong>
</pre>

<p>The <code>poetry update</code> command doesn’t modify the project metadata in
<em>pyproject.toml</em>. It only updates dependencies within the compatible version
range. If you need to update the version range, use <code>poetry add</code> with the new
constraint, including any extras and markers. Alternatively, edit
<em>pyproject.toml</em> and refresh the lock file with <code>poetry lock --no-update</code>.</p>

<p>If you no longer need a package for your project, remove it with <code>poetry
remove</code>:</p>
<pre data-type="programlisting">$ <strong>poetry remove <em>&lt;package&gt;</em></strong>
</pre>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Managing Environments"><div class="sect1" id="section_poetry_environments">
<h1>Managing Environments</h1>

<p>Poetry’s <code>add</code>, <code>update</code>, and <code>remove</code> commands don’t just update dependencies
in the <em>pyproject.toml</em> and <em>poetry.lock</em> files. They also synchronize the
project environment with the lock file by installing, updating, or removing
packages. Poetry creates the virtual environment for the project on demand.</p>

<p>By default, Poetry stores the environments for all projects in a shared folder.
Configure Poetry to keep the environment in a <em>.venv</em> directory inside the
project instead:</p>
<pre data-type="programlisting">$ <strong>poetry config virtualenvs.in-project true</strong>
</pre>

<p>This setting makes the environment discoverable for other tools in the
ecosystem, such as <code>py</code> and <code>uv</code>. Having the directory in the project is
convenient when you need to examine its contents. Although the setting restricts
you to a single environment, this limitation is seldom a concern. Tools like Nox
and tox are tailor-made for testing across multiple environments (see
<a data-type="xref" href="ch08.html#chapter_nox">Chapter 8</a>).</p>

<p>You can check the location of the current environment using the command <code>poetry
env info --path</code>. If you want to create a clean slate for your project, use the
following commands to remove existing environments and create a new one using
the specified Python version:</p>
<pre data-type="programlisting">$ <strong>poetry env remove --all</strong>
$ <strong>poetry env use 3.12</strong>
</pre>

<p>You can re-run the second command to re-create the environment on a different
interpreter. Instead of a version like <code>3.12</code>, you can also pass a command like
<code>pypy3</code> for the PyPy interpreter or a full path like <code>/usr/bin/python3</code> for the
system Python.</p>

<p>Before you use the environment, you should install the project. Poetry performs
editable installs, so the environment reflects any code changes immediately:</p>
<pre data-type="programlisting">$ <strong>poetry install</strong>
</pre>

<p>Enter the project environment by launching a shell session with <code>poetry shell</code>.
Poetry activates the virtual environment using the activation script for your
current shell. With the environment activated, you can run the application from
the shell prompt. Just exit the shell session when you’re done:</p>
<pre data-type="programlisting">$ <strong>poetry shell</strong>
(random-wikipedia-article-py3.12) $ <strong>random-wikipedia-article</strong>
(random-wikipedia-article-py3.12) $ <strong>exit</strong>
</pre>

<p>You can also run the application in your current shell session, using the
command <code>poetry run</code>:</p>
<pre data-type="programlisting">$ <strong>poetry run random-wikipedia-article</strong>
</pre>

<p>The command is also handy for starting an interactive Python session in the
project environment:</p>
<pre data-type="programlisting">$ <strong>poetry run python</strong>
&gt;&gt;&gt; <strong>from random_wikipedia_article import main</strong>
&gt;&gt;&gt; <strong>main()</strong>
</pre>

<p>When you run a program with <code>poetry run</code>, Poetry activates the virtual
environment without launching a shell. This works by adding the environment to
the program’s <code>PATH</code> and <code>VIRTUAL_ENV</code> variables (see
<a data-type="xref" href="ch02.html#section_environments_activation">“Activation scripts”</a>).</p>
<div data-type="tip"><h6>Tip</h6>
<p>Just type <code>py</code> to get a Python session for your Poetry project on Linux and
macOS. This requires the Python Launcher for Unix, and you must configure Poetry
to use in-project environments.</p>
</div>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Dependency Groups"><div class="sect1" id="section_poetry_development_dependencies">
<h1>Dependency Groups</h1>

<p>Poetry allows you to declare development dependencies, organized in dependency
groups. Dependency groups aren’t part of the project metadata and are invisible
to end users. Let’s add the dependency groups from <a data-type="xref" href="ch04.html#section_dependencies_development">“Development Dependencies”</a>:</p>
<pre data-type="programlisting">$ <strong>poetry add --group=tests pytest pytest-sugar</strong>
$ <strong>poetry add --group=docs sphinx</strong>
</pre>

<p>Poetry adds the dependency groups under the <code>group</code> table in <em>pyproject.toml</em>:</p>

<pre data-type="programlisting" data-code-language="toml"><code class="k">[tool.poetry.group.tests.dependencies]</code><code class="w"/>
<code class="n">pytest</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"^8.1.1"</code><code class="w"/>
<code class="n">pytest-sugar</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"^1.0.0"</code><code class="w"/>

<code class="k">[tool.poetry.group.docs.dependencies]</code><code class="w"/>
<code class="n">sphinx</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"^7.2.6"</code><code class="w"/></pre>

<p>Dependency groups are installed into the project environment by default. You can
mark a group as optional using its <code>optional</code> key, like this:</p>

<pre data-type="programlisting" data-code-language="toml"><code class="k">[tool.poetry.group.docs]</code><code class="w"/>
<code class="n">optional</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">true</code><code class="w"/>

<code class="k">[tool.poetry.group.docs.dependencies]</code><code class="w"/>
<code class="n">sphinx</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"^7.2.6"</code><code class="w"/></pre>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>Don’t specify the <code>--optional</code> flag when you add a dependency group with <code>poetry
add</code>—it doesn’t mark the group as optional. The option designates optional
dependencies that are behind an extra; it has no valid use in the context of
dependency groups.</p>
</div>

<p>The <code>poetry install</code> command has several options that provide finer-grained
control over which dependencies are installed into the project environment
(<a data-type="xref" href="#table_poetry_install_options">Table 5-3</a>).</p>
<table id="table_poetry_install_options">
<caption><span class="label">Table 5-3. </span>Installing dependencies with <code>poetry install</code></caption>
<thead>
<tr>
<th>Option</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><p><code>--with=<em>&lt;group&gt;</em></code></p></td>
<td><p>Include a dependency group in the installation.</p></td>
</tr>
<tr>
<td><p><code>--without=<em>&lt;group&gt;</em></code></p></td>
<td><p>Exclude a dependency group from the installation.</p></td>
</tr>
<tr>
<td><p><code>--only=<em>&lt;group&gt;</em></code></p></td>
<td><p>Exclude all other dependency groups from the installation.</p></td>
</tr>
<tr>
<td><p><code>--no-root</code></p></td>
<td><p>Exclude the project itself from the installation.</p></td>
</tr>
<tr>
<td><p><code>--only-root</code></p></td>
<td><p>Exclude all dependencies from the installation.</p></td>
</tr>
<tr>
<td><p><code>--sync</code></p></td>
<td><p>Remove packages from the environment unless scheduled for installation.</p></td>
</tr>
</tbody>
</table>

<p>You can specify a single group or multiple groups (separated by commas). The
special group <code>main</code> refers to packages listed in the <code>tool.poetry.dependencies</code>
table. Use the option <code>--only=main</code> to exclude all development dependencies from
an installation. Similarly, the option <code>--without=main</code> lets you restrict an
installation to development dependencies.</p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Package Repositories"><div class="sect1" id="id148">
<h1>Package Repositories</h1>

<p>Poetry lets you upload your packages to the Python Package Index (PyPI) and
other package repositories. It also lets you configure the repositories from
which you add packages to your project. This section looks at both the publisher
and the consumer sides of interacting with package repositories.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>If you’re following along in this section, please don’t upload the example
project to PyPI. Use the TestPyPI repository instead—​it’s a playground for
testing, learning, and experimentation.</p>
</div>








<section data-type="sect2" data-pdf-bookmark="Publishing Packages to Package Repositories"><div class="sect2" id="id149">
<h2>Publishing Packages to Package Repositories</h2>

<p>Before you can upload packages to PyPI, you need an account and an API token to
authenticate with the repository, as explained in <a data-type="xref" href="ch03.html#section_packages_twine">“Uploading Packages with Twine”</a>.
Next, add the API token to Poetry:</p>
<pre data-type="programlisting">$ <strong>poetry config pypi-token.pypi <em>&lt;token&gt;</em></strong>
</pre>

<p>You can create packages for a Poetry project using standard tooling like <code>build</code>
or with Poetry’s command-line interface:</p>
<pre data-type="programlisting">$ <strong>poetry build</strong>
Building random-wikipedia-article (0.1.0)
  - Building sdist
  - Built random_wikipedia_article-0.1.0.tar.gz
  - Building wheel
  - Built random_wikipedia_article-0.1.0-py3-none-any.whl
</pre>

<p>Like <code>build</code>, Poetry places the packages in the <em>dist</em> directory. You can
publish the packages in <em>dist</em> using <code>poetry publish</code>:</p>
<pre data-type="programlisting">$ <strong>poetry publish</strong>
</pre>

<p>You can also collapse the two commands into one:</p>
<pre data-type="programlisting">$ <strong>poetry publish --build</strong>
</pre>

<p>Let’s upload the example project to TestPyPI, a separate instance of the Python
Package Index for testing distributions. If you want to upload packages to a
repository other than PyPI, you need to add the repository to your Poetry
configuration:</p>
<pre data-type="programlisting">$ <strong>poetry config repositories.testpypi https://test.pypi.org/legacy/</strong>
</pre>

<p>First, create an account and an API token on TestPyPI. Next, configure Poetry to
use that token when uploading to TestPyPI:</p>
<pre data-type="programlisting">$ <strong>poetry config pypi-token.testpypi <em>&lt;token&gt;</em></strong>
</pre>

<p>You can now specify the repository when publishing your project. Feel free to
try this out with your own version of the example project:</p>
<pre data-type="programlisting">$ <strong>poetry publish --repository=testpypi</strong>
Publishing random-wikipedia-article (0.1.0) to TestPyPI
 - Uploading random_wikipedia_article-0.1.0-py3-none-any.whl 100%
 - Uploading random_wikipedia_article-0.1.0.tar.gz 100%
</pre>

<p>Some package repositories use HTTP basic authentication with a username and
password. You can configure the credentials for such a repository like this:</p>
<pre data-type="programlisting">$ <strong>poetry config http-basic.<em>&lt;repo&gt;</em> <em>&lt;username&gt;</em></strong>
</pre>

<p>The command prompts you for the password and stores it in the system keyring, if
available, or in the <em>auth.toml</em> file on disk.</p>

<p>Alternatively, you can also configure a repository via environment variables
(replace <code><em>&lt;REPO&gt;</em></code> with the repository name in
uppercase, such as <code>PYPI</code>):</p>
<pre data-type="programlisting">$ <strong>export POETRY_REPOSITORIES_<em>&lt;REPO&gt;</em>_URL=<em>&lt;url&gt;</em></strong>
$ <strong>export POETRY_PYPI_TOKEN_<em>&lt;REPO&gt;</em>=<em>&lt;token&gt;</em></strong>
$ <strong>export POETRY_HTTP_BASIC_<em>&lt;REPO&gt;</em>_USERNAME=<em>&lt;username&gt;</em></strong>
$ <strong>export POETRY_HTTP_BASIC_<em>&lt;REPO&gt;</em>_PASSWORD=<em>&lt;password&gt;</em></strong>
</pre>

<p>Poetry also supports repositories that are secured by mutual TLS or use a custom
certificate authority; see the
<a href="https://python-poetry.org/docs/repositories/">official documentation</a> for
details.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Fetching Packages from Package Sources"><div class="sect2" id="id150">
<h2>Fetching Packages from Package Sources</h2>

<p>Above, you’ve seen how to upload your package to repositories other than PyPI.
Poetry also supports alternate repositories on the consumer side: you can add
packages to your project from sources other than PyPI. While upload targets are
a user setting and stored in the Poetry configuration, package sources are a
project setting, stored in <em>pyproject.toml</em>.</p>

<p>Add a package source using the command <code>poetry source add</code>:</p>
<pre data-type="programlisting">$ <strong>poetry source add <em>&lt;repo&gt;</em> <em>&lt;url&gt;</em> --priority=supplemental</strong>
</pre>

<p>Poetry searches supplemental sources if the package wasn’t found on PyPI. If you
want to disable PyPI, configure a primary source instead (the default priority):</p>
<pre data-type="programlisting">$ <strong>poetry source add <em>&lt;repo&gt;</em> <em>&lt;url&gt;</em></strong>
</pre>

<p>You configure credentials for package sources just like you do for repositories:</p>
<pre data-type="programlisting">$ <strong>poetry config http-basic.<em>&lt;repo&gt;</em> <em>&lt;username&gt;</em></strong>
</pre>

<p>You can now add packages from the alternate source:</p>
<pre data-type="programlisting">$ <strong>poetry add httpx --source=<em>&lt;repo&gt;</em></strong>
</pre>

<p>The following command lists the package sources for the project:</p>
<pre data-type="programlisting">$ <strong>poetry source show</strong>
</pre>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>Specify the source when adding packages from supplemental sources. Otherwise,
Poetry searches all sources when looking up a package. An attacker could upload
a malicious package to PyPI with the same name as your internal package
(<em>dependency confusion attack</em>).</p>
</div>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Extending Poetry with Plugins"><div class="sect1" id="id151">
<h1>Extending Poetry with Plugins</h1>

<p>Poetry comes with a plugin system that lets you extend its functionality. Use
pipx to inject the plugin into Poetry’s environment:</p>
<pre data-type="programlisting">$ <strong>pipx inject poetry <em>&lt;plugin&gt;</em></strong>
</pre>

<p>Replace <code><em>&lt;plugin&gt;</em></code> with the name of the plugin on PyPI.</p>

<p>If the plugin affects the build stage of your project, add it to the build
dependencies in <em>pyproject.toml</em>, as well. See
<a data-type="xref" href="#section_poetry_dynamic_versioning">“The Dynamic Versioning Plugin”</a> for an example.</p>

<p>By default, pipx upgrades applications without the injected packages. Use the
option <code>--include-injected</code> to also upgrade application plugins:</p>
<pre data-type="programlisting">$ <strong>pipx upgrade --include-injected poetry</strong>
</pre>

<p>If you no longer need the plugin, remove it from the injected packages:</p>
<pre data-type="programlisting">$ <strong>pipx uninject poetry <em>&lt;plugin&gt;</em></strong>
</pre>

<p>If you’re no longer sure which plugins you have installed, list them like this:</p>
<pre data-type="programlisting">$ <strong>poetry self show plugins</strong>
</pre>

<p>In this section, I’ll introduce you to three useful plugins for Poetry:</p>

<ul>
<li>
<p><code>poetry-plugin-export</code> allows you to generate requirements and constraints files</p>
</li>
<li>
<p><code>poetry-plugin-bundle</code> lets you deploy the project to a virtual environment</p>
</li>
<li>
<p><code>poetry-dynamic-versioning</code> populates the project version from the VCS</p>
</li>
</ul>








<section data-type="sect2" data-pdf-bookmark="Generating Requirements Files with the Export Plugin"><div class="sect2" id="id152">
<h2>Generating Requirements Files with the Export Plugin</h2>

<p>Poetry’s lock file is great to ensure that everybody on your team, and every
deployment environment, ends up with the same dependencies. But what do you do
if you can’t use Poetry in some context? For example, you may need to deploy
your project on a system that only has a Python interpreter and the bundled pip.</p>

<p>As of this writing, there’s no lock file standard in the wider Python world;
each packaging tool that supports lock files implements its own
format.<sup><a data-type="noteref" id="id287-marker" href="ch05.html#id287">3</a></sup> None of these lock file formats has support
in pip. But we do have requirements files.</p>

<p>Requirements files let you pin packages to an exact version, require their
artifacts to match cryptographic hashes, and use environment markers to restrict
packages to specific Python versions and platforms. Wouldn’t it be nice if you
could generate one from your <em>poetry.lock</em>, for interoperability with non-Poetry
environments? This is precisely what the export plugin achieves.</p>

<p>Install the plugin with pipx:</p>
<pre data-type="programlisting">$ <strong>pipx inject poetry poetry-plugin-export</strong>
</pre>

<p>The plugin powers the <code>poetry export</code> command, which sports a <code>--format</code> option
to specify the output format. By default, the command writes to the standard
output stream; use the <code>--output</code> option to specify a destination file.</p>
<pre data-type="programlisting">$ <strong>poetry export --format=requirements.txt --output=requirements.txt</strong>
</pre>

<p>Distribute the requirements file to the target system and use pip to install the
dependencies (typically followed by installing a wheel of your project).</p>
<pre data-type="programlisting">$ <strong>python3 -m pip install -r requirements.txt</strong>
</pre>

<p>Exporting to requirements format is useful beyond deploying. Many tools work
with requirements files as the de-facto industry standard. For example, you can
scan a requirements file for dependencies with known security vulnerabilities
using a tool like <a href="https://pyup.io/safety/">safety</a>.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Deploying Environments with the Bundle Plugin"><div class="sect2" id="id153">
<h2>Deploying Environments with the Bundle Plugin</h2>

<p>In the previous section, you saw how to deploy your project on a system without
Poetry. If you do have Poetry available, you might be wondering: can you just
deploy with <code>poetry install</code>? You could, but Poetry performs an editable install
of your project—​you’ll be running your application from the source tree. That
may not be acceptable in a production environment. Editable installs also limit
your ability to ship the virtual environment to another destination.</p>

<p>The bundle plugin allows you to deploy your project and locked dependencies to a
virtual environment of your choosing. It creates the environment, installs the
dependencies from the lock file, then builds and installs a wheel of your
project.</p>

<p>Install the plugin with pipx:</p>
<pre data-type="programlisting">$ <strong>pipx inject poetry poetry-plugin-bundle</strong>
</pre>

<p>After installation, you’ll see a new <code>poetry bundle</code> subcommand. Let’s use that
to bundle the project into a virtual environment in a directory named <em>app</em>. Use
the <code>--python</code> option to specify the interpreter for the environment, and the
option <code>--only=main</code> to exclude development dependencies.</p>
<pre data-type="programlisting">$ <strong>poetry bundle venv --python=/usr/bin/python3 --only=main app</strong>

  - Bundled random-wikipedia-article (0.1.0) into app
</pre>

<p>Test the environment by running the entry-point script for the
application.<sup><a data-type="noteref" id="id288-marker" href="ch05.html#id288">4</a></sup></p>
<pre data-type="programlisting">$ <strong>app/bin/random-wikipedia-article</strong>
</pre>

<p>You can use the bundle plugin to create a minimal Docker image for production.
Docker supports <em>multi-stage builds</em>, where the first stage builds the
application in a full-fledged build environment, and the second stage copies the
build artifacts over into a minimal runtime environment. This allows you to ship
slim images to production, speeding up deployments and reducing bloat and
potential vulnerabilities in your production environments.</p>

<p>In <a data-type="xref" href="#example_docker_poetry_bundle">Example 5-7</a>, the first stage installs Poetry and the
bundle plugin, copies the Poetry project, and bundles it into a self-contained
virtual environment. The second stage copies the virtual environment into a
minimal Python image.</p>
<div id="example_docker_poetry_bundle" data-type="example">
<h5><span class="label">Example 5-7. </span>Multi-stage Dockerfile with Poetry</h5>

<pre data-type="programlisting" data-code-language="docker"><code class="k">FROM</code><code class="w"> </code><code class="s">debian:12-slim</code><code class="w"> </code><code class="k">AS</code><code class="w"> </code><code class="s">builder</code><code class="w"> </code><a class="co" id="co_managing_projects_with_poetry_CO2-1" href="#callout_managing_projects_with_poetry_CO2-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a><code class="w">
</code><code class="k">RUN</code><code class="w"> </code><code>apt-get</code><code class="w"> </code><code>update</code><code class="w"> </code><code class="o">&amp;&amp;</code><code class="w"> </code><code class="se">\
</code><code class="w">    </code><code>apt-get</code><code class="w"> </code><code>install</code><code class="w"> </code><code>--no-install-suggests</code><code class="w"> </code><code>--no-install-recommends</code><code class="w"> </code><code>--yes</code><code class="w"> </code><code>pipx</code><code class="w">
</code><code class="k">ENV</code><code class="w"> </code><code class="nv">PATH</code><code class="o">=</code><code class="s2">"</code><code class="s2">/root/.local/bin:</code><code class="si">${</code><code class="nv">PATH</code><code class="si">}</code><code class="s2">"</code><code class="w">
</code><code class="k">RUN</code><code class="w"> </code><code>pipx</code><code class="w"> </code><code>install</code><code class="w"> </code><code>poetry</code><code class="w">
</code><code class="k">RUN</code><code class="w"> </code><code>pipx</code><code class="w"> </code><code>inject</code><code class="w"> </code><code>poetry</code><code class="w"> </code><code>poetry-plugin-bundle</code><code class="w">
</code><code class="k">WORKDIR</code><code class="w"> </code><code class="s">/src</code><code class="w">
</code><code class="k">COPY</code><code class="w"> </code><code>.</code><code class="w"> </code><code>.</code><code class="w">
</code><code class="k">RUN</code><code class="w"> </code><code>poetry</code><code class="w"> </code><code>bundle</code><code class="w"> </code><code>venv</code><code class="w"> </code><code>--python</code><code class="o">=</code><code>/usr/bin/python3</code><code class="w"> </code><code>--only</code><code class="o">=</code><code>main</code><code class="w"> </code><code>/venv</code><code class="w">
</code><code class="w">
</code><code class="k">FROM</code><code class="w"> </code><code class="s">gcr.io/distroless/python3-debian12</code><code class="w"> </code><a class="co" id="co_managing_projects_with_poetry_CO2-2" href="#callout_managing_projects_with_poetry_CO2-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a><code class="w">
</code><code class="k">COPY</code><code class="w"> </code><code>--from</code><code class="o">=</code><code>builder</code><code class="w"> </code><code>/venv</code><code class="w"> </code><code>/venv</code><code class="w"> </code><a class="co" id="co_managing_projects_with_poetry_CO2-3" href="#callout_managing_projects_with_poetry_CO2-3"><img src="assets/3.png" alt="3" width="12" height="12"/></a><code class="w">
</code><code class="k">ENTRYPOINT</code><code class="w"> </code><code class="p">[</code><code class="s2">"/venv/bin/random-wikipedia-article"</code><code class="p">]</code><code class="w"> </code><a class="co" id="co_managing_projects_with_poetry_CO2-4" href="#callout_managing_projects_with_poetry_CO2-4"><img src="assets/4.png" alt="4" width="12" height="12"/></a></pre></div>
<dl class="calloutlist">
<dt><a class="co" id="callout_managing_projects_with_poetry_CO2-1" href="#co_managing_projects_with_poetry_CO2-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>The first <code>FROM</code> directive introduces the build stage, where you build and
install your project. The base image is a slim variant of the Debian stable
release.</p></dd>
<dt><a class="co" id="callout_managing_projects_with_poetry_CO2-2" href="#co_managing_projects_with_poetry_CO2-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>The second <code>FROM</code> directive defines the image that you deploy to production.
The base image is a <em>distroless</em> Python image for Debian stable: Python language
support minus the operating system.</p></dd>
<dt><a class="co" id="callout_managing_projects_with_poetry_CO2-3" href="#co_managing_projects_with_poetry_CO2-3"><img src="assets/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>The <code>COPY</code> directive allows you to copy the virtual environment over from
the build stage.</p></dd>
<dt><a class="co" id="callout_managing_projects_with_poetry_CO2-4" href="#co_managing_projects_with_poetry_CO2-4"><img src="assets/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>The <code>ENTRYPOINT</code> directive lets you run the entry-point script when users
invoke <code>docker run</code> with the image.</p></dd>
</dl>

<p>If you have Docker installed, you can try this out. First, create a <em>Dockerfile</em>
in your project with the contents from <a data-type="xref" href="#example_docker_poetry_bundle">Example 5-7</a>. Next,
build and run the Docker image:</p>
<pre data-type="programlisting">$ <strong>docker build -t random-wikipedia-article .</strong>
$ <strong>docker run --rm -ti random-wikipedia-article</strong>
</pre>

<p>You should see the output from <code>random-wikipedia-article</code> in your terminal.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="The Dynamic Versioning Plugin"><div class="sect2" id="section_poetry_dynamic_versioning">
<h2>The Dynamic Versioning Plugin</h2>

<p>The dynamic versioning plugin populates the version in the project metadata from
a Git tag. Keeping the version in a single place reduces churn (see
<a data-type="xref" href="ch03.html#section_packages_single_sourcing_the_version">“Single-sourcing the project version”</a>). The plugin is based on
Dunamai, a Python library for deriving standards-compliant version strings from
tags in your version control system.</p>

<p>Install the plugin with pipx and enable it for your project:</p>
<pre data-type="programlisting">$ <strong>pipx inject poetry "poetry-dynamic-versioning[plugin]"</strong>
$ <strong>poetry dynamic-versioning enable</strong>
</pre>

<p>The second step enables the plugin in the <code>tool</code> section of <em>pyproject.toml</em>:</p>

<pre data-type="programlisting" data-code-language="toml"><code class="k">[tool.poetry-dynamic-versioning]</code><code class="w"/>
<code class="n">enable</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">true</code><code class="w"/></pre>

<p>Remember that you have installed the Poetry plugin globally. The explicit opt-in
ensures that you don’t accidentally start overwriting the version field in
unrelated Poetry projects.</p>

<p>Build frontends like pip and <code>build</code> need the plugin when they build your
project. For this reason, enabling the plugin also adds it to the build
dependencies in <em>pyproject.toml</em>. The plugin brings its own build backend, which
wraps the one provided by Poetry:</p>

<pre data-type="programlisting" data-code-language="toml"><code class="k">[build-system]</code><code class="w"/>
<code class="n">requires</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">[</code><code class="s2">"poetry-core&gt;=1.0.0"</code><code class="p">,</code><code class="w"> </code><code class="s2">"poetry-dynamic-versioning&gt;=1.0.0,&lt;2.0.0"</code><code class="p">]</code><code class="w"/>
<code class="n">build-backend</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"poetry_dynamic_versioning.backend"</code><code class="w"/></pre>

<p>Poetry still requires the <code>version</code> field in its own section. Set the field to
<code>"0.0.0"</code> to indicate that it’s unused.</p>

<pre data-type="programlisting" data-code-language="toml"><code class="k">[tool.poetry]</code><code class="w"/>
<code class="n">version</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"0.0.0"</code><code class="w"/></pre>

<p>You can now add a Git tag to set your project version:</p>
<pre data-type="programlisting">$ <strong>git tag v1.0.0</strong>
$ <strong>poetry build</strong>
Building random-wikipedia-article (1.0.0)
  - Building sdist
  - Built random_wikipedia_article-1.0.0.tar.gz
  - Building wheel
  - Built random_wikipedia_article-1.0.0-py3-none-any.whl
</pre>

<p>The plugin also replaces <code>__version__</code> attributes in Python modules. This mostly
works out of the box, but you need to declare <em>src</em> layout if you use it:</p>

<pre data-type="programlisting" data-code-language="toml"><code class="k">[tool.poetry-dynamic-versioning]</code><code class="w"/>
<code class="n">enable</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">true</code><code class="w"/>
<code class="n">substitution</code><code class="p">.</code><code class="n">folders</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">[{</code><code class="n">path</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="s2">"src"</code><code class="p">}]</code><code class="w"/></pre>

<p>Let’s add a <code>--version</code> option to the application. Edit <em>__init__.py</em> in
the package to add the following lines:</p>

<pre data-type="programlisting" data-code-language="python"><code class="kn">import</code> <code class="nn">argparse</code>

<code class="n">__version__</code> <code class="o">=</code> <code class="s2">"0.0.0"</code>

<code class="k">def</code> <code class="nf">main</code><code class="p">():</code>
    <code class="n">parser</code> <code class="o">=</code> <code class="n">argparse</code><code class="o">.</code><code class="n">ArgumentParser</code><code class="p">(</code><code class="n">prog</code><code class="o">=</code><code class="s2">"random-wikipedia-article"</code><code class="p">)</code>
    <code class="n">parser</code><code class="o">.</code><code class="n">add_argument</code><code class="p">(</code>
        <code class="s2">"--version"</code><code class="p">,</code> <code class="n">action</code><code class="o">=</code><code class="s2">"version"</code><code class="p">,</code> <code class="n">version</code><code class="o">=</code><code class="sa">f</code><code class="s2">"%(prog)s </code><code class="si">{</code><code class="n">__version__</code><code class="si">}</code><code class="s2">"</code>
    <code class="p">)</code>
    <code class="n">parser</code><code class="o">.</code><code class="n">parse_args</code><code class="p">()</code>
    <code class="o">...</code></pre>

<p>Before proceeding, commit your changes, but without adding another Git tag.
Let’s try the option in a fresh installation of the project:</p>
<pre data-type="programlisting">$ <strong>rm -rf .venv</strong>
$ <strong>uv venv</strong>
$ <strong>uv pip install --no-cache .</strong>
$ <strong>py -m random_wikipedia_article --version</strong>
random-wikipedia-article 1.0.0.post1.dev0+51c266e
</pre>

<p>As you can see, the plugin rewrote the <code>__version__</code> attribute during the build.
Since you didn’t tag the commit, Dunamai marked the version as a developmental
post-release of <code>1.0.0</code> and appended the commit hash using a local version
identifier.</p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Summary"><div class="sect1" id="id155">
<h1>Summary</h1>

<p>Poetry provides a unified workflow to manage packaging, dependencies and
environments. Poetry projects are interoperable with standard tooling: you can
build them with <code>build</code> and upload them to PyPI with Twine. But the Poetry
command-line interface also provides convenient shorthands for these tasks and
many more.</p>

<p>Poetry records the precise working set of packages in its lock file, giving you
deterministic deployments and checks, as well as a consistent experience when
collaborating with others. Poetry can track development dependencies; it
organizes them in dependency groups that you can install separately or together.
You can extend Poetry with plugins—​for example, to deploy the project into a
virtual environment or to derive the version number from Git.</p>

<p>If you need reproducible deployments for an application, if your team develops
on multiple operating systems, or if you just feel that standard tooling adds
too much overhead to your workflows, you should give Poetry a try.</p>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="id284"><sup><a href="ch05.html#id284-marker">1</a></sup> Sébastien Eustace: <a href="https://github.com/python-poetry/roadmap/issues/3">“Support for PEP 621,”</a> November 6, 2020.</p><p data-type="footnote" id="id285"><sup><a href="ch05.html#id285-marker">2</a></sup> The command also keeps your lock file and project environment up-to-date. If you edit the constraint in <em>pyproject.toml</em>, you’ll need to do this yourself. Read on to learn more about lock files and environments.</p><p data-type="footnote" id="id287"><sup><a href="ch05.html#id287-marker">3</a></sup> Apart from Poetry’s own <em>poetry.lock</em> and the closely related PDM lock file format, there’s pipenv’s <em>Pipfile.lock</em> and the <code>conda-lock</code> format for Conda environments.</p><p data-type="footnote" id="id288"><sup><a href="ch05.html#id288-marker">4</a></sup> Replace <em>bin</em> with <em>Scripts</em> if you’re on Windows.</p></div></div></section></div>
</div>
</body></html>