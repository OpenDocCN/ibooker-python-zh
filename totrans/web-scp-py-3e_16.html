<html><head></head><body><section data-pdf-bookmark="Chapter 14. Scraping JavaScript" data-type="chapter" epub:type="chapter"><div class="chapter" id="c-14">&#13;
<h1><span class="label">Chapter 14. </span>Scraping JavaScript</h1>&#13;
&#13;
<p>Client-side scripting languages are languages that are run in the browser itself, rather than on a web server. The success of a client-side language depends on your browser’s ability to interpret and execute the language correctly.</p>&#13;
&#13;
<p>While there are hundreds of server-side programming languages, there’s only one client-side programming language. This is because of the difficulty of getting every browser manufacturer to agree on a standard. This is a good thing when it comes to web scraping: the fewer languages there are to deal with, the better.</p>&#13;
&#13;
<div data-type="note" epub:type="note">&#13;
<h1>Other Client-Side Programming Languages</h1>&#13;
&#13;
<p>Some readers may take issue with the sentence: “There’s only one client-side programming language.” Technically, languages <a contenteditable="false" data-primary="programming languages, client-side" data-type="indexterm" id="id717"/><a contenteditable="false" data-primary="client-side code" data-type="indexterm" id="id718"/>such as ActionScript and VBScript exist. However, these are no longer supported and, in the case of VBScript, was only ever supported by a single browser. For this reason, they are very rarely seen.</p>&#13;
&#13;
<p>If you want to be pedantic about it, absolutely anyone can make a new client-side programming language! There are likely many of them out there! The only issue is getting widespread support by browsers to make that language effective and put it into use by <span class="keep-together">others.</span></p>&#13;
&#13;
<p>Some have also argued that CSS and HTML are <a contenteditable="false" data-primary="CSS (Cascading Style Sheets)" data-secondary="as programming language" data-type="indexterm" id="id719"/><a contenteditable="false" data-primary="HTML (HyperText Markup Language)" data-secondary="as programming language" data-type="indexterm" id="id720"/>programming languages in themselves. I agree with this in theory. Lara Schenck has an excellent and entertaining blog post on the subject: <a href="https://notlaura.com/is-css-turing-complete/"><em>https://notlaura.com/is-css-turing-complete/</em></a>.</p>&#13;
&#13;
<p>However, in practice, CSS and HTML are generally treated as markup languages separate from “programming languages” and, besides, are covered extensively in this book.</p>&#13;
</div>&#13;
&#13;
<p>JavaScript is, by far, the most common <a contenteditable="false" data-primary="JavaScript" data-type="indexterm" id="id721"/><a contenteditable="false" data-primary="client-side code" data-secondary="JavaScript" data-see="JavaScript" data-type="indexterm" id="id722"/>and most well-supported client-side scripting language on the web today. It can be used to collect information for user tracking, submit forms without reloading the page, embed multimedia, and even power entire online games. Even deceptively simple-looking pages often contain multiple pieces of JavaScript. You can find it embedded between <code>script</code> tags in the page’s source code:</p>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting">&#13;
<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code><code class="w"/>&#13;
<code class="w">    </code><code class="nx">alert</code><code class="p">(</code><code class="s2">"This creates a pop-up using JavaScript"</code><code class="p">);</code><code class="w"/>&#13;
<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code></pre>&#13;
&#13;
<section data-pdf-bookmark="A Brief Introduction to JavaScript" data-type="sect1"><div class="sect1" id="id85">&#13;
<h1>A Brief Introduction to JavaScript</h1>&#13;
&#13;
<p>Having at least some idea of what is going on in the code you are scraping can be immensely helpful. With that in mind, it’s a good idea to familiarize yourself with JavaScript.</p>&#13;
&#13;
<p><em>JavaScript</em> is a weakly typed <a contenteditable="false" data-primary="JavaScript" data-secondary="syntax" data-type="indexterm" id="id723"/>language, with a syntax that is often compared to C++ and Java. Although certain elements of the syntax, such as operators, loops, and arrays, might be similar, the weak typing and scriptlike nature of the language can make it a difficult beast for some programmers to deal with.</p>&#13;
&#13;
<p>For example, the following recursively calculates values in the Fibonacci sequence up to 100 and prints them to the browser’s developer console:</p>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting">&#13;
<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code><code class="w"> </code>&#13;
<code class="kd">function</code><code class="w"> </code><code class="nx">fibonacci</code><code class="p">(</code><code class="nx">a</code><code class="p">,</code><code class="w"> </code><code class="nx">b</code><code class="p">){</code><code class="w"> </code>&#13;
<code class="w">    </code><code class="kd">var</code><code class="w"> </code><code class="nx">nextNum</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nx">a</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="nx">b</code><code class="p">;</code><code class="w"> </code>&#13;
<code class="w">    </code><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">nextNum</code><code class="o">+</code><code class="s2">" is in the Fibonacci sequence"</code><code class="p">);</code><code class="w"> </code>&#13;
<code class="w">    </code><code class="k">if</code><code class="p">(</code><code class="nx">nextNum</code><code class="w"> </code><code class="o">&lt;</code><code class="w"> </code><code class="mf">100</code><code class="p">){</code><code class="w"> </code>&#13;
<code class="w">        </code><code class="nx">fibonacci</code><code class="p">(</code><code class="nx">b</code><code class="p">,</code><code class="w"> </code><code class="nx">nextNum</code><code class="p">);</code><code class="w"> </code>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"> </code>&#13;
<code class="p">}</code><code class="w"> </code>&#13;
<code class="nx">fibonacci</code><code class="p">(</code><code class="mf">1</code><code class="p">,</code><code class="w"> </code><code class="mf">1</code><code class="p">);</code><code class="w"/>&#13;
<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code></pre>&#13;
&#13;
<p>Notice that all variables are <a contenteditable="false" data-primary="JavaScript" data-secondary="var" data-type="indexterm" id="id724"/>identified by preceding them with <code>var</code>. This is similar to the <code>$</code> sign in PHP or the type declaration (<code>int</code>, <code>String</code>, <code>List</code>, etc.) in Java or C++. Python is unusual in that it doesn’t have this sort of explicit variable declaration.</p>&#13;
&#13;
<p>JavaScript is also good at passing functions around:</p>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting">&#13;
<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code><code class="w"/>&#13;
<code class="kd">var</code><code class="w"> </code><code class="nx">fibonacci</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kd">function</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"> </code>&#13;
<code class="w">    </code><code class="kd">var</code><code class="w"> </code><code class="nx">a</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="mf">1</code><code class="p">;</code><code class="w"> </code><code class="kd">var</code><code class="w"> </code><code class="nx">b</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="mf">1</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">return</code><code class="w"> </code><code class="kd">function</code><code class="w"> </code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"> </code>&#13;
<code class="w">        </code><code class="p">[</code><code class="nx">b</code><code class="p">,</code><code class="w"> </code><code class="nx">a</code><code class="p">]</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">[</code><code class="nx">a</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="nx">b</code><code class="p">,</code><code class="w"> </code><code class="nx">b</code><code class="p">];</code><code class="w"/>&#13;
<code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="nx">b</code><code class="p">;</code><code class="w"> </code>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"> </code>&#13;
<code class="p">}</code><code class="w"/>&#13;
<code class="kd">var</code><code class="w"> </code><code class="nx">fibInstance</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nx">fibonacci</code><code class="p">();</code><code class="w"/>&#13;
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">fibInstance</code><code class="p">()</code><code class="o">+</code><code class="s2">" is in the Fibonacci sequence"</code><code class="p">);</code><code class="w"> </code>&#13;
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">fibInstance</code><code class="p">()</code><code class="o">+</code><code class="s2">" is in the Fibonacci sequence"</code><code class="p">);</code><code class="w"> </code>&#13;
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">fibInstance</code><code class="p">()</code><code class="o">+</code><code class="s2">" is in the Fibonacci sequence"</code><code class="p">);</code><code class="w"/>&#13;
<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code></pre>&#13;
&#13;
<p>This might seem daunting at first, but it becomes simple if you think in terms of lambda expressions (covered in <a data-type="xref" href="ch05.html#c-5">Chapter 5</a>). The variable <code>fibonacci</code> is defined as a function. The value of its function returns a function that prints increasingly large values in the Fibonacci sequence. Each time it is called, it returns the Fibonacci-calculating function, which executes again and increases the values in the function.</p>&#13;
&#13;
<p>You might also see <a contenteditable="false" data-primary="JavaScript ES6" data-type="indexterm" id="id725"/>functions like these written in the arrow syntax introduced in JavaScript ES6 (ECMAScript 6, introduced in 2015):</p>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting">&#13;
<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code><code class="w"/>&#13;
<code class="kd">const</code><code class="w"> </code><code class="nx">fibonacci</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">()</code><code class="w"> </code><code class="p">=&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"> </code>&#13;
<code class="w">    </code><code class="kd">var</code><code class="w"> </code><code class="nx">a</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="mf">1</code><code class="p">;</code><code class="w"> </code><code class="kd">var</code><code class="w"> </code><code class="nx">b</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="mf">1</code><code class="p">;</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">return</code><code class="w"> </code><code class="p">()</code><code class="w"> </code><code class="p">=&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"> </code>&#13;
<code class="w">        </code><code class="p">[</code><code class="nx">b</code><code class="p">,</code><code class="w"> </code><code class="nx">a</code><code class="p">]</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">[</code><code class="nx">a</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="nx">b</code><code class="p">,</code><code class="w"> </code><code class="nx">b</code><code class="p">];</code><code class="w"/>&#13;
<code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="nx">b</code><code class="p">;</code><code class="w"> </code>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"> </code>&#13;
<code class="p">}</code><code class="w"/>&#13;
<code class="kd">const</code><code class="w"> </code><code class="nx">fibInstance</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nx">fibonacci</code><code class="p">();</code><code class="w"/>&#13;
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">fibInstance</code><code class="p">()</code><code class="o">+</code><code class="s2">" is in the Fibonacci sequence"</code><code class="p">);</code><code class="w"> </code>&#13;
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">fibInstance</code><code class="p">()</code><code class="o">+</code><code class="s2">" is in the Fibonacci sequence"</code><code class="p">);</code><code class="w"> </code>&#13;
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">fibInstance</code><code class="p">()</code><code class="o">+</code><code class="s2">" is in the Fibonacci sequence"</code><code class="p">);</code><code class="w"/>&#13;
<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code></pre>&#13;
&#13;
<p>Here, I’m using the JavaScript <a contenteditable="false" data-primary="JavaScript" data-secondary="const keyword" data-type="indexterm" id="id726"/>keyword <code>const</code> to indicate a constant variable that will not be reassigned later. You might also see the keyword <code>let</code>, indicating a variable that may be reassigned. These were also introduced in ES6.</p>&#13;
&#13;
<p>Passing around functions as variables is also extremely useful when it comes to handling user actions and callbacks, and it is worth getting comfortable with this style of programming when it comes to reading JavaScript.</p>&#13;
&#13;
<section data-pdf-bookmark="Common JavaScript Libraries" data-type="sect2"><div class="sect2" id="id157">&#13;
<h2>Common JavaScript Libraries</h2>&#13;
&#13;
<p>Although the core JavaScript language is <a contenteditable="false" data-primary="JavaScript" data-secondary="libraries" data-type="indexterm" id="jvspbr"/><a contenteditable="false" data-primary="libraries" data-secondary="JavaScript" data-type="indexterm" id="id727"/>important to know, you can’t get far on the modern web without using at least one of the language’s many third-party libraries. You might see one or more of these commonly used libraries when looking at page source code.</p>&#13;
&#13;
<p class="pagebreak-before">Executing JavaScript by using Python can be extremely time-consuming and processor intensive, especially if you’re doing it on a large scale. Knowing your way around JavaScript and being able to parse it directly (without needing to execute it to acquire the information) can be extremely useful and save you a lot of headaches.</p>&#13;
&#13;
<section data-pdf-bookmark="jQuery" data-type="sect3"><div class="sect3" id="id86">&#13;
<h3>jQuery</h3>&#13;
&#13;
<p><em>jQuery</em> is an extremely common library, <a contenteditable="false" data-primary="libraries" data-secondary="JavaScript" data-tertiary="jQuery" data-type="indexterm" id="id728"/><a contenteditable="false" data-primary="jQuery" data-type="indexterm" id="id729"/>used by more than 70% of all websites.<sup><a data-type="noteref" href="ch14.html#id730" id="id730-marker">1</a></sup>. A site using jQuery is readily identifiable because it will contain an import to jQuery somewhere in its code:</p>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting">&#13;
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"</code><code class="p">&gt;&lt;/</code>&#13;
 <code class="nt">script</code><code class="p">&gt;</code></pre>&#13;
&#13;
<p>If jQuery is found on a site, you must be careful when scraping it. jQuery is adept at dynamically creating HTML content that appears only after the JavaScript is executed. If you scrape the page’s content by using traditional methods, you will retrieve only the preloaded page that appears before the JavaScript has created the content (this scraping problem is covered in more detail in <a data-type="xref" href="#ajax_dynamic_html">“Ajax and Dynamic HTML”</a>).</p>&#13;
&#13;
<p>In addition, these pages are more likely to contain animations, interactive content, and embedded media that might make scraping challenging.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Google Analytics" data-type="sect3"><div class="sect3" id="id87">&#13;
<h3>Google Analytics</h3>&#13;
&#13;
<p><em>Google Analytics</em> is used <a contenteditable="false" data-primary="libraries" data-secondary="JavaScript" data-tertiary="Google Analytics" data-type="indexterm" id="id731"/><a contenteditable="false" data-primary="Google Analytics" data-type="indexterm" id="id732"/>by about 50% of all websites,<sup><a data-type="noteref" href="ch14.html#id733" id="id733-marker">2</a></sup> making it perhaps the most common JavaScript library and the most popular user tracking tool on the internet. Both <a href="http://pythonscraping.com"><em>http://pythonscraping.com</em></a> and <a href="http://www.oreilly.com/"><em>http://www.oreilly.com/</em></a> use Google Analytics.</p>&#13;
&#13;
<p>Determining whether a page is using Google Analytics is easy. It will have JavaScript at the bottom, similar to the following (taken from the O’Reilly Media site):</p>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting">&#13;
<code class="cm">&lt;!-- Google Analytics --&gt;</code>&#13;
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">type</code><code class="o">=</code><code class="s">"text/javascript"</code><code class="p">&gt;</code><code class="w"/>&#13;
&#13;
<code class="kd">var</code><code class="w"> </code><code class="nx">_gaq</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nx">_gaq</code><code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="p">[];</code><code class="w"> </code>&#13;
<code class="nx">_gaq</code><code class="p">.</code><code class="nx">push</code><code class="p">([</code><code class="s1">'_setAccount'</code><code class="p">,</code><code class="w"> </code><code class="s1">'UA-4591498-1'</code><code class="p">]);</code><code class="w"/>&#13;
<code class="nx">_gaq</code><code class="p">.</code><code class="nx">push</code><code class="p">([</code><code class="s1">'_setDomainName'</code><code class="p">,</code><code class="w"> </code><code class="s1">'oreilly.com'</code><code class="p">]);</code><code class="w"/>&#13;
<code class="nx">_gaq</code><code class="p">.</code><code class="nx">push</code><code class="p">([</code><code class="s1">'_addIgnoredRef'</code><code class="p">,</code><code class="w"> </code><code class="s1">'oreilly.com'</code><code class="p">]);</code><code class="w"/>&#13;
<code class="nx">_gaq</code><code class="p">.</code><code class="nx">push</code><code class="p">([</code><code class="s1">'_setSiteSpeedSampleRate'</code><code class="p">,</code><code class="w"> </code><code class="mf">50</code><code class="p">]);</code><code class="w"/>&#13;
<code class="nx">_gaq</code><code class="p">.</code><code class="nx">push</code><code class="p">([</code><code class="s1">'_trackPageview'</code><code class="p">]);</code><code class="w"/>&#13;
&#13;
<code class="p">(</code><code class="kd">function</code><code class="p">()</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><code class="kd">var</code><code class="w"> </code><code class="nx">ga</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nb">document</code><code class="p">.</code><code class="nx">createElement</code><code class="p">(</code><code class="s1">'script'</code><code class="p">);</code><code class="w"> </code><code class="nx">ga</code><code class="p">.</code><code class="nx">type</code><code class="w"> </code><code class="o">=</code><code class="w"/>&#13;
<code class="s1">'text/javascript'</code><code class="p">;</code><code class="w"> </code><code class="nx">ga</code><code class="p">.</code><code class="k">async</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">true</code><code class="p">;</code><code class="w"> </code><code class="nx">ga</code><code class="p">.</code><code class="nx">src</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">(</code><code class="s1">'https:'</code><code class="w"> </code><code class="o">==</code><code class="w"/>&#13;
<code class="nb">document</code><code class="p">.</code><code class="nx">location</code><code class="p">.</code><code class="nx">protocol</code><code class="w"> </code><code class="o">?</code><code class="w"> </code><code class="s1">'https://ssl'</code><code class="w"> </code><code class="o">:</code><code class="w"> </code><code class="s1">'http://www'</code><code class="p">)</code><code class="w"> </code><code class="o">+</code><code class="w"/>&#13;
<code class="s1">'.google-analytics.com/ga.js'</code><code class="p">;</code><code class="w"> </code><code class="kd">var</code><code class="w"> </code><code class="nx">s</code><code class="w"> </code><code class="o">=</code><code class="w"/>&#13;
<code class="nb">document</code><code class="p">.</code><code class="nx">getElementsByTagName</code><code class="p">(</code><code class="s1">'script'</code><code class="p">)[</code><code class="mf">0</code><code class="p">];</code><code class="w"/>&#13;
<code class="nx">s</code><code class="p">.</code><code class="nx">parentNode</code><code class="p">.</code><code class="nx">insertBefore</code><code class="p">(</code><code class="nx">ga</code><code class="p">,</code><code class="w"> </code><code class="nx">s</code><code class="p">);</code><code class="w"> </code><code class="p">})();</code><code class="w"/>&#13;
&#13;
<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code></pre>&#13;
&#13;
<p>This script handles Google Analytics-specific cookies used to track your visit from page to page. This can sometimes be a problem for web scrapers that are designed to execute JavaScript and handle cookies (such as those that use Selenium, discussed later in this chapter).</p>&#13;
&#13;
<p>If a site uses Google Analytics or a similar web analytics system, and you do not want the site to know that it’s being crawled or scraped, make sure to discard any cookies used for analytics or discard cookies altogether.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Google Maps" data-type="sect3"><div class="sect3" id="id88">&#13;
<h3>Google Maps</h3>&#13;
&#13;
<p>If you’ve spent any time on the <a contenteditable="false" data-primary="JavaScript" data-secondary="libraries" data-startref="jvspbr" data-type="indexterm" id="id734"/><a contenteditable="false" data-primary="libraries" data-secondary="JavaScript" data-tertiary="Google Maps" data-type="indexterm" id="id735"/><a contenteditable="false" data-primary="Google Maps" data-type="indexterm" id="id736"/>internet, you’ve almost certainly seen <em>Google Maps</em> embedded in a website. Its API makes it extremely easy to embed maps with custom information on any site.</p>&#13;
&#13;
<p>If you’re scraping any sort of location data, understanding how Google Maps works makes it easy to obtain well-formatted latitude/longitude coordinates and even addresses. One of the most common ways to denote a location in Google Maps is through a <em>marker</em> (also known as a <em>pin</em>).</p>&#13;
&#13;
<p>Markers can be inserted into any Google Map by using code such as:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting">&#13;
<code class="kd">var</code> <code class="nx">marker</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">google</code><code class="p">.</code><code class="nx">maps</code><code class="p">.</code><code class="nx">Marker</code><code class="p">({</code>&#13;
      <code class="nx">position</code><code class="o">:</code> <code class="k">new</code> <code class="nx">google</code><code class="p">.</code><code class="nx">maps</code><code class="p">.</code><code class="nx">LatLng</code><code class="p">(</code><code class="o">-</code><code class="mf">25.363882</code><code class="p">,</code><code class="mf">131.044922</code><code class="p">),</code>&#13;
      <code class="nx">map</code><code class="o">:</code> <code class="nx">map</code><code class="p">,</code>&#13;
      <code class="nx">title</code><code class="o">:</code> <code class="s1">'Some marker text'</code>&#13;
  <code class="p">});</code></pre>&#13;
&#13;
<p>Python makes it easy to extract all <a contenteditable="false" data-primary="Python" data-secondary="coordinates extraction" data-type="indexterm" id="id737"/>instances of coordinates that occur between <code class="keep-together">google.maps.LatLng(</code> and <code>)</code> to obtain a list of latitude/longitude coordinates.</p>&#13;
&#13;
<p>Using <a href="https://developers.google.com/maps/documentation/javascript/examples/geocoding-reverse">Google’s Reverse Geocoding API</a>, you can resolve these coordinate pairs to addresses that are well formatted for storage and analysis.</p>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Ajax and Dynamic HTML" data-type="sect1"><div class="sect1" id="ajax_dynamic_html">&#13;
<h1 class="pagebreak-before less_space">Ajax and Dynamic HTML</h1>&#13;
&#13;
<p>Until now, the only way we’ve had of <a contenteditable="false" data-primary="Ajax (Asynchronous JavaScript and XML)" data-type="indexterm" id="id738"/><a contenteditable="false" data-primary="JavaScript" data-secondary="Ajax" data-type="indexterm" id="id739"/>communicating with a web server is to send it some sort of HTTP request via the retrieval of a new page. If you’ve ever submitted a form or retrieved information from a server without reloading the page, you’ve likely used a website that uses Ajax.</p>&#13;
&#13;
<p>Contrary to what some believe, Ajax is not a language but a group of technologies used to accomplish a certain task (much like web scraping, come to think of it). <em>Ajax</em> stands for <em>Asynchronous JavaScript and XML</em> and is used to send information to and receive it from a web server without making a separate page request.</p>&#13;
&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>You should never say, “This website will be written in Ajax.” It would be correct to say, “This website will use Ajax to communicate with the web server.”</p>&#13;
</div>&#13;
&#13;
<p>Like Ajax, <em> dynamic HTML</em> (DHTML) is a collection of <a contenteditable="false" data-primary="DHTML (dynamic HTML)" data-type="indexterm" id="id740"/>technologies used for a common purpose. DHTML is HTML code, CSS language, or both that changes as client-side scripts change HTML elements on the page. A button might appear only after the user moves the cursor, a background color might change on a click, or an Ajax request might trigger a new block of content to load.</p>&#13;
&#13;
<p>Note that although the word “dynamic” is generally associated with words like “moving,” or “changing” the presence of interactive HTML components, moving images, or embedded media does not necessarily make a page DHTML, even though it might look dynamic. In addition, some of the most boring, static-looking pages on the internet can have DHTML processes running behind the scenes that depend on the use of JavaScript to manipulate the HTML and CSS.</p>&#13;
&#13;
<p>If you scrape many websites, you will soon run into a situation in which the content you are viewing in your browser does not match the content you see in the source code you’re retrieving from the site. You might view the output of your scraper and scratch your head, trying to figure out where everything you’re seeing on the exact same page in your browser has disappeared to.</p>&#13;
&#13;
<p>The web page might also have a loading page that appears to redirect you to another page of results, but you’ll notice that the page’s URL never changes when this redirect happens.</p>&#13;
&#13;
<p class="pagebreak-before">Both of these are caused by a failure of your scraper to execute the JavaScript that is making the magic happen on the page. Without the JavaScript, the HTML just sort of sits there, and the site might look very different from what it looks like in your web browser, which executes the JavaScript without problem.</p>&#13;
&#13;
<p>There are several giveaways that a page might be using Ajax or DHTML to change or load the content, but in situations like this, there are only two solutions: scrape the content directly from the JavaScript; or use Python packages capable of executing the JavaScript itself and scrape the website as you view it in your browser.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Executing JavaScript in Python with Selenium" data-type="sect1"><div class="sect1" id="id90">&#13;
<h1>Executing JavaScript in Python with Selenium</h1>&#13;
&#13;
<p><a href="http://www.seleniumhq.org">Selenium</a> is a powerful web scraping tool developed originally for website <a contenteditable="false" data-primary="JavaScript" data-secondary="Selenium" data-see="Selenium" data-type="indexterm" id="id741"/><a contenteditable="false" data-primary="Selenium" data-type="indexterm" id="id742"/>testing. These days, it’s also used when the accurate portrayal of websites—as they appear in a browser—is required. Selenium works by automating browsers to load the website, retrieve the required data, and even take screenshots or assert that certain actions happen on the website.</p>&#13;
&#13;
<p>Selenium does not contain its own web browser; it requires integration with third-party browsers in order to run. If you were to run Selenium with Firefox, for example, you would see a Firefox instance open up on your screen, navigate to the website, and perform the actions you had specified in the code. Although this might be neat to watch, I prefer my scripts to run quietly in the background and often use Chrome’s <em>headless</em> mode to do that.</p>&#13;
&#13;
<p>A <em>headless browser</em> loads websites <a contenteditable="false" data-primary="headless browsers" data-type="indexterm" id="id743"/><a contenteditable="false" data-primary="browsers, headless" data-type="indexterm" id="id744"/>into memory and executes JavaScript on the page, but does it without any graphic rendering of the website to the user. By combining Selenium with headless Chrome, you can run an extremely powerful web scraper that handles cookies, JavaScript, headers, and everything else you need with ease, as if you were using a rendered browser.</p>&#13;
&#13;
<section data-pdf-bookmark="Installing and Running Selenium" data-type="sect2"><div class="sect2" id="id91">&#13;
<h2>Installing and Running Selenium</h2>&#13;
&#13;
<p>You can download the Selenium library <a contenteditable="false" data-primary="Selenium" data-secondary="installing" data-type="indexterm" id="slnmst"/>from <a href="https://pypi.python.org/pypi/selenium">its website</a> or use a third-party installer such as pip to install it from the command line.</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="err">$</code> <code class="n">pip</code> <code class="n">install</code> <code class="n">selenium</code></pre>&#13;
&#13;
<p>Previous versions of Selenium required that you also manually download a webdriver file that would allow it to interface with your web browser. This webdriver is called such because it is <a contenteditable="false" data-primary="Selenium" data-secondary="drivers" data-type="indexterm" id="id745"/>a software <em>driver</em> for the web browser. Much like a software driver for a hardware device, it allows the Python Selenium package to interface with and control your browser.</p>&#13;
&#13;
<p>Unfortunately, because new versions of browsers are released frequently, and are much more frequently updated thanks to automatic updates, this meant that <span class="keep-together">Selenium</span> drivers also had to be frequently updated. Navigating to the browser driver’s website (such as <a href="http://chromedriver.chromium.org/downloads"><em class="hyperlink">http://chromedriver.chromium.org/downloads</em></a>), downloading the new file, and replacing the old file was a frequent chore. In Selenium 4, released in October 2021, this entire <a contenteditable="false" data-primary="webdriver manager" data-type="indexterm" id="id746"/><a contenteditable="false" data-primary="Selenium" data-secondary="webdriver manager" data-type="indexterm" id="id747"/>process was replaced by the webdriver manager Python package.</p>&#13;
&#13;
<p>The webdriver manager can be installed with pip:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="err">$</code> <code class="n">pip</code> <code class="n">install</code> <code class="n">webdriver</code><code class="o">-</code><code class="n">manager</code>&#13;
</pre>&#13;
&#13;
<p>When called, the webdriver manager downloads the latest driver:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="kn">from</code> <code class="nn">selenium</code> <code class="kn">import</code> <code class="n">webdriver</code>&#13;
<code class="kn">from</code> <code class="nn">selenium.webdriver.chrome.service</code> <code class="kn">import</code> <code class="n">Service</code>&#13;
<code class="kn">from</code> <code class="nn">webdriver_manager.chrome</code> <code class="kn">import</code> <code class="n">ChromeDriverManager</code>&#13;
&#13;
<code class="n">driver</code> <code class="o">=</code> <code class="n">webdriver</code><code class="o">.</code><code class="n">Chrome</code><code class="p">(</code><code class="n">service</code><code class="o">=</code><code class="n">Service</code><code class="p">(</code><code class="n">ChromeDriverManager</code><code class="p">()</code><code class="o">.</code><code class="n">install</code><code class="p">()))</code>&#13;
<code class="n">driver</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"http://www.python.org"</code><code class="p">)</code>&#13;
<code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mi">2</code><code class="p">)</code>&#13;
<code class="n">driver</code><code class="o">.</code><code class="n">close</code><code class="p">()</code></pre>&#13;
&#13;
<p>Of course, if this script is being run frequently, it’s inefficient to install a new driver file each time just in case the Chrome browser was updated since the last time it ran. The output of the driver manager installation is simply the path in your <code>driver</code> directory where the driver is located:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="n">CHROMEDRIVER_PATH</code> <code class="o">=</code> <code class="n">ChromeDriverManager</code><code class="p">()</code><code class="o">.</code><code class="n">install</code><code class="p">()</code>&#13;
<code class="n">driver</code> <code class="o">=</code> <code class="n">webdriver</code><code class="o">.</code><code class="n">Chrome</code><code class="p">(</code><code class="n">service</code><code class="o">=</code><code class="n">Service</code><code class="p">(</code><code class="n">CHROMEDRIVER_PATH</code><code class="p">))</code></pre>&#13;
&#13;
<p>If you still enjoy downloading files by hand, you can do that by passing your own path into the <code>Service</code> object:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="kn">from</code> <code class="nn">selenium</code> <code class="kn">import</code> <code class="n">webdriver</code>&#13;
<code class="kn">from</code> <code class="nn">selenium.webdriver.chrome.service</code> <code class="kn">import</code> <code class="n">Service</code>&#13;
&#13;
<code class="n">CHROMEDRIVER_PATH</code> <code class="o">=</code> <code class="s1">'drivers/chromedriver_mac_arm64/chromedriver'</code>&#13;
<code class="n">driver</code> <code class="o">=</code> <code class="n">webdriver</code><code class="o">.</code><code class="n">Chrome</code><code class="p">(</code><code class="n">service</code><code class="o">=</code><code class="n">Service</code><code class="p">(</code><code class="n">CHROMEDRIVER_PATH</code><code class="p">))</code>&#13;
<code class="n">driver</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"http://www.python.org"</code><code class="p">)</code>&#13;
<code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mi">2</code><code class="p">)</code>&#13;
<code class="n">driver</code><code class="o">.</code><code class="n">close</code><code class="p">()</code>&#13;
</pre>&#13;
&#13;
<p>Although plenty of pages use Ajax to load data, I’ve created a sample page at <a href="http://pythonscraping.com/pages/javascript/ajaxDemo.html"><em>http://pythonscraping.com/pages/javascript/ajaxDemo.html</em></a> to run your scrapers against. This page contains some sample text, hardcoded into the page’s HTML, that is replaced by Ajax-generated content after a two-second delay. If you were to scrape this page’s data by using traditional methods, you’d get only the loading page, without getting the data that you want.</p>&#13;
&#13;
<p class="pagebreak-before">The Selenium <a contenteditable="false" data-primary="libraries" data-secondary="Selenium" data-type="indexterm" id="id748"/><a contenteditable="false" data-primary="Selenium" data-secondary="library" data-type="indexterm" id="id749"/>library is an API called on the object <a href="https://selenium-python.readthedocs.io/api.html"><code>webdriver</code></a>. Note that this is a Python object representing or acting as an interface to the webdriver application you downloaded. While the same terms “driver” and “webdriver” are often used interchangeably for both things (the Python object and the application itself) it’s important to distinguish them <span class="keep-together">conceptually.</span></p>&#13;
&#13;
<p>The <code>webdriver</code> object is a <a contenteditable="false" data-primary="Selenium" data-secondary="webdriver object" data-type="indexterm" id="id750"/>bit like a browser in that it can load websites, but it can also be used like a <code>BeautifulSoup</code> object to find page elements, interact with elements on the page (send text, click, etc.), and do other actions to drive the web scrapers.</p>&#13;
&#13;
<p>The following code retrieves text behind an Ajax “wall” on the test page:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="kn">from</code> <code class="nn">selenium</code> <code class="kn">import</code> <code class="n">webdriver</code>&#13;
<code class="kn">from</code> <code class="nn">selenium.webdriver.common.by</code> <code class="kn">import</code> <code class="n">By</code>&#13;
<code class="kn">from</code> <code class="nn">selenium.webdriver.chrome.options</code> <code class="kn">import</code> <code class="n">Options</code>&#13;
<code class="kn">import</code> <code class="nn">time</code>&#13;
&#13;
<code class="n">chrome_options</code> <code class="o">=</code> <code class="n">Options</code><code class="p">()</code>&#13;
<code class="n">chrome_options</code><code class="o">.</code><code class="n">add_argument</code><code class="p">(</code><code class="s2">"--headless"</code><code class="p">)</code>&#13;
<code class="n">driver</code> <code class="o">=</code> <code class="n">webdriver</code><code class="o">.</code><code class="n">Chrome</code><code class="p">(</code>&#13;
    <code class="n">service</code><code class="o">=</code><code class="n">Service</code><code class="p">(</code><code class="n">CHROMEDRIVER_PATH</code><code class="p">),</code>&#13;
    <code class="n">options</code><code class="o">=</code><code class="n">chrome_options</code>&#13;
<code class="p">)</code>&#13;
<code class="n">driver</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s1">'http://pythonscraping.com/pages/javascript/ajaxDemo.html'</code><code class="p">)</code>&#13;
<code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mi">3</code><code class="p">)</code>&#13;
<code class="nb">print</code><code class="p">(</code><code class="n">driver</code><code class="o">.</code><code class="n">find_element</code><code class="p">(</code><code class="n">By</code><code class="o">.</code><code class="n">ID</code><code class="p">,</code> <code class="s1">'content'</code><code class="p">)</code><code class="o">.</code><code class="n">text</code><code class="p">)</code>&#13;
<code class="n">driver</code><code class="o">.</code><code class="n">close</code><code class="p">()</code>&#13;
</pre>&#13;
&#13;
<p>This creates a new Selenium webdriver, using the Chrome library, which tells the webdriver to load a page and then pauses execution for three seconds before looking at the page to retrieve the (hopefully loaded) content.</p>&#13;
&#13;
<p>When you instantiate a new Chrome webdriver in Python, you can pass it a variety of options through the <code>Options</code> object. In this case, we’re using the <code>--headless</code> option to make the webdriver run in the background:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="n">chrome_options</code> <code class="o">=</code> <code class="n">Options</code><code class="p">()</code>&#13;
<code class="n">chrome_options</code><code class="o">.</code><code class="n">add_argument</code><code class="p">(</code><code class="s1">'--headless'</code><code class="p">)</code>&#13;
</pre>&#13;
&#13;
<p>Whether you used the driver manager package to install a driver or downloaded it yourself, you must pass this path into the <code>Service</code> object, as well as pass in your options, to create a new webdriver:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="n">driver</code> <code class="o">=</code> <code class="n">webdriver</code><code class="o">.</code><code class="n">Chrome</code><code class="p">(</code>&#13;
    <code class="n">service</code><code class="o">=</code><code class="n">Service</code><code class="p">(</code><code class="n">CHROMEDRIVER_PATH</code><code class="p">),</code>&#13;
    <code class="n">options</code><code class="o">=</code><code class="n">chrome_options</code>&#13;
<code class="p">)</code>&#13;
</pre>&#13;
&#13;
<p class="pagebreak-before">If everything is configured correctly, the script should take a few seconds to run and then result in the following text:</p>&#13;
&#13;
<pre data-code-language="text" data-type="programlisting">&#13;
<code>Here is some important text you want </code><a contenteditable="false" data-primary="Selenium" data-secondary="installing" data-startref="slnmst" data-type="indexterm" id="id751"><code> </code></a><code>to retrieve!&#13;
A button to click!</code></pre>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Selenium Selectors" data-type="sect2"><div class="sect2" id="selenium_sidebar">&#13;
<h2>Selenium Selectors</h2>&#13;
&#13;
<p>In previous chapters, you’ve selected page <a contenteditable="false" data-primary="Selenium" data-secondary="selectors" data-type="indexterm" id="slnslt"/>elements using <code>BeautifulSoup</code> selectors, such as <code>find</code> and <code>find_all</code>. Selenium uses a very similar set of methods to select elements: <code>find_element</code> and <code>find_elements</code>.</p>&#13;
&#13;
<p>There are so many ways to find and <a contenteditable="false" data-primary="HTML (HyperText Markup Language)" data-secondary="Selenium selectors" data-type="indexterm" id="id752"/>select elements from HTML, you might think that Selenium would use a wide variety of arguments and keyword arguments for these methods. However, for both <code>find_element</code> and <code>find_elements</code> there are only two arguments for both of these functions: the <code>By</code> object and the string selector.</p>&#13;
&#13;
<p>The <code>By</code> object specifies how the selector string should be interpreted, with the following list of options:</p>&#13;
&#13;
<dl>&#13;
  <dt><code>By.ID</code></dt>&#13;
  <dd>Used in the example; finds elements by their HTML <code>id</code> attribute.</dd>&#13;
  <dt><code>By.NAME</code></dt>&#13;
  <dd>Finds HTML tags by their <code>name</code> attribute. This is handy for HTML forms.</dd>&#13;
  <dt><code>By.XPATH</code></dt>&#13;
  <dd>Uses an <code>XPath</code> expression to select matching elements. The XPath syntax will be covered in more detail later in this chapter.</dd>&#13;
  <dt><code>By.LINK_TEXT</code></dt>&#13;
  <dd>Finds HTML <code>&lt;a&gt;</code> tags by the text they contain. For example, a link labeled “Next” can be selected using <code>(By.LINK_TEXT, 'Next')</code>.</dd>&#13;
  <dt><code>By.PARTIAL_LINK_TEXT</code></dt>&#13;
  <dd>Similar to <code>LINK_TEXT</code> but matches on a partial string.</dd>&#13;
  <dt><code>By.TAG_NAME</code></dt>&#13;
  <dd>Finds HTML tags by their tag name.</dd>&#13;
  <dt><code>By.CLASS_NAME</code></dt>&#13;
  <dd>Used to find elements by their HTML <code>class</code> attribute. Why is this function <code>CLASS_NAME</code> and not simply <code>CLASS</code>? Using the form <code>object.CLASS</code> would create problems for Selenium’s Java library, where <code>.class</code> is a reserved method. To keep the Selenium syntax consistent between languages, <code>CLASS_NAME</code> is used instead.</dd>&#13;
  <dt><code>By.CSS_SELECTOR</code></dt>&#13;
  <dd>Finds elements by their <code>class</code>, <code>id</code>, or <code>tag</code> name, using the <code>#idName</code>, <code>.className</code>, <code>tagName</code> convention.</dd>&#13;
</dl>&#13;
&#13;
<p>In the previous example, you used the selector <code>driver.find_element(By.ID, 'content')</code>, although the following selectors would have worked as well:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="n">driver</code><code class="o">.</code><code class="n">find_element</code><code class="p">(</code><code class="n">By</code><code class="o">.</code><code class="n">CSS_SELECTOR</code><code class="p">,</code> <code class="s1">'#content'</code><code class="p">)</code>&#13;
<code class="n">driver</code><code class="o">.</code><code class="n">find_element</code><code class="p">(</code><code class="n">By</code><code class="o">.</code><code class="n">TAG_NAME</code><code class="p">,</code> <code class="s1">'div'</code><code class="p">)</code></pre>&#13;
&#13;
<p>Of course, if you want to select multiple elements on the page, most of these element selectors can return a Python list of elements by using <code>elements</code> (i.e., make it plural):</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="n">driver</code><code class="o">.</code><code class="n">find_elements</code><code class="p">(</code><code class="n">By</code><code class="o">.</code><code class="n">CSS_SELECTOR</code><code class="p">,</code> <code class="s1">'#content'</code><code class="p">)</code>&#13;
<code class="n">driver</code><code class="o">.</code><code class="n">find_elements</code><code class="p">(</code><code class="n">By</code><code class="o">.</code><code class="n">TAG_NAME</code><code class="p">,</code> <code class="s1">'div'</code><code class="p">)</code></pre>&#13;
&#13;
<p>If you still want to use BeautifulSoup to parse this content, you can, by using webdriver’s <code>page_source</code> function, which returns the page’s source, as viewed by the DOM at that current <a contenteditable="false" data-primary="Selenium" data-secondary="selectors" data-startref="slnslt" data-type="indexterm" id="id753"/>time, as a string:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="n">pageSource</code> <code class="o">=</code> <code class="n">driver</code><code class="o">.</code><code class="n">page_source</code>&#13;
<code class="n">bs</code> <code class="o">=</code> <code class="n">BeautifulSoup</code><code class="p">(</code><code class="n">pageSource</code><code class="p">,</code> <code class="s1">'html.parser'</code><code class="p">)</code>&#13;
<code class="nb">print</code><code class="p">(</code><code class="n">bs</code><code class="o">.</code><code class="n">find</code><code class="p">(</code><code class="nb">id</code><code class="o">=</code><code class="s1">'content'</code><code class="p">)</code><code class="o">.</code><code class="n">get_text</code><code class="p">())</code></pre>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Waiting to Load" data-type="sect2"><div class="sect2" id="id92">&#13;
<h2>Waiting to Load</h2>&#13;
&#13;
<p>Note that although the page itself <a contenteditable="false" data-primary="Selenium" data-secondary="page loading" data-type="indexterm" id="slngd"/>contains an HTML button, Selenium’s <code>.text</code> function retrieves the text value of the button in the same way that it retrieves all other content on the page.</p>&#13;
&#13;
<p>If the <code>time.sleep</code> pause is changed to one second instead of three, the text returned changes to the original:</p>&#13;
&#13;
<pre data-code-language="text" data-type="programlisting">&#13;
This is some content that will appear on the page while it's loading.&#13;
 You don't care about scraping this.</pre>&#13;
&#13;
<p>Although this solution works, it is somewhat inefficient, and implementing it could cause problems on a large scale. Page-load times are inconsistent, depending on the server <a contenteditable="false" data-primary="page loading" data-type="indexterm" id="id754"/>load at any particular millisecond, and natural variations occur in connection speed. Although this page load should take just over two seconds, you’re giving it an entire three seconds to make sure that it loads completely. A more efficient solution would repeatedly check for the existence of a particular element on a fully loaded page and return only when that element exists.</p>&#13;
&#13;
<p>The following program uses the presence of the button with the ID <code>loadedButton</code> to declare that the page has been fully loaded:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="kn">from</code> <code class="nn">selenium</code> <code class="kn">import</code> <code class="n">webdriver</code>&#13;
<code class="kn">from</code> <code class="nn">selenium.webdriver.common.by</code> <code class="kn">import</code> <code class="n">By</code>&#13;
<code class="kn">from</code> <code class="nn">selenium.webdriver.support.ui</code> <code class="kn">import</code> <code class="n">WebDriverWait</code>&#13;
<code class="kn">from</code> <code class="nn">selenium.webdriver.support</code> <code class="kn">import</code> <code class="n">expected_conditions</code> <code class="k">as</code> <code class="n">EC</code>&#13;
&#13;
<code class="n">chrome_options</code> <code class="o">=</code> <code class="n">Options</code><code class="p">()</code>&#13;
<code class="n">chrome_options</code><code class="o">.</code><code class="n">add_argument</code><code class="p">(</code><code class="s2">"--headless"</code><code class="p">)</code>&#13;
<code class="n">driver</code> <code class="o">=</code> <code class="n">webdriver</code><code class="o">.</code><code class="n">Chrome</code><code class="p">(</code>&#13;
    <code class="n">service</code><code class="o">=</code><code class="n">Service</code><code class="p">(</code><code class="n">CHROMEDRIVER_PATH</code><code class="p">),</code>&#13;
    <code class="n">options</code><code class="o">=</code><code class="n">chrome_options</code><code class="p">)</code>&#13;
&#13;
<code class="n">driver</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s1">'http://pythonscraping.com/pages/javascript/ajaxDemo.html'</code><code class="p">)</code>&#13;
<code class="k">try</code><code class="p">:</code>&#13;
    <code class="n">element</code> <code class="o">=</code> <code class="n">WebDriverWait</code><code class="p">(</code><code class="n">driver</code><code class="p">,</code> <code class="mi">10</code><code class="p">)</code><code class="o">.</code><code class="n">until</code><code class="p">(</code>&#13;
                       <code class="n">EC</code><code class="o">.</code><code class="n">presence_of_element_located</code><code class="p">((</code><code class="n">By</code><code class="o">.</code><code class="n">ID</code><code class="p">,</code> <code class="s1">'loadedButton'</code><code class="p">)))</code>&#13;
<code class="k">finally</code><code class="p">:</code>&#13;
    <code class="nb">print</code><code class="p">(</code><code class="n">driver</code><code class="o">.</code><code class="n">find_element</code><code class="p">(</code><code class="n">By</code><code class="o">.</code><code class="n">ID</code><code class="p">,</code> <code class="s1">'content'</code><code class="p">)</code><code class="o">.</code><code class="n">text</code><code class="p">)</code>&#13;
    <code class="n">driver</code><code class="o">.</code><code class="n">close</code><code class="p">()</code>&#13;
</pre>&#13;
&#13;
<p>This script has several new imports, most notably <code>WebDriverWait</code> and <code>expected​_con⁠ditions</code>, both of which are combined here to form what Selenium calls an<em> implicit wait</em>.</p>&#13;
&#13;
<p>An implicit wait differs from an <a contenteditable="false" data-primary="page loading" data-secondary="implicit versus explicit waits" data-type="indexterm" id="id755"/>explicit wait in that it waits for a certain state in the DOM to occur before continuing, while an explicit wait defines a hardcoded time as in the previous example, which has a wait of three seconds. In an implicit wait, the triggering DOM state is defined by <code>expected_condition</code> (note that the import is cast to <code>EC</code> here, a common convention used for brevity). Expected conditions can be many things in the Selenium library, including:</p>&#13;
&#13;
<ul>&#13;
	<li>&#13;
	<p>An alert box pops up.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>An element (such as a text box) is put into a <em>selected</em> state.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>The page’s title changes, or text is now displayed on the page or in a specific element.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>An element is now visible to the DOM, or an element disappears from the DOM.</p>&#13;
	</li>&#13;
</ul>&#13;
&#13;
<p>Most of these expected conditions require that you specify an element to watch for in the first place. Elements are specified using locators. Note that locators are not the same as selectors (see <a data-type="xref" href="#selenium_sidebar">“Selenium Selectors”</a> for more on selectors). A <em>locator</em> is an abstract query language, using the <code>By</code> object, which can be used in a variety of ways, including to make selectors.</p>&#13;
&#13;
<p>In the following code, a locator is used to find elements with the ID <code>loadedButton</code>:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="n">EC</code><code class="o">.</code><code class="n">presence_of_element_located</code><code class="p">((</code><code class="n">By</code><code class="o">.</code><code class="n">ID</code><code class="p">,</code> <code class="s1">'loadedButton'</code><code class="p">))</code></pre>&#13;
&#13;
<p>Locators also can be used to create selectors, using the <code>find_element</code> webdriver <span class="keep-together">function:</span></p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="nb">print</code><code class="p">(</code><code class="n">driver</code><code class="o">.</code><code class="n">find_element</code><code class="p">(</code><code class="n">By</code><code class="o">.</code><code class="n">ID</code><code class="p">,</code> <code class="s1">'content'</code><code class="p">)</code><code class="o">.</code><code class="n">text</code><code class="p">)</code></pre>&#13;
&#13;
<p>If you do not need to use a locator, don’t; it will save you an import. However, this handy tool is used for a variety of <a contenteditable="false" data-primary="Selenium" data-secondary="page loading" data-startref="slngd" data-type="indexterm" id="id756"/>applications and has a great degree of flexibility.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="XPath" data-type="sect2"><div class="sect2" id="id93">&#13;
<h2>XPath</h2>&#13;
&#13;
<p><em>XPath</em> (short for <em>XML Path</em>) is <a contenteditable="false" data-primary="XPath" data-type="indexterm" id="id757"/><a contenteditable="false" data-primary="Selenium" data-secondary="XPath" data-type="indexterm" id="id758"/>a query language used for navigating and selecting portions of an XML document. Founded by the W3C in 1999, it is occasionally used in languages such as Python, Java, and C# when dealing with XML documents.</p>&#13;
&#13;
<p>Although BeautifulSoup does not support XPath, many of the other libraries in this book, such as Scrapy and Selenium, do. It often can be used in the same way as CSS selectors (such as <code>mytag#idname</code>), although it is designed to work with more generalized XML documents rather than HTML documents in particular.</p>&#13;
&#13;
<p>The XPath syntax has four major concepts:</p>&#13;
&#13;
<dl>&#13;
  <dt>Root nodes versus nonroot nodes</dt>&#13;
  <dd><code>/div</code> will select the div node only if it is at the root of the document.</dd>&#13;
  <dd><code>//div</code> selects all divs anywhere in the document.</dd>&#13;
  <dt>Attribute selection</dt>&#13;
  <dd><code>//@href</code> selects any nodes with the attribute <code>href</code>.</dd>&#13;
  <dd><code>//a[@href='http://google.com']</code> selects all links in the document that point to Google.</dd>&#13;
  <dt>Selection of nodes by position</dt>&#13;
  <dd><code>//a[3]</code> selects the third link in the document.</dd>&#13;
  <dd><code>//table[last()]</code> selects the last table in the document.</dd>&#13;
  <dd><code>//a[position() &lt; 3]</code> selects the first two links in the document.</dd>&#13;
  <dt>Asterisks (*) match any set of characters or nodes and can be used in a variety of situations</dt>&#13;
  <dd><code>//table/tr/*</code> selects all children of <code>tr</code> tags in all tables (this is good for selecting cells using both <code>th</code> and <code>td</code> tags).</dd>&#13;
		<dd><code>//div[@*]</code> selects all <code>div</code> tags that have any attributes.</dd>&#13;
</dl>&#13;
&#13;
<p>XPath syntax also has many advanced features. Over the years, it has developed into a relatively complicated query language, with boolean logic, functions (such as <code>position()</code>), and a variety of operators not discussed here.</p>&#13;
&#13;
<p>If you have an HTML or XML selection problem that cannot be addressed by the functions shown here, see <a href="https://msdn.microsoft.com/en-us/enus/library/ms256471">Microsoft’s XPath Syntax page</a>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Additional Selenium WebDrivers" data-type="sect1"><div class="sect1" id="id94">&#13;
<h1>Additional Selenium WebDrivers</h1>&#13;
&#13;
<p>In the previous section, the Chrome WebDriver (ChromeDriver) was used with Selenium. In most cases, there is <a contenteditable="false" data-primary="Selenium" data-secondary="WebDrivers" data-type="indexterm" id="id759"/><a contenteditable="false" data-primary="WebDrivers, Selenium" data-type="indexterm" id="id760"/>little reason to have a browser pop up on the screen and start scraping the web, so running this in headless mode can be convenient. However, running in nonheadless mode, and/or using different browser drivers can be good practice for a number of reasons:</p>&#13;
&#13;
<ul>&#13;
	<li>&#13;
	<p>Troubleshooting. If your code is running in headless mode and fails, the failure may be difficult to diagnose without seeing the page in front of you.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>You can also pause the code execution and interact with the web page or use the inspector tools while your scraper is running in order to diagnose problems.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Tests may depend on a specific browser in order to run. A failure in one browser but not in another may point at a browser-specific problem.</p>&#13;
	</li>&#13;
</ul>&#13;
&#13;
<p>In most cases it is preferable to use the webdriver manager to get your browser drivers. For instance, you can use the webdriver manager for Firefox and Microsoft Edge:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="kn">from</code> <code class="nn">webdriver_manager.firefox</code> <code class="kn">import</code> <code class="n">GeckoDriverManager</code>&#13;
<code class="err">​</code><code class="kn">from</code> <code class="nn">webdriver_manager.microsoft</code> <code class="kn">import</code> <code class="n">EdgeChromiumDriverManager</code>&#13;
&#13;
<code class="nb">print</code><code class="p">(</code><code class="n">GeckoDriverManager</code><code class="p">()</code><code class="o">.</code><code class="n">install</code><code class="p">())</code>&#13;
<code class="nb">print</code><code class="p">(</code><code class="n">EdgeChromiumDriverManager</code><code class="p">()</code><code class="o">.</code><code class="n">install</code><code class="p">())</code>&#13;
</pre>&#13;
&#13;
<p>However, if you need a deprecated browser version or a browser not available through the webdriver manager (such as Safari) you may still need to manually download the driver files.</p>&#13;
&#13;
<p>Many groups, both official and unofficial, are involved in the creation and maintenance of Selenium webdrivers for every major browser today. The Selenium group curates a <a href="http://www.seleniumhq.org/download/">collection of these webdrivers</a> for easy reference.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Handling Redirects" data-type="sect1"><div class="sect1" id="id159">&#13;
<h1>Handling Redirects</h1>&#13;
&#13;
<p>Client-side redirects are page <a contenteditable="false" data-primary="Selenium" data-secondary="redirects" data-type="indexterm" id="rdrts"/><a contenteditable="false" data-primary="redirects" data-secondary="Selenium" data-type="indexterm" id="rdrsnm"/>redirects that are executed in your browser by JavaScript, rather than a redirect performed on the server, before the page content is sent. It can sometimes be tricky to tell the difference when visiting a page in your web browser. The redirect might happen so fast that you don’t notice any delay in loading time and assume that a client-side redirect is actually a server-side redirect.</p>&#13;
&#13;
<p>However, when scraping the web, the difference is obvious. A server-side redirect, depending on how it is handled, can be traversed easily by Python’s urllib library without any help from Selenium (for more information on doing this, see <a data-type="xref" href="ch06.html#c-6">Chapter 6</a>). Client-side redirects won’t be handled at all unless something is executing the JavaScript.</p>&#13;
&#13;
<p>Selenium is capable of handling these JavaScript redirects in the same way that it handles other JavaScript execution; however, the primary issue with these redirects is when to stop page execution—that is, how to tell when a page is done redirecting. A demo page at <a href="http://pythonscraping.com/pages/javascript/redirectDemo1.html"><em>http://pythonscraping.com/pages/javascript/redirectDemo1.html</em></a> gives an example of this type of redirect, with a two-second pause.</p>&#13;
&#13;
<p>You can detect that redirect in a clever way by “watching” an element in the DOM when the page initially loads, and then repeatedly calling that element until Selenium throws a <code>StaleElementReferenceException</code>; the element is no longer attached to the page’s DOM and the site has redirected:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="kn">from</code> <code class="nn">selenium</code> <code class="kn">import</code> <code class="n">webdriver</code>&#13;
<code class="kn">from</code> <code class="nn">selenium.webdriver.chrome.options</code> <code class="kn">import</code> <code class="n">Options</code>&#13;
<code class="kn">from</code> <code class="nn">selenium.common.exceptions</code> <code class="kn">import</code> <code class="n">StaleElementReferenceException</code>&#13;
<code class="kn">import</code> <code class="nn">time</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">waitForLoad</code><code class="p">(</code><code class="n">driver</code><code class="p">):</code>&#13;
    <code class="n">elem</code> <code class="o">=</code> <code class="n">driver</code><code class="o">.</code><code class="n">find_element</code><code class="p">(</code><code class="n">By</code><code class="o">.</code><code class="n">TAG_NAME</code><code class="p">,</code> <code class="s2">"html"</code><code class="p">)</code>&#13;
    <code class="n">count</code> <code class="o">=</code> <code class="mi">0</code>&#13;
    <code class="k">for</code> <code class="n">_</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="mi">20</code><code class="p">):</code>&#13;
        <code class="k">try</code><code class="p">:</code>&#13;
            <code class="n">elem</code> <code class="o">==</code> <code class="n">driver</code><code class="o">.</code><code class="n">find_element</code><code class="p">(</code><code class="n">By</code><code class="o">.</code><code class="n">TAG_NAME</code><code class="p">,</code> <code class="s2">"html"</code><code class="p">)</code>&#13;
        <code class="k">except</code> <code class="n">StaleElementReferenceException</code><code class="p">:</code>&#13;
            <code class="k">return</code>&#13;
        <code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mf">0.5</code><code class="p">)</code>&#13;
    <code class="nb">print</code><code class="p">(</code><code class="s2">"Timing out after 10 seconds and returning"</code><code class="p">)</code>&#13;
        &#13;
<code class="n">chrome_options</code> <code class="o">=</code> <code class="n">Options</code><code class="p">()</code>&#13;
<code class="n">chrome_options</code><code class="o">.</code><code class="n">add_argument</code><code class="p">(</code><code class="s2">"--headless"</code><code class="p">)</code>&#13;
<code class="n">driver</code> <code class="o">=</code> <code class="n">webdriver</code><code class="o">.</code><code class="n">Chrome</code><code class="p">(</code>&#13;
    <code class="n">service</code><code class="o">=</code><code class="n">Service</code><code class="p">(</code><code class="n">CHROMEDRIVER_PATH</code><code class="p">),</code>&#13;
    <code class="n">options</code><code class="o">=</code><code class="n">chrome_options</code>&#13;
<code class="p">)</code>&#13;
<code class="n">driver</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"http://pythonscraping.com/pages/javascript/redirectDemo1.html"</code><code class="p">)</code>&#13;
<code class="n">waitForLoad</code><code class="p">(</code><code class="n">driver</code><code class="p">)</code>&#13;
<code class="nb">print</code><code class="p">(</code><code class="n">driver</code><code class="o">.</code><code class="n">page_source</code><code class="p">)</code>&#13;
<code class="n">driver</code><code class="o">.</code><code class="n">close</code><code class="p">()</code>&#13;
</pre>&#13;
&#13;
<p>This script checks the page every half second, with a timeout of 10 seconds, although the times used for the checking time and timeout can be easily adjusted up or down, as needed.</p>&#13;
&#13;
<p class="pagebreak-before">Alternatively, you can write a similar loop checking the current URL of the page until the URL changes or it matches a specific URL that you’re looking for.</p>&#13;
&#13;
<p>Waiting for elements to appear and disappear is a common task in Selenium, and you can also use the same <code>WebDriverWait</code> function used in the previous button loading example. Here you’re providing it a timeout of 15 seconds and an XPath selector that looks for the <a contenteditable="false" data-primary="Selenium" data-secondary="redirects" data-startref="rdrts" data-type="indexterm" id="id761"/><a contenteditable="false" data-primary="redirects" data-secondary="Selenium" data-startref="rdrsnm" data-type="indexterm" id="id762"/>page body content to accomplish the same task:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="kn">from</code> <code class="nn">selenium.webdriver.common.by</code> <code class="kn">import</code> <code class="n">By</code>&#13;
<code class="kn">from</code> <code class="nn">selenium.webdriver.support.ui</code> <code class="kn">import</code> <code class="n">WebDriverWait</code>&#13;
<code class="kn">from</code> <code class="nn">selenium.webdriver.chrome.options</code> <code class="kn">import</code> <code class="n">Options</code>&#13;
<code class="kn">from</code> <code class="nn">selenium.webdriver.support</code> <code class="kn">import</code> <code class="n">expected_conditions</code> <code class="k">as</code> <code class="n">EC</code>&#13;
<code class="kn">from</code> <code class="nn">selenium.common.exceptions</code> <code class="kn">import</code> <code class="n">TimeoutException</code>&#13;
&#13;
<code class="n">chrome_options</code> <code class="o">=</code> <code class="n">Options</code><code class="p">()</code>&#13;
<code class="n">chrome_options</code><code class="o">.</code><code class="n">add_argument</code><code class="p">(</code><code class="s2">"--headless"</code><code class="p">)</code>&#13;
<code class="n">driver</code> <code class="o">=</code> <code class="n">webdriver</code><code class="o">.</code><code class="n">Chrome</code><code class="p">(</code>&#13;
    <code class="n">executable_path</code><code class="o">=</code><code class="s1">'drivers/chromedriver'</code><code class="p">,</code> &#13;
    <code class="n">options</code><code class="o">=</code><code class="n">chrome_options</code><code class="p">)</code>&#13;
<code class="n">driver</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s1">'http://pythonscraping.com/pages/javascript/redirectDemo1.html'</code><code class="p">)</code>&#13;
<code class="k">try</code><code class="p">:</code>&#13;
    <code class="n">txt</code> <code class="o">=</code> <code class="s1">'This is the page you are looking for!'</code>&#13;
    <code class="n">bodyElement</code> <code class="o">=</code> <code class="n">WebDriverWait</code><code class="p">(</code><code class="n">driver</code><code class="p">,</code> <code class="mi">15</code><code class="p">)</code><code class="o">.</code><code class="n">until</code><code class="p">(</code>&#13;
        <code class="n">EC</code><code class="o">.</code><code class="n">presence_of_element_located</code><code class="p">((</code>&#13;
            <code class="n">By</code><code class="o">.</code><code class="n">XPATH</code><code class="p">,</code>&#13;
            <code class="sa">f</code><code class="s1">'//body[contains(text(), "</code><code class="si">{</code><code class="n">txt</code><code class="si">}</code><code class="s1">")]'</code>&#13;
        <code class="p">))</code>&#13;
    <code class="p">)</code>&#13;
    <code class="nb">print</code><code class="p">(</code><code class="n">bodyElement</code><code class="o">.</code><code class="n">text</code><code class="p">)</code>&#13;
<code class="k">except</code> <code class="n">TimeoutException</code><code class="p">:</code>&#13;
    <code class="nb">print</code><code class="p">(</code><code class="s1">'Did not find the element'</code><code class="p">)</code>&#13;
</pre>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="A Final Note on JavaScript" data-type="sect1"><div class="sect1" id="id248">&#13;
<h1>A Final Note on JavaScript</h1>&#13;
&#13;
<p>Most sites today on the internet use JavaScript.<sup><a data-type="noteref" href="ch14.html#id763" id="id763-marker">3</a></sup> Fortunately for us, in many cases this use of JavaScript will not affect how you scrape the page. The JavaScript may be limited to powering a site’s tracking tools, controlling a small section of the site, or manipulating a drop-down menu, for example. In cases where it does impact how you scrape the site, the JavaScript can be executed with tools like Selenium to produce the simple HTML page you’ve been learning to scrape in the first part of this book.</p>&#13;
&#13;
<p>Remember: just because a site uses JavaScript does not mean that all the traditional web scraping tools go out the window. The purpose of JavaScript is ultimately to produce HTML and CSS code that can be rendered by the browser, or to communicate with the server dynamically, through HTTP requests and responses. Once Selenium is used, the HTML and CSS on the page can be read and parsed as you would with any other website code, and HTTP requests and responses can be sent and handled by your code via the techniques in earlier chapters, even without using Selenium.</p>&#13;
&#13;
<p>In addition, JavaScript can even be a benefit to web scrapers, because its use as a “browser-side content management system” may expose useful APIs to the outside world, letting you obtain the data more directly. For more information on this, see <a data-type="xref" href="ch15.html#c-15">Chapter 15</a>.</p>&#13;
&#13;
<p>If you are still having difficulty with a particularly hairy JavaScript situation, you can find information on Selenium and interacting directly with dynamic websites, including drag-and-drop interfaces, in <a data-type="xref" href="ch17.html#c-17">Chapter 17</a>.</p>&#13;
</div></section>&#13;
<div data-type="footnotes"><p data-type="footnote" id="id730"><sup><a href="ch14.html#id730-marker">1</a></sup> See Web Technology Surveys analysis at <a href="https://w3techs.com/technologies/details/js-jquery"><em>https://w3techs.com/technologies/details/js-jquery</em></a> W3Techs uses web crawlers to monitor trends in technology usage over time.</p><p data-type="footnote" id="id733"><sup><a href="ch14.html#id733-marker">2</a></sup> W3Techs, <a href="http://w3techs.com/technologies/details/ta-googleanalytics/all/all">“Usage Statistics and Market Share of Google Analytics for Websites”</a>.</p><p data-type="footnote" id="id763"><sup><a href="ch14.html#id763-marker">3</a></sup> W3Techs, <a href="http://w3techs.com/technologies/details/cp-javascript/all/all">“Usage Statistics of JavaScript as Client-Side Programming Language on Websites”</a>.</p></div></div></section></body></html>