<html><head></head><body><section data-pdf-bookmark="Chapter 9. Storing Data" data-type="chapter" epub:type="chapter"><div class="chapter" id="c-9">&#13;
<h1><span class="label">Chapter 9. </span>Storing Data</h1>&#13;
&#13;
<p>Although printing to the terminal is a lot of fun, it’s not incredibly useful when it comes to data aggregation and analysis. To make the majority of web scrapers remotely useful, you need to be able to save the information that they scrape.</p>&#13;
&#13;
<p>This chapter covers three main methods of data management that are sufficient for almost any imaginable application. Do you need to power the backend of a website or create your own API? You’ll probably want your scrapers to write to a database. Need a fast and easy way to collect documents off the internet and put them on your hard drive? You’ll probably want to create a file stream for that. Need occasional alerts, or aggregated data once a day? Send yourself an email!</p>&#13;
&#13;
<p>Above and beyond web scraping, the ability to store and interact with large amounts of data is incredibly important for just about any modern programming application. In fact, the information in this chapter is necessary for implementing many of the examples in later sections of the book. I highly recommend that you at least skim this chapter if you’re unfamiliar with automated data storage.</p>&#13;
&#13;
<section data-pdf-bookmark="Media Files" data-type="sect1"><div class="sect1" id="id52">&#13;
<h1>Media Files</h1>&#13;
&#13;
<p>You can store media files in two <a contenteditable="false" data-primary="storage" data-secondary="media files" data-type="indexterm" id="stgmdf"/><a contenteditable="false" data-primary="media file storage" data-type="indexterm" id="mdflssg"/><a contenteditable="false" data-primary="files" data-secondary="media, storage" data-type="indexterm" id="flmdsrg"/>main ways: by reference and by downloading the file itself. Storing a file by reference is as simple as saving the text URL where the file is located on the host server but not actually downloading the file. This has several advantages:</p>&#13;
&#13;
<ul>&#13;
	<li>&#13;
	<p>Scrapers run much faster and require much less bandwidth when they don’t have to download files.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>You save space on your own machine by <a contenteditable="false" data-primary="storage" data-secondary="URLs" data-type="indexterm" id="stglru"/>storing only the URLs.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>It is easier to write code that stores only URLs and doesn’t need to deal with additional file downloads.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>You can lessen the load on the host server by avoiding large file downloads.</p>&#13;
	</li>&#13;
</ul>&#13;
&#13;
<p>Here are the disadvantages:</p>&#13;
&#13;
<ul>&#13;
	<li>&#13;
	<p>Embedding these URLs in your own website <a contenteditable="false" data-primary="hotlinking" data-type="indexterm" id="id538"/>or application is known as <em>hotlinking</em>, and doing it is a quick way to get you in hot water on the internet.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>You do not want to use someone else’s server cycles to host media for your own applications.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>The file hosted at any particular URL is subject to change. This might lead to embarrassing effects if, say, you’re embedding a hotlinked image on a public blog, the blog owner finds out, and they decide to change the image to something unsavory. Less serious but still inconvenient: if you’re storing the URLs with the intent to use them later, they might eventually go missing at a later date.</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Real web browsers do not just request a page’s HTML and move on. They download all of the assets required by the page as well. Downloading files can make your scraper look like a human browsing the site, an advantage over merely recording links.</p>&#13;
	</li>&#13;
</ul>&#13;
&#13;
<p>If you’re debating whether to store a file or a URL to a file, you should ask yourself whether you’re likely to view or read that file more than once or twice, or if this database of files is going to be sitting around gathering electronic dust for most of its life. If the answer is the latter, it’s probably best to simply store the URL. If it’s the former, read on!</p>&#13;
&#13;
<p>The urllib library, used to retrieve <a contenteditable="false" data-primary="storage" data-secondary="URLs" data-startref="stglru" data-type="indexterm" id="id539"/>the content of web pages, also contains functions to retrieve the content of files. The following program uses <code>urllib.request.urlretrieve</code> to download images from a remote URL:</p>&#13;
&#13;
<pre data-code-language="python" data-executable="true" data-type="programlisting">&#13;
<code class="kn">from</code> <code class="nn">urllib.request</code> <code class="kn">import</code> <code class="n">urlretrieve</code><code class="p">,</code> <code class="n">urlopen</code>&#13;
<code class="kn">from</code> <code class="nn">bs4</code> <code class="kn">import</code> <code class="n">BeautifulSoup</code>&#13;
&#13;
<code class="n">html</code> <code class="o">=</code> <code class="n">urlopen</code><code class="p">(</code><code class="s1">'http://www.pythonscraping.com'</code><code class="p">)</code>&#13;
<code class="n">bs</code> <code class="o">=</code> <code class="n">BeautifulSoup</code><code class="p">(</code><code class="n">html</code><code class="p">,</code> <code class="s1">'html.parser'</code><code class="p">)</code>&#13;
<code class="n">imageLocation</code> <code class="o">=</code> <code class="n">bs</code><code class="o">.</code><code class="n">find</code><code class="p">(</code><code class="s1">'img'</code><code class="p">,</code> <code class="p">{</code><code class="s1">'alt'</code><code class="p">:</code> <code class="s1">'python-logo'</code><code class="p">})[</code><code class="s1">'src'</code><code class="p">]</code>&#13;
<code class="n">urlretrieve</code> <code class="p">(</code><code class="n">imageLocation</code><code class="p">,</code> <code class="s1">'logo.jpg'</code><code class="p">)</code>&#13;
</pre>&#13;
&#13;
<p>This downloads the Python logo from <em>http://pythonscraping.com</em> and stores it as <em>logo.jpg</em> in the same directory from which the script is running.</p>&#13;
&#13;
<p class="pagebreak-before">This works well if you need to download only a single file and know what to call it and what the file extension is. But most scrapers don’t download a single file and call it a day. The following downloads all internal files, linked to by any tag’s <code>src</code> attribute, from the home page of <em>http://pythonscraping.com</em>:</p>&#13;
&#13;
<pre data-code-language="python" data-executable="true" data-type="programlisting">&#13;
<code class="kn">import</code> <code class="nn">os</code>&#13;
<code class="kn">from</code> <code class="nn">urllib.request</code> <code class="kn">import</code> <code class="n">urlretrieve</code><code class="p">,</code> <code class="n">urlopen</code>&#13;
<code class="kn">from</code> <code class="nn">urllib.parse</code> <code class="kn">import</code> <code class="n">urlparse</code>&#13;
<code class="kn">from</code> <code class="nn">bs4</code> <code class="kn">import</code> <code class="n">BeautifulSoup</code>&#13;
&#13;
<code class="n">downloadDir</code> <code class="o">=</code> <code class="s1">'downloaded'</code>&#13;
<code class="n">baseUrl</code> <code class="o">=</code> <code class="s1">'https://pythonscraping.com/'</code>&#13;
<code class="n">baseNetloc</code> <code class="o">=</code> <code class="n">urlparse</code><code class="p">(</code><code class="n">baseUrl</code><code class="p">)</code><code class="o">.</code><code class="n">netloc</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">getAbsoluteURL</code><code class="p">(</code><code class="n">source</code><code class="p">):</code>&#13;
    <code class="k">if</code> <code class="n">urlparse</code><code class="p">(</code><code class="n">baseUrl</code><code class="p">)</code><code class="o">.</code><code class="n">netloc</code> <code class="o">==</code> <code class="s1">''</code><code class="p">:</code>&#13;
        <code class="k">return</code> <code class="n">baseUrl</code> <code class="o">+</code> <code class="n">source</code>&#13;
    <code class="k">return</code> <code class="n">source</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">getDownloadPath</code><code class="p">(</code><code class="n">fileUrl</code><code class="p">):</code>&#13;
    <code class="n">parsed</code> <code class="o">=</code> <code class="n">urlparse</code><code class="p">(</code><code class="n">fileUrl</code><code class="p">)</code>&#13;
    <code class="n">netloc</code> <code class="o">=</code> <code class="n">parsed</code><code class="o">.</code><code class="n">netloc</code><code class="o">.</code><code class="n">strip</code><code class="p">(</code><code class="s1">'/'</code><code class="p">)</code>&#13;
    <code class="n">path</code> <code class="o">=</code> <code class="n">parsed</code><code class="o">.</code><code class="n">path</code><code class="o">.</code><code class="n">strip</code><code class="p">(</code><code class="s1">'/'</code><code class="p">)</code>&#13;
    <code class="n">localfile</code> <code class="o">=</code> <code class="sa">f</code><code class="s1">'</code><code class="si">{</code><code class="n">downloadDir</code><code class="si">}</code><code class="s1">/</code><code class="si">{</code><code class="n">netloc</code><code class="si">}</code><code class="s1">/</code><code class="si">{</code><code class="n">path</code><code class="si">}</code><code class="s1">'</code>&#13;
    &#13;
    <code class="c1"># Remove the filename from the path in order to </code>&#13;
    <code class="c1"># make the directory structure leading up to it</code>&#13;
    <code class="n">localpath</code> <code class="o">=</code> <code class="s1">'/'</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="n">localfile</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="s1">'/'</code><code class="p">)[:</code><code class="o">-</code><code class="mi">1</code><code class="p">])</code>&#13;
    <code class="k">if</code> <code class="ow">not</code> <code class="n">os</code><code class="o">.</code><code class="n">path</code><code class="o">.</code><code class="n">exists</code><code class="p">(</code><code class="n">localpath</code><code class="p">):</code>&#13;
        <code class="n">os</code><code class="o">.</code><code class="n">makedirs</code><code class="p">(</code><code class="n">localpath</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">localfile</code>&#13;
&#13;
<code class="n">html</code> <code class="o">=</code> <code class="n">urlopen</code><code class="p">(</code><code class="n">baseUrl</code><code class="p">)</code>&#13;
<code class="n">bs</code> <code class="o">=</code> <code class="n">BeautifulSoup</code><code class="p">(</code><code class="n">html</code><code class="p">,</code> <code class="s1">'html.parser'</code><code class="p">)</code>&#13;
<code class="n">downloadList</code> <code class="o">=</code> <code class="n">bs</code><code class="o">.</code><code class="n">findAll</code><code class="p">(</code><code class="n">src</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code>&#13;
&#13;
<code class="k">for</code> <code class="n">download</code> <code class="ow">in</code> <code class="n">downloadList</code><code class="p">:</code>&#13;
    <code class="n">fileUrl</code> <code class="o">=</code> <code class="n">getAbsoluteURL</code><code class="p">(</code><code class="n">download</code><code class="p">[</code><code class="s1">'src'</code><code class="p">])</code>&#13;
    <code class="k">if</code> <code class="n">fileUrl</code> <code class="ow">is</code> <code class="ow">not</code> <code class="kc">None</code><code class="p">:</code>&#13;
        <code class="k">try</code><code class="p">:</code>&#13;
            <code class="n">urlretrieve</code><code class="p">(</code><code class="n">fileUrl</code><code class="p">,</code> <code class="n">getDownloadPath</code><code class="p">(</code><code class="n">fileUrl</code><code class="p">))</code>&#13;
            <code class="nb">print</code><code class="p">(</code><code class="n">fileUrl</code><code class="p">)</code>&#13;
        <code class="k">except</code> <code class="ne">Exception</code> <code class="k">as</code> <code class="n">e</code><code class="p">:</code>&#13;
            <code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s1">'Could not retrieve </code><code class="si">{</code><code class="n">fileUrl</code><code class="si">}</code><code class="s1"> Error: </code><code class="si">{</code><code class="n">e</code><code class="si">}</code><code class="s1">'</code><code class="p">)</code>&#13;
&#13;
</pre>&#13;
&#13;
<div data-type="warning" epub:type="warning">&#13;
<h1>Run with Caution</h1>&#13;
&#13;
<p>You know all those warnings you hear about <a contenteditable="false" data-primary="storage" data-secondary="media files" data-startref="stgmdf" data-type="indexterm" id="id540"/><a contenteditable="false" data-primary="media file storage" data-startref="mdflssg" data-type="indexterm" id="id541"/><a contenteditable="false" data-primary="files" data-secondary="media, storage" data-startref="flmdsrg" data-type="indexterm" id="id542"/><a contenteditable="false" data-primary="security" data-secondary="downloads" data-type="indexterm" id="id543"/><a contenteditable="false" data-primary="downloads, security" data-type="indexterm" id="id544"/><a contenteditable="false" data-primary=".exe files download security" data-primary-sortas="exe files" data-type="indexterm" id="id545"/>downloading unknown files off the internet? This script downloads everything it comes across to your computer’s hard drive. This includes random bash scripts, <em>.exe</em> files, and other potential malware.</p>&#13;
&#13;
<p>Think you’re safe because you’d never actually execute anything sent to your downloads folder? Especially if you run this program as an administrator, you’re asking for trouble. What happens if you run across a file on a website that sends itself to <em>../../../../usr/bin/python</em>? The next time you run a Python script from the command line, you <a contenteditable="false" data-primary="malware" data-type="indexterm" id="id546"/>could be deploying malware on your machine!</p>&#13;
&#13;
<p>This program is written for illustrative purposes only; it should not be randomly deployed without more extensive filename checking, and it should be run only in an account with limited permissions. As always, backing up your files, not storing sensitive information on your hard drive, and using a little common sense go a long way.</p>&#13;
</div>&#13;
&#13;
<p>This script uses a <a contenteditable="false" data-primary="lambda functions" data-type="indexterm" id="id547"/>lambda function (introduced in <a data-type="xref" href="ch05.html#c-5">Chapter 5</a>) to select all tags on the front page that have the <code>src</code> attribute, and then cleans and normalizes the URLs to get an absolute path for each download (making sure to discard external links). Then, each file is downloaded to its own path in the local folder <em>downloaded</em> on your own machine.</p>&#13;
&#13;
<p>Notice that Python’s <code>os</code> module is <a contenteditable="false" data-primary="os module" data-type="indexterm" id="id548"/><a contenteditable="false" data-primary="Python" data-secondary="os module" data-type="indexterm" id="id549"/>used briefly to retrieve the target directory for each download and create missing directories along the path if needed. The <code>os</code> module acts as an interface between Python and the operating system, allowing it to manipulate file paths, create directories, get information about running processes <a contenteditable="false" data-primary="security" data-secondary="downloads" data-startref="sctydw" data-type="indexterm" id="id550"/>and environment variables, and many other useful things.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Storing Data to CSV" data-type="sect1"><div class="sect1" id="store2csv_sec">&#13;
<h1>Storing Data to CSV</h1>&#13;
&#13;
<p><em>CSV</em>, or <em>comma-separated values</em>, is <a contenteditable="false" data-primary="storage" data-secondary="CSV (comma-separated values) file" data-type="indexterm" id="sgcvpv"/><a contenteditable="false" data-primary="CSV (comma-separated values)" data-secondary="file storage" data-type="indexterm" id="csvsvge"/>one of the most popular file formats in which to store spreadsheet data. It is supported by Microsoft Excel and many other applications because of its simplicity. The following is an example of a perfectly valid CSV file:</p>&#13;
&#13;
<pre data-code-language="text" data-type="programlisting">&#13;
fruit,cost&#13;
apple,1.00&#13;
banana,0.30&#13;
pear,1.25</pre>&#13;
&#13;
<p class="pagebreak-before">As with Python, whitespace is important here: each row is separated by a newline character, while columns within the row are separated by commas (hence the name “comma-separated”). Other forms of CSV files (sometimes called <em>character-separated value</em> files) use tabs or other characters to separate rows, but these file formats are less common and less widely supported.</p>&#13;
&#13;
<p>If you’re looking to download CSV files directly off the web and store them locally, without any parsing or modification, you don’t need this section. Download them like you would any other file and save them with the CSV file format by using the methods described in the previous section.</p>&#13;
&#13;
<p>Modifying a CSV file, or even creating one <a contenteditable="false" data-primary="csv library" data-type="indexterm" id="id551"/>entirely from scratch, is extremely easy with Python’s <em>csv</em> library:</p>&#13;
&#13;
<pre data-code-language="python" data-executable="true" data-type="programlisting">&#13;
<code class="kn">import</code> <code class="nn">csv</code>&#13;
&#13;
<code class="n">csvFile</code> <code class="o">=</code> <code class="nb">open</code><code class="p">(</code><code class="s1">'test.csv'</code><code class="p">,</code> <code class="s1">'w+'</code><code class="p">)</code>&#13;
<code class="k">try</code><code class="p">:</code>&#13;
    <code class="n">writer</code> <code class="o">=</code> <code class="n">csv</code><code class="o">.</code><code class="n">writer</code><code class="p">(</code><code class="n">csvFile</code><code class="p">)</code>&#13;
    <code class="n">writer</code><code class="o">.</code><code class="n">writerow</code><code class="p">((</code><code class="s1">'number'</code><code class="p">,</code> <code class="s1">'number plus 2'</code><code class="p">,</code> <code class="s1">'number times 2'</code><code class="p">))</code>&#13;
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="mi">10</code><code class="p">):</code>&#13;
        <code class="n">writer</code><code class="o">.</code><code class="n">writerow</code><code class="p">(</code> <code class="p">(</code><code class="n">i</code><code class="p">,</code> <code class="n">i</code><code class="o">+</code><code class="mi">2</code><code class="p">,</code> <code class="n">i</code><code class="o">*</code><code class="mi">2</code><code class="p">))</code>&#13;
<code class="k">finally</code><code class="p">:</code>&#13;
    <code class="n">csvFile</code><code class="o">.</code><code class="n">close</code><code class="p">()</code></pre>&#13;
&#13;
<p>A precautionary reminder: file creation in Python is fairly bulletproof. If <em>test.csv</em> does not already exist, Python will create the file  (but not the directory) automatically. If it already exists, Python will overwrite <em>test.csv</em> with the new data.</p>&#13;
&#13;
<p>After running, you should see a CSV file:</p>&#13;
&#13;
<pre data-code-language="text" data-type="programlisting">&#13;
number,number plus 2,number times 2&#13;
0,2,0&#13;
1,3,2&#13;
2,4,4&#13;
...</pre>&#13;
&#13;
<p>One common web scraping task is to retrieve an HTML table and write it as a CSV file. <a class="link" href="https://en.wikipedia.org/wiki/List_of_countries_with_McDonald%27s_restaurants">Wikipedia’s List of Countries with McDonald’s Restaurants</a> provides a fairly <a contenteditable="false" data-primary="HTML (HyperText Markup Language)" data-secondary="tables, writing as CSV files" data-type="indexterm" id="id552"/>complex HTML table with links, sorting, and other HTML garbage that needs to be discarded before it can be written to CSV. Using BeautifulSoup and the <code>get_text()</code> function copiously, you can do that in fewer than 20 lines:</p>&#13;
&#13;
<pre data-code-language="python" data-executable="true" data-type="programlisting">&#13;
<code class="kn">import</code> <code class="nn">csv</code>&#13;
<code class="kn">from</code> <code class="nn">urllib.request</code> <code class="kn">import</code> <code class="n">urlopen</code>&#13;
<code class="kn">from</code> <code class="nn">bs4</code> <code class="kn">import</code> <code class="n">BeautifulSoup</code>&#13;
&#13;
<code class="n">html</code> <code class="o">=</code> <code class="n">urlopen</code><code class="p">(</code><code class="s1">'https://en.wikipedia.org/wiki/</code><code class="w"/>&#13;
       <code class="n">List_of_countries_with_McDonald</code><code class="o">%</code><code class="mi">27</code><code class="n">s_restaurants</code><code class="s1">')</code><code class="w"/>&#13;
<code class="n">bs</code> <code class="o">=</code> <code class="n">BeautifulSoup</code><code class="p">(</code><code class="n">html</code><code class="p">,</code> <code class="s1">'html.parser'</code><code class="p">)</code>&#13;
<code class="c1"># The main comparison table is currently the first table on the page</code>&#13;
<code class="n">table</code> <code class="o">=</code> <code class="n">bs</code><code class="o">.</code><code class="n">find</code><code class="p">(</code><code class="s1">'table'</code><code class="p">,{</code><code class="s1">'class'</code><code class="p">:</code><code class="s1">'wikitable'</code><code class="p">})</code>&#13;
<code class="n">rows</code> <code class="o">=</code> <code class="n">table</code><code class="o">.</code><code class="n">findAll</code><code class="p">(</code><code class="s1">'tr'</code><code class="p">)</code>&#13;
<code class="n">csvFile</code> <code class="o">=</code> <code class="nb">open</code><code class="p">(</code><code class="s1">'countries.csv'</code><code class="p">,</code> <code class="s1">'wt+'</code><code class="p">)</code>&#13;
<code class="n">writer</code> <code class="o">=</code> <code class="n">csv</code><code class="o">.</code><code class="n">writer</code><code class="p">(</code><code class="n">csvFile</code><code class="p">)</code>&#13;
<code class="k">try</code><code class="p">:</code>&#13;
    <code class="k">for</code> <code class="n">row</code> <code class="ow">in</code> <code class="n">rows</code><code class="p">:</code>&#13;
        <code class="n">csvRow</code> <code class="o">=</code> <code class="p">[]</code>&#13;
        <code class="k">for</code> <code class="n">cell</code> <code class="ow">in</code> <code class="n">row</code><code class="o">.</code><code class="n">findAll</code><code class="p">([</code><code class="s1">'td'</code><code class="p">,</code> <code class="s1">'th'</code><code class="p">]):</code>&#13;
            <code class="n">csvRow</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">cell</code><code class="o">.</code><code class="n">get_text</code><code class="p">()</code><code class="o">.</code><code class="n">strip</code><code class="p">())</code>&#13;
        <code class="n">writer</code><code class="o">.</code><code class="n">writerow</code><code class="p">(</code><code class="n">csvRow</code><code class="p">)</code>&#13;
<code class="k">finally</code><code class="p">:</code>&#13;
    <code class="n">csvFile</code><code class="o">.</code><code class="n">close</code><code class="p">()</code>&#13;
</pre>&#13;
&#13;
<div data-type="tip">&#13;
<h1>There Is an Easier Way to Fetch a Single Table</h1>&#13;
&#13;
<p>This script is great to integrate into scrapers if you encounter many HTML tables that need to be converted to CSV files, or many HTML tables that need to be collected into a single CSV file. However, if you only need to do it just once, there’s a better tool for that: copying and pasting. Selecting and copying all the content of an HTML table and pasting it into Excel or Google Docs will get you the CSV file you’re looking for without running a script!</p>&#13;
</div>&#13;
&#13;
<p>The result should be a well-formatted CSV <a contenteditable="false" data-primary="storage" data-secondary="CSV (comma-separated values) file" data-startref="sgcvpv" data-type="indexterm" id="id553"/><a contenteditable="false" data-primary="CSV (comma-separated values)" data-secondary="file storage" data-startref="csvsvge" data-type="indexterm" id="id554"/>file saved locally, at <em>countries.csv</em>.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="MySQL" data-type="sect1"><div class="sect1" id="id54">&#13;
<h1>MySQL</h1>&#13;
&#13;
<p><em>MySQL</em> (officially pronounced “my es-kew-el,” although many say, “my sequel”) is the most popular open source <a contenteditable="false" data-primary="MySQL" data-seealso="PyMySQL" data-type="indexterm" id="id555"/>relational database management system today. Somewhat unusually for an open source project with large competitors, its popularity has historically been neck and neck with the two other major closed source database systems: Microsoft’s SQL Server and Oracle’s DBMS.</p>&#13;
&#13;
<p>Its popularity is not without cause. For most applications, it’s hard to go wrong with MySQL. It’s a scalable, robust, and full-featured DBMS, used by top websites: YouTube,<sup><a data-type="noteref" href="ch09.html#id556" id="id556-marker">1</a></sup> Twitter,<sup><a data-type="noteref" href="ch09.html#id557" id="id557-marker">2</a></sup> and Facebook,<sup><a data-type="noteref" href="ch09.html#id558" id="id558-marker">3</a></sup> among many others.</p>&#13;
&#13;
<p>Because of its ubiquity, price (“free” is a pretty great price), and out-of-box usability, it makes a fantastic database for web scraping projects, and we will use it throughout the remainder of this book.</p>&#13;
&#13;
<section data-pdf-bookmark="Installing MySQL" data-type="sect2"><div class="sect2" id="id55">&#13;
<h2>Installing MySQL</h2>&#13;
&#13;
<p>If you’re new to MySQL, installing a <a contenteditable="false" data-primary="MySQL" data-secondary="installing" data-type="indexterm" id="yqlstl"/>database might sound a little intimidating (if you’re an old hat at it, feel free to skip this section). In reality, it’s as simple as installing just about any other kind of software. At its core, MySQL is powered by a set of data files, stored on your server or local machine, that contain all the information stored in your database. The MySQL software layer on top of that provides a convenient way of interacting with the data via a command-line interface. For example, the following command digs through the data files and returns a list of all users in your database whose first name is “Ryan”:</p>&#13;
&#13;
<pre data-code-language="mysql" data-type="programlisting">&#13;
<code class="k">SELECT</code><code class="w"> </code><code class="o">*</code><code class="w"> </code><code class="k">FROM</code><code class="w"> </code><code class="n">users</code><code class="w"> </code><code class="k">WHERE</code><code class="w"> </code><code class="n">firstname</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="s2">"Ryan"</code><code class="w"/></pre>&#13;
&#13;
<p>If you’re on a Debian-based Linux <a contenteditable="false" data-primary="MySQL" data-secondary="Debian-based Linux" data-type="indexterm" id="id559"/>distribution (or anything with <code>apt-get</code>), installing MySQL is as easy as this:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
$<code class="w"> </code>sudo<code class="w"> </code>apt-get<code class="w"> </code>install<code class="w"> </code>mysql-server<code class="w"/></pre>&#13;
&#13;
<p>Just keep an eye on the installation process, approve the memory requirements, and enter a new password for your new root user when prompted.</p>&#13;
&#13;
<p>For macOS and Windows, things <a contenteditable="false" data-primary="macOS, MySQL installation" data-type="indexterm" id="id560"/><a contenteditable="false" data-primary="MySQL" data-secondary="macOS installation" data-type="indexterm" id="id561"/>are a little trickier. If you haven’t already, you need to create an Oracle account before downloading the package.</p>&#13;
&#13;
<p>If you’re on macOS, you first need to get <a href="http://dev.mysql.com/downloads/mysql/">the installation package</a>.</p>&#13;
&#13;
<p>Select the <em>.dmg</em> package, and log in with or create your Oracle account to download the file. After the file opens, you should be guided through a fairly straightforward installation wizard (see <a data-type="xref" href="#mac_installer">Figure 9-1</a>).</p>&#13;
&#13;
<p>The default installation steps should suffice, and for the purposes of this book, I assume you have a default MySQL installation.</p>&#13;
&#13;
<p>After MySQL is installed on macOS, you can start the MySQL server as follows:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
$<code class="w"> </code><code class="nb">cd</code><code class="w"> </code>/usr/local/mysql<code class="w"/>&#13;
$<code class="w"> </code>sudo<code class="w"> </code>./bin/mysqld_safe<code class="w"/></pre>&#13;
&#13;
<p>On Windows, installing and running MySQL is slightly more complicated, but the good news is that <a href="http://dev.mysql.com/downloads/windows/installer/">a convenient installer</a> simplifies the process. Once downloaded, it will guide you through the steps you need to take (see <a data-type="xref" href="#mysql_installer">Figure 9-2</a>).</p>&#13;
&#13;
<figure><div class="figure" id="mac_installer"><img alt="Alt Text" class="iimagesmysql_osx_installationpng" src="assets/wsp3_0901.png"/>&#13;
<h6><span class="label">Figure 9-1. </span>The macOS MySQL installer</h6>&#13;
</div></figure>&#13;
&#13;
<figure><div class="figure" id="mysql_installer"><img alt="Alt Text" class="iimagesmysql_windows_installerpng" src="assets/wsp3_0902.png"/>&#13;
<h6><span class="label">Figure 9-2. </span>The Windows MySQL Installer</h6>&#13;
</div></figure>&#13;
&#13;
<p>You should be able to install MySQL by using <a contenteditable="false" data-primary="MySQL server" data-type="indexterm" id="id562"/>the default selections, with one exception: on the Setup Type page, I recommend you choose Server Only to avoid installing a lot of additional Microsoft software and libraries. From there, you should be able to use the default installation settings and follow the prompts to start your MySQL server.</p>&#13;
&#13;
<p>After your MySQL server is installed and running, you will still need to be able to interact with it using the command line. On Windows, you can use the <a href="https://dev.mysql.com/downloads/shell/">MySQL Shell</a> tools. On Macs, I like to install the command-line tools with the <a href="https://brew.sh">Homebrew package manager</a>:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
$<code class="w"> </code>brew<code class="w"> </code>install<code class="w"> </code>mysql<code class="w"/>&#13;
</pre>&#13;
&#13;
<p>After installing the command-line tools, you should be able to connect to your MySQL server:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
$<code class="w"> </code>mysql<code class="w"> </code>-u<code class="w"> </code>root<code class="w"> </code>-p<code class="w"/>&#13;
</pre>&#13;
&#13;
<p>This will prompt you to enter the root password that you created during installation.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Some Basic Commands" data-type="sect2"><div class="sect2" id="id149">&#13;
<h2>Some Basic Commands</h2>&#13;
&#13;
<p>After your MySQL server is running, you <a contenteditable="false" data-primary="MySQL" data-secondary="commands" data-type="indexterm" id="myqcmm"/>have many options for interacting with the database. Plenty of software tools act as an intermediary so that you don’t have to deal with MySQL commands (or at least deal with them less often). Tools such as phpMyAdmin and MySQL Workbench can make it easy to quickly view, sort, and insert data. However, it’s still important to know your way around the command line.</p>&#13;
&#13;
<p>Except for variable names, MySQL is case insensitive; for example, <code>SELECT</code> is the same as <code>sElEcT</code>. However, by convention, all MySQL keywords are in all caps when you are writing a MySQL statement. Conversely, most developers prefer to name their tables and databases in lowercase, although this standard is often ignored.</p>&#13;
&#13;
<p>When you first log in to MySQL, there are no databases to add data to, but you can create one:</p>&#13;
&#13;
<pre data-code-language="mysql" data-type="programlisting">&#13;
<code class="o">&gt;</code><code class="w"> </code><code class="k">CREATE</code><code class="w"> </code><code class="k">DATABASE</code><code class="w"> </code><code class="n">scraping</code><code class="p">;</code><code class="w"/></pre>&#13;
&#13;
<p>Because every MySQL instance can have multiple databases, before you can start interacting with a database, you need to specify to MySQL which database you want to use:</p>&#13;
&#13;
<pre data-code-language="mysql" data-type="programlisting">&#13;
<code class="o">&gt;</code><code class="w"> </code><code class="k">USE</code><code class="w"> </code><code class="n">scraping</code><code class="p">;</code><code class="w"/></pre>&#13;
&#13;
<p>From this point on (at least until you close the MySQL connection or switch to another database), all commands entered will be run against the new <code>scraping</code> <span class="keep-together">database.</span></p>&#13;
&#13;
<p class="pagebreak-before">That all seems pretty straightforward. It must be similarly easy to create a table in the database, right? Let’s try to create a table to store a collection of scraped web pages:</p>&#13;
&#13;
<pre data-code-language="mysql" data-type="programlisting">&#13;
<code class="o">&gt;</code><code class="w"> </code><code class="k">CREATE</code><code class="w"> </code><code class="k">TABLE</code><code class="w"> </code><code class="n">pages</code><code class="p">;</code><code class="w"/></pre>&#13;
&#13;
<p>This results in an error:</p>&#13;
&#13;
<pre data-code-language="text" data-type="programlisting">&#13;
ERROR 1113 (42000): A table must have at least 1 column</pre>&#13;
&#13;
<p>Unlike a database, which can exist without any tables, a table in MySQL cannot exist without columns. To define columns in MySQL, you must enter them in a comma-delimited list, within parentheses, after the <code>CREATE TABLE &lt;tablename&gt;</code> statement:</p>&#13;
&#13;
<pre data-code-language="mysql" data-type="programlisting">&#13;
<code class="o">&gt;</code><code class="w"> </code><code class="k">CREATE</code><code class="w"> </code><code class="k">TABLE</code><code class="w"> </code><code class="n">pages</code><code class="w"> </code><code class="p">(</code><code class="n">id</code><code class="w"> </code><code class="kt">BIGINT</code><code class="p">(</code><code class="mi">7</code><code class="p">)</code><code class="w"> </code><code class="k">NOT</code><code class="w"> </code><code class="no">NULL</code><code class="w"> </code><code class="k">AUTO_INCREMENT</code><code class="p">,</code><code class="w"/>&#13;
<code class="n">title</code><code class="w"> </code><code class="kt">VARCHAR</code><code class="p">(</code><code class="mi">200</code><code class="p">),</code><code class="w"> </code><code class="n">content</code><code class="w"> </code><code class="kt">VARCHAR</code><code class="p">(</code><code class="mi">10000</code><code class="p">),</code><code class="w"/>&#13;
<code class="n">created</code><code class="w"> </code><code class="kt">TIMESTAMP</code><code class="w"> </code><code class="k">DEFAULT</code><code class="w"> </code><code class="k">CURRENT_TIMESTAMP</code><code class="p">,</code><code class="w"> </code><code class="k">PRIMARY</code><code class="w"> </code><code class="k">KEY</code><code class="p">(</code><code class="n">id</code><code class="p">));</code><code class="w"/></pre>&#13;
&#13;
<p>Each column definition has three parts:</p>&#13;
&#13;
<ul>&#13;
	<li>&#13;
	<p>The name (<code>id</code>, <code>title</code>, <code>created</code>, etc.)</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>The variable type (<code>BIGINT(7)</code>, <code>VARCHAR</code>, <code>TIMESTAMP</code>)</p>&#13;
	</li>&#13;
	<li>&#13;
	<p>Optionally, any additional attributes (<code>NOT NULL AUTO_INCREMENT</code>)</p>&#13;
	</li>&#13;
</ul>&#13;
&#13;
<p>At the end of the list of columns, you must <a contenteditable="false" data-primary="MySQL" data-secondary="table keys" data-type="indexterm" id="id563"/>define a table’s <em>key</em>. MySQL uses keys to organize the content in the table for fast lookups. Later in this chapter, I’ll describe how to use these keys to your advantage for speedier databases, but for now, using a table’s <code>id</code> column as the key is generally the best way to go.</p>&#13;
&#13;
<p>After the query executes, you can see what the structure of the table looks like at any time by using <code>DESCRIBE</code>:</p>&#13;
&#13;
<pre data-code-language="mysql" data-type="programlisting">&#13;
<code class="o">&gt;</code><code class="w"> </code><code class="k">DESCRIBE</code><code class="w"> </code><code class="n">pages</code><code class="p">;</code><code class="w"/>&#13;
<code class="o">+---------+----------------+------+-----+-------------------+----------------+</code><code class="w"/>&#13;
<code class="o">|</code><code class="w"> </code><code class="n">Field</code><code class="w">   </code><code class="o">|</code><code class="w"> </code><code class="k">Type</code><code class="w">           </code><code class="o">|</code><code class="w"> </code><code class="no">Null</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="k">Key</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="k">Default</code><code class="w">           </code><code class="o">|</code><code class="w"> </code><code class="n">Extra </code><code class="w">         </code><code class="o">|</code><code class="w"/>&#13;
<code class="o">+---------+----------------+------+-----+-------------------+----------------+</code><code class="w"/>&#13;
<code class="o">|</code><code class="w"> </code><code class="n">id </code><code class="w">     </code><code class="o">|</code><code class="w"> </code><code class="kt">bigint</code><code class="p">(</code><code class="mi">7</code><code class="p">)</code><code class="w">      </code><code class="o">|</code><code class="w"> </code><code class="k">NO</code><code class="w">   </code><code class="o">|</code><code class="w"> </code><code class="n">PRI</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="no">NULL</code><code class="w">              </code><code class="o">|</code><code class="w"> </code><code class="k">auto_increment</code><code class="w"> </code><code class="o">|</code><code class="w"/>&#13;
<code class="o">|</code><code class="w"> </code><code class="n">title</code><code class="w">   </code><code class="o">|</code><code class="w"> </code><code class="kt">varchar</code><code class="p">(</code><code class="mi">200</code><code class="p">)</code><code class="w">   </code><code class="o">|</code><code class="w"> </code><code class="n">YES </code><code class="w"> </code><code class="o">|</code><code class="w">     </code><code class="o">|</code><code class="w"> </code><code class="no">NULL</code><code class="w">              </code><code class="o">|</code><code class="w">                </code><code class="o">|</code><code class="w"/>&#13;
<code class="o">|</code><code class="w"> </code><code class="n">content</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="kt">varchar</code><code class="p">(</code><code class="mi">10000</code><code class="p">)</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="n">YES </code><code class="w"> </code><code class="o">|</code><code class="w">     </code><code class="o">|</code><code class="w"> </code><code class="no">NULL</code><code class="w">              </code><code class="o">|</code><code class="w">                </code><code class="o">|</code><code class="w"/>&#13;
<code class="o">|</code><code class="w"> </code><code class="n">created</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="kt">timestamp</code><code class="w">      </code><code class="o">|</code><code class="w"> </code><code class="k">NO</code><code class="w">   </code><code class="o">|</code><code class="w">     </code><code class="o">|</code><code class="w"> </code><code class="k">CURRENT_TIMESTAMP</code><code class="w"> </code><code class="o">|</code><code class="w">                </code><code class="o">|</code><code class="w"/>&#13;
<code class="o">+---------+----------------+------+-----+-------------------+----------------+</code><code class="w"/>&#13;
<code class="mi">4</code><code class="w"> </code><code class="k">rows</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="kt">set</code><code class="w"> </code><code class="p">(</code><code class="mf">0.01</code><code class="w"> </code><code class="n">sec</code><code class="p">)</code><code class="w"/>&#13;
</pre>&#13;
&#13;
<p>Of course, this is still an empty table. You can insert test data into the <em>pages</em> table by using the following line:</p>&#13;
&#13;
<pre data-code-language="mysql" data-type="programlisting">&#13;
<code class="o">&gt;</code><code class="w"> </code><code class="k">INSERT</code><code class="w"> </code><code class="k">INTO</code><code class="w"> </code><code class="n">pages</code><code class="w"> </code><code class="p">(</code><code class="n">title</code><code class="p">,</code><code class="w"> </code><code class="n">content</code><code class="p">)</code><code class="w"> </code><code class="k">VALUES</code><code class="w"> </code><code class="p">(</code><code class="s2">"Test page title"</code><code class="p">,</code><code class="w"/>&#13;
<code class="s2">"This is some test page content. It can be up to 10,000 characters</code>&#13;
<code class="s2">long."</code><code class="p">);</code><code class="w"/></pre>&#13;
&#13;
<p class="pagebreak-before">Notice that although the table has four columns (<code>id</code>, <code>title</code>, <code>content</code>, <code>created</code>), you need to define only two of them (<code>title</code> and <code>content</code>) in order to insert a row. That’s because the <code>id</code> column is autoincremented (MySQL automatically adds a 1 each time a new row is inserted) and generally can take care of itself. In addition, the <code>timestamp</code> column is set to contain the current time as a default.</p>&#13;
&#13;
<p>Of course, you <em>can</em> override these defaults:</p>&#13;
&#13;
<pre data-code-language="mysql" data-type="programlisting">&#13;
<code class="o">&gt;</code><code class="w"> </code><code class="k">INSERT</code><code class="w"> </code><code class="k">INTO</code><code class="w"> </code><code class="n">pages</code><code class="w"> </code><code class="p">(</code><code class="n">id</code><code class="p">,</code><code class="w"> </code><code class="n">title</code><code class="p">,</code><code class="w"> </code><code class="n">content</code><code class="p">,</code><code class="w"> </code><code class="n">created</code><code class="p">)</code><code class="w"> </code><code class="k">VALUES</code><code class="w"> </code><code class="p">(</code><code class="mi">3</code><code class="p">,</code><code class="w"> </code>&#13;
<code class="s2">"Test page title"</code><code class="p">,</code><code class="w"/>&#13;
<code class="s2">"This is some test page content. It can be up to 10,000 characters</code>&#13;
<code class="s2">long."</code><code class="p">,</code><code class="w"> </code><code class="s2">"2014-09-21 10:25:32"</code><code class="p">);</code><code class="w"/></pre>&#13;
&#13;
<p>As long as the integer you provide for the <code>id</code> column doesn’t already exist in the database, this override will work perfectly fine. However, it is generally bad practice to do this; it’s best to let MySQL handle the <code>id</code> and <code>timestamp</code> columns unless there is a compelling reason to do it differently.</p>&#13;
&#13;
<p>Now that you have some data in the table, you can use a wide variety of methods to select this data. Here are a few examples of <code>SELECT</code> statements:</p>&#13;
&#13;
<pre data-code-language="mysql" data-type="programlisting">&#13;
<code class="o">&gt;</code><code class="w"> </code><code class="k">SELECT</code><code class="w"> </code><code class="o">*</code><code class="w"> </code><code class="k">FROM</code><code class="w"> </code><code class="n">pages</code><code class="w"> </code><code class="k">WHERE</code><code class="w"> </code><code class="n">id</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="mi">2</code><code class="p">;</code><code class="w"/></pre>&#13;
&#13;
<p>This statement tells MySQL, “Select all from pages where <code>id</code> equals 2.” The asterisk (*) acts as a wildcard, returning all the rows where the clause (<code>where id equals 2</code>) is true. It returns the second row in the table, or an empty result if there is no row with an <code>id</code> of 2. For example, the following case-insensitive query returns all the rows where the <code>title</code> field contains “test” (the % symbol acts as a wildcard in MySQL strings):</p>&#13;
&#13;
<pre data-code-language="mysql" data-type="programlisting">&#13;
<code class="o">&gt;</code><code class="w"> </code><code class="k">SELECT</code><code class="w"> </code><code class="o">*</code><code class="w"> </code><code class="k">FROM</code><code class="w"> </code><code class="n">pages</code><code class="w"> </code><code class="k">WHERE</code><code class="w"> </code><code class="n">title</code><code class="w"> </code><code class="k">LIKE</code><code class="w"> </code><code class="s2">"%test%"</code><code class="p">;</code><code class="w"/></pre>&#13;
&#13;
<p>But what if you have a table with many columns, and you want only a particular piece of data returned? Rather than selecting all, you can do something like this:</p>&#13;
&#13;
<pre data-code-language="mysql" data-type="programlisting">&#13;
<code class="o">&gt;</code><code class="w"> </code><code class="k">SELECT</code><code class="w"> </code><code class="n">id</code><code class="p">,</code><code class="w"> </code><code class="n">title</code><code class="w"> </code><code class="k">FROM</code><code class="w"> </code><code class="n">pages</code><code class="w"> </code><code class="k">WHERE</code><code class="w"> </code><code class="n">content</code><code class="w"> </code><code class="k">LIKE</code><code class="w"> </code><code class="s2">"%page content%"</code><code class="p">;</code><code class="w"/></pre>&#13;
&#13;
<p>This returns just the <code>id</code> and <code>title</code> where the content contains the phrase “page content.”</p>&#13;
&#13;
<p><code>DELETE</code> statements have much the same syntax as <code>SELECT</code> statements:</p>&#13;
&#13;
<pre data-code-language="mysql" data-type="programlisting">&#13;
<code class="o">&gt;</code><code class="w"> </code><code class="k">DELETE</code><code class="w"> </code><code class="k">FROM</code><code class="w"> </code><code class="n">pages</code><code class="w"> </code><code class="k">WHERE</code><code class="w"> </code><code class="n">id</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="mi">1</code><code class="p">;</code><code class="w"/></pre>&#13;
&#13;
<p>For this reason, it is a good idea, especially when working on important databases that can’t be easily restored, to write any <code>DELETE</code> statements as a <code>SELECT</code> statement first (in this case, <code>SELECT * FROM pages WHERE  id = 1</code>), test to make sure only the rows you want to delete are returned, and then replace <code>SELECT *</code> with <code>DELETE</code>. Many programmers have horror stories of miscoding the clause on a <code>DELETE</code> statement, or worse, leaving it off entirely when they were in a hurry and ruining customer data. Don’t let it happen to you!</p>&#13;
&#13;
<p>Similar precautions should be taken <a contenteditable="false" data-primary="MySQL" data-secondary="UPDATE" data-type="indexterm" id="id564"/>with <code>UPDATE</code> statements:</p>&#13;
&#13;
<pre data-code-language="mysql" data-type="programlisting">&#13;
<code class="o">&gt;</code><code class="w"> </code><code class="k">UPDATE</code><code class="w"> </code><code class="n">pages</code><code class="w"> </code><code class="k">SET</code><code class="w"> </code><code class="n">title</code><code class="o">=</code><code class="s2">"A new title"</code><code class="p">,</code><code class="w"/>&#13;
<code class="n">content</code><code class="o">=</code><code class="s2">"Some new content"</code><code class="w"> </code><code class="k">WHERE</code><code class="w"> </code><code class="n">id</code><code class="o">=</code><code class="mi">2</code><code class="p">;</code><code class="w"/></pre>&#13;
&#13;
<p>For the purposes of this book, you will be <a contenteditable="false" data-primary="MySQL" data-secondary="commands" data-startref="myqcmm" data-type="indexterm" id="id565"/>working with only simple MySQL statements, doing basic selecting, inserting, and updating. If you’re interested in learning more commands and techniques with this powerful database tool, I recommend Paul DuBois’s <a class="orm:hideurl" href="http://shop.oreilly.com/product/0636920032274.do"><em>MySQL Cookbook</em></a> (O’Reilly).</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Integrating with Python" data-type="sect2"><div class="sect2" id="id56">&#13;
<h2>Integrating with Python</h2>&#13;
&#13;
<p>Unfortunately, Python support for MySQL is not <a contenteditable="false" data-primary="pip (package installer for python)" data-secondary="PyMySQL installation" data-type="indexterm" id="poppyyq"/><a contenteditable="false" data-primary="PyMySQL" data-seealso="MySQL" data-type="indexterm" id="pymlq"/>built in. However, many open source libraries allow you to interact with a MySQL database. One of the most popular of these is <a href="https://pypi.python.org/pypi/PyMySQL">PyMySQL</a>.</p>&#13;
&#13;
<p>As of this writing, the current version of PyMySQL is 1.0.3, which can be installed using pip:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
$<code class="w"> </code>pip<code class="w"> </code>install<code class="w"> </code>PyMySQL<code class="w"/>&#13;
</pre>&#13;
&#13;
<p>After installation, you should have access to the PyMySQL package automatically. While your local MySQL server is running, you should be able to execute the following script successfully (remember to add the root password for your database):</p>&#13;
&#13;
<pre data-code-language="python" data-executable="true" data-type="programlisting">&#13;
<code class="kn">import</code> <code class="nn">pymysql</code>&#13;
<code class="n">conn</code> <code class="o">=</code> <code class="n">pymysql</code><code class="o">.</code><code class="n">connect</code><code class="p">(</code>&#13;
    <code class="n">host</code><code class="o">=</code><code class="s1">'127.0.0.1'</code><code class="p">,</code>&#13;
<code class="err">​</code>    <code class="n">unix_socket</code><code class="o">=</code><code class="s1">'/tmp/mysql.sock'</code><code class="p">,</code>&#13;
<code class="err">​</code>    <code class="n">user</code><code class="o">=</code><code class="s1">'root'</code><code class="p">,</code>&#13;
<code class="err">​</code>    <code class="n">passwd</code><code class="o">=</code><code class="kc">None</code><code class="p">,</code>&#13;
<code class="err">​</code>    <code class="n">db</code><code class="o">=</code><code class="s1">'mysql'</code>&#13;
<code class="p">)</code>&#13;
<code class="n">cur</code> <code class="o">=</code> <code class="n">conn</code><code class="o">.</code><code class="n">cursor</code><code class="p">()</code>&#13;
<code class="n">cur</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s1">'USE scraping'</code><code class="p">)</code>&#13;
<code class="n">cur</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s1">'SELECT * FROM pages WHERE id=1'</code><code class="p">)</code>&#13;
<code class="nb">print</code><code class="p">(</code><code class="n">cur</code><code class="o">.</code><code class="n">fetchone</code><code class="p">())</code>&#13;
<code class="n">cur</code><code class="o">.</code><code class="n">close</code><code class="p">()</code>&#13;
<code class="n">conn</code><code class="o">.</code><code class="n">close</code><code class="p">()</code></pre>&#13;
&#13;
<p>Two new types of objects are at work in this example: the connection object (<code>conn</code>) and the cursor object (<code>cur</code>).</p>&#13;
&#13;
<p>The connection/cursor model is commonly <a contenteditable="false" data-primary="databases" data-secondary="connection/cursor model" data-type="indexterm" id="id566"/>used in database programming, although some users might find it tricky to differentiate between the two at first. The connection is responsible for, well, connecting to the database, of course, but also sending the database information, handling rollbacks (when a query or set of queries needs to be aborted and the database needs to be returned to its previous state), and creating new cursor objects.</p>&#13;
&#13;
<p>A connection can have many cursors. A cursor keeps track of certain <em>state</em> information, <a contenteditable="false" data-primary="state, connection/cursor model" data-type="indexterm" id="id567"/>such as which database it is using. If you have multiple databases and need to write information across all of them, you might have multiple cursors to handle this. A cursor also contains the results of the latest query it has executed. By calling functions on the cursor, such as <code>cur.fetchone()</code>, you can access this information.</p>&#13;
&#13;
<p>It is important that both the cursor and the connection are closed after you are finished using them. Not doing this might result in <em>connection leaks</em>, a buildup of unclosed connections that are no longer being used, but the software isn’t able to close because it’s under the impression that you might still use them. This is the sort of thing that brings databases down all the time (I have both written and fixed many connection leak bugs), so remember to close your connections!</p>&#13;
&#13;
<p>The most common thing you’ll probably <a contenteditable="false" data-primary="databases" data-secondary="scraping results" data-type="indexterm" id="id568"/>want to do, starting out, is to be able to store your scraping results in a database. Let’s take a look at how this could be done, using a previous example: the Wikipedia scraper.</p>&#13;
&#13;
<p>Dealing with Unicode text can be <a contenteditable="false" data-primary="Unicode" data-type="indexterm" id="id569"/>tough when web scraping. By default, MySQL does not handle Unicode. Fortunately, you can turn on this feature (just keep in mind that doing so will increase the size of your database). Because you’re bound to run into a variety of colorful characters on Wikipedia, now is a good time to tell your database to expect some Unicode:</p>&#13;
&#13;
<pre data-code-language="mysql" data-type="programlisting">&#13;
<code class="k">ALTER</code><code class="w"> </code><code class="k">DATABASE</code><code class="w"> </code><code class="n">scraping</code><code class="w"> </code><code class="k">CHARACTER</code><code class="w"> </code><code class="k">SET</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">utf8mb4</code><code class="w"> </code><code class="k">COLLATE</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="n">utf8mb4_unicode_ci</code><code class="p">;</code><code class="w"/>&#13;
<code class="k">ALTER</code><code class="w"> </code><code class="k">TABLE</code><code class="w"> </code><code class="n">pages</code><code class="w"> </code><code class="k">CONVERT</code><code class="w"> </code><code class="k">TO</code><code class="w"> </code><code class="k">CHARACTER</code><code class="w"> </code><code class="k">SET</code><code class="w"> </code><code class="n">utf8mb4</code><code class="w"> </code><code class="k">COLLATE</code><code class="w"> </code><code class="n">utf8mb4_unicode_ci</code><code class="p">;</code><code class="w"/>&#13;
<code class="k">ALTER</code><code class="w"> </code><code class="k">TABLE</code><code class="w"> </code><code class="n">pages</code><code class="w"> </code><code class="k">CHANGE</code><code class="w"> </code><code class="n">title</code><code class="w"> </code><code class="n">title</code><code class="w"> </code><code class="kt">VARCHAR</code><code class="p">(</code><code class="mi">200</code><code class="p">)</code><code class="w"> </code><code class="k">CHARACTER</code><code class="w"> </code><code class="k">SET</code><code class="w"> </code><code class="n">utf8mb4</code><code class="w"> </code><code class="k">COLLATE</code><code class="w"> </code>&#13;
<code class="n">utf8mb4_unicode_ci</code><code class="p">;</code><code class="w"/>&#13;
<code class="k">ALTER</code><code class="w"> </code><code class="k">TABLE</code><code class="w"> </code><code class="n">pages</code><code class="w"> </code><code class="k">CHANGE</code><code class="w"> </code><code class="n">content</code><code class="w"> </code><code class="n">content</code><code class="w"> </code><code class="kt">VARCHAR</code><code class="p">(</code><code class="mi">10000</code><code class="p">)</code><code class="w"> </code><code class="k">CHARACTER</code><code class="w"> </code><code class="k">SET</code><code class="w"> </code><code class="n">utf8mb4</code><code class="w"> </code>&#13;
<code class="k">COLLATE</code><code class="w"> </code><code class="n">utf8mb4_unicode_ci</code><code class="p">;</code><code class="w"/></pre>&#13;
&#13;
<p>These four lines change the default character set for the database, for the table, and for both of the two columns—from <code>utf8mb4</code> (still technically Unicode, but with notoriously terrible support for most Unicode characters) to <code>utf8mb4_unicode_ci</code>.</p>&#13;
&#13;
<p>You’ll know that you’re successful if you try inserting a few umlauts or Mandarin characters into the <code>title</code> or <code>content</code> field in the database and it succeeds with no errors.</p>&#13;
&#13;
<p>Now that the database is prepared to accept a wide variety of all that Wikipedia can throw at it, you can run the following:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="n">conn</code> <code class="o">=</code> <code class="n">pymysql</code><code class="o">.</code><code class="n">connect</code><code class="p">(</code><code class="n">host</code><code class="o">=</code><code class="s1">'127.0.0.1'</code><code class="p">,</code> <code class="n">unix_socket</code><code class="o">=</code><code class="s1">'/tmp/mysql.sock'</code><code class="p">,</code>&#13;
                       <code class="n">user</code><code class="o">=</code><code class="s1">'root'</code><code class="p">,</code> <code class="n">passwd</code><code class="o">=</code><code class="kc">None</code><code class="p">,</code> <code class="n">db</code><code class="o">=</code><code class="s1">'mysql'</code><code class="p">,</code> <code class="n">charset</code><code class="o">=</code><code class="s1">'utf8'</code><code class="p">)</code>&#13;
<code class="n">cur</code> <code class="o">=</code> <code class="n">conn</code><code class="o">.</code><code class="n">cursor</code><code class="p">()</code>&#13;
<code class="n">cur</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s1">'USE scraping'</code><code class="p">)</code>&#13;
&#13;
<code class="n">random</code><code class="o">.</code><code class="n">seed</code><code class="p">(</code><code class="n">datetime</code><code class="o">.</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">())</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">store</code><code class="p">(</code><code class="n">title</code><code class="p">,</code> <code class="n">content</code><code class="p">):</code>&#13;
    <code class="n">cur</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s1">'INSERT INTO pages (title, content) VALUES '</code>&#13;
        <code class="s1">'("</code><code class="si">%s</code><code class="s1">", "</code><code class="si">%s</code><code class="s1">")'</code><code class="p">,</code> <code class="p">(</code><code class="n">title</code><code class="p">,</code> <code class="n">content</code><code class="p">))</code>&#13;
    <code class="n">cur</code><code class="o">.</code><code class="n">connection</code><code class="o">.</code><code class="n">commit</code><code class="p">()</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">getLinks</code><code class="p">(</code><code class="n">articleUrl</code><code class="p">):</code>&#13;
    <code class="n">html</code> <code class="o">=</code> <code class="n">urlopen</code><code class="p">(</code><code class="s1">'http://en.wikipedia.org'</code><code class="o">+</code><code class="n">articleUrl</code><code class="p">)</code>&#13;
    <code class="n">bs</code> <code class="o">=</code> <code class="n">BeautifulSoup</code><code class="p">(</code><code class="n">html</code><code class="p">,</code> <code class="s1">'html.parser'</code><code class="p">)</code>&#13;
    <code class="n">title</code> <code class="o">=</code> <code class="n">bs</code><code class="o">.</code><code class="n">find</code><code class="p">(</code><code class="s1">'h1'</code><code class="p">)</code><code class="o">.</code><code class="n">get_text</code><code class="p">()</code>&#13;
    <code class="n">content</code> <code class="o">=</code> <code class="n">bs</code><code class="o">.</code><code class="n">find</code><code class="p">(</code><code class="s1">'div'</code><code class="p">,</code> <code class="p">{</code><code class="s1">'id'</code><code class="p">:</code><code class="s1">'mw-content-text'</code><code class="p">})</code><code class="o">.</code><code class="n">find</code><code class="p">(</code><code class="s1">'p'</code><code class="p">)</code>&#13;
        <code class="o">.</code><code class="n">get_text</code><code class="p">()</code>&#13;
    <code class="n">store</code><code class="p">(</code><code class="n">title</code><code class="p">,</code> <code class="n">content</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">bs</code><code class="o">.</code><code class="n">find</code><code class="p">(</code><code class="s1">'div'</code><code class="p">,</code> <code class="p">{</code><code class="s1">'id'</code><code class="p">:</code><code class="s1">'bodyContent'</code><code class="p">})</code><code class="o">.</code><code class="n">find_all</code><code class="p">(</code><code class="s1">'a'</code><code class="p">,</code>&#13;
        <code class="n">href</code><code class="o">=</code><code class="n">re</code><code class="o">.</code><code class="n">compile</code><code class="p">(</code><code class="s1">'^(/wiki/)((?!:).)*$'</code><code class="p">))</code>&#13;
&#13;
<code class="n">links</code> <code class="o">=</code> <code class="n">getLinks</code><code class="p">(</code><code class="s1">'/wiki/Kevin_Bacon'</code><code class="p">)</code>&#13;
<code class="k">try</code><code class="p">:</code>&#13;
    <code class="k">while</code> <code class="nb">len</code><code class="p">(</code><code class="n">links</code><code class="p">)</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">:</code>&#13;
         <code class="n">newArticle</code> <code class="o">=</code> <code class="n">links</code><code class="p">[</code><code class="n">random</code><code class="o">.</code><code class="n">randint</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="nb">len</code><code class="p">(</code><code class="n">links</code><code class="p">)</code><code class="o">-</code><code class="mi">1</code><code class="p">)]</code><code class="o">.</code><code class="n">attrs</code><code class="p">[</code><code class="s1">'href'</code><code class="p">]</code>&#13;
         <code class="nb">print</code><code class="p">(</code><code class="n">newArticle</code><code class="p">)</code>&#13;
         <code class="n">links</code> <code class="o">=</code> <code class="n">getLinks</code><code class="p">(</code><code class="n">newArticle</code><code class="p">)</code>&#13;
<code class="k">finally</code><code class="p">:</code>&#13;
    <code class="n">cur</code><code class="o">.</code><code class="n">close</code><code class="p">()</code>&#13;
    <code class="n">conn</code><code class="o">.</code><code class="n">close</code><code class="p">()</code>&#13;
</pre>&#13;
&#13;
<p>There are a few things to <a contenteditable="false" data-primary="UTF-8" data-type="indexterm" id="id570"/><a contenteditable="false" data-primary="Python" data-secondary="UTF-8" data-type="indexterm" id="id571"/>note here: first, <code>"charset='utf8'"</code> is added to the database connection string. This tells the connection that it should send all information to the database as UTF-8 (and, of course, the database should already be configured to handle this).</p>&#13;
&#13;
<p>Second, note the <a contenteditable="false" data-primary="store function" data-type="indexterm" id="id572"/>addition of a <code>store</code> function. This takes in two string variables, <code>title</code> and <code>content</code>, and adds them to an <code>INSERT</code> statement that is executed by the cursor and then committed by the cursor’s connection. This is an excellent example of the separation of the cursor and the connection; while the cursor has stored information about the database and its own context, it needs to operate through the connection in order to send information back to the database and insert information.</p>&#13;
&#13;
<p>Last, you’ll see that a <code>finally</code> statement <a contenteditable="false" data-primary="finally statement" data-type="indexterm" id="id573"/>is added to the program’s main loop, at the bottom of the code. This ensures that, regardless of how the program is interrupted or the exceptions that might be thrown during its execution (and because the web is messy, you should always assume exceptions will be thrown), the cursor and the connection will both be closed immediately before the program ends. It is a good idea to include a <code>try...finally</code> statement like this whenever you are scraping the web and have an open database connection.</p>&#13;
&#13;
<p>Although PyMySQL is not a huge package, there are a fair number of useful functions that this book can’t accommodate. You can check <a contenteditable="false" data-primary="pip (package installer for python)" data-secondary="PyMySQL installation" data-startref="poppyyq" data-type="indexterm" id="id574"/><a contenteditable="false" data-primary="PyMySQL" data-seealso="MySQL" data-startref="pymlq" data-type="indexterm" id="id575"/>out their <a href="https://pymysql.readthedocs.io/en/latest/">documentation</a> at the PyMySQL site.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Database Techniques and Good Practice" data-type="sect2"><div class="sect2" id="id57">&#13;
<h2>Database Techniques and Good Practice</h2>&#13;
&#13;
<p>Some people spend their entire careers studying, tuning, and inventing databases. I am not one of those people, and this is not that kind of book. However, as with many subjects in computer science, there are a few tricks you can learn quickly to at least make your databases sufficient, and sufficiently speedy, for most applications.</p>&#13;
&#13;
<p>First, with few exceptions, always <a contenteditable="false" data-primary="databases" data-secondary="id columns" data-type="indexterm" id="id576"/><a contenteditable="false" data-primary="databases" data-seealso="MySQL" data-type="indexterm" id="id577"/>add <code>id</code> columns to your tables. All tables in MySQL must have at least one primary key (the key column that MySQL sorts on), so that MySQL knows how to order it, and it can often be difficult to choose these keys <span class="keep-together">intelligently.</span></p>&#13;
&#13;
<p>The debate over whether to use an artificially created <code>id</code> column for this key or a unique attribute such as <code>username</code> has raged among data scientists and software engineers for years, although I tend to lean on the side of creating <code>id</code> columns. This is <em>especially</em> true when you’re dealing with web scraping and storing someone else’s data. You have no idea what’s actually unique or not unique, and I’ve been surprised before.</p>&#13;
&#13;
<p>Your <code>id</code> column should be autoincremented and used as the primary key for all of your tables.</p>&#13;
&#13;
<p>Second, use intelligent indexing. A <a contenteditable="false" data-primary="indexing" data-type="indexterm" id="id578"/>dictionary (like the book, not the Python object) is a list of words indexed alphabetically. This allows quick lookups whenever you need a word, as long as you know how it’s spelled. You could also imagine a dictionary that is organized alphabetically by the word’s definition. This wouldn’t be nearly as useful unless you were playing some strange game of <em>Jeopardy!</em> in which a definition was presented and you needed to come up with the word. But in the world of database lookups, these sorts of situations happen. For example, you might have a field in your database that you will often be querying against:</p>&#13;
&#13;
<pre data-code-language="mysql" data-type="programlisting">&#13;
<code class="o">&gt;</code><code class="k">SELECT</code><code class="w"> </code><code class="o">*</code><code class="w"> </code><code class="k">FROM</code><code class="w"> </code><code class="n">dictionary</code><code class="w"> </code><code class="k">WHERE</code><code class="w"> </code><code class="k">definition</code><code class="o">=</code><code class="s2">"A small furry animal that says meow"</code><code class="p">;</code><code class="w"/>&#13;
<code class="o">+------+-------+-------------------------------------+</code><code class="w"/>&#13;
<code class="o">|</code><code class="w"> </code><code class="n">id</code><code class="w">   </code><code class="o">|</code><code class="w"> </code><code class="n">word</code><code class="w">  </code><code class="o">|</code><code class="w"> </code><code class="k">definition</code><code class="w">                          </code><code class="o">|</code><code class="w"/>&#13;
<code class="o">+------+-------+-------------------------------------+</code><code class="w"/>&#13;
<code class="o">|</code><code class="w">  </code><code class="mi">200</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="n">cat</code><code class="w">   </code><code class="o">|</code><code class="w"> </code><code class="n">A</code><code class="w"> </code><code class="n">small</code><code class="w"> </code><code class="n">furry</code><code class="w"> </code><code class="n">animal</code><code class="w"> </code><code class="n">that</code><code class="w"> </code><code class="n">says</code><code class="w"> </code><code class="n">meow</code><code class="w"> </code><code class="o">|</code><code class="w"/>&#13;
<code class="o">+------+-------+-------------------------------------+</code><code class="w"/>&#13;
<code class="mi">1</code><code class="w"> </code><code class="k">row</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code class="kt">set</code><code class="w"> </code><code class="p">(</code><code class="mf">0.00</code><code class="w"> </code><code class="n">sec</code><code class="p">)</code><code class="w"/></pre>&#13;
&#13;
<p>You might very well want to add an index to this table (in addition to the index presumably already in place on the <code>id</code>) to the <code>definition</code> column to make lookups on this column faster. Keep in mind, though, that adding indexing requires more space for the new index, as well as additional processing time when inserting new rows. Especially when you’re dealing with large amounts of data, you should carefully consider the trade-offs of your indexes and how much you need to index. To make this “definitions” index a little lighter, you can tell MySQL to index only the first few characters in the column value. This command creates an index on the first 16 characters in the <code>definition</code> field:</p>&#13;
&#13;
<pre data-code-language="mysql" data-type="programlisting">&#13;
<code class="k">CREATE</code><code class="w"> </code><code class="k">INDEX</code><code class="w"> </code><code class="k">definition</code><code class="w"> </code><code class="k">ON</code><code class="w"> </code><code class="n">dictionary</code><code class="w"> </code><code class="p">(</code><code class="n">id</code><code class="p">,</code><code class="w"> </code><code class="k">definition</code><code class="p">(</code><code class="mi">16</code><code class="p">));</code><code class="w"/></pre>&#13;
&#13;
<p>This index will make your lookups much faster when searching for words by their full definition (especially if the first 16 characters in definition values tend to be very different from each other), and not add too much in the way of extra space and up-front processing time.</p>&#13;
&#13;
<p>On the subject of query time versus database size (one of the fundamental balancing acts in database engineering), one of the common mistakes made, especially with web scraping of large amounts of natural text data, is to store lots of repeating data. For example, say you want to measure the frequency of certain phrases that crop up across websites. These phrases might be found from a given list or automatically generated via a text-analysis algorithm. You might be tempted to store the data as something like this:</p>&#13;
&#13;
<pre data-code-language="text" data-type="programlisting">&#13;
+--------+--------------+------+-----+---------+----------------+&#13;
| Field  | Type         | Null | Key | Default | Extra          |&#13;
+--------+--------------+------+-----+---------+----------------+&#13;
| id     | int(11)      | NO   | PRI | NULL    | auto_increment |&#13;
| url    | varchar(200) | YES  |     | NULL    |                |&#13;
| phrase | varchar(200) | YES  |     | NULL    |                |&#13;
+--------+--------------+------+-----+---------+----------------+</pre>&#13;
&#13;
<p>This adds a row to the database each time you find a phrase on a site and records the URL where it was found. However, by splitting the data into three separate tables, you can shrink your dataset enormously:</p>&#13;
&#13;
<pre data-code-language="mysql" data-type="programlisting">&#13;
<code class="o">&gt;</code><code class="k">DESCRIBE</code><code class="w"> </code><code class="n">phrases</code><code class="w"/>&#13;
<code class="o">+--------+--------------+------+-----+---------+----------------+</code><code class="w"/>&#13;
<code class="o">|</code><code class="w"> </code><code class="n">Field </code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="k">Type</code><code class="w">         </code><code class="o">|</code><code class="w"> </code><code class="no">Null</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="k">Key</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="k">Default</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="n">Extra </code><code class="w">         </code><code class="o">|</code><code class="w"/>&#13;
<code class="o">+--------+--------------+------+-----+---------+----------------+</code><code class="w"/>&#13;
<code class="o">|</code><code class="w"> </code><code class="n">id</code><code class="w">     </code><code class="o">|</code><code class="w"> </code><code class="kt">int</code><code class="p">(</code><code class="mi">11</code><code class="p">)</code><code class="w">      </code><code class="o">|</code><code class="w"> </code><code class="k">NO</code><code class="w">   </code><code class="o">|</code><code class="w"> </code><code class="n">PRI</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="no">NULL</code><code class="w">    </code><code class="o">|</code><code class="w"> </code><code class="k">auto_increment</code><code class="w"> </code><code class="o">|</code><code class="w"/>&#13;
<code class="o">|</code><code class="w"> </code><code class="n">phrase</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="kt">varchar</code><code class="p">(</code><code class="mi">200</code><code class="p">)</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="n">YES </code><code class="w"> </code><code class="o">|</code><code class="w">     </code><code class="o">|</code><code class="w"> </code><code class="no">NULL</code><code class="w">    </code><code class="o">|</code><code class="w">                </code><code class="o">|</code><code class="w"/>&#13;
<code class="o">+--------+--------------+------+-----+---------+----------------+</code><code class="w"/>&#13;
&#13;
<code class="w"> </code><code class="o">&gt;</code><code class="k">DESCRIBE</code><code class="w"> </code><code class="n">urls</code><code class="w"/>&#13;
<code class="w"> </code><code class="o">+-------+--------------+------+-----+---------+----------------+</code><code class="w"/>&#13;
<code class="o">|</code><code class="w"> </code><code class="n">Field</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="k">Type</code><code class="w">         </code><code class="o">|</code><code class="w"> </code><code class="no">Null</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="k">Key</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="k">Default</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="n">Extra </code><code class="w">         </code><code class="o">|</code><code class="w"/>&#13;
<code class="o">+-------+--------------+------+-----+---------+----------------+</code><code class="w"/>&#13;
<code class="o">|</code><code class="w"> </code><code class="n">id </code><code class="w">   </code><code class="o">|</code><code class="w"> </code><code class="kt">int</code><code class="p">(</code><code class="mi">11</code><code class="p">)</code><code class="w">      </code><code class="o">|</code><code class="w"> </code><code class="k">NO</code><code class="w">   </code><code class="o">|</code><code class="w"> </code><code class="n">PRI</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="no">NULL</code><code class="w">    </code><code class="o">|</code><code class="w"> </code><code class="k">auto_increment</code><code class="w"> </code><code class="o">|</code><code class="w"/>&#13;
<code class="o">|</code><code class="w"> </code><code class="n">url</code><code class="w">   </code><code class="o">|</code><code class="w"> </code><code class="kt">varchar</code><code class="p">(</code><code class="mi">200</code><code class="p">)</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="n">YES </code><code class="w"> </code><code class="o">|</code><code class="w">     </code><code class="o">|</code><code class="w"> </code><code class="no">NULL</code><code class="w">    </code><code class="o">|</code><code class="w">                </code><code class="o">|</code><code class="w"/>&#13;
<code class="o">+-------+--------------+------+-----+---------+----------------+</code><code class="w"/>&#13;
&#13;
<code class="o">&gt;</code><code class="k">DESCRIBE</code><code class="w"> </code><code class="n">foundInstances</code><code class="w"/>&#13;
<code class="o">+-------------+---------+------+-----+---------+----------------+</code><code class="w"/>&#13;
<code class="o">|</code><code class="w"> </code><code class="n">Field</code><code class="w">       </code><code class="o">|</code><code class="w"> </code><code class="k">Type</code><code class="w">    </code><code class="o">|</code><code class="w"> </code><code class="no">Null</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="k">Key</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="k">Default</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="n">Extra </code><code class="w">         </code><code class="o">|</code><code class="w"/>&#13;
<code class="o">+-------------+---------+------+-----+---------+----------------+</code><code class="w"/>&#13;
<code class="o">|</code><code class="w"> </code><code class="n">id </code><code class="w">         </code><code class="o">|</code><code class="w"> </code><code class="kt">int</code><code class="p">(</code><code class="mi">11</code><code class="p">)</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="k">NO</code><code class="w">   </code><code class="o">|</code><code class="w"> </code><code class="n">PRI</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="no">NULL</code><code class="w">    </code><code class="o">|</code><code class="w"> </code><code class="k">auto_increment</code><code class="w"> </code><code class="o">|</code><code class="w"/>&#13;
<code class="o">|</code><code class="w"> </code><code class="n">urlId</code><code class="w">       </code><code class="o">|</code><code class="w"> </code><code class="kt">int</code><code class="p">(</code><code class="mi">11</code><code class="p">)</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="n">YES </code><code class="w"> </code><code class="o">|</code><code class="w">     </code><code class="o">|</code><code class="w"> </code><code class="no">NULL</code><code class="w">    </code><code class="o">|</code><code class="w">                </code><code class="o">|</code><code class="w"/>&#13;
<code class="o">|</code><code class="w"> </code><code class="n">phraseId </code><code class="w">   </code><code class="o">|</code><code class="w"> </code><code class="kt">int</code><code class="p">(</code><code class="mi">11</code><code class="p">)</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="n">YES </code><code class="w"> </code><code class="o">|</code><code class="w">     </code><code class="o">|</code><code class="w"> </code><code class="no">NULL</code><code class="w">    </code><code class="o">|</code><code class="w">                </code><code class="o">|</code><code class="w"/>&#13;
<code class="o">|</code><code class="w"> </code><code class="n">occurrences</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="kt">int</code><code class="p">(</code><code class="mi">11</code><code class="p">)</code><code class="w"> </code><code class="o">|</code><code class="w"> </code><code class="n">YES </code><code class="w"> </code><code class="o">|</code><code class="w">     </code><code class="o">|</code><code class="w"> </code><code class="no">NULL</code><code class="w">    </code><code class="o">|</code><code class="w">                </code><code class="o">|</code><code class="w"/>&#13;
<code class="o">+-------------+---------+------+-----+---------+----------------+</code><code class="w"/></pre>&#13;
&#13;
<p>Although the table definitions are larger, you can see that the majority of the columns are just integer <code>id</code> fields. These take up far less space. In addition, the full text of each URL and phrase is stored exactly once.</p>&#13;
&#13;
<p>Unless you install a third-party package or keep meticulous logs, it can be impossible to tell when a piece of data was added, updated, or removed from your database. Depending on the available space for your data, the frequency of changes, and the importance of determining when those changes happened, you might want to consider keeping several timestamps in place: <code>created</code>, <code>updated</code>, and <code>deleted</code>.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="“Six Degrees” in MySQL" data-type="sect2"><div class="sect2" id="c-6-six-degrees-in-mysql">&#13;
<h2>“Six Degrees” in MySQL</h2>&#13;
&#13;
<p><a data-type="xref" href="ch06.html#c-6">Chapter 6</a> introduced <a contenteditable="false" data-primary="Six Degrees of Wikipedia" data-secondary="MySQL and" data-type="indexterm" id="sxdwkal"/><a contenteditable="false" data-primary="MySQL" data-secondary="Six Degrees of Wikipedia" data-type="indexterm" id="mqxdkp"/>the Six Degrees of Wikipedia problem, in which the goal is to find the connection between any two Wikipedia articles through a series of links (i.e., find a way to get from one Wikipedia article to the next just by clicking links from one page to the next). To solve this problem, it is necessary not only to build bots that can crawl the site (which you have already done) but also store the information in an architecturally sound way to make data analysis easy later.</p>&#13;
&#13;
<p>Autoincremented <code>id</code> columns, timestamps, and multiple tables: they all come into play here. To figure out how to best store this information, you need to think abstractly. A link is simply something that connects Page A to Page B. It could just as easily connect Page B to Page A, but this would be a separate link. You can uniquely identify a link by saying, “There exists a link on page A, which connects to page B. That is, <code>INSERT INTO</code> links (<code>fromPageId</code>, <code>toPageId</code>) VALUES (A, B); (where A and B are the unique IDs for the two pages).”</p>&#13;
&#13;
<p>A two-table system designed to store pages and links, along with creation dates and unique IDs, can be constructed as follows:</p>&#13;
&#13;
<pre data-code-language="mysql" data-type="programlisting">&#13;
<code class="k">CREATE</code><code class="w"> </code><code class="k">DATABASE</code><code class="w"> </code><code class="n">wikipedia</code><code class="p">;</code><code class="w"/>&#13;
<code class="k">USE</code><code class="w"> </code><code class="n">wikipedia</code><code class="p">;</code><code class="w"/>&#13;
&#13;
<code class="k">CREATE</code><code class="w"> </code><code class="k">TABLE</code><code class="w"> </code><code class="n">wikipedia</code><code class="p">.</code><code class="n">pages</code><code class="w"> </code><code class="p">(</code><code class="w"/>&#13;
<code class="w">  </code><code class="n">id</code><code class="w"> </code><code class="kt">INT</code><code class="w"> </code><code class="k">NOT</code><code class="w"> </code><code class="no">NULL</code><code class="w"> </code><code class="k">AUTO_INCREMENT</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">  </code><code class="n">url</code><code class="w"> </code><code class="kt">VARCHAR</code><code class="p">(</code><code class="mi">255</code><code class="p">)</code><code class="w"> </code><code class="k">NOT</code><code class="w"> </code><code class="no">NULL</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">  </code><code class="n">created</code><code class="w"> </code><code class="kt">TIMESTAMP</code><code class="w"> </code><code class="k">NOT</code><code class="w"> </code><code class="no">NULL</code><code class="w"> </code><code class="k">DEFAULT</code><code class="w"> </code><code class="k">CURRENT_TIMESTAMP</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">  </code><code class="k">PRIMARY</code><code class="w"> </code><code class="k">KEY</code><code class="w"> </code><code class="p">(</code><code class="n">id</code><code class="p">)</code><code class="w"/>&#13;
<code class="p">);</code><code class="w"/>&#13;
&#13;
<code class="k">CREATE</code><code class="w"> </code><code class="k">TABLE</code><code class="w"> </code><code class="n">wikipedia</code><code class="p">.</code><code class="n">links</code><code class="w"> </code><code class="p">(</code><code class="w"/>&#13;
<code class="w">  </code><code class="n">id</code><code class="w"> </code><code class="kt">INT</code><code class="w"> </code><code class="k">NOT</code><code class="w"> </code><code class="no">NULL</code><code class="w"> </code><code class="k">AUTO_INCREMENT</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">  </code><code class="n">fromPageId</code><code class="w"> </code><code class="kt">INT</code><code class="w"> </code><code class="no">NULL</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">  </code><code class="n">toPageId</code><code class="w"> </code><code class="kt">INT</code><code class="w"> </code><code class="no">NULL</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">  </code><code class="n">created</code><code class="w"> </code><code class="kt">TIMESTAMP</code><code class="w"> </code><code class="k">NOT</code><code class="w"> </code><code class="no">NULL</code><code class="w"> </code><code class="k">DEFAULT</code><code class="w"> </code><code class="k">CURRENT_TIMESTAMP</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">  </code><code class="k">PRIMARY</code><code class="w"> </code><code class="k">KEY</code><code class="w"> </code><code class="p">(</code><code class="n">id</code><code class="p">)</code><code class="w"/>&#13;
<code class="p">);</code><code class="w"/>&#13;
</pre>&#13;
&#13;
<p>Notice that, unlike with previous crawlers that print the title of the page, you’re not even storing the title of the page in the <code>pages</code> table. Why is that? Well, recording the title of the page requires that you visit the page to retrieve it. If you want to build an efficient web crawler to fill out these tables, you want to be able to store the page, as well as links to it, even if you haven’t necessarily visited the page yet.</p>&#13;
&#13;
<p>Although this doesn’t hold true for all sites, the nice thing about Wikipedia links and page titles is that one can be turned into the other through simple manipulation. For example, <em>http://en.wikipedia.org/wiki/Monty_Python</em> indicates that the title of the page is “Monty Python.”</p>&#13;
&#13;
<p>The following will store all pages on Wikipedia that have a “Bacon number” (the number of links between it and the page for Kevin Bacon, inclusive) of 6 or less:</p>&#13;
&#13;
<pre data-code-language="python" data-executable="true" data-type="programlisting">&#13;
<code class="kn">from</code> <code class="nn">urllib.request</code> <code class="kn">import</code> <code class="n">urlopen</code>&#13;
<code class="kn">from</code> <code class="nn">bs4</code> <code class="kn">import</code> <code class="n">BeautifulSoup</code>&#13;
<code class="kn">import</code> <code class="nn">re</code>&#13;
<code class="kn">import</code> <code class="nn">pymysql</code>&#13;
<code class="kn">from</code> <code class="nn">random</code> <code class="kn">import</code> <code class="n">shuffle</code>&#13;
&#13;
<code class="n">conn</code> <code class="o">=</code> <code class="n">pymysql</code><code class="o">.</code><code class="n">connect</code><code class="p">(</code><code class="n">host</code><code class="o">=</code><code class="s1">'127.0.0.1'</code><code class="p">,</code> <code class="n">unix_socket</code><code class="o">=</code><code class="s1">'/tmp/mysql.sock'</code><code class="p">,</code>&#13;
                       <code class="n">user</code><code class="o">=</code><code class="s1">'root'</code><code class="p">,</code> <code class="n">passwd</code><code class="o">=</code><code class="s1">'password'</code><code class="p">,</code> <code class="n">db</code><code class="o">=</code><code class="s1">'mysql'</code><code class="p">,</code> &#13;
                             <code class="n">charset</code><code class="o">=</code><code class="s1">'utf8'</code><code class="p">)</code>&#13;
<code class="n">cur</code> <code class="o">=</code> <code class="n">conn</code><code class="o">.</code><code class="n">cursor</code><code class="p">()</code>&#13;
<code class="n">cur</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s1">'USE wikipedia'</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">insertPageIfNotExists</code><code class="p">(</code><code class="n">url</code><code class="p">):</code>&#13;
    <code class="n">cur</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s1">'SELECT id FROM pages WHERE url = </code><code class="si">%s</code><code class="s1"> LIMIT 1'</code><code class="p">,</code> <code class="p">(</code><code class="n">url</code><code class="p">))</code>&#13;
    <code class="n">page</code> <code class="o">=</code> <code class="n">cur</code><code class="o">.</code><code class="n">fetchone</code><code class="p">()</code>&#13;
    <code class="k">if</code> <code class="ow">not</code> <code class="n">page</code><code class="p">:</code>&#13;
        <code class="n">cur</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s1">'INSERT INTO pages (url) VALUES (</code><code class="si">%s</code><code class="s1">)'</code><code class="p">,</code> <code class="p">(</code><code class="n">url</code><code class="p">))</code>&#13;
        <code class="n">conn</code><code class="o">.</code><code class="n">commit</code><code class="p">()</code>&#13;
        <code class="k">return</code> <code class="n">cur</code><code class="o">.</code><code class="n">lastrowid</code>&#13;
    <code class="k">else</code><code class="p">:</code>&#13;
        <code class="k">return</code> <code class="n">page</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">loadPages</code><code class="p">():</code>&#13;
    <code class="n">cur</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s1">'SELECT url FROM pages'</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="p">[</code><code class="n">row</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code> <code class="k">for</code> <code class="n">row</code> <code class="ow">in</code> <code class="n">cur</code><code class="o">.</code><code class="n">fetchall</code><code class="p">()]</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">insertLink</code><code class="p">(</code><code class="n">fromPageId</code><code class="p">,</code> <code class="n">toPageId</code><code class="p">):</code>&#13;
    <code class="n">cur</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code>&#13;
        <code class="s1">'SELECT EXISTS(SELECT 1 FROM links WHERE fromPageId = </code><code class="si">%s</code><code class="se">\</code>&#13;
<code class="s1"> AND toPageId = </code><code class="si">%s</code><code class="s1">)'</code>&#13;
        <code class="p">,(</code><code class="nb">int</code><code class="p">(</code><code class="n">fromPageId</code><code class="p">),</code>&#13;
        <code class="nb">int</code><code class="p">(</code><code class="n">toPageId</code><code class="p">))</code>&#13;
    <code class="p">)</code>&#13;
    <code class="k">if</code> <code class="ow">not</code> <code class="n">cur</code><code class="o">.</code><code class="n">fetchone</code><code class="p">()[</code><code class="mi">0</code><code class="p">]:</code>&#13;
        <code class="n">cur</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s1">'INSERT INTO links (fromPageId, toPageId) VALUES (</code><code class="si">%s</code><code class="s1">, </code><code class="si">%s</code><code class="s1">)'</code><code class="p">,</code> &#13;
                    <code class="p">(</code><code class="nb">int</code><code class="p">(</code><code class="n">fromPageId</code><code class="p">),</code> <code class="nb">int</code><code class="p">(</code><code class="n">toPageId</code><code class="p">)))</code>&#13;
        <code class="n">conn</code><code class="o">.</code><code class="n">commit</code><code class="p">()</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">pageHasLinks</code><code class="p">(</code><code class="n">pageId</code><code class="p">):</code>&#13;
    <code class="n">cur</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code>&#13;
        <code class="s1">'SELECT EXISTS(SELECT 1 FROM links WHERE fromPageId = </code><code class="si">%s</code><code class="s1">)'</code>&#13;
        <code class="p">,</code> <code class="p">(</code><code class="nb">int</code><code class="p">(</code><code class="n">pageId</code><code class="p">))</code>&#13;
    <code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">cur</code><code class="o">.</code><code class="n">fetchone</code><code class="p">()[</code><code class="mi">0</code><code class="p">]</code>&#13;
&#13;
&#13;
<code class="k">def</code> <code class="nf">getLinks</code><code class="p">(</code><code class="n">pageUrl</code><code class="p">,</code> <code class="n">recursionLevel</code><code class="p">,</code> <code class="n">pages</code><code class="p">):</code>&#13;
    <code class="k">if</code> <code class="n">recursionLevel</code> <code class="o">&gt;</code> <code class="mi">4</code><code class="p">:</code>&#13;
        <code class="k">return</code>&#13;
&#13;
    <code class="n">pageId</code> <code class="o">=</code> <code class="n">insertPageIfNotExists</code><code class="p">(</code><code class="n">pageUrl</code><code class="p">)</code>&#13;
    <code class="n">html</code> <code class="o">=</code> <code class="n">urlopen</code><code class="p">(</code><code class="sa">f</code><code class="s1">'http://en.wikipedia.org</code><code class="si">{</code><code class="n">pageUrl</code><code class="si">}</code><code class="s1">'</code><code class="p">)</code>&#13;
    <code class="n">bs</code> <code class="o">=</code> <code class="n">BeautifulSoup</code><code class="p">(</code><code class="n">html</code><code class="p">,</code> <code class="s1">'html.parser'</code><code class="p">)</code>&#13;
    <code class="n">links</code> <code class="o">=</code> <code class="n">bs</code><code class="o">.</code><code class="n">findAll</code><code class="p">(</code><code class="s1">'a'</code><code class="p">,</code> <code class="n">href</code><code class="o">=</code><code class="n">re</code><code class="o">.</code><code class="n">compile</code><code class="p">(</code><code class="s1">'^(/wiki/)((?!:).)*$'</code><code class="p">))</code>&#13;
    <code class="n">links</code> <code class="o">=</code> <code class="p">[</code><code class="n">link</code><code class="o">.</code><code class="n">attrs</code><code class="p">[</code><code class="s1">'href'</code><code class="p">]</code> <code class="k">for</code> <code class="n">link</code> <code class="ow">in</code> <code class="n">links</code><code class="p">]</code>&#13;
&#13;
    <code class="k">for</code> <code class="n">link</code> <code class="ow">in</code> <code class="n">links</code><code class="p">:</code>&#13;
        <code class="n">linkId</code> <code class="o">=</code> <code class="n">insertPageIfNotExists</code><code class="p">(</code><code class="n">link</code><code class="p">)</code>&#13;
        <code class="n">insertLink</code><code class="p">(</code><code class="n">pageId</code><code class="p">,</code> <code class="n">linkId</code><code class="p">)</code>&#13;
        <code class="k">if</code> <code class="ow">not</code> <code class="n">pageHasLinks</code><code class="p">(</code><code class="n">linkId</code><code class="p">):</code>&#13;
            <code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s1">'Getting </code><code class="si">{</code><code class="n">link</code><code class="si">}</code><code class="s1">'</code><code class="p">)</code>&#13;
            <code class="n">pages</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">link</code><code class="p">)</code>&#13;
            <code class="n">getLinks</code><code class="p">(</code><code class="n">link</code><code class="p">,</code> <code class="n">recursionLevel</code><code class="o">+</code><code class="mi">1</code><code class="p">,</code> <code class="n">pages</code><code class="p">)</code>&#13;
        <code class="k">else</code><code class="p">:</code>&#13;
            <code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s1">'Already fetched </code><code class="si">{</code><code class="n">link</code><code class="si">}</code><code class="s1">'</code><code class="p">)</code>&#13;
        &#13;
        &#13;
<code class="n">getLinks</code><code class="p">(</code><code class="s1">'/wiki/Kevin_Bacon'</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="n">loadPages</code><code class="p">())</code> &#13;
<code class="n">cur</code><code class="o">.</code><code class="n">close</code><code class="p">()</code>&#13;
<code class="n">conn</code><code class="o">.</code><code class="n">close</code><code class="p">()</code>&#13;
</pre>&#13;
&#13;
<p>Three functions here use PyMySQL to interface with the database:</p>&#13;
&#13;
<dl>&#13;
	<dt><code>insertPageIfNotExists</code></dt>&#13;
	<dd>As its name indicates, this function inserts a new page record if it does not exist already. This, along with the running list of all collected pages stored in <code>pages</code>, ensures that page records are not duplicated. It also serves to look up <code>pageId</code> numbers in order to create new links.</dd>&#13;
	<dt><code>insertLink</code></dt>&#13;
	<dd>This creates a new link record in the database. It will not create a link if that link already exists. Even if two or more identical links <em>do</em> exist on the page, for our purposes, they are the same link, represent the same relationship, and should be counted as only one record. This also helps maintain the integrity of the database if the program is run multiple times, even over the same pages.</dd>&#13;
	<dt><code>loadPages</code></dt>&#13;
	<dd>This loads all current pages from the database into a list, so that it can be determined whether a new page should be visited. Pages are also collected during runtime, so if this crawler is run only once, starting with an empty database, in theory <code>loadPage</code> should not be needed. In practice, however, problems may arise. The network might go down, or you might want to collect links over several periods of time, and it’s important for the crawler to be able to reload itself and not lose any ground.</dd>&#13;
</dl>&#13;
&#13;
<p>You should be aware of one potentially problematic subtlety of using <code>loadPages</code>, and the <code>pages</code> list it generates, to determine whether or not to visit a page: as soon as each page is loaded, all the links on that page are stored as pages, even though they have not been visited yet—just their links have been seen. If the crawler is stopped and restarted, all of these “seen but not visited” pages will never be visited, and links coming from them will not be recorded. This might be fixed by adding a boolean <code>visited</code> variable to each page record and setting it to <code>True</code> only if that page has been loaded and its own outgoing links recorded.</p>&#13;
&#13;
<p>For our purposes, however, this solution is fine as is. If you can ensure fairly long runtimes (or just a single runtime), and it isn’t a necessity to ensure a complete set of links (just a large dataset to experiment with), the addition of the <code>visited</code> variable is <a contenteditable="false" data-primary="Six Degrees of Wikipedia" data-secondary="MySQL and" data-startref="sxdwkal" data-type="indexterm" id="id579"/><a contenteditable="false" data-primary="MySQL" data-secondary="Six Degrees of Wikipedia" data-startref="mqxdkp" data-type="indexterm" id="id580"/>not necessary.</p>&#13;
&#13;
<p>For the continuation of this problem and the final solution for getting from <a href="https://en.wikipedia.org/wiki/Kevin_Bacon">Kevin Bacon</a> to <a href="https://en.wikipedia.org/wiki/Eric_Idle">Eric Idle</a>, see <a data-type="xref" href="ch12.html#six-degrees-conclusion">“Six Degrees of Wikipedia: Conclusion”</a> on solving directed graph problems.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Email" data-type="sect1"><div class="sect1" id="id58">&#13;
<h1>Email</h1>&#13;
&#13;
<p>Just as web pages are sent over HTTP, email is sent over SMTP (Simple Mail Transfer Protocol). And just as <a contenteditable="false" data-primary="email" data-secondary="SMTP (Simple Mail Transfer Protocol)" data-type="indexterm" id="esmpt"/><a contenteditable="false" data-primary="SMTP (Simple Mail Transfer Protocol)" data-type="indexterm" id="ssmmpp"/>you use a web server client to handle sending out web pages over HTTP, servers use various email clients, such as Sendmail, Postfix, or Mailman, to send and receive email.</p>&#13;
&#13;
<p class="pagebreak-before">Although sending email with Python is relatively easy, it does require that you have access to a server running SMTP. Setting up an SMTP client on your server or local machine is tricky and outside the scope of this book, but many excellent resources can help with this task, particularly if you are running Linux or macOS.</p>&#13;
&#13;
<p>The following code examples assume that you are running an SMTP client locally. (To modify this code for a remote SMTP client, change <code>localhost</code> to your remote server’s address.)</p>&#13;
&#13;
<p>Sending an email with Python requires just nine lines of code:</p>&#13;
&#13;
<pre data-code-language="python" data-executable="true" data-type="programlisting">&#13;
<code class="kn">import</code> <code class="nn">smtplib</code>&#13;
<code class="kn">from</code> <code class="nn">email.mime.text</code> <code class="kn">import</code> <code class="n">MIMEText</code>&#13;
&#13;
<code class="n">msg</code> <code class="o">=</code> <code class="n">MIMEText</code><code class="p">(</code><code class="s1">'The body of the email is here'</code><code class="p">)</code>&#13;
&#13;
<code class="n">msg</code><code class="p">[</code><code class="s1">'Subject'</code><code class="p">]</code> <code class="o">=</code> <code class="s1">'An Email Alert'</code>&#13;
<code class="n">msg</code><code class="p">[</code><code class="s1">'From'</code><code class="p">]</code> <code class="o">=</code> <code class="s1">'ryan@pythonscraping.com'</code>&#13;
<code class="n">msg</code><code class="p">[</code><code class="s1">'To'</code><code class="p">]</code> <code class="o">=</code> <code class="s1">'webmaster@pythonscraping.com'</code>&#13;
&#13;
<code class="n">s</code> <code class="o">=</code> <code class="n">smtplib</code><code class="o">.</code><code class="n">SMTP</code><code class="p">(</code><code class="s1">'localhost'</code><code class="p">)</code>&#13;
<code class="n">s</code><code class="o">.</code><code class="n">send_message</code><code class="p">(</code><code class="n">msg</code><code class="p">)</code>&#13;
<code class="n">s</code><code class="o">.</code><code class="n">quit</code><code class="p">()</code>&#13;
</pre>&#13;
&#13;
<p>Python contains two important packages <a contenteditable="false" data-primary="Python" data-secondary="email module" data-type="indexterm" id="id581"/><a contenteditable="false" data-primary="email" data-secondary="smtplib package" data-type="indexterm" id="id582"/><a contenteditable="false" data-primary="email" data-secondary="email package" data-type="indexterm" id="id583"/><a contenteditable="false" data-primary="smtplib package" data-type="indexterm" id="id584"/>for sending email: <em>smtplib</em> and<em> email</em>.</p>&#13;
&#13;
<p>Python’s email module contains useful formatting <a contenteditable="false" data-primary="email" data-secondary="MIME (Multipurpose Internet Mail Extensions)" data-type="indexterm" id="id585"/><a contenteditable="false" data-primary="MIME (Multipurpose Internet Mail Extensions)" data-type="indexterm" id="id586"/>functions for creating email packets to send. The <code>MIMEText</code> object, used here, creates an empty email formatted for transfer with the low-level MIME (Multipurpose Internet Mail Extensions) protocol, across which the higher-level SMTP connections are made. The <code>MIMEText</code> object, <code>msg</code>, contains to/from email addresses, as well as a body and a header, which Python uses to create a properly formatted email.</p>&#13;
&#13;
<p>The smtplib package contains information for handling the connection to the server. Just like a connection to a MySQL server, this connection must be torn down every time it is created to avoid creating too many connections.</p>&#13;
&#13;
<p>This basic email function can be extended and made more useful by enclosing it in a function:</p>&#13;
&#13;
<pre data-code-language="python" data-executable="true" data-type="programlisting">&#13;
<code class="kn">import</code> <code class="nn">smtplib</code>&#13;
<code class="kn">from</code> <code class="nn">email.mime.text</code> <code class="kn">import</code> <code class="n">MIMEText</code>&#13;
<code class="kn">from</code> <code class="nn">bs4</code> <code class="kn">import</code> <code class="n">BeautifulSoup</code>&#13;
<code class="kn">from</code> <code class="nn">urllib.request</code> <code class="kn">import</code> <code class="n">urlopen</code>&#13;
<code class="kn">import</code> <code class="nn">time</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">sendMail</code><code class="p">(</code><code class="n">subject</code><code class="p">,</code> <code class="n">body</code><code class="p">):</code>&#13;
    <code class="n">msg</code> <code class="o">=</code> <code class="n">MIMEText</code><code class="p">(</code><code class="n">body</code><code class="p">)</code>&#13;
    <code class="n">msg</code><code class="p">[</code><code class="s1">'Subject'</code><code class="p">]</code> <code class="o">=</code> <code class="n">subject</code>&#13;
    <code class="n">msg</code><code class="p">[</code><code class="s1">'From'</code><code class="p">]</code> <code class="o">=</code><code class="s1">'christmas_alerts@pythonscraping.com'</code>&#13;
    <code class="n">msg</code><code class="p">[</code><code class="s1">'To'</code><code class="p">]</code> <code class="o">=</code> <code class="s1">'ryan@pythonscraping.com'</code>&#13;
&#13;
    <code class="n">s</code> <code class="o">=</code> <code class="n">smtplib</code><code class="o">.</code><code class="n">SMTP</code><code class="p">(</code><code class="s1">'localhost'</code><code class="p">)</code>&#13;
    <code class="n">s</code><code class="o">.</code><code class="n">send_message</code><code class="p">(</code><code class="n">msg</code><code class="p">)</code>&#13;
    <code class="n">s</code><code class="o">.</code><code class="n">quit</code><code class="p">()</code>&#13;
&#13;
<code class="n">bs</code> <code class="o">=</code> <code class="n">BeautifulSoup</code><code class="p">(</code><code class="n">urlopen</code><code class="p">(</code><code class="s1">'https://isitchristmas.com/'</code><code class="p">),</code> <code class="s1">'html.parser'</code><code class="p">)</code>&#13;
<code class="k">while</code><code class="p">(</code><code class="n">bs</code><code class="o">.</code><code class="n">find</code><code class="p">(</code><code class="s1">'a'</code><code class="p">,</code> <code class="p">{</code><code class="s1">'id'</code><code class="p">:</code><code class="s1">'answer'</code><code class="p">})</code><code class="o">.</code><code class="n">attrs</code><code class="p">[</code><code class="s1">'title'</code><code class="p">]</code> <code class="o">==</code> <code class="s1">'NO'</code><code class="p">):</code>&#13;
    <code class="nb">print</code><code class="p">(</code><code class="s1">'It is not Christmas yet.'</code><code class="p">)</code>&#13;
    <code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mi">3600</code><code class="p">)</code>&#13;
    <code class="n">bs</code> <code class="o">=</code> <code class="n">BeautifulSoup</code><code class="p">(</code><code class="n">urlopen</code><code class="p">(</code><code class="s1">'https://isitchristmas.com/'</code><code class="p">),</code> <code class="s1">'html.parser'</code><code class="p">)</code>&#13;
&#13;
<code class="n">sendMail</code><code class="p">(</code><code class="s1">'It</code><code class="se">\'</code><code class="s1">s Christmas!'</code><code class="p">,</code> &#13;
         <code class="s1">'According to http://itischristmas.com, it is Christmas!'</code><code class="p">)</code>&#13;
&#13;
</pre>&#13;
&#13;
<p>This particular script checks the website <a href="https://isitchristmas.com"><em>https://isitchristmas.com</em></a> (the main feature of which is a giant YES or NO, depending on the day of the year) once an hour. If it sees anything other than a NO, it will send you an email alerting you that it’s Christmas.</p>&#13;
&#13;
<p>Although this particular program might not <a contenteditable="false" data-primary="email" data-secondary="SMTP (Simple Mail Transfer Protocol)" data-startref="esmpt" data-type="indexterm" id="id587"/><a contenteditable="false" data-primary="SMTP (Simple Mail Transfer Protocol)" data-startref="ssmmpp" data-type="indexterm" id="id588"/>seem much more useful than a calendar hanging on your wall, it can be slightly tweaked to do a variety of extremely useful things. It can email you alerts in response to site outages, test failures, or even the appearance of an out-of-stock product you’re waiting for on Amazon—none of which your wall calendar can do.</p>&#13;
</div></section>&#13;
<div data-type="footnotes"><p data-type="footnote" id="id556"><sup><a href="ch09.html#id556-marker">1</a></sup> Joab Jackson, <a href="http://bit.ly/1LWVmc8">“YouTube Scales MySQL with Go Code”</a>, <em>PCWorld</em>, December 15, 2012.</p><p data-type="footnote" id="id557"><sup><a href="ch09.html#id557-marker">2</a></sup> Jeremy Cole and Davi Arnaut, <a href="http://bit.ly/1KHDKns">“MySQL at Twitter”</a>, <em>The Twitter Engineering Blog</em>, April 9, 2012.</p><p data-type="footnote" id="id558"><sup><a href="ch09.html#id558-marker">3</a></sup> <a href="http://on.fb.me/1RFMqvw">“MySQL and Database Engineering: Mark Callaghan”</a>, Facebook Engineering, March 4, 2012.</p></div></div></section></body></html>