<html><head></head><body><section data-pdf-bookmark="Chapter 17. Data Discovery and Visualization" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch17">&#13;
<h1><span class="label">Chapter 17. </span>Data Discovery and Visualization</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Preview" data-type="sect1"><div class="sect1" id="id159">&#13;
<h1>Preview</h1>&#13;
&#13;
<p><a data-primary="data discovery and visualization" data-type="indexterm" id="icd087"/>Although FastAPI does have <em>API</em> in its name,&#13;
it can serve more things than APIs.&#13;
This chapter shows you how to generate&#13;
tables, plots, graphs, and maps&#13;
from data,&#13;
using a small database of imaginary creatures from&#13;
around the world.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Python and Data" data-type="sect1"><div class="sect1" id="id160">&#13;
<h1>Python and Data</h1>&#13;
&#13;
<p><a data-primary="Python" data-secondary="data and" data-type="indexterm" id="id973"/>Python has become very popular in the&#13;
last few years for many reasons:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Ease of learning</p>&#13;
</li>&#13;
<li>&#13;
<p>Clean syntax</p>&#13;
</li>&#13;
<li>&#13;
<p>Rich standard library</p>&#13;
</li>&#13;
<li>&#13;
<p>Huge number of high-quality third-party packages</p>&#13;
</li>&#13;
<li>&#13;
<p>Special emphasis on data manipulation, conversion, and introspection</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The last point has always been relevant for traditional <a data-primary="ETL (extract, transform, load)" data-type="indexterm" id="id974"/>ETL tasks for database creation.&#13;
A nonprofit <a data-primary="pydata" data-type="indexterm" id="id975"/>group called&#13;
<a href="https://pydata.org">PyData</a>&#13;
even organizes conferences and develops tools for&#13;
open source data analysis with Python.&#13;
The popularity of Python also reflects the recent surge in AI and the need for&#13;
tools to prepare the data that feeds AI models.</p>&#13;
&#13;
<p>In this chapter, we’ll try some Python data packages and see&#13;
how they relate to modern Python web development and FastAPI.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="PSV Text Output" data-type="sect1"><div class="sect1" id="id161">&#13;
<h1>PSV Text Output</h1>&#13;
&#13;
<p><a data-primary="data discovery and visualization" data-secondary="PSV text output" data-type="indexterm" id="icd088"/>In<a data-primary="PSV text output" data-type="indexterm" id="icd091"/> this section, we’ll use the creatures listed in <a data-type="xref" href="app02.html#app02">Appendix B</a>.&#13;
The data is in this book’s GitHub repo,&#13;
in&#13;
the pipe-separated file <em>cryptid.psv</em>&#13;
and the SQLite database <em>cryptid.db</em>.&#13;
Comma-separated (<em>.csv</em>)&#13;
and tab-separated (<em>.tsv</em>) files are common,&#13;
but commas are used within the data cells themselves,&#13;
and tabs are sometimes hard to distinguish&#13;
from other whitespace.&#13;
The pipe character (<code>|</code>) is distinct,&#13;
and rare enough in standard&#13;
text to serve as a good separator.</p>&#13;
&#13;
<p>Let’s try the <em>.psv</em> text file first,&#13;
using just text output&#13;
examples for simplicity,&#13;
and then&#13;
go on to full web examples using the SQLite database.</p>&#13;
&#13;
<p>The initial header line of the <em>.psv</em> file&#13;
contains the names of the fields:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><code>name</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>country</code> (<code>*</code> means many countries)</p>&#13;
</li>&#13;
<li>&#13;
<p><code>area</code> (optional, US state or other country area)</p>&#13;
</li>&#13;
<li>&#13;
<p><code>description</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>aka</code> (also known as)</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The rest of the lines in the file&#13;
describe one creature at a time,&#13;
with the fields in that order, separated by a <code>|</code> character.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="csv" data-type="sect2"><div class="sect2" id="id162">&#13;
<h2>csv</h2>&#13;
&#13;
<p><a data-type="xref" href="#ex-17-1">Example 17-1</a>&#13;
reads<a data-primary="PSV text output" data-secondary="csv package" data-type="indexterm" id="icd089"/> the<a data-primary="csv package" data-type="indexterm" id="icd090"/> creature data into Python data structures.&#13;
First, the pipe-separated file&#13;
<em>cryptids.psv</em>&#13;
can be read with the standard Python&#13;
csv package,&#13;
yielding a list of tuples, where each tuple represents a line of&#13;
data from the file.&#13;
(The csv package also includes a <code>DictReader</code>&#13;
that returns a list of dicts instead.)&#13;
The first line of this file is a header&#13;
with the names of the columns;&#13;
without this, we could still supply the headers through&#13;
arguments to csv functions.</p>&#13;
&#13;
<p>I’m including type hints in the examples,&#13;
but you can drop these if you have an older version of Python,&#13;
and the code will still work.&#13;
Let’s print only the header and first five lines,&#13;
to save&#13;
a few trees.<sup><a data-type="noteref" href="ch17.html#id976" id="id976-marker">1</a></sup></p>&#13;
<div class="pagebreak-before less_space" data-type="example" id="ex-17-1">&#13;
<h5><span class="label">Example 17-1. </span>Read PSV file with csv (<span class="plain">load_csv.py</span>)</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">csv</code>&#13;
<code class="kn">import</code> <code class="nn">sys</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">read_csv</code><code class="p">(</code><code class="n">fname</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">list</code><code class="p">[</code><code class="nb">tuple</code><code class="p">]:</code>&#13;
    <code class="k">with</code> <code class="nb">open</code><code class="p">(</code><code class="n">fname</code><code class="p">)</code> <code class="k">as</code> <code class="n">file</code><code class="p">:</code>&#13;
        <code class="n">data</code> <code class="o">=</code> <code class="p">[</code><code class="n">row</code> <code class="k">for</code> <code class="n">row</code> <code class="ow">in</code> <code class="n">csv</code><code class="o">.</code><code class="n">reader</code><code class="p">(</code><code class="n">file</code><code class="p">,</code> <code class="n">delimiter</code><code class="o">=</code><code class="s2">"|"</code><code class="p">)]</code>&#13;
    <code class="k">return</code> <code class="n">data</code>&#13;
&#13;
<code class="k">if</code> <code class="vm">__name__</code> <code class="o">==</code> <code class="s2">"__main__"</code><code class="p">:</code>&#13;
    <code class="n">data</code> <code class="o">=</code> <code class="n">read_csv</code><code class="p">(</code><code class="n">sys</code><code class="o">.</code><code class="n">argv</code><code class="p">[</code><code class="mi">1</code><code class="p">])</code>&#13;
    <code class="k">for</code> <code class="n">row</code> <code class="ow">in</code> <code class="n">data</code><code class="p">[</code><code class="mi">0</code><code class="p">:</code><code class="mi">5</code><code class="p">]:</code>&#13;
        <code class="nb">print</code><code class="p">(</code><code class="n">row</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>Now run the test in <a data-type="xref" href="#ex-17-2">Example 17-2</a>.<a data-primary="PSV text output" data-secondary="csv package" data-startref="icd089" data-type="indexterm" id="id977"/><a data-primary="csv package" data-startref="icd090" data-type="indexterm" id="id978"/></p>&#13;
<div data-type="example" id="ex-17-2">&#13;
<h5><span class="label">Example 17-2. </span>Test CSV database loading</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>python load_csv.py cryptid.psv</strong>&#13;
['name', 'country', 'area', 'description', 'aka']&#13;
['Abaia', 'FJ', ' ', 'Lake eel', ' ']&#13;
['Afanc', 'UK', 'CYM', 'Welsh lake monster', ' ']&#13;
['Agropelter', 'US', 'ME', 'Forest twig flinger', ' ']&#13;
['Akkorokamui', 'JP', ' ', 'Giant Ainu octopus', ' ']&#13;
['Albatwitch', 'US', 'PA', 'Apple stealing mini Bigfoot', ' ']</pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="python-tabulate" data-type="sect2"><div class="sect2" id="id163">&#13;
<h2>python-tabulate</h2>&#13;
&#13;
<p><a data-primary="PSV text output" data-secondary="python-tabulate" data-type="indexterm" id="id979"/>Let’s<a data-primary="python-tabulate" data-type="indexterm" id="id980"/> try one more open source tool,&#13;
<a href="https://oreil.ly/L0f6k">python-tabulate</a>,&#13;
that is specifically designed for tabular output.&#13;
You’ll need to run <code>pip install tabulate</code> first.&#13;
<a data-type="xref" href="#ex-17-3">Example 17-3</a> shows the code.</p>&#13;
<div data-type="example" id="ex-17-3">&#13;
<h5><span class="label">Example 17-3. </span>Read PSV file with python-tabulate (<span class="plain">load_tabulate.py</span>)</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">tabulate</code> <code class="kn">import</code> <code class="n">tabulate</code>&#13;
<code class="kn">import</code> <code class="nn">sys</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">read_csv</code><code class="p">(</code><code class="n">fname</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">list</code><code class="p">[</code><code class="nb">tuple</code><code class="p">]:</code>&#13;
    <code class="k">with</code> <code class="nb">open</code><code class="p">(</code><code class="n">fname</code><code class="p">)</code> <code class="k">as</code> <code class="n">file</code><code class="p">:</code>&#13;
        <code class="n">data</code> <code class="o">=</code> <code class="p">[</code><code class="n">row</code> <code class="k">for</code> <code class="n">row</code> <code class="ow">in</code> <code class="n">csv</code><code class="o">.</code><code class="n">reader</code><code class="p">(</code><code class="n">file</code><code class="p">,</code> <code class="n">delimiter</code><code class="o">=</code><code class="s2">"|"</code><code class="p">)]</code>&#13;
    <code class="k">return</code> <code class="n">data</code>&#13;
&#13;
<code class="k">if</code> <code class="vm">__name__</code> <code class="o">==</code> <code class="s2">"__main__"</code><code class="p">:</code>&#13;
    <code class="n">data</code> <code class="o">=</code> <code class="n">read_csv</code><code class="p">(</code><code class="n">sys</code><code class="o">.</code><code class="n">argv</code><code class="p">[</code><code class="mi">1</code><code class="p">])</code>&#13;
    <code class="nb">print</code><code class="p">(</code><code class="n">tabulate</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="mi">0</code><code class="p">:</code><code class="mi">5</code><code class="p">]))</code></pre></div>&#13;
&#13;
<p>Run <a data-type="xref" href="#ex-17-3">Example 17-3</a> in <a data-type="xref" href="#ex-17-4">Example 17-4</a>.</p>&#13;
<div data-type="example" id="ex-17-4">&#13;
<h5><span class="label">Example 17-4. </span>Run the tabulate load script</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>python load_tabulate.py cryptid.psv</strong>&#13;
-----------  -------  ----  -------------------  ---&#13;
Name         Country  Area  Description          AKA&#13;
Abaia        FJ             Lake eel&#13;
Afanc        UK       CYM   Welsh lake monster&#13;
Agropelter   US       ME    Forest twig flinger&#13;
Akkorokamui  JP             Giant Ainu octopus&#13;
-----------  -------  ----  -------------------  ---</pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="pandas" data-type="sect2"><div class="sect2" id="id164">&#13;
<h2>pandas</h2>&#13;
&#13;
<p><a data-primary="PSV text output" data-secondary="pandas" data-type="indexterm" id="id981"/>The<a data-primary="pandas" data-type="indexterm" id="id982"/> two previous examples were mostly output formatters.&#13;
<a href="https://pandas.pydata.org">Pandas</a>&#13;
is an excellent tool for slicing and dicing data.&#13;
It goes beyond the standard Python data structures&#13;
with advanced constructs like the&#13;
<a href="https://oreil.ly/j-8eh">DataFrame</a>: a combination of a table, dictionary, and series.&#13;
It can also read <em>.csv</em> and other character-separated files.&#13;
<a data-type="xref" href="#ex-17-5">Example 17-5</a> is like the previous examples,&#13;
but pandas returns a DataFrame instead of a list of tuples.</p>&#13;
<div data-type="example" id="ex-17-5">&#13;
<h5><span class="label">Example 17-5. </span>Read PSV file with pandas (<span class="plain">load_pandas.py</span>)</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">pandas</code>&#13;
<code class="kn">import</code> <code class="nn">sys</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">read_pandas</code><code class="p">(</code><code class="n">fname</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">pandas</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">:</code>&#13;
    <code class="n">data</code> <code class="o">=</code> <code class="n">pandas</code><code class="o">.</code><code class="n">read_csv</code><code class="p">(</code><code class="n">fname</code><code class="p">,</code> <code class="n">sep</code><code class="o">=</code><code class="s2">"|"</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">data</code>&#13;
&#13;
<code class="k">if</code> <code class="vm">__name__</code> <code class="o">==</code> <code class="s2">"__main__"</code><code class="p">:</code>&#13;
    <code class="n">data</code> <code class="o">=</code> <code class="n">read_pandas</code><code class="p">(</code><code class="n">sys</code><code class="o">.</code><code class="n">argv</code><code class="p">[</code><code class="mi">1</code><code class="p">])</code>&#13;
    <code class="nb">print</code><code class="p">(</code><code class="n">data</code><code class="o">.</code><code class="n">head</code><code class="p">(</code><code class="mi">5</code><code class="p">))</code></pre></div>&#13;
&#13;
<p>Run <a data-type="xref" href="#ex-17-5">Example 17-5</a> in <a data-type="xref" href="#ex-17-6">Example 17-6</a>.</p>&#13;
<div data-type="example" id="ex-17-6">&#13;
<h5><span class="label">Example 17-6. </span>Run the pandas load script</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>python load_pandas.py cryptid.psv</strong>&#13;
          name country area                  description aka&#13;
0        Abaia      FJ                          Lake eel&#13;
1        Afanc      UK  CYM           Welsh lake monster&#13;
2   Agropelter      US   ME          Forest twig flinger&#13;
3  Akkorokamui      JP                Giant Ainu octopus&#13;
4   Albatwitch      US   PA  Apple stealing mini Bigfoot</pre></div>&#13;
&#13;
<p>Pandas has a metric boatload of interesting functions,&#13;
so take a <a data-primary="PSV text output" data-startref="icd091" data-type="indexterm" id="id983"/>look<a data-primary="data discovery and visualization" data-secondary="PSV text output" data-startref="icd088" data-type="indexterm" id="id984"/>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="SQLite Data Source and Web Output" data-type="sect1"><div class="sect1" id="id229">&#13;
<h1>SQLite Data Source and Web Output</h1>&#13;
&#13;
<p><a data-primary="data discovery and visualization" data-secondary="SQLite data source and web output" data-type="indexterm" id="icd092"/>For<a data-primary="SQLite" data-secondary="data source and web output" data-type="indexterm" id="icd093"/> the rest of the examples in this chapter,&#13;
you’ll read creature data from the SQLite database,&#13;
using some of the&#13;
website code from earlier chapters.&#13;
Then you’ll slice, dice, and marinate&#13;
the data with different recipes.&#13;
Instead of simple text output,&#13;
you’ll install each example into our&#13;
ever-growing cryptid website.&#13;
You’ll need a few additions to our existing&#13;
Web, Service, and Data levels.</p>&#13;
&#13;
<p>First, you need a Web-level function and an associated&#13;
HTTP <code>GET</code> route to return all the creature data.&#13;
And you already have one!&#13;
Let’s make a web call to get everything,&#13;
but again show only the first few lines (trees, you know).&#13;
That’s <a data-type="xref" href="#ex-17-7">Example 17-7</a>,&#13;
right here.</p>&#13;
<div data-type="example" id="ex-17-7">&#13;
<h5><span class="label">Example 17-7. </span>Run the creature download test (truncated; trees are watching)</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http -b localhost:8000/creature</strong>&#13;
[&#13;
    {&#13;
        "aka": "AKA",&#13;
        "area": "Area",&#13;
        "country": "Country",&#13;
        "description": "Description",&#13;
        "name": "Name"&#13;
    },&#13;
    {&#13;
        "aka": " ",&#13;
        "area": " ",&#13;
        "country": "FJ",&#13;
        "description": "Lake eel",&#13;
        "name": "Abaia"&#13;
    },&#13;
...&#13;
]</pre></div>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Chart/Graph Packages" data-type="sect2"><div class="sect2" id="id165">&#13;
<h2>Chart/Graph Packages</h2>&#13;
&#13;
<p><a data-primary="SQLite" data-secondary="chart/graph packages" data-type="indexterm" id="icd094"/>Now<a data-primary="chart/graph packages" data-type="indexterm" id="icd098"/> we can go beyond text to GUIs.&#13;
Some of the most useful and popular Python packages&#13;
for graphical data displays include the following:</p>&#13;
<dl>&#13;
<dt><a href="https://matplotlib.org">Matplotlib</a></dt>&#13;
<dd>&#13;
<p><a data-primary="Matplotlib" data-type="indexterm" id="id985"/>Extensive, but needs some fiddling to get the prettiest results</p>&#13;
</dd>&#13;
<dt><a href="https://plotly.com/python">Plotly</a></dt>&#13;
<dd>&#13;
<p><a data-primary="Plotly" data-type="indexterm" id="id986"/>Similar to Matplotlib and Seaborn, with an emphasis on interactive graphs</p>&#13;
</dd>&#13;
<dt><a href="https://dash.plotly.com">Dash</a></dt>&#13;
<dd>&#13;
<p><a data-primary="Dash" data-type="indexterm" id="id987"/>Built on Plotly as a sort of data dashboard</p>&#13;
</dd>&#13;
<dt><a href="https://seaborn.pydata.org">Seaborn</a></dt>&#13;
<dd>&#13;
<p><a data-primary="Seaborn" data-type="indexterm" id="id988"/>Built on Matplotlib and offers a higher-level interface, but with less graph types</p>&#13;
</dd>&#13;
<dt><a href="http://bokeh.org">Bokeh</a></dt>&#13;
<dd>&#13;
<p><a data-primary="Bokeh" data-type="indexterm" id="id989"/>Integrates with JavaScript to provide dashboard views of very large datasets</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>How can you decide? You can consider the following criteria:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Graph types (e.g., scatter, bar, line)</p>&#13;
</li>&#13;
<li>&#13;
<p>Styling</p>&#13;
</li>&#13;
<li>&#13;
<p>Ease of use</p>&#13;
</li>&#13;
<li>&#13;
<p>Performance</p>&#13;
</li>&#13;
<li>&#13;
<p>Data limits</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Comparisons like <a href="https://oreil.ly/10Nsw">“Top 6 Python Libraries for Visualization: Which One to Use?”</a> by khuyentran1476 can help you choose.&#13;
In the end, the choice often comes down to&#13;
the one that you figure out enough about first. For this chapter, I chose Plotly,&#13;
which can create attractive plots without too much coding.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Chart Example 1: Test" data-type="sect2"><div class="sect2" id="id166">&#13;
<h2>Chart Example 1: Test</h2>&#13;
&#13;
<p>Plotly<a data-primary="Plotly" data-type="indexterm" id="icd096"/> is an open source (free) Python library&#13;
with multiple levels of control and detail:</p>&#13;
<dl>&#13;
<dt><a href="https://plotly.com/python/plotly-express">Plotly Express</a></dt>&#13;
<dd>&#13;
<p>A minimal Plotly library</p>&#13;
</dd>&#13;
<dt><a href="https://plotly.com/python">Plotly</a></dt>&#13;
<dd>&#13;
<p>The main library</p>&#13;
</dd>&#13;
<dt><a href="https://dash.plotly.com">Dash</a></dt>&#13;
<dd>&#13;
<p><a data-primary="Dash" data-type="indexterm" id="id990"/>Data application tools</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>There <a data-primary="Dash Enterprise" data-type="indexterm" id="id991"/>is also&#13;
<a href="https://dash.plotly.com/dash-enterprise">Dash Enterprise</a>,&#13;
which,&#13;
like almost anything with <em>Enterprise</em> in its name&#13;
(including spaceship models)&#13;
costs money.</p>&#13;
&#13;
<p>What can we actually show from the creature data?&#13;
Charts and graphs have some common forms:</p>&#13;
&#13;
<ul class="two-col">&#13;
<li>&#13;
<p>Scatter</p>&#13;
</li>&#13;
<li>&#13;
<p>Line</p>&#13;
</li>&#13;
<li>&#13;
<p>Bar</p>&#13;
</li>&#13;
<li>&#13;
<p>Histogram</p>&#13;
</li>&#13;
<li>&#13;
<p>Box (statistical)</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p class="pagebreak-before">Our data fields are all strings, intentionally minimal to&#13;
keep the examples from overwhelming the logic&#13;
and integration steps.&#13;
For each example, we’ll read all the creature&#13;
data from the SQLite database&#13;
using code from previous chapters,&#13;
and adding Web and Service functions to select&#13;
particular data to feed to the plot library functions.</p>&#13;
&#13;
<p>First, install Plotly, and a library needed by Plotly to&#13;
export images:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><code>pip install plotly</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>pip install kaleido</code></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Then, in <a data-type="xref" href="#ex-17-8">Example 17-8</a>,&#13;
add a test function to <em>web/creature.py</em>&#13;
to see if we have the right pieces,&#13;
in the right places.</p>&#13;
<div data-type="example" id="ex-17-8">&#13;
<h5><span class="label">Example 17-8. </span>Add a test plot endpoint (edit <span class="plain">web/creature.py</span>)</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1"># (insert these lines in web/creature.py)</code>&#13;
&#13;
<code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">Response</code>&#13;
<code class="kn">import</code> <code class="nn">plotly.express</code> <code class="k">as</code> <code class="nn">px</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/test"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">test</code><code class="p">():</code>&#13;
    <code class="n">df</code> <code class="o">=</code> <code class="n">px</code><code class="o">.</code><code class="n">data</code><code class="o">.</code><code class="n">iris</code><code class="p">()</code>&#13;
    <code class="n">fig</code> <code class="o">=</code> <code class="n">px</code><code class="o">.</code><code class="n">scatter</code><code class="p">(</code><code class="n">df</code><code class="p">,</code> <code class="n">x</code><code class="o">=</code><code class="s2">"sepal_width"</code><code class="p">,</code> <code class="n">y</code><code class="o">=</code><code class="s2">"sepal_length"</code><code class="p">,</code> <code class="n">color</code><code class="o">=</code><code class="s2">"species"</code><code class="p">)</code>&#13;
    <code class="n">fig_bytes</code> <code class="o">=</code> <code class="n">fig</code><code class="o">.</code><code class="n">to_image</code><code class="p">(</code><code class="nb">format</code><code class="o">=</code><code class="s2">"png"</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">Response</code><code class="p">(</code><code class="n">content</code><code class="o">=</code><code class="n">fig_bytes</code><code class="p">,</code> <code class="n">media_type</code><code class="o">=</code><code class="s2">"image/png"</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>The documentation routinely recommends calling <code>fig.show()</code>&#13;
to show the image that you just created,&#13;
but we’re trying to fit in with how FastAPI and Starlette&#13;
do things.</p>&#13;
&#13;
<p>So first you get <code>fig_bytes</code> (the actual <code>bytes</code> content&#13;
of the image);&#13;
then you return a custom <code>Response</code> object.</p>&#13;
&#13;
<p>After you’ve added this endpoint to <em>web/creature.py</em>&#13;
and restarted the web server&#13;
(automatically if you ran Uvicorn with <code>--reload</code>),&#13;
try accessing this new endpoint&#13;
by typing <strong><code>localhost:8000/creature/test</code></strong> into your browser’s&#13;
location bar.&#13;
You should see <a data-type="xref" href="#fig-test-plotly">Figure 17-1</a>.</p>&#13;
&#13;
<figure><div class="figure" id="fig-test-plotly">&#13;
<img alt="fapi 1701" src="assets/fapi_1701.png"/>&#13;
<h6><span class="label">Figure 17-1. </span>Test Plotly image</h6>&#13;
</div></figure>&#13;
&#13;
<p>If you got a weird error from Uvicorn like&#13;
<code>ValueError: 'not' is not a valid parameter name</code>,&#13;
then update Pydantic to fix a <a data-primary="Plotly" data-startref="icd096" data-type="indexterm" id="id992"/>bug:&#13;
<code>pip install -U pydantic</code>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Chart Example 2: Histogram" data-type="sect2"><div class="sect2" id="id167">&#13;
<h2>Chart Example 2: Histogram</h2>&#13;
&#13;
<p>If <a data-primary="histograms" data-type="indexterm" id="icd095"/>all is well,&#13;
let’s start playing with our creature data.&#13;
We’ll add a <code>plot()</code> function&#13;
to <em>web/creature.py</em>.&#13;
We’ll get all the creature data from the database&#13;
via the <code>get_all()</code> functions in <em>service/creature.py</em>&#13;
and <em>data/creature.py</em>.&#13;
Then we’ll extract what we want and use Plotly&#13;
to display various images of the results.</p>&#13;
&#13;
<p>For our first trick (<a data-type="xref" href="#ex-17-9">Example 17-9</a>), we’ll just use the <code>name</code>&#13;
field and make a bar chart indicating the number of creatures’&#13;
names that start with each letter.</p>&#13;
<div data-type="example" id="ex-17-9">&#13;
<h5><span class="label">Example 17-9. </span>Bar chart of creature name initials</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1"># (insert these lines in web/creature.py)</code>&#13;
&#13;
<code class="kn">from</code> <code class="nn">collections</code> <code class="kn">import</code> <code class="n">Counter</code>&#13;
<code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">Response</code>&#13;
<code class="kn">import</code> <code class="nn">plotly.express</code> <code class="k">as</code> <code class="nn">px</code>&#13;
<code class="kn">from</code> <code class="nn">service.creature</code> <code class="kn">import</code> <code class="n">get_all</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/plot"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">plot</code><code class="p">():</code>&#13;
    <code class="n">creatures</code> <code class="o">=</code> <code class="n">get_all</code><code class="p">()</code>&#13;
    <code class="n">letters</code> <code class="o">=</code> <code class="s2">"ABCDEFGHIJKLMNOPQRSTUVWXYZ"</code>&#13;
    <code class="n">counts</code> <code class="o">=</code> <code class="n">Counter</code><code class="p">(</code><code class="n">creature</code><code class="o">.</code><code class="n">name</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code> <code class="k">for</code> <code class="n">creature</code> <code class="ow">in</code> <code class="n">creatures</code><code class="p">)</code>&#13;
    <code class="n">y</code> <code class="o">=</code> <code class="p">{</code> <code class="n">letter</code><code class="p">:</code> <code class="n">counts</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">letter</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code> <code class="k">for</code> <code class="n">letter</code> <code class="ow">in</code> <code class="n">letters</code> <code class="p">}</code>&#13;
    <code class="n">fig</code> <code class="o">=</code> <code class="n">px</code><code class="o">.</code><code class="n">histogram</code><code class="p">(</code><code class="n">x</code><code class="o">=</code><code class="nb">list</code><code class="p">(</code><code class="n">letters</code><code class="p">),</code> <code class="n">y</code><code class="o">=</code><code class="n">y</code><code class="p">,</code> <code class="n">title</code><code class="o">=</code><code class="s2">"Creature Names"</code><code class="p">,</code>&#13;
        <code class="n">labels</code><code class="o">=</code><code class="p">{</code><code class="s2">"x"</code><code class="p">:</code> <code class="s2">"Initial"</code><code class="p">,</code> <code class="s2">"y"</code><code class="p">:</code> <code class="s2">"Initial"</code><code class="p">})</code>&#13;
    <code class="n">fig_bytes</code> <code class="o">=</code> <code class="n">fig</code><code class="o">.</code><code class="n">to_image</code><code class="p">(</code><code class="nb">format</code><code class="o">=</code><code class="s2">"png"</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">Response</code><code class="p">(</code><code class="n">content</code><code class="o">=</code><code class="n">fig_bytes</code><code class="p">,</code> <code class="n">media_type</code><code class="o">=</code><code class="s2">"image/png"</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>Type <code><strong>localhost:8000/creature/plot</strong></code> into<a data-primary="SQLite" data-secondary="chart/graph packages" data-startref="icd094" data-type="indexterm" id="id993"/> your<a data-primary="chart/graph packages" data-startref="icd098" data-type="indexterm" id="id994"/> browser’s&#13;
location bar.&#13;
You should<a data-primary="histograms" data-startref="icd095" data-type="indexterm" id="id995"/> see <a data-type="xref" href="#fig-histogram">Figure 17-2</a>.</p>&#13;
&#13;
<figure><div class="figure" id="fig-histogram">&#13;
<img alt="fapi 1702" src="assets/fapi_1702.png"/>&#13;
<h6><span class="label">Figure 17-2. </span>Creature name initial histogram</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Map Packages" data-type="sect2"><div class="sect2" id="id168">&#13;
<h2>Map Packages</h2>&#13;
&#13;
<p><a data-primary="SQLite" data-secondary="map packages" data-type="indexterm" id="icd097"/>If<a data-primary="map packages" data-type="indexterm" id="icd099"/> you try to Google <code><strong>Python</strong></code> and <code><strong>maps</strong></code>, you’ll get&#13;
many links about Python dictionaries, which are a built-in&#13;
<em>mapping type</em> in the language,&#13;
and not the same thing.&#13;
So you may need to try synonyms like&#13;
<em>GIS</em>, <em>geo</em>, <em>cartography</em>, <em>spatial</em>, and so on.&#13;
Popular packages, some of them built atop others in the list,&#13;
include the following:</p>&#13;
<dl>&#13;
<dt><a href="https://oreil.ly/3QvCz">PyGIS</a></dt>&#13;
<dd>&#13;
<p><a data-primary="PyGIS" data-type="indexterm" id="id996"/>References for spatial data&#13;
processing in Python</p>&#13;
</dd>&#13;
<dt><a href="https://pysal.org">PySAL</a></dt>&#13;
<dd>&#13;
<p><a data-primary="PySAL" data-type="indexterm" id="id997"/>Python Spatial Analysis Library</p>&#13;
</dd>&#13;
<dt><a href="https://oreil.ly/YnUow">Cartopy</a></dt>&#13;
<dd>&#13;
<p><a data-primary="Cartopy" data-type="indexterm" id="id998"/>Analyzes and maps geospatial data</p>&#13;
</dd>&#13;
<dt><a href="https://oreil.ly/72luj">Folium</a></dt>&#13;
<dd>&#13;
<p><a data-primary="Folium" data-type="indexterm" id="id999"/>Integrated with JavaScript</p>&#13;
</dd>&#13;
<dt><a href="https://oreil.ly/LWfS5">Python Client for Google Maps Services</a></dt>&#13;
<dd>&#13;
<p><a data-primary="Python Client for Google Maps Services" data-type="indexterm" id="id1000"/>API access to Google Maps</p>&#13;
</dd>&#13;
<dt><a href="https://geemap.org">Geemap</a></dt>&#13;
<dd>&#13;
<p><a data-primary="Geemap" data-type="indexterm" id="id1001"/>Google Earth support</p>&#13;
</dd>&#13;
<dt><a href="https://oreil.ly/Slfvc">Geoplot</a></dt>&#13;
<dd>&#13;
<p><a data-primary="Geoplot" data-type="indexterm" id="id1002"/>Extends Cartopy and Matplotlib</p>&#13;
</dd>&#13;
<dt><a href="https://geopandas.org">GeoPandas</a></dt>&#13;
<dd>&#13;
<p><a data-primary="GeoPandas" data-type="indexterm" id="id1003"/>An extension of our friend pandas</p>&#13;
</dd>&#13;
<dt><a href="https://oreil.ly/l7M5C">ArcGIS and ArcPy</a></dt>&#13;
<dd>&#13;
<p><a data-primary="ArcGIS" data-type="indexterm" id="id1004"/><a data-primary="ArcPy" data-type="indexterm" id="id1005"/><a data-primary="Esri" data-type="indexterm" id="id1006"/>Esri’s open source interface</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>Similar to the criteria for plot/graph packages,&#13;
choices may depend on the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Map types (e.g., choropleth, vector, raster)</p>&#13;
</li>&#13;
<li>&#13;
<p>Styling</p>&#13;
</li>&#13;
<li>&#13;
<p>Ease of use</p>&#13;
</li>&#13;
<li>&#13;
<p>Performance</p>&#13;
</li>&#13;
<li>&#13;
<p>Data limits</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Like charts and graphs, maps come in many types and can be used for various <span class="keep-together">purposes</span>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Map Example" data-type="sect2"><div class="sect2" id="id169">&#13;
<h2>Map Example</h2>&#13;
&#13;
<p>I’ll use Plotly again for these mapping examples;&#13;
it’s neither too basic nor too complex,&#13;
and this helps show how to integrate a small web-based map&#13;
with FastAPI.</p>&#13;
&#13;
<p><a data-type="xref" href="#ex17-10">Example 17-10</a> gets the two-letter ISO country codes&#13;
of our creatures.&#13;
But it turns out that&#13;
the function that draws Plotly maps&#13;
(a <em>choropleth</em>, which sounds like a shape-changing&#13;
cryptid itself)&#13;
wants to use another&#13;
<em>three</em>-letter ISO country code standard instead.&#13;
Grrr.&#13;
So we could redo all the codes in the database and PSV file,&#13;
but it’s easier to&#13;
run <code>pip install country_converter</code>&#13;
and map one set of country codes to another.</p>&#13;
<div data-type="example" id="ex17-10">&#13;
<h5><span class="label">Example 17-10. </span>Map countries with cryptids (edit <span class="plain">web/creature.py</span>)</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="c1"># (insert these lines in web/creature.py)</code>&#13;
&#13;
<code class="kn">import</code> <code class="nn">plotly.express</code> <code class="k">as</code> <code class="nn">px</code>&#13;
<code class="kn">import</code> <code class="nn">country_converter</code> <code class="k">as</code> <code class="nn">coco</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/map"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">map</code><code class="p">():</code>&#13;
    <code class="n">creatures</code> <code class="o">=</code> <code class="n">service</code><code class="o">.</code><code class="n">get_all</code><code class="p">()</code>&#13;
    <code class="n">iso2_codes</code> <code class="o">=</code> <code class="nb">set</code><code class="p">(</code><code class="n">creature</code><code class="o">.</code><code class="n">country</code> <code class="k">for</code> <code class="n">creature</code> <code class="ow">in</code> <code class="n">creatures</code><code class="p">)</code>&#13;
    <code class="n">iso3_codes</code> <code class="o">=</code> <code class="n">coco</code><code class="o">.</code><code class="n">convert</code><code class="p">(</code><code class="n">names</code><code class="o">=</code><code class="n">iso2_codes</code><code class="p">,</code> <code class="n">to</code><code class="o">=</code><code class="s2">"ISO3"</code><code class="p">)</code>&#13;
    <code class="n">fig</code> <code class="o">=</code> <code class="n">px</code><code class="o">.</code><code class="n">choropleth</code><code class="p">(</code>&#13;
        <code class="n">locationmode</code><code class="o">=</code><code class="s2">"ISO-3"</code><code class="p">,</code>&#13;
        <code class="n">locations</code><code class="o">=</code><code class="n">iso3_codes</code><code class="p">)</code>&#13;
    <code class="n">fig_bytes</code> <code class="o">=</code> <code class="n">fig</code><code class="o">.</code><code class="n">to_image</code><code class="p">(</code><code class="nb">format</code><code class="o">=</code><code class="s2">"png"</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">Response</code><code class="p">(</code><code class="n">content</code><code class="o">=</code><code class="n">fig_bytes</code><code class="p">,</code> <code class="n">media_type</code><code class="o">=</code><code class="s2">"image/png"</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>Ask your browser to pretty please get <code><strong>localhost:8000/creature/map</strong></code>,&#13;
and with any luck you’ll see a map in which&#13;
cryptid-bearing countries stick out (<a data-type="xref" href="#fig-map-cryptid-countries">Figure 17-3</a>).</p>&#13;
&#13;
<figure><div class="figure" id="fig-map-cryptid-countries">&#13;
<img alt="fapi 1703" src="assets/fapi_1703.png"/>&#13;
<h6><span class="label">Figure 17-3. </span>Map of cryptid countries</h6>&#13;
</div></figure>&#13;
&#13;
<p>You could expand this map to focus on the <a data-primary="map packages" data-startref="icd099" data-type="indexterm" id="id1007"/>US&#13;
by <a data-primary="SQLite" data-secondary="map packages" data-startref="icd097" data-type="indexterm" id="id1008"/>using<a data-primary="SQLite" data-secondary="data source and web output" data-startref="icd093" data-type="indexterm" id="id1009"/> the<a data-primary="data discovery and visualization" data-secondary="SQLite data source and web output" data-startref="icd092" data-type="indexterm" id="id1010"/>&#13;
<code>area</code> field,&#13;
which is a two-character state code&#13;
if <code>country</code> is <code>US</code>.&#13;
Use <code>locationmode="USA-states"</code>,&#13;
and assign those <code>area</code> values to the&#13;
<code>locations</code> parameter of <code>px.choropleth()</code>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Review" data-type="sect1"><div class="sect1" id="id170">&#13;
<h1>Review</h1>&#13;
&#13;
<p>Have any cryptids been snuffling around near your house?&#13;
You found out in this chapter,&#13;
where various plotting, graphing, and mapping tools&#13;
poked at a database of worrisome creatures<a data-primary="data discovery and visualization" data-startref="icd087" data-type="indexterm" id="id1011"/>.</p>&#13;
</div></section>&#13;
<div data-type="footnotes"><p data-type="footnote" id="id976"><sup><a href="ch17.html#id976-marker">1</a></sup> If there are any trees like Tolkien’s Ents, we don’t want them lumbering up to our doors some night to have a word.</p></div></div></section></body></html>