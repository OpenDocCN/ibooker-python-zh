<html><head></head><body>
<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 14. Runtime Checking With pydantic" class="preface"><div class="preface" id="pydantic">
<h1 class="calibre10" id="calibre_pb_0"><span class="calibre">Chapter 14. </span>Runtime Checking With pydantic</h1>


<p class="author1">The central theme of robust code is making it easier to detect errors. Errors are an inevitable part of developing complex systems; you can’t avoid them. By writing your own types, you create a vocabulary that makes it harder to introduce inconsistencies. Using type annotations provides you a safety net, letting you catch mistakes as you are developing.<a data-type="indexterm" data-primary="shifting errors left" id="idm45644735043096" class="calibre5"/> Both of these are examples of <em class="calibre6">shifting errors left</em>; instead of finding errors during testing (or worse, in production), you find them earlier, ideally as you develop code.</p>

<p class="author1">However, not every error is easily found through code inspection and static analysis.<a data-type="indexterm" data-primary="errors" data-secondary="finding at runtime" id="idm45644735041320" class="calibre5"/> There is a whole class of errors that will only be detectable at runtime. Any time you interact with data supplied from outside your program (such as databases, config files, network requests), you run the risk of inputting invalid data. Your code can be rock-solid in how you retrieve and parse data, but there’s not much you can do to prevent users from passing in invalid data.</p>

<p class="author1">Your first <a data-type="indexterm" data-primary="validation logic" id="idm45644735039432" class="calibre5"/>inclination might be to write a lot of <em class="calibre6">validation logic</em>: <code class="calibre17">if</code> statements and checks to see if all of the data passed in is correct. The problem is that validation logic is often complex, sprawling, and tough to understand at a glance. The more comprehensive your validation, the worse it gets. If your goal is to find errors, reading all the code (and tests) will be your best shot. In that case, you need to minimize the amount of code you look at. Herein lies the rub: you will understand more of the code the more you read, but the more you read, the higher the cognitive burden you will have, decreasing your chances of finding an error.</p>

<p class="author1">In this chapter, you’ll learn how using the pydantic library will fix this problem. pydantic lets you define modeled classes, reducing the amount of validation logic you need to write, without sacrificing readability. pydantic will easily parse user-supplied data, providing guarantees about output data structures. I’ll go through a few basic examples of what you can do with it, and then end the chapter with some advanced pydantic usage.</p>






</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 14. Runtime Checking With pydantic" class="preface">
<div class="preface" id="pydantic">
<section data-type="sect1" data-pdf-bookmark="Dynamic Configuration" class="preface"><div class="preface" id="idm45644735036136">
<h1 class="calibre12" id="calibre_pb_1">Dynamic Configuration</h1>

<p class="author1">In this chapter, I’m going to build out types describing restaurants. I’ll start by providing a way for a user to specify restaurants through configuration files. Here is a list of configurable fields (and their constraints) per restaurant:</p>

<ul class="printings">
<li class="calibre9">
<p class="author1">Name of the restaurant</p>

<ul class="calibre54">
<li class="calibre55">
<p class="author1">For legacy reasons, the name must be less than 32 characters long, and only contain letters, numbers, quotation marks, and spaces (no Unicode, sorry).</p>
</li>
</ul>
</li>
<li class="calibre9">
<p class="author1">Owner’s full name</p>
</li>
<li class="calibre9">
<p class="author1">Address</p>
</li>
<li class="calibre9">
<p class="author1">List of employees</p>

<ul class="calibre54">
<li class="calibre55">
<p class="author1">There must be at least one chef and one server.</p>
</li>
<li class="calibre55">
<p class="author1">Each employee has a name and position (chef, server, host, sous chef, or delivery driver).</p>
</li>
<li class="calibre55">
<p class="author1">Each employee either has a mailing address for a check or direct deposit details.</p>
</li>
</ul>
</li>
<li class="calibre9">
<p class="author1">List of dishes</p>

<ul class="calibre54">
<li class="calibre55">
<p class="author1">Each dish has a name, price, and description. The name is limited to 16 characters, and the description is limited to 80 characters. Optionally, there is a picture (in the form of a filename) with each dish.</p>
</li>
<li class="calibre55">
<p class="author1">Each dish must have a unique name.</p>
</li>
<li class="calibre55">
<p class="author1">There must be at least three dishes on the menu.</p>
</li>
</ul>
</li>
<li class="calibre9">
<p class="author1">Number of seats</p>
</li>
<li class="calibre9">
<p class="author1">Offers to-go orders (Boolean)</p>
</li>
<li class="calibre9">
<p class="author1">Offers delivery (Boolean)</p>
</li>
</ul>

<p class="author1">This information is stored in a <a href="https://yaml.org" class="calibre5">YAML file</a> that<a data-type="indexterm" data-primary="YAML files" id="idm45644734960072" class="calibre5"/> looks like this:</p>

<pre data-type="programlisting" data-code-language="yaml" class="calibre35"><code class="nt">name</code><code class="calibre17">:</code> <code class="calibre17">Viafore's</code>
<code class="nt">owner</code><code class="calibre17">:</code> <code class="calibre17">Pat Viafore</code>
<code class="nt">address</code><code class="calibre17">:</code> <code class="calibre17">123 Fake St. Fakington, FA 01234</code>
<code class="nt">employees</code><code class="calibre17">:</code>
  <code class="calibre17">-</code> <code class="nt">name</code><code class="calibre17">:</code> <code class="calibre17">Pat Viafore</code>
    <code class="nt">position</code><code class="calibre17">:</code> <code class="calibre17">Chef</code>
    <code class="nt">payment_details</code><code class="calibre17">:</code>
      <code class="nt">bank_details</code><code class="calibre17">:</code>
        <code class="nt">routing_number</code><code class="calibre17">:</code> <code class="s">"123456789"</code>
        <code class="nt">account_number</code><code class="calibre17">:</code> <code class="s">"123456789012"</code>
  <code class="calibre17">-</code> <code class="nt">name</code><code class="calibre17">:</code> <code class="calibre17">Made-up McGee</code>
    <code class="nt">position</code><code class="calibre17">:</code> <code class="calibre17">Server</code>
    <code class="nt">payment_details</code><code class="calibre17">:</code>
      <code class="nt">bank_details</code><code class="calibre17">:</code>
        <code class="nt">routing_number</code><code class="calibre17">:</code> <code class="s">"123456789"</code>
        <code class="nt">account_number</code><code class="calibre17">:</code> <code class="s">"123456789012"</code>
  <code class="calibre17">-</code> <code class="nt">name</code><code class="calibre17">:</code> <code class="calibre17">Fabricated Frank</code>
    <code class="nt">position</code><code class="calibre17">:</code> <code class="calibre17">Sous Chef</code>
    <code class="nt">payment_details</code><code class="calibre17">:</code>
      <code class="nt">bank_details</code><code class="calibre17">:</code>
        <code class="nt">routing_number</code><code class="calibre17">:</code> <code class="s">"123456789"</code>
        <code class="nt">account_number</code><code class="calibre17">:</code> <code class="s">"123456789012"</code>
  <code class="calibre17">-</code> <code class="nt">name</code><code class="calibre17">:</code> <code class="calibre17">Illusory Ilsa</code>
    <code class="nt">position</code><code class="calibre17">:</code> <code class="calibre17">Host</code>
    <code class="nt">payment_details</code><code class="calibre17">:</code>
      <code class="nt">bank_details</code><code class="calibre17">:</code>
        <code class="nt">routing_number</code><code class="calibre17">:</code> <code class="s">"123456789"</code>
        <code class="nt">account_number</code><code class="calibre17">:</code> <code class="s">"123456789012"</code>
<code class="nt">dishes</code><code class="calibre17">:</code>
  <code class="calibre17">-</code> <code class="nt">name</code><code class="calibre17">:</code> <code class="calibre17">Pasta and Sausage</code>
    <code class="nt">price_in_cents</code><code class="calibre17">:</code> <code class="calibre17">1295</code>
    <code class="nt">description</code><code class="calibre17">:</code> <code class="calibre17">Rigatoni and sausage with a tomato-garlic-basil sauce</code>
  <code class="calibre17">-</code> <code class="nt">name</code><code class="calibre17">:</code> <code class="calibre17">Pasta Bolognese</code>
    <code class="nt">price_in_cents</code><code class="calibre17">:</code> <code class="calibre17">1495</code>
    <code class="nt">description</code><code class="calibre17">:</code> <code class="calibre17">Spaghetti with a rich tomato and beef Sauce</code>
  <code class="calibre17">-</code> <code class="nt">name</code><code class="calibre17">:</code> <code class="calibre17">Caprese Salad</code>
    <code class="nt">price_in_cents</code><code class="calibre17">:</code> <code class="calibre17">795</code>
    <code class="nt">description</code><code class="calibre17">:</code> <code class="calibre17">Tomato, buffalo mozzarella, and basil</code>
    <code class="nt">picture</code><code class="calibre17">:</code> <code class="calibre17">caprese.png</code>
<code class="nt">number_of_seats</code><code class="calibre17">:</code> <code class="calibre17">12</code>
<code class="nt">to_go</code><code class="calibre17">:</code> <code class="calibre17">true</code>
<code class="nt">delivery</code><code class="calibre17">:</code> <code class="calibre17">false</code></pre>

<p class="author1">The pip-installable library <code class="calibre17">yaml</code> makes it easy to read this file, providing a dictionary:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="k">with</code> <code class="nb">open</code><code class="calibre17">(</code><code class="s">'code_examples/chapter14/restaurant.yaml'</code><code class="calibre17">)</code> <code class="k">as</code> <code class="n">yaml_file</code><code class="calibre17">:</code>
    <code class="n">restaurant</code> <code class="calibre17">=</code> <code class="n">yaml</code><code class="calibre17">.</code><code class="n">safe_load</code><code class="calibre17">(</code><code class="n">yaml_file</code><code class="calibre17">)</code>

<code class="k">print</code><code class="calibre17">(</code><code class="n">restaurant</code><code class="calibre17">)</code>
<code class="calibre17">&gt;&gt;&gt;</code> <code class="calibre17">{</code>
    <code class="s">"name"</code><code class="calibre17">:</code> <code class="s">"Viafore's"</code><code class="calibre17">,</code>
    <code class="s">"owner"</code><code class="calibre17">:</code> <code class="s">"Pat Viafore"</code><code class="calibre17">,</code>
    <code class="s">"address"</code><code class="calibre17">:</code> <code class="s">"123 Fake St. Fakington, FA 01234"</code><code class="calibre17">,</code>
    <code class="s">"employees"</code><code class="calibre17">:</code> <code class="calibre17">[{</code>
        <code class="s">"name"</code><code class="calibre17">:</code> <code class="s">"Pat Viafore"</code><code class="calibre17">,</code>
        <code class="s">"position"</code><code class="calibre17">:</code> <code class="s">"Chef"</code><code class="calibre17">,</code>
        <code class="s">"payment_details"</code><code class="calibre17">:</code> <code class="calibre17">{</code>
            <code class="s">"bank_details"</code><code class="calibre17">:</code> <code class="calibre17">{</code>
                <code class="s">"routing_number"</code><code class="calibre17">:</code> <code class="s">'123456789'</code><code class="calibre17">,</code>
                <code class="s">"account_number"</code><code class="calibre17">:</code> <code class="s">'123456789012'</code>
            <code class="calibre17">}</code>
        <code class="calibre17">}</code>
    <code class="calibre17">},</code>
    <code class="calibre17">{</code>
        <code class="s">"name"</code><code class="calibre17">:</code> <code class="s">"Made-up McGee"</code><code class="calibre17">,</code>
        <code class="s">"position"</code><code class="calibre17">:</code> <code class="s">"Server"</code><code class="calibre17">,</code>
        <code class="s">"payment_details"</code><code class="calibre17">:</code> <code class="calibre17">{</code>
            <code class="s">"bank_details"</code><code class="calibre17">:</code> <code class="calibre17">{</code>
                <code class="s">"routing_number"</code><code class="calibre17">:</code> <code class="s">'123456789'</code><code class="calibre17">,</code>
                <code class="s">"account_number"</code><code class="calibre17">:</code> <code class="s">'123456789012'</code>
            <code class="calibre17">}</code>
        <code class="calibre17">}</code>
    <code class="calibre17">},</code>
    <code class="calibre17">{</code>
        <code class="s">"name"</code><code class="calibre17">:</code> <code class="s">"Fabricated Frank"</code><code class="calibre17">,</code>
        <code class="s">"position"</code><code class="calibre17">:</code> <code class="s">"Sous Chef"</code><code class="calibre17">,</code>
        <code class="s">"payment_details"</code><code class="calibre17">:</code> <code class="calibre17">{</code>
            <code class="s">"bank_details"</code><code class="calibre17">:</code> <code class="calibre17">{</code>
                <code class="s">"routing_number"</code><code class="calibre17">:</code> <code class="s">'123456789'</code><code class="calibre17">,</code>
                <code class="s">"account_number"</code><code class="calibre17">:</code> <code class="s">'123456789012'</code>
            <code class="calibre17">}</code>
        <code class="calibre17">}</code>
    <code class="calibre17">},</code>
    <code class="calibre17">{</code>
        <code class="s">"name"</code><code class="calibre17">:</code> <code class="s">"Illusory Ilsa"</code><code class="calibre17">,</code>
        <code class="s">"position"</code><code class="calibre17">:</code> <code class="s">"Host"</code><code class="calibre17">,</code>
        <code class="s">"payment_details"</code><code class="calibre17">:</code> <code class="calibre17">{</code>
            <code class="s">"bank_details"</code><code class="calibre17">:</code> <code class="calibre17">{</code>
                <code class="s">"routing_number"</code><code class="calibre17">:</code> <code class="s">'123456789'</code><code class="calibre17">,</code>
                <code class="s">"account_number"</code><code class="calibre17">:</code> <code class="s">'123456789012'</code>
            <code class="calibre17">}</code>
        <code class="calibre17">}</code>
    <code class="calibre17">}],</code>
    <code class="s">"dishes"</code><code class="calibre17">:</code> <code class="calibre17">[{</code>
        <code class="s">"name"</code><code class="calibre17">:</code> <code class="s">"Pasta and Sausage"</code><code class="calibre17">,</code>
        <code class="s">"price_in_cents"</code><code class="calibre17">:</code> <code class="mi">1295</code><code class="calibre17">,</code>
        <code class="s">"description"</code><code class="calibre17">:</code> <code class="s">"Rigatoni and sausage with a tomato-garlic-basil sauce"</code>
    <code class="calibre17">},</code>
    <code class="calibre17">{</code>
        <code class="s">"name"</code><code class="calibre17">:</code> <code class="s">"Pasta Bolognese"</code><code class="calibre17">,</code>
        <code class="s">"price_in_cents"</code><code class="calibre17">:</code> <code class="mi">1495</code><code class="calibre17">,</code>
        <code class="s">"description"</code><code class="calibre17">:</code> <code class="s">"Spaghetti with a rich tomato and beef Sauce"</code>
    <code class="calibre17">},</code>
    <code class="calibre17">{</code>
        <code class="s">"name"</code><code class="calibre17">:</code> <code class="s">"Caprese Salad"</code><code class="calibre17">,</code>
        <code class="s">"price_in_cents"</code><code class="calibre17">:</code> <code class="mi">795</code><code class="calibre17">,</code>
        <code class="s">"description"</code><code class="calibre17">:</code> <code class="s">"Tomato, buffalo mozzarella, and basil"</code><code class="calibre17">,</code>
        <code class="s">"picture"</code><code class="calibre17">:</code> <code class="s">"caprese.png"</code>
    <code class="calibre17">}],</code>
    <code class="s">'number_of_seats'</code><code class="calibre17">:</code> <code class="mi">12</code><code class="calibre17">,</code>
    <code class="s">"to_go"</code><code class="calibre17">:</code> <code class="nb">True</code><code class="calibre17">,</code>
    <code class="s">"delivery"</code><code class="calibre17">:</code> <code class="nb">False</code>
<code class="calibre17">}</code></pre>

<p class="author1">I want you to put on your tester hat for a second.<a data-type="indexterm" data-primary="types" data-secondary="enumerating test cases for invalid data" id="idm45644734823560" class="calibre5"/><a data-type="indexterm" data-primary="testing" data-secondary="enumerating test cases for invalid data" id="idm45644734822712" class="calibre5"/> The requirements I’ve just given are certainly not exhaustive; how would you refine them? I want you to take a few minutes and list out all the different constraints you can think of with just the dictionary given. Assuming the YAML file parses and returns a dictionary, how many invalid test cases can you think of?</p>
<div data-type="note" epub:type="note" class="calibre21"><h6 class="calibre22">Note</h6>
<p class="author1">You may notice that the routing number and account numbers are strings in the example above. This is intentional. Despite being a string of numerals, I do not want this to be a numeric type. Numeric operations (such as addition or multiplication) do not make sense, and I do not want an account number of 000000001234 to be truncated to 1234.</p>
</div>

<p class="author1">Here are some ideas to think about when enumerating test cases:</p>

<ul class="printings">
<li class="calibre9">
<p class="author1">Python is a dynamic language. Are you sure that everything is the right type?</p>
</li>
<li class="calibre9">
<p class="author1">Dictionaries don’t require any sort of required fields—are you sure every field is present?</p>
</li>
<li class="calibre9">
<p class="author1">Are all the constraints from the problem statement tested for?</p>
</li>
<li class="calibre9">
<p class="author1">What about additional constraints (correct routing numbers, account numbers, and addresses?)</p>
</li>
<li class="calibre9">
<p class="author1">What about negative numbers where there shouldn’t be?</p>
</li>
</ul>

<p class="author1">I came up with 67 different test cases with invalid data in about five minutes. Some of my test cases included (the full list is included in the <a href="https://github.com/pviafore/RobustPython" class="calibre5">GitHub repo for this book</a>):</p>

<ul class="printings">
<li class="calibre9">
<p class="author1">Name is zero characters.</p>
</li>
<li class="calibre9">
<p class="author1">Name is not a string.</p>
</li>
<li class="calibre9">
<p class="author1">There are no chefs.</p>
</li>
<li class="calibre9">
<p class="author1">Employee has no bank details or address.</p>
</li>
<li class="calibre9">
<p class="author1">Employee’s routing number is truncated (0000123 becomes 123).</p>
</li>
<li class="calibre9">
<p class="author1">Number of seats is negative.</p>
</li>
</ul>

<p class="author1">This, admittedly, is not a very complex class. Could you imagine the number of test cases for a much more involved class? Even with 67 test cases, could you imagine opening up a constructor of a type and checking 67 different conditions? In most of the codebases I’ve worked on, the validation logic is nowhere near as comprehensive. However, this is user-configurable data and I want errors to be caught as early as possible in runtime. You should prefer catching the errors at data injection over first use. After all, the first use of these values might not happen until you are in a separate system, decoupled from your parse logic.</p>
</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 14. Runtime Checking With pydantic" class="preface">
<div class="preface" id="pydantic">
<section data-type="sect1" data-pdf-bookmark="Dynamic Configuration" class="preface">
<div class="preface" id="idm45644735036136">
<div data-type="note" epub:type="note" class="calibre21"><h1 class="calibre38" id="calibre_pb_2">Discussion Topic</h1>
<p class="author1">Think about some user data represented as data types in your system. How complex is that data? How many ways can you construct it incorrectly? Discuss the impact of creating this data incorrectly and how confident you are that your code will catch all the errors.</p>
</div>

<p class="author1">Throughout this chapter, I’ll show you how to create a type that is easy to read and models all the constraints listed. Since I’ve focused on type annotations so much, it’d be nice if I can catch missing fields or wrong types at typecheck time.<a data-type="indexterm" data-primary="TypedDict" id="idm45644734560184" class="calibre5"/> A first idea is to use a <code class="calibre17">TypedDict</code> (see <a data-type="xref" href="part0008_split_000.html#collections" class="calibre5">Chapter 5</a> for more information on <code class="calibre17">TypedDict</code>):</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="k">from</code> <code class="nn">typing</code> <code class="k">import</code> <code class="n">Literal</code><code class="calibre17">,</code> <code class="n">TypedDict</code><code class="calibre17">,</code> <code class="n">Union</code>
<code class="k">class</code> <code class="nc">AccountAndRoutingNumber</code><code class="calibre17">(</code><code class="n">TypedDict</code><code class="calibre17">):</code>
    <code class="n">account_number</code><code class="calibre17">:</code> <code class="nb">str</code>
    <code class="n">routing_number</code><code class="calibre17">:</code> <code class="nb">str</code>

<code class="k">class</code> <code class="nc">BankDetails</code><code class="calibre17">(</code><code class="n">TypedDict</code><code class="calibre17">):</code>
    <code class="n">bank_details</code><code class="calibre17">:</code> <code class="n">AccountAndRoutingNumber</code>

<code class="n">AddressOrBankDetails</code> <code class="calibre17">=</code> <code class="n">Union</code><code class="calibre17">[</code><code class="nb">str</code><code class="calibre17">,</code> <code class="n">BankDetails</code><code class="calibre17">]</code>

<code class="n">Position</code> <code class="calibre17">=</code> <code class="n">Literal</code><code class="calibre17">[</code><code class="s">'Chef'</code><code class="calibre17">,</code> <code class="s">'Sous Chef'</code><code class="calibre17">,</code> <code class="s">'Host'</code><code class="calibre17">,</code>
                   <code class="s">'Server'</code><code class="calibre17">,</code> <code class="s">'Delivery Driver'</code><code class="calibre17">]</code>

<code class="k">class</code> <code class="nc">Dish</code><code class="calibre17">(</code><code class="n">TypedDict</code><code class="calibre17">):</code>
    <code class="n">name</code><code class="calibre17">:</code> <code class="nb">str</code>
    <code class="n">price_in_cents</code><code class="calibre17">:</code> <code class="nb">int</code>
    <code class="n">description</code><code class="calibre17">:</code> <code class="nb">str</code>

<code class="k">class</code> <code class="nc">DishWithOptionalPicture</code><code class="calibre17">(</code><code class="n">Dish</code><code class="calibre17">,</code> <code class="n">TypedDict</code><code class="calibre17">,</code> <code class="n">total</code><code class="calibre17">=</code><code class="nb">False</code><code class="calibre17">):</code>
    <code class="n">picture</code><code class="calibre17">:</code> <code class="nb">str</code>

<code class="k">class</code> <code class="nc">Employee</code><code class="calibre17">(</code><code class="n">TypedDict</code><code class="calibre17">):</code>
    <code class="n">name</code><code class="calibre17">:</code> <code class="nb">str</code>
    <code class="n">position</code><code class="calibre17">:</code> <code class="n">Position</code>
    <code class="n">payment_information</code><code class="calibre17">:</code> <code class="n">AddressOrBankDetails</code>

<code class="k">class</code> <code class="nc">Restaurant</code><code class="calibre17">(</code><code class="n">TypedDict</code><code class="calibre17">):</code>
    <code class="n">name</code><code class="calibre17">:</code> <code class="nb">str</code>
    <code class="n">owner</code><code class="calibre17">:</code> <code class="nb">str</code>
    <code class="n">address</code><code class="calibre17">:</code> <code class="nb">str</code>
    <code class="n">employees</code><code class="calibre17">:</code> <code class="nb">list</code><code class="calibre17">[</code><code class="n">Employee</code><code class="calibre17">]</code>
    <code class="n">dishes</code><code class="calibre17">:</code> <code class="nb">list</code><code class="calibre17">[</code><code class="n">Dish</code><code class="calibre17">]</code>
    <code class="n">number_of_seats</code><code class="calibre17">:</code> <code class="nb">int</code>
    <code class="n">to_go</code><code class="calibre17">:</code> <code class="nb">bool</code>
    <code class="n">delivery</code><code class="calibre17">:</code> <code class="nb">bool</code></pre>

<p class="author1">This is a huge step in readability; you can tell exactly what types are needed to construct your type. You could write the following function:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="k">def</code> <code class="nf">load_restaurant</code><code class="calibre17">(</code><code class="n">filename</code><code class="calibre17">:</code> <code class="nb">str</code><code class="calibre17">)</code> <code class="calibre17">-&gt;</code> <code class="n">Restaurant</code><code class="calibre17">:</code>
    <code class="k">with</code> <code class="nb">open</code><code class="calibre17">(</code><code class="n">filename</code><code class="calibre17">)</code> <code class="k">as</code> <code class="n">yaml_file</code><code class="calibre17">:</code>
        <code class="k">return</code> <code class="n">yaml</code><code class="calibre17">.</code><code class="n">safe_load</code><code class="calibre17">(</code><code class="n">yaml_file</code><code class="calibre17">)</code></pre>

<p class="author1">Downstream consumers would automatically benefit from the types I’ve just laid out. However, there are a few problems with this approach:</p>

<ul class="printings">
<li class="calibre9">
<p class="author1">I can’t control construction of a <code class="calibre17">TypedDict</code>, so I can’t validate any fields as part of type construction.<a data-type="indexterm" data-primary="validation" data-secondary="TypedDict limitations for" id="idm45644734287688" class="calibre5"/> I must force consumers to do the validation.</p>
</li>
<li class="calibre9">
<p class="author1"><code class="calibre17">TypedDict</code> cannot have additional methods on it.</p>
</li>
<li class="calibre9">
<p class="author1"><code class="calibre17">TypedDict</code> does no validation implicitly. If you create the wrong dictionary from YAML, the typechecker will not complain.</p>
</li>
</ul>

<p class="author1">That last point is important. In fact, I could have the following contents as the entirety of my YAML file, and the code will still typecheck:</p>
<pre class="calibre35">invalid_name: "This is the wrong file format"</pre>

<p class="author1">Typechecking will not catch errors at runtime. You need something stronger. Enter pydantic.</p>
</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 14. Runtime Checking With pydantic" class="preface">
<div class="preface" id="pydantic">
<section data-type="sect1" data-pdf-bookmark="pydantic" class="preface"><div class="preface" id="idm45644735035192">
<h1 class="calibre12" id="calibre_pb_3">pydantic</h1>

<p class="author1"><a href="https://pydantic-docs.helpmanual.io" class="calibre5"><em class="calibre6">pydantic</em></a> is a library that provides runtime checking of your types without sacrificing readability.<a data-type="indexterm" data-primary="pydantic" id="ix_pyda" class="calibre5"/><a data-type="indexterm" data-primary="typechecking" data-secondary="runtime checking with pydantic" id="idm45644734279320" class="calibre5"/><a data-type="indexterm" data-primary="data classes" data-secondary="modeling with pydantic" id="idm45644734278360" class="calibre5"/> You can use pydantic to model your classes like so:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="k">from</code> <code class="nn">pydantic.dataclasses</code> <code class="k">import</code> <code class="n">dataclass</code>
<code class="k">from</code> <code class="nn">typing</code> <code class="k">import</code> <code class="n">Literal</code><code class="calibre17">,</code> <code class="n">Optional</code><code class="calibre17">,</code> <code class="n">TypedDict</code><code class="calibre17">,</code> <code class="n">Union</code>

<code class="nd">@dataclass</code>
<code class="k">class</code> <code class="nc">AccountAndRoutingNumber</code><code class="calibre17">:</code>
    <code class="n">account_number</code><code class="calibre17">:</code> <code class="nb">str</code>
    <code class="n">routing_number</code><code class="calibre17">:</code> <code class="nb">str</code>

<code class="nd">@dataclass</code>
<code class="k">class</code> <code class="nc">BankDetails</code><code class="calibre17">:</code>
    <code class="n">bank_details</code><code class="calibre17">:</code> <code class="n">AccountAndRoutingNumber</code>

<code class="n">AddressOrBankDetails</code> <code class="calibre17">=</code> <code class="n">Union</code><code class="calibre17">[</code><code class="nb">str</code><code class="calibre17">,</code> <code class="n">BankDetails</code><code class="calibre17">]</code>

<code class="n">Position</code> <code class="calibre17">=</code> <code class="n">Literal</code><code class="calibre17">[</code><code class="s">'Chef'</code><code class="calibre17">,</code> <code class="s">'Sous Chef'</code><code class="calibre17">,</code> <code class="s">'Host'</code><code class="calibre17">,</code>
                   <code class="s">'Server'</code><code class="calibre17">,</code> <code class="s">'Delivery Driver'</code><code class="calibre17">]</code>

<code class="nd">@dataclass</code>
<code class="k">class</code> <code class="nc">Dish</code><code class="calibre17">:</code>
    <code class="n">name</code><code class="calibre17">:</code> <code class="nb">str</code>
    <code class="n">price_in_cents</code><code class="calibre17">:</code> <code class="nb">int</code>
    <code class="n">description</code><code class="calibre17">:</code> <code class="nb">str</code>
    <code class="n">picture</code><code class="calibre17">:</code> <code class="n">Optional</code><code class="calibre17">[</code><code class="nb">str</code><code class="calibre17">]</code> <code class="calibre17">=</code> <code class="nb">None</code>

<code class="nd">@dataclass</code>
<code class="k">class</code> <code class="nc">Employee</code><code class="calibre17">:</code>
    <code class="n">name</code><code class="calibre17">:</code> <code class="nb">str</code>
    <code class="n">position</code><code class="calibre17">:</code> <code class="n">Position</code>
    <code class="n">payment_information</code><code class="calibre17">:</code> <code class="n">AddressOrBankDetails</code>

<code class="nd">@dataclass</code>
<code class="k">class</code> <code class="nc">Restaurant</code><code class="calibre17">:</code>
    <code class="n">name</code><code class="calibre17">:</code> <code class="nb">str</code>
    <code class="n">owner</code><code class="calibre17">:</code> <code class="nb">str</code>
    <code class="n">address</code><code class="calibre17">:</code> <code class="nb">str</code>
    <code class="n">employees</code><code class="calibre17">:</code> <code class="nb">list</code><code class="calibre17">[</code><code class="n">Employee</code><code class="calibre17">]</code>
    <code class="n">dishes</code><code class="calibre17">:</code> <code class="nb">list</code><code class="calibre17">[</code><code class="n">Dish</code><code class="calibre17">]</code>
    <code class="n">number_of_seats</code><code class="calibre17">:</code> <code class="nb">int</code>
    <code class="n">to_go</code><code class="calibre17">:</code> <code class="nb">bool</code>
    <code class="n">delivery</code><code class="calibre17">:</code> <code class="nb">bool</code></pre>

<p class="author1">You decorate each class with a <code class="calibre17">pydantic.dataclasses.dataclass</code> instead of inheriting from <code class="calibre17">TypedDict</code>. Once you have this, pydantic does validation upon type <span class="calibre">construction</span>.<a data-type="indexterm" data-primary="validation" data-secondary="pydantic validation at type construction" id="idm45644734273448" class="calibre5"/></p>

<p class="author1">To construct the pydantic type, I’ll change my load function as follows:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="k">def</code> <code class="nf">load_restaurant</code><code class="calibre17">(</code><code class="n">filename</code><code class="calibre17">:</code> <code class="nb">str</code><code class="calibre17">)</code> <code class="calibre17">-&gt;</code> <code class="n">Restaurant</code><code class="calibre17">:</code>
    <code class="k">with</code> <code class="nb">open</code><code class="calibre17">(</code><code class="n">filename</code><code class="calibre17">)</code> <code class="k">as</code> <code class="n">yaml_file</code><code class="calibre17">:</code>
        <code class="n">data</code> <code class="calibre17">=</code> <code class="n">yaml</code><code class="calibre17">.</code><code class="n">safe_load</code><code class="calibre17">(</code><code class="n">yaml_file</code><code class="calibre17">)</code>
        <code class="k">return</code> <code class="n">Restaurant</code><code class="calibre17">(</code><code class="calibre17">**</code><code class="n">data</code><code class="calibre17">)</code></pre>

<p class="author1">If a future developer violates any constraint, pydantic will throw an exception.<a data-type="indexterm" data-primary="exceptions" data-secondary="thrown by pydantic, examples" id="idm45644734075704" class="calibre5"/> Here are some example exceptions:</p>

<p class="author1">If a field is missing, such as a missing description:</p>

<pre data-type="programlisting" class="calibre35">pydantic.error_wrappers.ValidationError: 1 validation error for Restaurant
dishes -&gt; 2
  __init__() missing 1 required positional argument:
    'description' (type=type_error)</pre>

<p class="author1">When an invalid type is provided, such as putting the number 3 as an employee’s position:</p>

<pre data-type="programlisting" class="calibre35">pydantic.error_wrappers.ValidationError: 1 validation error for Restaurant
employees -&gt; 0 -&gt; position
  unexpected value; permitted: 'Chef', 'Sous Chef', 'Host',
                               'Server', 'Delivery Driver'
                               (type=value_error.const; given=3;
                                permitted=('Chef', 'Sous Chef', 'Host',
                                           'Server', 'Delivery Driver'))</pre>
<div data-type="warning" epub:type="warning" class="calibre23"><h6 class="calibre24">Warning</h6>
<p class="author1">Pydantic can work with mypy, but you<a data-type="indexterm" data-primary="mypy typechecker" data-secondary="using pydantic with" id="idm45644733969928" class="calibre5"/><a data-type="indexterm" data-primary="pydantic" data-secondary="using with mypy" id="idm45644733968952" class="calibre5"/> may need to enable the pydantic plug-in for typechecking in your <em class="calibre6">mypy.ini</em> to take advantage of all the features. Your <em class="calibre6">mypy.ini</em> will need the following in it:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre43"><code class="calibre17">[</code><code class="n">mypy</code><code class="calibre17">]</code>
<code class="n">plugins</code> <code class="calibre17">=</code> <code class="n">pydantic</code><code class="calibre17">.</code><code class="n">mypy</code></pre>

<p class="author1">For more information, check out the <a href="https://oreil.ly/FBQXX" class="calibre5">pydantic documentation</a>.</p>
</div>

<p class="author1">By modeling types with pydantic, I can catch entire classes of errors without writing my own validation logic. The pydantic data classes above catch 38 of the 67 test cases that I came up with earlier. But I can do better. This code still is missing functionality for those other 29 test cases, but I can use pydantic’s built-in validators to catch even more errors on type construction.</p>








</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 14. Runtime Checking With pydantic" class="preface">
<div class="preface" id="pydantic">
<section data-type="sect1" data-pdf-bookmark="pydantic" class="preface">
<div class="preface" id="idm45644735035192">
<section data-type="sect2" data-pdf-bookmark="Validators" class="preface"><div class="preface" id="idm45644734054488">
<h2 class="calibre34" id="calibre_pb_4">Validators</h2>

<p class="author1">Pydantic offers a ton of built-in <em class="calibre6">validators</em>. Validators are custom types that will check for specific constraints upon a field.<a data-type="indexterm" data-primary="pydantic" data-secondary="validators" id="ix_pydaval" class="calibre5"/><a data-type="indexterm" data-primary="validators (pydantic)" id="ix_valpyda" class="calibre5"/> For instance, if I wanted to make sure that strings were a certain size or that all integers were positive, I could use pydantic’s constrained types:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="k">from</code><code class="calibre17"> </code><code class="nn">typing</code><code class="calibre17"> </code><code class="k">import</code><code class="calibre17"> </code><code class="n">Optional</code><code class="calibre17">
</code><code class="calibre17">
</code><code class="k">from</code><code class="calibre17"> </code><code class="nn">pydantic.dataclasses</code><code class="calibre17"> </code><code class="k">import</code><code class="calibre17"> </code><code class="n">dataclass</code><code class="calibre17">
</code><code class="k">from</code><code class="calibre17"> </code><code class="nn">pydantic</code><code class="calibre17"> </code><code class="k">import</code><code class="calibre17"> </code><code class="n">constr</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="n">PositiveInt</code><code class="calibre17">
</code><code class="calibre17">
</code><code class="nd">@dataclass</code><code class="calibre17">
</code><code class="k">class</code><code class="calibre17"> </code><code class="nc">AccountAndRoutingNumber</code><code class="calibre17">:</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">account_number</code><code class="calibre17">:</code><code class="calibre17"> </code><code class="n">constr</code><code class="calibre17">(</code><code class="n">min_length</code><code class="calibre17">=</code><code class="mi">9</code><code class="calibre17">,</code><code class="n">max_length</code><code class="calibre17">=</code><code class="mi">9</code><code class="calibre17">)</code><code class="calibre17"> </code><a class="calibre5" id="co_runtime_checking_with_pydantic_CO1-1" href="part0018_split_004.html#callout_runtime_checking_with_pydantic_CO1-1"><img src="../images/00002.gif" alt="1" class="calibre40"/></a><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">routing_number</code><code class="calibre17">:</code><code class="calibre17"> </code><code class="n">constr</code><code class="calibre17">(</code><code class="n">min_length</code><code class="calibre17">=</code><code class="mi">8</code><code class="calibre17">,</code><code class="n">max_length</code><code class="calibre17">=</code><code class="mi">12</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">
</code><code class="nd">@dataclass</code><code class="calibre17">
</code><code class="k">class</code><code class="calibre17"> </code><code class="nc">Address</code><code class="calibre17">:</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">address</code><code class="calibre17">:</code><code class="calibre17"> </code><code class="n">constr</code><code class="calibre17">(</code><code class="n">min_length</code><code class="calibre17">=</code><code class="mi">1</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">
</code><code class="c"># ... snip ...</code><code class="calibre17">
</code><code class="calibre17">
</code><code class="nd">@dataclass</code><code class="calibre17">
</code><code class="k">class</code><code class="calibre17"> </code><code class="nc">Dish</code><code class="calibre17">:</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">name</code><code class="calibre17">:</code><code class="calibre17"> </code><code class="n">constr</code><code class="calibre17">(</code><code class="n">min_length</code><code class="calibre17">=</code><code class="mi">1</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="n">max_length</code><code class="calibre17">=</code><code class="mi">16</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">price_in_cents</code><code class="calibre17">:</code><code class="calibre17"> </code><code class="n">PositiveInt</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">description</code><code class="calibre17">:</code><code class="calibre17"> </code><code class="n">constr</code><code class="calibre17">(</code><code class="n">min_length</code><code class="calibre17">=</code><code class="mi">1</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="n">max_length</code><code class="calibre17">=</code><code class="mi">80</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">picture</code><code class="calibre17">:</code><code class="calibre17"> </code><code class="n">Optional</code><code class="calibre17">[</code><code class="nb">str</code><code class="calibre17">]</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="nb">None</code><code class="calibre17">
</code><code class="calibre17">
</code><code class="nd">@dataclass</code><code class="calibre17">
</code><code class="k">class</code><code class="calibre17"> </code><code class="nc">Restaurant</code><code class="calibre17">:</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">name</code><code class="calibre17">:</code><code class="calibre17"> </code><code class="n">constr</code><code class="calibre17">(</code><code class="n">regex</code><code class="calibre17">=</code><code class="calibre17">r</code><code class="s">'</code><code class="s">^[a-zA-Z0-9 ]*$</code><code class="s">'</code><code class="calibre17">,</code><code class="calibre17"> </code><a class="calibre5" id="co_runtime_checking_with_pydantic_CO1-2" href="part0018_split_004.html#callout_runtime_checking_with_pydantic_CO1-2"><img src="../images/00005.gif" alt="2" class="calibre40"/></a><code class="calibre17">
</code><code class="calibre17">                  </code><code class="n">min_length</code><code class="calibre17">=</code><code class="mi">1</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="n">max_length</code><code class="calibre17">=</code><code class="mi">16</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">owner</code><code class="calibre17">:</code><code class="calibre17"> </code><code class="n">constr</code><code class="calibre17">(</code><code class="n">min_length</code><code class="calibre17">=</code><code class="mi">1</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">address</code><code class="calibre17">:</code><code class="calibre17"> </code><code class="n">constr</code><code class="calibre17">(</code><code class="n">min_length</code><code class="calibre17">=</code><code class="mi">1</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">employees</code><code class="calibre17">:</code><code class="calibre17"> </code><code class="n">List</code><code class="calibre17">[</code><code class="n">Employee</code><code class="calibre17">]</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">dishes</code><code class="calibre17">:</code><code class="calibre17"> </code><code class="n">List</code><code class="calibre17">[</code><code class="n">Dish</code><code class="calibre17">]</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">number_of_seats</code><code class="calibre17">:</code><code class="calibre17"> </code><code class="n">PositiveInt</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">to_go</code><code class="calibre17">:</code><code class="calibre17"> </code><code class="nb">bool</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">delivery</code><code class="calibre17">:</code><code class="calibre17"> </code><code class="nb">bool</code></pre>
<dl class="calibre13">
<dt class="calibre14"><a class="calibre5" id="callout_runtime_checking_with_pydantic_CO1-1" href="part0018_split_004.html#co_runtime_checking_with_pydantic_CO1-1"><img src="../images/00002.gif" alt="1" class="calibre40"/></a></dt>
<dd class="calibre41"><p class="calibre42">I’m constraining a string to be a certain length.</p></dd>
<dt class="calibre14"><a class="calibre5" id="callout_runtime_checking_with_pydantic_CO1-2" href="part0018_split_004.html#co_runtime_checking_with_pydantic_CO1-2"><img src="../images/00005.gif" alt="2" class="calibre40"/></a></dt>
<dd class="calibre41"><p class="calibre42">I’m constraining a string to match a regular expression (in this case, only alphanumeric characters and spaces).</p></dd>
</dl>

<p class="author1">If I pass in an invalid type (such as a restaurant name with special characters or a negative number of seats), I get the following error:</p>

<pre data-type="programlisting" class="calibre35">pydantic.error_wrappers.ValidationError: 2 validation errors for Restaurant
name
  string does not match regex "^[a-zA-Z0-9 ]$" (type=value_error.str.regex;
                                                pattern=^[a-zA-Z0-9 ]$)
number_of_seats
  ensure this value is greater than 0
    (type=value_error.number.not_gt; limit_value=0)</pre>

<p class="author1">I can even constrain lists to enforce further restrictions.</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="k">from</code><code class="calibre17"> </code><code class="nn">pydantic</code><code class="calibre17"> </code><code class="k">import</code><code class="calibre17"> </code><code class="n">conlist</code><code class="calibre17">,</code><code class="n">constr</code><code class="calibre17">
</code><code class="nd">@dataclass</code><code class="calibre17">
</code><code class="k">class</code><code class="calibre17"> </code><code class="nc">Restaurant</code><code class="calibre17">:</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">name</code><code class="calibre17">:</code><code class="calibre17"> </code><code class="n">constr</code><code class="calibre17">(</code><code class="n">regex</code><code class="calibre17">=</code><code class="calibre17">r</code><code class="s">'</code><code class="s">^[a-zA-Z0-9 ]*$</code><code class="s">'</code><code class="calibre17">,</code><code class="calibre17">
</code><code class="calibre17">                   </code><code class="n">min_length</code><code class="calibre17">=</code><code class="mi">1</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="n">max_length</code><code class="calibre17">=</code><code class="mi">16</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">owner</code><code class="calibre17">:</code><code class="calibre17"> </code><code class="n">constr</code><code class="calibre17">(</code><code class="n">min_length</code><code class="calibre17">=</code><code class="mi">1</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">address</code><code class="calibre17">:</code><code class="calibre17"> </code><code class="n">constr</code><code class="calibre17">(</code><code class="n">min_length</code><code class="calibre17">=</code><code class="mi">1</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">employees</code><code class="calibre17">:</code><code class="calibre17"> </code><code class="n">conlist</code><code class="calibre17">(</code><code class="n">Employee</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="n">min_items</code><code class="calibre17">=</code><code class="mi">2</code><code class="calibre17">)</code><code class="calibre17"> </code><a class="calibre5" id="co_runtime_checking_with_pydantic_CO2-1" href="part0018_split_004.html#callout_runtime_checking_with_pydantic_CO2-1"><img src="../images/00002.gif" alt="1" class="calibre40"/></a><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">dishes</code><code class="calibre17">:</code><code class="calibre17"> </code><code class="n">conlist</code><code class="calibre17">(</code><code class="n">Dish</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="n">min_items</code><code class="calibre17">=</code><code class="mi">3</code><code class="calibre17">)</code><code class="calibre17"> </code><a class="calibre5" id="co_runtime_checking_with_pydantic_CO2-2" href="part0018_split_004.html#callout_runtime_checking_with_pydantic_CO2-2"><img src="../images/00005.gif" alt="2" class="calibre40"/></a><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">number_of_seats</code><code class="calibre17">:</code><code class="calibre17"> </code><code class="n">PositiveInt</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">to_go</code><code class="calibre17">:</code><code class="calibre17"> </code><code class="nb">bool</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="n">delivery</code><code class="calibre17">:</code><code class="calibre17"> </code><code class="nb">bool</code></pre>
<dl class="calibre13">
<dt class="calibre14"><a class="calibre5" id="callout_runtime_checking_with_pydantic_CO2-1" href="part0018_split_004.html#co_runtime_checking_with_pydantic_CO2-1"><img src="../images/00002.gif" alt="1" class="calibre40"/></a></dt>
<dd class="calibre41"><p class="calibre42">This list is constrained to <code class="calibre17">Employee</code> types and must have at least two employees.</p></dd>
<dt class="calibre14"><a class="calibre5" id="callout_runtime_checking_with_pydantic_CO2-2" href="part0018_split_004.html#co_runtime_checking_with_pydantic_CO2-2"><img src="../images/00005.gif" alt="2" class="calibre40"/></a></dt>
<dd class="calibre41"><p class="calibre42">This list is constrained to <code class="calibre17">Dish</code> types and must have at least three dishes.</p></dd>
</dl>

<p class="author1">If I pass in something that doesn’t follow these constraints (such as forgetting a dish):</p>

<pre data-type="programlisting" class="calibre35">pydantic.error_wrappers.ValidationError: 1 validation error for Restaurant
dishes
  ensure this value has at least 3 items
    (type=value_error.list.min_items; limit_value=3)</pre>

<p class="author1">With constrained types, I catch an additional 17 of my previously thought-up test cases, bringing my total up to 55 out of 67 test cases covered. Pretty nice, isn’t it?</p>

<p class="author1">To catch the remaining set of errors, I can use custom validators to embed those last pieces of validation logic:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="k">from</code> <code class="nn">pydantic</code> <code class="k">import</code> <code class="n">validator</code>
<code class="nd">@dataclass</code>
<code class="k">class</code> <code class="nc">Restaurant</code><code class="calibre17">:</code>
    <code class="n">name</code><code class="calibre17">:</code> <code class="n">constr</code><code class="calibre17">(</code><code class="n">regex</code><code class="calibre17">=</code><code class="calibre17">r</code><code class="s">'^[a-zA-Z0-9 ]*$'</code><code class="calibre17">,</code>
                   <code class="n">min_length</code><code class="calibre17">=</code><code class="mi">1</code><code class="calibre17">,</code> <code class="n">max_length</code><code class="calibre17">=</code><code class="mi">16</code><code class="calibre17">)</code>
    <code class="n">owner</code><code class="calibre17">:</code> <code class="n">constr</code><code class="calibre17">(</code><code class="n">min_length</code><code class="calibre17">=</code><code class="mi">1</code><code class="calibre17">)</code>
    <code class="n">address</code><code class="calibre17">:</code> <code class="n">constr</code><code class="calibre17">(</code><code class="n">min_length</code><code class="calibre17">=</code><code class="mi">1</code><code class="calibre17">)</code>
    <code class="n">employees</code><code class="calibre17">:</code> <code class="n">conlist</code><code class="calibre17">(</code><code class="n">Employee</code><code class="calibre17">,</code> <code class="n">min_items</code><code class="calibre17">=</code><code class="mi">2</code><code class="calibre17">)</code>
    <code class="n">dishes</code><code class="calibre17">:</code> <code class="n">conlist</code><code class="calibre17">(</code><code class="n">Dish</code><code class="calibre17">,</code> <code class="n">min_items</code><code class="calibre17">=</code><code class="mi">3</code><code class="calibre17">)</code>
    <code class="n">number_of_seats</code><code class="calibre17">:</code> <code class="n">PositiveInt</code>
    <code class="n">to_go</code><code class="calibre17">:</code> <code class="nb">bool</code>
    <code class="n">delivery</code><code class="calibre17">:</code> <code class="nb">bool</code>

    <code class="nd">@validator</code><code class="calibre17">(</code><code class="s">'employees'</code><code class="calibre17">)</code>
    <code class="k">def</code> <code class="nf">check_chef_and_server</code><code class="calibre17">(</code><code class="n">cls</code><code class="calibre17">,</code> <code class="n">employees</code><code class="calibre17">):</code>
        <code class="k">if</code> <code class="calibre17">(</code><code class="nb">any</code><code class="calibre17">(</code><code class="n">e</code> <code class="k">for</code> <code class="n">e</code> <code class="calibre19">in</code> <code class="n">employees</code> <code class="k">if</code> <code class="n">e</code><code class="calibre17">.</code><code class="n">position</code> <code class="calibre17">==</code> <code class="s">'Chef'</code><code class="calibre17">)</code> <code class="calibre19">and</code>
            <code class="nb">any</code><code class="calibre17">(</code><code class="n">e</code> <code class="k">for</code> <code class="n">e</code> <code class="calibre19">in</code> <code class="n">employees</code> <code class="k">if</code> <code class="n">e</code><code class="calibre17">.</code><code class="n">position</code> <code class="calibre17">==</code> <code class="s">'Server'</code><code class="calibre17">)):</code>
                <code class="k">return</code> <code class="n">employees</code>
        <code class="k">raise</code> <code class="ne">ValueError</code><code class="calibre17">(</code><code class="s">'Must have at least one chef and one server'</code><code class="calibre17">)</code></pre>

<p class="author1">If I then fail to provide at least one chef and server:</p>

<pre data-type="programlisting" class="calibre35">pydantic.error_wrappers.ValidationError: 1 validation error for Restaurant
employees
  Must have at least one chef and one server (type=value_error)</pre>

<p class="author1">I will leave it up to you to write custom validators for other error cases (such as valid addresses, valid routing numbers, or a valid image that exists on a filesystem).<a data-type="indexterm" data-primary="validators (pydantic)" data-startref="ix_valpyda" id="idm45644733542072" class="calibre5"/><a data-type="indexterm" data-primary="pydantic" data-secondary="validators" data-startref="ix_pydaval" id="idm45644733392856" class="calibre5"/></p>
</div></section>













</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 14. Runtime Checking With pydantic" class="preface">
<div class="preface" id="pydantic">
<section data-type="sect1" data-pdf-bookmark="pydantic" class="preface">
<div class="preface" id="idm45644735035192">
<section data-type="sect2" data-pdf-bookmark="Validation Versus Parsing" class="preface"><div class="preface" id="idm45644734053896">
<h2 class="calibre34" id="calibre_pb_5">Validation Versus Parsing</h2>

<p class="author1">Admittedly, pydantic is not strictly a validation library, but also a <em class="calibre6">parsing</em> library.<a data-type="indexterm" data-primary="pydantic" data-secondary="validation versus parsing" id="idm45644733389560" class="calibre5"/> The difference is slight, but needs to be called out. In all my examples, I have been using pydantic to check arguments and types, but it is not a strict validator. Pydantic advertises itself as a <em class="calibre6">parsing library</em>, which means it is providing a guarantee of what comes <em class="calibre6">out</em> of the data model, not what goes in. That is, when you are defining pydantic models, pydantic will do whatever it can to coerce data into the types you defined.</p>

<p class="author1">If you were to have a model:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="k">from</code> <code class="nn">pydantic</code> <code class="k">import</code> <code class="n">dataclass</code>
<code class="nd">@dataclass</code>
<code class="k">class</code> <code class="nc">Model</code><code class="calibre17">:</code>
    <code class="n">value</code><code class="calibre17">:</code> <code class="nb">int</code></pre>

<p class="author1">There is no problem passing in a string or a float into this model; pydantic will do its best to coerce the value to an integer (or throw an exception if the value is not coercible). This code throws no exceptions:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="n">Model</code><code class="calibre17">(</code><code class="n">value</code><code class="calibre17">=</code><code class="s">"123"</code><code class="calibre17">)</code> <code class="c"># value is set to the integer 123</code>
<code class="n">Model</code><code class="calibre17">(</code><code class="n">value</code><code class="calibre17">=</code><code class="mi">5.5</code><code class="calibre17">)</code> <code class="c"># this truncates the value to 5</code></pre>

<p class="author1">Pydantic is parsing these values, not validating them. You are not guaranteed to pass an integer into the model, but you are always guaranteed an <code class="calibre17">int</code> comes out on the other side (or an exception is thrown).</p>

<p class="author1">If you’d like to restrict this sort of behavior, you can use pydantic’s strict fields:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="k">from</code> <code class="nn">pydantic.dataclasses</code> <code class="k">import</code> <code class="n">dataclass</code>
<code class="k">from</code> <code class="nn">pydantic</code> <code class="k">import</code> <code class="n">StrictInt</code>
<code class="nd">@dataclass</code>
<code class="k">class</code> <code class="nc">Model</code><code class="calibre17">:</code>
    <code class="n">value</code><code class="calibre17">:</code> <code class="n">StrictInt</code></pre>

<p class="author1">Now, when constructing from another type,</p>

<pre data-type="programlisting" class="calibre35">x = Model(value="0023").value</pre>

<p class="author1">you will get an error:</p>

<pre data-type="programlisting" class="calibre35">pydantic.error_wrappers.ValidationError: 1 validation error for Model
value
  value is not a valid integer (type=type_error.integer)</pre>

<p class="author1">So, while pydantic advertises itself as a parsing library, it is possible to enforce more strict behavior in your data models.</p>
</div></section>





</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 14. Runtime Checking With pydantic" class="preface">
<div class="preface" id="pydantic">
<section data-type="sect1" data-pdf-bookmark="Closing Thoughts" class="preface"><div class="preface" id="idm45644734282296">
<h1 class="calibre12" id="calibre_pb_6">Closing Thoughts</h1>

<p class="author1">I’ve been harping on the importance of typecheckers throughout this book, but that doesn’t mean catching errors at runtime is meaningless. While typecheckers catch their fair share of errors and reduce runtime checks, they can’t catch everything. You still need validation logic to fill in the gaps.</p>

<p class="author1">For these sorts of checks, the pydantic library is a great tool in your toolbox. By embedding your validation logic directly into your types (without writing tons of tedious <code class="calibre17">if</code> statements), you improve robustness twofold. First, you dramatically increase readability; developers reading your type definition will know exactly what constraints are imposed upon it. Second, it gives you that much-needed layer of protection with runtime checking.</p>

<p class="author1">I find that pydantic also helps fill in the middle ground between a data class and a class.<a data-type="indexterm" data-primary="invariants" data-secondary="pydantic data classes" id="idm45644733268568" class="calibre5"/> Each constraint is technically fulfilling invariants about that class. I normally advise not to give your data classes an invariant because you can’t protect it; you don’t control construction and property access is public. However, pydantic protects the invariant even when you call a constructor or set a field. But, if you have fields that are interdependent (such as needing to set both at the same time or needing to set only one field based on the value of another), stick with a class.<a data-type="indexterm" data-primary="pydantic" data-startref="ix_pyda" id="idm45644733266952" class="calibre5"/></p>

<p class="author1">That’s it for <a data-type="xref" href="part0011.html#part_2" class="calibre5">Part II</a>. You’ve learned how to create your own types with <code class="calibre17">Enums</code>, data classes, and classes. Each of these fits a specific use case, so be mindful about your intentions when writing types. You learned how types can model <em class="calibre6">is-a</em> relationships with subtyping. You also learned why your API is so important to each class; it’s the first chance other developers get to understand what you’re doing. You finished up with this chapter, learning about the need to do runtime validation in addition to static typechecking.</p>

<p class="author1">In the next part, I’m going to take a step back and look at robustness from a much broader viewpoint. Pretty much all of the guidance in the first two parts of this book has focused on type annotations and typecheckers. Readability and error checking are important benefits of robustness, but they are not all there is. Other maintainers need to be able to make big changes to your codebase to introduce new functionality, not just small changes interacting with your types. They need to extend your codebase. <a data-type="xref" href="part0019.html#part_3" class="calibre5">Part III</a> will focus on extensibility.</p>
</div></section>







</div></section></body></html>