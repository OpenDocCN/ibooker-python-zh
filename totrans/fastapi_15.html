<html><head></head><body><section data-pdf-bookmark="Chapter 12. Testing" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch12">&#13;
<h1><span class="label">Chapter 12. </span>Testing</h1>&#13;
&#13;
<blockquote>&#13;
<p>A QA <a data-primary="Keller, Brenan" data-type="indexterm" id="id745"/>engineer walks into a bar. Orders a beer. Orders 0 beers. Orders 99999999999 beers. Orders a lizard. Orders –1 beers. Orders a ueicbksjdhd.</p>&#13;
&#13;
<p>First real customer walks in and asks where the bathroom is. The bar bursts into flames, killing everyone.</p>&#13;
<p data-type="attribution">Brenan Keller, <cite>Twitter</cite></p>&#13;
</blockquote>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Preview" data-type="sect1"><div class="sect1" id="id102">&#13;
<h1>Preview</h1>&#13;
&#13;
<p>This<a data-primary="testing" data-type="indexterm" id="icd112"/> chapter discusses the kinds of testing that you would perform&#13;
on a FastAPI site:&#13;
<em>unit</em>, <em>integration</em>, and <em>full</em>.&#13;
It features <em>pytest</em> and automated test development.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Web API Testing" data-type="sect1"><div class="sect1" id="id103">&#13;
<h1>Web API Testing</h1>&#13;
&#13;
<p>You’ve<a data-primary="testing" data-secondary="web API testing" data-type="indexterm" id="icd113"/> already<a data-primary="web API testing" data-type="indexterm" id="icd125"/> seen several manual API testing tools&#13;
as endpoints have been added:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>HTTPie</p>&#13;
</li>&#13;
<li>&#13;
<p>Requests</p>&#13;
</li>&#13;
<li>&#13;
<p>HTTPX</p>&#13;
</li>&#13;
<li>&#13;
<p>The web browser</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>And many more testing tools are available:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://curl.se">Curl</a> is very well known,<a data-primary="curl" data-type="indexterm" id="id746"/>&#13;
although in this&#13;
book I’ve used HTTPie instead for its simpler syntax.<a data-primary="HTTPie" data-secondary="testing" data-type="indexterm" id="id747"/></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="http://httpbin.org">Httpbin</a>,<a data-primary="httpbin" data-type="indexterm" id="id748"/>&#13;
written by the author of Requests,&#13;
is a free test server that&#13;
provides many views into your HTTP request.</p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://www.postman.com">Postman</a> is a full<a data-primary="Postman" data-type="indexterm" id="id749"/>&#13;
API test platform.</p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/eUK_R">Chrome DevTools</a><a data-primary="Chrome DevTools" data-type="indexterm" id="id750"/>&#13;
is a rich toolset,&#13;
part of the Chrome browser.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>These can all be used for full (end-to-end) tests,&#13;
such as those you’ve seen in the previous chapters.&#13;
Those manual tests have been useful for quickly verifying code&#13;
just after it’s typed.</p>&#13;
&#13;
<p>But what if a change that you make later breaks one&#13;
of those earlier manual tests (a <em>regression</em>)?&#13;
You don’t want to rerun dozens of tests after every code change.&#13;
That’s when <em>automated</em> tests become important. The rest of this chapter focuses on these, and how to build them with <a data-primary="web API testing" data-startref="icd125" data-type="indexterm" id="id751"/>pytest<a data-primary="testing" data-secondary="web API testing" data-startref="icd113" data-type="indexterm" id="id752"/>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Where to Test" data-type="sect1"><div class="sect1" id="id104">&#13;
<h1>Where to Test</h1>&#13;
&#13;
<p>I’ve<a data-primary="testing" data-secondary="varieties of" data-type="indexterm" id="id753"/> mentioned the varieties of tests:</p>&#13;
<dl>&#13;
<dt>Unit<a data-primary="unit tests" data-type="indexterm" id="id754"/></dt>&#13;
<dd>&#13;
<p>Within<a data-primary="testing" data-secondary="unit tests" data-type="indexterm" id="id755"/> a layer, tests individual functions</p>&#13;
</dd>&#13;
<dt>Integration<a data-primary="integration tests" data-type="indexterm" id="id756"/></dt>&#13;
<dd>&#13;
<p><a data-primary="testing" data-secondary="integration tests" data-type="indexterm" id="id757"/>Across layers, tests connectivity</p>&#13;
</dd>&#13;
<dt>Full<a data-primary="full (end-to-end; contract) tests" data-secondary="defined" data-type="indexterm" id="id758"/></dt>&#13;
<dd>&#13;
<p>Tests<a data-primary="testing" data-secondary="full tests" data-type="indexterm" id="id759"/> the full API and stack beneath it</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>Sometimes these are called <a data-primary="test pyramid" data-type="indexterm" id="id760"/>a <em>test pyramid</em>,&#13;
with the width indicating the relative number of tests that should&#13;
be in each group (<a data-type="xref" href="#fig-pyramid">Figure 12-1</a>).</p>&#13;
&#13;
<figure><div class="figure" id="fig-pyramid">&#13;
<img alt="fapi 1201" src="assets/fapi_1201.png"/>&#13;
<h6><span class="label">Figure 12-1. </span>Test pyramid</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="What to Test" data-type="sect1"><div class="sect1" id="id218">&#13;
<h1>What to Test</h1>&#13;
&#13;
<p>What <a data-primary="testing" data-secondary="what to test" data-type="indexterm" id="icd114"/>should you test as you’re writing code?&#13;
Basically, for a given input,&#13;
confirm that you get the correct output.&#13;
You might check the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Missing inputs</p>&#13;
</li>&#13;
<li>&#13;
<p>Duplicate inputs</p>&#13;
</li>&#13;
<li>&#13;
<p>Incorrect input types</p>&#13;
</li>&#13;
<li>&#13;
<p>Incorrect input order</p>&#13;
</li>&#13;
<li>&#13;
<p>Invalid input values</p>&#13;
</li>&#13;
<li>&#13;
<p>Huge inputs or outputs</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Errors can happen anywhere:</p>&#13;
<dl>&#13;
<dt>The <a data-primary="testing" data-secondary="Web layer" data-type="indexterm" id="id761"/>Web layer<a data-primary="Web layer" data-secondary="testing" data-type="indexterm" id="id762"/></dt>&#13;
<dd>&#13;
<p>Pydantic will catch any mismatch&#13;
with the model and return a <code>422</code> HTTP status code.</p>&#13;
</dd>&#13;
<dt>The <a data-primary="testing" data-secondary="Data layer" data-type="indexterm" id="id763"/>Data layer<a data-primary="Data layer" data-secondary="testing" data-type="indexterm" id="id764"/></dt>&#13;
<dd>&#13;
<p>The database will raise exceptions&#13;
for missing or duplicate data,&#13;
as well as SQL query syntax errors.&#13;
Timeouts or memory exhaustion may occur when&#13;
passing a huge data result in one piece,&#13;
instead of in chunks with a generator or pagination.</p>&#13;
</dd>&#13;
<dt>Any layer</dt>&#13;
<dd>&#13;
<p>Plain old bugs and oversights can occur.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>Chapters <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch08.html#ch08">8</a> through&#13;
<a data-type="xref" data-xrefstyle="select:labelnumber" href="ch10.html#ch10">10</a>&#13;
contained some of these tests:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><em>Full manual tests</em>, using tools like HTTPie</p>&#13;
</li>&#13;
<li>&#13;
<p><em>Unit manual tests</em>, as Python fragments</p>&#13;
</li>&#13;
<li>&#13;
<p><em>Automated tests</em>, using pytest scripts</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The next few sections expand on pytest<a data-primary="testing" data-secondary="what to test" data-startref="icd114" data-type="indexterm" id="id765"/>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Pytest" data-type="sect1"><div class="sect1" id="id105">&#13;
<h1>Pytest</h1>&#13;
&#13;
<p>Python<a data-primary="testing" data-secondary="pytest" data-type="indexterm" id="icd115"/> has<a data-primary="pytest" data-type="indexterm" id="icd126"/> long had the standard package&#13;
<a href="https://oreil.ly/3u0M_">unittest</a>.<a data-primary="unittest" data-type="indexterm" id="id766"/>&#13;
A later third-party package called&#13;
<a href="https://nose.readthedocs.io">nose</a><a data-primary="nose" data-type="indexterm" id="id767"/>&#13;
tried to improve on it.&#13;
Most Python developers now prefer&#13;
<a href="https://docs.pytest.org">pytest</a>,&#13;
which does more&#13;
than either of these&#13;
and is easier to use.&#13;
It isn’t built into Python,&#13;
so you’ll need to run&#13;
<code>pip install pytest</code>&#13;
if you don’t already have it.&#13;
Also, run&#13;
<code>pip install pytest-mock</code>&#13;
to get the&#13;
automatic <code>mocker</code> fixture;&#13;
you’ll see this later in this chapter.</p>&#13;
&#13;
<p>What does pytest offer?&#13;
Nice automatic features include the following:</p>&#13;
<dl>&#13;
<dt>Test discovery</dt>&#13;
<dd>&#13;
<p>A test prefix or test suffix in a Python filename&#13;
will be run automatically.&#13;
This filename matching goes down into subdirectories,&#13;
executing as many tests as you have there.</p>&#13;
</dd>&#13;
<dt>Assertion failure details</dt>&#13;
<dd>&#13;
<p>A failing <code>assert</code> statement prints&#13;
what was expected and what actually happened.</p>&#13;
</dd>&#13;
<dt>Fixtures</dt>&#13;
<dd>&#13;
<p>These functions can run once for the whole test script,&#13;
or run for every test&#13;
(its <em>scope</em>),&#13;
providing test functions with parameters like&#13;
standard test data or database initialization.&#13;
Fixtures are a sort of dependency injection,&#13;
like FastAPI offers for web path functions:&#13;
specific data passed to a general test function.</p>&#13;
</dd>&#13;
<dt>Parameterization</dt>&#13;
<dd>&#13;
<p>This provides multiple test data to a test <a data-primary="pytest" data-startref="icd126" data-type="indexterm" id="id768"/>function<a data-primary="testing" data-secondary="pytest" data-startref="icd115" data-type="indexterm" id="id769"/>.</p>&#13;
</dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Layout" data-type="sect1"><div class="sect1" id="id219">&#13;
<h1>Layout</h1>&#13;
&#13;
<p>Where<a data-primary="testing" data-secondary="layout" data-type="indexterm" id="id770"/> should you put your tests?&#13;
There doesn’t seem to be wide agreement,&#13;
but here are two reasonable designs:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>A <em>test</em> directory at the top,&#13;
with subdirectories for the code area being tested (like <em>web</em>,&#13;
<em>service</em>, etc.)</p>&#13;
</li>&#13;
<li>&#13;
<p>A <em>test</em> directory under each code directory&#13;
(like <em>web</em>, <em>service</em>, etc.).</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Also, within the specific subdirectory like <em>test/web</em>,&#13;
should you make more directories for different test types&#13;
(like <em>unit</em>, <em>integration</em>, and <em>full</em>)?&#13;
In this book, I’m using this hierarchy:</p>&#13;
&#13;
<pre data-type="programlisting">test&#13;
├── unit&#13;
│   ├── web&#13;
│   ├── service&#13;
│   └── data&#13;
├── integration&#13;
└── full</pre>&#13;
&#13;
<p>Individual test scripts live within the bottom directories.&#13;
Those are in this chapter.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Automated Unit Tests" data-type="sect1"><div class="sect1" id="id106">&#13;
<h1>Automated Unit Tests</h1>&#13;
&#13;
<p>A <a data-primary="testing" data-secondary="unit tests" data-type="indexterm" id="icd116"/>unit<a data-primary="unit tests" data-type="indexterm" id="icd117"/> test should check one thing,&#13;
within one layer.&#13;
This usually means passing parameter(s)&#13;
to a function and asserting what should be returned.</p>&#13;
&#13;
<p>Unit tests require <em>isolation</em>&#13;
of the code being tested.&#13;
If not, you’re also testing something else.&#13;
So, how do you isolate code for unit tests?</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Mocking" data-type="sect2"><div class="sect2" id="id107">&#13;
<h2>Mocking</h2>&#13;
&#13;
<p>In <a data-primary="unit tests" data-secondary="mocking" data-type="indexterm" id="icd118"/>this<a data-primary="mocking" data-type="indexterm" id="icd132"/> book’s code stack,&#13;
accessing a URL via a web API generally calls&#13;
a function in the Web layer,&#13;
which calls a function in the Service layer,&#13;
which calls a function in the Data layer,&#13;
which accesses a database.&#13;
The results flow back up the chain,&#13;
eventually back out of the Web layer to the caller.</p>&#13;
&#13;
<p>Unit testing sounds simple.&#13;
For each function in your codebase,&#13;
pass in test arguments&#13;
and confirm that it returns expected values.&#13;
This works well for a <em>pure function</em>: one&#13;
that takes input arguments and returns responses&#13;
without referencing any external code.&#13;
But most functions also call other functions,&#13;
so how can you control what those other functions do?&#13;
What about the data that comes from these external sources?&#13;
The most common external factor to control is&#13;
database access, but really it can be anything.</p>&#13;
&#13;
<p>One method is to <em>mock</em> each external function call.&#13;
Because functions are first-class objects in Python,&#13;
you can substitute one function&#13;
for another.&#13;
The unittest package has a mock module that does this.</p>&#13;
&#13;
<p>Many developers believe that mocking is the best way&#13;
to isolate unit tests.&#13;
I’ll first show examples of mocking here,&#13;
along with the argument that often mocking requires too much&#13;
knowledge of <em>how</em> your code works,&#13;
rather than the results.&#13;
You may hear the terms<a data-primary="structural testing" data-type="indexterm" id="id771"/>&#13;
<em>structural testing</em>&#13;
(as in mocks, where the tested code is quite visible)&#13;
and&#13;
<em>behavioral testing</em><a data-primary="behavioral testing" data-type="indexterm" id="id772"/>&#13;
(where the code internals are not needed).</p>&#13;
&#13;
<p>Examples <a data-type="xref" data-xrefstyle="select:labelnumber" href="#ex-12-1">12-1</a> and&#13;
<a data-type="xref" data-xrefstyle="select:labelnumber" href="#ex-12-2">12-2</a> define the modules&#13;
<em>mod1.py</em> and <em>mod2.py</em>.</p>&#13;
<div data-type="example" id="ex-12-1">&#13;
<h5><span class="label">Example 12-1. </span>Called module <span class="plain">(mod1.py)</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">preamble</code><code class="p">()</code> <code class="o">-&gt;</code> <code class="nb">str</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="s2">"The sum is "</code></pre></div>&#13;
<div data-type="example" id="ex-12-2">&#13;
<h5><span class="label">Example 12-2. </span>Calling module <span class="plain">(mod2.py)</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">mod1</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">summer</code><code class="p">(</code><code class="n">x</code><code class="p">:</code> <code class="nb">int</code><code class="p">,</code> <code class="n">y</code><code class="p">:</code><code class="nb">int</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">str</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">mod1</code><code class="o">.</code><code class="n">preamble</code><code class="p">()</code> <code class="o">+</code> <code class="sa">f</code><code class="s2">"</code><code class="si">{</code><code class="n">x</code><code class="o">+</code><code class="n">y</code><code class="si">}</code><code class="s2">"</code></pre></div>&#13;
&#13;
<p>The <code>summer()</code> function calculates the sum of its arguments,&#13;
and returns a string with a preamble and the sum.&#13;
<a data-type="xref" href="#ex-12-3">Example 12-3</a> is a minimal pytest script&#13;
to verify <code>summer()</code>.</p>&#13;
<div data-type="example" id="ex-12-3">&#13;
<h5><span class="label">Example 12-3. </span>Pytest script <span class="plain">test_summer1.py</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">mod2</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_summer</code><code class="p">():</code>&#13;
    <code class="k">assert</code> <code class="s2">"The sum is 11"</code> <code class="o">==</code> <code class="n">mod2</code><code class="o">.</code><code class="n">summer</code><code class="p">(</code><code class="mi">5</code><code class="p">,</code><code class="mi">6</code><code class="p">)</code></pre></div>&#13;
&#13;
<p><a data-type="xref" href="#ex-12-4">Example 12-4</a> runs the test successfully.</p>&#13;
<div data-type="example" id="ex-12-4">&#13;
<h5><span class="label">Example 12-4. </span>Run the pytest script</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>pytest -q test_summer1.py</strong>&#13;
.                                                                    [100%]&#13;
1 passed in 0.04s</pre></div>&#13;
&#13;
<p>(The <code>-q</code> runs the test quietly,&#13;
without lots of extra printed details.)&#13;
OK, it passed.&#13;
But the <code>summer()</code> function got some text from the <code>preamble</code>&#13;
function.&#13;
What if we just want to test that the addition succeeded?</p>&#13;
&#13;
<p>We could write a new function that just&#13;
returns the stringified sum of two numbers, and&#13;
then rewrite <code>summer()</code> to return this&#13;
appended to the <code>preamble()</code> string.</p>&#13;
&#13;
<p>Or, we could mock <code>preamble()</code> to remove its effect,&#13;
as shown in multiple ways in <a data-type="xref" href="#ex-12-5">Example 12-5</a>.</p>&#13;
<div data-type="example" id="ex-12-5">&#13;
<h5><span class="label">Example 12-5. </span>Pytest with a mock <span class="plain">(test_summer2.py)</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">unittest</code> <code class="kn">import</code> <code class="n">mock</code>&#13;
<code class="kn">import</code> <code class="nn">mod1</code>&#13;
<code class="kn">import</code> <code class="nn">mod2</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_summer_a</code><code class="p">():</code>&#13;
    <code class="k">with</code> <code class="n">mock</code><code class="o">.</code><code class="n">patch</code><code class="p">(</code><code class="s2">"mod1.preamble"</code><code class="p">,</code> <code class="n">return_value</code><code class="o">=</code><code class="s2">""</code><code class="p">):</code>&#13;
        <code class="k">assert</code> <code class="s2">"11"</code> <code class="o">==</code> <code class="n">mod2</code><code class="o">.</code><code class="n">summer</code><code class="p">(</code><code class="mi">5</code><code class="p">,</code><code class="mi">6</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_summer_b</code><code class="p">():</code>&#13;
    <code class="k">with</code> <code class="n">mock</code><code class="o">.</code><code class="n">patch</code><code class="p">(</code><code class="s2">"mod1.preamble"</code><code class="p">)</code> <code class="k">as</code> <code class="n">mock_preamble</code><code class="p">:</code>&#13;
        <code class="n">mock_preamble</code><code class="o">.</code><code class="n">return_value</code><code class="o">=</code><code class="s2">""</code>&#13;
        <code class="k">assert</code> <code class="s2">"11"</code> <code class="o">==</code> <code class="n">mod2</code><code class="o">.</code><code class="n">summer</code><code class="p">(</code><code class="mi">5</code><code class="p">,</code><code class="mi">6</code><code class="p">)</code>&#13;
&#13;
<code class="nd">@mock</code><code class="o">.</code><code class="n">patch</code><code class="p">(</code><code class="s2">"mod1.preamble"</code><code class="p">,</code> <code class="n">return_value</code><code class="o">=</code><code class="s2">""</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">test_summer_c</code><code class="p">(</code><code class="n">mock_preamble</code><code class="p">):</code>&#13;
    <code class="k">assert</code> <code class="s2">"11"</code> <code class="o">==</code> <code class="n">mod2</code><code class="o">.</code><code class="n">summer</code><code class="p">(</code><code class="mi">5</code><code class="p">,</code><code class="mi">6</code><code class="p">)</code>&#13;
&#13;
<code class="nd">@mock</code><code class="o">.</code><code class="n">patch</code><code class="p">(</code><code class="s2">"mod1.preamble"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">test_caller_d</code><code class="p">(</code><code class="n">mock_preamble</code><code class="p">):</code>&#13;
    <code class="n">mock_preamble</code><code class="o">.</code><code class="n">return_value</code> <code class="o">=</code> <code class="s2">""</code>&#13;
    <code class="k">assert</code> <code class="s2">"11"</code> <code class="o">==</code> <code class="n">mod2</code><code class="o">.</code><code class="n">summer</code><code class="p">(</code><code class="mi">5</code><code class="p">,</code><code class="mi">6</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>These tests show that mocks can be created in more than one way.&#13;
The function <code>test_caller_a()</code> uses <code>mock.patch()</code> as&#13;
a Python <em>context manager</em> (the <code>with</code> statement).<a data-primary="context managers" data-type="indexterm" id="id773"/>&#13;
Its arguments are listed here:</p>&#13;
<dl>&#13;
<dt><code>"mod1.preamble"</code></dt>&#13;
<dd>&#13;
<p>The full string name of the&#13;
<code>preamble()</code> function in module <code>mod1</code>.</p>&#13;
</dd>&#13;
<dt><code>return_value=""</code></dt>&#13;
<dd>&#13;
<p>Makes this mocked version return an empty string.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>The <code>test_caller_b()</code> function is almost the same,&#13;
but adds <code>as mock_preamble</code> to use the mock object on the next line.</p>&#13;
&#13;
<p>The <code>test_caller_c()</code> function defines the mock with&#13;
a Python <em>decorator</em>.<a data-primary="decorators" data-type="indexterm" id="id774"/>&#13;
The mocked object is passed as an argument to <code>test_caller2()</code>.</p>&#13;
&#13;
<p>The <code>test_caller_d()</code> function is like <code>test_caller_b()</code>,&#13;
setting the <code>return_value</code> in a separate call to <code>mock_preamble</code>.</p>&#13;
&#13;
<p>In each case, the string name of the thing to be mocked&#13;
must match the way it’s called in the code that’s being tested—in this case, <code>summer()</code>.&#13;
The mock library converts this string name to a variable&#13;
that will intercept any references to the original variable&#13;
with that name.&#13;
(Remember that in Python, variables are just references to&#13;
the real objects.)</p>&#13;
&#13;
<p>So, when <a data-type="xref" href="#ex-12-6">Example 12-6</a> is run,&#13;
in all four <code>summer()</code> test functions,&#13;
when <code>summer(5,6)</code> is called, the changeling&#13;
mock <code>preamble()</code> is called instead of the real one.&#13;
The mocked version drops that string, so the test can&#13;
ensure that <code>summer()</code> returns a string version of the&#13;
sum of its <a data-primary="mocking" data-startref="icd132" data-type="indexterm" id="id775"/>two arguments<a data-primary="unit tests" data-secondary="mocking" data-startref="icd118" data-type="indexterm" id="id776"/>.</p>&#13;
<div data-type="example" id="ex-12-6">&#13;
<h5><span class="label">Example 12-6. </span>Run mocked pytest</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>pytest -q test_summer2.py</strong>&#13;
....                                                                 [100%]&#13;
4 passed in 0.13s</pre></div>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>That was a contrived case, for simplicity.&#13;
Mocking can be quite complex;&#13;
see articles <a data-primary="Ronquillo, Alex" data-type="indexterm" id="id777"/>like&#13;
<a href="https://oreil.ly/I0bkd">“Understanding the Python Mock Object Library” by Alex Ronquillo</a>&#13;
for clear examples,&#13;
and the official&#13;
<a href="https://oreil.ly/hN9lZ">Python docs</a>&#13;
for the harrowing details.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Test Doubles and Fakes" data-type="sect2"><div class="sect2" id="id220">&#13;
<h2>Test Doubles and Fakes</h2>&#13;
&#13;
<p>To <a data-primary="unit tests" data-secondary="test doubles and fakes" data-type="indexterm" id="icd119"/>perform that mock, you needed to know&#13;
that the <code>summer()</code> function imported the&#13;
function <code>preamble()</code> from the module <code>mod1</code>.&#13;
This was a structural test,&#13;
requiring knowledge of specific variable and module names.</p>&#13;
&#13;
<p>Is there a way to perform a behavioral&#13;
test that doesn’t&#13;
need this?</p>&#13;
&#13;
<p>One way is to define a <em>double</em>:&#13;
separate code that does what we want in the test—in this case, make <code>preamble()</code> return an empty string.&#13;
One way to do this is with imports.&#13;
Apply this to this example first,&#13;
before using it for unit tests in the layers&#13;
of the next three sections.</p>&#13;
&#13;
<p>First, redefine <em>mod2.py</em> in <a data-type="xref" href="#ex-12-7">Example 12-7</a>.</p>&#13;
<div data-type="example" id="ex-12-7">&#13;
<h5><span class="label">Example 12-7. </span>Make <span class="plain">mod2.py</span> import a double if unit testing</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">os</code>&#13;
<code class="k">if</code> <code class="n">os</code><code class="o">.</code><code class="n">get_env</code><code class="p">(</code><code class="s2">"UNIT_TEST"</code><code class="p">):</code>&#13;
    <code class="kn">import</code> <code class="nn">fake_mod1</code> <code class="k">as</code> <code class="nn">mod1</code>&#13;
<code class="k">else</code><code class="p">:</code>&#13;
    <code class="kn">import</code> <code class="nn">mod1</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">summer</code><code class="p">(</code><code class="n">x</code><code class="p">:</code> <code class="nb">int</code><code class="p">,</code> <code class="n">y</code><code class="p">:</code><code class="nb">int</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">str</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">mod1</code><code class="o">.</code><code class="n">preamble</code><code class="p">()</code> <code class="o">+</code> <code class="sa">f</code><code class="s2">"</code><code class="si">{</code><code class="n">x</code><code class="o">+</code><code class="n">y</code><code class="si">}</code><code class="s2">"</code></pre></div>&#13;
&#13;
<p><a data-type="xref" href="#ex-12-8">Example 12-8</a> defines that double module <em>fake_mod1.py</em>.</p>&#13;
<div data-type="example" id="ex-12-8">&#13;
<h5><span class="label">Example 12-8. </span>Double <span class="plain">fake_mod1.py</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">preamble</code><code class="p">()</code> <code class="o">-&gt;</code> <code class="nb">str</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="s2">""</code></pre></div>&#13;
&#13;
<p>And <a data-type="xref" href="#ex-12-9">Example 12-9</a> is the test.</p>&#13;
<div data-type="example" id="ex-12-9">&#13;
<h5><span class="label">Example 12-9. </span>Test script <span class="plain">test_summer_fake.py</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">os</code>&#13;
<code class="n">os</code><code class="o">.</code><code class="n">environ</code><code class="p">[</code><code class="s2">"UNIT_TEST"</code><code class="p">]</code> <code class="o">=</code> <code class="s2">"true"</code>&#13;
<code class="kn">import</code> <code class="nn">mod2</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_summer_fake</code><code class="p">():</code>&#13;
    <code class="k">assert</code> <code class="s2">"11"</code> <code class="o">==</code> <code class="n">mod2</code><code class="o">.</code><code class="n">summer</code><code class="p">(</code><code class="mi">5</code><code class="p">,</code><code class="mi">6</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>…​.which <a data-type="xref" href="#ex-12-10">Example 12-10</a> runs.</p>&#13;
<div data-type="example" id="ex-12-10">&#13;
<h5><span class="label">Example 12-10. </span>Run the new unit test</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>pytest -q test_summer_fake.py</strong>&#13;
.                                                                    [100%]&#13;
1 passed in 0.04s</pre></div>&#13;
&#13;
<p>This import-switching method does require adding a check&#13;
for an environment variable,&#13;
but avoids having to write specific mocks for function calls.&#13;
You can be the judge of which you prefer.&#13;
The next few sections will use the <code>import</code> method,&#13;
which works nicely with the <em>fake</em> package that&#13;
I’d been using as I defined the code layers.</p>&#13;
&#13;
<p>To summarize, these examples replaced <code>preamble()</code> with a <em>mock</em> in&#13;
a test script or imported a doppelgänger&#13;
<em>double</em>.&#13;
You can isolate the code being tested in other ways,&#13;
but these work&#13;
and are not as tricky as others that Google might find for you<a data-primary="unit tests" data-secondary="test doubles and fakes" data-startref="icd119" data-type="indexterm" id="id778"/>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Web" data-type="sect2"><div class="sect2" id="id221">&#13;
<h2>Web</h2>&#13;
&#13;
<p>This<a data-primary="unit tests" data-secondary="Web layer" data-type="indexterm" id="icd120"/> layer<a data-primary="Web layer" data-secondary="testing" data-type="indexterm" id="icd127"/> implements <a data-primary="testing" data-secondary="Web layer" data-type="indexterm" id="icd800"/>the site’s API.&#13;
Ideally, each path function (endpoint)&#13;
should have at least one test—maybe more, if the function could fail in more than one way.&#13;
At the Web layer, you typically want to see if the&#13;
endpoint exists,&#13;
works with the correct parameters,&#13;
and returns the right status code and data.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>These are shallow API tests,&#13;
testing solely within the Web layer.&#13;
So, Service-layer calls&#13;
(which would in turn call the Data layer and the database)&#13;
need to be intercepted, along with any other calls&#13;
that exit the Web layer.</p>&#13;
</div>&#13;
&#13;
<p>Using the <code>import</code> idea of the previous section, use the environment variable <code>CRYPTID_UNIT_TEST</code>&#13;
to import the <em>fake</em> package as <code>service</code>,&#13;
instead of the real <code>service</code>.&#13;
This stops Web functions from calling Service functions,&#13;
and instead short-circuits them to the <em>fake</em>&#13;
(doubles) version.&#13;
Then the lower Data layer and database aren’t involved, either.&#13;
We get what we want: unit tests.&#13;
<a data-type="xref" href="#ex-12-11">Example 12-11</a> has the modified <em>web/creature.py</em> file.</p>&#13;
<div data-type="example" id="ex-12-11">&#13;
<h5><span class="label">Example 12-11. </span>Modified <span class="plain">web/creature.py</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">os</code>&#13;
<code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">APIRouter</code><code class="p">,</code> <code class="n">HTTPException</code>&#13;
<code class="kn">from</code> <code class="nn">model.creature</code> <code class="kn">import</code> <code class="n">Creature</code>&#13;
<code class="k">if</code> <code class="n">os</code><code class="o">.</code><code class="n">getenv</code><code class="p">(</code><code class="s2">"CRYPTID_UNIT_TEST"</code><code class="p">):</code>&#13;
    <code class="kn">from</code> <code class="nn">fake</code> <code class="kn">import</code> <code class="n">creature</code> <code class="k">as</code> <code class="n">service</code>&#13;
<code class="k">else</code><code class="p">:</code>&#13;
    <code class="kn">from</code> <code class="nn">service</code> <code class="kn">import</code> <code class="n">creature</code> <code class="k">as</code> <code class="n">service</code>&#13;
<code class="kn">from</code> <code class="nn">error</code> <code class="kn">import</code> <code class="n">Missing</code><code class="p">,</code> <code class="n">Duplicate</code>&#13;
&#13;
<code class="n">router</code> <code class="o">=</code> <code class="n">APIRouter</code><code class="p">(</code><code class="n">prefix</code> <code class="o">=</code> <code class="s2">"/creature"</code><code class="p">)</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">get_all</code><code class="p">()</code> <code class="o">-&gt;</code> <code class="nb">list</code><code class="p">[</code><code class="n">Creature</code><code class="p">]:</code>&#13;
    <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="n">get_all</code><code class="p">()</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/</code><code class="si">{name}</code><code class="s2">"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">get_one</code><code class="p">(</code><code class="n">name</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Creature</code><code class="p">:</code>&#13;
    <code class="k">try</code><code class="p">:</code>&#13;
        <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="n">get_one</code><code class="p">(</code><code class="n">name</code><code class="p">)</code>&#13;
    <code class="k">except</code> <code class="n">Missing</code> <code class="k">as</code> <code class="n">exc</code><code class="p">:</code>&#13;
        <code class="k">raise</code> <code class="n">HTTPException</code><code class="p">(</code><code class="n">status_code</code><code class="o">=</code><code class="mi">404</code><code class="p">,</code> <code class="n">detail</code><code class="o">=</code><code class="n">exc</code><code class="o">.</code><code class="n">msg</code><code class="p">)</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"/"</code><code class="p">,</code> <code class="n">status_code</code><code class="o">=</code><code class="mi">201</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">create</code><code class="p">(</code><code class="n">creature</code><code class="p">:</code> <code class="n">Creature</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Creature</code><code class="p">:</code>&#13;
    <code class="k">try</code><code class="p">:</code>&#13;
        <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">creature</code><code class="p">)</code>&#13;
    <code class="k">except</code> <code class="n">Duplicate</code> <code class="k">as</code> <code class="n">exc</code><code class="p">:</code>&#13;
        <code class="k">raise</code> <code class="n">HTTPException</code><code class="p">(</code><code class="n">status_code</code><code class="o">=</code><code class="mi">409</code><code class="p">,</code> <code class="n">detail</code><code class="o">=</code><code class="n">exc</code><code class="o">.</code><code class="n">msg</code><code class="p">)</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">patch</code><code class="p">(</code><code class="s2">"/"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">modify</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">,</code> <code class="n">creature</code><code class="p">:</code> <code class="n">Creature</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Creature</code><code class="p">:</code>&#13;
    <code class="k">try</code><code class="p">:</code>&#13;
        <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="n">modify</code><code class="p">(</code><code class="n">name</code><code class="p">,</code> <code class="n">creature</code><code class="p">)</code>&#13;
    <code class="k">except</code> <code class="n">Missing</code> <code class="k">as</code> <code class="n">exc</code><code class="p">:</code>&#13;
        <code class="k">raise</code> <code class="n">HTTPException</code><code class="p">(</code><code class="n">status_code</code><code class="o">=</code><code class="mi">404</code><code class="p">,</code> <code class="n">detail</code><code class="o">=</code><code class="n">exc</code><code class="o">.</code><code class="n">msg</code><code class="p">)</code>&#13;
&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">delete</code><code class="p">(</code><code class="s2">"/</code><code class="si">{name}</code><code class="s2">"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">delete</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="kc">None</code><code class="p">:</code>&#13;
    <code class="k">try</code><code class="p">:</code>&#13;
        <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="n">delete</code><code class="p">(</code><code class="n">name</code><code class="p">)</code>&#13;
    <code class="k">except</code> <code class="n">Missing</code> <code class="k">as</code> <code class="n">exc</code><code class="p">:</code>&#13;
        <code class="k">raise</code> <code class="n">HTTPException</code><code class="p">(</code><code class="n">status_code</code><code class="o">=</code><code class="mi">404</code><code class="p">,</code> <code class="n">detail</code><code class="o">=</code><code class="n">exc</code><code class="o">.</code><code class="n">msg</code><code class="p">)</code></pre></div>&#13;
&#13;
<p><a data-type="xref" href="#ex-12-12">Example 12-12</a> has tests, using two pytest fixtures:</p>&#13;
<dl>&#13;
<dt><code>sample()</code></dt>&#13;
<dd>&#13;
<p>A new <code>Creature</code> object</p>&#13;
</dd>&#13;
<dt><code>fakes()</code></dt>&#13;
<dd>&#13;
<p>A list of “existing” creatures</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>The fakes are obtained from a lower-level module.&#13;
By setting the environment variable <code>CRYPTID_UNIT_TEST</code>,&#13;
the Web module from <a data-type="xref" href="#ex-12-11">Example 12-11</a>&#13;
imports the fake service version&#13;
(providing fake data rather than calling the database)&#13;
instead of the&#13;
real one.&#13;
This isolates the tests, which is the point.<a data-primary="unit tests" data-secondary="Web layer" data-startref="icd120" data-type="indexterm" id="id779"/><a data-primary="testing" data-secondary="Web layer" data-startref="icd800" data-type="indexterm" id="id780"/><a data-primary="Web layer" data-secondary="testing" data-startref="icd127" data-type="indexterm" id="id781"/></p>&#13;
<div data-type="example" id="ex-12-12">&#13;
<h5><span class="label">Example 12-12. </span>Web unit tests for creatures, using fixtures</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">HTTPException</code>&#13;
<code class="kn">import</code> <code class="nn">pytest</code>&#13;
<code class="kn">import</code> <code class="nn">os</code>&#13;
<code class="n">os</code><code class="o">.</code><code class="n">environ</code><code class="p">[</code><code class="s2">"CRYPTID_UNIT_TEST"</code><code class="p">]</code> <code class="o">=</code> <code class="s2">"true"</code>&#13;
<code class="kn">from</code> <code class="nn">model.creature</code> <code class="kn">import</code> <code class="n">Creature</code>&#13;
<code class="kn">from</code> <code class="nn">web</code> <code class="kn">import</code> <code class="n">creature</code>&#13;
&#13;
<code class="nd">@pytest</code><code class="o">.</code><code class="n">fixture</code>&#13;
<code class="k">def</code> <code class="nf">sample</code><code class="p">()</code> <code class="o">-&gt;</code> <code class="n">Creature</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">Creature</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s2">"dragon"</code><code class="p">,</code>&#13;
        <code class="n">description</code><code class="o">=</code><code class="s2">"Wings! Fire! Aieee!"</code><code class="p">,</code>&#13;
        <code class="n">country</code><code class="o">=</code><code class="s2">"*"</code><code class="p">)</code>&#13;
&#13;
<code class="nd">@pytest</code><code class="o">.</code><code class="n">fixture</code>&#13;
<code class="k">def</code> <code class="nf">fakes</code><code class="p">()</code> <code class="o">-&gt;</code> <code class="nb">list</code><code class="p">[</code><code class="n">Creature</code><code class="p">]:</code>&#13;
    <code class="k">return</code> <code class="n">creature</code><code class="o">.</code><code class="n">get_all</code><code class="p">()</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">assert_duplicate</code><code class="p">(</code><code class="n">exc</code><code class="p">):</code>&#13;
    <code class="k">assert</code> <code class="n">exc</code><code class="o">.</code><code class="n">value</code><code class="o">.</code><code class="n">status_code</code> <code class="o">==</code> <code class="mi">404</code>&#13;
    <code class="k">assert</code> <code class="s2">"Duplicate"</code> <code class="ow">in</code> <code class="n">exc</code><code class="o">.</code><code class="n">value</code><code class="o">.</code><code class="n">msg</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">assert_missing</code><code class="p">(</code><code class="n">exc</code><code class="p">):</code>&#13;
    <code class="k">assert</code> <code class="n">exc</code><code class="o">.</code><code class="n">value</code><code class="o">.</code><code class="n">status_code</code> <code class="o">==</code> <code class="mi">404</code>&#13;
    <code class="k">assert</code> <code class="s2">"Missing"</code> <code class="ow">in</code> <code class="n">exc</code><code class="o">.</code><code class="n">value</code><code class="o">.</code><code class="n">msg</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_create</code><code class="p">(</code><code class="n">sample</code><code class="p">):</code>&#13;
    <code class="k">assert</code> <code class="n">creature</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">sample</code><code class="p">)</code> <code class="o">==</code> <code class="n">sample</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_create_duplicate</code><code class="p">(</code><code class="n">fakes</code><code class="p">):</code>&#13;
    <code class="k">with</code> <code class="n">pytest</code><code class="o">.</code><code class="n">raises</code><code class="p">(</code><code class="n">HTTPException</code><code class="p">)</code> <code class="k">as</code> <code class="n">exc</code><code class="p">:</code>&#13;
        <code class="n">_</code> <code class="o">=</code> <code class="n">creature</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">fakes</code><code class="p">[</code><code class="mi">0</code><code class="p">])</code>&#13;
        <code class="n">assert_duplicate</code><code class="p">(</code><code class="n">exc</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_get_one</code><code class="p">(</code><code class="n">fakes</code><code class="p">):</code>&#13;
    <code class="k">assert</code> <code class="n">creature</code><code class="o">.</code><code class="n">get_one</code><code class="p">(</code><code class="n">fakes</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="o">.</code><code class="n">name</code><code class="p">)</code> <code class="o">==</code> <code class="n">fakes</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_get_one_missing</code><code class="p">():</code>&#13;
    <code class="k">with</code> <code class="n">pytest</code><code class="o">.</code><code class="n">raises</code><code class="p">(</code><code class="n">HTTPException</code><code class="p">)</code> <code class="k">as</code> <code class="n">exc</code><code class="p">:</code>&#13;
        <code class="n">_</code> <code class="o">=</code> <code class="n">creature</code><code class="o">.</code><code class="n">get_one</code><code class="p">(</code><code class="s2">"bobcat"</code><code class="p">)</code>&#13;
        <code class="n">assert_missing</code><code class="p">(</code><code class="n">exc</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_modify</code><code class="p">(</code><code class="n">fakes</code><code class="p">):</code>&#13;
    <code class="k">assert</code> <code class="n">creature</code><code class="o">.</code><code class="n">modify</code><code class="p">(</code><code class="n">fakes</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="o">.</code><code class="n">name</code><code class="p">,</code> <code class="n">fakes</code><code class="p">[</code><code class="mi">0</code><code class="p">])</code> <code class="o">==</code> <code class="n">fakes</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_modify_missing</code><code class="p">(</code><code class="n">sample</code><code class="p">):</code>&#13;
    <code class="k">with</code> <code class="n">pytest</code><code class="o">.</code><code class="n">raises</code><code class="p">(</code><code class="n">HTTPException</code><code class="p">)</code> <code class="k">as</code> <code class="n">exc</code><code class="p">:</code>&#13;
        <code class="n">_</code> <code class="o">=</code> <code class="n">creature</code><code class="o">.</code><code class="n">modify</code><code class="p">(</code><code class="n">sample</code><code class="o">.</code><code class="n">name</code><code class="p">,</code> <code class="n">sample</code><code class="p">)</code>&#13;
        <code class="n">assert_missing</code><code class="p">(</code><code class="n">exc</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_delete</code><code class="p">(</code><code class="n">fakes</code><code class="p">):</code>&#13;
    <code class="k">assert</code> <code class="n">creature</code><code class="o">.</code><code class="n">delete</code><code class="p">(</code><code class="n">fakes</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="o">.</code><code class="n">name</code><code class="p">)</code> <code class="ow">is</code> <code class="kc">None</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_delete_missing</code><code class="p">(</code><code class="n">sample</code><code class="p">):</code>&#13;
    <code class="k">with</code> <code class="n">pytest</code><code class="o">.</code><code class="n">raises</code><code class="p">(</code><code class="n">HTTPException</code><code class="p">)</code> <code class="k">as</code> <code class="n">exc</code><code class="p">:</code>&#13;
        <code class="n">_</code> <code class="o">=</code> <code class="n">creature</code><code class="o">.</code><code class="n">delete</code><code class="p">(</code><code class="s2">"emu"</code><code class="p">)</code>&#13;
        <code class="n">assert_missing</code><code class="p">(</code><code class="n">exc</code><code class="p">)</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Service" data-type="sect2"><div class="sect2" id="id222">&#13;
<h2>Service</h2>&#13;
&#13;
<p>In<a data-primary="unit tests" data-secondary="Service layer" data-type="indexterm" id="icd121"/> a <a data-primary="Service layer" data-secondary="testing" data-type="indexterm" id="icd128"/>way,<a data-primary="testing" data-secondary="Service layer" data-type="indexterm" id="icd700"/> the Service layer is the important one&#13;
and could be connected to different Web and Data layers.&#13;
<a data-type="xref" href="#ex-12-13">Example 12-13</a> is similar to <a data-type="xref" href="#ex-12-11">Example 12-11</a>,&#13;
differing mainly in the <code>import</code> and use&#13;
of the lower-level data module.&#13;
It also doesn’t catch any exceptions that might arise&#13;
from the Data layer,&#13;
leaving them to be handled by the Web layer.</p>&#13;
<div data-type="example" id="ex-12-13">&#13;
<h5><span class="label">Example 12-13. </span>Modified <span class="plain">service/creature.py</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">os</code>&#13;
<code class="kn">from</code> <code class="nn">model.creature</code> <code class="kn">import</code> <code class="n">Creature</code>&#13;
<code class="k">if</code> <code class="n">os</code><code class="o">.</code><code class="n">getenv</code><code class="p">(</code><code class="s2">"CRYPTID_UNIT_TEST"</code><code class="p">):</code>&#13;
    <code class="kn">from</code> <code class="nn">fake</code> <code class="kn">import</code> <code class="n">creature</code> <code class="k">as</code> <code class="n">data</code>&#13;
<code class="k">else</code><code class="p">:</code>&#13;
    <code class="kn">from</code> <code class="nn">data</code> <code class="kn">import</code> <code class="n">creature</code> <code class="k">as</code> <code class="n">data</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">get_all</code><code class="p">()</code> <code class="o">-&gt;</code> <code class="nb">list</code><code class="p">[</code><code class="n">Creature</code><code class="p">]:</code>&#13;
    <code class="k">return</code> <code class="n">data</code><code class="o">.</code><code class="n">get_all</code><code class="p">()</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">get_one</code><code class="p">(</code><code class="n">name</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Creature</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">data</code><code class="o">.</code><code class="n">get_one</code><code class="p">(</code><code class="n">name</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">create</code><code class="p">(</code><code class="n">creature</code><code class="p">:</code> <code class="n">Creature</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Creature</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">data</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">creature</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">modify</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">,</code> <code class="n">creature</code><code class="p">:</code> <code class="n">Creature</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Creature</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">data</code><code class="o">.</code><code class="n">modify</code><code class="p">(</code><code class="n">name</code><code class="p">,</code> <code class="n">creature</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">delete</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="kc">None</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">data</code><code class="o">.</code><code class="n">delete</code><code class="p">(</code><code class="n">name</code><code class="p">)</code></pre></div>&#13;
&#13;
<p><a data-type="xref" href="#ex-12-14">Example 12-14</a> has the corresponding unit tests.<a data-primary="Service layer" data-secondary="testing" data-startref="icd128" data-type="indexterm" id="id782"/><a data-primary="testing" data-secondary="Service layer" data-startref="icd700" data-type="indexterm" id="id783"/><a data-primary="unit tests" data-secondary="Service layer" data-startref="icd121" data-type="indexterm" id="id784"/></p>&#13;
<div data-type="example" id="ex-12-14">&#13;
<h5><span class="label">Example 12-14. </span>Service tests in <span class="plain">test/unit/service/test_creature.py</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">os</code>&#13;
<code class="n">os</code><code class="o">.</code><code class="n">environ</code><code class="p">[</code><code class="s2">"CRYPTID_UNIT_TEST"</code><code class="p">]</code><code class="o">=</code> <code class="s2">"true"</code>&#13;
<code class="kn">import</code> <code class="nn">pytest</code>&#13;
&#13;
<code class="kn">from</code> <code class="nn">model.creature</code> <code class="kn">import</code> <code class="n">Creature</code>&#13;
<code class="kn">from</code> <code class="nn">error</code> <code class="kn">import</code> <code class="n">Missing</code><code class="p">,</code> <code class="n">Duplicate</code>&#13;
<code class="kn">from</code> <code class="nn">data</code> <code class="kn">import</code> <code class="n">creature</code> <code class="k">as</code> <code class="n">data</code>&#13;
&#13;
<code class="nd">@pytest</code><code class="o">.</code><code class="n">fixture</code>&#13;
<code class="k">def</code> <code class="nf">sample</code><code class="p">()</code> <code class="o">-&gt;</code> <code class="n">Creature</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">Creature</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s2">"yeti"</code><code class="p">,</code>&#13;
        <code class="n">aka</code><code class="p">:</code><code class="s2">"Abominable Snowman"</code><code class="p">,</code>&#13;
        <code class="n">country</code><code class="o">=</code><code class="s2">"CN"</code><code class="p">,</code>&#13;
        <code class="n">area</code><code class="o">=</code><code class="s2">"Himalayas"</code><code class="p">,</code>&#13;
        <code class="n">description</code><code class="o">=</code><code class="s2">"Handsome Himalayan"</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_create</code><code class="p">(</code><code class="n">sample</code><code class="p">):</code>&#13;
    <code class="n">resp</code> <code class="o">=</code> <code class="n">data</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">sample</code><code class="p">)</code>&#13;
    <code class="k">assert</code> <code class="n">resp</code> <code class="o">==</code> <code class="n">sample</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_create_duplicate</code><code class="p">(</code><code class="n">sample</code><code class="p">):</code>&#13;
    <code class="n">resp</code> <code class="o">=</code> <code class="n">data</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">sample</code><code class="p">)</code>&#13;
    <code class="k">assert</code> <code class="n">resp</code> <code class="o">==</code> <code class="n">sample</code>&#13;
    <code class="k">with</code> <code class="n">pytest</code><code class="o">.</code><code class="n">raises</code><code class="p">(</code><code class="n">Duplicate</code><code class="p">):</code>&#13;
        <code class="n">resp</code> <code class="o">=</code> <code class="n">data</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">sample</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_get_exists</code><code class="p">(</code><code class="n">sample</code><code class="p">):</code>&#13;
    <code class="n">resp</code> <code class="o">=</code> <code class="n">data</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">sample</code><code class="p">)</code>&#13;
    <code class="k">assert</code> <code class="n">resp</code> <code class="o">==</code> <code class="n">sample</code>&#13;
    <code class="n">resp</code> <code class="o">=</code> <code class="n">data</code><code class="o">.</code><code class="n">get_one</code><code class="p">(</code><code class="n">sample</code><code class="o">.</code><code class="n">name</code><code class="p">)</code>&#13;
    <code class="k">assert</code> <code class="n">resp</code> <code class="o">==</code> <code class="n">sample</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_get_missing</code><code class="p">():</code>&#13;
    <code class="k">with</code> <code class="n">pytest</code><code class="o">.</code><code class="n">raises</code><code class="p">(</code><code class="n">Missing</code><code class="p">):</code>&#13;
        <code class="n">_</code> <code class="o">=</code> <code class="n">data</code><code class="o">.</code><code class="n">get_one</code><code class="p">(</code><code class="s2">"boxturtle"</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_modify</code><code class="p">(</code><code class="n">sample</code><code class="p">):</code>&#13;
    <code class="n">sample</code><code class="o">.</code><code class="n">country</code> <code class="o">=</code> <code class="s2">"CA"</code> <code class="c1"># Canada!</code>&#13;
    <code class="n">resp</code> <code class="o">=</code> <code class="n">data</code><code class="o">.</code><code class="n">modify</code><code class="p">(</code><code class="n">sample</code><code class="o">.</code><code class="n">name</code><code class="p">,</code> <code class="n">sample</code><code class="p">)</code>&#13;
    <code class="k">assert</code> <code class="n">resp</code> <code class="o">==</code> <code class="n">sample</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_modify_missing</code><code class="p">():</code>&#13;
    <code class="n">bob</code><code class="p">:</code> <code class="n">Creature</code> <code class="o">=</code> <code class="n">Creature</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s2">"bob"</code><code class="p">,</code> <code class="n">country</code><code class="o">=</code><code class="s2">"US"</code><code class="p">,</code> <code class="n">area</code><code class="o">=</code><code class="s2">"*"</code><code class="p">,</code>&#13;
        <code class="n">description</code><code class="o">=</code><code class="s2">"some guy"</code><code class="p">,</code> <code class="n">aka</code><code class="o">=</code><code class="s2">"??"</code><code class="p">)</code>&#13;
    <code class="k">with</code> <code class="n">pytest</code><code class="o">.</code><code class="n">raises</code><code class="p">(</code><code class="n">Missing</code><code class="p">):</code>&#13;
        <code class="n">_</code> <code class="o">=</code> <code class="n">data</code><code class="o">.</code><code class="n">modify</code><code class="p">(</code><code class="n">bob</code><code class="o">.</code><code class="n">name</code><code class="p">,</code> <code class="n">bob</code><code class="p">)</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Data" data-type="sect2"><div class="sect2" id="id108">&#13;
<h2>Data</h2>&#13;
&#13;
<p>The <a data-primary="unit tests" data-secondary="Data layer" data-type="indexterm" id="id785"/>Data <a data-primary="Data layer" data-secondary="testing" data-type="indexterm" id="id786"/>layer <a data-primary="testing" data-secondary="Data layer" data-type="indexterm" id="id787"/>is simpler to test in isolation, because&#13;
there’s no worry about accidentally calling a function&#13;
in an even lower layer.&#13;
Unit tests should cover both the functions in this layer&#13;
and the specific database queries that they use.&#13;
So far, SQLite has been the database “server” and SQL&#13;
the query language.&#13;
But as I mention in <a data-type="xref" href="ch14.html#ch14">Chapter 14</a>,&#13;
you may decide to work with a package like SQLAlchemy<a data-primary="SQLAlchemy" data-type="indexterm" id="id788"/>,&#13;
and use its SQLAlchemy Expression Language or its ORM.&#13;
Then these would need full tests.&#13;
So far, I’ve kept to the lowest level: Python’s&#13;
DB-API and vanilla SQL queries.</p>&#13;
&#13;
<p>Unlike the Web and Service unit tests,&#13;
this time we don’t need “fake” modules to replace&#13;
the existing Data layer modules.&#13;
Instead, set a different environment variable to get the&#13;
Data layer to use a memory-only SQLite instance&#13;
instead of a file-based one.&#13;
This doesn’t require any changes to the existing Data&#13;
modules, just a setting in <a data-type="xref" href="#ex-12-15">Example 12-15</a>’s&#13;
test <em>before</em> importing any Data<a data-primary="unit tests" data-startref="icd117" data-type="indexterm" id="id789"/> modules<a data-primary="testing" data-secondary="unit tests" data-startref="icd116" data-type="indexterm" id="id790"/>.</p>&#13;
<div data-type="example" id="ex-12-15">&#13;
<h5><span class="label">Example 12-15. </span>Data unit tests <span class="plain">test/unit/data/test_creature.py</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">os</code>&#13;
<code class="kn">import</code> <code class="nn">pytest</code>&#13;
<code class="kn">from</code> <code class="nn">model.creature</code> <code class="kn">import</code> <code class="n">Creature</code>&#13;
<code class="kn">from</code> <code class="nn">error</code> <code class="kn">import</code> <code class="n">Missing</code><code class="p">,</code> <code class="n">Duplicate</code>&#13;
&#13;
<code class="c1"># set this before data import below</code>&#13;
<code class="n">os</code><code class="o">.</code><code class="n">environ</code><code class="p">[</code><code class="s2">"CRYPTID_SQLITE_DB"</code><code class="p">]</code> <code class="o">=</code> <code class="s2">":memory:"</code>&#13;
<code class="kn">from</code> <code class="nn">data</code> <code class="kn">import</code> <code class="n">creature</code>&#13;
&#13;
<code class="nd">@pytest</code><code class="o">.</code><code class="n">fixture</code>&#13;
<code class="k">def</code> <code class="nf">sample</code><code class="p">()</code> <code class="o">-&gt;</code> <code class="n">Creature</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">Creature</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s2">"yeti"</code><code class="p">,</code>&#13;
        <code class="n">aka</code><code class="o">=</code><code class="s2">"Abominable Snowman"</code><code class="p">,</code>&#13;
        <code class="n">country</code><code class="o">=</code><code class="s2">"CN"</code><code class="p">,</code>&#13;
        <code class="n">area</code><code class="o">=</code><code class="s2">"Himalayas"</code><code class="p">,</code>&#13;
        <code class="n">description</code><code class="o">=</code><code class="s2">"Hapless Himalayan"</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_create</code><code class="p">(</code><code class="n">sample</code><code class="p">):</code>&#13;
    <code class="n">resp</code> <code class="o">=</code> <code class="n">creature</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">sample</code><code class="p">)</code>&#13;
    <code class="k">assert</code> <code class="n">resp</code> <code class="o">==</code> <code class="n">sample</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_create_duplicate</code><code class="p">(</code><code class="n">sample</code><code class="p">):</code>&#13;
    <code class="k">with</code> <code class="n">pytest</code><code class="o">.</code><code class="n">raises</code><code class="p">(</code><code class="n">Duplicate</code><code class="p">):</code>&#13;
        <code class="n">_</code> <code class="o">=</code> <code class="n">creature</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">sample</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_get_one</code><code class="p">(</code><code class="n">sample</code><code class="p">):</code>&#13;
    <code class="n">resp</code> <code class="o">=</code> <code class="n">creature</code><code class="o">.</code><code class="n">get_one</code><code class="p">(</code><code class="n">sample</code><code class="o">.</code><code class="n">name</code><code class="p">)</code>&#13;
    <code class="k">assert</code> <code class="n">resp</code> <code class="o">==</code> <code class="n">sample</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_get_one_missing</code><code class="p">():</code>&#13;
    <code class="k">with</code> <code class="n">pytest</code><code class="o">.</code><code class="n">raises</code><code class="p">(</code><code class="n">Missing</code><code class="p">):</code>&#13;
        <code class="n">resp</code> <code class="o">=</code> <code class="n">creature</code><code class="o">.</code><code class="n">get_one</code><code class="p">(</code><code class="s2">"boxturtle"</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_modify</code><code class="p">(</code><code class="n">sample</code><code class="p">):</code>&#13;
    <code class="n">creature</code><code class="o">.</code><code class="n">country</code> <code class="o">=</code> <code class="s2">"JP"</code>  <code class="c1"># Japan!</code>&#13;
    <code class="n">resp</code> <code class="o">=</code> <code class="n">creature</code><code class="o">.</code><code class="n">modify</code><code class="p">(</code><code class="n">sample</code><code class="o">.</code><code class="n">name</code><code class="p">,</code> <code class="n">sample</code><code class="p">)</code>&#13;
    <code class="k">assert</code> <code class="n">resp</code> <code class="o">==</code> <code class="n">sample</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_modify_missing</code><code class="p">():</code>&#13;
    <code class="n">thing</code><code class="p">:</code> <code class="n">Creature</code> <code class="o">=</code> <code class="n">Creature</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s2">"snurfle"</code><code class="p">,</code>&#13;
        <code class="n">description</code><code class="o">=</code><code class="s2">"some thing"</code><code class="p">,</code> <code class="n">country</code><code class="o">=</code><code class="s2">"somewhere"</code><code class="p">)</code>&#13;
    <code class="k">with</code> <code class="n">pytest</code><code class="o">.</code><code class="n">raises</code><code class="p">(</code><code class="n">Missing</code><code class="p">):</code>&#13;
        <code class="n">_</code> <code class="o">=</code> <code class="n">creature</code><code class="o">.</code><code class="n">modify</code><code class="p">(</code><code class="n">thing</code><code class="o">.</code><code class="n">name</code><code class="p">,</code> <code class="n">thing</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_delete</code><code class="p">(</code><code class="n">sample</code><code class="p">):</code>&#13;
    <code class="n">resp</code> <code class="o">=</code> <code class="n">creature</code><code class="o">.</code><code class="n">delete</code><code class="p">(</code><code class="n">sample</code><code class="o">.</code><code class="n">name</code><code class="p">)</code>&#13;
    <code class="k">assert</code> <code class="n">resp</code> <code class="ow">is</code> <code class="kc">None</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_delete_missing</code><code class="p">(</code><code class="n">sample</code><code class="p">):</code>&#13;
    <code class="k">with</code> <code class="n">pytest</code><code class="o">.</code><code class="n">raises</code><code class="p">(</code><code class="n">Missing</code><code class="p">):</code>&#13;
        <code class="n">_</code> <code class="o">=</code> <code class="n">creature</code><code class="o">.</code><code class="n">delete</code><code class="p">(</code><code class="n">sample</code><code class="o">.</code><code class="n">name</code><code class="p">)</code></pre></div>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Automated Integration Tests" data-type="sect1"><div class="sect1" id="id109">&#13;
<h1>Automated Integration Tests</h1>&#13;
&#13;
<p><a data-primary="testing" data-secondary="integration tests" data-type="indexterm" id="icd123"/>Integration<a data-primary="integration tests" data-type="indexterm" id="icd130"/> tests show how well different code interacts&#13;
<em>between</em> layers.&#13;
But if you look for examples of this,&#13;
you get many different answers.&#13;
Should you test partial call trails&#13;
like Web → Service, Web → Data, and so on?</p>&#13;
&#13;
<p>To fully test every connection in an A → B → C&#13;
pipeline, you’d need to test the <span class="keep-together">following</span>:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>A → B</p>&#13;
</li>&#13;
<li>&#13;
<p>B → C</p>&#13;
</li>&#13;
<li>&#13;
<p>A → C</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>And the arrows would fill a quiver if you have more&#13;
than these three junctions.</p>&#13;
&#13;
<p>Or should integration tests be essentially full tests,&#13;
but with the&#13;
very end piece—data storage on disk—mocked?</p>&#13;
&#13;
<p>So far, you’ve been using SQLite as the database,&#13;
and you can use in-memory SQLite as a double (fake)&#13;
for the on-disk SQLite database.&#13;
If your queries are <em>very</em> standard SQL,&#13;
SQLite-in-memory may be an adequate mock for&#13;
other databases as well.&#13;
If not, these modules are tailored to&#13;
mock specific databases:</p>&#13;
<dl>&#13;
<dt>PostgreSQL</dt>&#13;
<dd>&#13;
<p><a href="https://pgmock.readthedocs.io">pgmock</a><a data-primary="pgmock" data-type="indexterm" id="id791"/><a data-primary="PostgreSQL" data-type="indexterm" id="id792"/></p>&#13;
</dd>&#13;
<dt>MongoDB</dt>&#13;
<dd>&#13;
<p><a href="https://github.com/mongomock/mongomock">Mongomock</a><a data-primary="Mongomock" data-type="indexterm" id="id793"/><a data-primary="MongoDB" data-type="indexterm" id="id794"/></p>&#13;
</dd>&#13;
<dt>Many</dt>&#13;
<dd>&#13;
<p><a href="https://pytest-mock-resources.readthedocs.io">Pytest Mock Resources</a><a data-primary="Pytest Mock Resources" data-type="indexterm" id="id795"/>&#13;
spins up various test databases in Docker containers,&#13;
and is integrated with pytest.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>Finally, you could just fire up a test database of the same kind&#13;
as production.&#13;
An environment variable could contain the specifics,&#13;
much like the unit test/fake trick you’ve been <a data-primary="integration tests" data-startref="icd130" data-type="indexterm" id="id796"/>using<a data-primary="testing" data-secondary="integration tests" data-startref="icd123" data-type="indexterm" id="id797"/>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The Repository Pattern" data-type="sect1"><div class="sect1" id="id110">&#13;
<h1>The Repository Pattern</h1>&#13;
&#13;
<p>Although<a data-primary="testing" data-secondary="Repository pattern" data-type="indexterm" id="id798"/> I<a data-primary="Repository pattern" data-type="indexterm" id="id799"/> did not implement it for this book,&#13;
the&#13;
<a href="https://oreil.ly/3JMKH">Repository pattern</a>&#13;
is an interesting approach.&#13;
A <em>repository</em>  is a simple intermediate in-memory data store—like the fake Data layer that you’ve seen here so far.&#13;
This then talks to pluggable backends for real databases.&#13;
It’s accompanied <a data-primary="Unit of Work pattern" data-type="indexterm" id="id800"/>by a&#13;
 <a href="https://oreil.ly/jHGV8"><em>Unit of Work</em> pattern</a>,&#13;
which ensures that a group of operations in a single <em>session</em>&#13;
is either committed or rolled back as a whole.</p>&#13;
&#13;
<p>So far, the database queries in this book have been atomic.&#13;
For real-world database work, you may need&#13;
multistep queries, and some kind of session&#13;
handling. The Repository pattern also dovetails with&#13;
 <a href="https://oreil.ly/0f0Q3">dependency injection</a>,<a data-primary="dependency injection" data-type="indexterm" id="id801"/>&#13;
 which you’ve seen elsewhere in this book and&#13;
 probably appreciate a little by now.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before less_space" data-pdf-bookmark="Automated Full Tests" data-type="sect1"><div class="sect1" id="id111">&#13;
<h1>Automated Full Tests</h1>&#13;
&#13;
<p>Full<a data-primary="testing" data-secondary="full tests" data-type="indexterm" id="icd124"/> tests <a data-primary="full (end-to-end; contract) tests" data-secondary="automated" data-type="indexterm" id="icd131"/>exercise all the layers together,&#13;
as close to production use as possible.&#13;
Most of the tests that you’ve already seen in this&#13;
book have been full: call the Web endpoint,&#13;
run through Servicetown to downtown Dataville,&#13;
and return with groceries.&#13;
These are closed tests.&#13;
Everything is live, and you don’t care how it does it,&#13;
just that it does it.</p>&#13;
&#13;
<p>You can fully test each endpoint in&#13;
the overall API in two ways:</p>&#13;
<dl>&#13;
<dt>Over HTTP/HTTPS</dt>&#13;
<dd>&#13;
<p>Write individual Python test clients that&#13;
access the server. Many examples in this book have done this,&#13;
with standalone clients like HTTPie, or in scripts using Requests.</p>&#13;
</dd>&#13;
<dt>Using <code>TestClient</code></dt>&#13;
<dd>&#13;
<p>Use this built-in FastAPI/Starlette&#13;
object to access the server directly, without an overt&#13;
TCP connection.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>But these approaches require writing one or more tests for each endpoint.&#13;
This can become medieval, and we’re a few centuries&#13;
past medieval now.&#13;
A more recent approach is based on&#13;
<em>property-based testing</em>.&#13;
This takes advantage of FastAPI’s&#13;
autogenerated documentation.&#13;
An OpenAPI <em>schema</em> called <em>openapi.json</em>&#13;
is created by <span class="keep-together">FastAPI</span> every time you change a path function&#13;
or path decorator in the Web layer.&#13;
This schema details everything about every endpoint: arguments,&#13;
return values, and so on.&#13;
That’s what OpenAPI is for, as described here by the <a href="https://www.openapis.org/faq">OpenAPI Initiative’s FAQ page</a>:</p>&#13;
<blockquote>&#13;
<p>The OAS defines a standard, programming language-agnostic interface&#13;
description for REST APIs, which allows both humans and computers to&#13;
discover and understand the capabilities of a service without requiring&#13;
access to source code, additional documentation, or inspection of&#13;
network traffic.</p>&#13;
<p data-type="attribution">OAS (OpenAPI Specification)</p>&#13;
</blockquote>&#13;
&#13;
<p>Two packages<a data-primary="Hypothesis" data-type="indexterm" id="id802"/> are<a data-primary="Schemathesis" data-type="indexterm" id="id803"/> needed:</p>&#13;
<dl>&#13;
<dt><a href="https://hypothesis.works">Hypothesis</a></dt>&#13;
<dd>&#13;
<p><code>pip install hypothesis</code></p>&#13;
</dd>&#13;
<dt><a href="https://schemathesis.readthedocs.io">Schemathesis</a></dt>&#13;
<dd>&#13;
<p><code>pip install schemathesis</code></p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>Hypothesis is the base library,&#13;
and Schemathesis applies it&#13;
to the OpenAPI 3.0 schema that FastAPI generates.&#13;
Running Schemathesis reads this schema,&#13;
generates gobs of tests with varying data&#13;
(that you don’t need to come up with!),&#13;
and works with pytest.</p>&#13;
&#13;
<p>To keep this brief, <a data-type="xref" href="#ex-12-16">Example 12-16</a> first&#13;
slims <em>main.py</em> down to its base&#13;
creature and explorer endpoints.</p>&#13;
<div data-type="example" id="ex-12-16">&#13;
<h5><span class="label">Example 12-16. </span>Bare-bones <span class="plain">main.py</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">FastAPI</code>&#13;
<code class="kn">from</code> <code class="nn">web</code> <code class="kn">import</code> <code class="n">explorer</code><code class="p">,</code> <code class="n">creature</code>&#13;
&#13;
<code class="n">app</code> <code class="o">=</code> <code class="n">FastAPI</code><code class="p">()</code>&#13;
<code class="n">app</code><code class="o">.</code><code class="n">include_router</code><code class="p">(</code><code class="n">explorer</code><code class="o">.</code><code class="n">router</code><code class="p">)</code>&#13;
<code class="n">app</code><code class="o">.</code><code class="n">include_router</code><code class="p">(</code><code class="n">creature</code><code class="o">.</code><code class="n">router</code><code class="p">)</code></pre></div>&#13;
&#13;
<p><a data-type="xref" href="#ex-12-17">Example 12-17</a> runs the tests.</p>&#13;
<div data-type="example" id="ex-12-17">&#13;
<h5><span class="label">Example 12-17. </span>Run Schemathesis tests</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>schemathesis http://localhost:8000/openapi.json</strong>&#13;
===================== Schemathesis test session starts =====================&#13;
Schema location: http://localhost:8000/openapi.json&#13;
Base URL: http://localhost:8000/&#13;
Specification version: Open API 3.0.2&#13;
Workers: 1&#13;
Collected API operations: 12&#13;
&#13;
GET /explorer/ .                                                      [  8%]&#13;
POST /explorer/ .                                                     [ 16%]&#13;
PATCH /explorer/ F                                                    [ 25%]&#13;
GET /explorer .                                                       [ 33%]&#13;
POST /explorer .                                                      [ 41%]&#13;
GET /explorer/{name} .                                                [ 50%]&#13;
DELETE /explorer/{name} .                                             [ 58%]&#13;
GET /creature/ .                                                      [ 66%]&#13;
POST /creature/ .                                                     [ 75%]&#13;
PATCH /creature/ F                                                    [ 83%]&#13;
GET /creature/{name} .                                                [ 91%]&#13;
DELETE /creature/{name} .                                             [100%]</pre></div>&#13;
&#13;
<p>I got two F’s, both in <code>PATCH</code> calls&#13;
(<code>modify()</code> functions).&#13;
How mortifying.</p>&#13;
&#13;
<p>This output section is followed by one marked <code>FAILURES</code>,&#13;
with detailed stack traces of any tests that failed.&#13;
Those need to be fixed.&#13;
The final section is marked <code>SUMMARY</code>:</p>&#13;
&#13;
<pre data-type="programlisting">Performed checks:&#13;
    not_a_server_error                    717 / 727 passed          FAILED&#13;
&#13;
Hint: You can visualize test results in Schemathesis.io&#13;
by using `--report` in your CLI command.</pre>&#13;
&#13;
<p>That was fast,&#13;
and multiple tests were not needed for each endpoint,&#13;
imagining inputs that might break them.&#13;
Property-based testing reads the types and constraints&#13;
of the input arguments from the API schema,&#13;
and generates a range of values&#13;
to shoot at each endpoint.</p>&#13;
&#13;
<p>This is yet another unexpected benefit of type hints,&#13;
which at first seemed to be just nice <a data-primary="full (end-to-end; contract) tests" data-secondary="automated" data-startref="icd131" data-type="indexterm" id="id804"/>things<a data-primary="testing" data-secondary="full tests" data-startref="icd124" data-type="indexterm" id="id805"/>:</p>&#13;
<ul class="simplelist"><li>type hints → OpenAPI schema → generated documentation <em>and</em> tests</li></ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Security Testing" data-type="sect1"><div class="sect1" id="id112">&#13;
<h1>Security Testing</h1>&#13;
&#13;
<p>Security<a data-primary="testing" data-secondary="security testing" data-type="indexterm" id="id806"/> isn’t<a data-primary="security testing" data-type="indexterm" id="id807"/> one thing, but everything.&#13;
You need to defend against malice&#13;
but also against plain old mistakes,&#13;
and even events that you have no control over.&#13;
Let’s defer scaling issues to the next section and deal&#13;
mainly here with the analysis of potential threats.</p>&#13;
&#13;
<p><a data-type="xref" href="ch11.html#ch11">Chapter 11</a> discussed authentication and authorization.&#13;
These factors are always messy and error-prone.&#13;
It’s tempting to use clever methods to counteract&#13;
clever attacks, and it’s always a challenge to design&#13;
protection that’s easy to understand and implement.</p>&#13;
&#13;
<p>But now that you know about Schemathesis,<a data-primary="Schemathesis" data-type="indexterm" id="id808"/>&#13;
read its&#13;
<a href="https://oreil.ly/v_O-Q">documentation</a>&#13;
on property-based testing for authentication.&#13;
Just as it vastly simplified testing most of the API,&#13;
it can automate much of the tests for endpoints that&#13;
need authentication.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Load Testing" data-type="sect1"><div class="sect1" id="id113">&#13;
<h1>Load Testing</h1>&#13;
&#13;
<p>Load<a data-primary="testing" data-secondary="load testing" data-type="indexterm" id="id809"/> tests<a data-primary="load testing" data-type="indexterm" id="id810"/> show how your application handles heavy traffic:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>API calls</p>&#13;
</li>&#13;
<li>&#13;
<p>Database reads or writes</p>&#13;
</li>&#13;
<li>&#13;
<p>Memory use</p>&#13;
</li>&#13;
<li>&#13;
<p>Disk use</p>&#13;
</li>&#13;
<li>&#13;
<p>Network latency and bandwidth</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Some can be <em>full</em> tests that simulate an army of users&#13;
clamoring to use your service;&#13;
you want to be ready before that day arrives.&#13;
The content in this section overlaps with that in&#13;
<a data-type="xref" href="ch13.html#performanceSect">“Performance”</a>&#13;
and&#13;
<a data-type="xref" href="ch13.html#troubleshooting">“Troubleshooting”</a>.</p>&#13;
&#13;
<p>Many good load testers out are there,&#13;
but here I’ll recommend&#13;
<a href="https://locust.io">Locust</a>.<a data-primary="Locust" data-type="indexterm" id="id811"/>&#13;
With Locust, you define all your tests with plain Python scripts.&#13;
It can simulate hundreds of thousands of users,&#13;
all pounding away at your site, or even multiple servers,&#13;
at once.</p>&#13;
&#13;
<p>Install it locally with <code>pip install locust</code>.&#13;
Your first test may be how many concurrent visitors your site can handle.&#13;
This is like testing how much extreme weather a building&#13;
can withstand when faced with a hurricane/earthquake/blizzard&#13;
or other home insurance event.&#13;
So, you need some website structural tests.&#13;
Follow the Locust&#13;
<a href="https://docs.locust.io">docs</a>&#13;
for all the details.</p>&#13;
&#13;
<p>But, as they say on TV, there’s more!&#13;
Recently,&#13;
<a href="https://github.com/alteryx/locust-grasshopper">Grasshopper</a>&#13;
extended Locust to do things<a data-primary="Grasshopper" data-type="indexterm" id="id812"/>&#13;
like measuring time across multiple HTTP calls.&#13;
To try this extension out,&#13;
install with <code>pip install locust-grasshopper</code>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Review" data-type="sect1"><div class="sect1" id="id114">&#13;
<h1>Review</h1>&#13;
&#13;
<p>This chapter fleshed out the types of testing,&#13;
with examples of pytest performing automated code testing at the&#13;
unit, integration, and full levels.&#13;
API tests can be automated with Schemathesis.&#13;
This chapter also discussed how to expose security and performance&#13;
problems before they strike<a data-primary="testing" data-startref="icd112" data-type="indexterm" id="id813"/>.</p>&#13;
</div></section>&#13;
</div></section></body></html>