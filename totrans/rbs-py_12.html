<html><head></head><body>
<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 10. User-Defined Types: Classes" class="preface"><div class="preface" id="classes">
<h1 class="calibre10" id="calibre_pb_0"><span class="calibre">Chapter 10. </span>User-Defined Types: Classes</h1>


<p class="author1">Classes will be the final user-defined type that I’ll cover in this book.<a data-type="indexterm" data-primary="classes" id="ix_clss" class="calibre5"/><a data-type="indexterm" data-primary="user-defined types" data-secondary="classes" id="ix_usrDTCl" class="calibre5"/> Many developers learn classes early, and this is both a boon and a bane. Classes are used in many frameworks and codebases, so it pays off to be fluent in class design. However, when developers learn classes too early, they miss the nuance of when and, more importantly, when not to use them.</p>

<p class="author1">Think back to your use of classes. Could you represent that data as a <code class="calibre17">dataclass</code> instead? What about a set of free functions? I’ve seen too many codebases that use classes everywhere when they really shouldn’t, and maintainability suffers because <span class="calibre">of it</span>.</p>

<p class="author1">However, I’ve also come across codebases that swing the pendulum the other way: using no classes at all. This also affects maintainability; it is easy to break assumptions and have inconsistent data throughout. In Python, you should strive for a balance. Classes have a place in your codebase, but it is important to recognize their strengths and weaknesses. It’s time to really dig deep, cast aside your preconceptions, and learn how classes help you make more robust code.</p>






</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 10. User-Defined Types: Classes" class="preface">
<div class="preface" id="classes">
<section data-type="sect1" data-pdf-bookmark="Class Anatomy" class="preface"><div class="preface" id="idm45644740941032">
<h1 class="calibre12" id="calibre_pb_1">Class Anatomy</h1>

<p class="author1">Classes are intended to be another way of grouping related data together. They have decades of history in the object-oriented paradigm and, at first glance, don’t differ that much from what you learned about data classes. In fact, you can write a class just like you wrote a <code class="calibre17">dataclass</code>:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="k">class</code> <code class="nc">Person</code><code class="calibre17">:</code>
    <code class="n">name</code><code class="calibre17">:</code> <code class="nb">str</code> <code class="calibre17">=</code> <code class="s">""</code>
    <code class="n">years_experience</code><code class="calibre17">:</code> <code class="nb">int</code> <code class="calibre17">=</code> <code class="mi">0</code>
    <code class="n">address</code><code class="calibre17">:</code> <code class="nb">str</code> <code class="calibre17">=</code> <code class="s">""</code>

<code class="n">pat</code> <code class="calibre17">=</code> <code class="n">Person</code><code class="calibre17">()</code>
<code class="n">pat</code><code class="calibre17">.</code><code class="n">name</code> <code class="calibre17">=</code> <code class="s">"Pat"</code>
<code class="k">print</code><code class="calibre17">(</code><code class="n">f</code><code class="s">"Hello {pat.name}"</code><code class="calibre17">)</code></pre>

<p class="author1">Looking at the code above, you could easily write it a different way with a <code class="calibre17">dict</code> or <code class="calibre17">dataclass</code>:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="n">pat</code> <code class="calibre17">=</code> <code class="calibre17">{</code>
    <code class="s">"name"</code><code class="calibre17">:</code> <code class="s">""</code><code class="calibre17">,</code>
    <code class="s">"years_experience"</code><code class="calibre17">:</code> <code class="mi">0</code><code class="calibre17">,</code>
    <code class="s">"address"</code><code class="calibre17">:</code> <code class="s">""</code>
<code class="calibre17">}</code>

<code class="nd">@dataclass</code>
<code class="k">class</code> <code class="nc">Person</code><code class="calibre17">():</code>
    <code class="n">name</code><code class="calibre17">:</code> <code class="nb">str</code> <code class="calibre17">=</code> <code class="s">""</code>
    <code class="n">years_experience</code><code class="calibre17">:</code> <code class="nb">int</code> <code class="calibre17">=</code> <code class="mi">0</code>
    <code class="n">address</code><code class="calibre17">:</code> <code class="nb">str</code> <code class="calibre17">=</code> <code class="s">""</code></pre>

<p class="author1">In <a data-type="xref" href="part0013_split_000.html#dataclasses" class="calibre5">Chapter 9</a>, you learned the advantages of data classes over raw dictionaries, and classes offer many of the same benefits. But you might (rightly) wonder why you would ever use a class instead of a data class again?</p>

<p class="author1">In fact, given the flexibility and convenvenience of data classes, classes might feel inferior. You don’t get the fancy features like <code class="calibre17">frozen</code> or <code class="calibre17">ordered</code>. You don’t get built-in string methods. Why, you can’t even instantiate a <code class="calibre17">Person</code> as nicely as with data classes.</p>

<p class="author1">Try to do something like:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="n">pat</code> <code class="calibre17">=</code> <code class="n">Person</code><code class="calibre17">(</code><code class="s">"Pat"</code><code class="calibre17">,</code> <code class="mi">13</code><code class="calibre17">,</code> <code class="s">"123 Fake St."</code><code class="calibre17">)</code></pre>

<p class="author1">When trying this with a class, you’ll be immediately greeted with an error:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="ne">TypeError</code><code class="calibre17">:</code> <code class="n">Person</code><code class="calibre17">()</code> <code class="n">takes</code> <code class="n">no</code> <code class="n">arguments</code></pre>

<p class="author1">That’s really frustrating, at first glance. However, this design decision is intentional. You need to explicitly define how a class gets constructed, which is done through <a data-type="indexterm" data-primary="constructors" id="idm45644740788104" class="calibre5"/>a special method called a <em class="calibre6">constructor</em>. It may seem like a drawback compared to data classes, but it allows you to have more fine-grained control over the fields in your class. The next few sections will describe how you can use this control to your benefit. First, let’s look at what the constructor of a class actually provides you.</p>








</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 10. User-Defined Types: Classes" class="preface">
<div class="preface" id="classes">
<section data-type="sect1" data-pdf-bookmark="Class Anatomy" class="preface">
<div class="preface" id="idm45644740941032">
<section data-type="sect2" data-pdf-bookmark="Constructors" class="preface"><div class="preface" id="idm45644740786536">
<h2 class="calibre34" id="calibre_pb_2">Constructors</h2>

<p class="author1">A constructor describes how to initialize your class.<a data-type="indexterm" data-primary="classes" data-secondary="constructors" id="idm45644740779608" class="calibre5"/> You define a constructor with an <code class="calibre17">__init__</code> method:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="k">class</code> <code class="nc">Person</code><code class="calibre17">:</code>
    <code class="k">def</code> <code class="calibre17">__init__</code><code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">,</code>
                  <code class="n">name</code><code class="calibre17">:</code> <code class="nb">str</code><code class="calibre17">,</code>
                  <code class="n">years_experience</code><code class="calibre17">:</code> <code class="nb">int</code><code class="calibre17">,</code>
                  <code class="n">address</code><code class="calibre17">:</code> <code class="nb">str</code><code class="calibre17">):</code>
        <code class="nb">self</code><code class="calibre17">.</code><code class="n">name</code> <code class="calibre17">=</code> <code class="n">name</code>
        <code class="nb">self</code><code class="calibre17">.</code><code class="n">years_experience</code> <code class="calibre17">=</code> <code class="n">years_experience</code>
        <code class="nb">self</code><code class="calibre17">.</code><code class="n">address</code> <code class="calibre17">=</code> <code class="n">address</code>

<code class="n">pat</code> <code class="calibre17">=</code> <code class="n">Person</code><code class="calibre17">(</code><code class="s">"Pat"</code><code class="calibre17">,</code> <code class="mi">13</code><code class="calibre17">,</code> <code class="s">"123 Fake St."</code><code class="calibre17">)</code></pre>

<p class="author1">Notice that I tweaked the class a bit. Instead of defining the variables like I did in a <code class="calibre17">dataclass</code>, I am defining all the variables in a constructor. The constructor is a special method that gets called when class is instantiated.  It takes arguments needed to define your user data type, as well as a special argument called <code class="calibre17">self</code>.<a data-type="indexterm" data-primary="self argument in class instantiations" id="idm45644740646744" class="calibre5"/> The specific name for this parameter is arbitrary, but you’ll see most code use <code class="calibre17">self</code> as the convention. Each time you instantiate a class, the <code class="calibre17">self</code> argument refers to that specific instance; one instance’s attributes won’t conflict with another instance’s attributes, even though they are the same class.<a data-type="indexterm" data-primary="attributes" data-secondary="self argument and" id="idm45644740645032" class="calibre5"/></p>

<p class="author1">So why would you ever write a class?<a data-type="indexterm" data-primary="classes" data-secondary="advantage over data classes and dictionaries" id="idm45644740643800" class="calibre5"/><a data-type="indexterm" data-primary="dictionaries" data-secondary="classes versus" id="idm45644740642840" class="calibre5"/><a data-type="indexterm" data-primary="data classes" data-secondary="classes versus" id="idm45644740641896" class="calibre5"/> Dictionaries or data classes are simpler to write and involve less ceremony. For something like the <code class="calibre17">Person</code> object listed earlier, I don’t disagree. However, a class can convey one key thing that a dictionary or data class can’t easily convey: <em class="calibre6">invariants</em>.</p>
</div></section>





</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 10. User-Defined Types: Classes" class="preface">
<div class="preface" id="classes">
<section data-type="sect1" data-pdf-bookmark="Invariants" class="preface"><div class="preface" id="idm45644740940408">
<h1 class="calibre12" id="calibre_pb_3">Invariants</h1>

<p class="author1">An invariant is a property of an entity that remains unchanged throughout the lifetime of that entity.<a data-type="indexterm" data-primary="classes" data-secondary="invariants" id="ix_clssinv" class="calibre5"/><a data-type="indexterm" data-primary="invariants" id="ix_invar" class="calibre5"/> Invariants are the concepts that hold true about your code. Readers and writers of code will reason about your code and depend upon that reasoning to keep everything straight. Invariants are the building blocks for understanding your codebase. Here are some examples of invariants:</p>

<ul class="printings">
<li class="calibre9">
<p class="author1">Every employee has a unique ID; no two employee IDs are duplicated.</p>
</li>
<li class="calibre9">
<p class="author1">Enemies in a game may only take actions if their health points are above zero.</p>
</li>
<li class="calibre9">
<p class="author1">Circles may only have a positive radius.</p>
</li>
<li class="calibre9">
<p class="author1">Pizzas will always have cheese on top of sauce.</p>
</li>
</ul>

<p class="author1">Invariants convey immutable properties of objects.<a data-type="indexterm" data-primary="immutability" data-seealso="invariants" id="idm45644740630936" class="calibre5"/> They can reflect mathematical properties, business rules, coordination guarantees, or anything else you want to hold true. Invariants do not have to mirror the real world; they just have to be true for <em class="calibre6">your</em> system. For instance, Chicago-style deep-dish pizza aficionados may disagree with that last pizza-related bullet, but if your system only handles cheese-on-sauce pizzas, it’s OK to encode that as an invariant. The invariant only refers to a specific entity, too. You get to decide the scope of the invariant, whether it is true across your system, or whether it only applies to a specific program, module, or class. This chapter will focus on classes and their role in <em class="calibre6">preserving</em> invariants.</p>

<p class="author1">So, how does a class help convey invariants?<a data-type="indexterm" data-primary="assertions" data-secondary="conveying invariants in classes" id="idm45644740627800" class="calibre5"/> Let’s start with the constructor. You can put in safeguards and assertions to check that an invariant is satisfied, and from that point on, a user of that class should be able to depend on that invariant being true for the lifetime of the class. Let’s see how.</p>

<p class="author1">Consider an imaginary automated pizza maker that makes a perfect pizza every time. It will take dough, roll it into a circle, apply sauce and toppings, and then bake the pizza. I will list out some invariants that I want to preserve in my system (these invariants are not universally true about all pizzas in the world, just true for the pizzas I want to create).</p>

<p class="author1">I want the following to hold true for the lifetime of the pizza:</p>

<ul class="printings">
<li class="calibre9">
<p class="author1">Sauce will never be put on top of toppings (cheese is a topping in this scenario).</p>
</li>
<li class="calibre9">
<p class="author1">Toppings may go above or below cheese.</p>
</li>
<li class="calibre9">
<p class="author1">Pizza will have at most only one sauce.</p>
</li>
<li class="calibre9">
<p class="author1">Dough radius can be only whole numbers.</p>
</li>
<li class="calibre9">
<p class="author1">The radius of dough may be only between 6 and 12 inches, inclusive (between 15 and 30 centimeters).</p>
</li>
</ul>

<p class="author1">Some of these might be for business reasons, some might be for health reasons, and some might be just limitations of machinery, but every one of these is intended to be true for the lifetime of that pizza. I’ll check for these invariants during construction of the pizza.</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="k">from</code> <code class="nn">pizza.sauces</code> <code class="k">import</code> <code class="n">is_sauce</code>
<code class="k">class</code> <code class="nc">PizzaSpecification</code><code class="calibre17">:</code>
    <code class="k">def</code> <code class="calibre17">__init__</code><code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">,</code>
                  <code class="n">dough_radius_in_inches</code><code class="calibre17">:</code> <code class="nb">int</code><code class="calibre17">,</code>
                  <code class="n">toppings</code><code class="calibre17">:</code> <code class="nb">list</code><code class="calibre17">[</code><code class="nb">str</code><code class="calibre17">]):</code>
        <code class="k">assert</code> <code class="mi">6</code> <code class="calibre17">&lt;=</code> <code class="n">dough_radius_in_inches</code> <code class="calibre17">&lt;=</code> <code class="mi">12</code><code class="calibre17">,</code> \
            <code class="s">'Dough must be between 6 and 12 inches'</code>
        <code class="n">sauces</code> <code class="calibre17">=</code> <code class="calibre17">[</code><code class="n">t</code> <code class="k">for</code> <code class="n">t</code> <code class="calibre19">in</code> <code class="n">toppings</code> <code class="k">if</code> <code class="n">is_sauce</code><code class="calibre17">(</code><code class="n">t</code><code class="calibre17">)]</code>
        <code class="k">assert</code> <code class="nb">len</code><code class="calibre17">(</code><code class="n">sauces</code><code class="calibre17">)</code> <code class="calibre17">&lt;</code> <code class="mi">2</code><code class="calibre17">,</code> \
            <code class="s">'Can only have at most one sauce'</code>

        <code class="nb">self</code><code class="calibre17">.</code><code class="n">dough_radius_in_inches</code> <code class="calibre17">=</code> <code class="n">dough_radius_in_inches</code>
        <code class="n">sauce</code> <code class="calibre17">=</code> <code class="n">sauces</code><code class="calibre17">[:</code><code class="mi">1</code><code class="calibre17">]</code>
        <code class="nb">self</code><code class="calibre17">.</code><code class="n">toppings</code> <code class="calibre17">=</code> <code class="n">sauce</code> <code class="calibre17">+</code> \
            <code class="calibre17">[</code><code class="n">t</code> <code class="k">for</code> <code class="n">t</code> <code class="calibre19">in</code> <code class="n">toppings</code> <code class="k">if</code> <code class="calibre19">not</code> <code class="n">is_sauce</code><code class="calibre17">(</code><code class="n">t</code><code class="calibre17">)]</code></pre>

<p class="author1">Let’s break down this<a data-type="indexterm" data-primary="classes" data-secondary="invariants" data-tertiary="checking" id="idm45644740616808" class="calibre5"/><a data-type="indexterm" data-primary="invariants" data-secondary="checking" id="idm45644740514792" class="calibre5"/> invariant checking:</p>

<ul class="printings">
<li class="calibre9">
<p class="author1"><code class="calibre17">dough_radius_in_inches</code> is an integer. This doesn’t stop callers from passing floats/strings/whatever into the constructor, but if used in conjunction with a typechecker (like those you used in <a data-type="xref" href="part0004.html#part_1" class="calibre5">Part I</a>), you can detect when callers pass the wrong type. If you aren’t using a typechecker, you would have to do an <span class="calibre"><code class="calibre17">isinstance()</code></span> check (or something similar) instead.</p>
</li>
<li class="calibre9">
<p class="author1">This code asserts that the dough radius is between 6 and 12 inches (inclusive). If this is not the case, an <code class="calibre17">AssertionError</code> is thrown (preventing construction of the class).</p>
</li>
<li class="calibre9">
<p class="author1">This code asserts that there is at most one sauce, throwing an <code class="calibre17">AssertionError</code> if that does not hold true.</p>
</li>
<li class="calibre9">
<p class="author1">This code ensures that the sauce is at the beginning of our toppings list (presumably this will be used to tell the pizza maker in what order to lay toppings down).</p>
</li>
<li class="calibre9">
<p class="author1">Note that I don’t explicitly do anything to preserve that toppings can be above or below cheese. This is because the default behavior of the implementation satisfies the invariant. However, you may still choose to communicate the invariant to your callers through documentation.</p>
</li>
</ul>
<aside data-type="sidebar" epub:type="sidebar" class="calibre32"><div class="sidebar" id="idm45644740505096">
<h5 class="calibre33">Assertions Versus Exceptions</h5>
<p class="author1">Throughout this book, I will use assertions in some cases, and raise exceptions in other cases.<a data-type="indexterm" data-primary="assertions" data-secondary="versus exceptions" data-secondary-sortas="exceptions" id="idm45644740503400" class="calibre5"/><a data-type="indexterm" data-primary="exceptions" data-secondary="assertions versus" id="idm45644740502152" class="calibre5"/> When an assertion fails, it raises an <code class="calibre17">AssertionError</code>, which is a type of exception. This may make assertions and exceptions seem interchangeable, but I am actually picking one or the other intentionally.</p>

<p class="author1">Assertions are not guaranteed to execute at runtime, as your code may be deployed with options that disable assertions. In this case, I use them for things that I always expect to be true, unless a developer in the system messes up. It is intended to catch mistakes during development, and it signals to other developers that it is up to them to not create a situation that fails an assertion.</p>

<p class="author1">Exceptions, on the other hand, indicate to a developer that something may be possible due to user error or malicious actors. It is unlikely to happen, but other developers must be prepared to catch the exception if something goes wrong.</p>

<p class="author1">If the error is not an exceptional use case, I may choose to return an <code class="calibre17">Optional</code> or <code class="calibre17">Union</code> instead (see <a data-type="xref" href="part0007_split_000.html#constraints" class="calibre5">Chapter 4</a> for more information). Note that this only applies if the function returns a value. The constructors in this chapter do not return any values, so using an <code class="calibre17">Optional</code> or <code class="calibre17">Union</code> is inappropriate. In these cases, make it crystal clear to future developers that an exception (or assertion) can be thrown, because the typechecker will not be much help.</p>
</div></aside>








</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 10. User-Defined Types: Classes" class="preface">
<div class="preface" id="classes">
<section data-type="sect1" data-pdf-bookmark="Invariants" class="preface">
<div class="preface" id="idm45644740940408">
<section data-type="sect2" data-pdf-bookmark="Avoiding Broken Invariants" class="preface"><div class="preface" id="idm45644740495416">
<h2 class="calibre34" id="calibre_pb_4">Avoiding Broken Invariants</h2>

<p class="author1">It is incredibly important that you never, ever construct this class if the invariants would be broken. <a data-type="indexterm" data-primary="invariants" data-secondary="avoiding broken invariants" id="idm45644740494056" class="calibre5"/><a data-type="indexterm" data-primary="classes" data-secondary="invariants" data-tertiary="avoiding broken invariants" id="idm45644740493016" class="calibre5"/>You have two avenues that you can choose if the caller ever constructs an object in a way such that invariants would be broken.</p>
<dl class="calibre13">
<dt class="calibre14">Throw an exception</dt>
<dd class="calibre15">
<p class="calibre16">This prevents the object from being constructed.<a data-type="indexterm" data-primary="exceptions" data-secondary="throwing to avoid broken invariants" id="idm45644740489976" class="calibre5"/> This is what I did when making sure the dough radius was appropriate and that I had at most one sauce.</p>
</dd>
<dt class="calibre14">Massage the data</dt>
<dd class="calibre15">
<p class="calibre16">Make the data conform to the invariant. I could have thrown an exception when I didn’t get toppings in the right order, but instead, I rearranged them to satisfy the invariant.<a data-type="indexterm" data-primary="massaging data to avoid broken invariants" id="idm45644740487272" class="calibre5"/></p>
</dd>
</dl>
<aside data-type="sidebar" epub:type="sidebar" class="calibre32"><div class="sidebar" id="idm45644740486088">
<h5 class="calibre33">What If You Don’t Want Exceptions?</h5>
<p class="author1">If you don’t want to use exceptions, you can use a function to create your class instead (also known as a factory method).<a data-type="indexterm" data-primary="exceptions" data-secondary="avoiding use of with broken variants" id="idm45644740484456" class="calibre5"/><a data-type="indexterm" data-primary="underscores" data-secondary="hiding classes from help" id="idm45644740483464" class="calibre5"/> You can hide your class from <code class="calibre17">help()</code> by preceding the class with an underscore (<code class="calibre17">_</code>), and then create a function in your module that checks invariants and instantiates the class. <a data-type="indexterm" data-primary="None values" data-secondary="returning for unsatisfiable invariants" id="idm45644740481464" class="calibre5"/>If the invariants are not satisfiable, you can return <code class="calibre17">None</code>. Make sure you are using <code class="calibre17">Optional</code> types (as covered in <a data-type="xref" href="part0007_split_000.html#constraints" class="calibre5">Chapter 4</a>) to represent <code class="calibre17">None</code>.</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="c"># Note to maintainers, only create this through create_pizza_spec function</code>
<code class="k">class</code> <code class="nc">_PizzaSpecification</code><code class="o">:</code>
    <code class="c"># ... snip class</code>

<code class="k">def</code> <code class="nf">create_pizza_spec</code><code class="o">(</code><code class="n">dough_radius_in_inches</code><code class="o">:</code> <code class="nb">int</code><code class="o">,</code>
                      <code class="n">toppings</code><code class="o">:</code> <code class="nb">list</code><code class="o">[</code><code class="nb">str</code><code class="o">])</code> <code class="o">-&gt;</code> <code class="n">Optional</code><code class="o">[</code><code class="n">_PizzaSpecification</code><code class="o">]:</code>
    <code class="k">try</code><code class="o">:</code>
        <code class="k">return</code> <code class="n">_PizzaSpecification</code><code class="o">()</code>
    <code class="k">except</code><code class="o">:</code>
        <code class="k">return</code> <code class="nb">None</code></pre>

<p class="author1">If you really want to, you can move your invariant checking to the function itself, but at that point, you are dealing with an invariant-less type and you should be using a data class. If you are more accustomed to functional programming paradigms, and will be keeping most of your classes immutable, then this is less of an issue.</p>
</div></aside>
</div></section>













</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 10. User-Defined Types: Classes" class="preface">
<div class="preface" id="classes">
<section data-type="sect1" data-pdf-bookmark="Invariants" class="preface">
<div class="preface" id="idm45644740940408">
<section data-type="sect2" data-pdf-bookmark="Why Are Invariants Beneficial?" class="preface"><div class="preface" id="idm45644740393144">
<h2 class="calibre34" id="calibre_pb_5">Why Are Invariants Beneficial?</h2>

<p class="author1">It is a lot of work to write a class and come up with invariants.<a data-type="indexterm" data-primary="classes" data-secondary="invariants" data-tertiary="benefits of" id="ix_clssinvben" class="calibre5"/><a data-type="indexterm" data-primary="invariants" data-secondary="benefits of" id="ix_invarbene" class="calibre5"/> But I want you to <span class="calibre">consciously</span> think about invariants every time you group some data together. Ask <span class="calibre">yourself</span>:</p>

<ul class="printings">
<li class="calibre9">
<p class="author1">Should any of this data be restricted in any form that I can’t catch through the type system (such as the order of toppings)?</p>
</li>
<li class="calibre9">
<p class="author1">Are some fields interdependent (i.e., changing one field may necessitate a change in another field)?</p>
</li>
<li class="calibre9">
<p class="author1">Are there guarantees I want to provide about the data?</p>
</li>
</ul>

<p class="author1">If you answer yes to any of these questions, you have invariants you want to preserve and should write a class. When you choose to write a class and define a set of invariants, you’re doing a few things:</p>
<ol class="calibre30">
<li value="1" class="calibre31">
<p class="author1">You’re adhering <a data-type="indexterm" data-primary="Don't Repeat Yourself (DRY) principle" id="idm45644740382248" class="calibre5"/>to the Don’t Repeat Yourself (DRY) principle.<sup class="calibre11"><a data-type="noteref" id="idm45644740381352-marker" href="part0014_split_014.html#idm45644740381352" class="calibre5">1</a></sup> Instead of littering your code with checks before object construction, you put those checks in one place.</p>
</li>
<li value="2" class="calibre31">
<p class="author1">You’re putting more work on the writer to ease the work of the reader/maintainer/caller. Your code will most likely live longer than you work on it. By providing an invariant (and communicating it well—see the next section), you lessen the burden of those who come after you.</p>
</li>
<li value="3" class="calibre31">
<p class="author1">You’re more effectively able to reason about code. There’s a reason why languages like <a href="https://www.adacore.com/about-ada" class="calibre5">Ada</a> and concepts like formal proofs are used in mission-critical environments. They provide developers with comfort; other coders can trust your code to a certain degree.</p>
</li>

</ol>

<p class="author1">All of this leads to fewer bugs. You’re not running the risk of people misconstructing objects or missing a required check. You’re making an easier API for people to think about, and you reduce the risk of people using your objects incorrectly. You will also adhere closer to the Law of Least Surprise. You never want someone to be surprised when using your code (how many times have you heard the phrase, “Wait, <em class="calibre6">that’s</em> how the class works?”). By defining invariants and sticking to them, there is less chance for someone to be surprised.</p>

<p class="author1">A dictionary simply cannot do that.</p>

<p class="author1">Consider a pizza specification represented by a dictionary:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="calibre17">{</code>
    <code class="s">"dough_radius_in_inches"</code><code class="calibre17">:</code> <code class="mi">7</code>
    <code class="s">"toppings"</code><code class="calibre17">:</code> <code class="calibre17">[</code><code class="s">"tomato sauce"</code><code class="calibre17">,</code> <code class="s">"mozzarella"</code><code class="calibre17">,</code> <code class="s">"pepperoni"</code><code class="calibre17">]</code>
<code class="calibre17">}</code></pre>

<p class="author1">There is no simple way for you to force a user to construct this dictionary correctly. You would have to rely on callers doing the right thing in every invocation (which will only become more difficult as the codebase grows). There is also no way to prevent users from modifying the dictionary freely and breaking invariants.</p>
<div data-type="note" epub:type="note" class="calibre21"><h6 class="calibre22">Note</h6>
<p class="author1">It’s true, you could define methods that construct dictionaries after checking invariants, and only mutate the dictionary through functions that also check invariants. Or, you could certainly write a constructor and invariant-checking methods on data classes. But if you go through all that trouble, why not write a class? Be mindful of what your choices communicate to future maintainers. You must be deliberate between your choice of dictionaries, data classes and classes. Each of these abstractions conveys a very specific meaning, and if you choose the wrong one, you’ll confuse maintainers.</p>
</div>

<p class="author1">There’s another benefit that I haven’t talked about, and it relates to the “S” in SOLID (see the next sidebar): the Single Responsibility Principle.<a data-type="indexterm" data-primary="Single Responsibility Principle" id="idm45644740366888" class="calibre5"/> The Single Responsibility Principle states that each object “should have one and only one reason to change.”<sup class="calibre11"><a data-type="noteref" id="idm45644740365960-marker" href="part0014_split_014.html#idm45644740365960" class="calibre5">2</a></sup> It sounds simple, but in practice it can be a struggle to know exactly how granular <em class="calibre6">one</em> reason to change is. My suggestion to you is to define a set of related invariants (such as your dough and toppings) and write a class per set of related invariants.<a data-type="indexterm" data-primary="cohesion (in classes)" id="idm45644740363176" class="calibre5"/><a data-type="indexterm" data-primary="attributes" id="idm45644740362472" class="calibre5"/> If you ever find yourself writing attributes or methods that do not directly relate to one of those invariants, your class has low <em class="calibre6">cohesion</em>, which means it has too many responsibilities.</p>
<aside data-type="sidebar" epub:type="sidebar" class="calibre32"><div class="sidebar" id="idm45644740333080">
<h5 class="calibre33">SOLID Design Principles</h5>
<p class="author1">The SOLID design principles were first<a data-type="indexterm" data-primary="SOLID design principles" id="idm45644740331752" class="calibre5"/> described by Robert C. Martin in his 2000 paper, <a href="https://oreil.ly/GvwUz" class="calibre5">“Design Principles and Design Patterns”</a>. They are five design principles that I have found very useful when developing in larger codebases. The SOLID design principles are as follows:</p>
<dl class="calibre13">
<dt class="calibre14">Single Responsibility Principle</dt>
<dd class="calibre15">
<p class="calibre16">A principle for reuse and consolidation of code<a data-type="indexterm" data-primary="Open-Closed Principle (OCP)" id="idm45644740328088" class="calibre5"/></p>
</dd>
<dt class="calibre14">Open-Closed Principle</dt>
<dd class="calibre15">
<p class="calibre16">A principle for extensibility<a data-type="indexterm" data-primary="Liskov Substitution Principle" id="idm45644740326088" class="calibre5"/><a data-type="indexterm" data-primary="Interface Segregation Principle" id="idm45644740325320" class="calibre5"/><a data-type="indexterm" data-primary="Dependency Inversion Principle" id="idm45644740324632" class="calibre5"/></p>
</dd>
<dt class="calibre14">Liskov Substitution Principle</dt>
<dd class="calibre15">
<p class="calibre16">A principle for subtyping</p>
</dd>
<dt class="calibre14">Interface Segregation Principle</dt>
<dd class="calibre15">
<p class="calibre16">A principle for abstraction</p>
</dd>
<dt class="calibre14">Dependency Inversion Principle</dt>
<dd class="calibre15">
<p class="calibre16">A principle for decoupling dependencies</p>
</dd>
</dl>

<p class="author1">Some of these principles will be touched upon throughout the book. Remember that all of these are just principles. Use your best judgment in applying them.</p>
</div></aside>
</div></section>













</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 10. User-Defined Types: Classes" class="preface">
<div class="preface" id="classes">
<section data-type="sect1" data-pdf-bookmark="Invariants" class="preface">
<div class="preface" id="idm45644740940408">
<section data-type="sect2" data-pdf-bookmark="Why Are Invariants Beneficial?" class="preface">
<div class="preface" id="idm45644740393144">
<div data-type="note" epub:type="note" class="calibre21"><h1 class="calibre38" id="calibre_pb_6">Discussion Topic</h1>
<p class="author1">Consider some of the most important parts of your codebase. What invariants are true about that system? How well are these invariants enforced, such that developers cannot break them?<a data-type="indexterm" data-primary="classes" data-secondary="invariants" data-tertiary="benefits of" data-startref="ix_clssinvben" id="idm45644740317720" class="calibre5"/><a data-type="indexterm" data-primary="invariants" data-secondary="benefits of" data-startref="ix_invarbene" id="idm45644740292680" class="calibre5"/></p>
</div>
</div></section>













</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 10. User-Defined Types: Classes" class="preface">
<div class="preface" id="classes">
<section data-type="sect1" data-pdf-bookmark="Invariants" class="preface">
<div class="preface" id="idm45644740940408">
<section data-type="sect2" data-pdf-bookmark="Communicating Invariants" class="preface"><div class="preface" id="idm45644740392552">
<h2 class="calibre34" id="calibre_pb_7">Communicating Invariants</h2>

<p class="author1">Now, you can’t realize these benefits unless you can effectively communicate them.<a data-type="indexterm" data-primary="classes" data-secondary="invariants" data-tertiary="communicating" id="idm45644740290296" class="calibre5"/><a data-type="indexterm" data-primary="invariants" data-secondary="communicating" id="idm45644740289048" class="calibre5"/> Nobody can reason about invariants that they don’t know about. So, how do you do that? Well, with any communication, you should consider your audience. You have two types of people with two different use cases:</p>
<dl class="calibre13">
<dt class="calibre14">Consumers of the class</dt>
<dd class="calibre15">
<p class="calibre16">These are people who are trying to solve their own problems and are looking for tools to help them. They may be trying to debug an issue or find a class in a codebase that helps them out.</p>
</dd>
<dt class="calibre14">Future maintainers of the class</dt>
<dd class="calibre15">
<p class="calibre16">People will add onto your class, and it’s important that they do not break invariants that all your callers have come to depend on.</p>
</dd>
</dl>

<p class="author1">You will need to keep both in mind when desigining your classes.</p>
</div></section>













</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 10. User-Defined Types: Classes" class="preface">
<div class="preface" id="classes">
<section data-type="sect1" data-pdf-bookmark="Invariants" class="preface">
<div class="preface" id="idm45644740940408">
<section data-type="sect2" data-pdf-bookmark="Consuming Your Class" class="preface"><div class="preface" id="idm45644740283672">
<h2 class="calibre34" id="calibre_pb_8">Consuming Your Class</h2>

<p class="author1">First, consumers of your class will typically look at your source code to see how it works and if it meets their needs.<a data-type="indexterm" data-primary="classes" data-secondary="invariants" data-tertiary="consuming your class" id="idm45644740282040" class="calibre5"/><a data-type="indexterm" data-primary="invariants" data-secondary="consuming your class" id="idm45644740280792" class="calibre5"/> Putting assertion statements (or raising other exceptions) in the constructor is a great way to tell a user what is and isn’t possible with your class.<a data-type="indexterm" data-primary="constructors" data-secondary="assertions  or raising exceptions in" id="idm45644740279544" class="calibre5"/> A constructor is typically the first place a developer will look (after all, if they can’t instantiate your class, how can they use it?). For invariants that you cannot represent in code (yes, those exist), you want to document that in whatever your users use for API reference.<a data-type="indexterm" data-primary="documentation" data-secondary="for invariants not expressible in code" id="idm45644740278104" class="calibre5"/> The closer to the code your documentation is, the more likely a user will find it when looking at your code.</p>

<p class="author1">Knowledge in one’s head is not scalable or discoverable. Wikis and/or documentation portals are a decent step, but often are better suited for larger scale ideas that don’t go out of date as quickly. A README in the code repository is a better step, but the true best place is a comment or docstring with the class itself.<a data-type="indexterm" data-primary="comments, placing with classes" id="idm45644740276168" class="calibre5"/></p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="k">class</code> <code class="nc">PizzaSpecification</code><code class="calibre17">:</code>
    <code class="sd">"""</code>
<code class="sd">    This class represents a Pizza Specification for use in</code>
<code class="sd">    Automated Pizza Machines.</code>

<code class="sd">    The pizza specification is defined by the size of the dough and</code>
<code class="sd">    the toppings. Dough should be a whole number between 6 and 12</code>
<code class="sd">    inches (inclusive). If anything else is passed in, an AssertionError</code>
<code class="sd">    is thrown. The machinery cannot handle less than 6 inches and the</code>
<code class="sd">    business case is too costly for more than 12 inches.</code>

<code class="sd">    Toppings may have at most one sauce, but you may pass in toppings</code>
<code class="sd">    in any order. If there is more than one sauce, an AssertionError is</code>
<code class="sd">    thrown. This is done based on our research telling us that</code>
<code class="sd">    consumers find two-sauced pizzas do not taste good.</code>

<code class="sd">    This class will make sure that sauce is always the first topping,</code>
<code class="sd">    regardless of order passed in.</code>

<code class="sd">    Toppings are allowed to go above and below cheese</code>
<code class="sd">    (the order of non-sauce toppings matters).</code>

<code class="sd">    """</code>
    <code class="k">def</code> <code class="calibre17">__init__</code><code class="calibre17">(</code><code class="calibre17">...</code><code class="calibre17">)</code>
        <code class="c"># ... implementation goes here</code></pre>

<p class="author1">I’ve had a bit of a contentious relationship with comments throughout my career. In the beginning, I would comment everything, probably because my university professors required it. A few years later, the pendulum swung too far in the other direction, and I was one to espouse “code shall be self-documenting,” meaning that the code should be able to stand on its own. After all, comments could go out of date and, as the common saying goes, “a wrong comment is worse than no comment.” The pendulum has since<a data-type="indexterm" data-primary="documentation" data-secondary="self-documenting code" id="idm45644740242040" class="calibre5"/> shifted back and I’ve learned that code should absolutely self-document <em class="calibre6">what</em> it’s doing (this is just another spin on the Law of Least Surprise), but comments help the human nature of code. Most people simplify this to <em class="calibre6">why</em> the code behaves it does, but sometimes that is vague. In the snippet above, I go about it by documenting my invariants (including ones not apparent in code), and backing it up with business reasons. This way, a consumer can ascertain what the class is and isn’t used for, as well as whether the class fits into their intended use case.</p>
</div></section>













</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 10. User-Defined Types: Classes" class="preface">
<div class="preface" id="classes">
<section data-type="sect1" data-pdf-bookmark="Invariants" class="preface">
<div class="preface" id="idm45644740940408">
<section data-type="sect2" data-pdf-bookmark="What About Maintainers?" class="preface"><div class="preface" id="idm45644740269256">
<h2 class="calibre34" id="calibre_pb_9">What About Maintainers?</h2>

<p class="author1">You will have to deal with the other group, the future maintainers of your code, differently. This is a tricky one.<a data-type="indexterm" data-primary="classes" data-secondary="invariants" data-tertiary="future maintainers and" id="idm45644740238536" class="calibre5"/><a data-type="indexterm" data-primary="invariants" data-secondary="future code maintainers and" id="idm45644740237288" class="calibre5"/><a data-type="indexterm" data-primary="maintainable code" data-secondary="invariants and future maintainers" id="idm45644740236328" class="calibre5"/> You have a comment that helps define your constraints, but that won’t prevent inadvertent changing of invariants. Changing invariants is a delicate thing. People will come to depend on these invariants, even if they aren’t reflected in function signatures or type systems. If somebody changes an invariant, every consumer of the class could be affected (sometimes this is inevitable, but be aware of the cost).</p>

<p class="author1">To help catch this, I’ll lean on an old friend as a safety net—unit tests. <a data-type="indexterm" data-primary="unit tests" id="idm45644740234200" class="calibre5"/>Unit tests are snippets of code that will automatically test your own classes and functions. (For more discussion on unit tests, check out <a data-type="xref" href="part0027_split_000.html#testing_strategy" class="calibre5">Chapter 21</a>.) You should absolutely write unit tests around your expectations and invariants, but there’s one additional facet I’d like you to consider: help future test writers know when invariants are broken as well.<a data-type="indexterm" data-primary="context managers" id="idm45644740232184" class="calibre5"/><a data-type="indexterm" data-primary="with blocks" id="idm45644740231512" class="calibre5"/> I like to do this with the help of a context manager—a construct in Python that forces code to run when a <code class="calibre17">with</code> block is exited (if you’re not familiar with context managers, you’ll learn more in <a data-type="xref" href="part0015_split_000.html#api" class="calibre5">Chapter 11</a>):</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="k">import</code> <code class="nn">contextlib</code>
<code class="k">from</code> <code class="nn">pizza_specification</code> <code class="k">import</code> <code class="n">PizzaSpecification</code>

<code class="nd">@contextlib.contetxtmanager</code>
<code class="k">def</code> <code class="nf">create_pizza_specification</code><code class="calibre17">(</code><code class="n">dough_radius_in_inches</code><code class="calibre17">:</code> <code class="nb">int</code><code class="calibre17">,</code>
                               <code class="n">toppings</code><code class="calibre17">:</code> <code class="nb">list</code><code class="calibre17">[</code><code class="nb">str</code><code class="calibre17">]):</code>
    <code class="n">pizza_spec</code> <code class="calibre17">=</code> <code class="n">PizzaSpecification</code><code class="calibre17">(</code><code class="n">dough_radius_in_inches</code><code class="calibre17">,</code> <code class="n">toppings</code><code class="calibre17">)</code>
    <code class="k">yield</code> <code class="n">pizza_spec</code>
    <code class="k">assert</code> <code class="mi">6</code> <code class="calibre17">&lt;=</code> <code class="n">pizza_spec</code><code class="calibre17">.</code><code class="n">dough_radius_in_inches</code> <code class="calibre17">&lt;=</code> <code class="mi">12</code>
    <code class="n">sauces</code> <code class="calibre17">=</code> <code class="calibre17">[</code><code class="n">t</code> <code class="k">for</code> <code class="n">t</code> <code class="calibre19">in</code> <code class="n">pizza_spec</code><code class="calibre17">.</code><code class="n">toppings</code> <code class="k">if</code> <code class="n">is_sauce</code><code class="calibre17">(</code><code class="n">t</code><code class="calibre17">)]</code>
    <code class="k">assert</code> <code class="nb">len</code><code class="calibre17">(</code><code class="n">sauces</code><code class="calibre17">)</code> <code class="calibre17">&lt;</code> <code class="mi">2</code>
    <code class="k">if</code> <code class="n">sauces</code><code class="calibre17">:</code>
        <code class="k">assert</code> <code class="n">pizza_spec</code><code class="calibre17">.</code><code class="n">toppings</code><code class="calibre17">[</code><code class="mi">0</code><code class="calibre17">]</code> <code class="calibre17">==</code> <code class="n">sauces</code><code class="calibre17">[</code><code class="mi">0</code><code class="calibre17">]</code>

    <code class="c"># check that we assert order of all non sauces</code>
    <code class="c"># keep in mind, no invariant is specified that we can't add</code>
    <code class="c"># toppings at a later date, so we only check against what was</code>
    <code class="c"># passed in</code>
    <code class="n">non_sauces</code> <code class="calibre17">=</code> <code class="calibre17">[</code><code class="n">t</code> <code class="k">for</code> <code class="n">t</code> <code class="calibre19">in</code> <code class="n">pizza_spec</code><code class="calibre17">.</code><code class="n">toppings</code> <code class="k">if</code> <code class="n">t</code> <code class="calibre19">not</code> <code class="calibre19">in</code> <code class="n">sauces</code><code class="calibre17">]</code>
    <code class="n">expected_non_sauces</code> <code class="calibre17">=</code> <code class="calibre17">[</code><code class="n">t</code> <code class="k">for</code> <code class="n">t</code> <code class="calibre19">in</code> <code class="n">toppings</code> <code class="k">if</code> <code class="n">t</code> <code class="calibre19">not</code> <code class="calibre19">in</code> <code class="n">sauces</code><code class="calibre17">]</code>
    <code class="k">for</code> <code class="n">expected</code><code class="calibre17">,</code> <code class="n">actual</code> <code class="calibre19">in</code> <code class="nb">zip</code><code class="calibre17">(</code><code class="n">expected_non_sauces</code><code class="calibre17">,</code> <code class="n">non_sauces</code><code class="calibre17">):</code>
        <code class="k">assert</code> <code class="n">expected</code> <code class="calibre17">==</code> <code class="n">actual</code>


<code class="k">def</code> <code class="nf">test_pizza_operations</code><code class="calibre17">():</code>
    <code class="k">with</code> <code class="n">create_pizza_specification</code><code class="calibre17">(</code><code class="mi">8</code><code class="calibre17">,</code> <code class="calibre17">[</code><code class="s">"Tomato Sauce"</code><code class="calibre17">,</code> <code class="s">"Peppers"</code><code class="calibre17">])</code> \
        <code class="k">as</code> <code class="n">pizza_spec</code><code class="calibre17">:</code>

        <code class="c"># do something with pizza_spec</code></pre>

<p class="author1">The beauty of using a context manager like this is that every invariant can be checked as a postcondition of the test. This feels like duplication and direct violation of the DRY principle, but in this case, it’s warranted. Unit tests are a form of double-entry bookkeeping, and you want them to find errors when one side erroneously changes.</p>
<aside data-type="sidebar" epub:type="sidebar" class="calibre32"><div class="sidebar" id="idm45644740226248">
<h5 class="calibre33">Is Invariant Checking Slow?</h5>
<p class="author1">There is a runtime cost to checking all these invariants, especially for more complex data types than a pizza.<a data-type="indexterm" data-primary="invariants" data-secondary="checking" data-tertiary="running too slow" id="idm45644740224936" class="calibre5"/> Checking invariants provides  a real benefit for making humans go faster, but for an object that is created multiple times in a tight loop, developers may want to eschew conditionals and/or exceptions in favor of code execution performance. If you’re in a case where your program is not meeting a benchmark, you’ve profiled the code, and the invariant checking is the biggest culprit, here’s what I want you to do:</p>

<p class="author1">Continue to document the invariants the class has, but convey through very explicit means that the onus is on callers to satisfy the invariants, not the class itself. The class should still try to maintain the invariants to help reasonability, but it can’t do as much precondition checking as you may like. You are deliberately, in essence, sacrificing maintainability for speed. It will be case by case just how much maintainability suffers and how much of a speedup you will receive. If you do choose this route, supplement other processes in your environment to make up for the decrease of maintainability (more robust linting, more stringent code reviews, etc.).<a data-type="indexterm" data-primary="classes" data-secondary="invariants" data-startref="ix_clssinv" id="idm45644740020728" class="calibre5"/><a data-type="indexterm" data-primary="invariants" data-startref="ix_invar" id="idm45644740019480" class="calibre5"/></p>
</div></aside>
</div></section>





</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 10. User-Defined Types: Classes" class="preface">
<div class="preface" id="classes">
<section data-type="sect1" data-pdf-bookmark="Encapsulation and Maintaining Invariants" class="preface"><div class="preface" id="idm45644740639160">
<h1 class="calibre12" id="calibre_pb_10">Encapsulation and Maintaining Invariants</h1>

<p class="author1">I have a little secret for you.<a data-type="indexterm" data-primary="classes" data-secondary="encapsulation and maintaining invariants" id="ix_clssenc" class="calibre5"/><a data-type="indexterm" data-primary="invariants" data-secondary="maintaining, encapsulation and" id="ix_invarmtn" class="calibre5"/> I wasn’t completely honest in the last section. I know, I know, shame on me, and I’m sure the eagle-eyed readers have already spotted my deception.</p>

<p class="author1">Consider this:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="n">pizza_spec</code> <code class="calibre17">=</code> <code class="n">PizzaSpecification</code><code class="calibre17">(</code><code class="n">dough_radius_in_inches</code><code class="calibre17">=</code><code class="mi">8</code><code class="calibre17">,</code>
                                <code class="n">toppings</code><code class="calibre17">=</code><code class="calibre17">[</code><code class="s">'Olive Oil'</code><code class="calibre17">,</code>
                                          <code class="s">'Garlic'</code><code class="calibre17">,</code>
                                          <code class="s">'Sliced Roma Tomatoes'</code><code class="calibre17">,</code>
                                          <code class="s">'Mozzarella'</code><code class="calibre17">])</code></pre>

<p class="author1">Nothing at all is preventing a future developer from changing some invariants after the fact.</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="n">pizza_spec</code><code class="calibre17">.</code><code class="n">dough_radius_in_inches</code> <code class="calibre17">=</code> <code class="mi">100</code>  <code class="c"># BAD!</code>
<code class="n">pizza_spec</code><code class="calibre17">.</code><code class="n">toppings</code><code class="calibre17">.</code><code class="n">append</code><code class="calibre17">(</code><code class="s">'Tomato Sauce'</code><code class="calibre17">)</code>  <code class="c"># Second sauce, oh no!</code></pre>

<p class="author1">What was the point of talking about invariants if any developer can immediately invalidate them? Well, it turns out that I have another concept to discuss: <em class="calibre6">encapsulation</em>.<a data-type="indexterm" data-primary="encapsulation" id="ix_encap" class="calibre5"/></p>








</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 10. User-Defined Types: Classes" class="preface">
<div class="preface" id="classes">
<section data-type="sect1" data-pdf-bookmark="Encapsulation and Maintaining Invariants" class="preface">
<div class="preface" id="idm45644740639160">
<section data-type="sect2" data-pdf-bookmark="Encapsul-what, Now?" class="preface"><div class="preface" id="idm45644739985016">
<h2 class="calibre34" id="calibre_pb_11">Encapsul-what, Now?</h2>

<p class="author1">Encapsulation. Simply put, it’s the ability for an entity to hide properties and the actions that operate upon those properties. Practically speaking, it means that you decide what properties are visible to callers, and restrict how they can access them and/or change data.<a data-type="indexterm" data-primary="APIs" data-secondary="encapsulation accomplished with" id="idm45644739983432" class="calibre5"/> This is accomplished using an <em class="calibre6">application programming interface</em> (API).</p>

<p class="author1">When most people think of an API, things like REST or SDKs (software development kits) come to mind. But every class has its own API. It’s the cornerstone of how you interact with classes. Every function call, every property access, every initialization is part of an object’s API.</p>

<p class="author1">So far, I’ve covered two parts of the API in the <code class="calibre17">PizzaSpecification</code>: the initialization (constructor) and property access. I don’t have much more to say about the constructor; its done its job in verifying invariants. Now, I will address how to preserve those invariants as you flesh out the rest of an API (the operations that we wish to bundle with this class).</p>
</div></section>













</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 10. User-Defined Types: Classes" class="preface">
<div class="preface" id="classes">
<section data-type="sect1" data-pdf-bookmark="Encapsulation and Maintaining Invariants" class="preface">
<div class="preface" id="idm45644740639160">
<section data-type="sect2" data-pdf-bookmark="Protecting Data Access" class="preface"><div class="preface" id="idm45644739979848">
<h2 class="calibre34" id="calibre_pb_12">Protecting Data Access</h2>

<p class="author1">That leads us back to the problem at the beginning of this section: how do we prevent users of our API (our class) from breaking invariants? By signaling that this data should be <em class="calibre6">private</em>.<a data-type="indexterm" data-primary="invariants" data-secondary="maintaining, encapsulation and" data-tertiary="protecting data access" id="idm45644739940328" class="calibre5"/><a data-type="indexterm" data-primary="classes" data-secondary="encapsulation and maintaining invariants" data-tertiary="protecting data access" id="idm45644739939080" class="calibre5"/><a data-type="indexterm" data-primary="data access, protecting for classes" id="idm45644739937896" class="calibre5"/><a data-type="indexterm" data-primary="private data" id="idm45644739937208" class="calibre5"/></p>

<p class="author1">There are three types of access control in many programming languages:</p>
<dl class="calibre13">
<dt class="calibre14">Public</dt>
<dd class="calibre15">
<p class="calibre16">Any other piece of code can access this part of the API.<a data-type="indexterm" data-primary="public data" id="idm45644739934424" class="calibre5"/></p>
</dd>
<dt class="calibre14">Protected</dt>
<dd class="calibre15">
<p class="calibre16">Only subclasses (we’ll see these more in <a data-type="xref" href="part0016_split_000.html#subtyping" class="calibre5">Chapter 12</a>) should access this part of the API.<a data-type="indexterm" data-primary="protected data" id="idm45644739931608" class="calibre5"/></p>
</dd>
<dt class="calibre14">Private</dt>
<dd class="calibre15">
<p class="calibre16">Only this class (and any other instances of this class) should access this part of the API.</p>
</dd>
</dl>

<p class="author1">Public and protected attributes form your public API, and should be relatively stable before people depend on your class heavily. However, it is a general convention that people should leave your private API alone. This should leave you free to hide things that you feel need to be inaccessible. This is how you can preserve your invariants.</p>

<p class="author1">In Python, you signal to other developers that an attribute<a data-type="indexterm" data-primary="attributes" data-secondary="protected and private" id="idm45644739928008" class="calibre5"/><a data-type="indexterm" data-primary="methods" data-secondary="private" id="idm45644739927032" class="calibre5"/> should be protected by prefixing it with an underscore (<code class="calibre17">_</code>). <a data-type="indexterm" data-primary="underscores" data-secondary="in protected and private attributes and methods" id="idm45644739925576" class="calibre5"/>Private attributes and methods should be prefixed with two underscores (<code class="calibre17">__</code>). (Note that this is not the same as functions <em class="calibre6">surrounded</em> by two underscores—those denote special magic methods, which I’ll cover in <a data-type="xref" href="part0015_split_000.html#api" class="calibre5">Chapter 11</a>.) In Python, you don’t have a compiler that can catch when this access control is broken. There is nothing stopping a developer from reaching in and messing with your protected and private members. Enforcing this becomes an organizational challenge, part of the nature of the beast with a dynamically typed language like Python. Set up linting, enforce code styles, do thorough code reviews; you should treat your API as a core tenet of your class and not allow it to be broken lightly.</p>

<p class="author1">There are a few benefits to making your attributes protected/private. Protected and private attributes don’t show up in <code class="calibre17">help()</code> of a class. This will reduce the chance of somebody using these attributes inadvertently. Furthermore, private attributes aren’t as easily accessible.</p>

<p class="author1">Consider the <code class="calibre17">PizzaSpecification</code> with private members:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="k">from</code><code class="calibre17"> </code><code class="nn">pizza.sauces</code><code class="calibre17"> </code><code class="k">import</code><code class="calibre17"> </code><code class="n">is_sauce</code><code class="calibre17">
</code><code class="k">class</code><code class="calibre17"> </code><code class="nc">PizzaSpecification</code><code class="calibre17">:</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="k">def</code><code class="calibre17"> </code><code class="calibre17">__init__</code><code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">,</code><code class="calibre17">
</code><code class="calibre17">                 </code><code class="n">dough_radius_in_inches</code><code class="calibre17">:</code><code class="calibre17"> </code><code class="nb">int</code><code class="calibre17">,</code><code class="calibre17">
</code><code class="calibre17">                 </code><code class="n">toppings</code><code class="calibre17">:</code><code class="calibre17"> </code><code class="nb">list</code><code class="calibre17">[</code><code class="nb">str</code><code class="calibre17">]</code><code class="calibre17">)</code><code class="calibre17">:</code><code class="calibre17">
</code><code class="calibre17">        </code><code class="k">assert</code><code class="calibre17"> </code><code class="mi">6</code><code class="calibre17"> </code><code class="calibre17">&lt;</code><code class="calibre17">=</code><code class="calibre17"> </code><code class="n">dough_radius_in_inches</code><code class="calibre17"> </code><code class="calibre17">&lt;</code><code class="calibre17">=</code><code class="calibre17"> </code><code class="mi">12</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="calibre17">\
</code><code class="calibre17">        </code><code class="s">'</code><code class="s">Dough must be between 6 and 12 inches</code><code class="s">'</code><code class="calibre17">
</code><code class="calibre17">        </code><code class="n">sauces</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="calibre17">[</code><code class="n">t</code><code class="calibre17"> </code><code class="k">for</code><code class="calibre17"> </code><code class="n">t</code><code class="calibre17"> </code><code class="calibre19">in</code><code class="calibre17"> </code><code class="n">toppings</code><code class="calibre17"> </code><code class="k">if</code><code class="calibre17"> </code><code class="n">is_sauce</code><code class="calibre17">(</code><code class="n">t</code><code class="calibre17">)</code><code class="calibre17">]</code><code class="calibre17">
</code><code class="calibre17">        </code><code class="k">assert</code><code class="calibre17"> </code><code class="nb">len</code><code class="calibre17">(</code><code class="n">sauces</code><code class="calibre17">)</code><code class="calibre17"> </code><code class="calibre17">&lt;</code><code class="calibre17"> </code><code class="mi">2</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="calibre17">\
</code><code class="calibre17">            </code><code class="s">'</code><code class="s">Can have at most one sauce</code><code class="s">'</code><code class="calibre17">
</code><code class="calibre17">
</code><code class="calibre17">        </code><code class="nb">self</code><code class="calibre17">.</code><code class="n">__dough_radius_in_inches</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="n">dough_radius_in_inches</code><code class="calibre17"> </code><a class="calibre5" id="co_user_defined_types__classes_CO1-1" href="part0014_split_012.html#callout_user_defined_types__classes_CO1-1"><img src="../images/00002.gif" alt="1" class="calibre40"/></a><code class="calibre17">
</code><code class="calibre17">        </code><code class="n">sauce</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="n">sauces</code><code class="calibre17">[</code><code class="calibre17">:</code><code class="mi">1</code><code class="calibre17">]</code><code class="calibre17">
</code><code class="calibre17">        </code><code class="nb">self</code><code class="calibre17">.</code><code class="n">__toppings</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="n">sauce</code><code class="calibre17"> </code><code class="calibre17">+</code><code class="calibre17"> </code><code class="calibre17">\
</code><code class="calibre17">            </code><code class="calibre17">[</code><code class="n">t</code><code class="calibre17"> </code><code class="k">for</code><code class="calibre17"> </code><code class="n">t</code><code class="calibre17"> </code><code class="calibre19">in</code><code class="calibre17"> </code><code class="n">toppings</code><code class="calibre17"> </code><code class="k">if</code><code class="calibre17"> </code><code class="calibre19">not</code><code class="calibre17"> </code><code class="n">is_sauce</code><code class="calibre17">(</code><code class="n">t</code><code class="calibre17">)</code><code class="calibre17">]</code><code class="calibre17"> </code><a class="calibre5" id="co_user_defined_types__classes_CO1-2" href="part0014_split_012.html#callout_user_defined_types__classes_CO1-2"><img src="../images/00005.gif" alt="2" class="calibre40"/></a><code class="calibre17">
</code><code class="calibre17">
</code><code class="n">pizza_spec</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="n">PizzaSpecification</code><code class="calibre17">(</code><code class="n">dough_radius_in_inches</code><code class="calibre17">=</code><code class="mi">8</code><code class="calibre17">,</code><code class="calibre17">
</code><code class="calibre17">                                </code><code class="n">toppings</code><code class="calibre17">=</code><code class="calibre17">[</code><code class="s">'</code><code class="s">Olive Oil</code><code class="s">'</code><code class="calibre17">,</code><code class="calibre17">
</code><code class="calibre17">                                          </code><code class="s">'</code><code class="s">Garlic</code><code class="s">'</code><code class="calibre17">,</code><code class="calibre17">
</code><code class="calibre17">                                          </code><code class="s">'</code><code class="s">Sliced Roma Tomatoes</code><code class="s">'</code><code class="calibre17">,</code><code class="calibre17">
</code><code class="calibre17">                                          </code><code class="s">'</code><code class="s">Mozzarella</code><code class="s">'</code><code class="calibre17">]</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">
</code><code class="n">pizza_spec</code><code class="calibre17">.</code><code class="n">__toppings</code><code class="calibre17">.</code><code class="n">append</code><code class="calibre17">(</code><code class="s">'</code><code class="s">Tomato Sauce</code><code class="s">'</code><code class="calibre17">)</code><code class="calibre17"> </code><code class="c"># OOPS</code><code class="calibre17">
</code><code class="calibre17">&gt;&gt;</code><code class="calibre17">&gt;</code><code class="calibre17"> </code><code class="ne">AttributeError</code><code class="calibre17">:</code><code class="calibre17"> </code><code class="nb">type</code><code class="calibre17"> </code><code class="nb">object</code><code class="calibre17"> </code><code class="s">'</code><code class="s">pizza_spec</code><code class="s">'</code><code class="calibre17"> </code><code class="n">has</code><code class="calibre17"> </code><code class="n">no</code><code class="calibre17"> </code><code class="n">attribute</code><code class="calibre17"> </code><code class="s">'</code><code class="s">__toppings</code><code class="s">'</code></pre>
<dl class="calibre13">
<dt class="calibre14"><a class="calibre5" id="callout_user_defined_types__classes_CO1-1" href="part0014_split_012.html#co_user_defined_types__classes_CO1-1"><img src="../images/00002.gif" alt="1" class="calibre40"/></a></dt>
<dd class="calibre41"><p class="calibre42">Dough radius in inches is now a private member.</p></dd>
<dt class="calibre14"><a class="calibre5" id="callout_user_defined_types__classes_CO1-2" href="part0014_split_012.html#co_user_defined_types__classes_CO1-2"><img src="../images/00005.gif" alt="2" class="calibre40"/></a></dt>
<dd class="calibre41"><p class="calibre42">Toppings is now a private member.</p></dd>
</dl>

<p class="author1">Python does something called name mangling when you prefix attributes with two underscores.<a data-type="indexterm" data-primary="name mangling" id="idm45644739763368" class="calibre5"/> That is, Python changes the name out from underneath you, making it very obvious when users are abusing your API. I can find out what name mangling is by using the <code class="calibre17">__dict__</code> attribute of an object:</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="n">pizza_spec</code><code class="calibre17">.</code><code class="calibre17">__dict__</code>
<code class="calibre17">&gt;&gt;&gt;</code> <code class="calibre17">{</code> <code class="s">'_PizzaSpecification__toppings'</code><code class="calibre17">:</code> <code class="calibre17">[</code><code class="s">'Olive Oil'</code><code class="calibre17">,</code>
                                        <code class="s">'Garlic'</code><code class="calibre17">,</code>
                                        <code class="s">'Sliced Roma Tomatoes'</code><code class="calibre17">,</code>
                                        <code class="s">'Mozzarella'</code><code class="calibre17">],</code>
      <code class="s">'_PizzaSpecification__dough_radius_in_inches'</code><code class="calibre17">:</code> <code class="mi">8</code>
<code class="calibre17">}</code>

<code class="n">pizza_spec</code><code class="calibre17">.</code><code class="n">_PizzaSpecification__dough_radius_in_inches</code> <code class="calibre17">=</code> <code class="mi">100</code>
<code class="k">print</code><code class="calibre17">(</code><code class="n">pizza_spec</code><code class="calibre17">.</code><code class="n">_PizzaSpecification__dough_radius_in_inches</code><code class="calibre17">)</code>
<code class="calibre17">&gt;&gt;&gt;</code> <code class="mi">100</code></pre>

<p class="author1">If you see an attribute access like this, you should raise a red flag: developers are messing with class internals and this might break invariants. Fortunately, this is very easy to catch when linting code bases (you’ll learn more about linters in <a data-type="xref" href="part0026_split_000.html#static_analysis" class="calibre5">Chapter 20</a>). Form a pact with your cocontributors and don’t touch anything that is private; otherwise, you’ll find yourself in an unmaintainable mess.</p>
<aside data-type="sidebar" epub:type="sidebar" class="calibre32"><div class="sidebar" id="idm45644739513048">
<h5 class="calibre33">Should I Write Getters/Setters for Every Private Member?</h5>
<p class="author1">It’s a common mistake (especially for those just learning about private attributes) to write a getter and setter for every one.<a data-type="indexterm" data-primary="getters and setters" data-secondary="writing for every private class member" id="idm45644739511704" class="calibre5"/> If you find your class is almost nothing but getter and setters, you may want to look at a data class instead. You’re providing public access, just with more steps.</p>

<p class="author1">Even if you do have invariants in your class, beware an abundance of getter methods. You don’t want to be returning references to mutable attributes such as lists or dictionaries. In many cases, it may be appropriate to return a copy of that data. If your callers need to mutate that data, try to force them through the API of your choosing (or write a new API, if appropriate, that preserves your invariants).</p>
</div></aside>
</div></section>













</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 10. User-Defined Types: Classes" class="preface">
<div class="preface" id="classes">
<section data-type="sect1" data-pdf-bookmark="Encapsulation and Maintaining Invariants" class="preface">
<div class="preface" id="idm45644740639160">
<section data-type="sect2" data-pdf-bookmark="Operations" class="preface"><div class="preface" id="idm45644739979224">
<h2 class="calibre34" id="calibre_pb_13">Operations</h2>

<p class="author1">So now I have a class whose invariants cannot be (easily) broken.<a data-type="indexterm" data-primary="invariants" data-secondary="maintaining, encapsulation and" data-tertiary="operations" id="ix_invarmtnops" class="calibre5"/><a data-type="indexterm" data-primary="classes" data-secondary="encapsulation and maintaining invariants" data-tertiary="operations" id="ix_clssencops" class="calibre5"/> I have a class that is constructible, but I’m not able to change or read any data from it. That’s because I’ve only touched upon one part of encapsulation thus far: the hiding of data. I still need to walk through how to bundle operations with data. Enter methods.</p>

<p class="author1">I will trust that you have a good handle on functions that live outside of a class (also known as free functions). What I’ll focus on are functions that live inside the class, also known as methods.</p>

<p class="author1">Let’s say that for my pizza specification, I want to be able to add a topping while the pizza is queued to be made. After all, my pizzas are a huge success (it’s my imagination, let me have this one), and there is often a long line of pizzas to be made. But a family just placing their order realizes they missed their son’s favorite topping, and in order to prevent a toddler meltdown over melted cheese, they need to modify their order after they’ve submitted it. I’ll define a new function that adds a topping for their convenience.</p>

<pre data-type="programlisting" data-code-language="python" class="calibre35"><code class="k">from</code><code class="calibre17"> </code><code class="nn">typing</code><code class="calibre17"> </code><code class="k">import</code><code class="calibre17"> </code><code class="n">List</code><code class="calibre17">
</code><code class="k">from</code><code class="calibre17"> </code><code class="nn">pizza.exceptions</code><code class="calibre17"> </code><code class="k">import</code><code class="calibre17"> </code><code class="n">PizzaException</code><code class="calibre17">
</code><code class="k">from</code><code class="calibre17"> </code><code class="nn">pizza.sauces</code><code class="calibre17"> </code><code class="k">import</code><code class="calibre17"> </code><code class="n">is_sauce</code><code class="calibre17">
</code><code class="k">class</code><code class="calibre17"> </code><code class="nc">PizzaSpecification</code><code class="calibre17">:</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="k">def</code><code class="calibre17"> </code><code class="calibre17">__init__</code><code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">,</code><code class="calibre17">
</code><code class="calibre17">                 </code><code class="n">dough_radius_in_inches</code><code class="calibre17">:</code><code class="calibre17"> </code><code class="nb">int</code><code class="calibre17">,</code><code class="calibre17">
</code><code class="calibre17">                 </code><code class="n">toppings</code><code class="calibre17">:</code><code class="calibre17"> </code><code class="nb">list</code><code class="calibre17">[</code><code class="nb">str</code><code class="calibre17">]</code><code class="calibre17">)</code><code class="calibre17">:</code><code class="calibre17">
</code><code class="calibre17">        </code><code class="k">assert</code><code class="calibre17"> </code><code class="mi">6</code><code class="calibre17"> </code><code class="calibre17">&lt;</code><code class="calibre17">=</code><code class="calibre17"> </code><code class="n">dough_radius_in_inches</code><code class="calibre17"> </code><code class="calibre17">&lt;</code><code class="calibre17">=</code><code class="calibre17"> </code><code class="mi">12</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="calibre17">\
</code><code class="calibre17">            </code><code class="s">'</code><code class="s">Dough must be between 6 and 12 inches</code><code class="s">'</code><code class="calibre17">
</code><code class="calibre17">
</code><code class="calibre17">        </code><code class="nb">self</code><code class="calibre17">.</code><code class="n">__dough_radius_in_inches</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="n">dough_radius_in_inches</code><code class="calibre17">
</code><code class="calibre17">        </code><code class="nb">self</code><code class="calibre17">.</code><code class="n">__toppings</code><code class="calibre17">:</code><code class="calibre17"> </code><code class="nb">list</code><code class="calibre17">[</code><code class="nb">str</code><code class="calibre17">]</code><code class="calibre17"> </code><code class="calibre17">=</code><code class="calibre17"> </code><code class="calibre17">[</code><code class="calibre17">]</code><code class="calibre17">
</code><code class="calibre17">        </code><code class="k">for</code><code class="calibre17"> </code><code class="n">topping</code><code class="calibre17"> </code><code class="calibre19">in</code><code class="calibre17"> </code><code class="n">toppings</code><code class="calibre17">:</code><code class="calibre17">
</code><code class="calibre17">            </code><code class="nb">self</code><code class="calibre17">.</code><code class="n">add_topping</code><code class="calibre17">(</code><code class="n">topping</code><code class="calibre17">)</code><code class="calibre17"> </code><a class="calibre5" id="co_user_defined_types__classes_CO2-1" href="part0014_split_013.html#callout_user_defined_types__classes_CO2-1"><img src="../images/00002.gif" alt="1" class="calibre40"/></a><code class="calibre17">
</code><code class="calibre17">
</code><code class="calibre17">
</code><code class="calibre17">    </code><code class="k">def</code><code class="calibre17"> </code><code class="nf">add_topping</code><code class="calibre17">(</code><code class="nb">self</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="n">topping</code><code class="calibre17">:</code><code class="calibre17"> </code><code class="nb">str</code><code class="calibre17">)</code><code class="calibre17">:</code><code class="calibre17"> </code><a class="calibre5" id="co_user_defined_types__classes_CO2-2" href="part0014_split_013.html#callout_user_defined_types__classes_CO2-2"><img src="../images/00005.gif" alt="2" class="calibre40"/></a><code class="calibre17">
</code><code class="calibre17">        </code><code class="sd">'''
        Add a topping to the pizza
        All rules for pizza construction (one sauce, no sauce above
        cheese, etc.) still apply.
        '''</code><code class="calibre17">
</code><code class="calibre17">        </code><code class="k">if</code><code class="calibre17"> </code><code class="calibre17">(</code><code class="n">is_sauce</code><code class="calibre17">(</code><code class="n">topping</code><code class="calibre17">)</code><code class="calibre17"> </code><code class="calibre19">and</code><code class="calibre17">
</code><code class="calibre17">               </code><code class="nb">any</code><code class="calibre17">(</code><code class="n">t</code><code class="calibre17"> </code><code class="k">for</code><code class="calibre17"> </code><code class="n">t</code><code class="calibre17"> </code><code class="calibre19">in</code><code class="calibre17"> </code><code class="nb">self</code><code class="calibre17">.</code><code class="n">__toppings</code><code class="calibre17"> </code><code class="k">if</code><code class="calibre17"> </code><code class="n">is_sauce</code><code class="calibre17">(</code><code class="n">t</code><code class="calibre17">)</code><code class="calibre17">)</code><code class="calibre17">)</code><code class="calibre17">:</code><code class="calibre17">
</code><code class="calibre17">               </code><code class="k">raise</code><code class="calibre17"> </code><code class="n">PizzaException</code><code class="calibre17">(</code><code class="s">'</code><code class="s">Pizza may only have one sauce</code><code class="s">'</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">
</code><code class="calibre17">        </code><code class="k">if</code><code class="calibre17"> </code><code class="n">is_sauce</code><code class="calibre17">(</code><code class="n">topping</code><code class="calibre17">)</code><code class="calibre17">:</code><code class="calibre17">
</code><code class="calibre17">            </code><code class="nb">self</code><code class="calibre17">.</code><code class="n">__toppings</code><code class="calibre17">.</code><code class="n">insert</code><code class="calibre17">(</code><code class="mi">0</code><code class="calibre17">,</code><code class="calibre17"> </code><code class="n">topping</code><code class="calibre17">)</code><code class="calibre17">
</code><code class="calibre17">        </code><code class="k">else</code><code class="calibre17">:</code><code class="calibre17">
</code><code class="calibre17">            </code><code class="nb">self</code><code class="calibre17">.</code><code class="n">__toppings</code><code class="calibre17">.</code><code class="n">append</code><code class="calibre17">(</code><code class="n">topping</code><code class="calibre17">)</code></pre>
<dl class="calibre13">
<dt class="calibre14"><a class="calibre5" id="callout_user_defined_types__classes_CO2-1" href="part0014_split_013.html#co_user_defined_types__classes_CO2-1"><img src="../images/00002.gif" alt="1" class="calibre40"/></a></dt>
<dd class="calibre41"><p class="calibre42">Use the new <code class="calibre17">add_topping</code> method.</p></dd>
<dt class="calibre14"><a class="calibre5" id="callout_user_defined_types__classes_CO2-2" href="part0014_split_013.html#co_user_defined_types__classes_CO2-2"><img src="../images/00005.gif" alt="2" class="calibre40"/></a></dt>
<dd class="calibre41"><p class="calibre42">The new <code class="calibre17">add_topping</code> method.</p></dd>
</dl>

<p class="author1">It’d be easy to write a method that merely appends a topping to a list.  But that wouldn’t be right. I have an invariant to uphold, and I’m not backing down now. The code makes sure that we don’t add a second sauce, and if the topping is a sauce, ensures that it is laid down first. Remember, an invariant needs to be true for the lifetime of an object, which extends far past initial construction. Every method you add should be continuing to preserve that invariant.</p>

<p class="author1">Methods are often separated into two categories: accessors and mutators.<a data-type="indexterm" data-primary="methods" data-secondary="accessors and mutators" id="idm45644739210872" class="calibre5"/><a data-type="indexterm" data-primary="accessors" id="idm45644739209896" class="calibre5"/><a data-type="indexterm" data-primary="mutators" id="idm45644739209224" class="calibre5"/><a data-type="indexterm" data-primary="getters and setters" id="idm45644739208552" class="calibre5"/> Some people simplify this to “getters” and “setters,” but I feel like that is a bit too narrow. “Getters” and “setters” often describe methods that just return a simple value or set a member variable. Many methods are much more complicated: setting multiple fields, performing complex calculations, or manipulating data structures.</p>

<p class="author1">Accessors are for retrieving information. If you have invariants that relate to how you represent data, these are the methods you care about. For example, the pizza specification might include a way to transform its internal data into machine operations (roll dough, apply sauce, apply toppings, bake). By nature of the invariants, you’d want to make sure you aren’t producing invalid machine operations.</p>

<p class="author1">Mutators are things that alter the state of your object. If you have mutators, you need to be extra careful that you are preserving any invariants as you change state. Adding new toppings to an existing pizza is a mutator.</p>

<p class="author1">This is also a good way to measure whether a function should be inside your class or not.<a data-type="indexterm" data-primary="functions" data-secondary="deciding whether to place inside a class" id="idm45644739279576" class="calibre5"/> If you have functions that don’t concern themselves with invariants, or even worse, don’t concern themselves with members of the class, you probably have a free function instead. This class is better served by living at module scope and outside of your class. It may be appealing to jam just one more function into an already bloated class (it often is the easiest), but if you strive for maintainability, having unrelated functions in a class leads to a nightmare. (You set up all sorts of interesting dependency chains; if you’ve ever asked yourself why one file depends on another file, this is often the reason.) It also may happen that your class has no invariants at all, and you should instead just chain together free functions.</p>
<aside data-type="sidebar" epub:type="sidebar" class="calibre32"><div class="sidebar" id="idm45644739277624">
<h5 class="calibre33">What About @staticmethod and @classmethod?</h5>
<p class="author1">I do not often use <code class="calibre17">staticmethod</code> and <code class="calibre17">classmethod</code>.<a data-type="indexterm" data-primary="@staticmethod decorator" id="idm45644739297912" class="calibre5"/><a data-type="indexterm" data-primary="@classmethod decorator" id="idm45644739297176" class="calibre5"/> For those unfamiliar, these are decorators that allow you to write functions that are bound to a class instead of an instance (<code class="calibre17">classmethod</code>) and functions that live inside a class but aren’t bound to it in any way (<code class="calibre17">staticmethod</code>). To me, these are holdovers from an older mentality of programming where there weren’t as many robust patterns as there are today.</p>

<p class="author1">With <code class="calibre17">staticmethod</code>, I almost always think that it should be a free function at module-level scope rather than tied to a class. With <code class="calibre17">classmethod</code>, there are a few more legitimate use cases (including some around metaprogramming), but in more cases than not, free functions are more robust. Free functions are easier to move around than classes (classes may need to be broken up or joined together), and I don’t have to worry about how subtypes override my class methods or static methods (there are some sharp edges with inheritance and class/static methods.)</p>
</div></aside>

<p class="author1">And that’s invariants. It’s not something developers talk about enough, but once you start thinking in terms of invariants, you’ll see a major boost to class maintainability. Remember, you use invariants to allow users to reason about your objects and reduce cognitive load. It’s OK if you take extra time writing code if you will pay off the costs for however many readers after.<a data-type="indexterm" data-primary="invariants" data-secondary="maintaining, encapsulation and" data-tertiary="operations" data-startref="ix_invarmtnops" id="idm45644739745928" class="calibre5"/><a data-type="indexterm" data-primary="classes" data-secondary="encapsulation and maintaining invariants" data-tertiary="operations" data-startref="ix_clssencops" id="idm45644739744392" class="calibre5"/><a data-type="indexterm" data-primary="encapsulation" data-startref="ix_encap" id="idm45644739742936" class="calibre5"/><a data-type="indexterm" data-primary="invariants" data-secondary="maintaining, encapsulation and" data-startref="ix_invarmtn" id="idm45644739741992" class="calibre5"/><a data-type="indexterm" data-primary="classes" data-secondary="encapsulation and maintaining variants" data-startref="ix_clssenc" id="idm45644739739896" class="calibre5"/></p>
</div></section>





</div></section>













</div></section>

<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 10. User-Defined Types: Classes" class="preface">
<div class="preface" id="classes">
<section data-type="sect1" data-pdf-bookmark="Closing Thoughts" class="preface"><div class="preface" id="idm45644740017944">
<h1 class="calibre12" id="calibre_pb_14">Closing Thoughts</h1>

<p class="author1">I spent a fair amount of time on classes, especially compared to other user-defined data types such as enumerations and data classes. However, this was intentional. Classes are typically taught very early, and rarely revisited. I’ve found that most developers tend to overuse classes, without considering what they are meant for.</p>

<p class="author1">As you decide how to create user-defined types, I offer the following guide for you:</p>
<dl class="calibre13">
<dt class="calibre14">Dictionaries</dt>
<dd class="calibre15">
<p class="calibre16">Dictionaries are meant for mappings from keys to values.<a data-type="indexterm" data-primary="dictionaries" data-secondary="deciding whether to use" id="idm45644739734808" class="calibre5"/> If you are using dictionaries but rarely iterating over them or dynamically asking for keys, you aren’t using them like an associative mapping and probably need a different type. There is an exception when retrieving data from data sources at runtime (e.g., getting JSON, parsing YAML, retrieving database data, etc.), where a <code class="calibre17">TypedDict</code> is appropriate (see <a data-type="xref" href="part0008_split_000.html#collections" class="calibre5">Chapter 5</a>). However, if you don’t need to use them as dictionaries elsewhere, you should strive to get these into user-defined classes after parsing the data.</p>
</dd>
<dt class="calibre14">Enumerations</dt>
<dd class="calibre15">
<p class="calibre16">Enumerations are great for representing a union of discrete scalar values.<a data-type="indexterm" data-primary="enumerations" data-secondary="deciding whether to use" id="idm45644739481816" class="calibre5"/> You don’t necessarily care about what the enumeration values are; you just need separate identifiers to differentiate cases in your code.</p>
</dd>
<dt class="calibre14">Data classes</dt>
<dd class="calibre15">
<p class="calibre16">Data classes are great for bundles of data that are mostly independent.<a data-type="indexterm" data-primary="data classes" data-secondary="deciding whether to use" id="idm45644739479272" class="calibre5"/> You may have some restrictions on how individual fields can be set, but for the most part, users are free to get and set individual attributes to their heart’s content.</p>
</dd>
<dt class="calibre14">Classes</dt>
<dd class="calibre15">
<p class="calibre16">Classes are all about invariants. If you have an invariant you want to preserve, create a class, assert that the preconditions hold when constructing, and don’t let any method or user access break that invariant.</p>
</dd>
</dl>

<p class="author1"><a data-type="xref" href="part0014_split_014.html#class_flowchart" class="calibre5">Figure 10-1</a> is a handy flowchart that describes these rules of thumb.</p>

<figure class="calibre36"><div id="class_flowchart" class="figure">
<img src="../images/00014.gif" alt="Picking the appropriate abstraction" class="calibre40"/>
<h6 class="calibre37"><span class="calibre">Figure 10-1. </span>Picking the appropriate abstraction</h6>
</div></figure>

<p class="author1">However, knowing which type to pick is only half the battle. Once you’ve picked the right type, you need to make it seamless to interact with from a consumer’s perspective. In the next chapter, you’re going to learn how to make your user-defined types more natural to work with by focusing on the type’s API.<a data-type="indexterm" data-primary="classes" data-startref="ix_clss" id="idm45644739431752" class="calibre5"/><a data-type="indexterm" data-primary="user-defined types" data-secondary="classes" data-startref="ix_usrDTCl" id="idm45644739430776" class="calibre5"/></p>
</div></section>







<div data-type="footnotes" class="calibre25"><p data-type="footnote" id="idm45644740381352" class="calibre26"><sup class="calibre27"><a href="part0014_split_005.html#idm45644740381352-marker" class="calibre5">1</a></sup> Andrew Hunt and David Thomas. <em class="calibre6">The Pragmatic Programmer: From Journeyman to Master</em>. Reading, MA: Addison-Wesley, 2000.</p><p data-type="footnote" id="idm45644740365960" class="calibre26"><sup class="calibre27"><a href="part0014_split_005.html#idm45644740365960-marker" class="calibre5">2</a></sup> Robert C. Martin. “The Single Responsibility Principle.” <em class="calibre6">The Clean Code Blog</em> (blog), May 8, 2014. <a href="https://oreil.ly/ZOMxb" class="calibre5"><em class="calibre6">https://oreil.ly/ZOMxb</em></a>.</p></div></div></section></body></html>