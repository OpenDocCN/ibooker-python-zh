<html><head></head><body><section data-pdf-bookmark="Chapter 8. Web Layer" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch08">&#13;
<h1><span class="label">Chapter 8. </span>Web Layer</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Preview" data-type="sect1"><div class="sect1" id="id71">&#13;
<h1>Preview</h1>&#13;
&#13;
<p><a data-type="xref" href="ch03.html#ch03">Chapter 3</a> <a data-primary="Web layer" data-type="indexterm" id="ibd001"/>was a quick look at how to define&#13;
FastAPI web endpoints,&#13;
pass simple string inputs to them,&#13;
and get responses.&#13;
This chapter goes further into the top layer of&#13;
a FastAPI application—which could also be called an <em>Interface</em> or <em>Router</em> layer—and its integration with the Service and Data layers.</p>&#13;
&#13;
<p>As before, I’ll start with small examples.&#13;
Then I’ll introduce some structure, dividing layers&#13;
into subsections to allow for cleaner development and growth.&#13;
The less code we write,&#13;
the less we’ll need to remember and fix later.</p>&#13;
&#13;
<p>The basic sample data in this book concerns&#13;
imaginary creatures,&#13;
or<a data-primary="cryptids" data-secondary="defined" data-type="indexterm" id="id611"/> <em>cryptids</em>,&#13;
and their explorers.&#13;
You may find parallels with other domains of information.</p>&#13;
&#13;
<p>What do we do with information, in general?&#13;
Like most websites, ours will provide ways to do the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Retrieve</p>&#13;
</li>&#13;
<li>&#13;
<p>Create</p>&#13;
</li>&#13;
<li>&#13;
<p>Modify</p>&#13;
</li>&#13;
<li>&#13;
<p>Replace</p>&#13;
</li>&#13;
<li>&#13;
<p>Delete</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Starting from the top,&#13;
we’ll create web endpoints that perform these functions on our data.&#13;
At first, we’ll provide fake data to make the endpoints work with&#13;
any web client.&#13;
In the following chapters,&#13;
we’ll move the fake data code down into the lower layers.&#13;
At each step, we’ll ensure that the site still works and passes&#13;
data through correctly.&#13;
Finally, in <a data-type="xref" href="ch10.html#ch10">Chapter 10</a>,&#13;
we’ll drop the faking&#13;
and store real data in real databases,&#13;
for a full end-to-end (Web → Service → Data) website.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Allowing any anonymous visitor to perform all these actions&#13;
will be an object lesson in “why we can’t have nice things.”&#13;
<a data-type="xref" href="ch11.html#ch11">Chapter 11</a> discusses the<a data-primary="authentication" data-type="indexterm" id="id612"/> <em>auth</em> (authentication and<a data-primary="authorization" data-type="indexterm" id="id613"/>&#13;
authorization) needed to define roles and limit who can do what.&#13;
For the rest of the current chapter, we’ll sidestep auth&#13;
and just show how to handle the raw web functions.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Interlude: Top-Down, Bottom-Up, Middle-Out?" data-type="sect1"><div class="sect1" id="id72">&#13;
<h1>Interlude: Top-Down, Bottom-Up, Middle-Out?</h1>&#13;
&#13;
<p><a data-primary="Web layer" data-secondary="design approach" data-type="indexterm" id="ibd002"/>When <a data-primary="design approach" data-type="indexterm" id="ibd020"/>designing a website,&#13;
you could start from one of the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>The Web layer and work down</p>&#13;
</li>&#13;
<li>&#13;
<p>The Data layer and work up</p>&#13;
</li>&#13;
<li>&#13;
<p>The Service layer and work out in both directions</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Do you already have a database,&#13;
installed and loaded with data, and are just pining for a way to share it with the world?&#13;
If so, you may want to tackle the&#13;
Data layer’s code and tests first,&#13;
then the Service layer,&#13;
and write the Web layer last.</p>&#13;
&#13;
<p>If you’re following&#13;
<a href="https://oreil.ly/iJu9Q">domain-driven design</a>,&#13;
you might start in the middle Service layer,&#13;
defining your core&#13;
entities and data models. Or you may want to evolve the web interface first,&#13;
and fake calls to the lower layers until you know what&#13;
you’ll expect of them.</p>&#13;
&#13;
<p>You’ll find very good design discussions and recommendations in these books:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://oreil.ly/5KrL9"><em>Clean Architectures in Python</em></a> by Leonardo Giordani (<span class="keep-together">Digital</span> Cat Books)</p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://www.cosmicpython.com"><em>Architecture Patterns with Python</em></a> by Harry J.W. Percival and Bob Gregory (O’Reilly)</p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/Gk0z2"><em>Microservice APIs</em></a> by José Haro Peralta (Manning)</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>In these and other sources,&#13;
you’ll see terms like&#13;
<em>hexagonal architecture</em>,&#13;
<em>ports</em>,&#13;
and <em>adapters</em>.&#13;
Your choices on how to proceed largely depend on what data you&#13;
have already and how you want to approach the work of building a site.</p>&#13;
&#13;
<p>I’m guessing that many of you are mainly interested in trying out FastAPI&#13;
and its related technologies,&#13;
and don’t necessarily have a predefined mature data domain&#13;
that you want to instrument right away.</p>&#13;
&#13;
<p>So, in this book I’m taking the web-first approach—step-by-step,&#13;
starting with essential parts,&#13;
and adding others as needed&#13;
on the way down.&#13;
Sometimes experiments work, sometimes not.&#13;
I’ll avoid the urge to stuff everything into this Web layer&#13;
at <a data-primary="design approach" data-startref="ibd020" data-type="indexterm" id="id614"/>first<a data-primary="Web layer" data-secondary="design approach" data-startref="ibd002" data-type="indexterm" id="id615"/>.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>This Web layer is just one way of passing data between a user&#13;
and a service.&#13;
Alternate ways exist,&#13;
such as by a <a data-primary="CLI (command-line interface)" data-type="indexterm" id="id616"/>CLI or software development kit (SDK).&#13;
In other frameworks, you might see this Web layer&#13;
<a data-primary="presentation layer" data-see="Web layer" data-type="indexterm" id="id617"/>called <a data-primary="view layer" data-see="Web layer" data-type="indexterm" id="id618"/>a <em>view</em> or <em>presentation</em> layer.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="RESTful API Design" data-type="sect1"><div class="sect1" id="id73">&#13;
<h1>RESTful API Design</h1>&#13;
&#13;
<p><a data-primary="Web layer" data-secondary="RESTful API design" data-type="indexterm" id="ibd003"/>HTTP <a data-primary="RESTful API design" data-secondary="Web layer" data-type="indexterm" id="ibd021"/>is a way to get commands and data between web clients&#13;
and servers.&#13;
But, just as you can combine ingredients from your refrigerator&#13;
in ways from ghastly to gourmet,&#13;
some recipes for HTTP work better than others.</p>&#13;
&#13;
<p>In <a data-type="xref" href="ch01.html#ch01">Chapter 1</a>, I mentioned that <em>RESTful</em> became a useful,&#13;
though sometimes fuzzy,&#13;
model for HTTP development.&#13;
RESTful designs have these <a data-primary="RESTful API design" data-secondary="core components" data-type="indexterm" id="id619"/>core components:</p>&#13;
<dl>&#13;
<dt>Resources</dt>&#13;
<dd>&#13;
<p>The data elements your application manages</p>&#13;
</dd>&#13;
<dt>IDs</dt>&#13;
<dd>&#13;
<p>Unique resource identifiers</p>&#13;
</dd>&#13;
<dt>URLs</dt>&#13;
<dd>&#13;
<p>Structured resource and ID strings</p>&#13;
</dd>&#13;
<dt>Verbs<a data-primary="HTTP verbs" data-type="indexterm" id="ibd036"/> or actions</dt>&#13;
<dd>&#13;
<p>Terms that accompany URLs for different purposes:</p>&#13;
<dl>&#13;
<dt><code>GET</code></dt>&#13;
<dd>&#13;
<p>Retrieve a resource.</p>&#13;
</dd>&#13;
<dt><code>POST</code></dt>&#13;
<dd>&#13;
<p>Create a new resource.</p>&#13;
</dd>&#13;
<dt><code>PUT</code></dt>&#13;
<dd>&#13;
<p>Completely replace a resource.</p>&#13;
</dd>&#13;
<dt><code>PATCH</code></dt>&#13;
<dd>&#13;
<p>Partially replace a resource.</p>&#13;
</dd>&#13;
<dt><code>DELETE</code></dt>&#13;
<dd>&#13;
<p>Resource goes kaboom.</p>&#13;
</dd>&#13;
</dl>&#13;
</dd>&#13;
</dl>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>You’ll see disagreement about the relative merits of&#13;
<code>PUT</code> versus <code>PATCH</code>.&#13;
If you don’t need to distinguish between&#13;
a partial modification and a full one (replacement), you may not need both.</p>&#13;
</div>&#13;
&#13;
<p>General RESTful rules for combining verbs and URLs&#13;
containing resources and IDs&#13;
use these patterns of path parameters&#13;
(content between the <code>/</code> in the URL):</p>&#13;
<dl>&#13;
<dt>verb /resource/</dt>&#13;
<dd>&#13;
<p>Apply <em>verb</em> to all resources&#13;
of type <em>resource</em>.</p>&#13;
</dd>&#13;
<dt>verb /resource/id</dt>&#13;
<dd>&#13;
<p>Apply <em>verb</em> to the <em>resource</em>&#13;
with ID <em>id</em>.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>Using the example data for this book,&#13;
a <code>GET</code> request to the endpoint <em>/thing</em>&#13;
would return data on all explorers,&#13;
but a <code>GET</code> request for <em>/thing/abc</em>&#13;
would give you data for&#13;
only the <code>thing</code> resource with <a data-primary="HTTP" data-secondary="verbs" data-startref="ibd036" data-type="indexterm" id="id620"/>ID <code>abc</code>.</p>&#13;
&#13;
<p>Finally, web requests often carry more information, indicating to do the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Sort results</p>&#13;
</li>&#13;
<li>&#13;
<p>Paginate results</p>&#13;
</li>&#13;
<li>&#13;
<p>Perform another function</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Parameters for these can sometimes be expressed&#13;
as <em>path</em> parameters<a data-primary="path parameters" data-type="indexterm" id="id621"/>&#13;
(tacked onto the end, after another <code>/</code>)&#13;
but are often included as&#13;
<em>query</em> parameters<a data-primary="query parameters" data-type="indexterm" id="id622"/>&#13;
(<em>var=val</em> stuff after the <code>?</code> in the URL).&#13;
Because URLs have size limits,&#13;
large requests are often conveyed in the HTTP body.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Most authors recommend using plurals when naming&#13;
the resource,&#13;
and related namespaces like&#13;
API sections and database tables.&#13;
I followed this advice for a long time but now feel that singular names are simpler for many reasons (including oddities of the English&#13;
language):</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Some words are their own plurals: <code>series</code>, <code>fish</code></p>&#13;
</li>&#13;
<li>&#13;
<p>Some words have irregular plurals: <code>children</code>, <code>people</code></p>&#13;
</li>&#13;
<li>&#13;
<p>You need bespoke singular to/from plural conversion code in many places</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>For these reasons,&#13;
I’m using a singular naming scheme in many&#13;
places in this book.&#13;
This is against usual RESTful advice, so&#13;
feel free to ignore this if you <a data-primary="RESTful API design" data-secondary="Web layer" data-startref="ibd021" data-type="indexterm" id="id623"/>disagree<a data-primary="Web layer" data-secondary="RESTful API design" data-startref="ibd003" data-type="indexterm" id="id624"/>.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="File and Directory Site Layout" data-type="sect1"><div class="sect1" id="id74">&#13;
<h1>File and Directory Site Layout</h1>&#13;
&#13;
<p><a data-primary="Web layer" data-secondary="file and directory site layout" data-type="indexterm" id="ibd004"/>Our <a data-primary="file and directory layout" data-secondary="Web layer" data-type="indexterm" id="ibd022"/>data mainly concerns creatures and explorers.&#13;
Initially, we could define all the URLs&#13;
and their FastAPI path functions&#13;
for accessing their data&#13;
in a single Python file.&#13;
Let’s resist that temptation, and start as though&#13;
we were already a rising star in the cryptid web space.&#13;
With a good foundation, cool new things are much easier to add.</p>&#13;
&#13;
<p>First, pick a directory on your machine.&#13;
Name it <em>fastapi</em>, or anything that will help&#13;
you remember where you’ll be messing with the code from this book.&#13;
Within it, create the following subdirectories:</p>&#13;
<dl>&#13;
<dt>src</dt>&#13;
<dd>&#13;
<p>Contains all the website code</p>&#13;
<dl>&#13;
<dt>web</dt>&#13;
<dd>&#13;
<p>The FastAPI web layer</p>&#13;
</dd>&#13;
<dt>service</dt>&#13;
<dd>&#13;
<p>The business logic layer</p>&#13;
</dd>&#13;
<dt>data</dt>&#13;
<dd>&#13;
<p>The storage interface layer</p>&#13;
</dd>&#13;
<dt>model</dt>&#13;
<dd>&#13;
<p>Pydantic model definitions</p>&#13;
</dd>&#13;
<dt>fake</dt>&#13;
<dd>&#13;
<p>Early hardwired (<em>stub</em>) data</p>&#13;
</dd>&#13;
</dl>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>Each of these directories will soon gain three files:</p>&#13;
<dl>&#13;
<dt>__init__.py</dt>&#13;
<dd>&#13;
<p>Needed to treat this directory as a package</p>&#13;
</dd>&#13;
<dt>creature.py</dt>&#13;
<dd>&#13;
<p>Creature code for this layer</p>&#13;
</dd>&#13;
<dt>explorer.py</dt>&#13;
<dd>&#13;
<p>Explorer code for this layer</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p><em>Many</em> opinions exist on how to lay out&#13;
sites for development.&#13;
This design is intended to show the layer separation&#13;
and leave room for future additions.</p>&#13;
&#13;
<p>Some explanations are needed right now. First, <em>__init__.py</em> files are empty.&#13;
They’re sort of a Python hack, so their directory&#13;
should be treated as a Python <em>package</em>&#13;
that may be imported from. Second, the <em>fake</em> directory provides some stub&#13;
data to higher layers as the lower ones are built.</p>&#13;
&#13;
<p>In addition, Python’s <em>import</em> logic doesn’t work strictly with&#13;
directory hierarchies.&#13;
It relies on <a data-primary="Python" data-secondary="packages" data-type="indexterm" id="id625"/>Python <em>packages</em> <a data-primary="Python" data-secondary="modules" data-type="indexterm" id="id626"/>and <em>modules</em>.&#13;
The <em>.py</em> files listed in the tree structure described previously&#13;
are Python modules (source files).&#13;
Their parent directories are packages <em>if</em> they contain an&#13;
<em>__init__.py</em> file.&#13;
(This is a convention to tell Python whether,&#13;
if you have a directory called <em>sys</em> and you type <code>import sys</code>, you actually want the system one or your local one.)</p>&#13;
&#13;
<p>Python programs can import packages and modules.&#13;
The Python interpreter has a built-in&#13;
<code>sys.path</code> variable,&#13;
which includes the location of the standard Python code.&#13;
The environment variable<a data-primary="PYTHONPATH environment variable" data-type="indexterm" id="id627"/> <code>PYTHONPATH</code> is an empty or&#13;
colon-separated string of directory names&#13;
that tells Python which parent directories to check before&#13;
<code>sys.path</code> to&#13;
find the imported modules or packages.&#13;
So, if you change to your new <em>fastapi</em> directory,&#13;
type this&#13;
(on Linux or macOS)&#13;
to ensure that the new code under it will be checked&#13;
first when importing:</p>&#13;
&#13;
<pre data-type="programlisting">$ <strong>export PYTHONPATH=$PWD/src</strong></pre>&#13;
&#13;
<p>That <code>$PWD</code> means <em>print working directory</em>,&#13;
and saves you from typing the full path&#13;
to your <em>fastapi</em> directory, although you can if you want.&#13;
And the <code>src</code> part means to look only in there&#13;
for modules and packages to import.</p>&#13;
&#13;
<p>To set the<a data-primary="PWD (print working directory) environment variable" data-type="indexterm" id="id628"/> <code>PWD</code> environment<a data-primary="print working directory (PWD) environment variable" data-type="indexterm" id="id629"/> variable under <a data-primary="file and directory layout" data-secondary="Web layer" data-startref="ibd022" data-type="indexterm" id="id630"/>Windows<a data-primary="Web layer" data-secondary="file and directory site layout" data-startref="ibd004" data-type="indexterm" id="id631"/>,&#13;
see <a href="https://oreil.ly/9NRBA">“Excursus: Setting Environment Variables” at the Python Software Foundation site</a>.</p>&#13;
&#13;
<p>Whew.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The First Website Code" data-type="sect1"><div class="sect1" id="id191">&#13;
<h1>The First Website Code</h1>&#13;
&#13;
<p><a data-primary="Web layer" data-secondary="first website code" data-type="indexterm" id="ibd005"/>This section discusses how to use FastAPI&#13;
to write requests and responses for a RESTful API site.&#13;
Then, we’ll begin to apply these to our actual,&#13;
increasingly gnarly, site.</p>&#13;
&#13;
<p>Let’s begin with <a data-type="xref" href="#ex-8-1">Example 8-1</a>.&#13;
Within <em>src</em>, make this&#13;
new top-level <em>main.py</em>  program&#13;
that will start the&#13;
Uvicorn program and FastAPI package.</p>&#13;
<div data-type="example" id="ex-8-1">&#13;
<h5><span class="label">Example 8-1. </span>The main program, <span class="plain">main.py</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">FastAPI</code>&#13;
&#13;
&#13;
<code class="n">app</code> <code class="o">=</code> <code class="n">FastAPI</code><code class="p">()</code>&#13;
&#13;
&#13;
<code class="nd">@app</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">top</code><code class="p">():</code>&#13;
    <code class="k">return</code> <code class="s2">"top here"</code>&#13;
&#13;
&#13;
<code class="k">if</code> <code class="vm">__name__</code> <code class="o">==</code> <code class="s2">"__main__"</code><code class="p">:</code>&#13;
    <code class="kn">import</code> <code class="nn">uvicorn</code>&#13;
    <code class="n">uvicorn</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="s2">"main:app"</code><code class="p">,</code> <code class="n">reload</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>That <code>app</code> is the FastAPI object that ties everything together.&#13;
Uvicorn’s first argument is <code>"main:app"</code> because the file is&#13;
called <em>main.py</em>, and the second is <code>app</code>, the name&#13;
of the FastAPI object.</p>&#13;
&#13;
<p>Uvicorn will keep on running,&#13;
and restart if any code changes&#13;
in the same directory or any subdirectories.&#13;
Without <code>reload=True</code>,&#13;
each time you modify your code,&#13;
you’d need to kill and restart Uvicorn manually.&#13;
In many of the following examples, you’ll just keep changing&#13;
the same <em>main.py</em> file and forcing a restart,&#13;
instead of creating&#13;
<em>main2.py</em>, <em>main3.py</em>, and so on.</p>&#13;
&#13;
<p>Fire up <em>main.py</em> in <a data-type="xref" href="#ex-8-2">Example 8-2</a>.</p>&#13;
<div data-type="example" id="ex-8-2">&#13;
<h5><span class="label">Example 8-2. </span>Run the main program</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>python main.py &amp;</strong>&#13;
INFO:     Will watch for changes in these directories: [.../fastapi']&#13;
INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)&#13;
INFO:     Started reloader process [92543] using StatReload&#13;
INFO:     Started server process [92551]&#13;
INFO:     Waiting for application startup.&#13;
INFO:     Application startup complete.</pre></div>&#13;
&#13;
<p>That final <code>&amp;</code> puts the program into the background,&#13;
and you can run other programs in the same terminal window&#13;
if you like.&#13;
Or omit the <code>&amp;</code> and run your&#13;
other code in a different window or tab.</p>&#13;
&#13;
<p>Now you can access the site <code>localhost:8000</code> with a browser&#13;
or any of the test programs that you’ve seen so far.&#13;
<a data-type="xref" href="#ex-8-3">Example 8-3</a> uses HTTPie:</p>&#13;
<div data-type="example" id="ex-8-3">&#13;
<h5><span class="label">Example 8-3. </span>Test the main program</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http localhost:8000</strong>&#13;
HTTP/1.1 200 OK&#13;
content-length: 8&#13;
content-type: application/json&#13;
date: Sun, 05 Feb 2023 03:54:29 GMT&#13;
server: uvicorn&#13;
&#13;
"top here"</pre></div>&#13;
&#13;
<p>From now on, as you make changes,&#13;
the web server should restart automatically.&#13;
If an error kills it,&#13;
restart it with <code>python main.py</code> again.</p>&#13;
&#13;
<p><a data-type="xref" href="#ex-8-4">Example 8-4</a>&#13;
adds another test endpoint,&#13;
using a <em>path</em> parameter (part of the URL).</p>&#13;
<div data-type="example" id="ex-8-4">&#13;
<h5><span class="label">Example 8-4. </span>Add an endpoint</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">uvicorn</code>&#13;
<code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">FastAPI</code>&#13;
&#13;
<code class="n">app</code> <code class="o">=</code> <code class="n">FastAPI</code><code class="p">()</code>&#13;
&#13;
<code class="nd">@app</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">top</code><code class="p">():</code>&#13;
    <code class="k">return</code> <code class="s2">"top here"</code>&#13;
&#13;
<code class="nd">@app</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/echo/</code><code class="si">{thing}</code><code class="s2">"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">echo</code><code class="p">(</code><code class="n">thing</code><code class="p">):</code>&#13;
    <code class="k">return</code> <code class="sa">f</code><code class="s2">"echoing </code><code class="si">{</code><code class="n">thing</code><code class="si">}</code><code class="s2">"</code>&#13;
&#13;
<code class="k">if</code> <code class="vm">__name__</code> <code class="o">==</code> <code class="s2">"__main__"</code><code class="p">:</code>&#13;
    <code class="n">uvicorn</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="s2">"main:app"</code><code class="p">,</code> <code class="n">reload</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>As soon as you save your changes to <em>main.py</em> in your editor,&#13;
the window where your web server is running should print&#13;
something like this:</p>&#13;
&#13;
<pre data-type="programlisting">WARNING:  StatReload detected changes in 'main.py'. Reloading...&#13;
INFO:     Shutting down&#13;
INFO:     Waiting for application shutdown.&#13;
INFO:     Application shutdown complete.&#13;
INFO:     Finished server process [92862]&#13;
INFO:     Started server process [92872]&#13;
INFO:     Waiting for application startup.&#13;
INFO:     Application startup complete.</pre>&#13;
&#13;
<p><a data-type="xref" href="#ex-8-5">Example 8-5</a> shows whether the new endpoint was handled correctly&#13;
(the <code>-b</code> prints only the response body).</p>&#13;
<div data-type="example" id="ex-8-5">&#13;
<h5><span class="label">Example 8-5. </span>Test new endpoint</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http -b localhost:8000/echo/argh</strong>&#13;
"echoing argh"</pre></div>&#13;
&#13;
<p>In the following sections,&#13;
we’ll add more endpoints <a data-primary="Web layer" data-secondary="first website code" data-startref="ibd005" data-type="indexterm" id="id632"/>to <em>main.py</em>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Requests" data-type="sect1"><div class="sect1" id="id192">&#13;
<h1>Requests</h1>&#13;
&#13;
<p><a data-primary="Web layer" data-secondary="HTTP requests" data-type="indexterm" id="ibd006"/>An <a data-primary="HTTP requests" data-secondary="Web layer" data-type="indexterm" id="ibd023"/>HTTP request consists of a text <em>header</em>&#13;
followed by one or more <em>body</em> sections.&#13;
You could write your own code to parse HTTP into Python&#13;
data structures, but you wouldn’t be the first.&#13;
In your web application,&#13;
it’s more productive to have these details done for you by&#13;
a framework.</p>&#13;
&#13;
<p>FastAPI’s dependency injection is particularly useful here.&#13;
Data may come from different parts of the HTTP message,&#13;
and you’ve already seen how you can&#13;
specify one or more of these dependencies to say where the data is located:</p>&#13;
<dl>&#13;
<dt><code>Header</code></dt>&#13;
<dd>&#13;
<p>In the HTTP headers</p>&#13;
</dd>&#13;
<dt><code>Path</code></dt>&#13;
<dd>&#13;
<p>In the URL</p>&#13;
</dd>&#13;
<dt><code>Query</code></dt>&#13;
<dd>&#13;
<p>After the <code>?</code> in the URL</p>&#13;
</dd>&#13;
<dt><code>Body</code></dt>&#13;
<dd>&#13;
<p>In the HTTP body</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>Other, more indirect, sources include the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Environment variables</p>&#13;
</li>&#13;
<li>&#13;
<p>Configuration settings</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p><a data-type="xref" href="#ex-8-6">Example 8-6</a> features an HTTP request,&#13;
using our old friend HTTPie,&#13;
and ignoring the returned HTML body data.</p>&#13;
<div data-type="example" id="ex-8-6">&#13;
<h5><span class="label">Example 8-6. </span>HTTP request and response headers</h5>&#13;
&#13;
<pre data-code-language="text" data-type="programlisting"><code>$ </code><strong><code>http -p HBh http://example.com/</code></strong><code>&#13;
GET / HTTP/1.1&#13;
Accept: </code><strong><code>/</code></strong><code>&#13;
Accept-Encoding: gzip, deflate&#13;
Connection: keep-alive&#13;
Host: example.com&#13;
User-Agent: HTTPie/3.2.1&#13;
&#13;
&#13;
&#13;
HTTP/1.1 200 OK&#13;
Age: 374045&#13;
Cache-Control: max-age=604800&#13;
Content-Encoding: gzip&#13;
Content-Length: 648&#13;
Content-Type: text/html; charset=UTF-8&#13;
Date: Sat, 04 Feb 2023 01:00:21 GMT&#13;
Etag: "3147526947+gzip"&#13;
Expires: Sat, 11 Feb 2023 01:00:21 GMT&#13;
Last-Modified: Thu, 17 Oct 2019 07:18:26 GMT&#13;
Server: ECS (cha/80E2)&#13;
Vary: Accept-Encoding&#13;
X-Cache: HIT</code></pre></div>&#13;
&#13;
<p>The first line asks for the top page at <em>example.com</em>&#13;
(a free website that anyone can use in, well, examples).&#13;
It asks only for a URL, with no parameters anywhere else.&#13;
The first block of lines is the HTTP request headers&#13;
sent to the website,&#13;
and the next block contains the HTTP response headers.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Most test examples from here on&#13;
won’t need all those request and response headers,&#13;
so you’ll see more<a data-primary="HTTP requests" data-secondary="Web layer" data-startref="ibd023" data-type="indexterm" id="id633"/> use of<a data-primary="Web layer" data-secondary="requests" data-startref="ibd006" data-type="indexterm" id="id634"/> <code>http -b</code>.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Multiple Routers" data-type="sect1"><div class="sect1" id="id75">&#13;
<h1>Multiple Routers</h1>&#13;
&#13;
<p><a data-primary="Web layer" data-secondary="subrouters" data-type="indexterm" id="ibd007"/>Most<a data-primary="subrouters" data-type="indexterm" id="id635"/> web services handle multiple kinds of resources.&#13;
Although you could throw all your path-handling code in a single&#13;
file and head off to a happy hour somewhere,&#13;
it’s often handy to use multiple <em>subrouters</em> instead of the&#13;
single <code>app</code> variable that most of the examples up to now have used.</p>&#13;
&#13;
<p>Under the <em>web</em> directory (in the same directory as the <em>main.py</em>&#13;
file that you’ve been modifying so far),&#13;
make&#13;
a file called <em>explorer.py</em>, as in <a data-type="xref" href="#ex-8-7">Example 8-7</a>.</p>&#13;
<div data-type="example" id="ex-8-7">&#13;
<h5><span class="label">Example 8-7. </span><code>APIRouter</code> use in <span class="plain">web/explorer.py</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">APIRouter</code>&#13;
&#13;
<code class="n">router</code> <code class="o">=</code> <code class="n">APIRouter</code><code class="p">(</code><code class="n">prefix</code> <code class="o">=</code> <code class="s2">"/explorer"</code><code class="p">)</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">top</code><code class="p">():</code>&#13;
    <code class="k">return</code> <code class="s2">"top explorer endpoint"</code></pre></div>&#13;
&#13;
<p>Now, <a data-type="xref" href="#ex-8-8">Example 8-8</a>&#13;
gets the top-level application <em>main.py</em>&#13;
to know that&#13;
there’s a new subrouter in town,&#13;
which will handle all URLs that start with <em>/explorer</em>:</p>&#13;
<div data-type="example" id="ex-8-8">&#13;
<h5><span class="label">Example 8-8. </span>Connect the main application (<span class="plain">main.py</span>) to the subrouter</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">FastAPI</code>&#13;
<code class="kn">from</code> <code class="nn">.web</code> <code class="kn">import</code> <code class="n">explorer</code>&#13;
&#13;
<code class="n">app</code> <code class="o">=</code> <code class="n">FastAPI</code><code class="p">()</code>&#13;
&#13;
<code class="n">app</code><code class="o">.</code><code class="n">include_router</code><code class="p">(</code><code class="n">explorer</code><code class="o">.</code><code class="n">router</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>This new file will be picked up by Uvicorn.&#13;
As usual, test in <a data-type="xref" href="#ex-8-9">Example 8-9</a> instead of assuming it will work.</p>&#13;
<div data-type="example" id="ex-8-9">&#13;
<h5><span class="label">Example 8-9. </span>Test new subrouter</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http -b localhost:8000/explorer/</strong>&#13;
"top explorer endpoint"</pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Build the Web Layer" data-type="sect1"><div class="sect1" id="id193">&#13;
<h1>Build the Web Layer</h1>&#13;
&#13;
<p><a data-primary="Web layer" data-secondary="building" data-type="indexterm" id="ibd008"/>Now let’s start adding the actual core functions to the Web layer.&#13;
Initially, fake all the data in the web functions themselves.&#13;
In <a data-type="xref" href="ch09.html#ch09">Chapter 9</a>, we will move the fake data stuff to corresponding service&#13;
functions,&#13;
and in <a data-type="xref" href="ch10.html#ch10">Chapter 10</a>, to the data functions.&#13;
Finally, an actual database will be added for the Data layer&#13;
to access.&#13;
At each development step,&#13;
calls to the web endpoints should still work.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Define Data Models" data-type="sect1"><div class="sect1" id="id76">&#13;
<h1>Define Data Models</h1>&#13;
&#13;
<p><a data-primary="Web layer" data-secondary="defining data models" data-type="indexterm" id="ibd009"/>First, <a data-primary="data models, defining" data-type="indexterm" id="ibd025"/>define the data that we’ll be passing among levels.&#13;
Our <em>domain</em> contains explorers and creatures,&#13;
so let’s define minimal initial Pydantic models for them.&#13;
Other ideas might come up later, like&#13;
expeditions, journals, or ecommerce sales of coffee mugs.&#13;
But for now, just include the two breathing&#13;
(usually, in the case of creatures)&#13;
models in <a data-type="xref" href="#ex-8-10">Example 8-10</a>.</p>&#13;
<div data-type="example" id="ex-8-10">&#13;
<h5><span class="label">Example 8-10. </span>Model definition in <span class="plain">model/explorer.py</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">pydantic</code> <code class="kn">import</code> <code class="n">BaseModel</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">Explorer</code><code class="p">(</code><code class="n">BaseModel</code><code class="p">):</code>&#13;
    <code class="n">name</code><code class="p">:</code> <code class="nb">str</code>&#13;
    <code class="n">country</code><code class="p">:</code> <code class="nb">str</code>&#13;
    <code class="n">description</code><code class="p">:</code> <code class="nb">str</code></pre></div>&#13;
&#13;
<p><a data-type="xref" href="#ex-8-11">Example 8-11</a> resurrects the <code>Creature</code> definition&#13;
from earlier chapters.</p>&#13;
<div data-type="example" id="ex-8-11">&#13;
<h5><span class="label">Example 8-11. </span>Model definition in <span class="plain">model/creature.py</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">pydantic</code> <code class="kn">import</code> <code class="n">BaseModel</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">Creature</code><code class="p">(</code><code class="n">BaseModel</code><code class="p">):</code>&#13;
    <code class="n">name</code><code class="p">:</code> <code class="nb">str</code>&#13;
    <code class="n">country</code><code class="p">:</code> <code class="nb">str</code>&#13;
    <code class="n">area</code><code class="p">:</code> <code class="nb">str</code>&#13;
    <code class="n">description</code><code class="p">:</code> <code class="nb">str</code>&#13;
    <code class="n">aka</code><code class="p">:</code> <code class="nb">str</code></pre></div>&#13;
&#13;
<p>These are very simple initial models.&#13;
You’re not using any of Pydantic’s features,&#13;
such as required versus optional,&#13;
or constrained values.&#13;
This simple code can be enhanced later&#13;
without massive logic upheavals.</p>&#13;
&#13;
<p>For <code>country</code> values, you’ll use the ISO two-character&#13;
country codes; this saves a little typing, at the cost of looking&#13;
up uncommon <a data-primary="data models, defining" data-startref="ibd025" data-type="indexterm" id="id636"/>ones<a data-primary="Web layer" data-secondary="defining data models" data-startref="ibd009" data-type="indexterm" id="id637"/>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Stub and Fake Data" data-type="sect1"><div class="sect1" id="id77">&#13;
<h1>Stub and Fake Data</h1>&#13;
&#13;
<p><a data-primary="Web layer" data-secondary="stubs" data-type="indexterm" id="ibd010"/>Also <a data-primary="stubs (mock data)" data-type="indexterm" id="ibd026"/>known<a data-primary="mocking" data-type="indexterm" id="id638"/> as <em>mock data</em>, <em>stubs</em> are canned results&#13;
that are returned without calling the normal “live” modules.&#13;
They’re a quick way to test your routes and responses.</p>&#13;
&#13;
<p><a data-primary="Web layer" data-secondary="fakes" data-type="indexterm" id="ibd019"/>A <em>fake</em> is<a data-primary="fake data" data-type="indexterm" id="ibd029"/> a stand-in for a real data source that performs at least some of the same functions.&#13;
An example is an in-memory class that mimics a database.&#13;
You’ll be making some fake data in this chapter and the next few,&#13;
as you fill in the code that defines the layers and their&#13;
communication.&#13;
In <a data-type="xref" href="ch10.html#ch10">Chapter 10</a>,&#13;
you’ll define an actual live data store (a database)&#13;
to replace these fakes.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Create Common Functions Through the Stack" data-type="sect1"><div class="sect1" id="id194">&#13;
<h1>Create Common Functions Through the Stack</h1>&#13;
&#13;
<p><a data-primary="Web layer" data-secondary="creating common functions" data-type="indexterm" id="ibd011"/>Similar to the data examples,&#13;
the approach to building this site is exploratory.&#13;
Often it isn’t clear what will eventually be needed,&#13;
so let’s start with some pieces that would be common&#13;
to similar sites.&#13;
Providing a frontend for data usually requires ways to do the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><em>Get</em> one, some, all</p>&#13;
</li>&#13;
<li>&#13;
<p><em>Create</em></p>&#13;
</li>&#13;
<li>&#13;
<p><em>Replace</em> completely</p>&#13;
</li>&#13;
<li>&#13;
<p><em>Modify</em> partially</p>&#13;
</li>&#13;
<li>&#13;
<p><em>Delete</em></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Essentially, these are the CRUD basics from databases,&#13;
although I’ve split the U into partial (<em>modify</em>)&#13;
and complete (<em>replace</em>) functions.&#13;
Maybe this distinction will prove unnecessary!&#13;
It depends on where the data leads.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Create Fake Data" data-type="sect1"><div class="sect1" id="id78">&#13;
<h1>Create Fake Data</h1>&#13;
&#13;
<p><a data-primary="Web layer" data-secondary="fakes" data-type="indexterm" id="ibd012"/>Working top-down,&#13;
you’ll duplicate some&#13;
functions in all three levels.&#13;
To save typing, <a data-type="xref" href="#ex-8-12">Example 8-12</a> introduces&#13;
the top-level directory called <em>fake</em>,&#13;
with modules providing fake data on explorers and creatures.</p>&#13;
<div data-type="example" id="ex-8-12">&#13;
<h5><span class="label">Example 8-12. </span>New module <span class="plain">fake/explorer.py</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">model.explorer</code> <code class="kn">import</code> <code class="n">Explorer</code>&#13;
&#13;
<code class="c1"># fake data, replaced in Chapter 10 by a real database and SQL</code>&#13;
<code class="n">_explorers</code> <code class="o">=</code> <code class="p">[</code>&#13;
    <code class="n">Explorer</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s2">"Claude Hande"</code><code class="p">,</code>&#13;
             <code class="n">country</code><code class="o">=</code><code class="s2">"FR"</code><code class="p">,</code>&#13;
             <code class="n">description</code><code class="o">=</code><code class="s2">"Scarce during full moons"</code><code class="p">),</code>&#13;
    <code class="n">Explorer</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s2">"Noah Weiser"</code><code class="p">,</code>&#13;
             <code class="n">country</code><code class="o">=</code><code class="s2">"DE"</code><code class="p">,</code>&#13;
             <code class="n">description</code><code class="o">=</code><code class="s2">"Myopic machete man"</code><code class="p">),</code>&#13;
    <code class="p">]</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">get_all</code><code class="p">()</code> <code class="o">-&gt;</code> <code class="nb">list</code><code class="p">[</code><code class="n">Explorer</code><code class="p">]:</code>&#13;
    <code class="sd">"""Return all explorers"""</code>&#13;
    <code class="k">return</code> <code class="n">_explorers</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">get_one</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Explorer</code> <code class="o">|</code> <code class="kc">None</code><code class="p">:</code>&#13;
    <code class="k">for</code> <code class="n">_explorer</code> <code class="ow">in</code> <code class="n">_explorers</code><code class="p">:</code>&#13;
        <code class="k">if</code> <code class="n">_explorer</code><code class="o">.</code><code class="n">name</code> <code class="o">==</code> <code class="n">name</code><code class="p">:</code>&#13;
            <code class="k">return</code> <code class="n">_explorer</code>&#13;
    <code class="k">return</code> <code class="kc">None</code>&#13;
&#13;
<code class="c1"># The following are nonfunctional for now,</code>&#13;
<code class="c1"># so they just act like they work, without modifying</code>&#13;
<code class="c1"># the actual fake _explorers list:</code>&#13;
<code class="k">def</code> <code class="nf">create</code><code class="p">(</code><code class="n">explorer</code><code class="p">:</code> <code class="n">Explorer</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Explorer</code><code class="p">:</code>&#13;
    <code class="sd">"""Add an explorer"""</code>&#13;
    <code class="k">return</code> <code class="n">explorer</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">modify</code><code class="p">(</code><code class="n">explorer</code><code class="p">:</code> <code class="n">Explorer</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Explorer</code><code class="p">:</code>&#13;
    <code class="sd">"""Partially modify an explorer"""</code>&#13;
    <code class="k">return</code> <code class="n">explorer</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">replace</code><code class="p">(</code><code class="n">explorer</code><code class="p">:</code> <code class="n">Explorer</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Explorer</code><code class="p">:</code>&#13;
    <code class="sd">"""Completely replace an explorer"""</code>&#13;
    <code class="k">return</code> <code class="n">explorer</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">delete</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">bool</code><code class="p">:</code>&#13;
    <code class="sd">"""Delete an explorer; return None if it existed"""</code>&#13;
    <code class="k">return</code> <code class="kc">None</code></pre></div>&#13;
&#13;
<p>The creature setup in <a data-type="xref" href="#ex-8-13">Example 8-13</a> is similar.</p>&#13;
<div data-type="example" id="ex-8-13">&#13;
<h5><span class="label">Example 8-13. </span>New module <span class="plain">fake/creature.py</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">model.creature</code> <code class="kn">import</code> <code class="n">Creature</code>&#13;
&#13;
&#13;
<code class="c1"># fake data, until we use a real database and SQL</code>&#13;
<code class="n">_creatures</code> <code class="o">=</code> <code class="p">[</code>&#13;
    <code class="n">Creature</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s2">"Yeti"</code><code class="p">,</code>&#13;
             <code class="n">aka</code><code class="o">=</code><code class="s2">"Abominable Snowman"</code><code class="p">,</code>&#13;
             <code class="n">country</code><code class="o">=</code><code class="s2">"CN"</code><code class="p">,</code>&#13;
             <code class="n">area</code><code class="o">=</code><code class="s2">"Himalayas"</code><code class="p">,</code>&#13;
             <code class="n">description</code><code class="o">=</code><code class="s2">"Hirsute Himalayan"</code><code class="p">),</code>&#13;
    <code class="n">Creature</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s2">"Bigfoot"</code><code class="p">,</code>&#13;
             <code class="n">description</code><code class="o">=</code><code class="s2">"Yeti's Cousin Eddie"</code><code class="p">,</code>&#13;
             <code class="n">country</code><code class="o">=</code><code class="s2">"US"</code><code class="p">,</code>&#13;
             <code class="n">area</code><code class="o">=</code><code class="s2">"*"</code><code class="p">,</code>&#13;
             <code class="n">aka</code><code class="o">=</code><code class="s2">"Sasquatch"</code><code class="p">),</code>&#13;
    <code class="p">]</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">get_all</code><code class="p">()</code> <code class="o">-&gt;</code> <code class="nb">list</code><code class="p">[</code><code class="n">Creature</code><code class="p">]:</code>&#13;
    <code class="sd">"""Return all creatures"""</code>&#13;
    <code class="k">return</code> <code class="n">_creatures</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">get_one</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Creature</code> <code class="o">|</code> <code class="kc">None</code><code class="p">:</code>&#13;
    <code class="sd">"""Return one creature"""</code>&#13;
    <code class="k">for</code> <code class="n">_creature</code> <code class="ow">in</code> <code class="n">_creatures</code><code class="p">:</code>&#13;
        <code class="k">if</code> <code class="n">_creature</code><code class="o">.</code><code class="n">name</code> <code class="o">==</code> <code class="n">name</code><code class="p">:</code>&#13;
            <code class="k">return</code> <code class="n">_creature</code>&#13;
    <code class="k">return</code> <code class="kc">None</code>&#13;
&#13;
<code class="c1"># The following are nonfunctional for now,</code>&#13;
<code class="c1"># so they just act like they work, without modifying</code>&#13;
<code class="c1"># the actual fake _creatures list:</code>&#13;
<code class="k">def</code> <code class="nf">create</code><code class="p">(</code><code class="n">creature</code><code class="p">:</code> <code class="n">Creature</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Creature</code><code class="p">:</code>&#13;
    <code class="sd">"""Add a creature"""</code>&#13;
    <code class="k">return</code> <code class="n">creature</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">modify</code><code class="p">(</code><code class="n">creature</code><code class="p">:</code> <code class="n">Creature</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Creature</code><code class="p">:</code>&#13;
    <code class="sd">"""Partially modify a creature"""</code>&#13;
    <code class="k">return</code> <code class="n">creature</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">replace</code><code class="p">(</code><code class="n">creature</code><code class="p">:</code> <code class="n">Creature</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Creature</code><code class="p">:</code>&#13;
    <code class="sd">"""Completely replace a creature"""</code>&#13;
    <code class="k">return</code> <code class="n">creature</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">delete</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">):</code>&#13;
    <code class="sd">"""Delete a creature; return None if it existed"""</code>&#13;
    <code class="k">return</code> <code class="kc">None</code></pre></div>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Yes, the module functions are almost identical.&#13;
They’ll change later,&#13;
when a real database arrives and must handle the&#13;
differing fields of the two models. Also, you’re using separate functions here,&#13;
rather than defining a <code>Fake</code> class or abstract class.&#13;
A module has its own namespace,&#13;
so it’s an equivalent way of bundling data and <span class="keep-together">functions</span>.</p>&#13;
</div>&#13;
&#13;
<p>Now let’s modify the web functions from Examples <a data-type="xref" data-xrefstyle="select:labelnumber" href="#ex-8-12">8-12</a> and&#13;
<a data-type="xref" data-xrefstyle="select:labelnumber" href="#ex-8-13">8-13</a>.&#13;
Preparing to build out the later layers (Service and Data),&#13;
import the fake data provider that was <span class="keep-together">just defined</span>,&#13;
but name it <code>service</code> here:&#13;
<code>import fake.explorer as service</code> (<a data-type="xref" href="#ex-8-14">Example 8-14</a>).&#13;
In <a data-type="xref" href="ch09.html#ch09">Chapter 9</a>, you’ll do the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Make a new <em>service/explorer.py</em> file.</p>&#13;
</li>&#13;
<li>&#13;
<p>Import the fake data there.</p>&#13;
</li>&#13;
<li>&#13;
<p>Make <em>web/explorer.py</em> import the new service module&#13;
instead of the fake module.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>In <a data-type="xref" href="ch10.html#ch10">Chapter 10</a>, you’ll do the same in the Data layer.&#13;
All of this is just adding parts and wiring them together,&#13;
with as little code rework as possible.&#13;
You don’t turn on the electricity&#13;
(i.e., a live database and persistent data)&#13;
until later in <a data-type="xref" href="ch10.html#ch10">Chapter 10</a>.</p>&#13;
<div data-type="example" id="ex-8-14">&#13;
<h5><span class="label">Example 8-14. </span>New endpoints for <span class="plain">web/explorer.py</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">APIRouter</code>&#13;
<code class="kn">from</code> <code class="nn">model.explorer</code> <code class="kn">import</code> <code class="n">Explorer</code>&#13;
<code class="kn">import</code> <code class="nn">fake.explorer</code> <code class="k">as</code> <code class="nn">service</code>&#13;
&#13;
<code class="n">router</code> <code class="o">=</code> <code class="n">APIRouter</code><code class="p">(</code><code class="n">prefix</code> <code class="o">=</code> <code class="s2">"/explorer"</code><code class="p">)</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">get_all</code><code class="p">()</code> <code class="o">-&gt;</code> <code class="nb">list</code><code class="p">[</code><code class="n">Explorer</code><code class="p">]:</code>&#13;
    <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="n">get_all</code><code class="p">()</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/</code><code class="si">{name}</code><code class="s2">"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">get_one</code><code class="p">(</code><code class="n">name</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Explorer</code> <code class="o">|</code> <code class="kc">None</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="n">get_one</code><code class="p">(</code><code class="n">name</code><code class="p">)</code>&#13;
&#13;
<code class="c1"># all the remaining endpoints do nothing yet:</code>&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"/"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">create</code><code class="p">(</code><code class="n">explorer</code><code class="p">:</code> <code class="n">Explorer</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Explorer</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">explorer</code><code class="p">)</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">patch</code><code class="p">(</code><code class="s2">"/"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">modify</code><code class="p">(</code><code class="n">explorer</code><code class="p">:</code> <code class="n">Explorer</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Explorer</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="n">modify</code><code class="p">(</code><code class="n">explorer</code><code class="p">)</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">put</code><code class="p">(</code><code class="s2">"/"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">replace</code><code class="p">(</code><code class="n">explorer</code><code class="p">:</code> <code class="n">Explorer</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Explorer</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="n">replace</code><code class="p">(</code><code class="n">explorer</code><code class="p">)</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">delete</code><code class="p">(</code><code class="s2">"/</code><code class="si">{name}</code><code class="s2">"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">delete</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">):</code>&#13;
    <code class="k">return</code> <code class="kc">None</code></pre></div>&#13;
&#13;
<p>And now, do the same for <em>/creature</em> endpoints (<a data-type="xref" href="#ex-8-15a">Example 8-15</a>).&#13;
Yes, this is similar cut-and-paste code for now,&#13;
but doing this up front simplifies changes later on—and there will always be changes later.</p>&#13;
<div data-type="example" id="ex-8-15a">&#13;
<h5><span class="label">Example 8-15. </span>New endpoints for <span class="plain">web/creature.py</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">APIRouter</code>&#13;
<code class="kn">from</code> <code class="nn">model.creature</code> <code class="kn">import</code> <code class="n">Creature</code>&#13;
<code class="kn">import</code> <code class="nn">fake.creature</code> <code class="k">as</code> <code class="nn">service</code>&#13;
&#13;
<code class="n">router</code> <code class="o">=</code> <code class="n">APIRouter</code><code class="p">(</code><code class="n">prefix</code> <code class="o">=</code> <code class="s2">"/creature"</code><code class="p">)</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">get_all</code><code class="p">()</code> <code class="o">-&gt;</code> <code class="nb">list</code><code class="p">[</code><code class="n">Creature</code><code class="p">]:</code>&#13;
    <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="n">get_all</code><code class="p">()</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/</code><code class="si">{name}</code><code class="s2">"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">get_one</code><code class="p">(</code><code class="n">name</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Creature</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="n">get_one</code><code class="p">(</code><code class="n">name</code><code class="p">)</code>&#13;
&#13;
<code class="c1"># all the remaining endpoints do nothing yet:</code>&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"/"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">create</code><code class="p">(</code><code class="n">creature</code><code class="p">:</code> <code class="n">Creature</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Creature</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">creature</code><code class="p">)</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">patch</code><code class="p">(</code><code class="s2">"/"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">modify</code><code class="p">(</code><code class="n">creature</code><code class="p">:</code> <code class="n">Creature</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Creature</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="n">modify</code><code class="p">(</code><code class="n">creature</code><code class="p">)</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">put</code><code class="p">(</code><code class="s2">"/"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">replace</code><code class="p">(</code><code class="n">creature</code><code class="p">:</code> <code class="n">Creature</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Creature</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="n">replace</code><code class="p">(</code><code class="n">creature</code><code class="p">)</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">delete</code><code class="p">(</code><code class="s2">"/</code><code class="si">{name}</code><code class="s2">"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">delete</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">):</code>&#13;
    <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="n">delete</code><code class="p">(</code><code class="n">name</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>The last time we poked at <em>main.py</em>,&#13;
it was to add the subrouter for <em>/explorer</em> URLs.&#13;
Now, let’s add another for <em>/creature</em> in <a data-type="xref" href="#ex-8-15">Example 8-16</a>.</p>&#13;
<div data-type="example" id="ex-8-15">&#13;
<h5><span class="label">Example 8-16. </span>Add creature subrouter to <span class="plain">main.py</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">uvicorn</code>&#13;
<code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">FastAPI</code>&#13;
<code class="kn">from</code> <code class="nn">web</code> <code class="kn">import</code> <code class="n">explorer</code><code class="p">,</code> <code class="n">creature</code>&#13;
&#13;
<code class="n">app</code> <code class="o">=</code> <code class="n">FastAPI</code><code class="p">()</code>&#13;
&#13;
<code class="n">app</code><code class="o">.</code><code class="n">include_router</code><code class="p">(</code><code class="n">explorer</code><code class="o">.</code><code class="n">router</code><code class="p">)</code>&#13;
<code class="n">app</code><code class="o">.</code><code class="n">include_router</code><code class="p">(</code><code class="n">creature</code><code class="o">.</code><code class="n">router</code><code class="p">)</code>&#13;
&#13;
<code class="k">if</code> <code class="vm">__name__</code> <code class="o">==</code> <code class="s2">"__main__"</code><code class="p">:</code>&#13;
    <code class="n">uvicorn</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="s2">"main:app"</code><code class="p">,</code> <code class="n">reload</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>Did all of that work?&#13;
If you typed or pasted everything exactly,&#13;
Uvicorn should have restarted the application.&#13;
Let’s try some<a data-primary="fake data" data-startref="ibd029" data-type="indexterm" id="id639"/> manual<a data-primary="Web layer" data-secondary="fakes" data-startref="ibd012" data-type="indexterm" id="id640"/> tests<a data-primary="Web layer" data-secondary="building" data-startref="ibd008" data-type="indexterm" id="id641"/>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Test!" data-type="sect1"><div class="sect1" id="id195">&#13;
<h1>Test!</h1>&#13;
&#13;
<p><a data-type="xref" href="ch12.html#ch12">Chapter 12</a> <a data-primary="Web layer" data-secondary="testing" data-type="indexterm" id="ibd013"/>will<a data-primary="testing" data-secondary="Web layer" data-type="indexterm" id="ibd030"/> show how to use pytest to automate&#13;
testing at various levels. Examples <a data-type="xref" data-xrefstyle="select:labelnumber" href="#ex08-17">8-17</a> to&#13;
<a data-type="xref" data-xrefstyle="select:labelnumber" href="#ex08-21">8-21</a> perform some manual Web-layer tests&#13;
of the explorer endpoints with HTTPie.</p>&#13;
<div data-type="example" id="ex08-17">&#13;
<h5><span class="label">Example 8-17. </span>Test the Get All endpoint</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http -b localhost:8000/explorer/</strong>&#13;
[&#13;
    {&#13;
        "country": "FR",&#13;
        "name": "Claude Hande",&#13;
        "description": "Scarce during full moons"&#13;
    },&#13;
    {&#13;
        "country": "DE",&#13;
        "name": "Noah Weiser",&#13;
        "description": "Myopic machete man"&#13;
    }&#13;
]</pre></div>&#13;
<div data-type="example">&#13;
<h5><span class="label">Example 8-18. </span>Test the Get One endpoint</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http -b localhost:8000/explorer/"Noah Weiser"</strong>&#13;
{&#13;
    "country": "DE",&#13;
    "name": "Noah Weiser",&#13;
    "description": "Myopic machete man"&#13;
}</pre></div>&#13;
<div data-type="example">&#13;
<h5><span class="label">Example 8-19. </span>Test the Replace endpoint</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http -b PUT localhost:8000/explorer/"Noah Weiser"</strong>&#13;
{&#13;
    "country": "DE",&#13;
    "name": "Noah Weiser",&#13;
    "description": "Myopic machete man"&#13;
}</pre></div>&#13;
<div data-type="example" id="ex08-20">&#13;
<h5><span class="label">Example 8-20. </span>Test the Modify endpoint</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http -b PATCH localhost:8000/explorer/"Noah Weiser"</strong>&#13;
{&#13;
    "country": "DE",&#13;
    "name": "Noah Weiser",&#13;
    "description": "Myopic machete man"&#13;
}</pre></div>&#13;
<div data-type="example" id="ex08-21">&#13;
<h5><span class="label">Example 8-21. </span>Test the Delete endpoint</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http -b DELETE localhost:8000/explorer/Noah%20Weiser</strong>&#13;
true&#13;
&#13;
$ <strong>http -b DELETE localhost:8000/explorer/Edmund%20Hillary</strong>&#13;
false</pre></div>&#13;
&#13;
<p>You can do the same for the <em>/creature</em> endpoints.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Using the FastAPI Automated Test Forms" data-type="sect1"><div class="sect1" id="id196">&#13;
<h1>Using the FastAPI Automated Test Forms</h1>&#13;
&#13;
<p><a data-primary="Web layer" data-secondary="FastAPI automated test forms" data-type="indexterm" id="ibd014"/>Besides<a data-primary="FastAPI" data-secondary="automated test forms" data-type="indexterm" id="ibd031"/> the manual tests that I’ve used in most examples,&#13;
FastAPI provides very nice automated test forms at the endpoints&#13;
<em>/docs</em> and <em>/redocs</em>.&#13;
They’re two different styles for the same information,&#13;
so I’ll just show a little from the <em>/docs</em> pages in <a data-type="xref" href="#fig-08-1">Figure 8-1</a>.</p>&#13;
&#13;
<figure><div class="figure" id="fig-08-1">&#13;
<img alt="Top docs page" src="assets/fapi_0801.png"/>&#13;
<h6><span class="label">Figure 8-1. </span>Generated documentation page</h6>&#13;
</div></figure>&#13;
&#13;
<p class="pagebreak-before">Try the first test:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Click the down-arrow to the right under the top&#13;
GET <code>/explorer/</code> section. That will open up a large light blue form.</p>&#13;
</li>&#13;
<li>&#13;
<p>Click the blue Execute button on the left. You’ll see the top section of the results in <a data-type="xref" href="#fig-08-2">Figure 8-2</a>.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<figure><div class="figure" id="fig-08-2">&#13;
<img alt="GET /explorer results page" src="assets/fapi_0802.png"/>&#13;
<h6><span class="label">Figure 8-2. </span>Generated results page for GET /explorer/</h6>&#13;
</div></figure>&#13;
&#13;
<p class="pagebreak-before">In the lower “Response body” section, you’ll see the JSON&#13;
returned for the (fake) explorer data that you’ve defined so far:</p>&#13;
&#13;
<pre data-type="programlisting">[&#13;
  {&#13;
    "name": "Claude Hande",&#13;
    "country": "FE",&#13;
    "description": "Scarce during full moons"&#13;
  },&#13;
  {&#13;
    "name": "Noah Weiser",&#13;
    "country": "DE",&#13;
    "description": "Myopic machete man"&#13;
  }&#13;
]</pre>&#13;
&#13;
<p>Try all the others. For some (like <code>GET /explorer/{name}</code>),&#13;
you’ll need to provide an input value.&#13;
You’ll get a response for each, even&#13;
though a few still do nothing until the database code is added. You can repeat these tests near the end of Chapters <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch09.html#ch09">9</a> and&#13;
<a data-type="xref" data-xrefstyle="select:labelnumber" href="ch10.html#ch10">10</a> to ensure that no data pipelines were punctured&#13;
during <a data-primary="FastAPI" data-secondary="automated test forms" data-startref="ibd031" data-type="indexterm" id="id642"/>these <a data-primary="testing" data-secondary="Web layer" data-startref="ibd030" data-type="indexterm" id="id643"/>code <a data-primary="Web layer" data-secondary="FastAPI automated test forms" data-startref="ibd0014" data-type="indexterm" id="id644"/>changes<a data-primary="Web layer" data-secondary="testing" data-startref="ibd013" data-type="indexterm" id="id645"/>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Talking to the Service and Data Layers" data-type="sect1"><div class="sect1" id="id197">&#13;
<h1>Talking to the Service and Data Layers</h1>&#13;
&#13;
<p><a data-primary="Web layer" data-secondary="Service layer and" data-type="indexterm" id="ibd015"/>Whenever <a data-primary="Web layer" data-secondary="Data layer and" data-type="indexterm" id="ibd016"/>a <a data-primary="Service layer" data-secondary="Web layer and" data-type="indexterm" id="ibd032"/>function<a data-primary="Data layer" data-secondary="Web layer and" data-type="indexterm" id="ibd033"/> in the Web layer needs data that is&#13;
managed by the Data layer, that function should ask the Service layer to&#13;
be an intermediary.&#13;
This requires more code and may seem unnecessary,&#13;
but it’s&#13;
a good idea:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>As the label on the jar says,&#13;
the Web layer deals with the web,&#13;
and the Data layer deals&#13;
with external data stores and services.&#13;
It’s much safer to keep their respective details&#13;
completely separate.</p>&#13;
</li>&#13;
<li>&#13;
<p>The layers can be tested independently.&#13;
Separation of layer&#13;
mechanisms allows this.</p>&#13;
</li>&#13;
</ul>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>For a very small site,&#13;
you could skip the Service layer if it doesn’t add any value.&#13;
<a data-type="xref" href="ch09.html#ch09">Chapter 9</a> initially defines service functions&#13;
that do little more than pass requests and responses&#13;
between the Web and Data layers.&#13;
At least keep the Web and Data layers separate, though.</p>&#13;
</div>&#13;
&#13;
<p>What does that Service layer function do?&#13;
You’ll see in the next chapter.&#13;
Hint: it talks to the Data layer,&#13;
but in a hushed voice so the Web layer doesn’t know&#13;
exactly what it’s saying.&#13;
But it also defines any specific business logic,&#13;
such as interactions between resources.&#13;
Mainly, the Web and Data layers should not care&#13;
what’s going on in there.&#13;
(The Service layer is a Secret Service.)</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Pagination and Sorting" data-type="sect1"><div class="sect1" id="id79">&#13;
<h1>Pagination and Sorting</h1>&#13;
&#13;
<p>In<a data-primary="Web layer" data-secondary="pagination" data-type="indexterm" id="id646"/> web <a data-primary="Web layer" data-secondary="sorting" data-type="indexterm" id="id647"/>interfaces<a data-primary="pagination" data-type="indexterm" id="id648"/>,&#13;
when<a data-primary="sorting" data-type="indexterm" id="id649"/> returning many or all things&#13;
with URL patterns like <code>GET</code> &#13;
<span class="keep-together"><em><code>/resource</code></em></span>,&#13;
you often want to request the lookup and&#13;
return of the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Only one thing</p>&#13;
</li>&#13;
<li>&#13;
<p>Possibly many things</p>&#13;
</li>&#13;
<li>&#13;
<p>All things</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>How do you get our well-meaning but extremely literal-minded&#13;
computer to do these things?&#13;
Well, for the first case,&#13;
the RESTful pattern that I mentioned earlier is to include&#13;
the resource’s ID in the URL path.&#13;
When getting multiple resources,&#13;
we may want to see the results in a particular order:</p>&#13;
<dl>&#13;
<dt>Sort</dt>&#13;
<dd>&#13;
<p>Order all the results,&#13;
even if you get only a set of them at a time.</p>&#13;
</dd>&#13;
<dt>Paginate</dt>&#13;
<dd>&#13;
<p>Return only some results at a time,&#13;
respecting any sorting.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>In each case,&#13;
a group of user-specified parameters indicates what you want.&#13;
It’s common to provide these as query parameters.&#13;
Here are some examples:</p>&#13;
<dl>&#13;
<dt>Sort</dt>&#13;
<dd>&#13;
<p><code>GET</code> <code>/explorer?sort=country</code>: Get all explorers, sorted by country code.</p>&#13;
</dd>&#13;
<dt>Paginate</dt>&#13;
<dd>&#13;
<p><code>GET</code> <code>/explorer?offset=10&amp;size=10</code>: Return&#13;
(in this case, unsorted)&#13;
explorers in places 10 through 19 of the whole list.</p>&#13;
</dd>&#13;
<dt>Both</dt>&#13;
<dd>&#13;
<p><code>GET</code> <code>/explorer?sort=country&amp;offset=10&amp;size=10</code></p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>Although you could specify these as individual query parameters,&#13;
FastAPI’s dependency injection can help:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Define the sort and paginate parameters&#13;
as a Pydantic model.</p>&#13;
</li>&#13;
<li>&#13;
<p>Provide the parameters model to the <code>get_all()</code> path function&#13;
with the <code>Depends</code> feature in the path&#13;
function arguments.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Where should the sorting&#13;
and pagination occur?&#13;
At first, it may seem simplest for the database queries&#13;
to pass full results up to the Web layer,&#13;
and use Python to carve up the data there.&#13;
But that isn’t very efficient.&#13;
These tasks usually fit best in the Data layer,&#13;
because databases are good at those things.&#13;
I’ll finally get around to some code for these in <a data-type="xref" href="ch17.html#ch17">Chapter 17</a>,&#13;
which has more database tidbits beyond those in <a data-type="xref" href="ch10.html#ch10">Chapter 10</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Review" data-type="sect1"><div class="sect1" id="id80">&#13;
<h1>Review</h1>&#13;
&#13;
<p>This chapter filled out more details from <a data-type="xref" href="ch03.html#ch03">Chapter 3</a> and others.&#13;
It began the process of making a full site for information&#13;
on imaginary creatures and their explorers.&#13;
Starting with the Web layer,&#13;
you defined endpoints with FastAPI&#13;
path decorators and path functions.&#13;
The path functions gather request data from wherever&#13;
they live in the HTTP request bytes.&#13;
Model data is automatically checked and validated by Pydantic.&#13;
Path functions generally pass arguments to corresponding service&#13;
functions, which are coming in the next chapter<a data-primary="Web layer" data-startref="ibd001" data-type="indexterm" id="id650"/>.</p>&#13;
</div></section>&#13;
</div></section></body></html>