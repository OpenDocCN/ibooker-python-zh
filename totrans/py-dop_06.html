<html><head></head><body><section data-pdf-bookmark="Chapter 6. Continuous Integration and Continuous Deployment" data-type="chapter" epub:type="chapter"><div class="chapter" id="CICD">&#13;
<h1><span class="label">Chapter 6. </span>Continuous Integration and <span class="keep-together">Continuous Deployment</span></h1>&#13;
&#13;
&#13;
<p><em>Author: Noah</em></p>&#13;
&#13;
<p><a data-primary="continuous integration/continuous deployment (CI/CD)" data-type="indexterm" id="ix_ch06-asciidoc0"/>The practices of continuous integration (CI) and continuous deployment (CD) are essential to a modern software development life cycle process. A CI system clones the codebase for the software under consideration from a source control system such as GitHub, builds the software into an artifact that can be a binary, a tar archive, or a Docker image, and, very importantly, also runs unit and/or integration tests for the software. A CD system deploys the artifacts built by the CI system to a target environment. This deployment can be automated for nonproduction environments, but usually includes a manual approval step for production. A more advanced type of such systems is a continuous delivery platform, which automates the deployment step to production and is capable of rolling back the deployment based on metrics obtained from monitoring and logging platforms.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Real-World Case Study: Converting a Poorly Maintained WordPress Site to Hugo" data-type="sect1"><div class="sect1" id="idm46691331487768">&#13;
<h1>Real-World Case Study: Converting a Poorly Maintained WordPress Site to Hugo</h1>&#13;
&#13;
<p><a data-primary="continuous integration/continuous deployment (CI/CD)" data-secondary="case study: converting a poorly maintained WordPress site to Hugo" data-type="indexterm" id="ix_ch06-asciidoc1"/><a data-primary="Hugo" data-secondary="converting WordPress site to" data-type="indexterm" id="ix_ch06-asciidoc2"/>A while back, a friend asked for a favor fixing their company website. The company sold very expensive, used scientific equipment and its inventory was served via a WordPress site that was frequently hacked, performed horribly, or was down for days. Typically I try to avoid getting sucked into projects like this, but since it was a friend, I decided to help. You can reference the code for the conversion project at this <a href="https://oreil.ly/myos1">Git repository</a>.</p>&#13;
&#13;
<p class="pagebreak-before">Each step of the conversion process is covered in the GitHub repo. The steps include:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Backup</p>&#13;
</li>&#13;
<li>&#13;
<p>Convert</p>&#13;
</li>&#13;
<li>&#13;
<p>Upgrade</p>&#13;
</li>&#13;
<li>&#13;
<p>Deploy</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>The story had a funny ending. After creating a bulletproof, “tank” of a website that had incredible performance, security, auto-deployment, and incredible SEO, it ran for years with zero vulnerabilities or downtime. Long after I had forgotten about the project, I got a text from my friend. It had been a couple years since I had last talked with him. He said the website was down and he needed my help.</p>&#13;
&#13;
<p>I texted back to him to ask how this was possible. It is running off Amazon S3 which has 99.999999999% uptime. He texted back that he had recently converted it back to WordPress because it was “easier” to make changes. I laughed and told him I wasn’t a good fit for his project. As they say, no good deed is left unpunished.</p>&#13;
</div>&#13;
&#13;
<p>Some of the requirements I considered were:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>It needed to be continuously deployed.</p>&#13;
</li>&#13;
<li>&#13;
<p>It needed to be fast to run and develop against!</p>&#13;
</li>&#13;
<li>&#13;
<p>It should be a static site hosted from a cloud provider.</p>&#13;
</li>&#13;
<li>&#13;
<p>There should be a reasonable workflow for converting from WordPress.</p>&#13;
</li>&#13;
<li>&#13;
<p>It should be possible to create a reasonable search interface using Python.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>In the end I decided to use <a href="https://gohugo.io">Hugo</a>, <a href="https://aws.amazon.com">AWS</a>, and <a href="https://www.algolia.com">Algolia</a>. The general architecture looked like <a data-type="xref" href="#Figure-6-1">Figure 6-1</a>.</p>&#13;
&#13;
<figure><div class="figure" id="Figure-6-1">&#13;
<img alt="pydo 0601" src="assets/pydo_0601.png"/>&#13;
<h6><span class="label">Figure 6-1. </span>Continuous deployment with Hugo</h6>&#13;
</div></figure>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Setting Up Hugo" data-type="sect2"><div class="sect2" id="idm46691331464424">&#13;
<h2>Setting Up Hugo</h2>&#13;
&#13;
<p><a data-primary="continuous integration/continuous deployment (CI/CD)" data-secondary="Hugo setup" data-type="indexterm" id="idm46691331462888"/><a data-primary="Hugo" data-secondary="setting up" data-type="indexterm" id="idm46691331461816"/>Getting started with Hugo is very straightforward (see the  <a href="https://oreil.ly/r_Rcg">getting started Hugo guide</a>). First, install the software. On my OS X machine I did it this way:</p>&#13;
&#13;
<pre data-type="programlisting">brew install hugo</pre>&#13;
&#13;
<p>If you already installed Hugo, you may need to upgrade:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">Error: hugo 0.40.3 is already installed&#13;
To upgrade to 0.57.2, run brew upgrade hugo.</pre>&#13;
&#13;
<p>If you are on another platform, you can follow <a href="https://oreil.ly/FfWdo">instructions here</a>. To verify things are working, run <code>hugo version</code>:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting"><code class="o">(</code>.python-devops<code class="o">)</code> ➜  ~ hugo version&#13;
Hugo Static Site Generator v0.57.2/extended darwin/amd64 BuildDate: unknown</pre>&#13;
&#13;
<p>The only thing left to do is to initialize a skeleton Hugo app and install a theme:</p>&#13;
&#13;
<pre data-type="programlisting">hugo new site quickstart</pre>&#13;
&#13;
<p>This creates a new site called <code>quickstart</code>. You can build this site again, VERY QUICKLY, by running <code>hugo</code>. This compiles the markdown files to HTML and CSS.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Converting WordPress to Hugo Posts" data-type="sect2"><div class="sect2" id="idm46691331463800">&#13;
<h2>Converting WordPress to Hugo Posts</h2>&#13;
&#13;
<p><a data-primary="continuous integration/continuous deployment (CI/CD)" data-secondary="converting WordPress to Hugo posts" data-type="indexterm" id="idm46691331441528"/><a data-primary="Hugo" data-secondary="converting WordPress posts to Hugo posts" data-type="indexterm" id="idm46691331440616"/>Next, I converted the WordPress database to JSON via a raw dump. Then I wrote a Python script to convert this data into Hugo posts in markdown format. Here is that code:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="sd">"""Conversion code of old database fields into markdown example.</code>&#13;
&#13;
<code class="sd">If you did a database dump of WordPress and then converted it to JSON, you could</code>&#13;
<code class="sd">tweak this."""</code>&#13;
&#13;
<code class="kn">import</code> <code class="nn">os</code>&#13;
<code class="kn">import</code> <code class="nn">shutil</code>&#13;
<code class="kn">from</code> <code class="nn">category</code> <code class="kn">import</code> <code class="n">CAT</code>&#13;
<code class="kn">from</code> <code class="nn">new_picture_products</code> <code class="kn">import</code> <code class="n">PICTURES</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">check_all_category</code><code class="p">():</code>&#13;
  <code class="n">ares</code> <code class="o">=</code> <code class="p">{}</code>&#13;
  <code class="n">REC</code> <code class="o">=</code> <code class="p">[]</code>&#13;
  <code class="k">for</code> <code class="n">pic</code> <code class="ow">in</code> <code class="n">PICTURES</code><code class="p">:</code>&#13;
    <code class="n">res</code>  <code class="o">=</code> <code class="n">check_category</code><code class="p">(</code><code class="n">pic</code><code class="p">)</code>&#13;
    <code class="k">if</code> <code class="ow">not</code> <code class="n">res</code><code class="p">:</code>&#13;
      <code class="n">pic</code><code class="p">[</code><code class="s2">"categories"</code><code class="p">]</code> <code class="o">=</code> <code class="s2">"Other"</code>&#13;
      <code class="n">REC</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">pic</code><code class="p">)</code>&#13;
      <code class="k">continue</code>&#13;
&#13;
    <code class="n">title</code><code class="p">,</code><code class="n">key</code> <code class="o">=</code> <code class="n">res</code>&#13;
    <code class="k">if</code> <code class="n">key</code><code class="p">:</code>&#13;
      <code class="k">print</code><code class="p">(</code><code class="s2">"FOUND MATCH: TITLE--[</code><code class="si">%s</code><code class="s2">], CATEGORY--[</code><code class="si">%s</code><code class="s2">]"</code> <code class="o">%</code>\&#13;
        <code class="p">(</code><code class="n">title</code><code class="p">,</code> <code class="n">key</code><code class="p">))</code>&#13;
      <code class="n">ares</code><code class="p">[</code><code class="n">title</code><code class="p">]</code><code class="o">=</code> <code class="n">key</code>&#13;
      <code class="n">pic</code><code class="p">[</code><code class="s2">"categories"</code><code class="p">]</code> <code class="o">=</code> <code class="n">key</code>&#13;
      <code class="n">REC</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">pic</code><code class="p">)</code>&#13;
  <code class="k">return</code> <code class="n">ares</code><code class="p">,</code> <code class="n">REC</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">check_category</code><code class="p">(</code><code class="n">rec</code><code class="p">):</code>&#13;
&#13;
  <code class="n">title</code> <code class="o">=</code> <code class="nb">str</code><code class="p">(</code><code class="n">rec</code><code class="p">[</code><code class="s1">'title'</code><code class="p">])</code>&#13;
  <code class="k">for</code> <code class="n">key</code><code class="p">,</code> <code class="n">values</code> <code class="ow">in</code> <code class="n">CAT</code><code class="o">.</code><code class="n">items</code><code class="p">():</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="s2">"KEY: </code><code class="si">%s</code><code class="s2">, VALUE: </code><code class="si">%s</code><code class="s2">"</code> <code class="o">%</code> <code class="p">(</code><code class="n">key</code><code class="p">,</code> <code class="n">values</code><code class="p">))</code>&#13;
    <code class="k">if</code> <code class="n">title</code> <code class="ow">in</code> <code class="n">key</code><code class="p">:</code>&#13;
      <code class="k">return</code> <code class="n">title</code><code class="p">,</code><code class="n">key</code>&#13;
    <code class="k">for</code> <code class="n">val</code> <code class="ow">in</code> <code class="n">values</code><code class="p">:</code>&#13;
      <code class="k">if</code> <code class="n">title</code> <code class="ow">in</code> <code class="n">val</code><code class="p">:</code>&#13;
        <code class="k">return</code> <code class="n">title</code><code class="p">,</code><code class="n">key</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">move_image</code><code class="p">(</code><code class="n">val</code><code class="p">):</code>&#13;
  <code class="sd">"""Creates a new copy of the uploaded images to img dir"""</code>&#13;
&#13;
  <code class="n">source_picture</code> <code class="o">=</code> <code class="s2">"static/uploads/</code><code class="si">%s</code><code class="s2">"</code> <code class="o">%</code> <code class="n">val</code><code class="p">[</code><code class="s2">"picture"</code><code class="p">]</code>&#13;
  <code class="n">destination_dir</code> <code class="o">=</code> <code class="s2">"static/img/"</code>&#13;
  <code class="n">shutil</code><code class="o">.</code><code class="n">copy</code><code class="p">(</code><code class="n">source_picture</code><code class="p">,</code> <code class="n">destination_dir</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">new_image_metadata</code><code class="p">(</code><code class="n">vals</code><code class="p">):</code>&#13;
  <code class="n">new_paths</code> <code class="o">=</code> <code class="p">[]</code>&#13;
  <code class="k">for</code> <code class="n">val</code> <code class="ow">in</code> <code class="n">vals</code><code class="p">:</code>&#13;
    <code class="n">pic</code> <code class="o">=</code> <code class="n">val</code><code class="p">[</code><code class="s1">'picture'</code><code class="p">]</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="s2">"/"</code><code class="p">)[</code><code class="o">-</code><code class="mi">1</code><code class="p">:]</code><code class="o">.</code><code class="n">pop</code><code class="p">()</code>&#13;
    <code class="n">destination_dir</code> <code class="o">=</code> <code class="s2">"static/img/</code><code class="si">%s</code><code class="s2">"</code> <code class="o">%</code> <code class="n">pic</code>&#13;
    <code class="n">val</code><code class="p">[</code><code class="s1">'picture'</code><code class="p">]</code> <code class="o">=</code> <code class="n">destination_dir</code>&#13;
    <code class="n">new_paths</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">val</code><code class="p">)</code>&#13;
  <code class="k">return</code> <code class="n">new_paths</code>&#13;
&#13;
<code class="n">CAT_LOOKUP</code> <code class="o">=</code> <code class="p">{</code><code class="s1">'2100'</code><code class="p">:</code> <code class="s1">'Foo'</code><code class="p">,</code>&#13;
 <code class="s1">'a'</code><code class="p">:</code> <code class="s1">'Biz'</code><code class="p">,</code>&#13;
 <code class="s1">'b'</code><code class="p">:</code> <code class="s1">'Bam'</code><code class="p">,</code>&#13;
 <code class="s1">'c'</code><code class="p">:</code> <code class="s1">'Bar'</code><code class="p">,</code>&#13;
 <code class="s1">'1'</code><code class="p">:</code> <code class="s1">'Foobar'</code><code class="p">,</code>&#13;
 <code class="s1">'2'</code><code class="p">:</code> <code class="s1">'bizbar'</code><code class="p">,</code>&#13;
 <code class="s1">'3'</code><code class="p">:</code> <code class="s1">'bam'</code><code class="p">}</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">write_post</code><code class="p">(</code><code class="n">val</code><code class="p">):</code>&#13;
&#13;
    <code class="n">tags</code> <code class="o">=</code> <code class="n">val</code><code class="p">[</code><code class="s2">"tags"</code><code class="p">]</code>&#13;
    <code class="n">date</code> <code class="o">=</code> <code class="n">val</code><code class="p">[</code><code class="s2">"date"</code><code class="p">]</code>&#13;
    <code class="n">title</code> <code class="o">=</code> <code class="n">val</code><code class="p">[</code><code class="s2">"title"</code><code class="p">]</code>&#13;
    <code class="n">picture</code> <code class="o">=</code> <code class="n">val</code><code class="p">[</code><code class="s2">"picture"</code><code class="p">]</code>&#13;
    <code class="n">categories</code> <code class="o">=</code> <code class="n">val</code><code class="p">[</code><code class="s2">"categories"</code><code class="p">]</code>&#13;
    <code class="n">out</code> <code class="o">=</code> <code class="s2">"""</code>&#13;
<code class="s2">+++</code>&#13;
<code class="s2">tags = ["</code><code class="si">%s</code><code class="s2">"]</code>&#13;
<code class="s2">categories = ["</code><code class="si">%s</code><code class="s2">"]</code>&#13;
<code class="s2">date = "</code><code class="si">%s</code><code class="s2">"</code>&#13;
<code class="s2">title = "</code><code class="si">%s</code><code class="s2">"</code>&#13;
<code class="s2">banner = "</code><code class="si">%s</code><code class="s2">"</code>&#13;
<code class="s2">+++</code>&#13;
<code class="s2">[![</code><code class="si">%s</code><code class="s2">](</code><code class="si">%s</code><code class="s2">)](</code><code class="si">%s</code><code class="s2">)</code>&#13;
<code class="s2"> **Product Name**: </code><code class="si">%s</code><code class="s2">"""</code> <code class="o">%</code>\&#13;
 <code class="p">(</code><code class="n">tags</code><code class="p">,</code> <code class="n">categories</code><code class="p">,</code> <code class="n">date</code><code class="p">,</code> <code class="n">title</code><code class="p">,</code> <code class="n">picture</code><code class="o">.</code><code class="n">lstrip</code><code class="p">(</code><code class="s2">"/"</code><code class="p">),</code>&#13;
   <code class="n">title</code><code class="p">,</code> <code class="n">picture</code><code class="p">,</code> <code class="n">picture</code><code class="p">,</code> <code class="n">title</code><code class="p">)</code>&#13;
&#13;
    <code class="n">filename</code> <code class="o">=</code> <code class="s2">"../content/blog/</code><code class="si">%s</code><code class="s2">.md"</code> <code class="o">%</code> <code class="n">title</code>&#13;
    <code class="k">if</code> <code class="n">os</code><code class="o">.</code><code class="n">path</code><code class="o">.</code><code class="n">exists</code><code class="p">(</code><code class="n">filename</code><code class="p">):</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="s2">"Removing: </code><code class="si">%s</code><code class="s2">"</code> <code class="o">%</code> <code class="n">filename</code><code class="p">)</code>&#13;
        <code class="n">os</code><code class="o">.</code><code class="n">unlink</code><code class="p">(</code><code class="n">filename</code><code class="p">)</code>&#13;
&#13;
    <code class="k">with</code> <code class="nb">open</code><code class="p">(</code><code class="n">filename</code><code class="p">,</code> <code class="s1">'a'</code><code class="p">)</code> <code class="k">as</code> <code class="n">the_file</code><code class="p">:</code>&#13;
        <code class="n">the_file</code><code class="o">.</code><code class="n">write</code><code class="p">(</code><code class="n">out</code><code class="p">)</code>&#13;
&#13;
<code class="k">if</code> <code class="nv-Magic">__name__</code> <code class="o">==</code> <code class="s1">'__main__'</code><code class="p">:</code>&#13;
    <code class="kn">from</code> <code class="nn">new_pic_category</code> <code class="kn">import</code> <code class="n">PRODUCT</code>&#13;
    <code class="k">for</code> <code class="n">product</code> <code class="ow">in</code> <code class="n">PRODUCT</code><code class="p">:</code>&#13;
        <code class="n">write_post</code><code class="p">(</code><code class="n">product</code><code class="p">)</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Creating an Algolia Index and Updating It" data-type="sect2"><div class="sect2" id="idm46691331451880">&#13;
<h2>Creating an Algolia Index and Updating It</h2>&#13;
&#13;
<p><a data-primary="Algolia index, creating/updating" data-type="indexterm" id="idm46691331450632"/><a data-primary="continuous integration/continuous deployment (CI/CD)" data-secondary="creating/updating Algolia index" data-type="indexterm" id="idm46691331449960"/>With the database products converted to markdown posts, the next step is to write some Python code that creates an Algolia index and syncs it. <a href="https://www.algolia.com">Algolia</a> is a great tool to use because it quickly solves the search engine problem and has nice Python support as well.</p>&#13;
&#13;
<p>This script crawls through all of the markdown files and generates a search index that can be uploaded to Algolia:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="sd">"""</code>&#13;
<code class="sd">Creates a very simple JSON index for Hugo to import into Algolia. Easy to extend.</code>&#13;
&#13;
<code class="sd">#might be useful to run this on content directory to remove spaces</code>&#13;
<code class="sd">for f in *\ *; do mv "$f" "${f// /_}"; done</code>&#13;
&#13;
<code class="sd">"""</code>&#13;
<code class="kn">import</code> <code class="nn">os</code>&#13;
<code class="kn">import</code> <code class="nn">json</code>&#13;
&#13;
<code class="n">CONTENT_ROOT</code> <code class="o">=</code> <code class="s2">"../content/products"</code>&#13;
<code class="n">CONFIG</code> <code class="o">=</code> <code class="s2">"../config.toml"</code>&#13;
<code class="n">INDEX_PATH</code> <code class="o">=</code> <code class="s2">"../index.json"</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">get_base_url</code><code class="p">():</code>&#13;
    <code class="k">for</code> <code class="n">line</code> <code class="ow">in</code> <code class="nb">open</code><code class="p">(</code><code class="n">CONFIG</code><code class="p">):</code>&#13;
        <code class="k">if</code> <code class="n">line</code><code class="o">.</code><code class="n">startswith</code><code class="p">(</code><code class="s2">"baseurl"</code><code class="p">):</code>&#13;
            <code class="n">url</code> <code class="o">=</code> <code class="n">line</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="s2">"="</code><code class="p">)[</code><code class="o">-</code><code class="mi">1</code><code class="p">]</code><code class="o">.</code><code class="n">strip</code><code class="p">()</code><code class="o">.</code><code class="n">strip</code><code class="p">(</code><code class="s1">'""'</code><code class="p">)</code>&#13;
            <code class="k">return</code> <code class="n">url</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">build_url</code><code class="p">(</code><code class="n">base_url</code><code class="p">,</code> <code class="n">title</code><code class="p">):</code>&#13;
&#13;
    <code class="n">url</code> <code class="o">=</code> <code class="s2">"&lt;a href='</code><code class="si">%s</code><code class="s2">products/</code><code class="si">%s</code><code class="s2">'&gt;</code><code class="si">%s</code><code class="s2">&lt;/a&gt;"</code> <code class="o">%</code>\&#13;
         <code class="p">(</code><code class="n">base_url</code><code class="o">.</code><code class="n">strip</code><code class="p">(),</code> <code class="n">title</code><code class="o">.</code><code class="n">lower</code><code class="p">(),</code> <code class="n">title</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">url</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">clean_title</code><code class="p">(</code><code class="n">title</code><code class="p">):</code>&#13;
    <code class="n">title_one</code> <code class="o">=</code> <code class="n">title</code><code class="o">.</code><code class="n">replace</code><code class="p">(</code><code class="s2">"_"</code><code class="p">,</code> <code class="s2">" "</code><code class="p">)</code>&#13;
    <code class="n">title_two</code> <code class="o">=</code> <code class="n">title_one</code><code class="o">.</code><code class="n">replace</code><code class="p">(</code><code class="s2">"-"</code><code class="p">,</code> <code class="s2">" "</code><code class="p">)</code>&#13;
    <code class="n">title_three</code> <code class="o">=</code> <code class="n">title_two</code><code class="o">.</code><code class="n">capitalize</code><code class="p">()</code>&#13;
    <code class="k">return</code> <code class="n">title_three</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">build_index</code><code class="p">():</code>&#13;
    <code class="n">baseurl</code> <code class="o">=</code> <code class="n">get_base_url</code><code class="p">()</code>&#13;
    <code class="n">index</code> <code class="o">=</code><code class="p">[]</code>&#13;
    <code class="n">posts</code> <code class="o">=</code> <code class="n">os</code><code class="o">.</code><code class="n">listdir</code><code class="p">(</code><code class="n">CONTENT_ROOT</code><code class="p">)</code>&#13;
    <code class="k">for</code> <code class="n">line</code> <code class="ow">in</code> <code class="n">posts</code><code class="p">:</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="s2">"FILE NAME: </code><code class="si">%s</code><code class="s2">"</code> <code class="o">%</code> <code class="n">line</code><code class="p">)</code>&#13;
        <code class="n">record</code> <code class="o">=</code> <code class="p">{}</code>&#13;
        <code class="n">title</code> <code class="o">=</code> <code class="n">line</code><code class="o">.</code><code class="n">strip</code><code class="p">(</code><code class="s2">".md"</code><code class="p">)</code>&#13;
        <code class="n">record</code><code class="p">[</code><code class="s1">'url'</code><code class="p">]</code> <code class="o">=</code> <code class="n">build_url</code><code class="p">(</code><code class="n">baseurl</code><code class="p">,</code> <code class="n">title</code><code class="p">)</code>&#13;
        <code class="n">record</code><code class="p">[</code><code class="s1">'title'</code><code class="p">]</code> <code class="o">=</code> <code class="n">clean_title</code><code class="p">(</code><code class="n">title</code><code class="p">)</code>&#13;
        <code class="k">print</code><code class="p">(</code><code class="s2">"INDEX RECORD: </code><code class="si">%s</code><code class="s2">"</code> <code class="o">%</code> <code class="n">record</code><code class="p">)</code>&#13;
        <code class="n">index</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">record</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">index</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">write_index</code><code class="p">():</code>&#13;
    <code class="n">index</code> <code class="o">=</code> <code class="n">build_index</code><code class="p">()</code>&#13;
    <code class="k">with</code> <code class="nb">open</code><code class="p">(</code><code class="n">INDEX_PATH</code><code class="p">,</code> <code class="s1">'w'</code><code class="p">)</code> <code class="k">as</code> <code class="n">outfile</code><code class="p">:</code>&#13;
        <code class="n">json</code><code class="o">.</code><code class="n">dump</code><code class="p">(</code><code class="n">index</code><code class="p">,</code><code class="n">outfile</code><code class="p">)</code>&#13;
&#13;
<code class="k">if</code> <code class="nv-Magic">__name__</code> <code class="o">==</code> <code class="s1">'__main__'</code><code class="p">:</code>&#13;
    <code class="n">write_index</code><code class="p">()</code></pre>&#13;
&#13;
<p>Finally, the index can be sent to Algolia with this snippet:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">json</code>&#13;
<code class="kn">from</code> <code class="nn">algoliasearch</code> <code class="kn">import</code> <code class="n">algoliasearch</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">update_index</code><code class="p">():</code>&#13;
    <code class="sd">"""Deletes index, then updates it"""</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="s2">"Starting Updating Index"</code><code class="p">)</code>&#13;
    <code class="n">client</code> <code class="o">=</code> <code class="n">algoliasearch</code><code class="o">.</code><code class="n">Client</code><code class="p">(</code><code class="s2">"YOUR_KEY"</code><code class="p">,</code> <code class="s2">"YOUR_VALUE"</code><code class="p">)</code>&#13;
    <code class="n">index</code> <code class="o">=</code> <code class="n">client</code><code class="o">.</code><code class="n">init_index</code><code class="p">(</code><code class="s2">"your_INDEX"</code><code class="p">)</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="s2">"Clearing index"</code><code class="p">)</code>&#13;
    <code class="n">index</code><code class="o">.</code><code class="n">clear_index</code><code class="p">()</code>&#13;
    <code class="k">print</code><code class="p">(</code><code class="s2">"Loading index"</code><code class="p">)</code>&#13;
    <code class="n">batch</code> <code class="o">=</code> <code class="n">json</code><code class="o">.</code><code class="n">load</code><code class="p">(</code><code class="nb">open</code><code class="p">(</code><code class="s1">'../index.json'</code><code class="p">))</code>&#13;
    <code class="n">index</code><code class="o">.</code><code class="n">add_objects</code><code class="p">(</code><code class="n">batch</code><code class="p">)</code>&#13;
&#13;
<code class="k">if</code> <code class="nv-Magic">__name__</code> <code class="o">==</code> <code class="s1">'__main__'</code><code class="p">:</code>&#13;
    <code class="n">update_index</code><code class="p">()</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Orchestrating with a Makefile" data-type="sect2"><div class="sect2" id="idm46691330995896">&#13;
<h2>Orchestrating with a Makefile</h2>&#13;
&#13;
<p><a data-primary="continuous integration/continuous deployment (CI/CD)" data-secondary="orchestrating with Makefile" data-type="indexterm" id="idm46691330995000"/><a data-primary="Makefile, orchestrating with" data-type="indexterm" id="idm46691330838936"/>Using a <code>Makefile</code> allows you to replicate the steps your deployment process will use later. I typically set up a <code>Makefile</code> to orchestrate this locally. Here is what the entire build and deploy process looks like:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">build:&#13;
  rm -rf public&#13;
  hugo&#13;
&#13;
watch: clean&#13;
  hugo server -w&#13;
&#13;
create-index:&#13;
  <code class="nb">cd </code>algolia<code class="p">;</code>python make_algolia_index.py<code class="p">;</code><code class="nb">cd</code> ..&#13;
&#13;
update-index:&#13;
  <code class="nb">cd </code>algolia<code class="p">;</code>python sync_algolia_index.py<code class="p">;</code><code class="nb">cd</code> ..&#13;
&#13;
make-index: create-index update-index&#13;
&#13;
clean:&#13;
  -rm -rf public&#13;
&#13;
sync:&#13;
  aws s3 --profile &lt;yourawsprofile&gt; sync --acl <code class="se">\</code>&#13;
    <code class="s2">"public-read"</code> public/ s3://example.com&#13;
&#13;
build-deploy-local: build sync&#13;
&#13;
all: build-deploy-local</pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Deploying with AWS CodePipeline" data-type="sect2"><div class="sect2" id="idm46691330828136">&#13;
<h2>Deploying with AWS CodePipeline</h2>&#13;
&#13;
<p><a data-primary="AWS (Amazon Web Services)" data-secondary="Code Pipeline" data-type="indexterm" id="idm46691330826952"/><a data-primary="continuous integration/continuous deployment (CI/CD)" data-secondary="AWS Code Pipeline" data-type="indexterm" id="idm46691330826040"/><a data-primary="continuous integration/continuous deployment (CI/CD)" data-secondary="deployment with AWS Code Pipeline" data-type="indexterm" id="idm46691330825000"/>Amazon Web Services (AWS) is a common deployment target for hosting a static website via Amazon S3, Amazon Route 53, and Amazon CloudFront. AWS CodePipeline, their build server service, works very well as the deployment mechanism for these sites. You can log into AWS CodePipeline, set up a new build project, and tell it to use a <em>buildspec.yml</em> file. The code can be customized and the portions that are templated out can be replaced with actual values.</p>&#13;
&#13;
<p>As soon as GitHub gets a change event, CodePipeline runs the install in a container. First it grabs the specific version of Hugo specified. Next it builds the Hugo pages. Thousands of Hugo pages can be rendered subsecond because of the speed of Go.</p>&#13;
&#13;
<p>Finally, the HTML pages are synced to Amazon S3. Because this is running inside of AWS and is synced, it is also extremely fast. The final step is that CloudFront is <span class="keep-together">invalidated:</span><a data-startref="ix_ch06-asciidoc2" data-type="indexterm" id="idm46691330771256"/><a data-startref="ix_ch06-asciidoc1" data-type="indexterm" id="idm46691330770552"/></p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">version: 0.1&#13;
&#13;
environment_variables:&#13;
  plaintext:&#13;
    HUGO_VERSION: <code class="s2">"0.42"</code>&#13;
&#13;
phases:&#13;
  install:&#13;
    commands:&#13;
      - <code class="nb">cd</code> /tmp&#13;
      - wget https://github.com/gohugoio/hugo/releases/<code class="se">\</code>&#13;
      download/v<code class="si">${</code><code class="nv">HUGO_VERSION</code><code class="si">}</code>/hugo_<code class="si">${</code><code class="nv">HUGO_VERSION</code><code class="si">}</code>_Linux-64bit.tar.gz&#13;
      - tar -xzf hugo_<code class="si">${</code><code class="nv">HUGO_VERSION</code><code class="si">}</code>_Linux-64bit.tar.gz&#13;
      - mv hugo /usr/bin/hugo&#13;
      - <code class="nb">cd</code> -&#13;
      - rm -rf /tmp/*&#13;
  build:&#13;
    commands:&#13;
      - rm -rf public&#13;
      - hugo&#13;
  post_build:&#13;
    commands:&#13;
      - aws s3 sync public/ s3://&lt;yourwebsite&gt;.com/ --region us-west-2 --delete&#13;
      - aws s3 cp s3://&lt;yourwebsite&gt;.com/<code class="se">\</code>&#13;
      s3://&lt;yourwebsite&gt;.com/ --metadata-directive REPLACE <code class="se">\</code>&#13;
        --cache-control <code class="s1">'max-age=604800'</code> --recursive&#13;
      - aws cloudfront create-invalidation --distribution-id<code class="o">=</code>&lt;YOURID&gt; --paths <code class="s1">'/*'</code>&#13;
      - <code class="nb">echo </code>Build completed on <code class="sb">`</code>date<code class="sb">`</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Real-World Case Study: Deploying a Python App Engine Application with Google Cloud Build" data-type="sect1"><div class="sect1" id="idm46691330292888">&#13;
<h1>Real-World Case Study: Deploying a Python App Engine Application with Google Cloud Build</h1>&#13;
&#13;
<p><a data-primary="continuous integration/continuous deployment (CI/CD)" data-secondary="case study: deploying a Python App Engine application with Google Cloud Build" data-type="indexterm" id="ix_ch06-asciidoc3"/><a data-primary="Google Cloud Build" data-type="indexterm" id="ix_ch06-asciidoc4"/><a data-primary="Python App Engine" data-type="indexterm" id="ix_ch06-asciidoc5"/>Back in 2008 I wrote the very first article on using Google App Engine. You have to use the Wayback Machine to get it from the <a href="https://oreil.ly/8LoIf">O’Reilly blog</a>.</p>&#13;
&#13;
<p>Here is a reboot for the modern era. This is another version of Google App Engine, but this time it uses <a href="https://oreil.ly/MllhM">Google Cloud Build</a>. The Google Cloud Platform (GCP) Cloud Build works a lot like AWS CodePipeline. Here is a config file that is checked into a GitHub repo. The config file is named <em>cloudbuild.yaml</em>. You can see all of the source code for this project <a href="https://oreil.ly/vxsnc">in this Git repository</a>:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">steps:&#13;
- name: python:3.7&#13;
  id: INSTALL&#13;
  entrypoint: python3&#13;
  args:&#13;
  - <code class="s1">'-m'</code>&#13;
  - <code class="s1">'pip'</code>&#13;
  - <code class="s1">'install'</code>&#13;
  - <code class="s1">'-t'</code>&#13;
  - <code class="s1">'.'</code>&#13;
  - <code class="s1">'-r'</code>&#13;
  - <code class="s1">'requirements.txt'</code>&#13;
- name: python:3.7&#13;
  entrypoint: ./pylint_runner&#13;
  id: LINT&#13;
  waitFor:&#13;
  - INSTALL&#13;
- name: <code class="s2">"gcr.io/cloud-builders/gcloud"</code>&#13;
  args: <code class="o">[</code><code class="s2">"app"</code>, <code class="s2">"deploy"</code><code class="o">]</code>&#13;
timeout: <code class="s2">"1600s"</code>&#13;
images: <code class="o">[</code><code class="s1">'gcr.io/$PROJECT_ID/pylint'</code><code class="o">]</code></pre>&#13;
&#13;
<p>Note that the <em>cloudbuild.yaml</em> file installs the packages seen here in the <em>requirements.txt</em> file and also runs <code>gcloud app deploy</code>, which deploys the App Engine application on check-in to GitHub:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting"><code class="nv">Flask</code><code class="o">==</code>1.0.2&#13;
<code class="nv">gunicorn</code><code class="o">==</code>19.9.0&#13;
<code class="nv">pylint</code><code class="o">==</code>2.3.1</pre>&#13;
&#13;
<p class="pagebreak-before">Here is a walk-through of how to set up this entire project:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Create the project.</p>&#13;
</li>&#13;
<li>&#13;
<p>Activate the cloud shell.</p>&#13;
</li>&#13;
<li>&#13;
<p>Refer to the <a href="https://oreil.ly/zgf5J">hello world docs for the Python 3 App Engine</a>.</p>&#13;
</li>&#13;
<li>&#13;
<p>Run <a data-primary="describe() method" data-type="indexterm" id="idm46691330273768"/><code>describe</code>:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">verify project is working&#13;
<code class="sb">```</code>bash&#13;
gcloud projects describe <code class="nv">$GOOGLE_CLOUD_PROJECT</code>&#13;
<code class="sb">```</code>&#13;
output of <code class="nb">command</code>:&#13;
<code class="sb">```</code>bash&#13;
createTime: <code class="s1">'2019-05-29T21:21:10.187Z'</code>&#13;
lifecycleState: ACTIVE&#13;
name: helloml&#13;
projectId: helloml-xxxxx&#13;
projectNumber: <code class="s1">'881692383648'</code>&#13;
<code class="sb">```</code></pre>&#13;
</li>&#13;
<li>&#13;
<p>You may want to verify that you have the correct project. If not, do this to switch:</p>&#13;
&#13;
<pre data-type="programlisting">gcloud config set project $GOOGLE_CLOUD_PROJECT</pre>&#13;
</li>&#13;
<li>&#13;
<p>Create the App Engine app:</p>&#13;
&#13;
<pre data-type="programlisting">gcloud app create</pre>&#13;
&#13;
<p>This will ask for the region. Go ahead and pick <code>us-central [12]</code>.</p>&#13;
&#13;
<pre data-type="programlisting">Creating App Engine application in project [helloml-xxx]&#13;
and region [us-central]....done.&#13;
Success! The app is now created.&#13;
Please use `gcloud app deploy` to deploy your first app.</pre>&#13;
</li>&#13;
<li>&#13;
<p>Clone the hello world sample app repo:</p>&#13;
&#13;
<pre data-type="programlisting">git clone https://github.com/GoogleCloudPlatform/python-docs-samples</pre>&#13;
</li>&#13;
<li>&#13;
<p><code>cd</code> into the repo:</p>&#13;
&#13;
<pre data-type="programlisting">cd python-docs-samples/appengine/standard_python37/hello_world</pre>&#13;
</li>&#13;
<li>&#13;
<p>Update the Cloudshell image (note that this is optional):</p>&#13;
&#13;
<pre data-type="programlisting">git clone https://github.com/noahgift/gcp-hello-ml.git&#13;
# Update .cloudshellcustomimagerepo.json with project and image name&#13;
# TIP: enable "Boost Mode" in in Cloudshell&#13;
cloudshell env build-local&#13;
cloudshell env push&#13;
cloudshell env update-default-image&#13;
# Restart Cloudshell VM</pre>&#13;
</li>&#13;
<li>&#13;
<p>Create and source the virtual environment:</p>&#13;
&#13;
<pre data-type="programlisting">virtualenv --python $(which python) venv&#13;
source venv/bin/activate</pre>&#13;
&#13;
<p>Double-check that it works:</p>&#13;
&#13;
<pre data-type="programlisting">which python&#13;
/home/noah_gift/python-docs-samples/appengine/\&#13;
  standard_python37/hello_world/venv/bin/python</pre>&#13;
</li>&#13;
<li>&#13;
<p>Activate the cloud shell editor.</p>&#13;
</li>&#13;
<li>&#13;
<p>Install the packages:</p>&#13;
&#13;
<pre data-type="programlisting">pip install -r requirements.txt</pre>&#13;
&#13;
<p>This should install Flask:</p>&#13;
&#13;
<pre data-type="programlisting">Flask==1.0.2</pre>&#13;
</li>&#13;
<li>&#13;
<p>Run Flask locally. This runs Flask locally in the GCP shell:</p>&#13;
&#13;
<pre data-type="programlisting">python main.py</pre>&#13;
</li>&#13;
<li>&#13;
<p>Use the web preview (see <a data-type="xref" href="#Figure-6-2">Figure 6-2</a>).</p>&#13;
&#13;
<figure><div class="figure" id="Figure-6-2">&#13;
<img alt="pydo 0602" src="assets/pydo_0602.png"/>&#13;
<h6><span class="label">Figure 6-2. </span>Web preview</h6>&#13;
</div></figure>&#13;
</li>&#13;
<li>&#13;
<p>Update <em>main.py</em>:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">flask</code> <code class="kn">import</code> <code class="n">Flask</code>&#13;
<code class="kn">from</code> <code class="nn">flask</code> <code class="kn">import</code> <code class="n">jsonify</code>&#13;
&#13;
<code class="n">app</code> <code class="o">=</code> <code class="n">Flask</code><code class="p">(</code><code class="nv-Magic">__name__</code><code class="p">)</code>&#13;
&#13;
<code class="nd">@app.route</code><code class="p">(</code><code class="s1">'/'</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">hello</code><code class="p">():</code>&#13;
    <code class="sd">"""Return a friendly HTTP greeting."""</code>&#13;
    <code class="k">return</code> <code class="s1">'Hello I like to make AI Apps'</code>&#13;
&#13;
<code class="nd">@app.route</code><code class="p">(</code><code class="s1">'/name/&lt;value&gt;'</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">name</code><code class="p">(</code><code class="n">value</code><code class="p">):</code>&#13;
    <code class="n">val</code> <code class="o">=</code> <code class="p">{</code><code class="s2">"value"</code><code class="p">:</code> <code class="n">value</code><code class="p">}</code>&#13;
    <code class="k">return</code> <code class="n">jsonify</code><code class="p">(</code><code class="n">val</code><code class="p">)</code>&#13;
&#13;
<code class="k">if</code> <code class="nv-Magic">__name__</code> <code class="o">==</code> <code class="s1">'__main__'</code><code class="p">:</code>&#13;
    <code class="n">app</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="n">host</code><code class="o">=</code><code class="s1">'127.0.0.1'</code><code class="p">,</code> <code class="n">port</code><code class="o">=</code><code class="mi">8080</code><code class="p">,</code> <code class="n">debug</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code></pre>&#13;
</li>&#13;
<li>&#13;
<p>Test out passing in parameters to exercise this function:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="nd">@app.route</code><code class="p">(</code><code class="s1">'/name/&lt;value&gt;'</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">name</code><code class="p">(</code><code class="n">value</code><code class="p">):</code>&#13;
    <code class="n">val</code> <code class="o">=</code> <code class="p">{</code><code class="s2">"value"</code><code class="p">:</code> <code class="n">value</code><code class="p">}</code>&#13;
    <code class="k">return</code> <code class="n">jsonify</code><code class="p">(</code><code class="n">val</code><code class="p">)</code></pre>&#13;
&#13;
<p>For example, calling this route will take the word <em>lion</em> and pass it into the name function in Flask:</p>&#13;
&#13;
<pre data-type="programlisting">https://8080-dot-3104625-dot-devshell.appspot.com/name/lion</pre>&#13;
&#13;
<p>Returns a value in the web browser:</p>&#13;
&#13;
<pre data-type="programlisting">{&#13;
value: "lion"&#13;
}</pre>&#13;
</li>&#13;
<li>&#13;
<p>Now deploy the app:</p>&#13;
&#13;
<pre data-type="programlisting">gcloud app deploy</pre>&#13;
&#13;
<p>Be warned! The first deploy could take about 10 minutes. You might also need to enable the cloud build API.</p>&#13;
&#13;
<pre data-type="programlisting">Do you want to continue (Y/n)?  y&#13;
Beginning deployment of service [default]...&#13;
╔════════════════════════════════════════════════════════════╗&#13;
╠═ Uploading 934 files to Google Cloud Storage              ═╣</pre>&#13;
</li>&#13;
<li>&#13;
<p>Now stream the log files:</p>&#13;
&#13;
<pre data-type="programlisting">gcloud app logs tail -s default</pre>&#13;
</li>&#13;
<li>&#13;
<p>The production app is deployed and should like this:</p>&#13;
&#13;
<pre data-type="programlisting">Setting traffic split for service [default]...done.&#13;
Deployed service [default] to [https://helloml-xxx.appspot.com]&#13;
You can stream logs from the command line by running:&#13;
  $ gcloud app logs tail -s default&#13;
&#13;
  $ gcloud app browse&#13;
(venv) noah_gift@cloudshell:~/python-docs-samples/appengine/\&#13;
  standard_python37/hello_world (helloml-242121)$ gcloud app&#13;
 logs tail -s default&#13;
Waiting for new log entries...&#13;
2019-05-29 22:45:02 default[2019]  [2019-05-29 22:45:02 +0000] [8]&#13;
2019-05-29 22:45:02 default[2019]  [2019-05-29 22:45:02 +0000] [8]&#13;
 (8)&#13;
2019-05-29 22:45:02 default[2019]  [2019-05-29 22:45:02 +0000] [8]&#13;
2019-05-29 22:45:02 default[2019]  [2019-05-29 22:45:02 +0000] [25]&#13;
2019-05-29 22:45:02 default[2019]  [2019-05-29 22:45:02 +0000] [27]&#13;
2019-05-29 22:45:04 default[2019]  "GET /favicon.ico HTTP/1.1" 404&#13;
2019-05-29 22:46:25 default[2019]  "GET /name/usf HTTP/1.1" 200</pre>&#13;
</li>&#13;
<li>&#13;
<p>Add a new route and test it out:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="nd">@app.route</code><code class="p">(</code><code class="s1">'/html'</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">html</code><code class="p">():</code>&#13;
    <code class="sd">"""Returns some custom HTML"""</code>&#13;
    <code class="k">return</code> <code class="s2">"""</code>&#13;
<code class="s2">    &lt;title&gt;This is a Hello World World Page&lt;/title&gt;</code>&#13;
<code class="s2">    &lt;p&gt;Hello&lt;/p&gt;</code>&#13;
<code class="s2">    &lt;p&gt;&lt;b&gt;World&lt;/b&gt;&lt;/p&gt;</code>&#13;
<code class="s2">    """</code></pre>&#13;
</li>&#13;
<li>&#13;
<p>Install Pandas and return JSON results. At this point, you may want to consider creating a <code>Makefile</code> and doing this:</p>&#13;
&#13;
<pre data-type="programlisting">touch Makefile&#13;
#this goes inside that file&#13;
install:&#13;
  pip install -r requirements.txt</pre>&#13;
&#13;
<p>You also may want to set up lint:</p>&#13;
&#13;
<pre data-type="programlisting">pylint --disable=R,C main.py&#13;
------------------------------------&#13;
Your code has been rated at 10.00/10</pre>&#13;
&#13;
<p>The web route syntax looks like the following block. Add Pandas import at the top:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">pandas</code> <code class="kn">as</code> <code class="nn">pd</code>&#13;
&#13;
<code class="nd">@app.route</code><code class="p">(</code><code class="s1">'/pandas'</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">pandas_sugar</code><code class="p">():</code>&#13;
    <code class="n">df</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">read_csv</code><code class="p">(</code>&#13;
      <code class="s2">"https://raw.githubusercontent.com/noahgift/sugar/</code><code class="se">\</code>&#13;
<code class="s2">      master/data/education_sugar_cdc_2003.csv"</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">jsonify</code><code class="p">(</code><code class="n">df</code><code class="o">.</code><code class="n">to_dict</code><code class="p">())</code></pre>&#13;
&#13;
<p>When you call the route https://&lt;yourapp&gt;.appspot.com/pandas, you should get something like <a data-type="xref" href="#Figure-6-3">Figure 6-3</a>.</p>&#13;
&#13;
<figure><div class="figure" id="Figure-6-3">&#13;
<img alt="pydo 0603" src="assets/pydo_0603.png"/>&#13;
<h6><span class="label">Figure 6-3. </span>Example of JSON out</h6>&#13;
</div></figure>&#13;
</li>&#13;
<li>&#13;
<p>Add this Wikipedia route:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">wikipedia</code>&#13;
<code class="nd">@app.route</code><code class="p">(</code><code class="s1">'/wikipedia/&lt;company&gt;'</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">wikipedia_route</code><code class="p">(</code><code class="n">company</code><code class="p">):</code>&#13;
    <code class="n">result</code> <code class="o">=</code> <code class="n">wikipedia</code><code class="o">.</code><code class="n">summary</code><code class="p">(</code><code class="n">company</code><code class="p">,</code> <code class="n">sentences</code><code class="o">=</code><code class="mi">10</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">result</code></pre>&#13;
</li>&#13;
<li>&#13;
<p>Add NLP to the app:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Run <a href="https://oreil.ly/c564z">IPython Notebook</a>.</p>&#13;
</li>&#13;
<li>&#13;
<p>Enable the Cloud Natural Language API.</p>&#13;
</li>&#13;
<li>&#13;
<p>Run <code>pip install google-cloud-language</code>:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">1</code><code class="p">]:</code> <code class="kn">from</code> <code class="nn">google.cloud</code> <code class="kn">import</code> <code class="n">language</code>&#13;
   <code class="o">...</code><code class="p">:</code> <code class="kn">from</code> <code class="nn">google.cloud.language</code> <code class="kn">import</code> <code class="n">enums</code>&#13;
   <code class="o">...</code><code class="p">:</code>&#13;
   <code class="o">...</code><code class="p">:</code> <code class="kn">from</code> <code class="nn">google.cloud.language</code> <code class="kn">import</code> <code class="n">types</code>&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">2</code><code class="p">]:</code>&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">2</code><code class="p">]:</code> <code class="n">text</code> <code class="o">=</code> <code class="s2">"LeBron James plays for the Cleveland Cavaliers."</code>&#13;
   <code class="o">...</code><code class="p">:</code> <code class="n">client</code> <code class="o">=</code> <code class="n">language</code><code class="o">.</code><code class="n">LanguageServiceClient</code><code class="p">()</code>&#13;
   <code class="o">...</code><code class="p">:</code> <code class="n">document</code> <code class="o">=</code> <code class="n">types</code><code class="o">.</code><code class="n">Document</code><code class="p">(</code>&#13;
   <code class="o">...</code><code class="p">:</code>         <code class="n">content</code><code class="o">=</code><code class="n">text</code><code class="p">,</code>&#13;
   <code class="o">...</code><code class="p">:</code>         <code class="nb">type</code><code class="o">=</code><code class="n">enums</code><code class="o">.</code><code class="n">Document</code><code class="o">.</code><code class="n">Type</code><code class="o">.</code><code class="n">PLAIN_TEXT</code><code class="p">)</code>&#13;
   <code class="o">...</code><code class="p">:</code> <code class="n">entities</code> <code class="o">=</code> <code class="n">client</code><code class="o">.</code><code class="n">analyze_entities</code><code class="p">(</code><code class="n">document</code><code class="p">)</code><code class="o">.</code><code class="n">entities</code>&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">3</code><code class="p">]:</code> <code class="n">entities</code></pre>&#13;
</li>&#13;
&#13;
</ol>&#13;
</li>&#13;
<li>&#13;
<p>Here is an end-to-end AI API example:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">flask</code> <code class="kn">import</code> <code class="n">Flask</code>&#13;
<code class="kn">from</code> <code class="nn">flask</code> <code class="kn">import</code> <code class="n">jsonify</code>&#13;
<code class="kn">import</code> <code class="nn">pandas</code> <code class="kn">as</code> <code class="nn">pd</code>&#13;
<code class="kn">import</code> <code class="nn">wikipedia</code>&#13;
&#13;
<code class="n">app</code> <code class="o">=</code> <code class="n">Flask</code><code class="p">(</code><code class="nv-Magic">__name__</code><code class="p">)</code>&#13;
&#13;
<code class="nd">@app.route</code><code class="p">(</code><code class="s1">'/'</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">hello</code><code class="p">():</code>&#13;
    <code class="sd">"""Return a friendly HTTP greeting."""</code>&#13;
    <code class="k">return</code> <code class="s1">'Hello I like to make AI Apps'</code>&#13;
&#13;
<code class="nd">@app.route</code><code class="p">(</code><code class="s1">'/name/&lt;value&gt;'</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">name</code><code class="p">(</code><code class="n">value</code><code class="p">):</code>&#13;
    <code class="n">val</code> <code class="o">=</code> <code class="p">{</code><code class="s2">"value"</code><code class="p">:</code> <code class="n">value</code><code class="p">}</code>&#13;
    <code class="k">return</code> <code class="n">jsonify</code><code class="p">(</code><code class="n">val</code><code class="p">)</code>&#13;
&#13;
<code class="nd">@app.route</code><code class="p">(</code><code class="s1">'/html'</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">html</code><code class="p">():</code>&#13;
    <code class="sd">"""Returns some custom HTML"""</code>&#13;
    <code class="k">return</code> <code class="s2">"""</code>&#13;
<code class="s2">    &lt;title&gt;This is a Hello World World Page&lt;/title&gt;</code>&#13;
<code class="s2">    &lt;p&gt;Hello&lt;/p&gt;</code>&#13;
<code class="s2">    &lt;p&gt;&lt;b&gt;World&lt;/b&gt;&lt;/p&gt;</code>&#13;
<code class="s2">    """</code>&#13;
<code class="nd">@app.route</code><code class="p">(</code><code class="s1">'/pandas'</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">pandas_sugar</code><code class="p">():</code>&#13;
    <code class="n">df</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">read_csv</code><code class="p">(</code>&#13;
      <code class="s2">"https://raw.githubusercontent.com/noahgift/sugar/</code><code class="se">\</code>&#13;
<code class="s2">      master/data/education_sugar_cdc_2003.csv"</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">jsonify</code><code class="p">(</code><code class="n">df</code><code class="o">.</code><code class="n">to_dict</code><code class="p">())</code>&#13;
&#13;
<code class="nd">@app.route</code><code class="p">(</code><code class="s1">'/wikipedia/&lt;company&gt;'</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">wikipedia_route</code><code class="p">(</code><code class="n">company</code><code class="p">):</code>&#13;
&#13;
    <code class="c1"># Imports the Google Cloud client library</code>&#13;
    <code class="kn">from</code> <code class="nn">google.cloud</code> <code class="kn">import</code> <code class="n">language</code>&#13;
    <code class="kn">from</code> <code class="nn">google.cloud.language</code> <code class="kn">import</code> <code class="n">enums</code>&#13;
    <code class="kn">from</code> <code class="nn">google.cloud.language</code> <code class="kn">import</code> <code class="n">types</code>&#13;
    <code class="n">result</code> <code class="o">=</code> <code class="n">wikipedia</code><code class="o">.</code><code class="n">summary</code><code class="p">(</code><code class="n">company</code><code class="p">,</code> <code class="n">sentences</code><code class="o">=</code><code class="mi">10</code><code class="p">)</code>&#13;
&#13;
    <code class="n">client</code> <code class="o">=</code> <code class="n">language</code><code class="o">.</code><code class="n">LanguageServiceClient</code><code class="p">()</code>&#13;
    <code class="n">document</code> <code class="o">=</code> <code class="n">types</code><code class="o">.</code><code class="n">Document</code><code class="p">(</code>&#13;
        <code class="n">content</code><code class="o">=</code><code class="n">result</code><code class="p">,</code>&#13;
        <code class="nb">type</code><code class="o">=</code><code class="n">enums</code><code class="o">.</code><code class="n">Document</code><code class="o">.</code><code class="n">Type</code><code class="o">.</code><code class="n">PLAIN_TEXT</code><code class="p">)</code>&#13;
    <code class="n">entities</code> <code class="o">=</code> <code class="n">client</code><code class="o">.</code><code class="n">analyze_entities</code><code class="p">(</code><code class="n">document</code><code class="p">)</code><code class="o">.</code><code class="n">entities</code>&#13;
    <code class="k">return</code> <code class="nb">str</code><code class="p">(</code><code class="n">entities</code><code class="p">)</code>&#13;
&#13;
&#13;
<code class="k">if</code> <code class="nv-Magic">__name__</code> <code class="o">==</code> <code class="s1">'__main__'</code><code class="p">:</code>&#13;
    <code class="n">app</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="n">host</code><code class="o">=</code><code class="s1">'127.0.0.1'</code><code class="p">,</code> <code class="n">port</code><code class="o">=</code><code class="mi">8080</code><code class="p">,</code> <code class="n">debug</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code></pre>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>This section has shown how to both set up an App Engine application from scratch in the Google Cloud Shell, as well as how to do continuous delivery using GCP Cloud Build.<a data-startref="ix_ch06-asciidoc5" data-type="indexterm" id="idm46691329755944"/><a data-startref="ix_ch06-asciidoc4" data-type="indexterm" id="idm46691329755336"/><a data-startref="ix_ch06-asciidoc3" data-type="indexterm" id="idm46691329754728"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Real-World Case Study: NFSOPS" data-type="sect1"><div class="sect1" id="idm46691329753928">&#13;
<h1>Real-World Case Study: NFSOPS</h1>&#13;
&#13;
<p><a data-primary="continuous integration/continuous deployment (CI/CD)" data-secondary="case study: NFSOPS" data-type="indexterm" id="idm46691329542888"/><a data-primary="NFSOPS" data-type="indexterm" id="idm46691329541880"/>NFOPS is an operational technique that uses NFS (Network File System) mount points to manage clusters of computers. It sounds like it is a new thing, but it has been around since Unix has been around. Noah used NFS mount points on Caltech’s Unix systems back in 2000 to manage and maintain software. What is old is new again.</p>&#13;
&#13;
<p>As a part-time consultant at a virtual reality startup in San Francisco, one problem I faced was how to build a jobs framework, quickly, that would dispatch work to thousands of AWS Spot Instances.</p>&#13;
&#13;
<p>The solution that ultimately worked was to use NFSOPS (<a data-type="xref" href="#Figure-6-4">Figure 6-4</a>) to deploy Python code to thousands of Computer Vision Spot Instances subsecond.</p>&#13;
&#13;
<figure><div class="figure" id="Figure-6-4">&#13;
<img alt="pydo 0604" src="assets/pydo_0604.png"/>&#13;
<h6><span class="label">Figure 6-4. </span>NFSOPS</h6>&#13;
</div></figure>&#13;
&#13;
<p>NFSOPS works by using a build server, in this case Jenkins, to mount several Amazon Elastic File System (EFS) mount points (DEV, STAGE, PROD). When a continuous integration build is performed, the final step is an <code>rsync</code> to the respective mount point:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting"><code class="c">#Jenkins deploy build step</code>&#13;
rsync -az --delete * /dev-efs/code/</pre>&#13;
&#13;
<p>The “deploy” is then subsecond to the mount point. When spot instances are launched by the thousands, they are preconfigured to mount EFS (the NFS mount points) and use the source code. This is a handy deployment pattern that optimizes for simplicity and speed. It can also work quite well in tandom with IAC, Amazon Machine Image (AMI), or Ansible.<a data-startref="ix_ch06-asciidoc0" data-type="indexterm" id="idm46691329512568"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>