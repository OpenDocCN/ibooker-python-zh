<html><head></head><body><section data-pdf-bookmark="Chapter 10. Data Layer" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch10">&#13;
<h1><span class="label">Chapter 10. </span>Data Layer</h1>&#13;
&#13;
<blockquote>&#13;
<p>If I’m not mistaken, I think Data was the comic relief on the show.</p>&#13;
<p data-type="attribution">Brent Spiner, <cite><em>Star Trek: The Next Generation</em></cite></p>&#13;
</blockquote>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Preview" data-type="sect1"><div class="sect1" id="id86">&#13;
<h1>Preview</h1>&#13;
&#13;
<p><a data-primary="Data layer" data-type="indexterm" id="ibd044"/>This chapter finally creates a persistent home for our site’s data,&#13;
at last connecting the three layers.&#13;
It uses the relational database SQLite&#13;
and introduces Python’s database API, aptly named DB-API.&#13;
<a data-type="xref" href="ch14.html#ch14">Chapter 14</a> goes into much more detail on databases,&#13;
including the SQLAlchemy package and nonrelational&#13;
databases.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="DB-API" data-type="sect1"><div class="sect1" id="id203">&#13;
<h1>DB-API</h1>&#13;
&#13;
<p><a data-primary="Data layer" data-secondary="DB-API" data-type="indexterm" id="ibd045"/>For<a data-primary="DB-API" data-secondary="Data layer" data-type="indexterm" id="ibd052"/> over 20 years,&#13;
Python has included a basic definition for&#13;
a relational database interface called DB-API:&#13;
<a href="https://oreil.ly/4Gp9T">PEP 249</a>.&#13;
Anyone who writes a Python driver for a relational database&#13;
is expected to at least include support for DB-API,&#13;
although other features may be included.</p>&#13;
&#13;
<p>These are the <a data-primary="DB-API" data-secondary="main functions of" data-type="indexterm" id="ibd058"/>main DB-API functions:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Create a connection <code>conn</code> to the database with <code>connect()</code>.</p>&#13;
</li>&#13;
<li>&#13;
<p>Create a cursor <code>curs</code> with <code>conn.cursor()</code>.</p>&#13;
</li>&#13;
<li>&#13;
<p>Execute a SQL string <code>stmt</code> with <code>curs.execute(stmt)</code>.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p class="pagebreak-before">The <code>execute...()</code> functions run a SQL statement <code><em>stmt</em></code> string&#13;
with optional parameters, listed here:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><code>execute(<em>stmt</em>)</code> if there are no parameters</p>&#13;
</li>&#13;
<li>&#13;
<p><code>execute(<em>stmt</em>, <em>params</em>)</code>, with parameters <code><em>params</em></code> in a single&#13;
sequence (list or tuple) or dict</p>&#13;
</li>&#13;
<li>&#13;
<p><code>executemany(<em>stmt</em>, <em>params_seq</em>)</code>, with multiple parameter groups&#13;
in the sequence<a data-primary="DB-API" data-secondary="main functions of" data-startref="ibd058" data-type="indexterm" id="id667"/> <code><em>params_seq</em></code></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>There are five ways of <a data-primary="DB-API" data-secondary="specifying parameters" data-type="indexterm" id="id668"/>specifying parameters,&#13;
and not all are supported by all database drivers.&#13;
If we have a statement <code><em>stmt</em></code> that begins with&#13;
<code>"select * from creature where"</code>,&#13;
and we want to specify string parameters for&#13;
the creature’s <code>name</code> <em>or</em> <code>country</code>,&#13;
the rest of the <code><em>stmt</em></code> string and its parameters&#13;
would look like those in <a data-type="xref" href="#table-10-1">Table 10-1</a>.</p>&#13;
<table id="table-10-1">&#13;
<caption><span class="label">Table 10-1. </span>Specifying the statement and parameters</caption>&#13;
<thead>&#13;
<tr>&#13;
<th>Type</th>&#13;
<th>Statement part</th>&#13;
<th>Parameters part</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p>qmark</p></td>&#13;
<td><p><code>name=? or country=?</code></p></td>&#13;
<td><p><code>(<em>name</em>, <em>country</em>)</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>numeric</p></td>&#13;
<td><p><code>name=:0 or country=:1</code></p></td>&#13;
<td><p><code>(<em>name</em>, <em>country</em>)</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>format</p></td>&#13;
<td><p><code>name=%s or country=%s</code></p></td>&#13;
<td><p><code>(<em>name</em>, <em>country</em>)</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>named</p></td>&#13;
<td><p><code>name=:name or country=:country</code></p></td>&#13;
<td><p><code>{"name": <em>name</em>, "country": <em>​coun⁠try</em>}</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>pyformat</p></td>&#13;
<td><p><code>name=%(name)s or country=%(country)s</code></p></td>&#13;
<td><p><code>{"name": <em>name</em>, "country": <em>​coun⁠try</em>}</code></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
&#13;
<p>The first three take a tuple argument, where the parameter&#13;
order matches the <code>?</code>, <code>:N</code>, or <code>%s</code> in the statement.&#13;
The last two take a dictionary, where the keys match the&#13;
names in the statement.</p>&#13;
&#13;
<p>So, the full call for the <em>named</em> style would look like&#13;
<a data-type="xref" href="#ex-10-1">Example 10-1</a>.</p>&#13;
<div data-type="example" id="ex-10-1">&#13;
<h5><span class="label">Example 10-1. </span>Using named-style parameters.</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="n">stmt</code> <code class="o">=</code> <code class="s2">"""select * from creature where</code>&#13;
<code class="s2">    name=:name or country=:country"""</code>&#13;
<code class="n">params</code> <code class="o">=</code> <code class="p">{</code><code class="s2">"name"</code><code class="p">:</code> <code class="s2">"yeti"</code><code class="p">,</code> <code class="s2">"country"</code><code class="p">:</code> <code class="s2">"CN"</code><code class="p">}</code>&#13;
<code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">stmt</code><code class="p">,</code> <code class="n">params</code><code class="p">)</code></pre></div>&#13;
&#13;
<p class="pagebreak-before">For SQL <code>INSERT</code>, <code>DELETE</code>, and <code>UPDATE</code> statements,&#13;
the returned value from <code>execute()</code> tells you how it worked.&#13;
For <code>SELECT</code>,&#13;
you iterate over returned data row(s), as Python tuples,&#13;
with a <code>fetch</code> method:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><code>fetchone()</code> returns one tuple, or <code>None</code>.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>fetchall()</code> returns a sequence of tuples.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>fetchmany(<em>num</em>)</code> returns up to <code><em>num</em></code> <a data-primary="DB-API" data-secondary="Data layer" data-startref="ibd052" data-type="indexterm" id="id669"/>tuples<a data-primary="Data layer" data-secondary="DB-API" data-startref="ibd045" data-type="indexterm" id="id670"/>.</p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="SQLite" data-type="sect1"><div class="sect1" id="id87">&#13;
<h1>SQLite</h1>&#13;
&#13;
<p><a data-primary="Data layer" data-secondary="SQLite" data-type="indexterm" id="ibd046"/>Python<a data-primary="SQLite" data-secondary="Data layer" data-type="indexterm" id="ibd053"/> <a data-primary="sqlite3" data-type="indexterm" id="id671"/>includes support for one database&#13;
(<a href="https://www.sqlite.org">SQLite</a>)&#13;
with the module&#13;
<a href="https://oreil.ly/CcYtJ">sqlite3</a>&#13;
in its standard packages.</p>&#13;
&#13;
<p>SQLite is unusual: it has no separate database server.&#13;
All the code is in a library,&#13;
and storage is in a single file.&#13;
Other databases run separate servers,&#13;
and clients communicate with them over TCP/IP,&#13;
using specific protocols.&#13;
Let’s use SQLite as the first physical data store for this website.&#13;
<a data-type="xref" href="ch14.html#ch14">Chapter 14</a> will include other databases, relational and not,&#13;
as well as more advanced packages like SQLAlchemy and&#13;
techniques like ORMs.</p>&#13;
&#13;
<p>First, we need to define how the data structures we’ve been using in&#13;
the website (<em>models</em>) can be represented in the database.&#13;
So far, our only models have been simple and similar,&#13;
but not identical:&#13;
<code>Creature</code> and <code>Explorer</code>.&#13;
They will change as we think of more things to do with them and let the data evolve without massive code changes.</p>&#13;
&#13;
<p><a data-type="xref" href="#ex-10-2">Example 10-2</a> shows the bare DB-API code and SQL to create&#13;
and work with the first tables.&#13;
It uses <em>named</em> argument strings (values&#13;
are represented like <code><em>name</em></code>),&#13;
which are supported by the sqlite3 package.</p>&#13;
<div data-type="example" id="ex-10-2">&#13;
<h5><span class="label">Example 10-2. </span>Create the file <span class="plain">data/creature.py</span> using sqlite3</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">sqlite3</code>&#13;
<code class="kn">from</code> <code class="nn">model.creature</code> <code class="kn">import</code> <code class="n">Creature</code>&#13;
&#13;
<code class="n">DB_NAME</code> <code class="o">=</code> <code class="s2">"cryptid.db"</code>&#13;
<code class="n">conn</code> <code class="o">=</code> <code class="n">sqlite3</code><code class="o">.</code><code class="n">connect</code><code class="p">(</code><code class="n">DB_NAME</code><code class="p">)</code>&#13;
<code class="n">curs</code> <code class="o">=</code> <code class="n">conn</code><code class="o">.</code><code class="n">cursor</code><code class="p">()</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">init</code><code class="p">():</code>&#13;
    <code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s2">"create table creature(name, description, country, area, aka)"</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">row_to_model</code><code class="p">(</code><code class="n">row</code><code class="p">:</code> <code class="nb">tuple</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Creature</code><code class="p">:</code>&#13;
    <code class="n">name</code><code class="p">,</code> <code class="n">description</code><code class="p">,</code> <code class="n">country</code><code class="p">,</code> <code class="n">area</code><code class="p">,</code> <code class="n">aka</code> <code class="o">=</code> <code class="n">row</code>&#13;
    <code class="k">return</code> <code class="n">Creature</code><code class="p">(</code><code class="n">name</code><code class="p">,</code> <code class="n">description</code><code class="p">,</code> <code class="n">country</code><code class="p">,</code> <code class="n">area</code><code class="p">,</code> <code class="n">aka</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">model_to_dict</code><code class="p">(</code><code class="n">creature</code><code class="p">:</code> <code class="n">Creature</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">dict</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">creature</code><code class="o">.</code><code class="n">dict</code><code class="p">()</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">get_one</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Creature</code><code class="p">:</code>&#13;
    <code class="n">qry</code> <code class="o">=</code> <code class="s2">"select * from creature where name=:name"</code>&#13;
    <code class="n">params</code> <code class="o">=</code> <code class="p">{</code><code class="s2">"name"</code><code class="p">:</code> <code class="n">name</code><code class="p">}</code>&#13;
    <code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">qry</code><code class="p">,</code> <code class="n">params</code><code class="p">)</code>&#13;
    <code class="n">row</code> <code class="o">=</code> <code class="n">curs</code><code class="o">.</code><code class="n">fetchone</code><code class="p">()</code>&#13;
    <code class="k">return</code> <code class="n">row_to_model</code><code class="p">(</code><code class="n">row</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">get_all</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">list</code><code class="p">[</code><code class="n">Creature</code><code class="p">]:</code>&#13;
    <code class="n">qry</code> <code class="o">=</code> <code class="s2">"select * from creature"</code>&#13;
    <code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">qry</code><code class="p">)</code>&#13;
    <code class="n">rows</code> <code class="o">=</code> <code class="nb">list</code><code class="p">(</code><code class="n">curs</code><code class="o">.</code><code class="n">fetchall</code><code class="p">())</code>&#13;
    <code class="k">return</code> <code class="p">[</code><code class="n">row_to_model</code><code class="p">(</code><code class="n">row</code><code class="p">)</code> <code class="k">for</code> <code class="n">row</code> <code class="ow">in</code> <code class="n">rows</code><code class="p">]</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">create</code><code class="p">(</code><code class="n">creature</code><code class="p">:</code> <code class="n">Creature</code><code class="p">):</code>&#13;
    <code class="n">qry</code> <code class="o">=</code> <code class="s2">"""insert into creature values</code>&#13;
<code class="s2">          (:name, :description, :country, :area, :aka)"""</code>&#13;
    <code class="n">params</code> <code class="o">=</code> <code class="n">model_to_dict</code><code class="p">(</code><code class="n">creature</code><code class="p">)</code>&#13;
    <code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">qry</code><code class="p">,</code> <code class="n">params</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">modify</code><code class="p">(</code><code class="n">creature</code><code class="p">:</code> <code class="n">Creature</code><code class="p">):</code>&#13;
    <code class="k">return</code> <code class="n">creature</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">replace</code><code class="p">(</code><code class="n">creature</code><code class="p">:</code> <code class="n">Creature</code><code class="p">):</code>&#13;
    <code class="k">return</code> <code class="n">creature</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">delete</code><code class="p">(</code><code class="n">creature</code><code class="p">:</code> <code class="n">Creature</code><code class="p">):</code>&#13;
    <code class="n">qry</code> <code class="o">=</code> <code class="s2">"delete from creature where name = :name"</code>&#13;
    <code class="n">params</code> <code class="o">=</code> <code class="p">{</code><code class="s2">"name"</code><code class="p">:</code> <code class="n">creature</code><code class="o">.</code><code class="n">name</code><code class="p">}</code>&#13;
    <code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">qry</code><code class="p">,</code> <code class="n">params</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>Near the top, the <code>init()</code> function makes the connection to&#13;
sqlite3 and the database fake <em>cryptid.db</em>.&#13;
It stores this in the variable <code>conn</code>;&#13;
this is global within the <em>data/creature.py</em> module.&#13;
Next, the <code>curs</code> variable is a <em>cursor</em> for iterating&#13;
over data returned by executing a SQL <code>SELECT</code> statement;&#13;
it’s also global to the module.</p>&#13;
&#13;
<p>Two utility functions translate between Pydantic models&#13;
and DB-API:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><code>row_to_model()</code> converts a tuple returned by a <em>fetch</em>&#13;
function to a model object.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>model_to_dict()</code> translates a Pydantic model to a&#13;
dictionary, suitable for use as a <em>named</em> query parameter.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The fake CRUD functions that&#13;
have been present so far in each layer down&#13;
(Web → Service → Data)&#13;
will now be replaced.&#13;
They use only plain SQL and the DB-API methods<a data-primary="SQLite" data-secondary="Data layer" data-startref="ibd053" data-type="indexterm" id="id672"/> in<a data-primary="Data layer" data-secondary="SQLite" data-startref="ibd046" data-type="indexterm" id="id673"/> sqlite3.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before less_space" data-pdf-bookmark="Layout" data-type="sect1"><div class="sect1" id="id204">&#13;
<h1>Layout</h1>&#13;
&#13;
<p><a data-primary="Data layer" data-secondary="layout" data-type="indexterm" id="id674"/>So far, (fake) data has been modified in steps:</p>&#13;
<ol>&#13;
<li>&#13;
<p>In <a data-type="xref" href="ch08.html#ch08">Chapter 8</a>, we made the fake <code><em>creatures</em></code> list in <em>web/creature.py</em>.</p>&#13;
</li>&#13;
<li>&#13;
<p>In <a data-type="xref" href="ch08.html#ch08">Chapter 8</a>, we made the fake <code><em>explorers</em></code> list in <em>web/explorer.py</em>.</p>&#13;
</li>&#13;
<li>&#13;
<p>In <a data-type="xref" href="ch09.html#ch09">Chapter 9</a>, we moved fake <code><em>creatures</em></code> to <em>service/creature.py</em>.</p>&#13;
</li>&#13;
<li>&#13;
<p>In <a data-type="xref" href="ch09.html#ch09">Chapter 9</a>, we moved fake <code><em>explorers</em></code> to <em>service/explorer.py</em>.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>Now the data has moved for the last time,&#13;
down to&#13;
<em>data/creature.py</em>.&#13;
But it’s not fake anymore:&#13;
it’s real live data,&#13;
persisting in the SQLite database file <em>cryptids.db</em>.&#13;
Creature data, again by lack of imagination,&#13;
is stored in the SQL table <code>creature</code> in this <span class="keep-together">database</span>.</p>&#13;
&#13;
<p>Once you save this new file,&#13;
Uvicorn should restart from your top <em>main.py</em>,&#13;
which calls <em>web/creature.py</em>,&#13;
which calls <em>service/creature.py</em>,&#13;
and finally down to this new <em>data/creature.py</em>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Making It Work" data-type="sect1"><div class="sect1" id="id88">&#13;
<h1>Making It Work</h1>&#13;
&#13;
<p><a data-primary="Data layer" data-secondary="database information at startup time" data-type="indexterm" id="ibd048"/>We have one small problem:&#13;
this module never calls its <code>init()</code>&#13;
function,&#13;
so there’s no SQLite <code>conn</code> or <code>curs</code> for the&#13;
other functions to use. This a configuration issue:&#13;
how do we provide the database information at startup time?&#13;
Possibilities include the <span class="keep-together">following</span>:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Hardwiring the database info in the code, as in <a data-type="xref" href="#ex-10-2">Example 10-2</a>.</p>&#13;
</li>&#13;
<li>&#13;
<p>Passing the info down through the layers.&#13;
But this would violate&#13;
the separation of layers;&#13;
the Web and Service layers should not know the internals&#13;
of the Data layer.</p>&#13;
</li>&#13;
<li>&#13;
<p>Passing the info from a different external source, such as</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>A config file</p>&#13;
</li>&#13;
<li>&#13;
<p>An environment variable</p>&#13;
</li>&#13;
</ul>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The environment variable is simple&#13;
and is endorsed by recommendations <a data-primary="Twelve-Factor App" data-type="indexterm" id="id675"/>like the&#13;
<a href="https://12factor.net/config">Twelve-Factor App</a>.&#13;
The code can include a default value if&#13;
the environment variable isn’t specified.&#13;
This approach can also be used in testing,&#13;
to provide a separate test database from the production one.</p>&#13;
&#13;
<p>In <a data-type="xref" href="#ex-10-3">Example 10-3</a>,&#13;
let’s define an environment variable called&#13;
<code>CRYPTID_SQLITE_DB</code>, with the default value <code>cryptid.db</code>.&#13;
Make a new file called <em>data/init.py</em> for&#13;
the new database initialization code&#13;
so it can also be reused for the explorer code.</p>&#13;
<div data-type="example" id="ex-10-3">&#13;
<h5><span class="label">Example 10-3. </span>New data initialization module <span class="plain">data/init.py</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="sd">"""Initialize SQLite database"""</code>&#13;
&#13;
<code class="kn">import</code> <code class="nn">os</code>&#13;
<code class="kn">from</code> <code class="nn">pathlib</code> <code class="kn">import</code> <code class="n">Path</code>&#13;
<code class="kn">from</code> <code class="nn">sqlite3</code> <code class="kn">import</code> <code class="n">connect</code><code class="p">,</code> <code class="n">Connection</code><code class="p">,</code> <code class="n">Cursor</code><code class="p">,</code> <code class="n">IntegrityError</code>&#13;
&#13;
<code class="n">conn</code><code class="p">:</code> <code class="n">Connection</code> <code class="o">|</code> <code class="kc">None</code> <code class="o">=</code> <code class="kc">None</code>&#13;
<code class="n">curs</code><code class="p">:</code> <code class="n">Cursor</code> <code class="o">|</code> <code class="kc">None</code> <code class="o">=</code> <code class="kc">None</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">get_db</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="o">|</code><code class="kc">None</code> <code class="o">=</code> <code class="kc">None</code><code class="p">,</code> <code class="n">reset</code><code class="p">:</code> <code class="nb">bool</code> <code class="o">=</code> <code class="kc">False</code><code class="p">):</code>&#13;
    <code class="sd">"""Connect to SQLite database file"""</code>&#13;
    <code class="k">global</code> <code class="n">conn</code><code class="p">,</code> <code class="n">curs</code>&#13;
    <code class="k">if</code> <code class="n">conn</code><code class="p">:</code>&#13;
        <code class="k">if</code> <code class="ow">not</code> <code class="n">reset</code><code class="p">:</code>&#13;
            <code class="k">return</code>&#13;
        <code class="n">conn</code> <code class="o">=</code> <code class="kc">None</code>&#13;
    <code class="k">if</code> <code class="ow">not</code> <code class="n">name</code><code class="p">:</code>&#13;
        <code class="n">name</code> <code class="o">=</code> <code class="n">os</code><code class="o">.</code><code class="n">getenv</code><code class="p">(</code><code class="s2">"CRYPTID_SQLITE_DB"</code><code class="p">)</code>&#13;
        <code class="n">top_dir</code> <code class="o">=</code> <code class="n">Path</code><code class="p">(</code><code class="vm">__file__</code><code class="p">)</code><code class="o">.</code><code class="n">resolve</code><code class="p">()</code><code class="o">.</code><code class="n">parents</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code> <code class="c1"># repo top</code>&#13;
        <code class="n">db_dir</code> <code class="o">=</code> <code class="n">top_dir</code> <code class="o">/</code> <code class="s2">"db"</code>&#13;
        <code class="n">db_name</code> <code class="o">=</code> <code class="s2">"cryptid.db"</code>&#13;
        <code class="n">db_path</code> <code class="o">=</code> <code class="nb">str</code><code class="p">(</code><code class="n">db_dir</code> <code class="o">/</code> <code class="n">db_name</code><code class="p">)</code>&#13;
        <code class="n">name</code> <code class="o">=</code> <code class="n">os</code><code class="o">.</code><code class="n">getenv</code><code class="p">(</code><code class="s2">"CRYPTID_SQLITE_DB"</code><code class="p">,</code> <code class="n">db_path</code><code class="p">)</code>&#13;
    <code class="n">conn</code> <code class="o">=</code> <code class="n">connect</code><code class="p">(</code><code class="n">name</code><code class="p">,</code> <code class="n">check_same_thread</code><code class="o">=</code><code class="kc">False</code><code class="p">)</code>&#13;
    <code class="n">curs</code> <code class="o">=</code> <code class="n">conn</code><code class="o">.</code><code class="n">cursor</code><code class="p">()</code>&#13;
&#13;
<code class="n">get_db</code><code class="p">()</code></pre></div>&#13;
&#13;
<p>A Python module is a<a data-primary="singletons" data-type="indexterm" id="id676"/> <em>singleton</em>, called only once despite multiple imports.&#13;
So, the initialization code in <em>init.py</em> is run only once, when the first import of it occurs.</p>&#13;
&#13;
<p>Last, modify <em>data/creature.py</em>&#13;
in <a data-type="xref" href="#ex-10-4">Example 10-4</a>&#13;
to use this new module&#13;
instead:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Mainly, drop lines 4 through 8.</p>&#13;
</li>&#13;
<li>&#13;
<p>Oh, and create the <code>creature</code> table in the&#13;
first place!</p>&#13;
</li>&#13;
<li>&#13;
<p>The table fields are all SQL <code>text</code> strings.&#13;
This is the default column type in SQLite&#13;
(unlike most SQL databases),&#13;
so you didn’t need to&#13;
include <code>text</code> earlier, but&#13;
being explicit doesn’t hurt.</p>&#13;
</li>&#13;
<li>&#13;
<p>The <code>if not exists</code> avoids clobbering the table&#13;
after it’s been created.</p>&#13;
</li>&#13;
<li>&#13;
<p>The <code>name</code> field is the explicit <code>primary key</code> for this table.&#13;
If this table ever houses lots of explorer data,&#13;
that key will be necessary for fast lookups.&#13;
The alternative is the dreaded <em>table scan</em>,&#13;
where the database code needs to look at every row until&#13;
it finds a match for <code>name</code>.</p>&#13;
</li>&#13;
</ul>&#13;
<div data-type="example" id="ex-10-4">&#13;
<h5><span class="label">Example 10-4. </span>Add database configuration to <span class="plain">data/creature.py</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">.init</code> <code class="kn">import</code> <code class="n">conn</code><code class="p">,</code> <code class="n">curs</code>&#13;
<code class="kn">from</code> <code class="nn">model.creature</code> <code class="kn">import</code> <code class="n">Creature</code>&#13;
&#13;
<code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s2">"""create table if not exists creature(</code>&#13;
<code class="s2">                name text primary key,</code>&#13;
<code class="s2">                description text,</code>&#13;
<code class="s2">                country text,</code>&#13;
<code class="s2">                area text,</code>&#13;
<code class="s2">                aka text)"""</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">row_to_model</code><code class="p">(</code><code class="n">row</code><code class="p">:</code> <code class="nb">tuple</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Creature</code><code class="p">:</code>&#13;
    <code class="p">(</code><code class="n">name</code><code class="p">,</code> <code class="n">description</code><code class="p">,</code> <code class="n">country</code><code class="p">,</code> <code class="n">area</code><code class="p">,</code> <code class="n">aka</code><code class="p">)</code> <code class="o">=</code> <code class="n">row</code>&#13;
    <code class="k">return</code> <code class="n">Creature</code><code class="p">(</code><code class="n">name</code><code class="p">,</code> <code class="n">description</code><code class="p">,</code> <code class="n">country</code><code class="p">,</code> <code class="n">area</code><code class="p">,</code> <code class="n">aka</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">model_to_dict</code><code class="p">(</code><code class="n">creature</code><code class="p">:</code> <code class="n">Creature</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">dict</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">creature</code><code class="o">.</code><code class="n">dict</code><code class="p">()</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">get_one</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Creature</code><code class="p">:</code>&#13;
    <code class="n">qry</code> <code class="o">=</code> <code class="s2">"select * from creature where name=:name"</code>&#13;
    <code class="n">params</code> <code class="o">=</code> <code class="p">{</code><code class="s2">"name"</code><code class="p">:</code> <code class="n">name</code><code class="p">}</code>&#13;
    <code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">qry</code><code class="p">,</code> <code class="n">params</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">row_to_model</code><code class="p">(</code><code class="n">curs</code><code class="o">.</code><code class="n">fetchone</code><code class="p">())</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">get_all</code><code class="p">()</code> <code class="o">-&gt;</code> <code class="nb">list</code><code class="p">[</code><code class="n">Creature</code><code class="p">]:</code>&#13;
    <code class="n">qry</code> <code class="o">=</code> <code class="s2">"select * from creature"</code>&#13;
    <code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">qry</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="p">[</code><code class="n">row_to_model</code><code class="p">(</code><code class="n">row</code><code class="p">)</code> <code class="k">for</code> <code class="n">row</code> <code class="ow">in</code> <code class="n">curs</code><code class="o">.</code><code class="n">fetchall</code><code class="p">()]</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">create</code><code class="p">(</code><code class="n">creature</code><code class="p">:</code> <code class="n">Creature</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Creature</code><code class="p">:</code>&#13;
    <code class="n">qry</code> <code class="o">=</code> <code class="s2">"insert into creature values"</code>&#13;
          <code class="s2">"(:name, :description, :country, :area, :aka)"</code>&#13;
    <code class="n">params</code> <code class="o">=</code> <code class="n">model_to_dict</code><code class="p">(</code><code class="n">creature</code><code class="p">)</code>&#13;
    <code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">qry</code><code class="p">,</code> <code class="n">params</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">get_one</code><code class="p">(</code><code class="n">creature</code><code class="o">.</code><code class="n">name</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">modify</code><code class="p">(</code><code class="n">creature</code><code class="p">:</code> <code class="n">Creature</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Creature</code><code class="p">:</code>&#13;
    <code class="n">qry</code> <code class="o">=</code> <code class="s2">"""update creature</code>&#13;
<code class="s2">             set country=:country,</code>&#13;
<code class="s2">                 name=:name,</code>&#13;
<code class="s2">                 description=:description,</code>&#13;
<code class="s2">                 area=:area,</code>&#13;
<code class="s2">                 aka=:aka</code>&#13;
<code class="s2">             where name=:name_orig"""</code>&#13;
    <code class="n">params</code> <code class="o">=</code> <code class="n">model_to_dict</code><code class="p">(</code><code class="n">creature</code><code class="p">)</code>&#13;
    <code class="n">params</code><code class="p">[</code><code class="s2">"name_orig"</code><code class="p">]</code> <code class="o">=</code> <code class="n">creature</code><code class="o">.</code><code class="n">name</code>&#13;
    <code class="n">_</code> <code class="o">=</code> <code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">qry</code><code class="p">,</code> <code class="n">params</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">get_one</code><code class="p">(</code><code class="n">creature</code><code class="o">.</code><code class="n">name</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">delete</code><code class="p">(</code><code class="n">creature</code><code class="p">:</code> <code class="n">Creature</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">bool</code><code class="p">:</code>&#13;
    <code class="n">qry</code> <code class="o">=</code> <code class="s2">"delete from creature where name = :name"</code>&#13;
    <code class="n">params</code> <code class="o">=</code> <code class="p">{</code><code class="s2">"name"</code><code class="p">:</code> <code class="n">creature</code><code class="o">.</code><code class="n">name</code><code class="p">}</code>&#13;
    <code class="n">res</code> <code class="o">=</code> <code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">qry</code><code class="p">,</code> <code class="n">params</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="nb">bool</code><code class="p">(</code><code class="n">res</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>By importing <code>conn</code> and <code>curs</code> from <em>init.py</em>,&#13;
it’s no longer necessary for <em>data/creature.py</em> to&#13;
import sqlite3 itself—unless someday it’s necessary to call another sqlite3&#13;
method that isn’t a method of the <code>conn</code> or <code>curs</code> objects.</p>&#13;
&#13;
<p>Again, these changes should goose Uvicorn into reloading&#13;
everything.&#13;
From now on,&#13;
testing with any of the methods that you’ve seen so far&#13;
(HTTPie and friends, or the automated <em>/docs</em> forms)&#13;
will show data that persists.&#13;
If you add a creature,&#13;
it will be there the next time you get all of them.</p>&#13;
&#13;
<p>Let’s do the same for explorers in<a data-primary="Data layer" data-secondary="database information at startup time" data-startref="ibd048" data-type="indexterm" id="id677"/> <a data-type="xref" href="#ex-10-5">Example 10-5</a>.</p>&#13;
<div data-type="example" id="ex-10-5">&#13;
<h5><span class="label">Example 10-5. </span>Add database configuration to <span class="plain">data/explorer.py</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">.init</code> <code class="kn">import</code> <code class="n">curs</code>&#13;
<code class="kn">from</code> <code class="nn">model.explorer</code> <code class="kn">import</code> <code class="n">Explorer</code>&#13;
&#13;
&#13;
<code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s2">"""create table if not exists explorer(</code>&#13;
<code class="s2">                name text primary key,</code>&#13;
<code class="s2">                country text,</code>&#13;
<code class="s2">                description text)"""</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">row_to_model</code><code class="p">(</code><code class="n">row</code><code class="p">:</code> <code class="nb">tuple</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Explorer</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">Explorer</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="n">row</code><code class="p">[</code><code class="mi">0</code><code class="p">],</code> <code class="n">country</code><code class="o">=</code><code class="n">row</code><code class="p">[</code><code class="mi">1</code><code class="p">],</code> <code class="n">description</code><code class="o">=</code><code class="n">row</code><code class="p">[</code><code class="mi">2</code><code class="p">])</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">model_to_dict</code><code class="p">(</code><code class="n">explorer</code><code class="p">:</code> <code class="n">Explorer</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">dict</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">explorer</code><code class="o">.</code><code class="n">dict</code><code class="p">()</code> <code class="k">if</code> <code class="n">explorer</code> <code class="k">else</code> <code class="kc">None</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">get_one</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Explorer</code><code class="p">:</code>&#13;
    <code class="n">qry</code> <code class="o">=</code> <code class="s2">"select * from explorer where name=:name"</code>&#13;
    <code class="n">params</code> <code class="o">=</code> <code class="p">{</code><code class="s2">"name"</code><code class="p">:</code> <code class="n">name</code><code class="p">}</code>&#13;
    <code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">qry</code><code class="p">,</code> <code class="n">params</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">row_to_model</code><code class="p">(</code><code class="n">curs</code><code class="o">.</code><code class="n">fetchone</code><code class="p">())</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">get_all</code><code class="p">()</code> <code class="o">-&gt;</code> <code class="nb">list</code><code class="p">[</code><code class="n">Explorer</code><code class="p">]:</code>&#13;
    <code class="n">qry</code> <code class="o">=</code> <code class="s2">"select * from explorer"</code>&#13;
    <code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">qry</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="p">[</code><code class="n">row_to_model</code><code class="p">(</code><code class="n">row</code><code class="p">)</code> <code class="k">for</code> <code class="n">row</code> <code class="ow">in</code> <code class="n">curs</code><code class="o">.</code><code class="n">fetchall</code><code class="p">()]</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">create</code><code class="p">(</code><code class="n">explorer</code><code class="p">:</code> <code class="n">Explorer</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Explorer</code><code class="p">:</code>&#13;
    <code class="n">qry</code> <code class="o">=</code> <code class="s2">"""insert into explorer (name, country, description)</code>&#13;
<code class="s2">             values (:name, :country, :description)"""</code>&#13;
    <code class="n">params</code> <code class="o">=</code> <code class="n">model_to_dict</code><code class="p">(</code><code class="n">explorer</code><code class="p">)</code>&#13;
    <code class="n">_</code> <code class="o">=</code> <code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">qry</code><code class="p">,</code> <code class="n">params</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">get_one</code><code class="p">(</code><code class="n">explorer</code><code class="o">.</code><code class="n">name</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">modify</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">,</code> <code class="n">explorer</code><code class="p">:</code> <code class="n">Explorer</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Explorer</code><code class="p">:</code>&#13;
    <code class="n">qry</code> <code class="o">=</code> <code class="s2">"""update explorer</code>&#13;
<code class="s2">             set country=:country,</code>&#13;
<code class="s2">             name=:name,</code>&#13;
<code class="s2">             description=:description</code>&#13;
<code class="s2">             where name=:name_orig"""</code>&#13;
    <code class="n">params</code> <code class="o">=</code> <code class="n">model_to_dict</code><code class="p">(</code><code class="n">explorer</code><code class="p">)</code>&#13;
    <code class="n">params</code><code class="p">[</code><code class="s2">"name_orig"</code><code class="p">]</code> <code class="o">=</code> <code class="n">explorer</code><code class="o">.</code><code class="n">name</code>&#13;
    <code class="n">_</code> <code class="o">=</code> <code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">qry</code><code class="p">,</code> <code class="n">params</code><code class="p">)</code>&#13;
    <code class="n">explorer2</code> <code class="o">=</code> <code class="n">get_one</code><code class="p">(</code><code class="n">explorer</code><code class="o">.</code><code class="n">name</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">explorer2</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">delete</code><code class="p">(</code><code class="n">explorer</code><code class="p">:</code> <code class="n">Explorer</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">bool</code><code class="p">:</code>&#13;
    <code class="n">qry</code> <code class="o">=</code> <code class="s2">"delete from explorer where name = :name"</code>&#13;
    <code class="n">params</code> <code class="o">=</code> <code class="p">{</code><code class="s2">"name"</code><code class="p">:</code> <code class="n">explorer</code><code class="o">.</code><code class="n">name</code><code class="p">}</code>&#13;
    <code class="n">res</code> <code class="o">=</code> <code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">qry</code><code class="p">,</code> <code class="n">params</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="nb">bool</code><code class="p">(</code><code class="n">res</code><code class="p">)</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Test!" data-type="sect1"><div class="sect1" id="id205">&#13;
<h1>Test!</h1>&#13;
&#13;
<p><a data-primary="Data layer" data-secondary="testing" data-type="indexterm" id="ibd049"/>That’s<a data-primary="testing" data-secondary="Data layer" data-type="indexterm" id="ibd055"/> a lot of code with no tests.&#13;
Does everything work?&#13;
I’d be surprised if it all did.&#13;
So let’s set up some tests.</p>&#13;
&#13;
<p>Make these subdirectories under the <em>test</em> directory:</p>&#13;
<dl>&#13;
<dt>unit</dt>&#13;
<dd>&#13;
<p>Within a layer</p>&#13;
</dd>&#13;
<dt>full</dt>&#13;
<dd>&#13;
<p>Across all layers</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>Which type should you write and run first?&#13;
Most people write automated unit tests first;&#13;
they’re smaller, and all the other layer pieces may not exist yet.&#13;
In this book, development has been top-down,&#13;
and we’re now completing the last layer.&#13;
Also, we did manual tests (with HTTPie and friends)&#13;
in Chapters <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch08.html#ch08">8</a> and&#13;
<a data-type="xref" data-xrefstyle="select:labelnumber" href="ch09.html#ch09">9</a>.&#13;
Those helped to expose bugs and omissions quickly;&#13;
automated tests ensure that you don’t keep making the same errors&#13;
later.&#13;
So, I recommend the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Some manual tests as you’re first writing the code</p>&#13;
</li>&#13;
<li>&#13;
<p>Unit tests after you’ve fixed Python syntax errors</p>&#13;
</li>&#13;
<li>&#13;
<p>Full tests after you have a full data flow across all layers</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Full Tests" data-type="sect2"><div class="sect2" id="id206">&#13;
<h2>Full Tests</h2>&#13;
&#13;
<p><a data-primary="Data layer" data-secondary="full tests" data-type="indexterm" id="ibd050"/>These <a data-primary="full (end-to-end; contract) tests" data-secondary="Data layer" data-type="indexterm" id="ibd056"/>call<a data-primary="testing" data-secondary="full tests" data-startref="icd200" data-type="indexterm" id="id678"/> the <a data-primary="testing" data-secondary="full tests" data-type="indexterm" id="icd500"/>web endpoints,&#13;
which take the code elevator down through Service to Data,&#13;
and back up again.&#13;
Sometimes these are called <em>end-to-end</em>&#13;
or <em>contract</em> tests.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Get all explorers" data-type="sect3"><div class="sect3" id="id311">&#13;
<h3>Get all explorers</h3>&#13;
&#13;
<p>Dipping a toe in the test waters,&#13;
not yet knowing if they’re infested with piranhas,&#13;
is brave volunteer <a data-type="xref" href="#ex-10-6">Example 10-6</a>.</p>&#13;
<div data-type="example" id="ex-10-6">&#13;
<h5><span class="label">Example 10-6. </span>The Get All Explorers test</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http localhost:8000/explorer</strong>&#13;
HTTP/1.1 405 Method Not Allowed&#13;
allow: POST&#13;
content-length: 31&#13;
content-type: application/json&#13;
date: Mon, 27 Feb 2023 20:05:18 GMT&#13;
server: uvicorn&#13;
&#13;
{&#13;
    "detail": "Method Not Allowed"&#13;
}</pre></div>&#13;
&#13;
<p>Eek! What happened?</p>&#13;
&#13;
<p>Oh.&#13;
The test asked for <code>/explorer</code>, not <code>/explorer/</code>,&#13;
and there’s no <code>GET</code>-method path function&#13;
for the URL <em>/explorer</em> (with no final slash).&#13;
In <em>web/explorer.py</em>, the path decorator for the&#13;
<code>get_all()</code> path function is this:</p>&#13;
&#13;
<pre data-type="programlisting">@router.get("/")</pre>&#13;
&#13;
<p>That, plus the earlier code</p>&#13;
&#13;
<pre data-type="programlisting">router = APIRouter(prefix = "/explorer")</pre>&#13;
&#13;
<p>means this <code>get_all()</code> path function&#13;
serves a URL containing <em>/explorer/</em>.</p>&#13;
&#13;
<p><a data-type="xref" href="#ex-10-7">Example 10-7</a>&#13;
happily shows that you can have more than one&#13;
path decorator per path function.</p>&#13;
<div data-type="example" id="ex-10-7">&#13;
<h5><span class="label">Example 10-7. </span>Add a nonslash path decorator for the <code>get_all()</code> path function</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="nd">@router</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">""</code><code class="p">)</code>&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">get_all</code><code class="p">()</code> <code class="o">-&gt;</code> <code class="nb">list</code><code class="p">[</code><code class="n">Explorer</code><code class="p">]:</code>&#13;
    <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="n">get_all</code><code class="p">()</code></pre></div>&#13;
&#13;
<p>Test with both URLs in Examples <a data-type="xref" data-xrefstyle="select:labelnumber" href="#ex-10-8">10-8</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="#ex-10-9">10-9</a>.</p>&#13;
<div data-type="example" id="ex-10-8">&#13;
<h5><span class="label">Example 10-8. </span>Test the nonslash endpoint</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http localhost:8000/explorer</strong>&#13;
HTTP/1.1 200 OK&#13;
content-length: 2&#13;
content-type: application/json&#13;
date: Mon, 27 Feb 2023 20:12:44 GMT&#13;
server: uvicorn&#13;
&#13;
[]</pre></div>&#13;
<div data-type="example" id="ex-10-9">&#13;
<h5><span class="label">Example 10-9. </span>Test the slash endpoint</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http localhost:8000/explorer/</strong>&#13;
HTTP/1.1 200 OK&#13;
content-length: 2&#13;
content-type: application/json&#13;
date: Mon, 27 Feb 2023 20:14:39 GMT&#13;
server: uvicorn&#13;
&#13;
[]</pre></div>&#13;
&#13;
<p>Now that both of these work,&#13;
create an explorer,&#13;
and retry the Get All test after.&#13;
<a data-type="xref" href="#ex-10-10">Example 10-10</a> attempts this,&#13;
but with a plot twist.</p>&#13;
<div data-type="example" id="ex-10-10">&#13;
<h5><span class="label">Example 10-10. </span>Test explorer creation, with an input error</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http post localhost:8000/explorer name="Beau Buffette", contry="US"</strong>&#13;
HTTP/1.1 422 Unprocessable Entity&#13;
content-length: 95&#13;
content-type: application/json&#13;
date: Mon, 27 Feb 2023 20:17:45 GMT&#13;
server: uvicorn&#13;
&#13;
{&#13;
    "detail": [&#13;
        {&#13;
            "loc": [&#13;
                "body",&#13;
                "country"&#13;
            ],&#13;
            "msg": "field required",&#13;
            "type": "value_error.missing"&#13;
        }&#13;
    ]&#13;
}</pre></div>&#13;
&#13;
<p>I misspelled <code>country</code>,&#13;
although my speling is usually impeckable.&#13;
Pydantic caught this in the Web layer,&#13;
returning a <code>422</code> HTTP status code and a description of the problem.&#13;
Generally, if FastAPI returns a <code>422</code>, the odds are that&#13;
Pydantic fingered the perpetrator.&#13;
The <code>"loc"</code> part says where the error occurred:&#13;
the field <code>"country"</code> is missing,&#13;
because I’m such an inept typist.</p>&#13;
&#13;
<p>Fix the spelling and retest in <a data-type="xref" href="#ex-10-11">Example 10-11</a>.</p>&#13;
<div data-type="example" id="ex-10-11">&#13;
<h5><span class="label">Example 10-11. </span>Create an explorer with the corrected value</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http post localhost:8000/explorer name="Beau Buffette" country="US"</strong>&#13;
HTTP/1.1 201 Created&#13;
content-length: 55&#13;
content-type: application/json&#13;
date: Mon, 27 Feb 2023 20:20:49 GMT&#13;
server: uvicorn&#13;
&#13;
{&#13;
    "name": "Beau Buffette,",&#13;
    "country": "US",&#13;
    "description": ""&#13;
}</pre></div>&#13;
&#13;
<p>This time the call returns a <code>201</code> status code,&#13;
which is traditional when a resource is created&#13;
(all <code>2<em>xx</em></code> status codes are considered to indicate success,&#13;
with plain <code>200</code> being the most generic).&#13;
The response also contains the JSON version of the&#13;
<code>Explorer</code> object that was just created.</p>&#13;
&#13;
<p>Now back to the initial test: will Beau turn up in the&#13;
Get All Explorers test?&#13;
<a data-type="xref" href="#ex-10-12">Example 10-12</a> answers this burning question.</p>&#13;
<div data-type="example" id="ex-10-12">&#13;
<h5><span class="label">Example 10-12. </span>Did the latest <code>create()</code> work?</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http localhost:8000/explorer</strong>&#13;
HTTP/1.1 200 OK&#13;
content-length: 57&#13;
content-type: application/json&#13;
date: Mon, 27 Feb 2023 20:26:26 GMT&#13;
server: uvicorn&#13;
&#13;
[&#13;
    {&#13;
        "name": "Beau Buffette",&#13;
        "country": "US",&#13;
        "description": ""&#13;
    }&#13;
]</pre></div>&#13;
&#13;
<p>Yay.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Get one explorer" data-type="sect3"><div class="sect3" id="id312">&#13;
<h3>Get one explorer</h3>&#13;
&#13;
<p>Now, what happens if you try to look up Beau with&#13;
the Get One endpoint&#13;
(<a data-type="xref" href="#ex-10-13">Example 10-13</a>)?</p>&#13;
<div data-type="example" id="ex-10-13">&#13;
<h5><span class="label">Example 10-13. </span>Test the Get One endpoint</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http localhost:8000/explorer/"Beau Buffette"</strong>&#13;
HTTP/1.1 200 OK&#13;
content-length: 55&#13;
content-type: application/json&#13;
date: Mon, 27 Feb 2023 20:28:48 GMT&#13;
server: uvicorn&#13;
&#13;
{&#13;
    "name": "Beau Buffette",&#13;
    "country": "US",&#13;
    "description": ""&#13;
}</pre></div>&#13;
&#13;
<p>I used the quotes to preserve that space between the first and&#13;
last names.&#13;
In URLs, you could also use&#13;
<code>Beau%20Buffette</code>;&#13;
the <code>%20</code> is the hex code for the space character in ASCII.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Missing and duplicate data" data-type="sect3"><div class="sect3" id="id89">&#13;
<h3>Missing and duplicate data</h3>&#13;
&#13;
<p>I’ve ignored two main error classes so far:</p>&#13;
<dl>&#13;
<dt><a data-primary="Data layer" data-secondary="missing data error" data-type="indexterm" id="id679"/>Missing <a data-primary="missing data error" data-type="indexterm" id="id680"/>data</dt>&#13;
<dd>&#13;
<p>If you try to get, modify,&#13;
or delete an explorer by a name that isn’t in the database.</p>&#13;
</dd>&#13;
<dt><a data-primary="Data layer" data-secondary="duplicate error" data-type="indexterm" id="id681"/>Duplicate <a data-primary="duplicate data error" data-type="indexterm" id="id682"/>data</dt>&#13;
<dd>&#13;
<p>If you try to create&#13;
an explorer with the same name more than once.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>So, what if you ask for a nonexistent or duplicate explorer?&#13;
So far, the code has been too optimistic, and exceptions will&#13;
bubble up from the abyss.</p>&#13;
&#13;
<p>Our friend Beau was just added to the database.&#13;
Imagine his evil clone&#13;
(who shares his name)&#13;
plots to replace him some dark night,&#13;
using <a data-type="xref" href="#ex-10-14">Example 10-14</a>.</p>&#13;
<div data-type="example" id="ex-10-14">&#13;
<h5><span class="label">Example 10-14. </span>Duplicate error: try to create an explorer more than once</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http post localhost:8000/explorer name="Beau Buffette" country="US"</strong>&#13;
HTTP/1.1 500 Internal Server Error&#13;
content-length: 3127&#13;
content-type: text/plain; charset=utf-8&#13;
date: Mon, 27 Feb 2023 21:04:09 GMT&#13;
server: uvicorn&#13;
&#13;
Traceback (most recent call last):&#13;
  File ".../starlette/middleware/errors.py", line 162, in <em>call</em>&#13;
... (lots of confusing innards here) ...&#13;
  File ".../service/explorer.py", line 11, in create&#13;
    return data.create(explorer)&#13;
           <sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup>&#13;
  File ".../data/explorer.py", line 37, in create&#13;
    curs.execute(qry, params)&#13;
sqlite3.IntegrityError: UNIQUE constraint failed: explorer.name</pre></div>&#13;
&#13;
<p>I omitted most of the lines in that error trace&#13;
(and replaced some parts with ellipses),&#13;
because it contained mostly internal calls made by FastAPI&#13;
and the underlying Starlette. But that last line:&#13;
a SQLite exception in the Web layer!&#13;
Where is the fainting couch?</p>&#13;
&#13;
<p>Right on the heels of this,&#13;
yet another horror in <a data-type="xref" href="#ex-10-15">Example 10-15</a>: a missing explorer.</p>&#13;
<div data-type="example" id="ex-10-15">&#13;
<h5><span class="label">Example 10-15. </span>Get a nonexistent explorer</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http localhost:8000/explorer/"Beau Buffalo"</strong>&#13;
HTTP/1.1 500 Internal Server Error&#13;
content-length: 3282&#13;
content-type: text/plain; charset=utf-8&#13;
date: Mon, 27 Feb 2023 21:09:37 GMT&#13;
server: uvicorn&#13;
&#13;
Traceback (most recent call last):&#13;
  File ".../starlette/middleware/errors.py", line 162, in <em>call</em>&#13;
... (many lines of ancient cuneiform) ...&#13;
  File ".../data/explorer.py", line 11, in row_to_model&#13;
    name, country, description = row&#13;
    <sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup><sup>^</sup>^^&#13;
TypeError: cannot unpack non-iterable NoneType object</pre></div>&#13;
&#13;
<p>What’s a good way to catch these at the bottom (Data) layer,&#13;
and communicate the details to the top (Web)?&#13;
Possibilities include the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Let SQLite cough up a hairball (exception) and deal with&#13;
it in the Web layer.</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>But: this mixes the layers, which is <em>Bad</em>.  The Web layer&#13;
should not know anything about specific databases.</p>&#13;
</li>&#13;
</ul>&#13;
</li>&#13;
<li>&#13;
<p>Make every function in the Service and Data layers&#13;
return <code>Explorer  | None</code> where they used to return <code>Explorer</code>.&#13;
Then a <code>None</code> indicates failure.&#13;
(You can shorten this by defining <code>OptExplorer = Explorer | None</code>&#13;
in <em>model/explorer.py</em>.)</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>But: the function may have failed for more than one reason, and you might&#13;
want details.  And this requires lots of code editing.</p>&#13;
</li>&#13;
</ul>&#13;
</li>&#13;
<li>&#13;
<p>Define exceptions for <code>Missing</code> and <code>Duplicate</code> data, including&#13;
details of the problem. These will flow up through the layers&#13;
with no code changes until the Web path functions catch them.&#13;
They’re also application specific rather than database specific,&#13;
preserving the sanctity of the layers.</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>But: actually, I like this one, so it goes in <a data-type="xref" href="#ex-10-16">Example 10-16</a>.</p>&#13;
</li>&#13;
</ul>&#13;
</li>&#13;
</ul>&#13;
<div data-type="example" id="ex-10-16">&#13;
<h5><span class="label">Example 10-16. </span>Define a new top-level <span class="plain">errors.py</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="k">class</code> <code class="nc">Missing</code><code class="p">(</code><code class="ne">Exception</code><code class="p">):</code>&#13;
    <code class="k">def</code> <code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">msg</code><code class="p">:</code><code class="nb">str</code><code class="p">):</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">msg</code> <code class="o">=</code> <code class="n">msg</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">Duplicate</code><code class="p">(</code><code class="ne">Exception</code><code class="p">):</code>&#13;
    <code class="k">def</code> <code class="fm">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">msg</code><code class="p">:</code><code class="nb">str</code><code class="p">):</code>&#13;
        <code class="bp">self</code><code class="o">.</code><code class="n">msg</code> <code class="o">=</code> <code class="n">msg</code></pre></div>&#13;
&#13;
<p>Each of these exceptions has a <code>msg</code> string attribute that can&#13;
inform the higher-level code of what happened.</p>&#13;
&#13;
<p>To implement this,&#13;
in <a data-type="xref" href="#ex-10-17">Example 10-17</a>,&#13;
have <em>data/init.py</em>&#13;
import the DB-API exception that SQLite would raise for&#13;
a duplicate.</p>&#13;
<div data-type="example" id="ex-10-17">&#13;
<h5><span class="label">Example 10-17. </span>Add a SQLite exception import into <span class="plain">data/init.py</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">sqlite3</code> <code class="kn">import</code> <code class="n">connect</code><code class="p">,</code> <code class="n">IntegrityError</code></pre></div>&#13;
&#13;
<p>Import and catch this error in <a data-type="xref" href="#ex-10-18">Example 10-18</a>.</p>&#13;
<div data-type="example" id="ex-10-18">&#13;
<h5><span class="label">Example 10-18. </span>Modify <span class="plain">data/explorer.py</span> to catch and raise these exceptions</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">init</code> <code class="kn">import</code> <code class="p">(</code><code class="n">conn</code><code class="p">,</code> <code class="n">curs</code><code class="p">,</code> <code class="n">IntegrityError</code><code class="p">)</code>&#13;
<code class="kn">from</code> <code class="nn">model.explorer</code> <code class="kn">import</code> <code class="n">Explorer</code>&#13;
<code class="kn">from</code> <code class="nn">error</code> <code class="kn">import</code> <code class="n">Missing</code><code class="p">,</code> <code class="n">Duplicate</code>&#13;
&#13;
<code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s2">"""create table if not exists explorer(</code>&#13;
<code class="s2">                name text primary key,</code>&#13;
<code class="s2">                country text,</code>&#13;
<code class="s2">                description text)"""</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">row_to_model</code><code class="p">(</code><code class="n">row</code><code class="p">:</code> <code class="nb">tuple</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Explorer</code><code class="p">:</code>&#13;
    <code class="n">name</code><code class="p">,</code> <code class="n">country</code><code class="p">,</code> <code class="n">description</code> <code class="o">=</code> <code class="n">row</code>&#13;
    <code class="k">return</code> <code class="n">Explorer</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="n">name</code><code class="p">,</code>&#13;
        <code class="n">country</code><code class="o">=</code><code class="n">country</code><code class="p">,</code> <code class="n">description</code><code class="o">=</code><code class="n">description</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">model_to_dict</code><code class="p">(</code><code class="n">explorer</code><code class="p">:</code> <code class="n">Explorer</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="nb">dict</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">explorer</code><code class="o">.</code><code class="n">dict</code><code class="p">()</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">get_one</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Explorer</code><code class="p">:</code>&#13;
    <code class="n">qry</code> <code class="o">=</code> <code class="s2">"select * from explorer where name=:name"</code>&#13;
    <code class="n">params</code> <code class="o">=</code> <code class="p">{</code><code class="s2">"name"</code><code class="p">:</code> <code class="n">name</code><code class="p">}</code>&#13;
    <code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">qry</code><code class="p">,</code> <code class="n">params</code><code class="p">)</code>&#13;
    <code class="n">row</code> <code class="o">=</code> <code class="n">curs</code><code class="o">.</code><code class="n">fetchone</code><code class="p">()</code>&#13;
    <code class="k">if</code> <code class="n">row</code><code class="p">:</code>&#13;
        <code class="k">return</code> <code class="n">row_to_model</code><code class="p">(</code><code class="n">row</code><code class="p">)</code>&#13;
    <code class="k">else</code><code class="p">:</code>&#13;
        <code class="k">raise</code> <code class="n">Missing</code><code class="p">(</code><code class="n">msg</code><code class="o">=</code><code class="sa">f</code><code class="s2">"Explorer </code><code class="si">{</code><code class="n">name</code><code class="si">}</code><code class="s2"> not found"</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">get_all</code><code class="p">()</code> <code class="o">-&gt;</code> <code class="nb">list</code><code class="p">[</code><code class="n">Explorer</code><code class="p">]:</code>&#13;
    <code class="n">qry</code> <code class="o">=</code> <code class="s2">"select * from explorer"</code>&#13;
    <code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">qry</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="p">[</code><code class="n">row_to_model</code><code class="p">(</code><code class="n">row</code><code class="p">)</code> <code class="k">for</code> <code class="n">row</code> <code class="ow">in</code> <code class="n">curs</code><code class="o">.</code><code class="n">fetchall</code><code class="p">()]</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">create</code><code class="p">(</code><code class="n">explorer</code><code class="p">:</code> <code class="n">Explorer</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Explorer</code><code class="p">:</code>&#13;
    <code class="k">if</code> <code class="ow">not</code> <code class="n">explorer</code><code class="p">:</code> <code class="k">return</code> <code class="kc">None</code>&#13;
    <code class="n">qry</code> <code class="o">=</code> <code class="s2">"""insert into explorer (name, country, description) values</code>&#13;
<code class="s2">             (:name, :country, :description)"""</code>&#13;
    <code class="n">params</code> <code class="o">=</code> <code class="n">model_to_dict</code><code class="p">(</code><code class="n">explorer</code><code class="p">)</code>&#13;
    <code class="k">try</code><code class="p">:</code>&#13;
        <code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">qry</code><code class="p">,</code> <code class="n">params</code><code class="p">)</code>&#13;
    <code class="k">except</code> <code class="n">IntegrityError</code><code class="p">:</code>&#13;
        <code class="k">raise</code> <code class="n">Duplicate</code><code class="p">(</code><code class="n">msg</code><code class="o">=</code>&#13;
            <code class="sa">f</code><code class="s2">"Explorer </code><code class="si">{</code><code class="n">explorer</code><code class="o">.</code><code class="n">name</code><code class="si">}</code><code class="s2"> already exists"</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="n">get_one</code><code class="p">(</code><code class="n">explorer</code><code class="o">.</code><code class="n">name</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">modify</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">,</code> <code class="n">explorer</code><code class="p">:</code> <code class="n">Explorer</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Explorer</code><code class="p">:</code>&#13;
    <code class="k">if</code> <code class="ow">not</code> <code class="p">(</code><code class="n">name</code> <code class="ow">and</code> <code class="n">explorer</code><code class="p">):</code> <code class="k">return</code> <code class="kc">None</code>&#13;
    <code class="n">qry</code> <code class="o">=</code> <code class="s2">"""update explorer</code>&#13;
<code class="s2">             set name=:name,</code>&#13;
<code class="s2">             country=:country,</code>&#13;
<code class="s2">             description=:description</code>&#13;
<code class="s2">             where name=:name_orig"""</code>&#13;
    <code class="n">params</code> <code class="o">=</code> <code class="n">model_to_dict</code><code class="p">(</code><code class="n">explorer</code><code class="p">)</code>&#13;
    <code class="n">params</code><code class="p">[</code><code class="s2">"name_orig"</code><code class="p">]</code> <code class="o">=</code> <code class="n">explorer</code><code class="o">.</code><code class="n">name</code>&#13;
    <code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">qry</code><code class="p">,</code> <code class="n">params</code><code class="p">)</code>&#13;
    <code class="k">if</code> <code class="n">curs</code><code class="o">.</code><code class="n">rowcount</code> <code class="o">==</code> <code class="mi">1</code><code class="p">:</code>&#13;
        <code class="k">return</code> <code class="n">get_one</code><code class="p">(</code><code class="n">explorer</code><code class="o">.</code><code class="n">name</code><code class="p">)</code>&#13;
    <code class="k">else</code><code class="p">:</code>&#13;
        <code class="k">raise</code> <code class="n">Missing</code><code class="p">(</code><code class="n">msg</code><code class="o">=</code><code class="sa">f</code><code class="s2">"Explorer </code><code class="si">{</code><code class="n">name</code><code class="si">}</code><code class="s2"> not found"</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">delete</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">):</code>&#13;
    <code class="k">if</code> <code class="ow">not</code> <code class="n">name</code><code class="p">:</code> <code class="k">return</code> <code class="kc">False</code>&#13;
    <code class="n">qry</code> <code class="o">=</code> <code class="s2">"delete from explorer where name = :name"</code>&#13;
    <code class="n">params</code> <code class="o">=</code> <code class="p">{</code><code class="s2">"name"</code><code class="p">:</code> <code class="n">name</code><code class="p">}</code>&#13;
    <code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">qry</code><code class="p">,</code> <code class="n">params</code><code class="p">)</code>&#13;
    <code class="k">if</code> <code class="n">curs</code><code class="o">.</code><code class="n">rowcount</code> <code class="o">!=</code> <code class="mi">1</code><code class="p">:</code>&#13;
        <code class="k">raise</code> <code class="n">Missing</code><code class="p">(</code><code class="n">msg</code><code class="o">=</code><code class="sa">f</code><code class="s2">"Explorer </code><code class="si">{</code><code class="n">name</code><code class="si">}</code><code class="s2"> not found"</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>This drops the need to declare that any functions return&#13;
<code>Explorer | None</code> or <code>Optional[Explorer]</code>.&#13;
You indicate type hints only for normal return types,&#13;
not exceptions.&#13;
Because exceptions flow upward independent of the call stack&#13;
until someone catches them,&#13;
for once you don’t have to change anything in the Service layer.&#13;
But here’s the new <em>web/explorer.py</em> in <a data-type="xref" href="#ex-10-19">Example 10-19</a>,&#13;
with exception handlers and appropriate HTTP status code returns.</p>&#13;
<div data-type="example" id="ex-10-19">&#13;
<h5><span class="label">Example 10-19. </span>Handle <code>Missing</code> and <code>Duplicate</code> exceptions in <span class="plain">web/explorer.py</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">APIRouter</code><code class="p">,</code> <code class="n">HTTPException</code>&#13;
<code class="kn">from</code> <code class="nn">model.explorer</code> <code class="kn">import</code> <code class="n">Explorer</code>&#13;
<code class="kn">from</code> <code class="nn">service</code> <code class="kn">import</code> <code class="n">explorer</code> <code class="k">as</code> <code class="n">service</code>&#13;
<code class="kn">from</code> <code class="nn">error</code> <code class="kn">import</code> <code class="n">Duplicate</code><code class="p">,</code> <code class="n">Missing</code>&#13;
&#13;
<code class="n">router</code> <code class="o">=</code> <code class="n">APIRouter</code><code class="p">(</code><code class="n">prefix</code> <code class="o">=</code> <code class="s2">"/explorer"</code><code class="p">)</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">""</code><code class="p">)</code>&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">get_all</code><code class="p">()</code> <code class="o">-&gt;</code> <code class="nb">list</code><code class="p">[</code><code class="n">Explorer</code><code class="p">]:</code>&#13;
    <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="n">get_all</code><code class="p">()</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/</code><code class="si">{name}</code><code class="s2">"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">get_one</code><code class="p">(</code><code class="n">name</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Explorer</code><code class="p">:</code>&#13;
    <code class="k">try</code><code class="p">:</code>&#13;
        <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="n">get_one</code><code class="p">(</code><code class="n">name</code><code class="p">)</code>&#13;
    <code class="k">except</code> <code class="n">Missing</code> <code class="k">as</code> <code class="n">exc</code><code class="p">:</code>&#13;
        <code class="k">raise</code> <code class="n">HTTPException</code><code class="p">(</code><code class="n">status_code</code><code class="o">=</code><code class="mi">404</code><code class="p">,</code> <code class="n">detail</code><code class="o">=</code><code class="n">exc</code><code class="o">.</code><code class="n">msg</code><code class="p">)</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">""</code><code class="p">,</code> <code class="n">status_code</code><code class="o">=</code><code class="mi">201</code><code class="p">)</code>&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"/"</code><code class="p">,</code> <code class="n">status_code</code><code class="o">=</code><code class="mi">201</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">create</code><code class="p">(</code><code class="n">explorer</code><code class="p">:</code> <code class="n">Explorer</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Explorer</code><code class="p">:</code>&#13;
    <code class="k">try</code><code class="p">:</code>&#13;
        <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">explorer</code><code class="p">)</code>&#13;
    <code class="k">except</code> <code class="n">Duplicate</code> <code class="k">as</code> <code class="n">exc</code><code class="p">:</code>&#13;
        <code class="k">raise</code> <code class="n">HTTPException</code><code class="p">(</code><code class="n">status_code</code><code class="o">=</code><code class="mi">404</code><code class="p">,</code> <code class="n">detail</code><code class="o">=</code><code class="n">exc</code><code class="o">.</code><code class="n">msg</code><code class="p">)</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">patch</code><code class="p">(</code><code class="s2">"/"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">modify</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">,</code> <code class="n">explorer</code><code class="p">:</code> <code class="n">Explorer</code><code class="p">)</code> <code class="o">-&gt;</code> <code class="n">Explorer</code><code class="p">:</code>&#13;
    <code class="k">try</code><code class="p">:</code>&#13;
        <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="n">modify</code><code class="p">(</code><code class="n">name</code><code class="p">,</code> <code class="n">explorer</code><code class="p">)</code>&#13;
    <code class="k">except</code> <code class="n">Missing</code> <code class="k">as</code> <code class="n">exc</code><code class="p">:</code>&#13;
        <code class="k">raise</code> <code class="n">HTTPException</code><code class="p">(</code><code class="n">status_code</code><code class="o">=</code><code class="mi">404</code><code class="p">,</code> <code class="n">detail</code><code class="o">=</code><code class="n">exc</code><code class="o">.</code><code class="n">msg</code><code class="p">)</code>&#13;
&#13;
<code class="nd">@router</code><code class="o">.</code><code class="n">delete</code><code class="p">(</code><code class="s2">"/</code><code class="si">{name}</code><code class="s2">"</code><code class="p">,</code> <code class="n">status_code</code><code class="o">=</code><code class="mi">204</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">delete</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code><code class="p">):</code>&#13;
    <code class="k">try</code><code class="p">:</code>&#13;
        <code class="k">return</code> <code class="n">service</code><code class="o">.</code><code class="n">delete</code><code class="p">(</code><code class="n">name</code><code class="p">)</code>&#13;
    <code class="k">except</code> <code class="n">Missing</code> <code class="k">as</code> <code class="n">exc</code><code class="p">:</code>&#13;
        <code class="k">raise</code> <code class="n">HTTPException</code><code class="p">(</code><code class="n">status_code</code><code class="o">=</code><code class="mi">404</code><code class="p">,</code> <code class="n">detail</code><code class="o">=</code><code class="n">exc</code><code class="o">.</code><code class="n">msg</code><code class="p">)</code></pre></div>&#13;
&#13;
<p class="pagebreak-after">Test these changes in <a data-type="xref" href="#ex-10-20">Example 10-20</a>.</p>&#13;
<div data-type="example" id="ex-10-20">&#13;
<h5><span class="label">Example 10-20. </span>Test Get One nonexisting explorer again, with new <code>Missing</code> exception</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http localhost:8000/explorer/"Beau Buffalo"</strong>&#13;
HTTP/1.1 404 Not Found&#13;
content-length: 44&#13;
content-type: application/json&#13;
date: Mon, 27 Feb 2023 21:11:27 GMT&#13;
server: uvicorn&#13;
&#13;
{&#13;
    "detail": "Explorer Beau Buffalo not found"&#13;
}</pre></div>&#13;
&#13;
<p>Good.&#13;
Now, try the evil clone attempt again in <a data-type="xref" href="#ex-10-21">Example 10-21</a>.</p>&#13;
<div data-type="example" id="ex-10-21">&#13;
<h5><span class="label">Example 10-21. </span>Test duplicate fix</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http post localhost:8000/explorer name="Beau Buffette" country="US"</strong>&#13;
HTTP/1.1 404 Not Found&#13;
content-length: 50&#13;
content-type: application/json&#13;
date: Mon, 27 Feb 2023 21:14:00 GMT&#13;
server: uvicorn&#13;
&#13;
{&#13;
    "detail": "Explorer Beau Buffette already exists"&#13;
}</pre></div>&#13;
&#13;
<p>The missing checks would also apply to the Modify and Delete&#13;
endpoints.&#13;
You can try writing similar <a data-primary="testing" data-secondary="full tests" data-startref="icd200" data-type="indexterm" id="id683"/>tests <a data-primary="full (end-to-end; contract) tests" data-secondary="Data layer" data-startref="ibd056" data-type="indexterm" id="id684"/>for <a data-primary="Data layer" data-secondary="full tests" data-startref="ibd050" data-type="indexterm" id="id685"/>them<a data-primary="testing" data-secondary="full tests" data-startref="icd500" data-type="indexterm" id="id686"/>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Unit Tests" data-type="sect2"><div class="sect2" id="id207">&#13;
<h2>Unit Tests</h2>&#13;
&#13;
<p><a data-primary="Data layer" data-secondary="unit tests" data-type="indexterm" id="ibd051"/>Unit <a data-primary="unit tests" data-secondary="Data layer" data-type="indexterm" id="ibd057"/>tests<a data-primary="testing" data-secondary="unit tests" data-type="indexterm" id="icd300"/> deal only with the Data layer,&#13;
checking the database calls and SQL syntax.&#13;
I’ve put this section after the full tests&#13;
because I wanted to have the&#13;
<code>Missing</code> and <code>Duplicate</code> exceptions already&#13;
defined,&#13;
explained,&#13;
and coded into <em>data/creature.py</em>.&#13;
<a data-type="xref" href="#ex-10-22">Example 10-22</a> lists the test script&#13;
<em>test/unit/data/test_creature.py</em>.&#13;
Here are some points to note:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>You set the environment variable <code>CRYPTID_SQLITE_DATABASE</code>&#13;
to <code>":memory:"</code> <em>before</em> importing <code>init</code> or <code>creature</code>&#13;
from <code>data</code>. This value makes SQLite work completely in memory,&#13;
not stomping any existing database file,&#13;
or even creating a file on disk.&#13;
It’s checked in <em>data/init.py</em> when that module is first imported.</p>&#13;
</li>&#13;
<li>&#13;
<p>The <em>fixture</em> named <code>sample</code> is passed to the functions&#13;
that need a <code>Creature</code> object.</p>&#13;
</li>&#13;
<li>&#13;
<p>The tests run in order. In this case, the same database&#13;
stays up the whole time, instead of being reset between&#13;
functions. The reason is to allow changes from previous&#13;
functions to persist. With pytest, a fixture can have on the following:</p>&#13;
<dl>&#13;
<dt>Function scope (the default)</dt>&#13;
<dd>&#13;
<p>It’s called anew before every test&#13;
function.</p>&#13;
</dd>&#13;
<dt>Session scope</dt>&#13;
<dd>&#13;
<p>It’s called only once, at the start.</p>&#13;
</dd>&#13;
</dl>&#13;
</li>&#13;
<li>&#13;
<p>Some tests force the <code>Missing</code> or <code>Duplicate</code> exceptions,&#13;
and verify that they caught them.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>So, each of the tests in <a data-type="xref" href="#ex-10-22">Example 10-22</a> gets a brand-new, unchanged&#13;
<code>Creature</code> object named <code>sample</code>.</p>&#13;
<div data-type="example" id="ex-10-22">&#13;
<h5><span class="label">Example 10-22. </span>Unit tests for <span class="plain">data/creature.py</span></h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">os</code>&#13;
<code class="kn">import</code> <code class="nn">pytest</code>&#13;
<code class="kn">from</code> <code class="nn">model.creature</code> <code class="kn">import</code> <code class="n">Creature</code>&#13;
<code class="kn">from</code> <code class="nn">error</code> <code class="kn">import</code> <code class="n">Missing</code><code class="p">,</code> <code class="n">Duplicate</code>&#13;
&#13;
<code class="c1"># set this before data imports below for data.init</code>&#13;
<code class="n">os</code><code class="o">.</code><code class="n">environ</code><code class="p">[</code><code class="s2">"CRYPTID_SQLITE_DB"</code><code class="p">]</code> <code class="o">=</code> <code class="s2">":memory:"</code>&#13;
<code class="kn">from</code> <code class="nn">data</code> <code class="kn">import</code> <code class="n">creature</code>&#13;
&#13;
<code class="nd">@pytest</code><code class="o">.</code><code class="n">fixture</code>&#13;
<code class="k">def</code> <code class="nf">sample</code><code class="p">()</code> <code class="o">-&gt;</code> <code class="n">Creature</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">Creature</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s2">"yeti"</code><code class="p">,</code> <code class="n">country</code><code class="o">=</code><code class="s2">"CN"</code><code class="p">,</code> <code class="n">area</code><code class="o">=</code><code class="s2">"Himalayas"</code><code class="p">,</code>&#13;
        <code class="n">description</code><code class="o">=</code><code class="s2">"Harmless Himalayan"</code><code class="p">,</code>&#13;
        <code class="n">aka</code><code class="o">=</code><code class="s2">"Abominable Snowman"</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_create</code><code class="p">(</code><code class="n">sample</code><code class="p">):</code>&#13;
    <code class="n">resp</code> <code class="o">=</code> <code class="n">creature</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">sample</code><code class="p">)</code>&#13;
    <code class="k">assert</code> <code class="n">resp</code> <code class="o">==</code> <code class="n">sample</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_create_duplicate</code><code class="p">(</code><code class="n">sample</code><code class="p">):</code>&#13;
    <code class="k">with</code> <code class="n">pytest</code><code class="o">.</code><code class="n">raises</code><code class="p">(</code><code class="n">Duplicate</code><code class="p">):</code>&#13;
        <code class="n">_</code> <code class="o">=</code> <code class="n">creature</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">sample</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_get_one</code><code class="p">(</code><code class="n">sample</code><code class="p">):</code>&#13;
    <code class="n">resp</code> <code class="o">=</code> <code class="n">creature</code><code class="o">.</code><code class="n">get_one</code><code class="p">(</code><code class="n">sample</code><code class="o">.</code><code class="n">name</code><code class="p">)</code>&#13;
    <code class="k">assert</code> <code class="n">resp</code> <code class="o">==</code> <code class="n">sample</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_get_one_missing</code><code class="p">():</code>&#13;
    <code class="k">with</code> <code class="n">pytest</code><code class="o">.</code><code class="n">raises</code><code class="p">(</code><code class="n">Missing</code><code class="p">):</code>&#13;
        <code class="n">_</code> <code class="o">=</code> <code class="n">creature</code><code class="o">.</code><code class="n">get_one</code><code class="p">(</code><code class="s2">"boxturtle"</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_modify</code><code class="p">(</code><code class="n">sample</code><code class="p">):</code>&#13;
    <code class="n">creature</code><code class="o">.</code><code class="n">area</code> <code class="o">=</code> <code class="s2">"Sesame Street"</code>&#13;
    <code class="n">resp</code> <code class="o">=</code> <code class="n">creature</code><code class="o">.</code><code class="n">modify</code><code class="p">(</code><code class="n">sample</code><code class="o">.</code><code class="n">name</code><code class="p">,</code> <code class="n">sample</code><code class="p">)</code>&#13;
    <code class="k">assert</code> <code class="n">resp</code> <code class="o">==</code> <code class="n">sample</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_modify_missing</code><code class="p">():</code>&#13;
    <code class="n">thing</code><code class="p">:</code> <code class="n">Creature</code> <code class="o">=</code> <code class="n">Creature</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="s2">"snurfle"</code><code class="p">,</code> <code class="n">country</code><code class="o">=</code><code class="s2">"RU"</code><code class="p">,</code> <code class="n">area</code><code class="o">=</code><code class="s2">""</code><code class="p">,</code>&#13;
        <code class="n">description</code><code class="o">=</code><code class="s2">"some thing"</code><code class="p">,</code> <code class="n">aka</code><code class="o">=</code><code class="s2">""</code><code class="p">)</code>&#13;
    <code class="k">with</code> <code class="n">pytest</code><code class="o">.</code><code class="n">raises</code><code class="p">(</code><code class="n">Missing</code><code class="p">):</code>&#13;
        <code class="n">_</code> <code class="o">=</code> <code class="n">creature</code><code class="o">.</code><code class="n">modify</code><code class="p">(</code><code class="n">thing</code><code class="o">.</code><code class="n">name</code><code class="p">,</code> <code class="n">thing</code><code class="p">)</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_delete</code><code class="p">(</code><code class="n">sample</code><code class="p">):</code>&#13;
    <code class="n">resp</code> <code class="o">=</code> <code class="n">creature</code><code class="o">.</code><code class="n">delete</code><code class="p">(</code><code class="n">sample</code><code class="o">.</code><code class="n">name</code><code class="p">)</code>&#13;
    <code class="k">assert</code> <code class="n">resp</code> <code class="ow">is</code> <code class="kc">None</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">test_delete_missing</code><code class="p">(</code><code class="n">sample</code><code class="p">):</code>&#13;
    <code class="k">with</code> <code class="n">pytest</code><code class="o">.</code><code class="n">raises</code><code class="p">(</code><code class="n">Missing</code><code class="p">):</code>&#13;
        <code class="n">_</code> <code class="o">=</code> <code class="n">creature</code><code class="o">.</code><code class="n">delete</code><code class="p">(</code><code class="n">sample</code><code class="o">.</code><code class="n">name</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>Hint: you can <a data-primary="testing" data-secondary="unit tests" data-startref="icd300" data-type="indexterm" id="id687"/>make <a data-primary="unit tests" data-secondary="Data layer" data-startref="ibd057" data-type="indexterm" id="id688"/>your <a data-primary="testing" data-secondary="Data layer" data-startref="ibd055" data-type="indexterm" id="id689"/>own <a data-primary="Data layer" data-secondary="unit tests" data-startref="ibd051" data-type="indexterm" id="id690"/>version<a data-primary="Data layer" data-secondary="testing" data-startref="ibd049" data-type="indexterm" id="id691"/> of&#13;
<em>test/unit/data/test_explorer.py</em>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Review" data-type="sect1"><div class="sect1" id="id90">&#13;
<h1>Review</h1>&#13;
&#13;
<p>This chapter presented a&#13;
simple data-handling layer,&#13;
with a few trips up and down the layer stack&#13;
as needed.&#13;
<a data-type="xref" href="ch12.html#ch12">Chapter 12</a>&#13;
contains unit tests for each layer,&#13;
as well as cross-layer integration&#13;
and full end-to-end tests.&#13;
<a data-type="xref" href="ch14.html#ch14">Chapter 14</a> goes into more database depth and detailed examples<a data-primary="Data layer" data-startref="ibd044" data-type="indexterm" id="id692"/>.</p>&#13;
</div></section>&#13;
</div></section></body></html>