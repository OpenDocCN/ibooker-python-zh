<html><head></head><body><section data-pdf-bookmark="Chapter 6. Dependencies" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch06">&#13;
<h1><span class="label">Chapter 6. </span>Dependencies</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Preview" data-type="sect1"><div class="sect1" id="id58">&#13;
<h1>Preview</h1>&#13;
&#13;
<p><a data-primary="dependencies" data-type="indexterm" id="icd054"/>One of the very nice design features of FastAPI is&#13;
a technique called&#13;
<em>dependency injection</em>.&#13;
This term sounds technical and esoteric,&#13;
but it’s a key aspect of FastAPI&#13;
and is surprisingly useful at many levels.&#13;
This chapter looks at FastAPI’s built-in capabilities&#13;
as well as how to write your own.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="What’s a Dependency?" data-type="sect1"><div class="sect1" id="id185">&#13;
<h1>What’s a Dependency?</h1>&#13;
&#13;
<p>A <a data-primary="dependencies" data-secondary="defined" data-type="indexterm" id="id563"/><em>dependency</em> is specific information that you need at some point.&#13;
The usual way to get this information is to write code that gets it,&#13;
right when you need it.</p>&#13;
&#13;
<p>When you’re writing a web service, at some time you may need to do the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Gather input parameters from the HTTP request</p>&#13;
</li>&#13;
<li>&#13;
<p>Validate inputs</p>&#13;
</li>&#13;
<li>&#13;
<p>Check user authentication and authorization for some endpoints</p>&#13;
</li>&#13;
<li>&#13;
<p>Look up data from a data source, often a database</p>&#13;
</li>&#13;
<li>&#13;
<p>Emit metrics, logs, or tracking information</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Web frameworks convert the HTTP request bytes to&#13;
data structures,&#13;
and you pluck what you need from them inside&#13;
your Web layer functions as you go.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problems with Dependencies" data-type="sect1"><div class="sect1" id="id186">&#13;
<h1>Problems with Dependencies</h1>&#13;
&#13;
<p>Getting <a data-primary="dependencies" data-secondary="problems with" data-type="indexterm" id="id564"/>what you want, right when you need it,&#13;
and without external code needing to know how you got it,&#13;
seems pretty reasonable.&#13;
But it turns out that consequences exist:</p>&#13;
<dl>&#13;
<dt>Testing</dt>&#13;
<dd>&#13;
<p>You <a data-primary="dependencies" data-secondary="testing" data-type="indexterm" id="id565"/>can’t test variations of your function that could look up the&#13;
dependency <span class="keep-together">differently</span>.</p>&#13;
</dd>&#13;
<dt>Hidden <a data-primary="dependencies" data-secondary="hidden" data-type="indexterm" id="id566"/>dependencies</dt>&#13;
<dd>&#13;
<p>Hiding the details means that code&#13;
your function needs could break when external code changes.</p>&#13;
</dd>&#13;
<dt>Code <a data-primary="dependencies" data-secondary="code duplication" data-type="indexterm" id="id567"/>duplication</dt>&#13;
<dd>&#13;
<p>If your dependency is a common one (like looking up a user in a&#13;
database or combining values from an HTTP request),&#13;
you might duplicate the lookup code in multiple functions.</p>&#13;
</dd>&#13;
<dt>OpenAPI <a data-primary="dependencies" data-secondary="OpenAPI visibility" data-type="indexterm" id="id568"/>visibility</dt>&#13;
<dd>&#13;
<p>The automatic test page that FastAPI makes for you&#13;
needs information from the dependency injection mechanism.</p>&#13;
</dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Dependency Injection" data-type="sect1"><div class="sect1" id="id59">&#13;
<h1>Dependency Injection</h1>&#13;
&#13;
<p>The term<a data-primary="dependency injection" data-type="indexterm" id="id569"/> <em>dependency injection</em> is simpler than it sounds:&#13;
pass any <em>specific</em> information that a function needs&#13;
<em>into</em> the function.&#13;
A traditional way to do this is to pass in&#13;
a helper function, which you then call to get the specific data.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="FastAPI Dependencies" data-type="sect1"><div class="sect1" id="id187">&#13;
<h1>FastAPI Dependencies</h1>&#13;
&#13;
<p>FastAPI <a data-primary="FastAPI" data-secondary="dependencies" data-type="indexterm" id="id570"/>goes <a data-primary="dependencies" data-secondary="FastAPI and" data-type="indexterm" id="id571"/>one step more: you can define dependencies as&#13;
arguments to your function,&#13;
and they are <em>automatically</em> called by FastAPI&#13;
and pass in the <em>values</em> that they return.&#13;
For example, a <code>user_dep</code> dependency could get the user’s&#13;
name and password from HTTP arguments,&#13;
look them up in a database,&#13;
and return a token that you use to track that user afterward.&#13;
Your web-handling function doesn’t ever call this directly;&#13;
it’s handled at function call time.</p>&#13;
&#13;
<p>You’ve already seen some dependencies&#13;
but didn’t see them referred to as such:&#13;
HTTP data sources like <code>Path</code>, <code>Query</code>, <code>Body</code>, and <code>Header</code>.&#13;
These are functions or Python classes&#13;
that dig the requested data from various areas&#13;
in the HTTP request.&#13;
They hide the details, like validity checks and data formats.</p>&#13;
&#13;
<p class="pagebreak-before">Why not write your own functions to do this?&#13;
You could, but you would not have these:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Data validity checks</p>&#13;
</li>&#13;
<li>&#13;
<p>Format conversions</p>&#13;
</li>&#13;
<li>&#13;
<p>Automatic documentation</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>In many other web frameworks,&#13;
you would do these checks inside your own&#13;
functions.&#13;
You’ll see examples of this in <a data-type="xref" href="ch07.html#ch07">Chapter 7</a>,&#13;
which compares FastAPI with Python web frameworks&#13;
like Flask and Django. But in FastAPI,&#13;
you can handle your own dependencies,&#13;
much as the built-in ones do.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Writing a Dependency" data-type="sect1"><div class="sect1" id="id188">&#13;
<h1>Writing a Dependency</h1>&#13;
&#13;
<p>In <a data-primary="dependencies" data-secondary="writing" data-type="indexterm" id="id572"/>FastAPI, a dependency is something that’s executed,&#13;
so a dependency object&#13;
needs to be of the type <code>Callable</code>,&#13;
which includes functions and classes—things that you <em>call</em>, with parentheses and optional arguments.</p>&#13;
&#13;
<p><a data-type="xref" href="#ex-6-1">Example 6-1</a> shows&#13;
a <code>user_dep()</code> dependency function that takes&#13;
name and password string arguments,&#13;
and just returns <code>True</code> if the user is valid.&#13;
For this first version, let’s have the function return <code>True</code> for anything.</p>&#13;
<div data-type="example" id="ex-6-1">&#13;
<h5><span class="label">Example 6-1. </span>A dependency function</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">FastAPI</code><code class="p">,</code> <code class="n">Depends</code><code class="p">,</code> <code class="n">Params</code>&#13;
&#13;
<code class="n">app</code> <code class="o">=</code> <code class="n">FastAPI</code><code class="p">()</code>&#13;
&#13;
<code class="c1"># the dependency function:</code>&#13;
<code class="k">def</code> <code class="nf">user_dep</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code> <code class="o">=</code> <code class="n">Params</code><code class="p">,</code> <code class="n">password</code><code class="p">:</code> <code class="nb">str</code> <code class="o">=</code> <code class="n">Params</code><code class="p">):</code>&#13;
    <code class="k">return</code> <code class="p">{</code><code class="s2">"name"</code><code class="p">:</code> <code class="n">name</code><code class="p">,</code> <code class="s2">"valid"</code><code class="p">:</code> <code class="kc">True</code><code class="p">}</code>&#13;
&#13;
<code class="c1"># the path function / web endpoint:</code>&#13;
<code class="nd">@app</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/user"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">get_user</code><code class="p">(</code><code class="n">user</code><code class="p">:</code> <code class="nb">dict</code> <code class="o">=</code> <code class="n">Depends</code><code class="p">(</code><code class="n">user_dep</code><code class="p">))</code> <code class="o">-&gt;</code> <code class="nb">dict</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">user</code></pre></div>&#13;
&#13;
<p>Here, <code>user_dep()</code> is a dependency function.&#13;
It acts like a FastAPI path function (it knows about&#13;
things like <code>Params</code>, etc.),&#13;
but doesn’t have a path decorator above it.&#13;
It’s a helper, not a web endpoint itself.</p>&#13;
&#13;
<p>The path function <code>get_user()</code> says that it expects an argument&#13;
variable called <code>user</code>, and that variable will get its value&#13;
from the dependency function <code>user_dep()</code>.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>In the arguments to <code>get_user()</code>,&#13;
we could not have said <code>user = user_dep</code>,&#13;
because <code>user_dep</code> is a Python function object.&#13;
And we could not say <code>user = user_dep()</code>,&#13;
because that would&#13;
have called the <code>user_dep()</code> function&#13;
when <code>get_user()</code> was <em>defined</em>, not when it’s used.&#13;
So we need that extra helper FastAPI <code>Depends()</code> function to&#13;
call <code>user_dep()</code> just when it’s wanted.</p>&#13;
</div>&#13;
&#13;
<p>You can have multiple dependencies in your path function&#13;
argument list.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Dependency Scope" data-type="sect1"><div class="sect1" id="id189">&#13;
<h1>Dependency Scope</h1>&#13;
&#13;
<p>You <a data-primary="dependencies" data-secondary="scope of" data-type="indexterm" id="icd052"/>can define dependencies to cover a single path function,&#13;
a group of them,&#13;
or the whole web application.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Single Path" data-type="sect2"><div class="sect2" id="id305">&#13;
<h2>Single Path</h2>&#13;
&#13;
<p>In your <em>path function</em>, include an argument like this:</p>&#13;
&#13;
<pre data-type="programlisting">def <em>pathfunc</em>(<em>name</em>: <em>depfunc</em> = Depends(<em>depfunc</em>)):</pre>&#13;
&#13;
<p>or just this:</p>&#13;
&#13;
<pre data-type="programlisting">def <em>pathfunc</em>(<em>name</em>: <em>depfunc</em> = Depends()):</pre>&#13;
&#13;
<p><em><code>name</code></em> is whatever you want to call the value(s)&#13;
returned by <em><code>depfunc</code></em>.</p>&#13;
&#13;
<p>From the earlier example:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><em><code>pathfunc</code></em> is <code>get_user()</code>.</p>&#13;
</li>&#13;
<li>&#13;
<p><em><code>depfunc</code></em> is <code>user_dep()</code>.</p>&#13;
</li>&#13;
<li>&#13;
<p><em><code>name</code></em> is <code>user</code>.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p><a data-type="xref" href="#ex-6-2">Example 6-2</a> uses this path and dependency to return a fixed user <code>name</code>&#13;
and a <code>valid</code> Boolean.</p>&#13;
<div data-type="example" id="ex-6-2">&#13;
<h5><span class="label">Example 6-2. </span>Return a user dependency</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">FastAPI</code><code class="p">,</code> <code class="n">Depends</code><code class="p">,</code> <code class="n">Params</code>&#13;
&#13;
<code class="n">app</code> <code class="o">=</code> <code class="n">FastAPI</code><code class="p">()</code>&#13;
&#13;
<code class="c1"># the dependency function:</code>&#13;
<code class="k">def</code> <code class="nf">user_dep</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code> <code class="o">=</code> <code class="n">Params</code><code class="p">,</code> <code class="n">password</code><code class="p">:</code> <code class="nb">str</code> <code class="o">=</code> <code class="n">Params</code><code class="p">):</code>&#13;
    <code class="k">return</code> <code class="p">{</code><code class="s2">"name"</code><code class="p">:</code> <code class="n">name</code><code class="p">,</code> <code class="s2">"valid"</code><code class="p">:</code> <code class="kc">True</code><code class="p">}</code>&#13;
&#13;
<code class="c1"># the path function / web endpoint:</code>&#13;
<code class="nd">@app</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/user"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">get_user</code><code class="p">(</code><code class="n">user</code><code class="p">:</code> <code class="nb">dict</code> <code class="o">=</code> <code class="n">Depends</code><code class="p">(</code><code class="n">user_dep</code><code class="p">))</code> <code class="o">-&gt;</code> <code class="nb">dict</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="n">user</code></pre></div>&#13;
&#13;
<p>If your dependency function just checks something and doesn’t return any values,&#13;
you can also define the dependency in your path <em>decorator</em>&#13;
(the preceding line, starting with a <code>@</code>):</p>&#13;
&#13;
<pre data-type="programlisting">@<em>app</em>.<em>method</em>(<em>url</em>, dependencies=[Depends(<em>depfunc</em>)])</pre>&#13;
&#13;
<p>Let’s try that in <a data-type="xref" href="#ex-6-3">Example 6-3</a>.</p>&#13;
<div data-type="example" id="ex-6-3">&#13;
<h5><span class="label">Example 6-3. </span>Define a user check dependency</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">FastAPI</code><code class="p">,</code> <code class="n">Depends</code><code class="p">,</code> <code class="n">Params</code>&#13;
&#13;
<code class="n">app</code> <code class="o">=</code> <code class="n">FastAPI</code><code class="p">()</code>&#13;
&#13;
<code class="c1"># the dependency function:</code>&#13;
<code class="k">def</code> <code class="nf">check_dep</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code> <code class="o">=</code> <code class="n">Params</code><code class="p">,</code> <code class="n">password</code><code class="p">:</code> <code class="nb">str</code> <code class="o">=</code> <code class="n">Params</code><code class="p">):</code>&#13;
    <code class="k">if</code> <code class="ow">not</code> <code class="n">name</code><code class="p">:</code>&#13;
        <code class="k">raise</code>&#13;
&#13;
<code class="c1"># the path function / web endpoint:</code>&#13;
<code class="nd">@app</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/check_user"</code><code class="p">,</code> <code class="n">dependencies</code><code class="o">=</code><code class="p">[</code><code class="n">Depends</code><code class="p">(</code><code class="n">check_dep</code><code class="p">)])</code>&#13;
<code class="k">def</code> <code class="nf">check_user</code><code class="p">()</code> <code class="o">-&gt;</code> <code class="nb">bool</code><code class="p">:</code>&#13;
    <code class="k">return</code> <code class="kc">True</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Multiple Paths" data-type="sect2"><div class="sect2" id="id306">&#13;
<h2>Multiple Paths</h2>&#13;
&#13;
<p><a data-type="xref" href="ch09.html#ch09">Chapter 9</a> gives more details on how to structure a&#13;
larger FastAPI application,&#13;
including defining more than one <em>router</em> object&#13;
under a top-level application,&#13;
instead of attaching every endpoint to the top-level&#13;
application.&#13;
<a data-type="xref" href="#ex-6-4">Example 6-4</a> sketches the idea.</p>&#13;
<div data-type="example" id="ex-6-4">&#13;
<h5><span class="label">Example 6-4. </span>Define a subrouter dependency</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code><code> </code><code class="nn">fastapi</code><code> </code><code class="kn">import</code><code> </code><code class="n">FastAPI</code><code class="p">,</code><code> </code><code class="n">Depends</code><code class="p">,</code><code> </code><code class="n">APIRouter</code><code>&#13;
</code><code>&#13;
</code><code class="n">router</code><code> </code><code class="o">=</code><code> </code><code class="n">APIRouter</code><code class="p">(</code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code class="p">,</code><code> </code><code class="n">dependencies</code><code class="o">=</code><code class="p">[</code><code class="n">Depends</code><code class="p">(</code><em><code class="n">depfunc</code></em><code class="p">)</code><code class="p">]</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>This will cause <em><code>depfunc()</code></em>&#13;
to be called for all path functions&#13;
under <code>router</code>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Global" data-type="sect2"><div class="sect2" id="id60">&#13;
<h2>Global</h2>&#13;
&#13;
<p>When you define your top-level FastAPI application object,&#13;
you can add dependencies to it that will apply to all its path functions,&#13;
as shown in <a data-type="xref" href="#ex-6-5">Example 6-5</a>.</p>&#13;
<div data-type="example" id="ex-6-5">&#13;
<h5><span class="label">Example 6-5. </span>Define app-level dependencies</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">FastAPI</code><code class="p">,</code> <code class="n">Depends</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">depfunc1</code><code class="p">():</code>&#13;
    <code class="k">pass</code>&#13;
&#13;
<code class="k">def</code> <code class="nf">depfunc2</code><code class="p">():</code>&#13;
    <code class="k">pass</code>&#13;
&#13;
<code class="n">app</code> <code class="o">=</code> <code class="n">FastAPI</code><code class="p">(</code><code class="n">dependencies</code><code class="o">=</code><code class="p">[</code><code class="n">Depends</code><code class="p">(</code><code class="n">depfunc1</code><code class="p">),</code> <code class="n">Depends</code><code class="p">(</code><code class="n">depfunc2</code><code class="p">)])</code>&#13;
&#13;
<code class="nd">@app</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/main"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">get_main</code><code class="p">():</code>&#13;
    <code class="k">pass</code></pre></div>&#13;
&#13;
<p>In this case, you’re using <code>pass</code> to ignore the other details&#13;
to show how to attach the <a data-primary="dependencies" data-secondary="scope of" data-startref="icd052" data-type="indexterm" id="id573"/>dependencies<a data-primary="dependencies" data-startref="icd054" data-type="indexterm" id="id574"/>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Review" data-type="sect1"><div class="sect1" id="id307">&#13;
<h1>Review</h1>&#13;
&#13;
<p>This chapter discussed dependencies and&#13;
dependency injection—ways of getting the data you need when you need it,&#13;
in a straightforward way. Coming up in the next chapter: Flask, Django, and FastAPI walk into a bar…​</p>&#13;
</div></section>&#13;
</div></section></body></html>