<html><head></head><body>
<div id="sbo-rt-content"><section data-pdf-bookmark="Chapter 7. Working Incrementally" data-type="chapter" epub:type="chapter"><div class="chapter" id="chapter_working_incrementally">
<h1><span class="label">Chapter 7. </span>Working Incrementally</h1>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id389">
<h1>A Note for Early Release Readers</h1>
<p>With Early Release ebooks, you get books in their earliest form—the author’s raw and unedited content as they write—so you can take advantage of these technologies long before the official release of these titles.</p>
<p>This will be the 7th chapter of the final book. The GitHub repo is available at <a class="bare" href="https://github.com/hjwp/book-example"><em class="hyperlink">https://github.com/hjwp/book-example</em></a>.</p>
<p>If you have comments about how we might improve the content and/or examples in this book, or if you notice missing material within this chapter, please reach out to the author at <a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a>.</p>
</div></aside>
<p><a data-primary="Test-Driven Development (TDD)" data-secondary="adapting existing code incrementally" data-type="indexterm" id="TDDadapt07"/>
<a data-primary="Testing Goat" data-secondary="working state to working state" data-type="indexterm" id="id390"/>
Now let’s address our real problem,
which is that our design only allows for one global list.
In this chapter I’ll demonstrate a critical TDD technique:
how to adapt existing code using an incremental, step-by-step process
which takes you from working state to working state.
Testing Goat, not Refactoring Cat.</p>
<section data-pdf-bookmark="Small Design When Necessary" data-type="sect1"><div class="sect1" id="id45">
<h1>Small Design When Necessary</h1>
<p><a data-primary="small vs. big design" data-type="indexterm" id="small07"/>
<a data-primary="multiple lists testing" data-secondary="small vs. big design" data-type="indexterm" id="MLTsmall07"/>
Let’s have a think about how we want support for multiple lists to work.</p>
<p>At the moment the only URL for our site is the homepage,
and that’s why there’s only one global list.
The most obvious way to support multiple lists is to say that each list gets its own URL,
so that people can start multiple lists,
or so that different people can have different lists.
How might that work?</p>
<section data-pdf-bookmark="Not Big Design Up Front" data-type="sect2"><div class="sect2" id="id46">
<h2>Not Big Design Up Front</h2>
<p><a data-primary="agile movement" data-type="indexterm" id="id391"/>
<a data-primary="Big Design Up Front" data-type="indexterm" id="id392"/>
<a data-primary="minimum viable applications" data-type="indexterm" id="id393"/>
TDD is closely associated with the agile movement in software development,
which includes a reaction against <em>Big Design Up Front</em>,
the traditional software engineering practice whereby,
after a lengthy requirements gathering exercise,
there is an equally lengthy design stage where the software is planned out on paper.
The agile philosophy is that you learn more from solving problems in practice than in theory,
especially when you confront your application with real users as soon as possible.
Instead of a long up-front design phase,
we try to put a <em>minimum viable application</em> out there early,
and let the design evolve gradually based on feedback from real-world usage.</p>
<p>But that doesn’t mean that thinking about design is outright banned!
In the last big chapter we saw how just blundering ahead without thinking can <em>eventually</em> get us to the right answer,
but often a little thinking about design can help us get there faster.
So, let’s think about our minimum viable lists app,
and what kind of design we’ll need to deliver it:</p>
<ul>
<li>
<p>We want each user to be able to store their own list—​at least one, for now.</p>
</li>
<li>
<p>A list is made up of several items, whose primary attribute is a bit of descriptive text.</p>
</li>
<li>
<p>We need to save lists from one visit to the next.
For now, we can give each user a unique URL for their list.
Later on we may want some way of automatically recognising users and showing them their lists.</p>
</li>
</ul>
<p>To deliver the “for now” items,
it sounds like we’re going to store lists and their items in a database.
Each list will have a unique URL,
and each list item will be a bit of descriptive text, associated with a particular list.</p>
</div></section>
<section data-pdf-bookmark="YAGNI!" data-type="sect2"><div class="sect2" id="id47">
<h2>YAGNI!</h2>
<p><a data-primary="Test-Driven Development (TDD)" data-secondary="philosophy of" data-tertiary="YAGNI" data-type="indexterm" id="id394"/>
<a data-primary="YAGNI (You ain’t gonna need it!)" data-type="indexterm" id="id395"/>
Once you start thinking about design, it can be hard to stop.
All sorts of other thoughts are occurring to us—​we might want to give each list a name or title,
we might want to recognise users using usernames and passwords,
we might want to add a longer notes field as well as short descriptions to our list,
we might want to store some kind of ordering, and so on.
But we obey another tenet of the agile gospel:  “YAGNI” (pronounced yag-knee),
which stands for “You ain’t gonna need it!”
As software developers, we have fun creating things,
and sometimes it’s hard to resist the urge to build things
just because an idea occurred to us and we <em>might</em> need it.
The trouble is that more often than not, no matter how cool the idea was,
you <em>won’t</em> end up using it.
Instead you have a load of unused code, adding to the complexity of your application.
YAGNI is the mantra we use to resist our overenthusiastic creative urges.</p>
</div></section>
<section data-pdf-bookmark="REST (ish)" data-type="sect2"><div class="sect2" id="id48">
<h2>REST (ish)</h2>
<p><a data-primary="Representational State Transfer (REST)" data-secondary="inspiration gained from" data-type="indexterm" id="id396"/>
<a data-primary="Model-View-Controller (MVC) pattern" data-type="indexterm" id="id397"/>
We have an idea of the data structure we want—​the Model part of
Model-View-Controller (MVC).  What about the View and Controller parts?
How should the user interact with <code>List</code>s and their <code>Item</code>s using a web browser?</p>
<p>Representational State Transfer (REST) is an approach to web design
that’s usually used to guide the design of web-based APIs.
When designing a user-facing site,
it’s not possible to stick <em>strictly</em> to the REST rules,
but they still provide some useful inspiration
(skip ahead to [Link to Come] if you want to see a real REST API).</p>
<p>REST suggests that we have a URL structure that matches our data structure,
in this case lists and list items.
Each list can have its own URL:</p>
<pre class="skipme" data-type="programlisting">    /lists/&lt;list identifier&gt;/</pre>
<p>That will fulfill the requirement we’ve specified in our FT.
To view a list, we use a GET request (a normal browser visit to the page).</p>
<p>To create a brand new list, we’ll have a special URL that accepts POST requests:</p>
<pre class="skipme" data-type="programlisting">    /lists/new</pre>
<p>To add a new item to an existing list,
we’ll have a separate URL, to which we can send POST requests:</p>
<pre class="skipme" data-type="programlisting">    /lists/&lt;list identifier&gt;/add_item</pre>
<p>(Again, we’re not trying to perfectly follow the rules of REST, which would use a PUT request
here—​we’re just using REST for inspiration.
Apart from anything else, you can’t use PUT in a standard HTML form.)</p>
<p><a data-primary="" data-startref="small07" data-type="indexterm" id="id398"/>
<a data-primary="" data-startref="MLTsmall07" data-type="indexterm" id="id399"/>
In summary, our scratchpad for this chapter looks something like this:</p>
<aside class="scratchpad" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id400">
<h1/>
<ul>
<li>
<p><em>Adjust model so that items are associated with different lists</em></p>
</li>
<li>
<p><em>Add unique URLs for each list</em></p>
</li>
<li>
<p><em>Add a URL for creating a new list via POST</em></p>
</li>
<li>
<p><em>Add URLs for adding a new item to an existing list via POST</em></p>
</li>
</ul>
</div></aside>
</div></section>
</div></section>
<section data-pdf-bookmark="Implementing the New Design Incrementally Using TDD" data-type="sect1"><div class="sect1" id="id82">
<h1>Implementing the New Design Incrementally Using TDD</h1>
<p><a data-primary="Test-Driven Development (TDD)" data-secondary="overall process of" data-type="indexterm" id="id401"/>
<a data-primary="multiple lists testing" data-secondary="incremental design implementation" data-type="indexterm" id="id402"/>
How do we use TDD to implement the new design?
Let’s take another look at the flowchart for the TDD process in [Link to Come].</p>
<p>At the top level, we’re going to use a combination of adding new functionality
(by adding a new FT and writing new application code),
and refactoring our application—​that is,
rewriting some of the existing implementation
so that it delivers the same functionality to the user
but using aspects of our new design.
We’ll be able to use the existing functional test
to verify we don’t break what already works,
and the new functional test to drive the new features.</p>
<p>At the unit test level,
we’ll be adding new tests or modifying existing ones
to test for the changes we want,
and we’ll be able to similarly use the unit tests
we <em>don’t</em> touch to help make sure we don’t break anything in the process.</p>
<figure><div class="figure" id="double-loop-tdd-diagram-2">
<img alt="An inner red/green/refactor loop surrounded by an outer red/green of FTs" height="2290" src="assets/double-loop-tdd-simpler.png" width="2761"/>
<h6><span class="label">Figure 7-1. </span>The TDD Process With Both Functional and Unit Tests</h6>
</div></figure>
</div></section>
<section class="pagebreak-before less_space" data-pdf-bookmark="Ensuring We Have a Regression Test" data-type="sect1"><div class="sect1" id="id49">
<h1>Ensuring We Have a Regression Test</h1>
<p><a data-primary="regression" data-type="indexterm" id="regression07"/>
<a data-primary="multiple lists testing" data-secondary="regression test" data-type="indexterm" id="MLTregression07"/>
Let’s translate our scratchpad into a new functional test method, which
introduces a second user and checks that their to-do list is separate from
Edith’s.</p>
<p>We’ll start out very similarly to the first. Edith adds a first item to
create a to-do list, but we introduce our first new assertion—Edith’s
list should live at its own, unique URL:</p>
<div class="sourcecode" data-type="example">
<p>functional_tests/tests.py (ch07l005)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code><code> </code><code class="nf">test_can_start_a_todo_list</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="c1"># Edith has heard about a cool new online to-do app.</code><code>
</code><code>    </code><code class="p">[</code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code class="p">]</code><code>
</code><code>    </code><code class="c1"># The page updates again, and now shows both items on her list</code><code>
</code><code>    </code><code class="bp">self</code><code class="o">.</code><code class="n">wait_for_row_in_list_table</code><code class="p">(</code><code class="s2">"</code><code class="s2">1: Buy peacock feathers</code><code class="s2">"</code><code class="p">)</code><code>
</code><code>    </code><code class="bp">self</code><code class="o">.</code><code class="n">wait_for_row_in_list_table</code><code class="p">(</code><code class="s2">"</code><code class="s2">2: Use peacock feathers to make a fly</code><code class="s2">"</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="c1"># Satisfied, she goes back to sleep</code><code>
</code><code>
</code><code class="k">def</code><code> </code><code class="nf">test_multiple_users_can_start_lists_at_different_urls</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="c1"># Edith starts a new to-do list</code><code>
</code><code>    </code><code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">live_server_url</code><code class="p">)</code><code>
</code><code>    </code><code class="n">inputbox</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code class="o">.</code><code class="n">find_element</code><code class="p">(</code><code class="n">By</code><code class="o">.</code><code class="n">ID</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">id_new_item</code><code class="s2">"</code><code class="p">)</code><code>
</code><code>    </code><code class="n">inputbox</code><code class="o">.</code><code class="n">send_keys</code><code class="p">(</code><code class="s2">"</code><code class="s2">Buy peacock feathers</code><code class="s2">"</code><code class="p">)</code><code>
</code><code>    </code><code class="n">inputbox</code><code class="o">.</code><code class="n">send_keys</code><code class="p">(</code><code class="n">Keys</code><code class="o">.</code><code class="n">ENTER</code><code class="p">)</code><code>
</code><code>    </code><code class="bp">self</code><code class="o">.</code><code class="n">wait_for_row_in_list_table</code><code class="p">(</code><code class="s2">"</code><code class="s2">1: Buy peacock feathers</code><code class="s2">"</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="c1"># She notices that her list has a unique URL</code><code>
</code><code>    </code><code class="n">edith_list_url</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code class="o">.</code><code class="n">current_url</code><code>
</code><code>    </code><code class="bp">self</code><code class="o">.</code><code class="n">assertRegex</code><code class="p">(</code><code class="n">edith_list_url</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">/lists/.+</code><code class="s2">"</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_incrementally_CO1-1" id="co_working_incrementally_CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></pre></div>
<dl class="calloutlist">
<dt><a class="co" href="#co_working_incrementally_CO1-1" id="callout_working_incrementally_CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p><code>assertRegex</code> is a helper function from <code>unittest</code>
that checks whether a string matches a regular expression.
We use it to check that our new REST-ish design has been implemented.
Find out more in the <a href="http://docs.python.org/3/library/unittest.xhtml"><code>unittest</code> documentation</a>.
<a data-primary="assertRegex" data-type="indexterm" id="id403"/>
<a data-primary="unittest module" data-secondary="documentation" data-type="indexterm" id="id404"/></p></dd>
</dl>
<p>Next we imagine a new user coming along.
We want to check that they don’t see any of Edith’s items
when they visit the home page,
and that they get their own unique URL for their list:</p>
<div class="sourcecode" data-type="example">
<p>functional_tests/tests.py (ch07l006)</p>
<pre data-code-language="python" data-type="programlisting"><code>    </code><code class="p">[</code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code class="p">]</code><code>
</code><code>    </code><code class="bp">self</code><code class="o">.</code><code class="n">assertRegex</code><code class="p">(</code><code class="n">edith_list_url</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">/lists/.+</code><code class="s2">"</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="c1"># Now a new user, Francis, comes along to the site.</code><code>
</code><code>
</code><code>    </code><code class="c1">## We delete all the browser's cookies</code><code>
</code><code>    </code><code class="c1">## as a way of simulating a brand new user session  </code><a class="co" href="#callout_working_incrementally_CO2-1" id="co_working_incrementally_CO2-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code>    </code><code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code class="o">.</code><code class="n">delete_all_cookies</code><code class="p">(</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="c1"># Francis visits the home page.  There is no sign of Edith's</code><code>
</code><code>    </code><code class="c1"># list</code><code>
</code><code>    </code><code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">live_server_url</code><code class="p">)</code><code>
</code><code>    </code><code class="n">page_text</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code class="o">.</code><code class="n">find_element</code><code class="p">(</code><code class="n">By</code><code class="o">.</code><code class="n">TAG_NAME</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">body</code><code class="s2">"</code><code class="p">)</code><code class="o">.</code><code class="n">text</code><code>
</code><code>    </code><code class="bp">self</code><code class="o">.</code><code class="n">assertNotIn</code><code class="p">(</code><code class="s2">"</code><code class="s2">Buy peacock feathers</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">page_text</code><code class="p">)</code><code>
</code><code>    </code><code class="bp">self</code><code class="o">.</code><code class="n">assertNotIn</code><code class="p">(</code><code class="s2">"</code><code class="s2">make a fly</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">page_text</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="c1"># Francis starts a new list by entering a new item. He</code><code>
</code><code>    </code><code class="c1"># is less interesting than Edith...</code><code>
</code><code>    </code><code class="n">inputbox</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code class="o">.</code><code class="n">find_element</code><code class="p">(</code><code class="n">By</code><code class="o">.</code><code class="n">ID</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">id_new_item</code><code class="s2">"</code><code class="p">)</code><code>
</code><code>    </code><code class="n">inputbox</code><code class="o">.</code><code class="n">send_keys</code><code class="p">(</code><code class="s2">"</code><code class="s2">Buy milk</code><code class="s2">"</code><code class="p">)</code><code>
</code><code>    </code><code class="n">inputbox</code><code class="o">.</code><code class="n">send_keys</code><code class="p">(</code><code class="n">Keys</code><code class="o">.</code><code class="n">ENTER</code><code class="p">)</code><code>
</code><code>    </code><code class="bp">self</code><code class="o">.</code><code class="n">wait_for_row_in_list_table</code><code class="p">(</code><code class="s2">"</code><code class="s2">1: Buy milk</code><code class="s2">"</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="c1"># Francis gets his own unique URL</code><code>
</code><code>    </code><code class="n">francis_list_url</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code class="o">.</code><code class="n">current_url</code><code>
</code><code>    </code><code class="bp">self</code><code class="o">.</code><code class="n">assertRegex</code><code class="p">(</code><code class="n">francis_list_url</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">/lists/.+</code><code class="s2">"</code><code class="p">)</code><code>
</code><code>    </code><code class="bp">self</code><code class="o">.</code><code class="n">assertNotEqual</code><code class="p">(</code><code class="n">francis_list_url</code><code class="p">,</code><code> </code><code class="n">edith_list_url</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="c1"># Again, there is no trace of Edith's list</code><code>
</code><code>    </code><code class="n">page_text</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code class="o">.</code><code class="n">find_element</code><code class="p">(</code><code class="n">By</code><code class="o">.</code><code class="n">TAG_NAME</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">body</code><code class="s2">"</code><code class="p">)</code><code class="o">.</code><code class="n">text</code><code>
</code><code>    </code><code class="bp">self</code><code class="o">.</code><code class="n">assertNotIn</code><code class="p">(</code><code class="s2">"</code><code class="s2">Buy peacock feathers</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">page_text</code><code class="p">)</code><code>
</code><code>    </code><code class="bp">self</code><code class="o">.</code><code class="n">assertIn</code><code class="p">(</code><code class="s2">"</code><code class="s2">Buy milk</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">page_text</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="c1"># Satisfied, they both go back to sleep</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" href="#co_working_incrementally_CO2-1" id="callout_working_incrementally_CO2-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>I’m using the convention of double-hashes (<code>##</code>)
to indicate “meta-comments”—comments
about <em>how</em> the test is working and why—​so that
we can distinguish them from regular comments in FTs
which explain the User Story.
They’re a message to our future selves,
which might otherwise be wondering why we’re
faffing about deleting cookies…​
<a data-primary="double-hashes (##)" data-type="indexterm" id="id405"/>
<a data-primary="## (double-hashes)" data-type="indexterm" id="id406"/>
<a data-primary="meta-comments" data-type="indexterm" id="id407"/></p></dd>
</dl>
<p>Other than that, the new test is fairly self-explanatory.
Let’s see how we do when we run our FTs:</p>
<pre data-type="programlisting">$ <strong>python manage.py test functional_tests</strong>
[...]
.F
======================================================================
FAIL: test_multiple_users_can_start_lists_at_different_urls (functional_tests.t
ests.NewVisitorTest.test_multiple_users_can_start_lists_at_different_urls)

 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...goat-book/functional_tests/tests.py", line 77, in
test_multiple_users_can_start_lists_at_different_urls
    self.assertRegex(edith_list_url, "/lists/.+")
AssertionError: Regex didn't match: '/lists/.+' not found in
'http://localhost:8081/'

 ---------------------------------------------------------------------
Ran 2 tests in 5.786s

FAILED (failures=1)</pre>
<p><a data-primary="" data-startref="regression07" data-type="indexterm" id="id408"/>
<a data-primary="" data-startref="MLTregression07" data-type="indexterm" id="id409"/>
Good, our first test still passes,
and the second one fails where we might expect.
Let’s do a commit, and then go and build some new models and views:</p>
<pre data-type="programlisting">$ <strong>git commit -a</strong></pre>
</div></section>
<section data-pdf-bookmark="Iterating Towards the New Design" data-type="sect1"><div class="sect1" id="id50">
<h1>Iterating Towards the New Design</h1>
<p><a data-primary="multiple lists testing" data-secondary="iterative development style" data-type="indexterm" id="id410"/>
<a data-primary="iterative development style" data-type="indexterm" id="id411"/>
Being all excited about our new design,
I had an overwhelming urge to dive in at this point
and start changing <em>models.py</em>,
which would have broken half the unit tests,
and then pile in and change almost every single line of code,
all in one go.
That’s a natural urge,
and TDD, as a discipline, is a constant fight against it.
Obey the Testing Goat, not Refactoring Cat!
We don’t need to implement our new, shiny design in a single big bang.
Let’s make small changes
that take us from a working state to a working state,
with our design guiding us gently at each stage.</p>
<p>There are four items on our to-do list.
The FT, with its <code>Regex didn't match</code> error,
is suggesting to us that the second item—​giving lists their own URL
and identifier—​is the one we should work on next.
Let’s have a go at fixing that, and only that.</p>
<p>The URL comes from the redirect after POST.
In <em>lists/tests.py</em>, let’s find <code>test_redirects_after_POST</code>,
and change the expected redirect location:</p>
<div class="sourcecode" data-type="example">
<p>lists/tests.py (ch07l007)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">test_redirects_after_POST</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
    <code class="n">response</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">client</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"/"</code><code class="p">,</code> <code class="n">data</code><code class="o">=</code><code class="p">{</code><code class="s2">"item_text"</code><code class="p">:</code> <code class="s2">"A new list item"</code><code class="p">})</code>
    <code class="bp">self</code><code class="o">.</code><code class="n">assertRedirects</code><code class="p">(</code><code class="n">response</code><code class="p">,</code> <code class="s2">"/lists/the-only-list-in-the-world/"</code><code class="p">)</code></pre></div>
<p>Does that seem slightly strange?
Clearly, <em>/lists/the-only-list-in-the-world</em> isn’t a URL
that’s going to feature in the final design of our application.
But we’re committed to changing one thing at a time.
While our application only supports one list,
this is the only URL that makes sense.
We’re still moving forwards,
in that we’ll have a different URL for our list and our home page,
which is a step along the way to a more REST-ful design.
Later, when we have multiple lists, it will be easy to change.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Another way of thinking about it
    is as a problem-solving 
<span class="keep-together">technique</span>:
    our new URL design is currently not implemented,
    so it works for 0 items.
    Ultimately, we want to solve for <em>n</em> items,
    but solving for 1 item is a good step along the way.</p>
</div>
<p>Running the unit tests gives us an expected fail:</p>
<pre data-type="programlisting">$ <strong>python manage.py test lists</strong>
[...]
AssertionError: '/' != '/lists/the-only-list-in-the-world/'
[...]</pre>
<p>We can go adjust our <code>home_page</code> view in <em>lists/views.py</em>:</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch07l008)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">home_page</code><code class="p">(</code><code class="n">request</code><code class="p">):</code>
    <code class="k">if</code> <code class="n">request</code><code class="o">.</code><code class="n">method</code> <code class="o">==</code> <code class="s2">"POST"</code><code class="p">:</code>
        <code class="n">Item</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">text</code><code class="o">=</code><code class="n">request</code><code class="o">.</code><code class="n">POST</code><code class="p">[</code><code class="s2">"item_text"</code><code class="p">])</code>
        <code class="k">return</code> <code class="n">redirect</code><code class="p">(</code><code class="s2">"/lists/the-only-list-in-the-world/"</code><code class="p">)</code>

    <code class="n">items</code> <code class="o">=</code> <code class="n">Item</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">all</code><code class="p">()</code>
    <code class="k">return</code> <code class="n">render</code><code class="p">(</code><code class="n">request</code><code class="p">,</code> <code class="s2">"home.xhtml"</code><code class="p">,</code> <code class="p">{</code><code class="s2">"items"</code><code class="p">:</code> <code class="n">items</code><code class="p">})</code></pre></div>
<p>Django’s unit test runner picks up on the fact that this
is not a real URL yet:</p>
<pre data-type="programlisting">$ <strong>python3 manage.py test lists</strong>
[...]
AssertionError: 404 != 200 : Couldn't retrieve redirection page
'/lists/the-only-list-in-the-world/': response code was 404 (expected 200)</pre>
</div></section>
<section data-pdf-bookmark="Taking a First, Self-Contained Step: One New URL" data-type="sect1"><div class="sect1" id="id51">
<h1>Taking a First, Self-Contained Step: One New URL</h1>
<p><a data-primary="URL mappings" data-type="indexterm" id="url07"/>
Our singleton list URL doesn’t exist yet.
We fix that in <em>superlists/urls.py</em>.</p>
<div class="sourcecode small-code" data-type="example">
<p>superlists/urls.py (ch07l009)</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code><code> </code><code class="nn">django</code><code class="nn">.</code><code class="nn">urls</code><code> </code><code class="kn">import</code><code> </code><code class="n">path</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">lists</code><code> </code><code class="kn">import</code><code> </code><code class="n">views</code><code>
</code><code>
</code><code class="n">urlpatterns</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code>
</code><code>    </code><code class="n">path</code><code class="p">(</code><code class="s2">"</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">views</code><code class="o">.</code><code class="n">home_page</code><code class="p">,</code><code> </code><code class="n">name</code><code class="o">=</code><code class="s2">"</code><code class="s2">home</code><code class="s2">"</code><code class="p">)</code><code class="p">,</code><code>
</code><code>    </code><code class="n">path</code><code class="p">(</code><code class="s2">"</code><code class="s2">lists/the-only-list-in-the-world/</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">views</code><code class="o">.</code><code class="n">home_page</code><code class="p">,</code><code> </code><code class="n">name</code><code class="o">=</code><code class="s2">"</code><code class="s2">view_list</code><code class="s2">"</code><code class="p">)</code><code class="p">,</code><code>  </code><a class="co" href="#callout_working_incrementally_CO3-1" id="co_working_incrementally_CO3-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code class="p">]</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" href="#co_working_incrementally_CO3-1" id="callout_working_incrementally_CO3-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>We’ll just point our new URL at the existing home page view.
This is the minimimal change.</p></dd>
</dl>
<div data-type="tip"><h6>Tip</h6>
<p>Watch out for trailing slashes in URLs,
    both here in <em>urls.py</em> and in the tests.
    They’re a common source of bugs.
    <a data-primary="troubleshooting" data-secondary="URL mappings" data-type="indexterm" id="id412"/></p>
</div>
<p>That gets our unit tests passing:</p>
<pre data-type="programlisting">$ <strong>python3 manage.py test lists</strong>
[...]
OK</pre>
<p>What do the FTs think?</p>
<pre data-type="programlisting">$ <strong>python3 manage.py test functional_tests</strong>
[...]
AssertionError: 'Buy peacock feathers' unexpectedly found in 'Your To-Do
list\n1: Buy peacock feathers'</pre>
<p>Good, they get a little further along,
we now confirm that we have a new URL,
but the actual page content is still the same,
it shows the old list.</p>
<section data-pdf-bookmark="Separating out our home page and list view functionality" data-type="sect2"><div class="sect2" id="id140">
<h2>Separating out our home page and list view functionality</h2>
<p>We now have two URLs,
but they’re actually doing the exact same thing.
Under the hood, they’re just pointing at the same function.
Continuing to work incrementally,
we can start to break apart the responsibilities
for these two different URLs:
* the home page only needs to display and react to creating
a brand new list based on its first item.
* the list view page needs to be able to display existing list items
and add new items to the list</p>
<p>Let’s split out some tests for our new URL.</p>
<p>Open up <em>lists/tests.py</em>, and add a new test class called <code>ListViewTest</code>.
Then move the method called <code>test_displays_all_list_items</code>
across from <code>HomePageTest</code> into our new class,
changing just the URL that is invoked by <code>self.client.get()</code>:</p>
<div class="sourcecode" data-type="example">
<p>lists/tests.py (ch07l010)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">class</code> <code class="nc">HomePageTest</code><code class="p">(</code><code class="n">TestCase</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf">test_uses_home_template</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="p">[</code><code class="o">...</code><code class="p">]</code>
    <code class="k">def</code> <code class="nf">test_can_save_a_POST_request</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="p">[</code><code class="o">...</code><code class="p">]</code>
    <code class="k">def</code> <code class="nf">test_redirects_after_POST</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="p">[</code><code class="o">...</code><code class="p">]</code>


<code class="k">class</code> <code class="nc">ListViewTest</code><code class="p">(</code><code class="n">TestCase</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf">test_displays_all_list_items</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="n">Item</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">text</code><code class="o">=</code><code class="s2">"itemey 1"</code><code class="p">)</code>
        <code class="n">Item</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">text</code><code class="o">=</code><code class="s2">"itemey 2"</code><code class="p">)</code>
        <code class="n">response</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">client</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/lists/the-only-list-in-the-world/"</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertContains</code><code class="p">(</code><code class="n">response</code><code class="p">,</code> <code class="s2">"itemey 1"</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertContains</code><code class="p">(</code><code class="n">response</code><code class="p">,</code> <code class="s2">"itemey 2"</code><code class="p">)</code></pre></div>
<p>Let’s try running this test now:</p>
<pre data-type="programlisting">$ <strong>python3 manage.py test lists</strong>
OK</pre>
<p>It passes, because the URL is still pointing
at the home_page view.</p>
<p>Let’s make it point at a new view:</p>
<div class="sourcecode" data-type="example">
<p>superlists/urls.py (ch07l011)</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">django.urls</code> <code class="kn">import</code> <code class="n">path</code>
<code class="kn">from</code> <code class="nn">lists</code> <code class="kn">import</code> <code class="n">views</code>

<code class="n">urlpatterns</code> <code class="o">=</code> <code class="p">[</code>
    <code class="n">path</code><code class="p">(</code><code class="s2">""</code><code class="p">,</code> <code class="n">views</code><code class="o">.</code><code class="n">home_page</code><code class="p">,</code> <code class="n">name</code><code class="o">=</code><code class="s2">"home"</code><code class="p">),</code>
    <code class="n">path</code><code class="p">(</code><code class="s2">"lists/the-only-list-in-the-world/"</code><code class="p">,</code> <code class="n">views</code><code class="o">.</code><code class="n">view_list</code><code class="p">,</code> <code class="n">name</code><code class="o">=</code><code class="s2">"view_list"</code><code class="p">),</code>
<code class="p">]</code></pre></div>
<p>That predictably fails because there is no such view function yet:</p>
<pre data-type="programlisting">$ <strong>python3 manage.py test lists</strong>
[...]
    path("lists/the-only-list-in-the-world/", views.view_list,
name="view_list"),
                                              ^^^^^^^^^^^^^^^
AttributeError: module 'lists.views' has no attribute 'view_list'</pre>
<section data-pdf-bookmark="A New View Function" data-type="sect3"><div class="sect3" id="id141">
<h3>A New View Function</h3>
<p>Fair enough.  Let’s create a dummy view function in <em>lists/views.py</em>:</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch07l012-0)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">view_list</code><code class="p">(</code><code class="n">request</code><code class="p">):</code>
    <code class="k">pass</code></pre></div>
<p>Not quite good enough:</p>
<pre data-type="programlisting">ValueError: The view lists.views.view_list didn't return an HttpResponse
object. It returned None instead.

[...]
FAILED (errors=2)</pre>
<p>Looking for the minimal code change,
let’s just make the view return our existing <em>home.xhtml</em> template,
but with nothing in it:</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch07l012-1)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">view_list</code><code class="p">(</code><code class="n">request</code><code class="p">):</code>
    <code class="k">return</code> <code class="n">render</code><code class="p">(</code><code class="n">request</code><code class="p">,</code> <code class="s2">"home.xhtml"</code><code class="p">)</code></pre></div>
<p>Now the tests guide us to making sure that our list view
shows existing list items:</p>
<pre data-type="programlisting">AssertionError: False is not true : Couldn't find 'itemey 1' in response</pre>
<p>So let’s copy the last two lines from <code>home_page</code>  more directly:</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch07l012)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">view_list</code><code class="p">(</code><code class="n">request</code><code class="p">):</code>
    <code class="n">items</code> <code class="o">=</code> <code class="n">Item</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">all</code><code class="p">()</code>
    <code class="k">return</code> <code class="n">render</code><code class="p">(</code><code class="n">request</code><code class="p">,</code> <code class="s2">"home.xhtml"</code><code class="p">,</code> <code class="p">{</code><code class="s2">"items"</code><code class="p">:</code> <code class="n">items</code><code class="p">})</code></pre></div>
<p>That gets us to passing unit tests!</p>
<pre data-type="programlisting">Ran 6 tests in 0.035s

OK</pre>
</div></section>
</div></section>
<section data-pdf-bookmark="The FTs detect a regression" data-type="sect2"><div class="sect2" id="id83">
<h2>The FTs detect a regression</h2>
<p>As always when we get to passing unit tests,
we run the functional tests to check how things are doing
“in real life”:</p>
<pre data-type="programlisting">$ <strong>python manage.py test functional_tests</strong>
[...]
FF
======================================================================
FAIL: test_can_start_a_todo_list
(functional_tests.tests.NewVisitorTest.test_can_start_a_todo_list)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...goat-book/functional_tests/tests.py", line 63, in
test_can_start_a_todo_list
[...]
AssertionError: '2: Use peacock feathers to make a fly' not found in ['1: Buy
peacock feathers']

======================================================================
FAIL: test_multiple_users_can_start_lists_at_different_urls (functional_tests.t
ests.NewVisitorTest.test_multiple_users_can_start_lists_at_different_urls)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...goat-book/functional_tests/tests.py", line 89, in
test_multiple_users_can_start_lists_at_different_urls
    self.assertNotIn("Buy peacock feathers", page_text)
AssertionError: 'Buy peacock feathers' unexpectedly found in 'Your To-Do
list\n1: Buy peacock feathers'</pre>
<p>Not only is our new test failing, but the old one is too.
That tells us we’ve introduced a <em>regression</em>.</p>
<p>What are they trying to tell us?</p>
<p><a data-primary="debugging" data-secondary="of functional tests" data-type="indexterm" id="id413"/>
<a data-primary="functional tests (FTs)" data-secondary="debugging techniques" data-type="indexterm" id="id414"/>
<a data-primary="POST requests" data-secondary="debugging" data-type="indexterm" id="id415"/>
<a data-primary="HTML" data-secondary="POST requests" data-tertiary="debugging" data-type="indexterm" id="id416"/>
Both tests are failing when we try to add the second item.
We have to put our debugging hats on here.
We know the home page is working, because the test has got all
the way down to line 63 in the first FT,
so we’ve at least added a first item.
And our unit tests are all passing,
so we’re pretty sure the URLs and views that we <em>do</em> have are doing what they should.
Let’s have a quick look at those unit tests to see what they tell us:</p>
<pre data-type="programlisting">$ <strong>grep -E "class|def" lists/tests.py</strong>
class HomePageTest(TestCase):
    def test_uses_home_template(self):
    def test_can_save_a_POST_request(self):
    def test_redirects_after_POST(self):
    def test_only_saves_items_when_necessary(self):
class ListViewTest(TestCase):
    def test_displays_all_list_items(self):
class ItemModelTest(TestCase):
    def test_saving_and_retrieving_items(self):</pre>
<p>The home page displays the right template, and can handle POST requests,
and the <em>/only-list-in-the-world/</em> view knows how to display all items…​
but it doesn’t know how to handle POST requests.
Ah, that gives us a clue.</p>
<p>A second clue is the rule of thumb that,
when all the unit tests are passing
but the functional tests aren’t,
it’s often pointing at a problem that’s not
covered by the unit tests,
and in our case, that’s often a template problem.</p>
<p>The answer is that our <em>home.xhtml</em> input form
currently doesn’t specify an explicit URL to POST to:</p>
<div class="sourcecode currentcontents" data-type="example">
<p>lists/templates/home.xhtml</p>
<pre data-code-language="html" data-type="programlisting">        <code class="p">&lt;</code><code class="nt">form</code> <code class="na">method</code><code class="o">=</code><code class="s">"POST"</code><code class="p">&gt;</code></pre></div>
<p>By default the browser sends the POST data back to the same URL it’s currently
on.
When we’re on the home page that works fine,
but when we’re on our <em>/only-list-in-the-world/</em> page, it doesn’t.</p>
</div></section>
<section data-pdf-bookmark="Getting Back to a Working State as Quickly as Possible" data-type="sect2"><div class="sect2" id="id52">
<h2>Getting Back to a Working State as Quickly as Possible</h2>
<p>Now we could dive in and add POST request handling to our new view,
but that would involve writing a bunch more tests and code,
and at this point we’d like to get back to a working state as quickly as possible.
Actually the <em>quickest</em> thing we can do to get things fixed
is to just use the existing home page view, which already works, for all POST requests:</p>
<div class="sourcecode" data-type="example">
<p>lists/templates/home.xhtml (ch07l013)</p>
<pre data-code-language="html" data-type="programlisting">    <code class="p">&lt;</code><code class="nt">form</code> <code class="na">method</code><code class="o">=</code><code class="s">"POST"</code> <code class="na">action</code><code class="o">=</code><code class="s">"/"</code><code class="p">&gt;</code></pre></div>
<p>Try that, and we’ll see our FTs get back to a happier place:</p>
<pre data-type="programlisting">FAIL: test_multiple_users_can_start_lists_at_different_urls (functional_tests.t
ests.NewVisitorTest.test_multiple_users_can_start_lists_at_different_urls)
[...]
AssertionError: 'Buy peacock feathers' unexpectedly found in 'Your To-Do
list\n1: Buy peacock feathers'

Ran 2 tests in 8.541s
FAILED (failures=1)</pre>
<p>Our regression test passes once again,
so we know we’re back to a working state.
The new functionality may not be working yet,
but at least the old stuff works as well as it used to.
<a data-primary="" data-startref="url07" data-type="indexterm" id="id417"/></p>
</div></section>
<section data-pdf-bookmark="Green? Refactor" data-type="sect2"><div class="sect2" id="id53">
<h2>Green? Refactor</h2>
<p><a data-primary="multiple lists testing" data-secondary="refactoring" data-type="indexterm" id="id418"/>
<a data-primary="refactoring" data-type="indexterm" id="id419"/>
<a data-primary="Red/Green/Refactor" data-type="indexterm" id="id420"/>
Time for a little tidying up.</p>
<p>In the <em>Red/Green/Refactor</em> dance, we’ve arrived at green,
so we should see what needs a refactor.
We now have two views, one for the home page,
and one for an individual list.
Both are currently using the same template,
and passing it all the list items currently in the database.
Post requests are only handled by the home page though.</p>
<p>It feels like the responsibilities of our two views are a little tangled up.
Let’s try and disentangle them a little.</p>
</div></section>
</div></section>
<section data-pdf-bookmark="Another Small Step: A Separate Template for Viewing Lists" data-type="sect1"><div class="sect1" id="id54">
<h1>Another Small Step: A Separate Template for Viewing Lists</h1>
<p><a data-primary="multiple lists testing" data-secondary="separate list viewing templates" data-type="indexterm" id="MLTseparate07"/>
<a data-primary="templates" data-secondary="separate list viewing templates" data-type="indexterm" id="TMPseparate07"/>
Since the home page and the list view are now quite distinct pages,
they should be using different HTML templates; <em>home.xhtml</em> can have the
single input box, whereas a new template, <em>list.xhtml</em>, can take care
of showing the table of existing items.</p>
<p>Let’s add a new test to check that it’s using a different template:</p>
<div class="sourcecode" data-type="example">
<p>lists/tests.py (ch07l014)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">class</code> <code class="nc">ListViewTest</code><code class="p">(</code><code class="n">TestCase</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf">test_uses_list_template</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="n">response</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">client</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/lists/the-only-list-in-the-world/"</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertTemplateUsed</code><code class="p">(</code><code class="n">response</code><code class="p">,</code> <code class="s2">"list.xhtml"</code><code class="p">)</code>

    <code class="k">def</code> <code class="nf">test_displays_all_list_items</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="p">[</code><code class="o">...</code><code class="p">]</code></pre></div>
<p>Let’s see what it says:</p>
<pre data-type="programlisting">AssertionError: False is not true : Template 'list.xhtml' was not a template
used to render the response. Actual template(s) used: home.xhtml</pre>
<p>Looks about right, let’s change the view:</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch07l015)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">view_list</code><code class="p">(</code><code class="n">request</code><code class="p">):</code>
    <code class="n">items</code> <code class="o">=</code> <code class="n">Item</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">all</code><code class="p">()</code>
    <code class="k">return</code> <code class="n">render</code><code class="p">(</code><code class="n">request</code><code class="p">,</code> <code class="s2">"list.xhtml"</code><code class="p">,</code> <code class="p">{</code><code class="s2">"items"</code><code class="p">:</code> <code class="n">items</code><code class="p">})</code></pre></div>
<p>But, obviously, that template doesn’t exist yet. If we run the unit tests, we
get:</p>
<pre data-type="programlisting">django.template.exceptions.TemplateDoesNotExist: list.xhtml</pre>
<p>Let’s create a new file at <em>lists/templates/list.xhtml</em>:</p>
<pre data-type="programlisting">$ <strong>touch lists/templates/list.xhtml</strong></pre>
<p>A blank template, which gives us this error—​good to know the tests are
there to make sure we fill it in:</p>
<pre data-type="programlisting">AssertionError: False is not true : Couldn't find 'itemey 1' in response</pre>
<p>The template for an individual list will reuse quite a lot of the stuff
we currently have in <em>home.xhtml</em>, so we can start by just copying that:</p>
<pre data-type="programlisting">$ <strong>cp lists/templates/home.xhtml lists/templates/list.xhtml</strong></pre>
<p>That gets the tests back to passing (green).</p>
<pre data-type="programlisting">$ <strong>python manage.py test lists</strong>
[...]
OK</pre>
<p>Now let’s do a little more tidying up (refactoring).
We said the home page doesn’t need to list items,
it only needs the new list input field,
so we can remove some lines from <em>lists/templates/home.xhtml</em>,
and maybe slightly tweak the <code>h1</code> to say “Start a new To-Do list”:</p>
<p>I’ll present the code change as a diff,
which hopefully shows a bit more clearly what we need to modify:</p>
<div class="sourcecode small-code" data-type="example">
<p>lists/templates/home.xhtml (ch07l018)</p>
<pre data-code-language="diff" data-type="programlisting"><code class="w"> </code>  &lt;body&gt;<code class="w"/>
<code class="gd">-    &lt;h1&gt;Your To-Do list&lt;/h1&gt;</code><code class="w"/>
<code class="gi">+    &lt;h1&gt;Start a new To-Do list&lt;/h1&gt;</code><code class="w"/>
<code class="w"> </code>    &lt;form method="POST" action="/"&gt;<code class="w"/>
<code class="w"> </code>      &lt;input name="item_text" id="id_new_item" placeholder="Enter a to-do item" /&gt;<code class="w"/>
<code class="w"> </code>      {% csrf_token %}<code class="w"/>
<code class="w"> </code>    &lt;/form&gt;<code class="w"/>
<code class="gd">-    &lt;table id="id_list_table"&gt;</code><code class="w"/>
<code class="gd">-      {% for item in items %}</code><code class="w"/>
<code class="gd">-        &lt;tr&gt;&lt;td&gt;{{ forloop.counter }}: {{ item.text }}&lt;/td&gt;&lt;/tr&gt;</code><code class="w"/>
<code class="gd">-      {% endfor %}</code><code class="w"/>
<code class="gd">-    &lt;/table&gt;</code><code class="w"/>
<code class="w"> </code>  &lt;/body&gt;<code class="w"/></pre></div>
<p>We rerun the unit tests to check that hasn’t broken anything…​</p>
<pre data-type="programlisting">OK</pre>
<p>Good.</p>
<p>Now there’s actually no need to pass all the items to the <em>home.xhtml</em> template
in our <code>home_page</code> view, so we can simplify that and delete a couple of lines:</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch07l019)</p>
<pre data-code-language="diff" data-type="programlisting"><code class="w"> </code>    if request.method == "POST":<code class="w"/>
<code class="w"> </code>        Item.objects.create(text=request.POST["item_text"])<code class="w"/>
<code class="w"> </code>        return redirect("/lists/the-only-list-in-the-world/")<code class="w"/>
<code class="gd">-</code><code class="w"/>
<code class="gd">-    items = Item.objects.all()</code><code class="w"/>
<code class="gd">-    return render(request, "home.xhtml", {"items": items})</code><code class="w"/>
<code class="gi">+    return render(request, "home.xhtml")</code><code class="w"/></pre></div>
<p>Rerun the unit tests once more; they still pass:</p>
<pre data-type="programlisting">OK</pre>
<p>Time to run the functional tests:</p>
<pre data-type="programlisting">AssertionError: '1: Buy milk' not found in ['1: Buy peacock feathers', '2: Buy
milk']</pre>
<p>Not bad!  Our regression test (the first FT) is passing,
and our new test is now getting slightly further forwards—​it’s
telling us that Francis isn’t getting his own list page
(because he still sees some of Edith’s list items).</p>
<p><a data-primary="" data-startref="MLTseparate07" data-type="indexterm" id="id421"/>
<a data-primary="" data-startref="TMPseparate07" data-type="indexterm" id="id422"/>
It may feel like we haven’t made much headway since,
functionally, the site still behaves almost exactly like it did
when we started the chapter,
but this really is progress.
We’ve started on the road to our new design,
and we’ve implemented a number of stepping stones
<em>without making anything worse than it was before</em>.
Let’s commit our progress so far:</p>
<pre data-type="programlisting">$ <strong>git status</strong> # should show 4 changed files and 1 new file, list.xhtml
$ <strong>git add lists/templates/list.xhtml</strong>
$ <strong>git diff</strong> # should show we've simplified home.xhtml,
           # moved one test to a new class in lists/tests.py added a new view
           # in views.py, and simplified home_page and added a line to urls.py
$ <strong>git commit -a</strong> # add a message summarising the above, maybe something like
                # "new URL, view and template to display lists"</pre>
</div></section>
<section data-pdf-bookmark="A Third Small Step: A New URL for Adding List Items" data-type="sect1"><div class="sect1" id="id55">
<h1>A Third Small Step: A New URL for Adding List Items</h1>
<p><a data-primary="multiple lists testing" data-secondary="list item URLs" data-type="indexterm" id="MLTlist07"/>
<a data-primary="URL mappings" data-type="indexterm" id="urlmap07a"/>
Where are we with our own to-do list?</p>
<aside class="scratchpad" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id423">
<h1/>
<ul>
<li>
<p><em>Adjust model so that items are associated with different lists</em></p>
</li>
<li>
<p><em>Add unique URLs for each list</em> …​</p>
</li>
<li>
<p><em>Add a URL for creating a new list via POST</em></p>
</li>
<li>
<p><em>Add URLs for adding a new item to an existing list via POST</em></p>
</li>
</ul>
</div></aside>
<p>We’ve <em>sort of</em> made progress on the second item,
even if there’s still only one list in the world.
The first item is a bit scary.
Can we do something about items 3 or 4?</p>
<p>Let’s have a new URL for adding new list items at <em>/lists/new</em>:
If nothing else, it’ll simplify the home page view.</p>
<section data-pdf-bookmark="A Test Class for New List Creation" data-type="sect2"><div class="sect2" id="id142">
<h2>A Test Class for New List Creation</h2>
<p>Open up <em>lists/tests.py</em>,
and <em>move</em> the <code>test_can_save_a_POST_request</code> and <code>test_redirects_after_POST</code> methods
into a new class, then change the URL they POST to:</p>
<div class="sourcecode small-code" data-type="example">
<p>lists/tests.py (ch07l020)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">class</code> <code class="nc">NewListTest</code><code class="p">(</code><code class="n">TestCase</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf">test_can_save_a_POST_request</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">client</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"/lists/new"</code><code class="p">,</code> <code class="n">data</code><code class="o">=</code><code class="p">{</code><code class="s2">"item_text"</code><code class="p">:</code> <code class="s2">"A new list item"</code><code class="p">})</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertEqual</code><code class="p">(</code><code class="n">Item</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">count</code><code class="p">(),</code> <code class="mi">1</code><code class="p">)</code>
        <code class="n">new_item</code> <code class="o">=</code> <code class="n">Item</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">get</code><code class="p">()</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertEqual</code><code class="p">(</code><code class="n">new_item</code><code class="o">.</code><code class="n">text</code><code class="p">,</code> <code class="s2">"A new list item"</code><code class="p">)</code>

    <code class="k">def</code> <code class="nf">test_redirects_after_POST</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="n">response</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">client</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"/lists/new"</code><code class="p">,</code> <code class="n">data</code><code class="o">=</code><code class="p">{</code><code class="s2">"item_text"</code><code class="p">:</code> <code class="s2">"A new list item"</code><code class="p">})</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertRedirects</code><code class="p">(</code><code class="n">response</code><code class="p">,</code> <code class="s2">"/lists/the-only-list-in-the-world/"</code><code class="p">)</code></pre></div>
<div data-type="tip"><h6>Tip</h6>
<p>This is another place to pay attention to trailing slashes, incidentally.
    It’s <code>/lists/new</code>, with no trailing slash.
    The convention I’m using is that
    URLs without a trailing slash are “action” URLs which modify the database.</p>
</div>
<p>Try running that:</p>
<pre data-type="programlisting">    self.assertEqual(Item.objects.count(), 1)
AssertionError: 0 != 1
[...]
    self.assertRedirects(response, "/lists/the-only-list-in-the-world/")
[...]
AssertionError: 404 != 302 : Response didn't redirect as expected: Response
code was 404 (expected 302)</pre>
<p>The first failure tells us we’re not saving a new item to the database,
and the second says that, instead of returning a 302 redirect,
our view is returning a 404.
That’s because we haven’t built a URL for <em>/lists/new</em>,
so the <code>client.post</code> is just getting a “not found” response.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Do you remember how we split this out into two tests earlier?
    If we only had one test that checked both the saving and the redirect,
    it would have failed on the <code>0 != 1</code> failure,
    which would have been much harder to debug.
    Ask me how I know this.</p>
</div>
</div></section>
<section data-pdf-bookmark="A URL and View for New List Creation" data-type="sect2"><div class="sect2" id="id143">
<h2>A URL and View for New List Creation</h2>
<p>Let’s build our new URL now:</p>
<div class="sourcecode" data-type="example">
<p>superlists/urls.py (ch07l021)</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">urlpatterns</code> <code class="o">=</code> <code class="p">[</code>
    <code class="n">path</code><code class="p">(</code><code class="s2">""</code><code class="p">,</code> <code class="n">views</code><code class="o">.</code><code class="n">home_page</code><code class="p">,</code> <code class="n">name</code><code class="o">=</code><code class="s2">"home"</code><code class="p">),</code>
    <code class="n">path</code><code class="p">(</code><code class="s2">"lists/new"</code><code class="p">,</code> <code class="n">views</code><code class="o">.</code><code class="n">new_list</code><code class="p">,</code> <code class="n">name</code><code class="o">=</code><code class="s2">"new_list"</code><code class="p">),</code>
    <code class="n">path</code><code class="p">(</code><code class="s2">"lists/the-only-list-in-the-world/"</code><code class="p">,</code> <code class="n">views</code><code class="o">.</code><code class="n">view_list</code><code class="p">,</code> <code class="n">name</code><code class="o">=</code><code class="s2">"view_list"</code><code class="p">),</code>
<code class="p">]</code></pre></div>
<p>Next we get a <code>no attribute 'new_list'</code>, so let’s fix that, in
<em>lists/views.py</em>:</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch07l022)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">new_list</code><code class="p">(</code><code class="n">request</code><code class="p">):</code>
    <code class="k">pass</code></pre></div>
<p>Then we get “The view lists.views.new_list didn’t return an HttpResponse
object”.  (This is getting rather familiar!)  We could return a raw
<code>HttpResponse</code>, but since we know we’ll need a redirect, let’s borrow a line
from <code>home_page</code>:</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch07l023)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">new_list</code><code class="p">(</code><code class="n">request</code><code class="p">):</code>
    <code class="k">return</code> <code class="n">redirect</code><code class="p">(</code><code class="s2">"/lists/the-only-list-in-the-world/"</code><code class="p">)</code></pre></div>
<p>That gives:</p>
<pre data-type="programlisting">    self.assertEqual(Item.objects.count(), 1)
AssertionError: 0 != 1</pre>
<p>Seems reasonably straightforward.
We borrow another line from <code>home_page</code>:</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch07l024)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">new_list</code><code class="p">(</code><code class="n">request</code><code class="p">):</code>
    <code class="n">Item</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">text</code><code class="o">=</code><code class="n">request</code><code class="o">.</code><code class="n">POST</code><code class="p">[</code><code class="s2">"item_text"</code><code class="p">])</code>
    <code class="k">return</code> <code class="n">redirect</code><code class="p">(</code><code class="s2">"/lists/the-only-list-in-the-world/"</code><code class="p">)</code></pre></div>
<p>And everything now passes:</p>
<pre data-type="programlisting">Ran 7 tests in 0.030s

OK</pre>
<p>And we can run the FTs to check that we’re still in the same place:
our regression test passes, and the new FT gets to the same point.</p>
<pre data-type="programlisting">[...]
AssertionError: '1: Buy milk' not found in ['1: Buy peacock feathers', '2: Buy
milk']
Ran 2 tests in 8.972s
FAILED (failures=1)</pre>
</div></section>
<section data-pdf-bookmark="Removing Now-Redundant Code and Tests" data-type="sect2"><div class="sect2" id="id144">
<h2>Removing Now-Redundant Code and Tests</h2>
<p>We’re looking good.
Since our new views are now doing most of the work that <code>home_page</code> used to do,
we should be able to massively simplify it.
Can we remove the whole <code>if request.method == 'POST'</code> section,
for example?</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch07l025)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">home_page</code><code class="p">(</code><code class="n">request</code><code class="p">):</code>
    <code class="k">return</code> <code class="n">render</code><code class="p">(</code><code class="n">request</code><code class="p">,</code> <code class="s2">"home.xhtml"</code><code class="p">)</code></pre></div>
<p>Yep!</p>
<pre data-type="programlisting">OK</pre>
<p>And while we’re at it, we can remove the now-redundant
<code>test_only_saves_​items_when_necessary</code> test too!</p>
<p>Doesn’t that feel good?  The view functions are looking much simpler. We rerun
the tests to make sure…​</p>
<pre class="dofirst-ch07l026" data-type="programlisting">Ran 6 tests in 0.016s
OK</pre>
<p>and the FTs?</p>
</div></section>
<section data-pdf-bookmark="A Regression! Pointing Our Forms at the New URL" data-type="sect2"><div class="sect2" id="id56">
<h2>A Regression! Pointing Our Forms at the New URL</h2>
<p>Oops:</p>
<pre data-type="programlisting">ERROR: test_can_start_a_todo_list
[...]
  File "...goat-book/functional_tests/tests.py", line 52, in
test_can_start_a_todo_list
[...]
    self.wait_for_row_in_list_table("1: Buy peacock feathers")
[...]
    table = self.browser.find_element(By.ID, "id_list_table")
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: [id="id_list_table"]

ERROR: test_multiple_users_can_start_lists_at_different_urls (functional_tests.
tests.NewVisitorTest.test_multiple_users_can_start_lists_at_different_urls)
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: [id="id_list_table"]
[...]

Ran 2 tests in 11.592s
FAILED (errors=2)</pre>
<p>Once again, the FTs pick up a tricky little bug,
something that our unit tests alone would find it hard to catch.</p>
<p>It’s because our forms are still pointing to the old URL.
In <em>both</em> <em>home.xhtml</em> and <em>lists.xhtml</em>, let’s change them to:</p>
<div class="sourcecode" data-type="example">
<p>lists/templates/home.xhtml, lists/templates/list.xhtml</p>
<pre data-code-language="html" data-type="programlisting">    <code class="p">&lt;</code><code class="nt">form</code> <code class="na">method</code><code class="o">=</code><code class="s">"POST"</code> <code class="na">action</code><code class="o">=</code><code class="s">"/lists/new"</code><code class="p">&gt;</code></pre></div>
<p class="pagebreak-before">And that should get us back to working again:</p>
<pre data-type="programlisting">AssertionError: '1: Buy milk' not found in ['1: Buy peacock feathers', '2: Buy
milk']
[...]
FAILED (failures=1)</pre>
<p>That’s another nicely self-contained commit,
in that we’ve made a bunch of changes to our URLs,
our <em>views.py</em> is looking much neater and tidier,
and we’re sure the application is still working as well as it did before.
We’re getting good at this working-state-to-working-state malarkey!</p>
<pre data-type="programlisting">$ <strong>git status</strong> # 5 changed files
$ <strong>git diff</strong> # URLs for forms x2, moved code in views + tests, new URL
$ <strong>git commit -a</strong></pre>
<p><a data-primary="" data-startref="MLTlist07" data-type="indexterm" id="id424"/>
<a data-primary="" data-startref="urlmap07a" data-type="indexterm" id="id425"/>
And we can cross out an item on the to-do list:</p>
<aside class="scratchpad" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id426">
<h1/>
<ul>
<li>
<p><em>Adjust model so that items are associated with different lists</em></p>
</li>
<li>
<p><em>Add unique URLs for each list</em></p>
</li>
<li>
<p><em>
<span class="strikethrough line-through">Add a URL for creating a new list via POST</span></em></p>
</li>
<li>
<p><em>Add URLs for adding a new item to an existing list via POST</em></p>
</li>
</ul>
</div></aside>
</div></section>
</div></section>
<section data-pdf-bookmark="Biting the Bullet: Adjusting Our Models" data-type="sect1"><div class="sect1" id="id145">
<h1>Biting the Bullet: Adjusting Our Models</h1>
<p>Enough housekeeping with our URLs.
It’s time to bite the bullet and change our models.
Let’s adjust the model unit test.
Again, a diff is a good way to see the changes:</p>
<div class="sourcecode" data-type="example">
<p>lists/tests.py (ch07l029)</p>
<pre data-code-language="diff" data-type="programlisting"><code class="gu">@@ -1,5 +1,5 @@</code><code class="w"/>
<code class="w"> </code>from django.test import TestCase<code class="w"/>
<code class="gd">-from lists.models import Item</code><code class="w"/>
<code class="gi">+from lists.models import Item, List</code><code class="w"/>


<code class="w"> </code>class HomePageTest(TestCase):<code class="w"/>
<code class="gu">@@ -35,20 +35,30 @@ class ListViewTest(TestCase):</code><code class="w"/>
<code class="w"> </code>        self.assertContains(response, "itemey 2")<code class="w"/>


<code class="gd">-class ItemModelTest(TestCase):</code><code class="w"/>
<code class="gi">+class ListAndItemModelsTest(TestCase):</code><code class="w"/>
<code class="w"> </code>    def test_saving_and_retrieving_items(self):<code class="w"/>
<code class="gi">+        mylist = List()</code><code class="w"/>
<code class="gi">+        mylist.save()</code><code class="w"/>
<code class="gi">+</code><code class="w"/>
<code class="w"> </code>        first_item = Item()<code class="w"/>
<code class="w"> </code>        first_item.text = "The first (ever) list item"<code class="w"/>
<code class="gi">+        first_item.list = mylist</code><code class="w"/>
<code class="w"> </code>        first_item.save()<code class="w"/>

<code class="w"> </code>        second_item = Item()<code class="w"/>
<code class="w"> </code>        second_item.text = "Item the second"<code class="w"/>
<code class="gi">+        second_item.list = mylist</code><code class="w"/>
<code class="w"> </code>        second_item.save()<code class="w"/>

<code class="gi">+        saved_list = List.objects.get()</code><code class="w"/>
<code class="gi">+        self.assertEqual(saved_list, mylist)</code><code class="w"/>
<code class="gi">+</code><code class="w"/>
<code class="w"> </code>        saved_items = Item.objects.all()<code class="w"/>
<code class="w"> </code>        self.assertEqual(saved_items.count(), 2)<code class="w"/>

<code class="w"> </code>        first_saved_item = saved_items[0]<code class="w"/>
<code class="w"> </code>        second_saved_item = saved_items[1]<code class="w"/>
<code class="w"> </code>        self.assertEqual(first_saved_item.text, "The first (ever) list item")<code class="w"/>
<code class="gi">+        self.assertEqual(first_saved_item.list, mylist)</code><code class="w"/>
<code class="w"> </code>        self.assertEqual(second_saved_item.text, "Item the second")<code class="w"/>
<code class="gi">+        self.assertEqual(second_saved_item.list, mylist)</code><code class="w"/></pre></div>
<p>We create a new <code>List</code> object
and then we assign each item to it by assigning it as its <code>.list</code> property.
We check that the list is properly saved,
and we check that the two items have also saved their relationship to the list.
You’ll also notice that we can compare list objects with each other directly
(<code>saved_list</code> and <code>mylist</code>)—behind the scenes,
these will compare themselves by checking
that their primary key (the <code>.id</code> attribute) is the same.</p>
<p>Time for another unit-test/code cycle.</p>
<p>For the first couple of iterations,
rather than explicitly showing you what code to enter in between every test run,
I’m only going to show you the expected error messages from running the tests.
I’ll let you figure out what each minimal code change should be, on your own.</p>
<div data-type="tip"><h6>Tip</h6>
<p>Need a hint?
    Go back and take a look at the steps we took
    to introduce the <code>Item</code> model in <a href="ch05.xhtml#first-django-model">the chapter before last</a>.</p>
</div>
<p>Your first error should be:</p>
<pre data-type="programlisting">ImportError: cannot import name 'List' from 'lists.models'</pre>
<p>Fix that, and then you should see:</p>
<pre class="dofirst-ch07l030" data-type="programlisting">AttributeError: 'List' object has no attribute 'save'</pre>
<p>Next you should see:</p>
<pre class="dofirst-ch07l031" data-type="programlisting">django.db.utils.OperationalError: no such table: lists_list</pre>
<p>So we run a <code>makemigrations</code>:</p>
<pre data-type="programlisting">$ <strong>python manage.py makemigrations</strong>
Migrations for 'lists':
  lists/migrations/0003_list.py
    - Create model List</pre>
<p>And then you should see:</p>
<pre data-type="programlisting">    self.assertEqual(first_saved_item.list, mylist)
AttributeError: 'Item' object has no attribute 'list'</pre>
<section data-pdf-bookmark="A Foreign Key Relationship" data-type="sect2"><div class="sect2" id="id146">
<h2>A Foreign Key Relationship</h2>
<p>How do we give our <code>Item</code> a list attribute?
Let’s just try naively making it like the <code>text</code> attribute
(and here’s your chance
to see whether your solution so far looks like mine by the way):</p>
<div class="sourcecode" data-type="example">
<p>lists/models.py (ch07l033)</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">django.db</code> <code class="kn">import</code> <code class="n">models</code>


<code class="k">class</code> <code class="nc">List</code><code class="p">(</code><code class="n">models</code><code class="o">.</code><code class="n">Model</code><code class="p">):</code>
    <code class="k">pass</code>


<code class="k">class</code> <code class="nc">Item</code><code class="p">(</code><code class="n">models</code><code class="o">.</code><code class="n">Model</code><code class="p">):</code>
    <code class="n">text</code> <code class="o">=</code> <code class="n">models</code><code class="o">.</code><code class="n">TextField</code><code class="p">(</code><code class="n">default</code><code class="o">=</code><code class="s2">""</code><code class="p">)</code>
    <code class="nb">list</code> <code class="o">=</code> <code class="n">models</code><code class="o">.</code><code class="n">TextField</code><code class="p">(</code><code class="n">default</code><code class="o">=</code><code class="s2">""</code><code class="p">)</code></pre></div>
<p>As usual, the tests tell us we need a migration:</p>
<pre data-type="programlisting">$ <strong>python manage.py test lists</strong>
[...]
django.db.utils.OperationalError: no such column: lists_item.list

$ <strong>python manage.py makemigrations</strong>
Migrations for 'lists':
  lists/migrations/0004_item_list.py
    - Add field list to item</pre>
<p>Let’s see what that gives us:</p>
<pre data-type="programlisting">AssertionError: 'List object (1)' != &lt;List: List object (1)&gt;</pre>
<p>We’re not quite there. Look closely at each side of the <code>!=</code>.
Do you see the quotes <code>'</code>?
Django has only saved the string representation of the <code>List</code> object.
To save the relationship to the object itself,
we tell Django about the relationship between the two classes using a <code>ForeignKey</code>:</p>
<div class="sourcecode" data-type="example">
<p>lists/models.py (ch07l035)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">class</code> <code class="nc">Item</code><code class="p">(</code><code class="n">models</code><code class="o">.</code><code class="n">Model</code><code class="p">):</code>
    <code class="n">text</code> <code class="o">=</code> <code class="n">models</code><code class="o">.</code><code class="n">TextField</code><code class="p">(</code><code class="n">default</code><code class="o">=</code><code class="s2">""</code><code class="p">)</code>
    <code class="nb">list</code> <code class="o">=</code> <code class="n">models</code><code class="o">.</code><code class="n">ForeignKey</code><code class="p">(</code><code class="n">List</code><code class="p">,</code> <code class="n">default</code><code class="o">=</code><code class="kc">None</code><code class="p">,</code> <code class="n">on_delete</code><code class="o">=</code><code class="n">models</code><code class="o">.</code><code class="n">CASCADE</code><code class="p">)</code></pre></div>
<p>That’ll need a migration too.  Since the last one was a red herring, let’s
delete it and replace it with a new one:</p>
<pre data-type="programlisting">$ <strong>rm lists/migrations/0004_item_list.py</strong>
$ <strong>python manage.py makemigrations</strong>
Migrations for 'lists':
  lists/migrations/0004_item_list.py
    - Add field list to item</pre>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>Deleting migrations is dangerous.
    Now and again it’s nice to do it to keep things tidy,
    because we don’t always get our models code right on the first go!
    But if you delete a migration that’s already been applied to a database somewhere,
    Django will be confused about what state it’s in,
    and won’t be able to apply future migrations.
    You should only do it when you’re sure the migration hasn’t been used.
    A good rule of thumb is that you should never delete or modify
    a migration that’s already been committed to your VCS.</p>
</div>
</div></section>
<section data-pdf-bookmark="Adjusting the Rest of the World to Our New Models" data-type="sect2"><div class="sect2" id="id57">
<h2>Adjusting the Rest of the World to Our New Models</h2>
<p>Back in our tests, now what happens?</p>
<pre data-type="programlisting">$ <strong>python manage.py test lists</strong>
[...]
ERROR: test_displays_all_list_items
django.db.utils.IntegrityError: NOT NULL constraint failed: lists_item.list_id
[...]
ERROR: test_redirects_after_POST
django.db.utils.IntegrityError: NOT NULL constraint failed: lists_item.list_id
[...]
ERROR: test_can_save_a_POST_request
django.db.utils.IntegrityError: NOT NULL constraint failed: lists_item.list_id

Ran 6 tests in 0.021s

FAILED (errors=3)</pre>
<p>Oh dear!</p>
<p>There is some good news.
Although it’s hard to see, our model tests are passing.
But three of our view tests are failing nastily.</p>
<p>The cause is the new relationship we’ve introduced between <code>Item</code>s and <code>List</code>s,
which requires each item to have a parent list,
and which our old tests and code aren’t prepared for.</p>
<p>Still, this is exactly why we have tests!
Let’s get them working again.
The easiest is the <code>ListViewTest</code>;
we just create a parent list for our two test items:</p>
<div class="sourcecode" data-type="example">
<p>lists/tests.py (ch07l038)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">class</code> <code class="nc">ListViewTest</code><code class="p">(</code><code class="n">TestCase</code><code class="p">):</code>
    <code class="p">[</code><code class="o">...</code><code class="p">]</code>
    <code class="k">def</code> <code class="nf">test_displays_all_list_items</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="n">mylist</code> <code class="o">=</code> <code class="n">List</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">create</code><code class="p">()</code>
        <code class="n">Item</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">text</code><code class="o">=</code><code class="s2">"itemey 1"</code><code class="p">,</code> <code class="nb">list</code><code class="o">=</code><code class="n">mylist</code><code class="p">)</code>
        <code class="n">Item</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">text</code><code class="o">=</code><code class="s2">"itemey 2"</code><code class="p">,</code> <code class="nb">list</code><code class="o">=</code><code class="n">mylist</code><code class="p">)</code></pre></div>
<p>That gets us down to two failing tests,
both on tests that try to POST to our <code>new_list</code> view.
Decoding the tracebacks using our usual technique,
working back from error to line of test code to,
buried in there somewhere,
the line of our own code that caused the failure:</p>
<pre data-type="programlisting">  File "...goat-book/lists/tests.py", line 19, in test_redirects_after_POST
    response = self.client.post("/lists/new", data={"item_text": "A new list
item"})
[...]
  File "...goat-book/lists/views.py", line 10, in new_list
    Item.objects.create(text=request.POST["item_text"])</pre>
<p>It’s when we try to create an item without a parent list.
So we make a similar change in the view:</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch07l039)</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">lists.models</code> <code class="kn">import</code> <code class="n">Item</code><code class="p">,</code> <code class="n">List</code>
<code class="p">[</code><code class="o">...</code><code class="p">]</code>

<code class="k">def</code> <code class="nf">new_list</code><code class="p">(</code><code class="n">request</code><code class="p">):</code>
    <code class="n">nulist</code> <code class="o">=</code> <code class="n">List</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">create</code><code class="p">()</code>
    <code class="n">Item</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">text</code><code class="o">=</code><code class="n">request</code><code class="o">.</code><code class="n">POST</code><code class="p">[</code><code class="s2">"item_text"</code><code class="p">],</code> <code class="nb">list</code><code class="o">=</code><code class="n">nulist</code><code class="p">)</code>
    <code class="k">return</code> <code class="n">redirect</code><code class="p">(</code><code class="s2">"/lists/the-only-list-in-the-world/"</code><code class="p">)</code></pre></div>
<p>And that<sup><a data-type="noteref" href="ch07.xhtml#id427" id="id427-marker">1</a></sup>
gets our tests passing again:</p>
<pre data-type="programlisting">Ran 6 tests in 0.030s

OK</pre>
<p><a data-primary="Test-Driven Development (TDD)" data-secondary="philosophy of" data-tertiary="working state to working state" data-type="indexterm" id="id428"/>
<a data-primary="working state to working state" data-type="indexterm" id="id429"/>
<a data-primary="Testing Goat" data-secondary="working state to working state" data-type="indexterm" id="id430"/>
Are you cringing internally at this point?
<em>Arg! This feels so wrong;
we create a new list for every single new item submission,
and we’re still just displaying all items as if they belong to the same list!</em>
I know, I feel the same.
The step-by-step approach,
in which you go from working code to working code, is counterintuitive.
I always feel like just diving in
and trying to fix everything all in one go,
instead of going from one weird half-finished state to another.
But remember the Testing Goat!
When you’re up a mountain,
you want to think very carefully about where you put each foot,
and take one step at a time, checking at each stage
that the place you’ve put it hasn’t caused you to fall off a cliff.</p>
<p>So just to reassure ourselves that things have worked, we rerun the FT:</p>
<pre data-type="programlisting">AssertionError: '1: Buy milk' not found in ['1: Buy peacock feathers', '2: Buy
milk']
[...]</pre>
<p>Sure enough, it gets all the way through to where we were before.
We haven’t broken anything, and we’ve made a big change to the database.
That’s something to be pleased with!
Let’s commit:</p>
<pre data-type="programlisting">$ <strong>git status</strong> # 3 changed files, plus 2 migrations
$ <strong>git add lists</strong>
$ <strong>git diff --staged</strong>
$ <strong>git commit</strong></pre>
<p>And we can cross out another item on the to-do list:</p>
<aside class="scratchpad" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id431">
<h1/>
<ul>
<li>
<p><em>
<span class="strikethrough line-through">Adjust model so that items are associated with different lists</span></em></p>
</li>
<li>
<p><em>Add unique URLs for each list</em></p>
</li>
<li>
<p><em>
<span class="strikethrough line-through">Add a URL for creating a new list via POST</span></em></p>
</li>
<li>
<p><em>Add URLs for adding a new item to an existing list via POST</em></p>
</li>
</ul>
</div></aside>
</div></section>
</div></section>
<section data-pdf-bookmark="Each List Should Have Its Own URL" data-type="sect1"><div class="sect1" id="id58">
<h1>Each List Should Have Its Own URL</h1>
<p>We can get rid of the silly <code>the-only-list-in-the-world</code> url,
but what shall we use as the unique identifier for our lists?
Probably the simplest thing, for now,
is just to use the auto-generated <code>id</code> field from the database.
Let’s change <code>ListViewTest</code> so that the two tests point at new URLs.</p>
<p>We’ll also change the old <code>test_displays_all_items</code> test
and call it <code>test_displays_only_items_for_that_list</code> instead,
making it check that only the items for a specific list are displayed:</p>
<div class="sourcecode" data-type="example">
<p>lists/tests.py (ch07l040)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">class</code> <code class="nc">ListViewTest</code><code class="p">(</code><code class="n">TestCase</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf">test_uses_list_template</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="n">mylist</code> <code class="o">=</code> <code class="n">List</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">create</code><code class="p">()</code>
        <code class="n">response</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">client</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="sa">f</code><code class="s2">"/lists/</code><code class="si">{</code><code class="n">mylist</code><code class="o">.</code><code class="n">id</code><code class="si">}</code><code class="s2">/"</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertTemplateUsed</code><code class="p">(</code><code class="n">response</code><code class="p">,</code> <code class="s2">"list.xhtml"</code><code class="p">)</code>

    <code class="k">def</code> <code class="nf">test_displays_only_items_for_that_list</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="n">correct_list</code> <code class="o">=</code> <code class="n">List</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">create</code><code class="p">()</code>
        <code class="n">Item</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">text</code><code class="o">=</code><code class="s2">"itemey 1"</code><code class="p">,</code> <code class="nb">list</code><code class="o">=</code><code class="n">correct_list</code><code class="p">)</code>
        <code class="n">Item</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">text</code><code class="o">=</code><code class="s2">"itemey 2"</code><code class="p">,</code> <code class="nb">list</code><code class="o">=</code><code class="n">correct_list</code><code class="p">)</code>
        <code class="n">other_list</code> <code class="o">=</code> <code class="n">List</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">create</code><code class="p">()</code>
        <code class="n">Item</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">text</code><code class="o">=</code><code class="s2">"other list item"</code><code class="p">,</code> <code class="nb">list</code><code class="o">=</code><code class="n">other_list</code><code class="p">)</code>

        <code class="n">response</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">client</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="sa">f</code><code class="s2">"/lists/</code><code class="si">{</code><code class="n">correct_list</code><code class="o">.</code><code class="n">id</code><code class="si">}</code><code class="s2">/"</code><code class="p">)</code>

        <code class="bp">self</code><code class="o">.</code><code class="n">assertContains</code><code class="p">(</code><code class="n">response</code><code class="p">,</code> <code class="s2">"itemey 1"</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertContains</code><code class="p">(</code><code class="n">response</code><code class="p">,</code> <code class="s2">"itemey 2"</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertNotContains</code><code class="p">(</code><code class="n">response</code><code class="p">,</code> <code class="s2">"other list item"</code><code class="p">)</code></pre></div>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Are you wondering about the line spacing in the test?
    I’m grouping together two lines at the beginning which set up the test,
    one line in the middle which actually calls the code under test,
    and the assertions at the end.
    This isn’t obligatory, but it does help see the structure of the test.
    Some people refer to this structure as <em>Arrange-Act-Assert</em>,
    or <em>Given-When-Then</em>: <em>Given</em> the database contains our list with two items,
    and another list, <em>When</em> I do a GET request for our list,
    <em>Then</em> I see the items in our list, but not the items in the other list.
    <a data-primary="Arrange, Act, Assert" data-type="indexterm" id="id432"/>
<a data-primary="Given / When / Then" data-type="indexterm" id="id433"/></p>
</div>
<p>Running the unit tests gives an expected 404, and another related error:</p>
<pre data-type="programlisting">FAIL: test_displays_only_items_for_that_list
AssertionError: 404 != 200 : Couldn't retrieve content: Response code was 404
(expected 200)
[...]
FAIL: test_uses_list_template
AssertionError: No templates used to render the response</pre>
<section data-pdf-bookmark="Capturing Parameters from URLs" data-type="sect2"><div class="sect2" id="id147">
<h2>Capturing Parameters from URLs</h2>
<p>It’s time to learn how we can pass parameters from URLs to views:</p>
<div class="sourcecode" data-type="example">
<p>superlists/urls.py (ch07l041-0)</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">urlpatterns</code> <code class="o">=</code> <code class="p">[</code>
    <code class="n">path</code><code class="p">(</code><code class="s2">""</code><code class="p">,</code> <code class="n">views</code><code class="o">.</code><code class="n">home_page</code><code class="p">,</code> <code class="n">name</code><code class="o">=</code><code class="s2">"home"</code><code class="p">),</code>
    <code class="n">path</code><code class="p">(</code><code class="s2">"lists/new"</code><code class="p">,</code> <code class="n">views</code><code class="o">.</code><code class="n">new_list</code><code class="p">,</code> <code class="n">name</code><code class="o">=</code><code class="s2">"new_list"</code><code class="p">),</code>
    <code class="n">path</code><code class="p">(</code><code class="s2">"lists/&lt;int:list_id&gt;/"</code><code class="p">,</code> <code class="n">views</code><code class="o">.</code><code class="n">view_list</code><code class="p">,</code> <code class="n">name</code><code class="o">=</code><code class="s2">"view_list"</code><code class="p">),</code>
<code class="p">]</code></pre></div>
<p>We adjust the regular expression for our URL to include a <em>capture group</em>,
<code>&lt;int:list_id&gt;</code>, which will match any numerical characters, up to the following <code>/</code>,
The captured id will get passed to the view as an argument.</p>
<p>In other words, if we go to the URL <em>/lists/1/</em>, <code>view_list</code> will get a second
argument after the normal <code>request</code> argument, namely the integer <code>1</code>.</p>
<p>But our view doesn’t expect an argument yet!
Sure enough, this causes problems:</p>
<pre data-type="programlisting">ERROR: test_displays_only_items_for_that_list
[...]
TypeError: view_list() got an unexpected keyword argument 'list_id'
[...]
ERROR: test_uses_list_template
[...]
TypeError: view_list() got an unexpected keyword argument 'list_id'
[...]
FAIL: test_redirects_after_POST
[...]
AssertionError: 404 != 200 : Couldn't retrieve redirection page
'/lists/the-only-list-in-the-world/': response code was 404 (expected 200)
[...]
FAILED (failures=1, errors=2)</pre>
<p>We can fix that easily with a dummy parameter in <em>views.py</em>:</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch07l041)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">view_list</code><code class="p">(</code><code class="n">request</code><code class="p">,</code> <code class="n">list_id</code><code class="p">):</code>
    <code class="p">[</code><code class="o">...</code><code class="p">]</code></pre></div>
<p>That takes us down to our expected failure,
plus an <em>only-list-in-the-world</em> that’s still hanging around somewhere,
which I’m sure we can fix later.</p>
<pre data-type="programlisting">FAIL: test_displays_only_items_for_that_list
[...]
AssertionError: 1 != 0 : Response should not contain 'other list item'
[...]
FAIL: test_redirects_after_POST
AssertionError: 404 != 200 : Couldn't retrieve redirection page
'/lists/the-only-list-in-the-world/': response code was 404 (expected 200)</pre>
<p>Let’s make our list view discriminate
over which items it sends to the template:</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch07l042)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">view_list</code><code class="p">(</code><code class="n">request</code><code class="p">,</code> <code class="n">list_id</code><code class="p">):</code>
    <code class="n">our_list</code> <code class="o">=</code> <code class="n">List</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="nb">id</code><code class="o">=</code><code class="n">list_id</code><code class="p">)</code>
    <code class="n">items</code> <code class="o">=</code> <code class="n">Item</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">filter</code><code class="p">(</code><code class="nb">list</code><code class="o">=</code><code class="n">our_list</code><code class="p">)</code>
    <code class="k">return</code> <code class="n">render</code><code class="p">(</code><code class="n">request</code><code class="p">,</code> <code class="s2">"list.xhtml"</code><code class="p">,</code> <code class="p">{</code><code class="s2">"items"</code><code class="p">:</code> <code class="n">items</code><code class="p">})</code></pre></div>
</div></section>
<section data-pdf-bookmark="Adjusting new_list to the New World" data-type="sect2"><div class="sect2" id="id148">
<h2>Adjusting new_list to the New World</h2>
<p>Now let’s address the <em>only-list-in-the-world</em> failure:</p>
<pre data-type="programlisting">FAIL: test_redirects_after_POST
[...]
AssertionError: 404 != 200 : Couldn't retrieve redirection page
'/lists/the-only-list-in-the-world/': response code was 404 (expected 200)</pre>
<p>Let’s have a little look and find the test that’s moaning:</p>
<div class="sourcecode currentcontents small-code" data-type="example">
<p>lists/tests.py</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">class</code> <code class="nc">NewListTest</code><code class="p">(</code><code class="n">TestCase</code><code class="p">):</code>
    <code class="p">[</code><code class="o">...</code><code class="p">]</code>

    <code class="k">def</code> <code class="nf">test_redirects_after_POST</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="n">response</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">client</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"/lists/new"</code><code class="p">,</code> <code class="n">data</code><code class="o">=</code><code class="p">{</code><code class="s2">"item_text"</code><code class="p">:</code> <code class="s2">"A new list item"</code><code class="p">})</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertRedirects</code><code class="p">(</code><code class="n">response</code><code class="p">,</code> <code class="s2">"/lists/the-only-list-in-the-world/"</code><code class="p">)</code></pre></div>
<p>It looks like it hasn’t been adjusted to the new world of <code>List</code>s and <code>Item</code>s.
The test should be saying that this view redirects
to the URL of the specific new list it just created.</p>
<div class="sourcecode small-code" data-type="example">
<p>lists/tests.py (ch07l043)</p>
<pre data-code-language="python" data-type="programlisting">    <code class="k">def</code> <code class="nf">test_redirects_after_POST</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="n">response</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">client</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"/lists/new"</code><code class="p">,</code> <code class="n">data</code><code class="o">=</code><code class="p">{</code><code class="s2">"item_text"</code><code class="p">:</code> <code class="s2">"A new list item"</code><code class="p">})</code>
        <code class="n">new_list</code> <code class="o">=</code> <code class="n">List</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">get</code><code class="p">()</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertRedirects</code><code class="p">(</code><code class="n">response</code><code class="p">,</code> <code class="sa">f</code><code class="s2">"/lists/</code><code class="si">{</code><code class="n">new_list</code><code class="o">.</code><code class="n">id</code><code class="si">}</code><code class="s2">/"</code><code class="p">)</code></pre></div>
<p>The test still fails, but we can now take a look at the view itself,
and change it so it redirects to the right place:</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch07l044)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">new_list</code><code class="p">(</code><code class="n">request</code><code class="p">):</code>
    <code class="n">nulist</code> <code class="o">=</code> <code class="n">List</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">create</code><code class="p">()</code>
    <code class="n">Item</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">text</code><code class="o">=</code><code class="n">request</code><code class="o">.</code><code class="n">POST</code><code class="p">[</code><code class="s2">"item_text"</code><code class="p">],</code> <code class="nb">list</code><code class="o">=</code><code class="n">nulist</code><code class="p">)</code>
    <code class="k">return</code> <code class="n">redirect</code><code class="p">(</code><code class="sa">f</code><code class="s2">"/lists/</code><code class="si">{</code><code class="n">nulist</code><code class="o">.</code><code class="n">id</code><code class="si">}</code><code class="s2">/"</code><code class="p">)</code></pre></div>
<p>That gets us back to passing unit tests:</p>
<pre data-type="programlisting">$ <strong>python3 manage.py test lists</strong>
[...]
......
 ---------------------------------------------------------------------
Ran 6 tests in 0.033s

OK</pre>
<p>What about the functional tests?  We must be almost there?</p>
</div></section>
</div></section>
<section class="pagebreak-before" data-pdf-bookmark="The Functional Tests Detect Another Regression" data-type="sect1"><div class="sect1" id="id149">
<h1>The Functional Tests Detect Another Regression</h1>
<p>Well, almost:</p>
<pre data-type="programlisting">F.
======================================================================
FAIL: test_can_start_a_todo_list
(functional_tests.tests.NewVisitorTest.test_can_start_a_todo_list)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...goat-book/functional_tests/tests.py", line 63, in
test_can_start_a_todo_list
    self.wait_for_row_in_list_table("2: Use peacock feathers to make a fly")
[...]
AssertionError: '2: Use peacock feathers to make a fly' not found in ['1: Use
peacock feathers to make a fly']

 ---------------------------------------------------------------------
Ran 2 tests in 8.617s

FAILED (failures=1)</pre>
<p>Our <em>new</em> FT is actually passing: different users can get different lists.
But the old test is warning us of a regression.
It looks like you can’t add a second item to a list any more.
It’s because of our quick-and-dirty hack
where we create a new list for every single POST submission.
This is exactly what we have functional tests for!</p>
<p>And it correlates nicely with the last item on our to-do list:</p>
<aside class="scratchpad" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id434">
<h1/>
<ul>
<li>
<p><em>
<span class="strikethrough line-through">Adjust model so that items are associated with different lists</span></em></p>
</li>
<li>
<p><em>
<span class="strikethrough line-through">Add unique URLs for each list</span></em></p>
</li>
<li>
<p><em>
<span class="strikethrough line-through">Add a URL for creating a new list via POST</span></em></p>
</li>
<li>
<p><em>Add URLs for adding a new item to an existing list via POST</em></p>
</li>
</ul>
</div></aside>
</div></section>
<section data-pdf-bookmark="One More View to Handle Adding Items to an Existing List" data-type="sect1"><div class="sect1" id="id150">
<h1>One More View to Handle Adding Items to an Existing List</h1>
<p>We need a URL and view to handle adding a new item to an existing list
(<em>/lists/&lt;list_id&gt;/add_item</em>).
We’re getting pretty good at these now,
so let’s knock one together quickly:</p>
<div class="sourcecode" data-type="example">
<p>lists/tests.py (ch07l045)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">class</code> <code class="nc">NewItemTest</code><code class="p">(</code><code class="n">TestCase</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf">test_can_save_a_POST_request_to_an_existing_list</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="n">other_list</code> <code class="o">=</code> <code class="n">List</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">create</code><code class="p">()</code>
        <code class="n">correct_list</code> <code class="o">=</code> <code class="n">List</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">create</code><code class="p">()</code>

        <code class="bp">self</code><code class="o">.</code><code class="n">client</code><code class="o">.</code><code class="n">post</code><code class="p">(</code>
            <code class="sa">f</code><code class="s2">"/lists/</code><code class="si">{</code><code class="n">correct_list</code><code class="o">.</code><code class="n">id</code><code class="si">}</code><code class="s2">/add_item"</code><code class="p">,</code>
            <code class="n">data</code><code class="o">=</code><code class="p">{</code><code class="s2">"item_text"</code><code class="p">:</code> <code class="s2">"A new item for an existing list"</code><code class="p">},</code>
        <code class="p">)</code>

        <code class="bp">self</code><code class="o">.</code><code class="n">assertEqual</code><code class="p">(</code><code class="n">Item</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">count</code><code class="p">(),</code> <code class="mi">1</code><code class="p">)</code>
        <code class="n">new_item</code> <code class="o">=</code> <code class="n">Item</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">get</code><code class="p">()</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertEqual</code><code class="p">(</code><code class="n">new_item</code><code class="o">.</code><code class="n">text</code><code class="p">,</code> <code class="s2">"A new item for an existing list"</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertEqual</code><code class="p">(</code><code class="n">new_item</code><code class="o">.</code><code class="n">list</code><code class="p">,</code> <code class="n">correct_list</code><code class="p">)</code>

    <code class="k">def</code> <code class="nf">test_redirects_to_list_view</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="n">other_list</code> <code class="o">=</code> <code class="n">List</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">create</code><code class="p">()</code>
        <code class="n">correct_list</code> <code class="o">=</code> <code class="n">List</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">create</code><code class="p">()</code>

        <code class="n">response</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">client</code><code class="o">.</code><code class="n">post</code><code class="p">(</code>
            <code class="sa">f</code><code class="s2">"/lists/</code><code class="si">{</code><code class="n">correct_list</code><code class="o">.</code><code class="n">id</code><code class="si">}</code><code class="s2">/add_item"</code><code class="p">,</code>
            <code class="n">data</code><code class="o">=</code><code class="p">{</code><code class="s2">"item_text"</code><code class="p">:</code> <code class="s2">"A new item for an existing list"</code><code class="p">},</code>
        <code class="p">)</code>

        <code class="bp">self</code><code class="o">.</code><code class="n">assertRedirects</code><code class="p">(</code><code class="n">response</code><code class="p">,</code> <code class="sa">f</code><code class="s2">"/lists/</code><code class="si">{</code><code class="n">correct_list</code><code class="o">.</code><code class="n">id</code><code class="si">}</code><code class="s2">/"</code><code class="p">)</code></pre></div>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Are you wondering about <code>other_list</code>?
    A bit like in the tests for viewing a specific list,
    it’s important that we add items to a specific list.
    Adding this second object to the database prevents me from using a hack
    like <code>List.objects.first()</code> in the implementation.
    Yes, that would be a stupid thing to do,
    and you can go too far down the road of testing
    for all the stupid things you must not do
    (there are an infinite number of those, after all).
    It’s a judgement call, but this one feels worth it.
    There’s some more discussion of this in [Link to Come].</p>
</div>
<p>So that fails as expected, the list item is not saved,
and the new URL currently returns a 404:</p>
<pre data-type="programlisting">AssertionError: 0 != 1
[...]
AssertionError: 404 != 302 : Response didn't redirect as expected: Response
code was 404 (expected 302)</pre>
<section data-pdf-bookmark="The Last New URL" data-type="sect2"><div class="sect2" id="id151">
<h2>The Last New URL</h2>
<p>Now we’ve got our expected 404,
let’s add a new URL for adding new items to existing lists:</p>
<div class="sourcecode" data-type="example">
<p>superlists/urls.py (ch07l046)</p>
<pre data-code-language="python" data-type="programlisting"><code class="n">urlpatterns</code> <code class="o">=</code> <code class="p">[</code>
    <code class="n">path</code><code class="p">(</code><code class="s2">""</code><code class="p">,</code> <code class="n">views</code><code class="o">.</code><code class="n">home_page</code><code class="p">,</code> <code class="n">name</code><code class="o">=</code><code class="s2">"home"</code><code class="p">),</code>
    <code class="n">path</code><code class="p">(</code><code class="s2">"lists/new"</code><code class="p">,</code> <code class="n">views</code><code class="o">.</code><code class="n">new_list</code><code class="p">,</code> <code class="n">name</code><code class="o">=</code><code class="s2">"new_list"</code><code class="p">),</code>
    <code class="n">path</code><code class="p">(</code><code class="s2">"lists/&lt;int:list_id&gt;/"</code><code class="p">,</code> <code class="n">views</code><code class="o">.</code><code class="n">view_list</code><code class="p">,</code> <code class="n">name</code><code class="o">=</code><code class="s2">"view_list"</code><code class="p">),</code>
    <code class="n">path</code><code class="p">(</code><code class="s2">"lists/&lt;int:list_id&gt;/add_item"</code><code class="p">,</code> <code class="n">views</code><code class="o">.</code><code class="n">add_item</code><code class="p">,</code> <code class="n">name</code><code class="o">=</code><code class="s2">"add_item"</code><code class="p">),</code>
<code class="p">]</code></pre></div>
<p>Three very similar-looking URLs there.
Let’s make a note on our to-do list;
they look like good candidates for a refactoring:</p>
<aside class="scratchpad" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id435">
<h1/>
<ul>
<li>
<p><em>
<span class="strikethrough line-through">Adjust model so that items are associated with different lists</span></em></p>
</li>
<li>
<p><em>
<span class="strikethrough line-through">Add unique URLs for each list</span></em></p>
</li>
<li>
<p><em>
<span class="strikethrough line-through">Add a URL for creating a new list via POST</span></em></p>
</li>
<li>
<p><em>Add URLs for adding a new item to an existing list via POST</em></p>
</li>
<li>
<p><em>Refactor away some duplication in urls.py</em></p>
</li>
</ul>
</div></aside>
<p>Back to the tests, we get the usual missing module view objects:</p>
<pre data-type="programlisting">AttributeError: module 'lists.views' has no attribute 'add_item'</pre>
</div></section>
<section data-pdf-bookmark="The Last New View" data-type="sect2"><div class="sect2" id="id152">
<h2>The Last New View</h2>
<p>Let’s try:</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch07l047)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">add_item</code><code class="p">(</code><code class="n">request</code><code class="p">):</code>
    <code class="k">pass</code></pre></div>
<p>Aha:</p>
<pre data-type="programlisting">TypeError: add_item() got an unexpected keyword argument 'list_id'</pre>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch07l048)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">add_item</code><code class="p">(</code><code class="n">request</code><code class="p">,</code> <code class="n">list_id</code><code class="p">):</code>
    <code class="k">pass</code></pre></div>
<p>And then:</p>
<pre data-type="programlisting">ValueError: The view lists.views.add_item didn't return an HttpResponse object.
It returned None instead.</pre>
<p class="pagebreak-before">We can copy the <code>redirect()</code> from <code>new_list</code>
and the <code>List.objects.get()</code> from <code>view_list</code>:</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch07l049)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">add_item</code><code class="p">(</code><code class="n">request</code><code class="p">,</code> <code class="n">list_id</code><code class="p">):</code>
    <code class="n">our_list</code> <code class="o">=</code> <code class="n">List</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="nb">id</code><code class="o">=</code><code class="n">list_id</code><code class="p">)</code>
    <code class="k">return</code> <code class="n">redirect</code><code class="p">(</code><code class="sa">f</code><code class="s2">"/lists/</code><code class="si">{</code><code class="n">our_list</code><code class="o">.</code><code class="n">id</code><code class="si">}</code><code class="s2">/"</code><code class="p">)</code></pre></div>
<p>That takes us to:</p>
<pre data-type="programlisting">    self.assertEqual(Item.objects.count(), 1)
AssertionError: 0 != 1</pre>
<p>Finally we make it save our new list item:</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch07l050)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">add_item</code><code class="p">(</code><code class="n">request</code><code class="p">,</code> <code class="n">list_id</code><code class="p">):</code>
    <code class="n">our_list</code> <code class="o">=</code> <code class="n">List</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="nb">id</code><code class="o">=</code><code class="n">list_id</code><code class="p">)</code>
    <code class="n">Item</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="n">text</code><code class="o">=</code><code class="n">request</code><code class="o">.</code><code class="n">POST</code><code class="p">[</code><code class="s2">"item_text"</code><code class="p">],</code> <code class="nb">list</code><code class="o">=</code><code class="n">our_list</code><code class="p">)</code>
    <code class="k">return</code> <code class="n">redirect</code><code class="p">(</code><code class="sa">f</code><code class="s2">"/lists/</code><code class="si">{</code><code class="n">our_list</code><code class="o">.</code><code class="n">id</code><code class="si">}</code><code class="s2">/"</code><code class="p">)</code></pre></div>
<p>And we’re back to passing tests.</p>
<pre data-type="programlisting">Ran 8 tests in 0.050s

OK</pre>
</div></section>
<section data-pdf-bookmark="Testing Template Context Directly" data-type="sect2"><div class="sect2" id="id59">
<h2>Testing Template Context Directly</h2>
<p><a data-primary="template context" data-type="indexterm" id="id436"/>
We’ve got our new view and URL for adding items to existing lists;
now we just need to actually use it in our <em>list.xhtml</em> template.
So we open it up to adjust the form tag…​</p>
<div class="sourcecode skipme" data-type="example">
<p>lists/templates/list.xhtml</p>
<pre data-code-language="html" data-type="programlisting">    <code class="p">&lt;</code><code class="nt">form</code> <code class="na">method</code><code class="o">=</code><code class="s">"POST"</code> <code class="na">action</code><code class="o">=</code><code class="s">"but what should we put here?"</code><code class="p">&gt;</code></pre></div>
<p>…​oh.
To get the URL for adding to the current list,
the template needs to know what list it’s rendering,
as well as what the items are.</p>
<p>We <em>want</em> to be able to do something like this:</p>
<div class="sourcecode skipme" data-type="example">
<p>lists/templates/list.xhtml</p>
<pre data-code-language="html" data-type="programlisting">    <code class="p">&lt;</code><code class="nt">form</code> <code class="na">method</code><code class="o">=</code><code class="s">"POST"</code> <code class="na">action</code><code class="o">=</code><code class="s">"/lists/{{ list.id }}/add_item"</code><code class="p">&gt;</code></pre></div>
<p>For that to work, the view will have to pass the list to the template.
Let’s create a new unit test in <code>ListViewTest</code>:</p>
<div class="sourcecode" data-type="example">
<p>lists/tests.py (ch07l051)</p>
<pre data-code-language="python" data-type="programlisting"><code>    </code><code class="k">def</code><code> </code><code class="nf">test_passes_correct_list_to_template</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="n">other_list</code><code> </code><code class="o">=</code><code> </code><code class="n">List</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="n">correct_list</code><code> </code><code class="o">=</code><code> </code><code class="n">List</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">create</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="n">response</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">client</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="sa">f</code><code class="s2">"</code><code class="s2">/lists/</code><code class="si">{</code><code class="n">correct_list</code><code class="o">.</code><code class="n">id</code><code class="si">}</code><code class="s2">/</code><code class="s2">"</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">assertEqual</code><code class="p">(</code><code class="n">response</code><code class="o">.</code><code class="n">context</code><code class="p">[</code><code class="s2">"</code><code class="s2">list</code><code class="s2">"</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">correct_list</code><code class="p">)</code><code>  </code><a class="co" href="#callout_working_incrementally_CO4-1" id="co_working_incrementally_CO4-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></pre></div>
<dl class="calloutlist">
<dt><a class="co" href="#co_working_incrementally_CO4-1" id="callout_working_incrementally_CO4-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p><code>response.context</code> represents the context we’re going to pass into
the render function—​the Django Test Client puts it on the <code>response</code>
object for us, to help with testing.</p></dd>
</dl>
<p>That gives us:</p>
<pre data-type="programlisting">    self.assertEqual(response.context["list"], correct_list)
                     ~~~~~~~~~~~~~~~~^^^^^^^^
[...]
KeyError: 'list'</pre>
<p>because we’re not passing <code>list</code> into the template.
It actually gives us an opportunity to simplify a little:</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch07l052)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">view_list</code><code class="p">(</code><code class="n">request</code><code class="p">,</code> <code class="n">list_id</code><code class="p">):</code>
    <code class="n">our_list</code> <code class="o">=</code> <code class="n">List</code><code class="o">.</code><code class="n">objects</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="nb">id</code><code class="o">=</code><code class="n">list_id</code><code class="p">)</code>
    <code class="k">return</code> <code class="n">render</code><code class="p">(</code><code class="n">request</code><code class="p">,</code> <code class="s2">"list.xhtml"</code><code class="p">,</code> <code class="p">{</code><code class="s2">"list"</code><code class="p">:</code> <code class="n">our_list</code><code class="p">})</code></pre></div>
<p>That, of course, introduces a bug,
because the template needed <code>items</code>:</p>
<pre data-type="programlisting">FAIL: test_displays_only_items_for_that_list
[...]
AssertionError: False is not true : Couldn't find 'itemey 1' in response</pre>
<p>But we can fix it in <em>list.xhtml</em>,
as well as adjusting the form’s POST action,
which is what we were trying to do anyway:</p>
<div class="sourcecode" data-type="example">
<p>lists/templates/list.xhtml (ch07l053)</p>
<pre data-code-language="html" data-type="programlisting"><code>    </code><code class="p">&lt;</code><code class="nt">form</code><code> </code><code class="na">method</code><code class="o">=</code><code class="s">"POST"</code><code> </code><code class="na">action</code><code class="o">=</code><code class="s">"/lists/{{ list.id }}/add_item"</code><code class="p">&gt;</code><code>  </code><a class="co" href="#callout_working_incrementally_CO5-1" id="co_working_incrementally_CO5-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
      [...]

      {% for item in list.item_set.all %}  </code><a class="co" href="#callout_working_incrementally_CO5-2" id="co_working_incrementally_CO5-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
        </code><code class="p">&lt;</code><code class="nt">tr</code><code class="p">&gt;</code><code class="p">&lt;</code><code class="nt">td</code><code class="p">&gt;</code><code>{{ forloop.counter }}: {{ item.text }}</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">td</code><code class="p">&gt;</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">tr</code><code class="p">&gt;</code><code>
      {% endfor %}</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" href="#co_working_incrementally_CO5-1" id="callout_working_incrementally_CO5-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>There’s our new form action.</p></dd>
<dt><a class="co" href="#co_working_incrementally_CO5-2" id="callout_working_incrementally_CO5-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p><code>.item_set</code> is called a
<a href="https://docs.djangoproject.com/en/4.2/topics/db/queries/#following-relationships-backward">reverse lookup</a>.
It’s one of Django’s incredibly useful bits of ORM that lets you look up an
object’s related items from a different table…​
<a data-primary="reverse lookups" data-type="indexterm" id="id437"/></p></dd>
</dl>
<p>So that gets the unit tests to pass:</p>
<pre data-type="programlisting">Ran 9 tests in 0.040s

OK</pre>
<p>How about the FTs?</p>
<pre data-type="programlisting">$ <strong>python manage.py test functional_tests</strong>
[...]
..
 ---------------------------------------------------------------------
Ran 2 tests in 9.771s

OK</pre>
<p>HOORAY!  Oh, and a quick check on our to-do list:</p>
<aside class="scratchpad" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id438">
<h1/>
<ul>
<li>
<p><em>
<span class="strikethrough line-through">Adjust model so that items are associated with different lists</span></em></p>
</li>
<li>
<p><em>
<span class="strikethrough line-through">Add unique URLs for each list</span></em></p>
</li>
<li>
<p><em>
<span class="strikethrough line-through">Add a URL for creating a new list via POST</span></em></p>
</li>
<li>
<p><em>
<span class="strikethrough line-through">Add URLs for adding a new item to an existing list via POST</span></em></p>
</li>
<li>
<p><em>Refactor away some duplication in urls.py</em></p>
</li>
</ul>
</div></aside>
<p>Irritatingly, the Testing Goat is a stickler for tying up loose ends too, so
we’ve got to do this one final thing.</p>
<p>Before we start, we’ll do a commit—​always make sure you’ve got a commit
of a working state before embarking on a refactor:</p>
<pre data-type="programlisting">$ <strong>git diff</strong>
$ <strong>git commit -am "new URL + view for adding to existing lists. FT passes :-)"</strong></pre>
</div></section>
</div></section>
<section data-pdf-bookmark="A Final Refactor Using URL includes" data-type="sect1"><div class="sect1" id="id60">
<h1>A Final Refactor Using URL includes</h1>
<p><em>superlists/urls.py</em> is really meant for URLs that apply to your entire site.
For URLs that only apply to the <code>lists</code> app,
Django encourages us to use a separate <em>lists/urls.py</em>,
to make the app more self-contained.
The simplest way to make one is to use a copy of the existing <em>urls.py</em>:</p>
<pre data-type="programlisting">$ <strong>cp superlists/urls.py lists/</strong></pre>
<p>Then we replace the three list-specific lines in <em>superlists/urls.py</em> with an <code>include()</code>:</p>
<div class="sourcecode" data-type="example">
<p>superlists/urls.py (ch07l055)</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code><code> </code><code class="nn">django</code><code class="nn">.</code><code class="nn">urls</code><code> </code><code class="kn">import</code><code> </code><code class="n">include</code><code class="p">,</code><code> </code><code class="n">path</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">lists</code><code> </code><code class="kn">import</code><code> </code><code class="n">views</code><code> </code><code class="k">as</code><code> </code><code class="n">list_views</code><code>  </code><a class="co" href="#callout_working_incrementally_CO6-1" id="co_working_incrementally_CO6-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code>
</code><code class="n">urlpatterns</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code>
</code><code>    </code><code class="n">path</code><code class="p">(</code><code class="s2">"</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">list_views</code><code class="o">.</code><code class="n">home_page</code><code class="p">,</code><code> </code><code class="n">name</code><code class="o">=</code><code class="s2">"</code><code class="s2">home</code><code class="s2">"</code><code class="p">)</code><code class="p">,</code><code>
</code><code>    </code><code class="n">path</code><code class="p">(</code><code class="s2">"</code><code class="s2">lists/</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">include</code><code class="p">(</code><code class="s2">"</code><code class="s2">lists.urls</code><code class="s2">"</code><code class="p">)</code><code class="p">)</code><code class="p">,</code><code>  </code><a class="co" href="#callout_working_incrementally_CO6-2" id="co_working_incrementally_CO6-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
</code><code class="p">]</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" href="#co_working_incrementally_CO6-1" id="callout_working_incrementally_CO6-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>While we’re at it, we use the <code>import x as y</code> syntax to alias <code>views</code>
This is good practice in your top-level <em>urls.py</em>,
because it will let us import views from multiple apps if we want—​and
indeed we will need to later on in the book.</p></dd>
<dt><a class="co" href="#co_working_incrementally_CO6-2" id="callout_working_incrementally_CO6-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Here’s the <code>include</code>.
Notice that it can take a part of a URL as a prefix,
which will be applied to all the included URLs
(this is the bit where we reduce duplication,
as well as giving our code a better structure).</p></dd>
</dl>
<p>Back in <em>lists/urls.py</em> we can trim down to only include the latter part
of our three URLs, and none of the other stuff from the parent <em>urls.py</em>:</p>
<div class="sourcecode" data-type="example">
<p>lists/urls.py (ch07l056)</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">django.urls</code> <code class="kn">import</code> <code class="n">path</code>
<code class="kn">from</code> <code class="nn">lists</code> <code class="kn">import</code> <code class="n">views</code>

<code class="n">urlpatterns</code> <code class="o">=</code> <code class="p">[</code>
    <code class="n">path</code><code class="p">(</code><code class="s2">"new"</code><code class="p">,</code> <code class="n">views</code><code class="o">.</code><code class="n">new_list</code><code class="p">,</code> <code class="n">name</code><code class="o">=</code><code class="s2">"new_list"</code><code class="p">),</code>
    <code class="n">path</code><code class="p">(</code><code class="s2">"&lt;int:list_id&gt;/"</code><code class="p">,</code> <code class="n">views</code><code class="o">.</code><code class="n">view_list</code><code class="p">,</code> <code class="n">name</code><code class="o">=</code><code class="s2">"view_list"</code><code class="p">),</code>
    <code class="n">path</code><code class="p">(</code><code class="s2">"&lt;int:list_id&gt;/add_item"</code><code class="p">,</code> <code class="n">views</code><code class="o">.</code><code class="n">add_item</code><code class="p">,</code> <code class="n">name</code><code class="o">=</code><code class="s2">"add_item"</code><code class="p">),</code>
<code class="p">]</code></pre></div>
<p>Rerun the unit tests to check that everything worked.</p>
<pre data-type="programlisting">Ran 9 tests in 0.040s

OK</pre>
<p>When I saw that it,
I couldn’t quite believe I did it correctly on the first go.
It always pays to be skeptical of your own abilities,
so I deliberately changed one of the URLs slightly,
just to check if it broke a test.
It did. We’re covered.</p>
<p>Feel free to try it yourself!
Remember to change it back,
check that the tests all pass again,
and then do a final commit:</p>
<pre data-type="programlisting">$ <strong>git status</strong>
$ <strong>git add lists/urls.py</strong>
$ <strong>git add superlists/urls.py</strong>
$ <strong>git diff --staged</strong>
$ <strong>git commit</strong></pre>
<p>Phew. A marathon chapter.
But we covered a number of important topics,
starting with some thinking about design.
We covered rules of thumb like “YAGNI” and “three strikes then refactor”.
But, most importantly, we saw how to adapt an existing codebase
step by step, going from working state to working state,
in order to iterate towards a new design.</p>
<p>I’d say we’re pretty close to being able to ship this site,
as the very first beta of the superlists website
that’s going to take over the world.
Maybe it needs a little prettification first…​let’s look at
what we need to do to deploy it in the next couple of chapters.
<a data-primary="" data-startref="TDDadapt07" data-type="indexterm" id="id439"/></p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id440">
<h1>Some More TDD Philosophy</h1><dl>
<dt>Working State to Working State (aka The Testing Goat vs. Refactoring Cat)</dt>
<dd>
<p>Our natural urge is often to dive in
and fix everything at once…​but if we’re not careful,
we’ll end up like Refactoring Cat,
in a situation with loads of changes to our code
and nothing working.
The Testing Goat encourages us to take one step at a time,
and go from working state to working state.
<a data-primary="Test-Driven Development (TDD)" data-secondary="philosophy of" data-tertiary="working state to working state" data-type="indexterm" id="id441"/>
<a data-primary="working state to working state" data-type="indexterm" id="id442"/></p>
</dd>
<dt>Split work out into small, achievable tasks</dt>
<dd>
<p>Sometimes this means starting with “boring” work
rather than diving straight in with the fun stuff,
but you’ll have to trust that YOLO-you in the parallel universe
is probably having a bad time, having broken everything,
and struggling to get the app working again.
<a data-primary="Test-Driven Development (TDD)" data-secondary="philosophy of" data-tertiary="split work into smaller tasks" data-type="indexterm" id="id443"/>
<a data-primary="small vs. big design" data-type="indexterm" id="id444"/></p>
</dd>
<dt>YAGNI</dt>
<dd>
<p>You ain’t gonna need it!
Avoid the temptation to write code that you think <em>might</em> be useful,
just because it suggests itself at the time.
Chances are, you won’t use it,
or you won’t have anticipated your future requirements correctly.
 See [Link to Come] for one methodology that helps us avoid this trap.
<a data-primary="Test-Driven Development (TDD)" data-secondary="philosophy of" data-tertiary="YAGNI" data-type="indexterm" id="id445"/>
<a data-primary="YAGNI (You ain’t gonna need it!)" data-type="indexterm" id="id446"/></p>
</dd>
</dl>
</div></aside>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="id427"><sup><a href="ch07.xhtml#id427-marker">1</a></sup> Are you wondering about the strange spelling of the “nulist” variable? Other options are “list”, which would shadow the built-in <code>list()</code> function, and <code>new_list</code>, which would shadow the name of the function that contains it. Or <code>list1</code> or <code>listey</code> or <code>mylist</code>, but none are particularly satisfactory.</p></div></div></section></div></body></html>