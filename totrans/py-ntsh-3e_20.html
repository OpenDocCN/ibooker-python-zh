<html><head></head><body>
<div id="sbo-rt-content"><section data-nutshell-tab="Serving HTTP" data-pdf-bookmark="Chapter 20. Serving HTTP" data-type="chapter" epub:type="chapter"><div class="chapter" id="serving_http">
<h1><span class="label">Chapter 20. </span>Serving HTTP</h1>
<p>When<a contenteditable="false" data-primary="web programming (server-side)" data-secondary="serving HTTP" data-type="indexterm" id="idm44924487700704"/> a browser (or any other web client) requests a page from a server, the server may return either static or dynamic content. Serving dynamic content involves server-side web programs generating and delivering content on the fly, often based on information stored in a database.</p>
<p>In<a contenteditable="false" data-primary="Common Gateway Interface (CGI)" data-type="indexterm" id="idm44924487698784"/><a contenteditable="false" data-primary="CGI (Common Gateway Interface)" data-type="indexterm" id="idm44924487697680"/> the early history of the web, the standard for server-side programming was the <em>Common Gateway Interface</em> (CGI), which required the server to run a separate program each time a client requested dynamic content. Process startup time, interpreter initialization, connection to databases, and script initialization add up to measurable overhead; CGI did not scale well.</p>
<p>Nowadays, web servers support many server-specific ways to reduce overhead, serving dynamic content from processes that can serve for several hits rather than starting up a new process per hit. Therefore, we do not cover CGI in this book. To maintain existing CGI programs, or better yet, port them to more modern approaches, consult the online docs (especially <a href="https://oreil.ly/qNhHr">PEP 594</a> for recommendations) and check out the standard library modules <a href="https://oreil.ly/h5Fo_"><span class="code">cgi</span></a> (deprecated as of 3.11) and <a href="https://oreil.ly/U4JL9"><span class="code">http.cookies</span></a>.<sup><a data-type="noteref" href="ch20.xhtml#ch01fn151" id="ch01fn151-marker">1</a></sup></p>
<p>HTTP<a contenteditable="false" data-primary="HTTP (Hypertext Transfer Protocol)" data-type="indexterm" id="idm44924487690752"/><a contenteditable="false" data-primary="Hypertext Transfer Protocol (HTTP)" data-type="indexterm" id="idm44924487689552"/> has become even more fundamental to distributed systems design with the emergence of systems based on <a href="https://microservices.io">microservices</a>, offering a convenient way to transport between processes the JSON content that is frequently used. There are thousands of publicly available HTTP data APIs on the internet. While HTTP’s principles remain almost unchanged since its inception in the mid-1990s, it has been significantly enhanced over the years to extend its capabilities.<sup><a data-type="noteref" href="ch20.xhtml#ch01fn152" id="ch01fn152-marker">2</a></sup> For a thorough grounding with excellent reference materials we recommend <a class="orm:hideurl" href="https://learning.oreilly.com/library/view/http-the-definitive/1565925092"><em>HTTP: The Definitive Guide</em></a> by David Gourley et al. (O’Reilly).</p>
<section data-pdf-bookmark="http.server" data-type="sect1"><div class="sect1" id="httpdotserver">
<h1>http.server</h1>
<p>Python’s<a contenteditable="false" data-primary="http.server module" data-type="indexterm" id="idm44924487682592"/><a contenteditable="false" data-primary="web programming (server-side)" data-secondary="http.server" data-type="indexterm" id="idm44924487681456"/><a contenteditable="false" data-primary="standard library modules" data-secondary="http.server" data-type="indexterm" id="idm44924487680016"/> standard library includes a module containing the server and handler classes to implement a simple HTTP server.</p>
<p>You can run this server from the command line by just entering:</p>
<pre data-code-language="python" data-type="programlisting">
$ <strong>python -m http.server</strong> <strong><em>port_number</em></strong></pre>
<p>By default, the server listens on all interfaces and provides access to the files in the current directory. One author uses this as a simple means for file transfer: start up a Python <span class="code">http.server</span> in the file directory on the source system, and then copy files to the destination using a utility such as <span class="code">wget</span> or <span class="code">curl</span>.</p>
<p><span class="code">http.server</span> has very limited security features. You can find further information on <span class="code">http.server</span> in the <a href="https://oreil.ly/5ckN2">online docs</a>. For production use, we recommend that you use one of the frameworks mentioned in the following sections.</p>
</div></section>
<section data-pdf-bookmark="WSGI" data-type="sect1"><div class="sect1" id="wsgi">
<h1>WSGI</h1>
<p>Python’s <em>Web Server Gateway Interface</em> (WSGI)<a contenteditable="false" data-primary="web programming (server-side)" data-secondary="Web Server Gateway Interface (WSGI)" data-type="indexterm" id="websgi20"/><a contenteditable="false" data-primary="Web Server Gateway Interface (WSGI)" data-type="indexterm" id="idm44924487666560"/><a contenteditable="false" data-primary="WSGI (Web Server Gateway Interface)" data-type="indexterm" id="wsgi20"/> is the standard way for all modern Python web development frameworks to interface with underlying web servers or gateways. WSGI is not meant for direct use by your application programs; rather, you code your programs using any one of many higher-abstraction frameworks, and the framework, in turn, uses WSGI to talk to the web server.</p>
<p>You need to care about the details of WSGI only if you’re implementing the WSGI interface for a web server that doesn’t already provide it (should any such server exist), or if you’re building a new Python web framework.<sup><a data-type="noteref" href="ch20.xhtml#ch01fn153" id="ch01fn153-marker">3</a></sup> In that case, study the WSGI <a href="https://oreil.ly/CALIJ">PEP</a>, the docs for the standard library package <a href="https://oreil.ly/9HmUO"><span class="code">wsgiref</span></a>, and the <a href="https://oreil.ly/UWcaq">archive</a> of <a href="http://WSGI.org">WSGI.org</a>.</p>
<p>A few WSGI concepts may be important to you if you use lightweight frameworks (i.e., ones that match WSGI closely). WSGI is an <em>interface</em>, and that interface has two sides: the <em>web server/gateway</em> side, and the <em>application/framework</em> side.</p>
<p>The framework side’s job is to provide a <em>WSGI application</em> object, a callable object (often the instance of a class with a <span class="code">__call__</span> special method, but that’s an implementation detail) respecting conventions in the PEP, and to connect the application object to the server by whatever means the specific server documents (often a few lines of code, or configuration files, or just a convention such as naming the WSGI application object <span class="code">application</span> as a top-level attribute in a module). The server calls the application object for each incoming HTTP request, and the application object responds appropriately so that the server can form the outgoing HTTP response and send it on—all according to said conventions. A framework, even a lightweight one, shields you from such details (except that you may have to instantiate and connect the application object, depending on the specific server).</p>
<section data-pdf-bookmark="WSGI Servers" data-type="sect2"><div class="sect2" id="wsgi_servers">
<h2>WSGI Servers</h2>
<p>An extensive list of servers and adapters you can use to run WSGI frameworks and applications (for development and testing, in production web setups, or both) is available <a href="https://oreil.ly/7De2i">online</a>—extensive, but just partial. For example, it does not mention that Google App Engine’s Python runtime is also a WSGI server, ready to dispatch WSGI apps as directed by the <em>app.yaml</em> configuration file.</p>
<p>If you’re looking for a WSGI server to use for development, or to deploy in production behind, say, an Nginx-based load balancer, you should be happy, at least on Unix-like systems, with<a contenteditable="false" data-primary="Gunicorn" data-type="indexterm" id="idm44924487651424"/> <a href="https://gunicorn.org">Gunicorn</a>: pure Python goodness, supporting nothing but WSGI, very lightweight. A worthy (also pure Python and WSGI-only) alternative, currently with better Windows support, is<a contenteditable="false" data-primary="Waitress" data-type="indexterm" id="idm44924487649472"/> <a href="https://oreil.ly/bs4IW">Waitress</a>. If you need richer features (such as support for Perl and Ruby as well as Python, and many other forms of extensibility), consider the bigger, more complex<a contenteditable="false" data-primary="uWSGI" data-type="indexterm" id="idm44924487647520"/> <a href="https://oreil.ly/DwiOe">uWSGI</a>.<sup><a data-type="noteref" href="ch20.xhtml#ch01fn154" id="ch01fn154-marker">4</a></sup></p>
<p>WSGI also has the concept of<a contenteditable="false" data-primary="middleware" data-type="indexterm" id="idm44924487644320"/> <em>middleware</em>, a subsystem that implements both the server and application sides of WSGI. A middleware object “wraps” a WSGI application; can selectively alter requests, environments, and responses; and presents itself to the server as “the application.” Multiple layers of wrappers are allowed and common, forming a “stack” of middleware offering services to the actual application-level code. If you want to write a cross-framework middleware component, then you may, indeed, need to become a WSGI expert.</p>
</div></section>
<section class="pagebreak-before" data-pdf-bookmark="ASGI" data-type="sect2"><div class="sect2" id="asgi">
<h2 class="less_space">ASGI</h2>
<p>If you’re into<a contenteditable="false" data-primary="asynchronous (async) programming" data-type="indexterm" id="idm44924487640144"/><a contenteditable="false" data-primary="ASGI (Asynchronous Server Gateway Interface)" data-type="indexterm" id="idm44924487638944"/><a contenteditable="false" data-primary="Asynchronous Server Gateway Interface (ASGI)" data-type="indexterm" id="idm44924487637744"/> asynchronous Python (which we don’t cover in this book), you should definitely investigate <a href="https://oreil.ly/ceEuZ">ASGI</a>, which sets out to do pretty much what<a contenteditable="false" data-primary="" data-startref="websgi20" data-type="indexterm" id="idm44924487635680"/><a contenteditable="false" data-primary="" data-startref="wsgi20" data-type="indexterm" id="idm44924487634304"/> WSGI does, but asynchronously. As is usually the case for asynchronous programs in a networking environment, it can offer greatly improved performance, albeit (arguably) with some increase in cognitive load for the developer.</p>
</div></section>
</div></section>
<section data-pdf-bookmark="Python Web Frameworks" data-type="sect1"><div class="sect1" id="python_web_frameworks">
<h1>Python Web Frameworks</h1>
<p>For<a contenteditable="false" data-primary="web programming (server-side)" data-secondary="Python web frameworks" data-type="indexterm" id="WPSSpwebframe20"/> a survey of Python web frameworks, see the Python <a href="https://oreil.ly/Me-Ig">wiki page</a>. It’s authoritative since it’s on the official <a href="http://Python.org">Python.org</a> website, and it’s community curated, so it stays up-to-date as time goes by. The wiki lists and points to dozens of frameworks<sup><a data-type="noteref" href="ch20.xhtml#ch01fn155" id="ch01fn155-marker">5</a></sup> that it identifies as “active,” plus many more it identifies as “discontinued/inactive.” In addition, it points to separate wiki pages about Python content management systems, web servers, and web components and libraries thereof.</p>
<section data-pdf-bookmark="“Full-Stack” Versus “Lightweight” Frameworks" data-type="sect2"><div class="sect2" id="quotation_markfull_stackquotation_mark">
<h2>“Full-Stack” Versus “Lightweight” Frameworks</h2>
<p>Roughly speaking, Python web frameworks can be classified as being either<a contenteditable="false" data-primary="full-stack frameworks" data-type="indexterm" id="idm44924487624496"/> <em>full-stack</em> (trying to supply all the functionality you may need to build a web application) or<a contenteditable="false" data-primary="lightweight frameworks" data-type="indexterm" id="lightframe20"/> <em>lightweight</em> (supplying just a handy interface to web serving itself, and letting you pick and choose your own favorite components for tasks such as interfacing to databases and templating). Of course, like all taxonomies, this one is imprecise and incomplete, and requires value judgments; however, it’s one way to start making sense of the many Python web frameworks.</p>
<p>In this book, we do not thoroughly cover any full-stack frameworks—each is far too complex. Nevertheless, one of them might be the best approach for your specific applications, so we do mention a few of the most popular ones, and recommend that you check out their websites.</p>
</div></section>
<section data-pdf-bookmark="A Few Popular Full-Stack Frameworks" data-type="sect2"><div class="sect2" id="a_few_popular_full_stack_frameworks">
<h2>A Few Popular Full-Stack Frameworks</h2>
<p>By far the most popular full-stack framework is<a contenteditable="false" data-primary="Django" data-type="indexterm" id="idm44924487618176"/> <a href="https://oreil.ly/JLnV5">Django</a>, which is sprawling and extensible. Django’s so-called <em>applications</em> are in fact reusable subsystems, while what’s normally called “an application” Django calls a <em>project</em>. Django requires its own unique mindset, but offers enormous power and functionality in return.</p>
<p class="pagebreak-before">An excellent alternative is<a contenteditable="false" data-primary="web2py" data-type="indexterm" id="idm44924487614352"/> <a href="http://www.web2py.com">web2py</a>: it’s just about as powerful, easier to learn, and well known for its dedication to backward compatibility (if it keeps up its great track record, any web2py application you code today will keep working far into the future). web2py also has outstanding documentation.</p>
<p>A third worthy contender is<a contenteditable="false" data-primary="TurboGears" data-type="indexterm" id="idm44924487611936"/> <a href="https://turbogears.org">TurboGears</a>, which starts out as a lightweight framework but achieves “full-stack” status by fully integrating other, independent third-party projects for the various other functionalities needed in most web apps, such as database interfacing and templating, rather than designing its own. Another somewhat philosophically similar “light but rich” framework is<a contenteditable="false" data-primary="Pyramid" data-type="indexterm" id="idm44924487609984"/> <a href="https://trypyramid.com">Pyramid</a>.</p>
</div></section>
<section data-pdf-bookmark="Considerations When Using Lightweight Frameworks" data-type="sect2"><div class="sect2" id="considerations_when_using_lightweight_f">
<h2>Considerations When Using Lightweight Frameworks</h2>
<p>Whenever you use a lightweight framework, if you need any database, templating, or other functionality not strictly related to HTTP, you’ll be picking and choosing separate components for that purpose. However, the lighter in weight your framework, the more components you will need to understand and integrate, for purposes such as authenticating a user or maintaining state across web requests by a given user. Many WSGI middleware packages can help you with such tasks. Some excellent ones are quite focused—for<a contenteditable="false" data-primary="Oso" data-type="indexterm" id="idm44924487606032"/> example, <a href="https://oreil.ly/zyXl0">Oso</a> for access control, <a href="https://oreil.ly/v8LxQ">Beaker</a> <a contenteditable="false" data-primary="Beaker" data-type="indexterm" id="idm44924487603360"/>for maintaining state in the form of lightweight sessions of any one of several kinds, and so forth.</p>
<p>However, when we (the authors of this book) require good WSGI middleware for just about any purpose, we almost invariably first check<a contenteditable="false" data-primary="Werkzeug" data-type="indexterm" id="idm44924487601424"/> <a href="https://oreil.ly/lF9H3">Werkzeug</a>, a collection of such components that’s amazing in breadth and quality. We don’t cover Werkzeug in this book (just as we don’t cover other middleware), but we recommend it highly (Werkzeug is also the foundation on which Flask—our favorite lightweight framework, which we do cover later in this chapter—is built).</p>
<p>You may notice that properly using lightweight frameworks requires you to understand HTTP (in other words, to know what you’re doing), while a full-stack framework tries to lead you by the hand and have you do the right thing without really needing to understand how or why it is right—at the cost of time and resources, and of accepting the full-stack framework’s conceptual map and mindset. The authors of this book are enthusiasts of the knowledge-heavy, resources-light approach of lightweight frameworks, but we acknowledge that there are many situations where the rich, heavy, all-embracing full-stack frameworks are more appropriate. To each their own!</p>
</div></section>
<section data-pdf-bookmark="A Few Popular Lightweight Frameworks" data-type="sect2"><div class="sect2" id="a_few_popular_lightweight_frameworks">
<h2>A Few Popular Lightweight Frameworks</h2>
<p>As mentioned, Python has multiple frameworks, including many lightweight ones. We cover two of the latter here: the popular, general-purpose Flask, and API-centric FastAPI.</p>
<section data-pdf-bookmark="Flask" data-type="sect3"><div class="sect3" id="flask">
<h3>Flask</h3>
<p>The most popular Python lightweight framework is<a contenteditable="false" data-primary="Flask" data-type="indexterm" id="flask20"/> <a href="https://oreil.ly/oCnoc">Flask</a>, a third-party <span class="code">pip</span>-installable package. Although lightweight, it includes a development server and debugger, and it explicitly relies on other well-chosen packages such as Werkzeug for middleware and <a href="https://oreil.ly/-HdvE">Jinja</a> for templating (both packages were originally authored by Armin Ronacher, the author of Flask).</p>
<p>In addition to the project website (which includes rich, detailed docs), look at the <a href="https://oreil.ly/v_YkH">sources on GitHub</a> and the <a href="https://oreil.ly/-76be">PyPI entry</a>. If you want to run Flask on Google App Engine (locally on your computer, or on Google’s servers at <em><a href="http://appspot.com">appspot.com</a></em>), Dough Mahugh’s <a href="https://oreil.ly/bs0JC">Medium article</a> can be quite handy.</p>
<p>We also highly recommend Miguel Grinberg’s book <a class="orm:hideurl" href="https://learning.oreilly.com/library/view/flask-web-development/9781491991725/"><em>Flask Web Development</em></a> (O’Reilly): although the second edition is rather dated (almost four years old at the time of this writing), it still provides an excellent foundation, on top of which you’ll have a far easier time learning the latest new additions.</p>
<p>The main class supplied by the <span class="code">flask</span> package is named <span class="code">Flask</span>. An instance of <span class="code">flask.Flask</span>, besides being a WSGI application itself, also wraps a WSGI application as its <span class="code">wsgi_app</span> property. When you need to further wrap the WSGI app in some WSGI middleware, use the idiom:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">flask</code><code>
</code><code>
</code><code class="n">app</code><code> </code><code class="o">=</code><code> </code><code class="n">flask</code><code class="o">.</code><code class="n">Flask</code><code class="p">(</code><code class="vm">__name__</code><code class="p">)</code><code>
</code><code class="n">app</code><code class="o">.</code><code class="n">wsgi_app</code><code> </code><code class="o">=</code><code> </code><em><code class="n">some_middleware</code></em><code class="p">(</code><code class="n">app</code><code class="o">.</code><code class="n">wsgi_app</code><code class="p">)</code></pre>
<p>When you instantiate <span class="code">flask.Flask</span>, always pass it as the first argument the application name (often just the <span class="code">__name__</span> special variable of the module where you instantiate it; if you instantiate it from within a package, usually in <em>__init__.py</em>, <span class="code">__name__.partition('.')[0]</span> works). Optionally, you can also pass named parameters such as <span class="code">static_folder</span> and <span class="code">template_folder</span> to customize where static files and Jinja templates are found; however, that’s rarely needed—the default values (subfolders named <em>static</em> and <em>templates</em>, respectively, located in the same folder as the Python script that instantiates <span class="code">flask.Flask</span>) make perfect sense.</p>
<p>An instance <span class="code"><em>app</em></span> of <span class="code">flask.Flask</span> supplies more than 100 methods and properties, many of them decorators to bind functions to <span class="code"><em>app</em></span> in various roles, such as <em>view functions</em> (serving HTTP verbs on a URL) or <em>hooks</em> (letting you alter a request before it’s processed or a response after it’s built, handling errors, and so forth).</p>
<p><span class="code">flask.Flask</span> takes just a few parameters at instantiation (and the ones it takes are not ones that you usually need to compute in your code), and it supplies decorators you’ll want to use as you define, for example, view functions. Thus, the normal pattern in <span class="code">flask</span> is to instantiate <span class="code"><em>app</em></span> early in your main script, just as your application is starting up, so that the app’s decorators, and other methods and properties, are available as you <span class="code"><strong>def</strong></span> view functions and so on.</p>
<p>Since there is a single global <span class="code"><em>app</em></span> object, you may wonder how thread-safe it can be to access, mutate, and rebind <span class="code"><em>app</em></span>’s properties and attributes. Not to worry: the names you see are actually just proxies to actual objects living in the <em>context</em> of a specific request, in a specific thread or <a href="https://oreil.ly/IaGCM">greenlet</a>. Never type-check those properties (their types are in fact obscure proxy types), and you’ll be fine.</p>
<p>Flask also supplies many other utility functions and classes; often, the latter subclass or wrap classes from other packages to add seamless, convenient Flask integration. For example, Flask’s <span class="code">Request</span> and <span class="code">Response</span> classes add just a little handy functionality by subclassing the corresponding Werkzeug classes.</p>
<section data-pdf-bookmark="Flask request objects" data-type="sect4"><div class="sect4" id="flask_request_objects">
<h4>Flask request objects</h4>
<p>The class <span class="code">flask.Request</span> supplies a large number of <a href="https://oreil.ly/mmYul">thoroughly documented properties</a>. <a data-type="xref" href="#useful_properties_of_flaskdotrequest">Table 20-1</a> lists the ones you’ll be using most often.</p>
<table class="border" id="useful_properties_of_flaskdotrequest">
<caption><span class="label">Table 20-1. </span>Useful properties of <span class="code">flask.Request</span></caption>
<tbody>
<tr>
<td><span class="code">args</span></td>
<td>A <span class="code">MultiDict</span> of the request’s query arguments</td>
</tr>
<tr>
<td><span class="code">cookies</span></td>
<td>A <span class="code">dict</span> with the cookies from the request</td>
</tr>
<tr>
<td><span class="code">data</span></td>
<td>A <span class="code">bytes</span> string, the request’s body (typically for POST and PUT requests)</td>
</tr>
<tr>
<td><span class="code">files</span></td>
<td>A <span class="code">MultiDict</span> of uploaded files in the request, mapping the files’ names to file-like objects containing each file’s data</td>
</tr>
<tr>
<td><span class="code">form</span></td>
<td>A <span class="code">MultiDict</span> with the request’s form fields, provided in the request’s body</td>
</tr>
<tr>
<td><span class="code">headers</span></td>
<td>A <span class="code">MultiDict</span> with the request’s headers</td>
</tr>
<tr>
<td><span class="code">values</span></td>
<td>A <span class="code">MultiDict</span> combining the <span class="code">args</span> and <span class="code">form</span> properties</td>
</tr>
</tbody>
</table>
<p>A <span class="code">MultiDict</span> is like a <span class="code">dict</span>, except that it can have multiple values for a key. Indexing and <span class="code">get</span> on a <span class="code">MultiDict</span> instance <span class="code"><em>m</em></span> return an arbitrary one of the values; to get the list of values for a key (an empty list, if the key is not in <span class="code"><em>m</em></span>), call <span class="code"><em>m</em></span><span class="code">.getlist(<em>key</em>)</span>.</p>
</div></section>
<section data-pdf-bookmark="Flask response objects" data-type="sect4"><div class="sect4" id="flask_response_objects">
<h4>Flask response objects</h4>
<p>Often, a Flask view function can just return a string (which becomes the response’s body): Flask transparently wraps an instance <span class="code"><em>r</em></span> of <span class="code">flask.Response</span> around the string, so you don’t have to worry about the response class. However, sometimes you want to alter the response’s headers; in this case, in the view function, call <span class="code"><em>r</em></span> <span class="code">= flask.make_response(<em>astring</em>)</span>, alter <span class="code"><em>r</em></span><span class="code">.headers</span> as you want, then <span class="code">return</span> <span class="code"><em>r</em></span>. (To set a cookie, don’t use <span class="code"><em>r</em></span><span class="code">.headers</span>; rather, call <a href="https://oreil.ly/AehLj"><span class="code"><em>r</em>.set_cookie</span></a>.)</p>
<p>Some of Flask’s built-in integrations with other systems don’t require subclassing: for example, the templating integration implicitly injects into the Jinja context the Flask globals <span class="code">config</span>, <span class="code">request</span>, <span class="code">session</span>, and <span class="code">g</span> (the latter being the handy “globals catch-all” object <span class="code">flask.g</span>, a proxy in application context, in which your code can store whatever you want to “stash” for the duration of the request being served) and the functions <span class="code">url_for</span> (to translate an endpoint to the corresponding URL, same as <span class="code">flask.url_for</span>) and <span class="code">get_flashed_messages</span> (to support <em>flashed messages</em>, which we do not cover in this book; same as <span class="code">flask.get_flashed_messages</span>). Flask also provides convenient ways for your code to inject more filters, functions, and values into the Jinja context, without any subclassing.</p>
<p>Most of the officially recognized or approved Flask <a href="https://oreil.ly/V8mD7">extensions</a> (hundreds are available from PyPI at the time of this writing) adopt similar approaches, supplying classes and utility functions to seamlessly integrate other popular subsystems with your Flask applications.</p>
<p>In addition, Flask introduces other features, such as <a href="https://oreil.ly/YmEuJ"><em>signals</em></a> to provide looser dynamic coupling in a “pub/sub” pattern and <a href="https://oreil.ly/jMIZE"><em>blueprints</em></a>, offering a substantial subset of a Flask application’s functionality to ease refactoring large applications in highly modular, flexible ways. We do not cover these advanced concepts in this book.</p>
<p><a data-type="xref" href="#example_twozero_onedot_a_flask_example">Example 20-1</a> shows a simple Flask example. (After using <span class="code">pip</span> to install Flask, run the example using the command <span class="code"><strong>flask --app flask_example run</strong></span>.)</p>
<div data-type="example" id="example_twozero_onedot_a_flask_example">
<h5><span class="label">Example 20-1. </span>A Flask example</h5>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">datetime</code><code class="o">,</code><code> </code><code class="nn">flask</code><code>
</code><code class="n">app</code><code> </code><code class="o">=</code><code> </code><code class="n">flask</code><code class="o">.</code><code class="n">Flask</code><code class="p">(</code><code class="vm">__name__</code><code class="p">)</code><code>
</code><code>
</code><em><code class="c1"># secret key for cryptographic components such as encoding session cookies;</code></em><code>
</code><em><code class="c1"># for production use, use secrets.token_bytes()</code></em><code>
</code><code class="n">app</code><code class="o">.</code><code class="n">secret_key</code><code> </code><code class="o">=</code><code> </code><code class="sa">b</code><strong><code class="s1">'</code><code class="se">\xc5</code><code class="se">\x8f</code><code class="se">\xbc</code><code class="se">\xa2</code><code class="se">\x1d</code><code class="se">\xeb</code><code class="se">\xb3</code><code class="se">\x94</code><code class="s1">;:d</code><code class="se">\x03</code><code class="s1">'</code></strong><code>
</code><code>
</code><code class="nd">@app</code><code class="o">.</code><code class="n">route</code><code class="p">(</code><code class="s1">'</code><code class="s1">/</code><code class="s1">'</code><code class="p">)</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">greet</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">lastvisit</code><code> </code><code class="o">=</code><code> </code><code class="n">flask</code><code class="o">.</code><code class="n">session</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s1">'</code><code class="s1">lastvisit</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>    </code><code class="n">now</code><code> </code><code class="o">=</code><code> </code><code class="n">datetime</code><code class="o">.</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="n">newvisit</code><code> </code><code class="o">=</code><code> </code><code class="n">now</code><code class="o">.</code><code class="n">ctime</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="n">template</code><code> </code><code class="o">=</code><code> </code><code class="s1">'''</code><code class="s1">
</code><code class="s1">      &lt;html&gt;&lt;head&gt;&lt;title&gt;Hello, visitor!&lt;/title&gt;</code><code class="s1">
</code><code class="s1">      &lt;/head&gt;&lt;body&gt;</code><code class="s1">
</code><code class="s1">      </code><code class="s1">{</code><code class="si">% i</code><code class="s1">f lastvisit </code><code class="s1">%</code><code class="s1">}</code><code class="s1">
</code><code class="s1">        &lt;p&gt;Welcome back to this site!&lt;/p&gt;</code><code class="s1">
</code><code class="s1">        &lt;p&gt;You last visited on </code><code class="s1">{{</code><code class="s1">lastvisit}} UTC&lt;/p&gt;</code><code class="s1">
</code><code class="s1">        &lt;p&gt;This visit on </code><code class="s1">{{</code><code class="s1">newvisit}} UTC&lt;/p&gt;</code><code class="s1">
</code><code class="s1">      </code><code class="s1">{</code><code class="si">% e</code><code class="s1">lse </code><code class="s1">%</code><code class="s1">}</code><code class="s1">
</code><code class="s1">        &lt;p&gt;Welcome to this site on your first visit!&lt;/p&gt;</code><code class="s1">
</code><code class="s1">        &lt;p&gt;This visit on </code><code class="s1">{{</code><code class="s1">newvisit}} UTC&lt;/p&gt;</code><code class="s1">
</code><code class="s1">        &lt;p&gt;Please Refresh the web page to proceed&lt;/p&gt;</code><code class="s1">
</code><code class="s1">      </code><code class="s1">{</code><code class="si">% e</code><code class="s1">ndif </code><code class="s1">%</code><code class="s1">}</code><code class="s1">
</code><code class="s1">      &lt;/body&gt;&lt;/html&gt;</code><code class="s1">'''</code><code>
</code><code>    </code><code class="n">flask</code><code class="o">.</code><code class="n">session</code><code class="p">[</code><code class="s1">'</code><code class="s1">lastvisit</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">newvisit</code><code>
</code><code>    </code><strong><code class="k">return</code></strong><code> </code><code class="n">flask</code><code class="o">.</code><code class="n">render_template_string</code><code class="p">(</code><code>
</code><code>      </code><code class="n">template</code><code class="p">,</code><code> </code><code class="n">newvisit</code><code class="o">=</code><code class="n">newvisit</code><code class="p">,</code><code> </code><code class="n">lastvisit</code><code class="o">=</code><code class="n">lastvisit</code><code class="p">)</code></pre>
</div>
<p class="pagebreak-before">This example shows how to use just a few of the many building blocks that Flask offers—the <span class="code">Flask</span> class, a view function, and rendering the response (in this case, using <span class="code">render_template_string</span> on a Jinja template; in real life, templates are usually kept in separate files rendered with <span class="code">render_template</span>). The example also shows how to maintain continuity of state among multiple interactions with the server from the same browser, with the handy <span class="code">flask.session</span> variable. (It could alternatively have put together the HTML response in Python code instead of using Jinja, and used a cookie directly instead of the session; however, real-world Flask apps do tend to use Jinja and sessions by preference.)</p>
<p>If this app had multiple view functions, it might want to set <span class="code">lastvisit</span> in the session to whatever URL had triggered the request. Here’s how to code and decorate a hook function to execute after each request:</p>
<pre data-code-language="python" data-type="programlisting">
<code class="nd">@app</code><code class="o">.</code><code class="n">after_request</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">set_lastvisit</code><code class="p">(</code><code class="n">response</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">now</code><code> </code><code class="o">=</code><code> </code><code class="n">datetime</code><code class="o">.</code><code class="n">datetime</code><code class="o">.</code><code class="n">now</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="n">flask</code><code class="o">.</code><code class="n">session</code><code class="p">[</code><code class="s1">'</code><code class="s1">lastvisit</code><code class="s1">'</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">now</code><code class="o">.</code><code class="n">ctime</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><strong><code class="k">return</code></strong><code> </code><code class="n">response</code></pre>
<p>You can now remove the <span class="code">flask.session['lastvisit'] = newvisit</span> statement from the view function <span class="code">greet</span>, and the app will keep working fine.<a contenteditable="false" data-primary="" data-startref="flask20" data-type="indexterm" id="idm44924487201808"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="FastAPI" data-type="sect3"><div class="sect3" id="fastapi">
<h3>FastAPI</h3>
<p><a href="https://fastapi.tiangolo.com">FastAPI</a> is<a contenteditable="false" data-primary="FastAPI" data-type="indexterm" id="fastapi20"/> of a more recent design than Flask or Django. While both of the latter have very usable extensions to provide API services, FastAPI aims squarely at producing HTTP-based APIs, as its name suggests. It’s also perfectly capable of producing dynamic web pages intended for browser consumption, making it a versatile server. FastAPI’s <a href="https://fastapi.tiangolo.com">home page</a> provides simple, short examples showing how it works and highlighting the advantages, backed up by very thorough and detailed reference documentation.</p>
<p>As type annotations (covered in <a data-type="xref" href="ch05.xhtml#type_annotations">Chapter 5</a>) entered the Python language, they found wider use than originally intended in tools like<a contenteditable="false" data-primary="pydantic" data-type="indexterm" id="idm44924487194208"/> <a href="https://pydantic-docs.helpmanual.io"><span class="code">pydantic</span></a>, which uses them to perform runtime parsing and validation. The FastAPI server exploits this support for clean data structures, demonstrating great potential to improve web coding productivity through built-in and tailored conversion and validation of inputs.</p>
<p>FastAPI also relies on<a contenteditable="false" data-primary="Starlette" data-type="indexterm" id="idm44924487160848"/> <a href="https://www.starlette.io">Starlette</a>, a high-performance asynchronous web framework, which in turn uses an ASGI server such as<a contenteditable="false" data-primary="Uvicorn" data-type="indexterm" id="idm44924487159008"/> <a href="https://www.uvicorn.org">Uvicorn</a> or<a contenteditable="false" data-primary="Hypercorn" data-type="indexterm" id="idm44924487157280"/> <a href="https://oreil.ly/SXsur">Hypercorn</a>. You don’t need to use async techniques directly to take advantage of FastAPI. You can write your application in more traditional Python style, though it might perform even faster if you do switch to the async style.</p>
<p>FastAPI’s ability to provide type-accurate APIs (and automatically generated documentation for them) aligned with the types indicated by your annotations means it can provide automatic parsing of incoming data and conversion on both input and output.</p>
<p>Consider the sample code shown in <a data-type="xref" href="#example_twozero_twodot_modelsdotpy_pyda">Example 20-2</a>, which defines a simple model for both <span class="code">pydantic</span> and <span class="code">mongoengine</span>. Each has four fields: <span class="code">name</span> and <span class="code">description</span> are strings, <span class="code">price</span> and <span class="code">tax</span> are decimal. Values are required for the <span class="code">name</span> and <span class="code">price</span> fields, but <span class="code">description</span> and <span class="code">tax</span> are optional. <span class="code">pydantic</span> establishes a default value of <span class="code"><strong>None</strong></span> for the latter two fields; <span class="code">mongoengine</span> does not store a value for fields whose value is <span class="code"><strong>None</strong></span>.</p>
<div data-type="example" id="example_twozero_twodot_modelsdotpy_pyda">
<h5><span class="label">Example 20-2. </span>models.py: <span class="code">pydantic</span> and <span class="code">mongoengine</span> data models</h5>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">from</code></strong><code> </code><code class="nn">decimal</code><code> </code><strong><code class="kn">import</code></strong><code> </code><code class="n">Decimal</code><code>
</code><strong><code class="kn">from</code></strong><code> </code><code class="nn">pydantic</code><code> </code><strong><code class="kn">import</code></strong><code> </code><code class="n">BaseModel</code><code class="p">,</code><code> </code><code class="n">Field</code><code>
</code><strong><code class="kn">from</code></strong><code> </code><code class="nn">mongoengine</code><code> </code><strong><code class="kn">import</code></strong><code> </code><code class="n">Document</code><code class="p">,</code><code> </code><code class="n">StringField</code><code class="p">,</code><code> </code><code class="n">DecimalField</code><code>
</code><strong><code class="kn">from</code></strong><code> </code><code class="nn">typing</code><code> </code><strong><code class="kn">import</code></strong><code> </code><code class="n">Optional</code><code>
</code><code>
</code><strong><code class="k">class</code></strong><code> </code><code class="nc">PItem</code><code class="p">(</code><code class="n">BaseModel</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="s2">"</code><code class="s2">pydantic typed data class.</code><code class="s2">"</code><code>
</code><code>    </code><code class="n">name</code><code class="p">:</code><code> </code><code class="nb">str</code><code>
</code><code>    </code><code class="n">price</code><code class="p">:</code><code> </code><code class="n">Decimal</code><code>
</code><code>    </code><code class="n">description</code><code class="p">:</code><code> </code><code class="n">Optional</code><code class="p">[</code><code class="nb">str</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><strong><code class="kc">None</code></strong><code>
</code><code>    </code><code class="n">tax</code><code class="p">:</code><code> </code><code class="n">Optional</code><code class="p">[</code><code class="n">Decimal</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><strong><code class="kc">None</code></strong><code>
</code><code>
</code><strong><code class="k">class</code></strong><code> </code><code class="nc">MItem</code><code class="p">(</code><code class="n">Document</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="s2">"</code><code class="s2">mongoengine document.</code><code class="s2">"</code><code>
</code><code>    </code><code class="n">name</code><code> </code><code class="o">=</code><code> </code><code class="n">StringField</code><code class="p">(</code><code class="n">primary_key</code><code class="o">=</code><strong><code class="kc">True</code></strong><code class="p">)</code><code>
</code><code>    </code><code class="n">price</code><code> </code><code class="o">=</code><code> </code><code class="n">DecimalField</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="n">description</code><code> </code><code class="o">=</code><code> </code><code class="n">StringField</code><code class="p">(</code><code class="n">required</code><code class="o">=</code><strong><code class="kc">False</code></strong><code class="p">)</code><code>
</code><code>    </code><code class="n">tax</code><code> </code><code class="o">=</code><code> </code><code class="n">DecimalField</code><code class="p">(</code><code class="n">required</code><code class="o">=</code><strong><code class="kc">False</code></strong><code class="p">)</code></pre>
</div>
<p>Suppose you wanted to accept such data through a web form or as JSON, and be able to retrieve the data as JSON or display it in HTML. The skeletal <a data-type="xref" href="#example_twozero_threedot_serverdotpy_fa">Example 20-3</a> (offering no facilities to maintain existing data) shows you how you might do this with FastAPI. This example uses the Uvicorn HTTP server, but makes no attempt to explicitly use Python’s async features. As with Flask, the program begins by creating an application object <span class="code">app</span>. This object has decorator methods for each HTTP method, but the <span class="code">app.route</span> decorator (while available) is eschewed in favor of <span class="code">app.get</span> for HTTP GET, <span class="code">app.post</span> for HTTP POST, and the like, and those determine which view function handles requests to the paths for different HTTP methods.</p>
<div class="pagebreak-before" data-type="example" id="example_twozero_threedot_serverdotpy_fa">
<h5 class="less_space"><span class="label">Example 20-3. </span>server.py: FastAPI sample code to accept and display item data</h5>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">from</code></strong><code> </code><code class="nn">decimal</code><code> </code><strong><code class="kn">import</code></strong><code> </code><code class="n">Decimal</code><code>
</code><strong><code class="kn">from</code></strong><code> </code><code class="nn">fastapi</code><code> </code><strong><code class="kn">import</code></strong><code> </code><code class="n">FastAPI</code><code class="p">,</code><code> </code><code class="n">Form</code><code>
</code><strong><code class="kn">from</code></strong><code> </code><code class="nn">fastapi</code><code class="nn">.</code><code class="nn">responses</code><code> </code><strong><code class="kn">import</code></strong><code> </code><code class="n">HTMLResponse</code><code class="p">,</code><code> </code><code class="n">FileResponse</code><code>
</code><strong><code class="kn">from</code></strong><code> </code><code class="nn">mongoengine</code><code> </code><strong><code class="kn">import</code></strong><code> </code><code class="n">connect</code><code>
</code><strong><code class="kn">from</code></strong><code> </code><code class="nn">mongoengine</code><code class="nn">.</code><code class="nn">errors</code><code> </code><strong><code class="kn">import</code></strong><code> </code><code class="n">NotUniqueError</code><code>
</code><strong><code class="kn">from</code></strong><code> </code><code class="nn">typing</code><code> </code><strong><code class="kn">import</code></strong><code> </code><code class="n">Optional</code><code>
</code><strong><code class="kn">import</code></strong><code> </code><code class="nn">json</code><code>
</code><strong><code class="kn">import</code></strong><code> </code><code class="nn">uvicorn</code><code>
</code><strong><code class="kn">from</code></strong><code> </code><code class="nn">models</code><code> </code><strong><code class="kn">import</code></strong><code> </code><code class="n">PItem</code><code class="p">,</code><code> </code><code class="n">MItem</code><code>
</code><code>
</code><code class="n">DATABASE_URI</code><code> </code><code class="o">=</code><code> </code><code class="s2">"</code><code class="s2">mongodb://localhost:27017</code><code class="s2">"</code><code>
</code><code class="n">db</code><code class="o">=</code><code class="n">DATABASE_URI</code><code class="o">+</code><code class="s2">"</code><code class="s2">/mydatabase</code><code class="s2">"</code><code>
</code><code class="n">connect</code><code class="p">(</code><code class="n">host</code><code class="o">=</code><code class="n">db</code><code class="p">)</code><code>
</code><code class="n">app</code><code> </code><code class="o">=</code><code> </code><code class="n">FastAPI</code><code class="p">(</code><code class="p">)</code><code>
</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">save</code><code class="p">(</code><code class="n">item</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><strong><code class="k">try</code></strong><code class="p">:</code><code>
</code><code>        </code><code class="k">return</code><code> </code><code class="n">item</code><code class="o">.</code><code class="n">save</code><code class="p">(</code><code class="n">force_insert</code><code class="o">=</code><strong><code class="kc">True</code></strong><code class="p">)</code><code>
</code><code>    </code><strong><code class="k">except</code></strong><code> </code><code class="n">NotUniqueError</code><code class="p">:</code><code>
</code><code>        </code><strong><code class="k">return</code></strong><code> </code><strong><code class="kc">None</code></strong><code>
</code><code>
</code><code class="nd">@app</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s1">'</code><code class="s1">/</code><code class="s1">'</code><code class="p">)</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">home_page</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="s2">"</code><code class="s2">View function to display a simple form.</code><code class="s2">"</code><code>
</code><code>    </code><strong><code class="k">return</code></strong><code> </code><code class="n">FileResponse</code><code class="p">(</code><code class="s2">"</code><code class="s2">index.xhtml</code><code class="s2">"</code><code class="p">)</code><code>
</code><code>
</code><code class="nd">@app</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"</code><code class="s2">/items/new/form/</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">response_class</code><code class="o">=</code><code class="n">HTMLResponse</code><code class="p">)</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">create_item_from_form</code><code class="p">(</code><code class="n">name</code><code class="p">:</code><code> </code><code class="nb">str</code><code class="o">=</code><code class="n">Form</code><code class="p">(</code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code class="p">)</code><code class="p">,</code><code>
</code><code>                          </code><code class="n">price</code><code class="p">:</code><code> </code><code class="n">Decimal</code><code class="o">=</code><code class="n">Form</code><code class="p">(</code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code class="p">)</code><code class="p">,</code><code>
</code><code>                          </code><code class="n">description</code><code class="p">:</code><code> </code><code class="n">Optional</code><code class="p">[</code><code class="nb">str</code><code class="p">]</code><code class="o">=</code><code class="n">Form</code><code class="p">(</code><code class="s2">"</code><code class="s2">"</code><code class="p">)</code><code class="p">,</code><code>
</code><code>                          </code><code class="n">tax</code><code class="p">:</code><code> </code><code class="n">Optional</code><code class="p">[</code><code class="n">Decimal</code><code class="p">]</code><code class="o">=</code><code class="n">Form</code><code class="p">(</code><code class="n">Decimal</code><code class="p">(</code><code class="s2">"</code><code class="s2">0.0</code><code class="s2">"</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="s2">"</code><code class="s2">View function to accept form data and create an item.</code><code class="s2">"</code><code>
</code><code>    </code><code class="n">mongoitem</code><code> </code><code class="o">=</code><code> </code><code class="n">MItem</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="n">name</code><code class="p">,</code><code> </code><code class="n">price</code><code class="o">=</code><code class="n">price</code><code class="p">,</code><code> </code><code class="n">description</code><code class="o">=</code><code class="n">description</code><code class="p">,</code><code> </code><code>
</code><code>                      </code><code class="n">tax</code><code class="o">=</code><code class="n">tax</code><code class="p">)</code><code>
</code><code>    </code><code class="n">value</code><code> </code><code class="o">=</code><code> </code><code class="n">save</code><code class="p">(</code><code class="n">mongoitem</code><code class="p">)</code><code>
</code><code>    </code><strong><code class="k">if</code></strong><code> </code><code class="n">value</code><code class="p">:</code><code>
</code><code>        </code><code class="n">body</code><code> </code><code class="o">=</code><code> </code><code class="sa">f</code><code class="s2">"</code><code class="s2">Item(</code><code class="si">{</code><code class="n">name</code><code class="si">!r}</code><code class="s2">, </code><code class="si">{</code><code class="n">price</code><code class="si">!r}</code><code class="s2">, </code><code class="si">{</code><code class="n">description</code><code class="si">!r}</code><code class="s2">, </code><code class="si">{</code><code class="n">tax</code><code class="si">!r}</code><code class="s2">)</code><code class="s2">"</code><code>
</code><code>    </code><strong><code class="k">else</code></strong><code class="p">:</code><code>
</code><code>        </code><code class="n">body</code><code> </code><code class="o">=</code><code> </code><code class="sa">f</code><code class="s2">"</code><code class="s2">Item </code><code class="si">{</code><code class="n">name</code><code class="si">!r}</code><code class="s2"> already present.</code><code class="s2">"</code><code>
</code><code>    </code><strong><code class="k">return</code></strong><code> </code><code class="sa">f</code><code class="s2">"""</code><code class="s2">&lt;html&gt;&lt;body&gt;&lt;h2&gt;</code><code class="si">{</code><code class="n">body</code><code class="si">}</code><code class="s2">&lt;/h2&gt;&lt;/body&gt;&lt;/html&gt;</code><code class="s2">"""</code><code>
</code><code>
</code><code class="nd">@app</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"</code><code class="s2">/items/new/</code><code class="s2">"</code><code class="p">)</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">create_item_from_json</code><code class="p">(</code><code class="n">item</code><code class="p">:</code><code> </code><code class="n">PItem</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="s2">"</code><code class="s2">View function to accept JSON data and create an item.</code><code class="s2">"</code><code>
</code><code>    </code><code class="n">mongoitem</code><code> </code><code class="o">=</code><code> </code><code class="n">MItem</code><code class="p">(</code><code class="o">*</code><code class="o">*</code><code class="n">item</code><code class="o">.</code><code class="n">dict</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>
</code><code>    </code><code class="n">value</code><code> </code><code class="o">=</code><code> </code><code class="n">save</code><code class="p">(</code><code class="n">mongoitem</code><code class="p">)</code><code>
</code><code>    </code><strong><code class="k">if</code></strong><code> </code><strong><code class="ow">not</code></strong><code> </code><code class="n">value</code><code class="p">:</code><code>
</code><code>        </code><strong><code class="k">return</code></strong><code> </code><code class="sa">f</code><code class="s2">"</code><code class="s2">Primary key </code><code class="si">{</code><code class="n">item</code><code class="o">.</code><code class="n">name</code><code class="si">!r}</code><code class="s2"> already present</code><code class="s2">"</code><code>
</code><code>    </code><strong><code class="k">return</code></strong><code> </code><code class="n">item</code><code class="o">.</code><code class="n">dict</code><code class="p">(</code><code class="p">)</code><code>
</code><code>
</code><code class="nd">@app</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"</code><code class="s2">/items/</code><code class="si">{name}</code><code class="s2">/</code><code class="s2">"</code><code class="p">)</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">retrieve_item</code><code class="p">(</code><code class="n">name</code><code class="p">:</code><code> </code><code class="nb">str</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="s2">"</code><code class="s2">View function to return the JSON contents of an item.</code><code class="s2">"</code><code>
</code><code>    </code><code class="n">m_item</code><code> </code><code class="o">=</code><code> </code><code class="n">MItem</code><code class="o">.</code><code class="n">objects</code><code class="p">(</code><code class="n">name</code><code class="o">=</code><code class="n">name</code><code class="p">)</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><strong><code class="k">return</code></strong><code> </code><code class="n">json</code><code class="o">.</code><code class="n">loads</code><code class="p">(</code><code class="n">m_item</code><code class="o">.</code><code class="n">to_json</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>
</code><code>
</code><strong><code class="k">if</code></strong><code> </code><code class="vm">__name__</code><code> </code><code class="o">==</code><code> </code><code class="s2">"</code><code class="s2">__main__</code><code class="s2">"</code><code class="p">:</code><code>
</code><code>    </code><code class="c1"># host as "localhost" or "127.0.0.1" allows only local apps to access the</code><code>
</code><code>    </code><code class="c1"># web page. Using "0.0.0.0" will accept access from apps on other hosts,</code><code>
</code><code>    </code><code class="c1"># but this can raise security concerns, and is generally not recommended.</code><code>
</code><code>    </code><code class="n">uvicorn</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="s2">"</code><code class="s2">__main__:app</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">host</code><code class="o">=</code><code class="s2">"</code><code class="s2">127.0.0.1</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">port</code><code class="o">=</code><code class="mi">8000</code><code class="p">,</code><code> </code><code class="n">reload</code><code class="o">=</code><code class="kc">True</code><code class="p">)</code></pre>
</div>
<p>The <span class="code">home_page</span> function, which takes no arguments, simply renders a minimal HTML home page containing a form from the <em>index.xhtml</em> file, shown in <a data-type="xref" href="#example_twozero_fourdot_the_indexdothtm">Example 20-4</a>. The form posts to the <em>/items/new/form/</em> endpoint, which triggers a call to the <span class="code">create_item_from_form</span> function, which is declared in the routing decorator as producing an HTML response rather than the default JSON.</p>
<div data-type="example" id="example_twozero_fourdot_the_indexdothtm">
<h5><span class="label">Example 20-4. </span>The index.xhtml file</h5>
<pre data-code-language="html" data-type="programlisting">
<code class="cp">&lt;!DOCTYPE html&gt;</code>
<code class="p">&lt;</code><code class="nt">html</code> <code class="na">lang</code><code class="o">=</code><code class="s">"en"</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">h2</code><code class="p">&gt;</code>FastAPI Demonstrator<code class="p">&lt;/</code><code class="nt">h2</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">form</code> <code class="na">method</code><code class="o">=</code><code class="s">"POST"</code> <code class="na">action</code><code class="o">=</code><code class="s">"/items/new/form/"</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">table</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">tr</code><code class="p">&gt;&lt;</code><code class="nt">td</code><code class="p">&gt;</code>Name<code class="p">&lt;/</code><code class="nt">td</code><code class="p">&gt;&lt;</code><code class="nt">td</code><code class="p">&gt;&lt;</code><code class="nt">input</code> <code class="na">name</code><code class="o">=</code><code class="s">"name"</code><code class="p">&gt;&lt;/</code><code class="nt">td</code><code class="p">&gt;&lt;/</code><code class="nt">tr</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">tr</code><code class="p">&gt;&lt;</code><code class="nt">td</code><code class="p">&gt;</code>Price<code class="p">&lt;/</code><code class="nt">td</code><code class="p">&gt;&lt;</code><code class="nt">td</code><code class="p">&gt;&lt;</code><code class="nt">input</code> <code class="na">name</code><code class="o">=</code><code class="s">"price"</code><code class="p">&gt;&lt;/</code><code class="nt">td</code><code class="p">&gt;&lt;/</code><code class="nt">tr</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">tr</code><code class="p">&gt;&lt;</code><code class="nt">td</code><code class="p">&gt;</code>Description<code class="p">&lt;/</code><code class="nt">td</code><code class="p">&gt;&lt;</code><code class="nt">td</code><code class="p">&gt;&lt;</code><code class="nt">input</code> <code class="na">name</code><code class="o">=</code><code class="s">"description"</code><code class="p">&gt;&lt;/</code><code class="nt">td</code><code class="p">&gt;&lt;/</code><code class="nt">tr</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">tr</code><code class="p">&gt;&lt;</code><code class="nt">td</code><code class="p">&gt;</code>Tax<code class="p">&lt;/</code><code class="nt">td</code><code class="p">&gt;&lt;</code><code class="nt">td</code><code class="p">&gt;&lt;</code><code class="nt">input</code> <code class="na">name</code><code class="o">=</code><code class="s">"tax"</code><code class="p">&gt;&lt;/</code><code class="nt">td</code><code class="p">&gt;&lt;/</code><code class="nt">tr</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">tr</code><code class="p">&gt;&lt;</code><code class="nt">td</code><code class="p">&gt;&lt;/</code><code class="nt">td</code><code class="p">&gt;&lt;</code><code class="nt">td</code><code class="p">&gt;&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"submit"</code><code class="p">&gt;&lt;/</code><code class="nt">td</code><code class="p">&gt;&lt;/</code><code class="nt">tr</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">table</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">form</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">html</code><code class="p">&gt;</code></pre>
</div>
<p>The form, shown in <a data-type="xref" href="#input_form_for_fastapi_demonstrator">Figure 20-1</a>, is handled by the <span class="code">create_item_from_form</span> function, whose signature takes an argument for each form field, with annotations defining each as a form field. Note that the signature defines its own default values for <span class="code">description</span> and <span class="code">tax</span>. The function creates an <span class="code">MItem</span> object from the form data and tries to save it in the database. The <span class="code">save</span> function forces insertions, inhibiting the update of an existing record, and reports failure by returning <span class="code"><strong>None</strong></span>; the return value is used to formulate a simple HTML reply. In a production application, a templating engine such as Jinja would typically be used to render the response.</p>
<figure><div class="figure" id="input_form_for_fastapi_demonstrator"><img alt="Input form for FastAPI Demonstrator" height="280" src="assets/pns4_2001.png" width="392"/>
<h6><span class="label">Figure 20-1. </span>Input form for FastAPI Demonstrator</h6>
</div></figure>
<p>The <span class="code">create_item_from_json</span> function, routed from the <em>/items/new/</em> endpoint, takes JSON input from a POST request. Its signature accepts a <span class="code">pydantic</span> record, so in this case, FastAPI will use <span class="code">pydantic</span>’s validation to determine whether the input is acceptable. The function returns a Python dictionary, which FastAPI automatically converts to a JSON response. This can easily be tested with a simple client, shown in <a data-type="xref" href="#example_twozero_fivedot_fastapi_test_cl">Example 20-5</a>.</p>
<div data-type="example" id="example_twozero_fivedot_fastapi_test_cl">
<h5><span class="label">Example 20-5. </span>FastAPI test client</h5>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">requests</code><code class="o">,</code><code> </code><code class="nn">json</code><code>
</code><code>
</code><code class="n">result</code><code> </code><code class="o">=</code><code> </code><code class="n">requests</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s1">'</code><code class="s1">http://localhost:8000/items/new/</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>                       </code><code class="n">json</code><code class="o">=</code><code class="p">{</code><code class="s2">"</code><code class="s2">name</code><code class="s2">"</code><code class="p">:</code><code> </code><code class="s2">"</code><code class="s2">Item1</code><code class="s2">"</code><code class="p">,</code><code>
</code><code>                             </code><code class="s2">"</code><code class="s2">price</code><code class="s2">"</code><code class="p">:</code><code> </code><code class="mf">12.34</code><code class="p">,</code><code>
</code><code>                             </code><code class="s2">"</code><code class="s2">description</code><code class="s2">"</code><code class="p">:</code><code> </code><code class="s2">"</code><code class="s2">Rusty old bucket</code><code class="s2">"</code><code class="p">}</code><code class="p">)</code><code>
</code><code class="nb">print</code><code class="p">(</code><code class="n">result</code><code class="o">.</code><code class="n">status_code</code><code class="p">,</code><code> </code><code class="n">result</code><code class="o">.</code><code class="n">json</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>
</code><code class="n">result</code><code> </code><code class="o">=</code><code> </code><code class="n">requests</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s1">'</code><code class="s1">http://localhost:8000/items/Item1/</code><code class="s1">'</code><code class="p">)</code><code>
</code><code class="nb">print</code><code class="p">(</code><code class="n">result</code><code class="o">.</code><code class="n">status_code</code><code class="p">,</code><code> </code><code class="n">result</code><code class="o">.</code><code class="n">json</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>
</code><code class="n">result</code><code> </code><code class="o">=</code><code> </code><code class="n">requests</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s1">'</code><code class="s1">http://localhost:8000/items/new/</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>                       </code><code class="n">json</code><code class="o">=</code><code class="p">{</code><code class="s2">"</code><code class="s2">name</code><code class="s2">"</code><code class="p">:</code><code> </code><code class="s2">"</code><code class="s2">Item2</code><code class="s2">"</code><code class="p">,</code><code>
</code><code>                             </code><code class="s2">"</code><code class="s2">price</code><code class="s2">"</code><code class="p">:</code><code> </code><code class="s2">"</code><code class="s2">Not a number</code><code class="s2">"</code><code class="p">}</code><code class="p">)</code><code>
</code><code class="nb">print</code><code class="p">(</code><code class="n">result</code><code class="o">.</code><code class="n">status_code</code><code class="p">,</code><code> </code><code class="n">result</code><code class="o">.</code><code class="n">json</code><code class="p">(</code><code class="p">)</code><code class="p">)</code></pre>
</div>
<p>The results of running this program are as follows:</p>
<pre data-type="programlisting">
<strong>200 {'name': 'Item1', 'price': 12.34, 'description': 'Rusty old</strong>
<strong>bucket'&gt; 'tax': None}</strong>
<strong>200 {'_id': 'Item1', 'price': 12.34, 'description': 'Rusty old bucket'}</strong>
<strong>422 {'detail': [{'loc': ['body', 'price'], 'msg': 'value is not a valid</strong>
<strong>decimal', 'type': 'type_error.decimal'}]}</strong></pre>
<p class="pagebreak-before">The first POST request to <em>/items/new/</em> sees the server returning the same data it was presented with, confirming that it has been saved in the database. Note that the <span class="code">tax</span> field was not supplied, so the <span class="code">pydantic</span> default value is used here. The second line shows the output from retrieving the newly stored item (<span class="code">mongoengine</span> identifies the primary key using the name <span class="code">_id</span>). The third line shows an error message, generated by the attempt to store a nonnumeric value in the <span class="code">price</span> field.</p>
<p>Finally, the <span class="code">retrieve_item</span> view function, routed from URLs such as <em>/items/Item1/</em>, extracts the key as the second path element and returns the JSON representation of the given item. It looks up the given key in <span class="code">mongoengine</span> and converts the returned record to a dictionary that is rendered as JSON by FastAPI.<a contenteditable="false" data-primary="" data-startref="WPSSpwebframe20" data-type="indexterm" id="idm44924486087264"/><a contenteditable="false" data-primary="" data-startref="lightframe20" data-type="indexterm" id="idm44924486085888"/><a contenteditable="false" data-primary="" data-startref="fastapi20" data-type="indexterm" id="idm44924486059584"/></p>
</div></section>
</div></section>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="ch01fn151"><sup><a href="ch20.xhtml#ch01fn151-marker">1</a></sup> One historical legacy is that, in CGI, a server provided the CGI script with information about the HTTP request to be served mostly via the operating system’s environment (in Python, that’s <span class="code">os.environ</span>); to this day, interfaces between web servers and application frameworks rely on “an environment” that’s essentially a dictionary and generalizes and speeds up the same fundamental idea.</p><p data-type="footnote" id="ch01fn152"><sup><a href="ch20.xhtml#ch01fn152-marker">2</a></sup> More <a href="https://oreil.ly/tAyoT">advanced versions of HTTP exist</a>, but we do not cover them in this book.</p><p data-type="footnote" id="ch01fn153"><sup><a href="ch20.xhtml#ch01fn153-marker">3</a></sup> Please don’t. As Titus Brown once pointed out, Python is (in)famous for having more web frameworks than keywords. One of this book’s authors once showed Guido how to easily fix that problem when he was first designing Python 3—just add a few hundred new keywords—but, for some reason, Guido was not very receptive to this suggestion.</p><p data-type="footnote" id="ch01fn154"><sup><a href="ch20.xhtml#ch01fn154-marker">4</a></sup> Installing uWSGI on Windows currently requires compiling it with Cygwin.</p><p data-type="footnote" id="ch01fn155"><sup><a href="ch20.xhtml#ch01fn155-marker">5</a></sup> Since Python has fewer than 40 keywords, you can see why Titus Brown once pointed out that Python has more web frameworks than keywords.</p></div></div></section></div></body></html>