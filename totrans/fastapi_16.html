<html><head></head><body><section data-pdf-bookmark="Chapter 13. Production" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch13">&#13;
<h1><span class="label">Chapter 13. </span>Production</h1>&#13;
&#13;
<blockquote>&#13;
<p>If <a data-primary="Weinberg, Gerald" data-type="indexterm" id="id814"/>builders built buildings the way programmers wrote programs,&#13;
the first woodpecker that came along would destroy civilization.</p>&#13;
<p data-type="attribution">Gerald Weinberg, <cite>computer scientist</cite></p>&#13;
</blockquote>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Preview" data-type="sect1"><div class="sect1" id="id116">&#13;
<h1>Preview</h1>&#13;
&#13;
<p>You<a data-primary="production" data-type="indexterm" id="icd103"/> have an application running on your local machine,&#13;
and now you’d like to share it.&#13;
This chapter presents many scenarios on how to move your application to production,&#13;
and keep it running correctly and efficiently.&#13;
Because some of the details can be <em>very</em> detailed,&#13;
in some cases I’ll refer to helpful external documents&#13;
rather than stuffing them in here.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Deployment" data-type="sect1"><div class="sect1" id="id117">&#13;
<h1>Deployment</h1>&#13;
&#13;
<p>All<a data-primary="production" data-secondary="deployment" data-type="indexterm" id="icd104"/> the<a data-primary="deployment" data-type="indexterm" id="icd105"/> code examples in this book so far have used a single instance of <code>uvicorn</code>&#13;
running on <code>localhost</code>, port <code>8000</code>.&#13;
To handle lots of traffic, you want multiple servers,&#13;
running&#13;
on the multiple cores that modern hardware provides.&#13;
You’ll also need something above these servers to do the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Keep them running (a <em>supervisor</em>)</p>&#13;
</li>&#13;
<li>&#13;
<p>Gather and feed external requests (a <em>reverse proxy</em>)</p>&#13;
</li>&#13;
<li>&#13;
<p>Return responses</p>&#13;
</li>&#13;
<li>&#13;
<p>Provide HTTPS <em>termination</em> (SSL decryption)</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Multiple Workers" data-type="sect2"><div class="sect2" id="id118">&#13;
<h2>Multiple Workers</h2>&#13;
&#13;
<p>You’ve<a data-primary="deployment" data-secondary="multiple workers" data-type="indexterm" id="id815"/> probably seen another Python server called&#13;
<a href="https://gunicorn.org">Gunicorn</a>.<a data-primary="Gunicorn" data-type="indexterm" id="id816"/>&#13;
This can supervise multiple workers,&#13;
but it’s a WSGI server, and FastAPI is based on ASGI.&#13;
Luckily, there’s a special Uvicorn worker class&#13;
that can be managed by <span class="keep-together">Gunicorn</span>.</p>&#13;
&#13;
<p><a data-type="xref" href="#ex-13-1">Example 13-1</a> sets up these Uvicorn workers&#13;
on <code>localhost</code>, port <code>8000</code>&#13;
(this is adapted from the&#13;
<a href="https://oreil.ly/Svdhx">official documentation</a>).&#13;
The quotes protect the shell from any special interpretation.</p>&#13;
<div data-type="example" id="ex-13-1">&#13;
<h5><span class="label">Example 13-1. </span>Use Gunicorn with Uvicorn workers</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>pip install "uvicorn[standard]" gunicorn</strong>&#13;
$ <strong>gunicorn main:app --workers 4 --worker-class \</strong>&#13;
<strong>uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000</strong></pre></div>&#13;
&#13;
<p>You’ll see many lines as Gunicorn does your bidding.&#13;
It will start a top-level Gunicorn process,&#13;
talking to four Uvicorn worker subprocesses,&#13;
all sharing port <code>8000</code> on <code>localhost</code> (<code>0.0.0.0</code>).&#13;
Change the host, port, or number of workers if you want something else.&#13;
The <code>main:app</code> refers to <em>main.py</em> and the FastAPI object&#13;
with the variable name <code>app</code>.&#13;
The Gunicorn&#13;
<a href="https://oreil.ly/TxYIy">docs</a> claim the following:</p>&#13;
<blockquote>Gunicorn should only need 4-12 worker processes to handle hundreds or thousands of requests per second.</blockquote>&#13;
&#13;
<p>It turns out that Uvicorn itself can&#13;
also fire up multiple Uvicorn workers, as in <a data-type="xref" href="#ex-13-2">Example 13-2</a>.</p>&#13;
<div data-type="example" id="ex-13-2">&#13;
<h5><span class="label">Example 13-2. </span>Use Uvicorn with Uvicorn workers</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>uvicorn main:app --host 0.0.0.0 --port 8000 --workers 4</strong></pre></div>&#13;
&#13;
<p>But this method doesn’t do process management,&#13;
so the gunicorn method is usually preferred.&#13;
Other process managers exist for Uvicorn:&#13;
see its <a href="https://www.uvicorn.org/deployment">official docs</a>.</p>&#13;
&#13;
<p>This handles three of the four jobs mentioned in the previous&#13;
section,&#13;
but not HTTPS encryption.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before less_space" data-pdf-bookmark="HTTPS" data-type="sect2"><div class="sect2" id="id119">&#13;
<h2>HTTPS</h2>&#13;
&#13;
<p>The <a data-primary="deployment" data-secondary="HTTPS" data-type="indexterm" id="id817"/>&#13;
official FastAPI&#13;
<a href="https://oreil.ly/HYRW7">HTTPS docs</a>,&#13;
like<a data-primary="HTTPS" data-type="indexterm" id="id818"/> all of the official <span class="keep-together">FastAPI</span> docs,&#13;
are extremely informative.&#13;
I recommend reading them,&#13;
followed by Ramírez’s<a data-primary="Ramírez, Sebastián" data-type="indexterm" id="id819"/>&#13;
<a href="https://oreil.ly/zcUWS">description</a>&#13;
of how to add HTTPS support to FastAPI&#13;
by using&#13;
<a href="https://traefik.io">Traefik</a>.<a data-primary="Traefik" data-type="indexterm" id="id820"/>&#13;
Traefik sits “above” your web servers,&#13;
similar to nginx&#13;
as a reverse proxy and load balancer,&#13;
but it includes that HTTPS magic.</p>&#13;
&#13;
<p>Although the process has many steps,&#13;
it’s still much simpler than it used to be.&#13;
In particular,&#13;
you used to regularly pay big bucks to a certificate authority&#13;
for a digital certificate that you could use to provide&#13;
HTTPS for your site.&#13;
Luckily, those authorities have been largely replaced by the free service&#13;
<a href="https://letsencrypt.org">Let’s Encrypt</a>.<a data-primary="Let's Encrypt" data-type="indexterm" id="id821"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Docker" data-type="sect2"><div class="sect2" id="id120">&#13;
<h2>Docker</h2>&#13;
&#13;
<p>When <a data-primary="deployment" data-secondary="Docker" data-type="indexterm" id="id822"/>Docker<a data-primary="Docker" data-type="indexterm" id="id823"/> burst on the scene&#13;
(in a five-minute&#13;
<a href="https://oreil.ly/25oef">lightning talk</a>&#13;
by Solomon Hykes<a data-primary="Hykes, Solomon" data-type="indexterm" id="id824"/> of dotCloud&#13;
at PyCon 2013),&#13;
it was the first time most of us had ever heard of&#13;
Linux containers.&#13;
Over time, we learned that Docker was faster and lighter&#13;
than virtual machines.&#13;
Instead of emulating a full operating system,&#13;
each container shared the server’s Linux kernel,&#13;
and isolated processes and networks into their own namespaces.&#13;
Suddenly,&#13;
by using the free Docker software, you could host multiple&#13;
independent services on a single machine,&#13;
without worrying about them stepping all over one another.</p>&#13;
&#13;
<p>Ten years later, Docker is universally recognized and supported.&#13;
If you want to host your FastAPI application on a cloud service,&#13;
you’ll usually need to create a <em>Docker image</em> of it first.&#13;
The&#13;
<a href="https://oreil.ly/QnwOW">official FastAPI docs</a>&#13;
include a thorough description of how to build&#13;
a Dockerized version of your FastAPI application.&#13;
One step is to write a <em>Dockerfile</em>:&#13;
a text file containing Docker configuration info,&#13;
like what application code to use and what processes to run.&#13;
Just to prove that this isn’t brain surgery during a rocket launch,&#13;
here’s the Dockerfile from that page:</p>&#13;
&#13;
<pre data-type="programlisting">FROM python:3.9&#13;
WORKDIR /code&#13;
COPY ./requirements.txt /code/requirements.txt&#13;
RUN pip install --no-cache-dir --upgrade -r /code/requirements.txt&#13;
COPY ./app /code/app&#13;
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "80"]</pre>&#13;
&#13;
<p>I recommend reading the official docs,&#13;
or other links that a Google search of <code>fastapi docker</code> will produce, such as <a href="https://oreil.ly/7TUpR">“The Ultimate FastAPI Tutorial Part 13—Using Docker to Deploy Your App”</a> by <a data-primary="Samiullah, Christopher" data-type="indexterm" id="id825"/>Christopher Samiullah.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before less_space" data-pdf-bookmark="Cloud Services" data-type="sect2"><div class="sect2" id="id121">&#13;
<h2>Cloud Services</h2>&#13;
&#13;
<p>Many <a data-primary="cloud services" data-type="indexterm" id="id826"/>sources<a data-primary="deployment" data-secondary="cloud services" data-type="indexterm" id="id827"/> of paid or free hosting are available on the Net.&#13;
Some walk-throughs on how to host FastAPI with them include the <a data-primary="Okada, Shinichi" data-type="indexterm" id="id828"/>following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://oreil.ly/DBZcm">“FastAPI—Deployment” by Tutorials Point</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/s8iar">“The Ultimate FastAPI Tutorial Part 6b—Basic Deployment on Linode” by Christopher Samiullah</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/A6gij">“How to Deploy a FastAPI App on Heroku for Free” by Shinichi Okada</a></p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Kubernetes" data-type="sect2"><div class="sect2" id="id122">&#13;
<h2>Kubernetes</h2>&#13;
&#13;
<p>Kubernetes<a data-primary="Kubernetes" data-type="indexterm" id="id829"/> grew<a data-primary="deployment" data-secondary="Kubernetes" data-type="indexterm" id="id830"/> from internal Google code for managing&#13;
internal systems that were becoming ever more godawfully complex.&#13;
System administrators (as they were called then) used to manually&#13;
configure tools like load balancers, reverse proxies,&#13;
humidors<sup><a data-type="noteref" href="ch13.html#id831" id="id831-marker">1</a></sup> and so on.&#13;
Kubernetes aimed to take much of this knowledge and automate it:&#13;
don’t tell me <em>how</em> to handle this; tell me what you <em>want</em>.&#13;
This included tasks like keeping a service running,&#13;
or firing up more servers if traffic spikes.</p>&#13;
&#13;
<p>There are many descriptions of how to deploy FastAPI&#13;
on Kubernetes, <a data-primary="deployment" data-startref="icd105" data-type="indexterm" id="id832"/><a data-primary="Mukhopadhyay, Sumanta" data-type="indexterm" id="id833"/>including<a data-primary="production" data-secondary="deployment" data-startref="icd104" data-type="indexterm" id="id834"/>&#13;
<a href="https://oreil.ly/ktTNu">“Deploying a FastAPI Application on Kubernetes” by Sumanta Mukhopadhyay</a>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Performance" data-type="sect1"><div class="sect1" id="performanceSect">&#13;
<h1>Performance</h1>&#13;
&#13;
<p>FastAPI’s<a data-primary="production" data-secondary="performance" data-type="indexterm" id="icd106"/> performance<a data-primary="performance" data-type="indexterm" id="icd107"/> is currently&#13;
<a href="https://oreil.ly/mxabf">among the highest</a>&#13;
of any Python web framework,&#13;
even comparable to frameworks in faster languages like Go.&#13;
But much of this is due to ASGI, avoiding I/O waiting with async.&#13;
Python itself is a relatively slow language.&#13;
The following are some&#13;
tips and tricks to improve overall performance.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Async" data-type="sect2"><div class="sect2" id="id124">&#13;
<h2>Async</h2>&#13;
&#13;
<p>Often<a data-primary="async keyword and function" data-type="indexterm" id="id835"/> a<a data-primary="performance" data-secondary="async function" data-type="indexterm" id="id836"/> web server doesn’t need to be really fast.&#13;
It spends much of its time getting HTTP network requests&#13;
and returning results (the Web layer in this book).&#13;
In between, a web service performs business logic (the Service layer)&#13;
and accesses data sources (the Data layer),&#13;
and again spends much of its time on network I/O.</p>&#13;
&#13;
<p>Whenever code in the web service has to wait for a response,&#13;
it’s a good candidate to use an async function&#13;
(<code>async def</code> rather than <code>def</code>).&#13;
This lets FastAPI and Starlette schedule the async function&#13;
and do other things while waiting for it to get its response.&#13;
This is one of the reasons FastAPI’s benchmarks are better than&#13;
WSGI-based frameworks like Flask and Django.</p>&#13;
&#13;
<p>Performance has two aspects:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>The time to handle a single request</p>&#13;
</li>&#13;
<li>&#13;
<p>The number of requests that can be handled at once</p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Caches" data-type="sect2"><div class="sect2" id="id125">&#13;
<h2>Caches</h2>&#13;
&#13;
<p>If<a data-primary="performance" data-secondary="caches" data-type="indexterm" id="id837"/> you<a data-primary="caches" data-type="indexterm" id="id838"/> have a web endpoint that ultimately gets data from&#13;
a static source (like a database record that changes rarely or never),&#13;
it’s possible to <em>cache</em> the data in a function.&#13;
This could be in any of the layers.&#13;
Python provides the standard&#13;
<a href="https://oreil.ly/8Kg4V">functools module</a><a data-primary="functools" data-type="indexterm" id="id839"/> and the functions <code>cache()</code> and <code>lru_cache()</code>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Databases, Files, and Memory" data-type="sect2"><div class="sect2" id="id126">&#13;
<h2>Databases, Files, and Memory</h2>&#13;
&#13;
<p>One <a data-primary="performance" data-secondary="databases" data-type="indexterm" id="id840"/>of<a data-primary="performance" data-secondary="files" data-type="indexterm" id="id841"/> the<a data-primary="performance" data-secondary="memory" data-type="indexterm" id="id842"/> most common causes of a slow website&#13;
is<a data-primary="databases" data-secondary="performance and" data-type="indexterm" id="id843"/> a <a data-primary="files" data-secondary="performance and" data-type="indexterm" id="id844"/>missing <a data-primary="memory and performance" data-type="indexterm" id="id845"/>index for a database table of sufficient size.&#13;
Often you won’t see the problem until your table has grown to&#13;
a particular size, and then queries suddenly become much slower.&#13;
In SQL, any column in a <code>WHERE</code> clause should be indexed.</p>&#13;
&#13;
<p>In many examples in this book, the primary key of the&#13;
<code>creature</code> and <code>explorer</code> tables has been the text field <code>name</code>.&#13;
When the tables were created, <code>name</code> was declared the&#13;
<code>primary key</code>.&#13;
For the tiny tables that you’ve seen so far in this book,&#13;
SQLite would ignore that key anyhow, since it’s faster&#13;
just to scan the table.&#13;
But once a table gets to a decent size—say a million rows—a missing index will make a noticeable difference.&#13;
The solution: run a <a href="https://oreil.ly/YPR3Q">query optimizer</a>.<a data-primary="query optimizers" data-type="indexterm" id="id846"/></p>&#13;
&#13;
<p>Even if you have a small table, you can do database&#13;
load testing with Python scripts or open source tools. If you’re making numerous sequential database queries, it may be possible to combine them in a single batch. If you’re uploading or downloading a large file,&#13;
use the streaming versions rather than a giant gulp.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Queues" data-type="sect2"><div class="sect2" id="id127">&#13;
<h2>Queues</h2>&#13;
&#13;
<p>If <a data-primary="performance" data-secondary="queues" data-type="indexterm" id="id847"/>you’re<a data-primary="queues" data-type="indexterm" id="id848"/> performing any task that takes longer than a fraction of&#13;
a second&#13;
(like sending a confirmation email or downsizing an image),&#13;
it may be worth handing it off to a job queue like&#13;
<a href="https://docs.celeryq.dev">Celery</a>.<a data-primary="Celery" data-type="indexterm" id="id849"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before less_space" data-pdf-bookmark="Python Itself" data-type="sect2"><div class="sect2" id="id128">&#13;
<h2>Python Itself</h2>&#13;
&#13;
<p>If<a data-primary="performance" data-secondary="Python and" data-type="indexterm" id="id850"/> your<a data-primary="Python" data-secondary="performance and" data-type="indexterm" id="id851"/> web service seems slow because&#13;
it does significant computing with Python,&#13;
you may want a “faster Python.”&#13;
Alternatives include the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Use <a href="https://www.pypy.org">PyPy</a> <a data-primary="PyPy" data-type="indexterm" id="id852"/>instead of the standard CPython.</p>&#13;
</li>&#13;
<li>&#13;
<p>Write a Python <a href="https://oreil.ly/BElJa">extension</a> in C, C++, or Rust.</p>&#13;
</li>&#13;
<li>&#13;
<p>Convert the slow Python code to <a href="https://cython.org">Cython</a>&#13;
(used by Pydantic and<a data-primary="Cython" data-type="indexterm" id="id853"/>&#13;
Uvicorn <span class="keep-together">themselves</span>).</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>A very intriguing recent announcement was the&#13;
<a href="https://oreil.ly/C96kx">Mojo language</a>.&#13;
It aims to be a complete superset of Python,&#13;
with new features (using the same friendly Python syntax)&#13;
that can speed up a Python example by <em>thousands</em> of times.&#13;
The main author, Chris Lattner<a data-primary="Lattner, Chris" data-type="indexterm" id="id854"/>, had previously worked on&#13;
compiler tools like&#13;
<a href="https://llvm.org">LLVM</a>,<a data-primary="LLVM" data-type="indexterm" id="id855"/>&#13;
<a href="https://clang.llvm.org">Clang</a>,<a data-primary="Clang" data-type="indexterm" id="id856"/>&#13;
and <a href="https://mlir.llvm.org">MLIR</a>,<a data-primary="MLIR" data-type="indexterm" id="id857"/>&#13;
plus the <a href="https://www.swift.org">Swift</a> language at Apple.<a data-primary="Swift" data-type="indexterm" id="id858"/></p>&#13;
&#13;
<p>Mojo aims to be a single-language solution to AI development,&#13;
which now (in PyTorch and TensorFlow)&#13;
requires Python/C/C++ sandwiches that are hard to develop,&#13;
manage, and debug.&#13;
But Mojo also would be a good general-purpose language&#13;
aside from AI.</p>&#13;
&#13;
<p>I coded in C for years and kept waiting for a successor&#13;
that was as performant but as easy to use as Python.&#13;
D, Go, Julia, Zig, and Rust were possibilities,&#13;
but if Mojo&#13;
can live up to its&#13;
<a href="https://oreil.ly/EojvA">goals</a>,&#13;
I would use Mojo<a data-primary="Mojo" data-type="indexterm" id="id859"/> <a data-primary="performance" data-startref="icd107" data-type="indexterm" id="id860"/>extensively<a data-primary="production" data-secondary="performance" data-startref="icd106" data-type="indexterm" id="id861"/>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Troubleshooting" data-type="sect1"><div class="sect1" id="troubleshooting">&#13;
<h1>Troubleshooting</h1>&#13;
&#13;
<p>Look<a data-primary="production" data-secondary="troubleshooting" data-type="indexterm" id="icd109"/> bottom-up&#13;
from <a data-primary="troubleshooting" data-type="indexterm" id="icd110"/>the time and place where you encounter a problem.&#13;
This includes time and space performance issues,&#13;
but also logic and async traps.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Kinds of Problems" data-type="sect2"><div class="sect2" id="id223">&#13;
<h2>Kinds of Problems</h2>&#13;
&#13;
<p>At <a data-primary="troubleshooting" data-secondary="HTTP response codes" data-type="indexterm" id="id862"/>a <a data-primary="HTTP responses" data-secondary="troubleshooting response codes" data-type="indexterm" id="id863"/>first glance, what HTTP response code did you get?</p>&#13;
<dl>&#13;
<dt><code>404</code></dt>&#13;
<dd>&#13;
<p>An authentication or authorization error.</p>&#13;
</dd>&#13;
<dt><code>422</code></dt>&#13;
<dd>&#13;
<p>Usually a Pydantic complaint about use of a model.</p>&#13;
</dd>&#13;
<dt><code>500</code></dt>&#13;
<dd>&#13;
<p>The failure of a service behind your FastAPI one.</p>&#13;
</dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Logging" data-type="sect2"><div class="sect2" id="id130">&#13;
<h2>Logging</h2>&#13;
&#13;
<p>Uvicorn <a data-primary="troubleshooting" data-secondary="logging" data-type="indexterm" id="id864"/>and <a data-primary="logging" data-type="indexterm" id="id865"/>other web servers typically write logs to stdout.&#13;
You can check the log to see what call was actually made,&#13;
including the HTTP verb and URL, but not data in the body, headers,&#13;
or cookies.</p>&#13;
&#13;
<p>If a particular endpoint returns a 400-level status code,&#13;
you can try feeding the same input back and see if the error&#13;
reoccurs.&#13;
If so, my first caveman debugging instinct is to add <code>print()</code>&#13;
statements in the relevant Web, Service, and Data functions.</p>&#13;
&#13;
<p>Also, wherever you raise an exception, add details.&#13;
If a database lookup fails,&#13;
include the input values and specific error, like an&#13;
attempt to double a unique key field.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Metrics" data-type="sect2"><div class="sect2" id="id131">&#13;
<h2>Metrics</h2>&#13;
&#13;
<p>The <a data-primary="troubleshooting" data-secondary="metrics" data-type="indexterm" id="id866"/>terms<a data-primary="metrics" data-type="indexterm" id="id867"/> <em>metrics</em>, <em>monitoring</em>, <em>observability</em>,&#13;
and <em>telemetry</em> may seem to overlap.&#13;
It’s common practice in Pythonland to use the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://prometheus.io">Prometheus</a> to gather metrics<a data-primary="Prometheus" data-type="indexterm" id="id868"/></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://grafana.com">Grafana</a> to display them<a data-primary="Grafana" data-type="indexterm" id="id869"/></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://opentelemetry.io">OpenTelemetry</a> to measure timing<a data-primary="OpenTelemetry" data-type="indexterm" id="id870"/></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>You can apply these to all your site’s layers:&#13;
Web, Service, and Data.&#13;
The Service ones may be more business-oriented,&#13;
and the others more technical,&#13;
and useful for site developers and maintainers.</p>&#13;
&#13;
<p>Here are some links to gather <a data-primary="troubleshooting" data-startref="icd110" data-type="indexterm" id="id871"/>FastAPI <a data-primary="production" data-secondary="troubleshooting" data-startref="icd109" data-type="indexterm" id="id872"/><a data-primary="Anand, Ankit" data-type="indexterm" id="id873"/>metrics:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://oreil.ly/EYJwR">Prometheus FastAPI Instrumentator</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/Gs90t">“Getting Started: Monitoring a FastAPI App with Grafana and Prometheus—A Step-by-Step Guide” by Zoo Codes</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/spKwe">“FastAPI Observability” page of Grafana Labs website</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/wDSNv">OpenTelemetry FastAPI Instrumentation</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/ZpSXs">“OpenTelemetry FastAPI Tutorial—Complete Implementation Guide” by Ankit Anand</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/nSD4G">OpenTelemetry Python documentation</a></p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Review" data-type="sect1"><div class="sect1" id="id132">&#13;
<h1>Review</h1>&#13;
&#13;
<p>It’s pretty clear that production is not easy.&#13;
Problems include the web machinery itself,&#13;
network and disk overloading,&#13;
and database problems.&#13;
This chapter offered hints on how to get the information you need,&#13;
and where to start digging when problems pop up<a data-primary="production" data-startref="icd103" data-type="indexterm" id="id874"/>.</p>&#13;
</div></section>&#13;
<div data-type="footnotes"><p data-type="footnote" id="id831"><sup><a href="ch13.html#id831-marker">1</a></sup> Wait, those keep cigars fresh.</p></div></div></section></body></html>