<html><head></head><body><section data-pdf-bookmark="Chapter 4. Useful Linux Utilities" data-type="chapter" epub:type="chapter"><div class="chapter" id="linux_utilities">&#13;
<h1><span class="label">Chapter 4. </span>Useful Linux Utilities</h1>&#13;
&#13;
&#13;
<p><a data-primary="Linux utilities" data-type="indexterm" id="ix_ch04-asciidoc0"/>The<a data-primary="Linux utilities" data-secondary="about" data-type="indexterm" id="idm46691335460216"/> command line and its tooling were one of the main reasons Alfredo felt attached to Linux servers when he started his career. One of his first jobs as a system administrator in a medium-sized company involved taking care of everything that was Linux-related. The small IT department was focused on the Windows servers and desktops, and they thoroughly disliked using the command line. At one point, the IT manager told him that he understood graphical user interfaces (GUIs), installing utilities, and tooling in general to solve problems: <em>“I am not a coder, if it doesn’t exist as a GUI, I can’t use it,”</em> he said.</p>&#13;
&#13;
<p>Alfredo was hired as a contractor to help out with the few Linux servers the company had. At the time, <a data-primary="Subversion (SVN)" data-type="indexterm" id="idm46691335457640"/><a data-primary="SVN (Subversion)" data-type="indexterm" id="idm46691335456936"/><a href="https://subversion.apache.org">Subversion (SVN) was all the rage for version control</a>, and the developers depended on this single SVN server to push their work. Instead of using the centralized identity server, provided by two <em>domain controllers</em>, it used a text-based authentication system that mapped a user to a hash representing the password. This meant that usernames didn’t necessarily map to those in the domain controller and that passwords could be anything. Often, a developer would ask to reset the password, and someone had to edit this text file with the hash. A project manager asked Alfredo to integrate the SVN authentication with the domain controller (Microsoft’s Active Directory). The first question he asked was why hadn’t the IT department done this already? <em>“They say it is not possible, but Alfredo, this is a lie, SVN can integrate with Active Directory.”</em></p>&#13;
&#13;
<p>He had never used an authentication service like Active Directory and barely understood SVN, but he was determined to make this work. Alfredo set out to read all about SVN and Active Directory, tinkered his way around a virtual machine with an SVN server running, and tried to get this authentication to work. It took about two weeks to read up on all the pieces involved and to get it to work. He succeeded in the end and was able to get this system into production. This felt incredibly powerful; he had acquired unique knowledge and was now ready to be fully in charge of this system. The IT manager, as well as the rest of the department, were ecstatic. Alfredo tried to share this newly acquired knowledge with others and was always met with an excuse: <em>“no time,”</em> <em>“too busy,”</em> <em>“other priorities,”</em> and <em>“perhaps some other time—maybe next week.”</em></p>&#13;
&#13;
<p>An apt description for technologists is: <em>knowledge workers</em>. Your curiosity and a never-ending pursuit of knowledge will continue to make you, and the environments you work on, much better. Don’t ever let a coworker (or a whole IT department, as in Alfredo’s case) be a deterrent for improving systems. If there is an opportunity to learn something new, jump on it! The worst that can happen is that you have acquired knowledge that perhaps won’t be used often, but on the other hand, might change your professional career.</p>&#13;
&#13;
<p>Linux does have desktop environments, but its real power comes from understanding and using the command line, and ultimately, by extending it. When there are no pre-made tools to solve a problem, seasoned DevOps people will craft their own. This notion of being able to come up with solutions by putting together the core pieces is incredibly powerful, and is what ultimately happened at that job where it felt productive to complete tasks without having to install off-the-shelf software to fix things.</p>&#13;
&#13;
<p>This chapter will go through some common patterns in the shell and will include some useful Python commands that should enhance the ability to interact with a machine. We find that creating aliases and <em>one-liners</em> is the most fun one can have at work, and sometimes they are so useful that they end up as plug-ins or standalone pieces of software.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Disk Utilities" data-type="sect1"><div class="sect1" id="idm46691335447816">&#13;
<h1>Disk Utilities</h1>&#13;
&#13;
<p><a data-primary="disk utilities" data-type="indexterm" id="ix_ch04-asciidoc1"/><a data-primary="Linux utilities" data-secondary="disk utilities" data-type="indexterm" id="ix_ch04-asciidoc2"/>There are several different utilities that you can use to get information about devices in a system. A lot of them have feature overlap, and some have an interactive session to deal with disk operations, such as <code>fdisk</code> and <code>parted</code>.</p>&#13;
&#13;
<p>It is <em>crucial</em> to have a good grasp on disk utilities, not only to retrieve information and manipulate partitions, but also to accurately measure performance. Performance, in particular, is one of the tough things to accomplish correctly. The best answer to the question <em>How do I measure the performance of a device?</em> is <em>It depends</em>, because it is difficult to do for the specific metric one is looking for.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Measuring Performance" data-type="sect2"><div class="sect2" id="idm46691335440872">&#13;
<h2>Measuring Performance</h2>&#13;
&#13;
<p><a data-primary="disk utilities" data-secondary="measuring performance" data-type="indexterm" id="ix_ch04-asciidoc3"/>If we had to work in an isolated environment with a server that doesn’t have access to the internet or that we don’t control and therefore can’t install packages, we would have to say that the <code>dd</code> tool (which should be readily available on all major Linux <span class="keep-together">distributions)</span> would help provide some answers. If at all possible, pair it with <code>iostat</code> to isolate the command that hammers the device versus the one that gets the report.</p>&#13;
&#13;
<p>As a seasoned performance engineer once said, it depends on what is measured and how. For example <code>dd</code> is single threaded and has limitations, such as being unable to do multiple random reads and writes; it also measures throughput and not input/output operations per second (IOPS). What are you measuring? Throughput or IOPS?</p>&#13;
<div data-type="caution"><h6>Caution</h6>&#13;
<p>A word of warning on these examples. They can destroy your system, don’t follow them blindly, and make sure to use devices that can get erased.</p>&#13;
</div>&#13;
&#13;
<p>This simple one-liner will run <code>dd</code> to get some numbers of a brand-new device (<em>/dev/sdc</em> in this case):</p>&#13;
&#13;
<pre data-type="programlisting">$ dd if=/dev/zero of=/dev/sdc count=10 bs=100M&#13;
10+0 records in&#13;
10+0 records out&#13;
1048576000 bytes (1.0 GB, 1000 MiB) copied, 1.01127 s, 1.0 GB/s</pre>&#13;
&#13;
<p>It writes 10 records of 100 megabytes at a rate of 1 GB/s. This is throughput. An easy way to get IOPS with <code>dd</code> is to use <a data-primary="iostat" data-type="indexterm" id="idm46691335430408"/><code>iostat</code>. In this example, <code>iostat</code> runs only on the device getting hammered with <code>dd</code>, with the <code>-d</code> flag only to give the device information, and with an interval of one second:</p>&#13;
&#13;
<pre data-type="programlisting">$ iostat -d /dev/sdc 1&#13;
&#13;
Device             tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn&#13;
sdc            6813.00         0.00   1498640.00          0    1498640&#13;
&#13;
Device             tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn&#13;
sdc            6711.00         0.00   1476420.00          0    1476420</pre>&#13;
&#13;
<p>The <code>iostat</code> output will repeat itself for every second until a <code>Ctrl-C</code> is issued to cancel the operation. The second column in the output is <code>tps</code>, which stands for transactions per second and is the same as IOPS. A nicer way to visualize the output, which avoids the clutter that a repeating command produces, is to clear the terminal on each run:</p>&#13;
&#13;
<pre data-type="programlisting">$ while true; do clear &amp;&amp; iostat -d /dev/sdc &amp;&amp; sleep 1; done</pre>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Accurate tests with fio" data-type="sect3"><div class="sect3" id="idm46691335424296">&#13;
<h3>Accurate tests with fio</h3>&#13;
&#13;
<p>If <code>dd</code> and <code>iostat</code> aren’t sufficient, the most commonly used tool for performance testing is <a data-primary="fio" data-type="indexterm" id="idm46691335407448"/><code>fio</code>. It can help clarify the performance behavior of a device in a read-heavy or write-heavy environment (and even adjust the percentages of reads versus writes).</p>&#13;
&#13;
<p>The output from <code>fio</code> is quite verbose. The example below trims it to emphasize the IOPS found on both read and write operations:</p>&#13;
&#13;
<pre data-type="programlisting">$ fio --name=sdc-performance --filename=/dev/sdc --ioengine=libaio \&#13;
  --iodepth=1 --rw=randrw --bs=32k --direct=0 --size=64m&#13;
sdc-performance: (g=0): rw=randwrite, bs=(R) 32.0KiB-32.0KiB,&#13;
(W) 32.0KiB-32.0KiB, (T) 32.0KiB-32.0KiB, ioengine=libaio, iodepth=1&#13;
fio-3.1&#13;
Starting 1 process&#13;
&#13;
sdc-performance: (groupid=0, jobs=1): err= 0: pid=2879:&#13;
   read: IOPS=1753, BW=54.8MiB/s (57.4MB/s)(31.1MiB/567msec)&#13;
...&#13;
   iops        : min= 1718, max= 1718, avg=1718.00, stdev= 0.00, samples=1&#13;
  write: IOPS=1858, BW=58.1MiB/s (60.9MB/s)(32.9MiB/567msec)&#13;
...&#13;
   iops        : min= 1824, max= 1824, avg=1824.00, stdev= 0.00, samples=1</pre>&#13;
&#13;
<p>The flags used in the example name the <em>job</em> <code>sdc-performance</code>, point to the <em>/dev/sdc</em> device directly (will require superuser permissions), use the native Linux asynchronous I/O library, set the <code>iodepth</code> to <code>1</code> (number of sequential I/O requests to be sent at a time), and define random read and write operations of 32 kilobytes for the buffer size using buffered I/O (can be set to 1 to use unbuffered I/O) on a 64-megabyte file. Quite the lengthy command here!</p>&#13;
&#13;
<p>The <code>fio</code> tool has a tremendous number of additional options that can help with most any case where accurate IOPS measurements are needed. For example, it can span the test across many devices at once, do some <em>I/O warm up</em>, and even set I/O thresholds for the test if a defined limit shouldn’t be surpassed. Finally, the many options in the command line can be configured with INI-style files so that the execution of jobs can be scripted nicely.<a data-startref="ix_ch04-asciidoc3" data-type="indexterm" id="idm46691335399000"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Partitions" data-type="sect2"><div class="sect2" id="idm46691335440248">&#13;
<h2>Partitions</h2>&#13;
&#13;
<p><a data-primary="disk utilities" data-secondary="partitions" data-type="indexterm" id="idm46691335397048"/><a data-primary="partitions" data-type="indexterm" id="idm46691335396072"/>We tend to default to <code>fdisk</code> with its interactive session to create partitions, but in some cases, <code>fdisk</code> doesn’t work well, such as with large partitions (two terabytes or larger). In those cases, your fallback should be to use <code>parted</code>.</p>&#13;
&#13;
<p>A quick interactive session shows how to create a primary partition with <code>fdisk</code>, with the default start value and four gibibytes of size. At the end the <code>w</code> key is sent to <em>write</em> the changes:</p>&#13;
&#13;
<pre data-type="programlisting">$ sudo fdisk /dev/sds&#13;
&#13;
Command (m for help): n&#13;
Partition type:&#13;
   p   primary (0 primary, 0 extended, 4 free)&#13;
   e   extended&#13;
Select (default p): p&#13;
Partition number (1-4, default 1):&#13;
First sector (2048-22527999, default 2048):&#13;
Using default value 2048&#13;
Last sector, +sectors or +size{K,M,G} (2048-22527999, default 22527999): +4G&#13;
Partition 1 of type Linux and of size 4 GiB is set&#13;
&#13;
Command (m for help): w&#13;
The partition table has been altered!&#13;
&#13;
Calling ioctl() to re-read partition table.&#13;
Syncing disks.</pre>&#13;
&#13;
<p><a data-primary="parted" data-type="indexterm" id="idm46691335390440"/><code>parted</code> accomplishes the same, but with a different interface:</p>&#13;
&#13;
<pre data-type="programlisting">$ sudo parted /dev/sdaa&#13;
GNU Parted 3.1&#13;
Using /dev/sdaa&#13;
Welcome to GNU Parted! Type 'help' to view a list of commands.&#13;
(parted) mklabel&#13;
New disk label type? gpt&#13;
(parted) mkpart&#13;
Partition name?  []?&#13;
File system type?  [ext2]?&#13;
Start? 0&#13;
End? 40%</pre>&#13;
&#13;
<p>In the end, you quit with the <code>q</code> key. For programmatic creation of partitions on the command line without any interactive prompts, you accomplish the same result with a couple of commands:</p>&#13;
&#13;
<pre data-type="programlisting">$ parted --script /dev/sdaa mklabel gpt&#13;
$ parted --script /dev/sdaa mkpart primary 1 40%&#13;
$ parted --script /dev/sdaa print&#13;
Disk /dev/sdaa: 11.5GB&#13;
Sector size (logical/physical): 512B/512B&#13;
Partition Table: gpt&#13;
Disk Flags:&#13;
&#13;
Number  Start   End     Size    File system  Name     Flags&#13;
 1      1049kB  4614MB  4613MB</pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Retrieving Specific Device Information" data-type="sect2"><div class="sect2" id="idm46691335386184">&#13;
<h2>Retrieving Specific Device Information</h2>&#13;
&#13;
<p><a data-primary="disk utilities" data-secondary="retrieving specific device information" data-type="indexterm" id="idm46691335384680"/>Sometimes when specific information for a device is needed, either <code>lsblk</code> or <code>blkid</code> are well suited. <code>fdisk</code> doesn’t like to work without superuser permissions. Here <a data-primary="fdisk" data-type="indexterm" id="idm46691335382104"/><code>fdisk</code> lists the information about the <em>/dev/sda</em> device:</p>&#13;
&#13;
<pre data-type="programlisting">$ fdisk -l /dev/sda&#13;
fdisk: cannot open /dev/sda: Permission denied&#13;
&#13;
$ sudo fdisk -l /dev/sda&#13;
&#13;
Disk /dev/sda: 42.9 GB, 42949672960 bytes, 83886080 sectors&#13;
Units = sectors of 1 * 512 = 512 bytes&#13;
Sector size (logical/physical): 512 bytes / 512 bytes&#13;
I/O size (minimum/optimal): 512 bytes / 512 bytes&#13;
Disk label type: dos&#13;
Disk identifier: 0x0009d9ce&#13;
&#13;
   Device Boot      Start         End      Blocks   Id  System&#13;
/dev/sda1   *        2048    83886079    41942016   83  Linux</pre>&#13;
&#13;
<p><a data-primary="blkid" data-type="indexterm" id="idm46691335379192"/><code>blkid</code> is a bit similar in that it wants superuser permissions as well:</p>&#13;
&#13;
<pre data-type="programlisting">$ blkid /dev/sda&#13;
&#13;
$ sudo blkid /dev/sda&#13;
/dev/sda: PTTYPE="dos"</pre>&#13;
&#13;
<p><a data-primary="lsblk" data-type="indexterm" id="idm46691335376936"/><code>lsblk</code> allows to get information without higher permissions, and provides the same informational output regardless:</p>&#13;
&#13;
<pre data-type="programlisting">$ lsblk /dev/sda&#13;
NAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINT&#13;
sda      8:0    0  40G  0 disk&#13;
└─sda1   8:1    0  40G  0 part /&#13;
$ sudo lsblk /dev/sda&#13;
NAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINT&#13;
sda      8:0    0  40G  0 disk&#13;
└─sda1   8:1    0  40G  0 part /</pre>&#13;
&#13;
<p>This command, which uses the <code>-p</code> flag for low-level device probing, is <em>very thorough</em> and should give you good enough information for a device:</p>&#13;
&#13;
<pre data-type="programlisting">$ blkid -p /dev/sda1&#13;
UUID="8e4622c4-1066-4ea8-ab6c-9a19f626755c" TYPE="xfs" USAGE="filesystem"&#13;
PART_ENTRY_SCHEME="dos" PART_ENTRY_TYPE="0x83" PART_ENTRY_FLAGS="0x80"&#13;
PART_ENTRY_NUMBER="1" PART_ENTRY_OFFSET="2048" PART_ENTRY_SIZE="83884032"</pre>&#13;
&#13;
<p><code>lsblk</code> has some default properties to look for:</p>&#13;
&#13;
<pre data-type="programlisting">$ lsblk -P /dev/nvme0n1p1&#13;
NAME="nvme0n1p1" MAJ:MIN="259:1" RM="0" SIZE="512M" RO="0" TYPE="part"</pre>&#13;
&#13;
<p>But it also allows you to set specific flags to request a particular property:</p>&#13;
&#13;
<pre data-type="programlisting">lsblk -P -o SIZE /dev/nvme0n1p1&#13;
SIZE="512M"</pre>&#13;
&#13;
<p>To access a property in this way makes it easy to script and even consume from the Python side of things.<a data-startref="ix_ch04-asciidoc2" data-type="indexterm" id="idm46691335369208"/><a data-startref="ix_ch04-asciidoc1" data-type="indexterm" id="idm46691335368504"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Network Utilities" data-type="sect1"><div class="sect1" id="idm46691335385592">&#13;
<h1>Network Utilities</h1>&#13;
&#13;
<p><a data-primary="Linux utilities" data-secondary="network utilities" data-type="indexterm" id="ix_ch04-asciidoc4"/><a data-primary="network utilities" data-type="indexterm" id="ix_ch04-asciidoc5"/>Network tooling keeps improving as more and more servers need to be interconnected. A lot of the utilities in this section cover useful one-liners like Secure Shell (SSH) tunneling, but some others go into the details of testing network performance, such as using the Apache Bench tool.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="SSH Tunneling" data-type="sect2"><div class="sect2" id="idm46691335363800">&#13;
<h2>SSH Tunneling</h2>&#13;
&#13;
<p><a data-primary="network utilities" data-secondary="SSH tunneling" data-type="indexterm" id="idm46691335362456"/><a data-primary="SSH tunneling" data-type="indexterm" id="idm46691335361480"/>Have you ever tried to reach an HTTP service that runs on a remote server that is not accessible except via SSH? This situation occurs when the HTTP service is enabled but not needed publicly. The last time we saw this happen was when a production instance of <a href="https://www.rabbitmq.com">RabbitMQ</a> had the management plug-in enabled, which starts an HTTP service on port 15672. The service isn’t exposed and with good reason; there is no need to have it publicly available since it is rarely used, and besides, one can use SSH’s tunneling capabilities.</p>&#13;
&#13;
<p>This works by creating an SSH connection with the remote server and then forwarding the remote port (15672, in my case) to a local port on the originating machine. The remote machine has a custom SSH port, which complicates the command slightly. This is is how it looks:</p>&#13;
&#13;
<pre data-type="programlisting">$ ssh -L 9998:localhost:15672 -p 2223 adeza@prod1.rabbitmq.ceph.internal -N</pre>&#13;
&#13;
<p>There are three flags, three numbers, and two addresses. Let’s dissect the command to make what is going on here much clearer. The <code>-L</code> flag is the one that signals that we want forwarding enabled and a local port (9998) to bind to a remote port (RabbitMQ’s default of 15672). Next, the <code>-p</code> flag indicates that the custom SSH port of the remote server is 2223, and then the username and address are specified. Lastly, the <code>-N</code> means that it shouldn’t get us to a remote shell and do the forwarding.</p>&#13;
&#13;
<p>When executed correctly, the command will appear to hang, but it allows you to go into <a href="http://localhost:9998/"><em class="hyperlink">http://localhost:9998/</em></a> and see the login page for the remote RabbitMQ instance. A useful flag to know when tunneling is <code>-f</code>: it will send the process into the background, which is helpful if this connection isn’t temporary, leaving the terminal ready and clean to do more work.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Benchmarking HTTP with Apache Benchmark (ab)" data-type="sect2"><div class="sect2" id="idm46691335353176">&#13;
<h2>Benchmarking HTTP with Apache Benchmark (ab)</h2>&#13;
&#13;
<p><a data-primary="ab (Apache Benchmark)" data-type="indexterm" id="ix_ch04-asciidoc6"/><a data-primary="Apache Benchmark (ab)" data-type="indexterm" id="ix_ch04-asciidoc7"/><a data-primary="benchmarking" data-type="indexterm" id="ix_ch04-asciidoc8"/><a data-primary="HTTP" data-secondary="benchmarking with Apache Benchmark" data-type="indexterm" id="ix_ch04-asciidoc9"/><a data-primary="network utilities" data-secondary="benchmarking HTTP with Apache Benchmark" data-type="indexterm" id="ix_ch04-asciidoc10"/>We <em>really</em> love to hammer servers we work with to ensure they handle load correctly, especially before they get promoted to production. Sometimes we even try to trigger some odd race condition that may happen under heavy load. The Apache Benchmark tool (<code>ab</code> in the command line) is one of those tiny tools that can get you going quickly with just a few flags.</p>&#13;
&#13;
<p>This command will create 100 requests at a time, for a total of 10,000 requests, to a local instance where Nginx is running:</p>&#13;
&#13;
<pre data-type="programlisting">$ ab -c 100 -n 10000 http://localhost/</pre>&#13;
&#13;
<p>That is pretty brutal to handle in a system, but this is a local server, and the requests are just an HTTP <code>GET</code>. The detailed output from <code>ab</code> is very comprehensive and looks like this (trimmed for brevity):</p>&#13;
&#13;
<pre data-type="programlisting">Benchmarking localhost (be patient)&#13;
...&#13;
Completed 10000 requests&#13;
Finished 10000 requests&#13;
&#13;
Server Software:        nginx/1.15.9&#13;
Server Hostname:        localhost&#13;
Server Port:            80&#13;
&#13;
Document Path:          /&#13;
Document Length:        612 bytes&#13;
&#13;
Concurrency Level:      100&#13;
Time taken for tests:   0.624 seconds&#13;
Complete requests:      10000&#13;
Failed requests:        0&#13;
Total transferred:      8540000 bytes&#13;
HTML transferred:       6120000 bytes&#13;
Requests per second:    16015.37 [#/sec] (mean)&#13;
Time per request:       6.244 [ms] (mean)&#13;
Time per request:       0.062 [ms] (mean, across all concurrent requests)&#13;
Transfer rate:          13356.57 [Kbytes/sec] received&#13;
&#13;
Connection Times (ms)&#13;
              min  mean[+/-sd] median   max&#13;
Connect:        0    3   0.6      3       5&#13;
Processing:     0    4   0.8      3       8&#13;
Waiting:        0    3   0.8      3       6&#13;
Total:          0    6   1.0      6       9</pre>&#13;
&#13;
<p>This type of information and how it is presented is tremendous. At a glance, you can quickly tell if a production server drops connections (in the <code>Failed requests</code> field) and what the averages are. A <code>GET</code> request is used, but <code>ab</code> allows you to use other HTTP verbs, such as <code>POST</code>, and even do a <code>HEAD</code> request. You need to exercise caution with this type of tool because it can easily overload a server. Below are more realistic numbers from an HTTP service in production (trimmed for brevity):</p>&#13;
&#13;
<pre data-type="programlisting">...&#13;
Benchmarking prod1.ceph.internal (be patient)&#13;
&#13;
Server Software:        nginx&#13;
Server Hostname:        prod1.ceph.internal&#13;
Server Port:            443&#13;
SSL/TLS Protocol:       TLSv1.2,ECDHE-RSA-AES256-GCM-SHA384,2048,256&#13;
Server Temp Key:        ECDH P-256 256 bits&#13;
TLS Server Name:        prod1.ceph.internal&#13;
&#13;
Complete requests:      200&#13;
Failed requests:        0&#13;
Total transferred:      212600 bytes&#13;
HTML transferred:       175000 bytes&#13;
Requests per second:    83.94 [#/sec] (mean)&#13;
Time per request:       1191.324 [ms] (mean)&#13;
Time per request:       11.913 [ms] (mean, across all concurrent requests)&#13;
Transfer rate:          87.14 [Kbytes/sec] received&#13;
....</pre>&#13;
&#13;
<p>Now the numbers look different, it hits a service with SSL enabled, and <code>ab</code> lists what the protocols are. At 83 requests per second, we think it could do better, but this is an API server that produces JSON, and it typically doesn’t get much load at once, as was just generated.<a data-startref="ix_ch04-asciidoc10" data-type="indexterm" id="idm46691335335336"/><a data-startref="ix_ch04-asciidoc9" data-type="indexterm" id="idm46691335334632"/><a data-startref="ix_ch04-asciidoc8" data-type="indexterm" id="idm46691335333960"/><a data-startref="ix_ch04-asciidoc7" data-type="indexterm" id="idm46691335333288"/><a data-startref="ix_ch04-asciidoc6" data-type="indexterm" id="idm46691335332616"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Load Testing with molotov" data-type="sect2"><div class="sect2" id="idm46691335331816">&#13;
<h2>Load Testing with molotov</h2>&#13;
&#13;
<p><a data-primary="load testing" data-type="indexterm" id="ix_ch04-asciidoc11"/><a data-primary="molotov, load testing with" data-type="indexterm" id="ix_ch04-asciidoc12"/><a data-primary="network utilities" data-secondary="load testing with molotov" data-type="indexterm" id="ix_ch04-asciidoc13"/>The <a href="https://molotov.readthedocs.io">Molotov</a> project is an interesting project geared towards load testing. Some of its features are similar to those of Apache Benchmark, but being a Python project, it provides a way to write scenarios with Python and the <code>asyncio</code> module.</p>&#13;
&#13;
<p>This is how the simplest example for <code>molotov</code> looks:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">molotov</code>&#13;
&#13;
<code class="nd">@molotov.scenario</code><code class="p">(</code><code class="mi">100</code><code class="p">)</code>&#13;
<code class="n">async</code> <code class="k">def</code> <code class="nf">scenario_one</code><code class="p">(</code><code class="n">session</code><code class="p">):</code>&#13;
    <code class="n">async</code> <code class="k">with</code> <code class="n">session</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"http://localhost:5000"</code><code class="p">)</code> <code class="k">as</code> <code class="n">resp</code><code class="p">:</code>&#13;
        <code class="k">assert</code> <code class="n">resp</code><code class="o">.</code><code class="n">status</code> <code class="o">==</code> <code class="mi">200</code></pre>&#13;
&#13;
<p>Save the file as <em>load_test.py</em>, create a small Flask application that handles both <code>POST</code> and <code>GET</code> requests at its main URL, and save it as <em>small.py</em>:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">flask</code> <code class="kn">import</code> <code class="n">Flask</code><code class="p">,</code> <code class="n">redirect</code><code class="p">,</code> <code class="n">request</code>&#13;
&#13;
<code class="n">app</code> <code class="o">=</code> <code class="n">Flask</code><code class="p">(</code><code class="s1">'basic app'</code><code class="p">)</code>&#13;
&#13;
<code class="nd">@app.route</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="n">methods</code><code class="o">=</code><code class="p">[</code><code class="s1">'GET'</code><code class="p">,</code> <code class="s1">'POST'</code><code class="p">])</code>&#13;
<code class="k">def</code> <code class="nf">index</code><code class="p">():</code>&#13;
    <code class="k">if</code> <code class="n">request</code><code class="o">.</code><code class="n">method</code> <code class="o">==</code> <code class="s1">'POST'</code><code class="p">:</code>&#13;
        <code class="n">redirect</code><code class="p">(</code><code class="s1">'https://www.google.com/search?q=</code><code class="si">%s</code><code class="s1">'</code> <code class="o">%</code> <code class="n">request</code><code class="o">.</code><code class="n">args</code><code class="p">[</code><code class="s1">'q'</code><code class="p">])</code>&#13;
    <code class="k">else</code><code class="p">:</code>&#13;
        <code class="k">return</code> <code class="s1">'&lt;h1&gt;GET request from Flask!&lt;/h1&gt;'</code></pre>&#13;
&#13;
<p>Start the Flask application with <code>FLASK_APP=small.py flask run</code>, and then run <code>molotov</code> with the <em>load_test.py</em> file created previously:</p>&#13;
&#13;
<pre data-type="programlisting">$ molotov -v -r 100 load_test.py&#13;
**** Molotov v1.6. Happy breaking! ****&#13;
Preparing 1 worker...&#13;
OK&#13;
SUCCESSES: 100 | FAILURES: 0 WORKERS: 0&#13;
*** Bye ***</pre>&#13;
&#13;
<p>One hundred requests on a single worker ran against the local Flask instance. The tool really shines when the load testing is extended to do more per request. It has concepts similar to unit testing, such as setup, teardown, and even code, that can react to certain events. Since the small Flask application can handle a <code>POST</code> that redirects to a Google search, add another scenario to the <em>load_test</em>.py_ file. This time change the weight so that 100% of the requests do a <code>POST</code>:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="nd">@molotov.scenario</code><code class="p">(</code><code class="mi">100</code><code class="p">)</code>&#13;
<code class="n">async</code> <code class="k">def</code> <code class="nf">scenario_post</code><code class="p">(</code><code class="n">session</code><code class="p">):</code>&#13;
    <code class="n">resp</code> <code class="o">=</code> <code class="n">await</code> <code class="n">session</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"http://localhost:5000"</code><code class="p">,</code> <code class="n">params</code><code class="o">=</code><code class="p">{</code><code class="s1">'q'</code><code class="p">:</code> <code class="s1">'devops'</code><code class="p">})</code>&#13;
    <code class="n">redirect_status</code> <code class="o">=</code> <code class="n">resp</code><code class="o">.</code><code class="n">history</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="o">.</code><code class="n">status</code>&#13;
    <code class="n">error</code> <code class="o">=</code> <code class="s2">"unexpected redirect status: </code><code class="si">%s</code><code class="s2">"</code> <code class="o">%</code> <code class="n">redirect_status</code>&#13;
    <code class="k">assert</code> <code class="n">redirect_status</code> <code class="o">==</code> <code class="mi">301</code><code class="p">,</code> <code class="n">error</code></pre>&#13;
&#13;
<p>Run this new scenario for a single request to show the following:</p>&#13;
&#13;
<pre data-type="programlisting">$ molotov -v -r 1 --processes 1 load_test.py&#13;
**** Molotov v1.6. Happy breaking! ****&#13;
Preparing 1 worker...&#13;
OK&#13;
AssertionError('unexpected redirect status: 302',)&#13;
  File ".venv/lib/python3.6/site-packages/molotov/worker.py", line 206, in step&#13;
    **scenario['kw'])&#13;
  File "load_test.py", line 12, in scenario_two&#13;
    assert redirect_status == 301, error&#13;
SUCCESSES: 0 | FAILURES: 1&#13;
*** Bye ***</pre>&#13;
&#13;
<p>A single request (with <code>-r 1</code>) was enough to make this fail. The assertion needs to be updated to check for a <code>302</code> instead of a <code>301</code>. Once that status is updated, change the weight of the <code>POST</code> scenario to <code>80</code> so that other requests (with a <code>GET</code>) are sent to the Flask application. This is how the file looks in the end:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">molotov</code>&#13;
&#13;
<code class="nd">@molotov.scenario</code><code class="p">()</code>&#13;
<code class="n">async</code> <code class="k">def</code> <code class="nf">scenario_one</code><code class="p">(</code><code class="n">session</code><code class="p">):</code>&#13;
    <code class="n">async</code> <code class="k">with</code> <code class="n">session</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"http://localhost:5000/"</code><code class="p">)</code> <code class="k">as</code> <code class="n">resp</code><code class="p">:</code>&#13;
        <code class="k">assert</code> <code class="n">resp</code><code class="o">.</code><code class="n">status</code> <code class="o">==</code> <code class="mi">200</code>&#13;
&#13;
<code class="nd">@molotov.scenario</code><code class="p">(</code><code class="mi">80</code><code class="p">)</code>&#13;
<code class="n">async</code> <code class="k">def</code> <code class="nf">scenario_two</code><code class="p">(</code><code class="n">session</code><code class="p">):</code>&#13;
    <code class="n">resp</code> <code class="o">=</code> <code class="n">await</code> <code class="n">session</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"http://localhost:5000"</code><code class="p">,</code> <code class="n">params</code><code class="o">=</code><code class="p">{</code><code class="s1">'q'</code><code class="p">:</code> <code class="s1">'devops'</code><code class="p">})</code>&#13;
    <code class="n">redirect_status</code> <code class="o">=</code> <code class="n">resp</code><code class="o">.</code><code class="n">history</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="o">.</code><code class="n">status</code>&#13;
    <code class="n">error</code> <code class="o">=</code> <code class="s2">"unexpected redirect status: </code><code class="si">%s</code><code class="s2">"</code> <code class="o">%</code> <code class="n">redirect_status</code>&#13;
    <code class="k">assert</code> <code class="n">redirect_status</code> <code class="o">==</code> <code class="mi">301</code><code class="p">,</code> <code class="n">error</code></pre>&#13;
&#13;
<p>Run <em>load_test.py</em> for 10 requests to distribute the requests, two for a <code>GET</code> and the rest with a <code>POST</code>:</p>&#13;
&#13;
<pre data-type="programlisting">127.0.0.1 - - [04/Sep/2019 12:10:54] "POST /?q=devops HTTP/1.1" 302 -&#13;
127.0.0.1 - - [04/Sep/2019 12:10:56] "POST /?q=devops HTTP/1.1" 302 -&#13;
127.0.0.1 - - [04/Sep/2019 12:10:57] "POST /?q=devops HTTP/1.1" 302 -&#13;
127.0.0.1 - - [04/Sep/2019 12:10:58] "GET / HTTP/1.1" 200 -&#13;
127.0.0.1 - - [04/Sep/2019 12:10:58] "POST /?q=devops HTTP/1.1" 302 -&#13;
127.0.0.1 - - [04/Sep/2019 12:10:59] "POST /?q=devops HTTP/1.1" 302 -&#13;
127.0.0.1 - - [04/Sep/2019 12:11:00] "POST /?q=devops HTTP/1.1" 302 -&#13;
127.0.0.1 - - [04/Sep/2019 12:11:01] "GET / HTTP/1.1" 200 -&#13;
127.0.0.1 - - [04/Sep/2019 12:11:01] "POST /?q=devops HTTP/1.1" 302 -&#13;
127.0.0.1 - - [04/Sep/2019 12:11:02] "POST /?q=devops HTTP/1.1" 302 -</pre>&#13;
&#13;
<p>As you can see, <code>molotov</code> is easily extensible with pure Python and can be modified to suit other, more complex, needs. These examples scratch the surface of what the tool can do<a data-startref="ix_ch04-asciidoc13" data-type="indexterm" id="idm46691335002520"/><a data-startref="ix_ch04-asciidoc12" data-type="indexterm" id="idm46691335001816"/><a data-startref="ix_ch04-asciidoc11" data-type="indexterm" id="idm46691335001144"/>.<a data-startref="ix_ch04-asciidoc5" data-type="indexterm" id="idm46691335000344"/><a data-startref="ix_ch04-asciidoc4" data-type="indexterm" id="idm46691334999640"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="CPU Utilities" data-type="sect1"><div class="sect1" id="idm46691335331224">&#13;
<h1>CPU Utilities</h1>&#13;
&#13;
<p><a data-primary="CPU utilities" data-type="indexterm" id="ix_ch04-asciidoc14"/><a data-primary="Linux utilities" data-secondary="CPU utilities" data-type="indexterm" id="ix_ch04-asciidoc15"/>There are two important CPU utilities: <code>top</code> and <code>htop</code>. You can find <code>top</code> preinstalled in most Linux distributions today, but if you are able to install packages, <code>htop</code> is fantastic to work with and we prefer its customizable interface over <code>top</code>. There are a few other tools out there that provide CPU visualization and perhaps even monitoring, but none are as complete and as widely available as both <code>top</code> and <code>htop</code>. For example, it is entirely possible to get CPU utilization from the <code>ps</code> command:</p>&#13;
&#13;
<pre data-type="programlisting">$ ps -eo pcpu,pid,user,args | sort -r | head -10&#13;
%CPU   PID USER     COMMAND&#13;
 0.3   719 vagrant  -bash&#13;
 0.1   718 vagrant  sshd: vagrant@pts/0&#13;
 0.1   668 vagrant  /lib/systemd/systemd --user&#13;
 0.0     9 root     [rcu_bh]&#13;
 0.0    95 root     [ipv6_addrconf]&#13;
 0.0    91 root     [kworker/u4:3]&#13;
 0.0     8 root     [rcu_sched]&#13;
 0.0    89 root     [scsi_tmf_1]</pre>&#13;
&#13;
<p>The <a data-primary="ps command" data-type="indexterm" id="idm46691334989736"/><code>ps</code> command takes some custom fields. The first one is <code>pcpu</code>, which gives the CPU usage, followed by the process ID, the user, and finally, the command. That <em>pipes</em> into a sorted reverse because by default it goes from less CPU usage to more, and you need to have the most CPU usage at the top. Finally, since the command displays this information for every single process, it filters the top 10 results with the <code>head</code> <span class="keep-together">command.</span></p>&#13;
&#13;
<p>But the command is quite a mouthful, is a challenge to remember, and is not updated on the fly. Even if aliased, you are better off with <code>top</code> or <code>htop</code>. As you will see, both have extensive features.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Viewing Processes with htop" data-type="sect2"><div class="sect2" id="idm46691334984888">&#13;
<h2>Viewing Processes with htop</h2>&#13;
&#13;
<p><a data-primary="htop" data-type="indexterm" id="idm46691334983320"/>The <code>htop</code> tool is just like <code>top</code> (an interactive process viewer) but is fully cross-platform (works on OS X, FreeBSD, OpenBSD, and Linux), offers support for better visualizations (see <a data-type="xref" href="#Figure-4-1">Figure 4-1</a>), and is a pleasure to use. Visit <a href="https://hisham.hm/htop"><em class="hyperlink">https://hisham.hm/htop</em></a> for a screenshot of <code>htop</code> running on a server. One of the main caveats of <code>htop</code> is that all the shortcuts you may know about <code>top</code> are not compatible, so you will have to rewire your brain to understand and use them for <code>htop</code>.</p>&#13;
&#13;
<figure><div class="figure" id="Figure-4-1">&#13;
<img alt="pydo 0401" src="assets/pydo_0401.png"/>&#13;
<h6><span class="label">Figure 4-1. </span>htop running on a server</h6>&#13;
</div></figure>&#13;
&#13;
<p>Right away, the look and feel of the information displayed in <a data-type="xref" href="#Figure-4-1">Figure 4-1</a> is different. The CPU, Memory, and Swap are nicely shown at the top left, and they move as the system changes. The arrow keys scroll up or down and even left to right, providing a view of the whole command of the process.</p>&#13;
&#13;
<p>Want to kill a process? Move to it with the arrow keys, or hit <code>/</code> to incrementally search (and filter) the process, and then press <code>k</code>. A new menu will show all the signals that can be sent to the process—for example, <code>SIGTERM</code> instead of <code>SIGKILL</code>. It is possible to <em>“tag”</em> more than one process to kill. Press the space bar to tag the selected <span class="keep-together">process,</span> highlighting it with a different color. Made a mistake and want to un-tag? Press the space bar again. This all feels very intuitive.</p>&#13;
&#13;
<p>One problem with <code>htop</code> is that it has lots of actions mapped to <code>F</code> keys, and you may not have any. For example, <code>F1</code> is for help. The alternative is to use the equivalent mappings when possible. To access the help menu, use the <code>h</code> key; to access the setup, use <code>Shift s</code> instead of F2.</p>&#13;
&#13;
<p>The <code>t</code> (again, how intuitive!) enables (toggles) the process list as a tree. Probably the most used functionality is sorting. Press <code>&gt;</code> and a menu appears to select what type of sorting you want: PID, user, memory, priority, and CPU percentage are just a few. There are also shortcuts to sort directly (skips the menu selection) by memory (<code>Shift i</code>), CPU (<code>Shift p</code>), and Time (<code>Shift t</code>).</p>&#13;
&#13;
<p>Finally, two incredible features: you can run <a data-primary="lsof" data-type="indexterm" id="idm46691334964008"/><a data-primary="strace" data-type="indexterm" id="idm46691334963304"/><code>strace</code> or <code>lsof</code> directly in the selected process as long as these are installed and available to the user. If the processes require superuser permissions, <code>htop</code> will report that, and it will require <code>sudo</code> to run as a privileged user. To run <code>strace</code> on a selected process, use the <code>s</code> key; for <code>lsof</code>, use the <code>l</code> key.</p>&#13;
&#13;
<p>If either <code>strace</code> or <code>lsof</code> is used, the search and filter options are available with the <code>/</code> character. What an incredibly useful tool! Hopefully, one day other non-<code>F</code> key mappings will be possible, even though most work can be done with the alternative <span class="keep-together">mappings.</span></p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>If <code>htop</code> is customized via its interactive session, the changes get persisted in a configuration file that is usually located at <em>~/.config/htop/htoprc</em>. If you define configurations there and later change them in the session, then the session will overwrite whatever was defined previously in the <em>htoprc</em> file.<a data-startref="ix_ch04-asciidoc15" data-type="indexterm" id="idm46691334953880"/><a data-startref="ix_ch04-asciidoc14" data-type="indexterm" id="idm46691334953144"/></p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Working with Bash and ZSH" data-type="sect1"><div class="sect1" id="idm46691334984264">&#13;
<h1>Working with Bash and ZSH</h1>&#13;
&#13;
<p><a data-primary="Linux utilities" data-secondary="Bash and ZSH basics" data-type="indexterm" id="ix_ch04-asciidoc16"/><a data-primary="shells, Bash/ZSH" data-type="indexterm" id="ix_ch04-asciidoc17"/>It all starts with customization. Both Bash and ZSH will usually come with a <em>“dotfile,”</em> a file prefixed with a dot that holds configuration but by default is hidden when directory contents are listed, and lives in the home directory of the user. For Bash this is <em>.bashrc</em>, and for ZSH it is <em>.zshrc</em>. Both shells support several layers of places that will get loaded in a predefined order, which ends in the configuration file for the user.</p>&#13;
&#13;
<p>When ZSH is installed, a <code>.zshrc</code> is usually not created. This is how a minimal version of it looks in a CentOS distro (all comments removed for brevity):</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>cat /etc/skel/.zshrc&#13;
autoload -U compinit&#13;
compinit&#13;
&#13;
setopt COMPLETE_IN_WORD</pre>&#13;
&#13;
<p>Bash has a couple of additional items in it but nothing surprising. You will no doubt get to the point of being extremely annoyed at some behavior or thing you saw in some other server that you want to replicate. We can’t live without colors in the terminal, so whatever the shell, it has to have color enabled. Before you know it, you are deep into configurations and want to add a bunch of useful aliases and functions.</p>&#13;
&#13;
<p>Soon after, the text editor configurations come in, and it all feels unmanageable on different machines or when new ones are added and all those useful aliases are not set up, and it is <em>unbelievable</em>, but no one has enabled color support anywhere. Everyone has a way to solve this problem in an entirely nontransferable, ad hoc way: Alfredo uses a <em>Makefile</em> at some point, and his coworkers use either nothing at all or a Bash script. A new project called <a href="https://deadc0de.re/dotdrop">Dotdrop</a> has lots of features to get all those dotfiles in working order, with features such as copying, symlinking, and keeping separate <em>profiles</em> for development and other machines—pretty useful when you move from one machine to another.</p>&#13;
&#13;
<p>You can use Dotdrop for a Python project, and although you can install it via the regular <code>virtualenv</code> and <code>pip</code> tooling, it is recommended to include it as a submodule to your repository of dotfiles. If you haven’t done so already, it is very convenient to keep all your dotfiles in version control to keep track of changes. Alfredo’s <a href="https://oreil.ly/LV1AH">dotfiles</a> are publicly available, and he tries to keep them as up-to-date as possible.</p>&#13;
&#13;
<p>Independent of what is used, keeping track of changes via version control, and making sure everything is always updated, is a good strategy.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Customizing the Python Shell" data-type="sect2"><div class="sect2" id="idm46691334936904">&#13;
<h2>Customizing the Python Shell</h2>&#13;
&#13;
<p><a data-primary="shells" data-secondary="customizing" data-type="indexterm" id="idm46691334935496"/><a data-primary="shells, Bash/ZSH" data-secondary="customizing the Python shell" data-type="indexterm" id="idm46691334934520"/>You can customize the Python shell with helpers and import useful modules in a Python file that then has to be exported as an environment variable. I keep my configuration files in a repository called <em>dotfiles</em>, so in my shell configuration file (<em>$HOME/.zshrc</em> for me) I define the following export:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting"><code class="nb">export </code><code class="nv">PYTHONSTARTUP</code><code class="o">=</code><code class="nv">$HOME</code>/dotfiles/pythonstartup.py</pre>&#13;
&#13;
<p>To try this out, create a new Python file called <em>pythonstartup.py</em> (although it can be named anything) that looks like this:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="go">import types</code>&#13;
<code class="go">import uuid</code>&#13;
&#13;
<code class="go">helpers = types.ModuleType('helpers')</code>&#13;
<code class="go">helpers.uuid4 = uuid.uuid4()</code></pre>&#13;
&#13;
<p>Now open up a new Python shell and specify the newly created <em>pythonstartup.py</em>:</p>&#13;
&#13;
<pre data-type="programlisting">$ PYTHONSTARTUP=pythonstartup.py python&#13;
Python 3.7.3 (default, Apr  3 2019, 06:39:12)&#13;
[GCC 8.3.0] on linux&#13;
Type "help", "copyright", "credits" or "license" for more information.&#13;
&gt;&gt;&gt; helpers&#13;
&lt;module 'helpers'&gt;&#13;
&gt;&gt;&gt; helpers.uuid4()&#13;
UUID('966d7dbe-7835-4ac7-bbbf-06bf33db5302')</pre>&#13;
&#13;
<p>The <a data-primary="helpers" data-type="indexterm" id="idm46691338344104"/><code>helpers</code> object is immediately available. Since we added the <code>uuid4</code> property, we can access it as <a data-primary="helpers.uuid4()" data-type="indexterm" id="idm46691342342312"/><code>helpers.uuid4()</code>. As you may be able to tell, all the imports and definitions are going to be available in the Python shell. This is a convenient way to extend behavior that can be useful with the default shell.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Recursive Globbing" data-type="sect2"><div class="sect2" id="idm46691342310776">&#13;
<h2>Recursive Globbing</h2>&#13;
&#13;
<p><a data-primary="recursive globbing" data-type="indexterm" id="idm46691358578424"/><a data-primary="shells, Bash/ZSH" data-secondary="recursive globbing" data-type="indexterm" id="idm46691358619688"/>Recursive globbing is enabled in ZSH by default, but Bash (versions 4 and higher) requires <code>shopt</code> to set it. Recursive globbing is a cool setting that allows you to traverse a path with the following syntax:</p>&#13;
&#13;
<pre data-type="programlisting">$ ls **/*.py</pre>&#13;
&#13;
<p>That snippet would go through each file and directory recursively and list every single file that ends in <code>.py</code>. This is how to enable it in Bash 4:</p>&#13;
&#13;
<pre data-type="programlisting">$ shopt -s globstar</pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Searching and Replacing with Confirmation Prompts" data-type="sect2"><div class="sect2" id="idm46691334831768">&#13;
<h2>Searching and Replacing with Confirmation Prompts</h2>&#13;
&#13;
<p><a data-primary="confirmation prompts, searching and replacing" data-type="indexterm" id="idm46691334822136"/><a data-primary="shells, Bash/ZSH" data-secondary="searching and replacing with confirmation prompts" data-type="indexterm" id="idm46691334830088"/>Vim has a nice feature in its search and replace engine that prompts for confirmation to perform the replacement or skip it. This is particularly useful when you can’t nail the exact regular expression that matches what you need but want to ignore some other close matches. We know regular expressions, but we’ve tried to avoid being an expert at them because it would be very tempting to use them for everything. Most of the time, you will want to perform a simple search and replace and not bang your head against the wall to come up with the perfect regex.</p>&#13;
&#13;
<p>The <code>c</code> flag needs to be appended at the end of the command to enable the confirmation prompt in Vim:</p>&#13;
&#13;
<pre data-type="programlisting">:%s/original term/replacement term/gc</pre>&#13;
&#13;
<p>The above translates to: search for <em>original term</em> in the whole file and replace it with <em>replacement term</em>, but at each instance, prompt so that one can decide to change it or skip it. If a match is found, Vim will display a message like this one:</p>&#13;
&#13;
<pre data-type="programlisting">replace with replacement term (y/n/a/q/l/^E/^Y)?</pre>&#13;
&#13;
<p>The whole confirmation workflow might seem silly but allows you to relax the constraints on the regular expression, or even not use one at all for a simpler match and replace. A quick example of this is a recent API change in a production tool that changed an object’s attribute for a callable. The code returned <code>True</code> or <code>False</code> to inform if superuser permissions were required or not. The actual replacement in a single file would look like this:</p>&#13;
&#13;
<pre data-type="programlisting">:%s/needs_root/needs_root()/gc</pre>&#13;
&#13;
<p>The added difficulty here is that <code>needs_root</code> was also splattered in comments and doc strings, so it wasn’t easy to come up with a regular expression that would allow skipping the replacement when inside a comment block or in part of a doc string. With the <code>c</code> flag, you can just hit <code>Y</code> or <code>N</code> and move on. No regular expression needed at all!</p>&#13;
&#13;
<p>With recursive globbing enabled (<code>shopt -s globstar</code> in Bash 4), this powerful one-liner will go through all the matching files, perform the search, and replace the item according to the prompts if the pattern is found inside the files:</p>&#13;
&#13;
<pre data-type="programlisting">vim -c "bufdo! set eventignore-=Syntax | %s/needs_root/needs_root()/gce" **/*.py</pre>&#13;
&#13;
<p>There is a lot to unpack here, but the above example will traverse recursively to find all the files ending in <code>.py</code>, load them into Vim, and perform the search and replace with confirmation only if there is a match. If there isn’t a match, it skips the file. The <code>set eventignore-=Syntax</code> is used because otherwise Vim will not load the syntax files when executing it this way; we like syntax highlighting and expect it to work when this type of replacement is used. The next part after the <code>|</code> character is the replacement with the confirmation flag and the <code>e</code> flag, which helps ignore any errors that would prevent a smooth workflow from being interrupted with errors.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>There are numerous other flags and variations that you can use to enhance the replacement command. To learn more about the special flags with a search and replace in Vim, take a look at <code>:help substitute</code>, specifically at the <code>s_flags</code> section.</p>&#13;
</div>&#13;
&#13;
<p>Make the complicated one-liner easier to remember with a function that takes two parameters (search and replace terms) and the path:</p>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting">vsed<code class="o">()</code> <code class="o">{</code>&#13;
  <code class="nv">search</code><code class="o">=</code><code class="nv">$1</code>&#13;
  <code class="nv">replace</code><code class="o">=</code><code class="nv">$2</code>&#13;
  <code class="nb">shift</code>&#13;
<code class="nb">  shift</code>&#13;
<code class="nb">  </code>vim -c <code class="s2">"bufdo! set eventignore-=Syntax| %s/</code><code class="nv">$search</code><code class="s2">/</code><code class="nv">$replace</code><code class="s2">/gce"</code> <code class="nv">$*</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p>Name it <code>vsed</code>, as a mix of Vim and the <code>sed</code> tool, so that it is easier to remember. In the terminal, it looks straightforward and allows you to make changes to multiple files easily and with confidence, since you can accept or deny each replacement:</p>&#13;
&#13;
<pre data-type="programlisting">$ vsed needs_root needs_root() **/*.py</pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Removing Temporary Python Files" data-type="sect2"><div class="sect2" id="idm46691334883896">&#13;
<h2>Removing Temporary Python Files</h2>&#13;
&#13;
<p><a data-primary="removing temporary Python files" data-type="indexterm" id="idm46691334739352"/><a data-primary="shells, Bash/ZSH" data-secondary="removing temporary Python files" data-type="indexterm" id="idm46691334738488"/><a data-primary="temporary Python files, removing" data-type="indexterm" id="idm46691334737544"/>Python’s <code>pyc</code>, and more recently its <a data-primary="pycache" data-type="indexterm" id="idm46691334736312"/><code><em>pycache</em></code> directories, can sometimes get in the way. This simple one-liner aliased to <a data-primary="pyclean" data-type="indexterm" id="idm46691334735064"/><code>pyclean</code> uses the <code>find</code> command to remove <code>pyc</code>, then goes on to find <code><em>pycache</em></code> directories and recursively deletes them with the tool’s built-in delete flag:</p>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting"><code class="nb">alias </code><code class="nv">pyclean</code><code class="o">=</code><code class="s1">'find . \</code>&#13;
<code class="s1">    \( -type f -name "*.py[co]" -o -type d -name "__pycache__" \) -delete &amp;&amp;</code>&#13;
<code class="s1">    echo "Removed pycs and __pycache__"'</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Listing and Filtering Processes" data-type="sect2"><div class="sect2" id="idm46691334716984">&#13;
<h2>Listing and Filtering Processes</h2>&#13;
&#13;
<p><a data-primary="filtering processes" data-type="indexterm" id="idm46691334725816"/><a data-primary="listing processes" data-type="indexterm" id="idm46691334725176"/><a data-primary="shells, Bash/ZSH" data-secondary="listing and filtering processes" data-type="indexterm" id="idm46691334724504"/>Process listing to view what runs in a machine and then filtering to check on a specific application is one of the things that you’ll do several times a day at the very least. It is not at all surprising that everyone has a variation on either the flags or the order of the flags for the <code>ps</code> tool (we usually use <code>aux</code>). It is something you end up doing so many times a day that the order and the flags get ingrained in your brain and it is hard to do it any other way.</p>&#13;
&#13;
<p>As a good starting point to list the processes and some information, such as process IDs, try this:</p>&#13;
&#13;
<pre data-type="programlisting">$ ps auxw</pre>&#13;
&#13;
<p>This command lists all processes with the <em>BSD-style</em> flags (flags that aren’t prefixed with a dash <code>-</code>) regardless or whether they have a terminal (tty) or not, and includes the user that owns the process. Finally, it gives more space to the output (<code>w</code> flag).</p>&#13;
&#13;
<p>Most of the times, you are filtering with <code>grep</code> to get information about a specific process. For example, if you want to check if Nginx is running, you pipe the output into grep and pass <code>nginx</code> as an argument:</p>&#13;
&#13;
<pre data-type="programlisting">$ ps auxw | grep nginx&#13;
root     29640  1536 ?        Ss   10:11   0:00 nginx: master process&#13;
www-data 29648  5440 ?        S    10:11   0:00 nginx: worker process&#13;
alfredo  30024   924 pts/14   S+   10:12   0:00 grep nginx</pre>&#13;
&#13;
<p>That is great, but it is annoying to have the <code>grep</code> command included. This is particularly maddening when there are no results except for the <code>grep</code>:</p>&#13;
&#13;
<pre data-type="programlisting">$ ps auxw | grep apache&#13;
alfredo  31351  0.0  0.0   8856   912 pts/13   S+   10:15   0:00 grep apache</pre>&#13;
&#13;
<p>No <code>apache</code> process is found, but the visuals may mislead you to think it is, and double-checking that this is indeed just <code>grep</code> being included because of the argument can get tiring pretty quickly. A way to solve this is to add another pipe to <code>grep</code> to filter itself from the output:</p>&#13;
&#13;
<pre data-type="programlisting">$ ps auxw | grep apache | grep -v grep</pre>&#13;
&#13;
<p>To have to always remember to add that extra <code>grep</code> can be equally annoying, so an alias comes to the rescue:</p>&#13;
&#13;
<pre data-type="programlisting">alias pg='ps aux | grep -v grep | grep $1'</pre>&#13;
&#13;
<p>The new alias will filter the first <code>grep</code> line out and leave only the interesting output (if any):</p>&#13;
&#13;
<pre data-type="programlisting">$ pg vim&#13;
alfredo  31585  77836 20624 pts/3    S+   18:39   0:00 vim /home/alfredo/.zshrc</pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Unix Timestamp" data-type="sect2"><div class="sect2" id="idm46691334726360">&#13;
<h2>Unix Timestamp</h2>&#13;
&#13;
<p><a data-primary="shells, Bash/ZSH" data-secondary="Unix timestamp" data-type="indexterm" id="idm46691334682184"/><a data-primary="unix timestamp" data-type="indexterm" id="idm46691334681208"/>To get the widely used Unix timestamp in Python is very easy:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="go">In [1]: import time</code>&#13;
&#13;
<code class="go">In [2]: int(time.time())</code>&#13;
<code class="go">Out[2]: 1566168361</code></pre>&#13;
&#13;
<p>But in the shell, it can be a bit more involved. This alias works in OS X, which has the BSD-flavored version of the <code>date</code> tool:</p>&#13;
&#13;
<pre data-type="programlisting">alias timestamp='date -j -f "%a %b %d %T %Z %Y" "`date`" "+%s"'</pre>&#13;
&#13;
<p>OS X can be awkward with its tooling, and it may be confusing to never remember why a given utility (like <code>date</code> in this case) behaves completely differently. In the Linux version of <code>date</code>, a far simpler approach works the same way:</p>&#13;
&#13;
<pre data-type="programlisting">alias timestamp='date "+%s"'</pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Mixing Python with Bash and ZSH" data-type="sect1"><div class="sect1" id="idm46691334951752">&#13;
<h1>Mixing Python with Bash and ZSH</h1>&#13;
&#13;
<p><a data-primary="Linux utilities" data-secondary="mixing Python with Bash and ZSH" data-type="indexterm" id="ix_ch04-asciidoc18"/><a data-primary="shells, Bash/ZSH" data-secondary="mixing Python" data-type="indexterm" id="ix_ch04-asciidoc19"/>It never occurred to us to try and mix Python with a shell, like ZSH or Bash. It feels like going against common sense, but there are a few good cases here that you can use almost daily. In general, our rule of thumb is that 10 lines of shell script is the limit; anything beyond that is a bug waiting to make you waste time because the error reporting isn’t there to help you out.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Random Password Generator" data-type="sect2"><div class="sect2" id="idm46691334652712">&#13;
<h2>Random Password Generator</h2>&#13;
&#13;
<p><a data-primary="shells, Bash/ZSH" data-secondary="random password generator" data-type="indexterm" id="idm46691334651336"/>The amount of accounts and passwords that you need on a week-to-week basis is only going to keep increasing, even for throwaway accounts that you can use Python for to generate robust passwords. Create a useful, randomized password generator that sends the contents to the clipboard to easily paste it:</p>&#13;
&#13;
<pre data-code-language="python3" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">1</code><code class="p">]:</code> <code class="kn">import</code> <code class="nn">os</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">2</code><code class="p">]:</code> <code class="kn">import</code> <code class="nn">base64</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">3</code><code class="p">]:</code> <code class="nb">print</code><code class="p">(</code><code class="n">base64</code><code class="o">.</code><code class="n">b64encode</code><code class="p">(</code><code class="n">os</code><code class="o">.</code><code class="n">urandom</code><code class="p">(</code><code class="mi">64</code><code class="p">))</code><code class="o">.</code><code class="n">decode</code><code class="p">(</code><code class="s1">'utf-8'</code><code class="p">))</code>&#13;
<code class="n">gHHlGXnqnbsALbAZrGaw</code><code class="o">+</code><code class="n">LmvipTeFi3tA</code><code class="o">/</code><code class="mi">9</code><code class="n">uBltNf9g2S9qTQ8hTpBYrXStp</code><code class="o">+</code><code class="n">i</code><code class="o">/</code><code class="n">o5TseeVo6wcX2A</code><code class="o">==</code></pre>&#13;
&#13;
<p>Porting that to a shell function that can take an arbitrary length (useful when a site restricts length to a certain number) looks like this:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">mpass<code class="o">()</code> <code class="o">{</code>&#13;
    <code class="k">if</code> <code class="o">[</code> <code class="nv">$1</code> <code class="o">]</code><code class="p">;</code> <code class="k">then</code>&#13;
        <code class="nv">length</code><code class="o">=</code><code class="nv">$1</code>&#13;
    <code class="k">else</code>&#13;
        <code class="nv">length</code><code class="o">=</code>12&#13;
    <code class="k">fi</code>&#13;
    <code class="nv">_hash</code><code class="o">=</code><code class="sb">`</code>python3 -c <code class="s2">"</code>&#13;
<code class="s2">import os,base64</code>&#13;
<code class="s2">exec('print(base64.b64encode(os.urandom(64))[:</code><code class="si">${</code><code class="nv">length</code><code class="si">}</code><code class="s2">].decode(\'utf-8\'))')</code>&#13;
<code class="s2">    "</code><code class="sb">`</code>&#13;
    <code class="nb">echo</code> <code class="nv">$_hash</code> <code class="p">|</code> xclip -selection clipboard&#13;
    <code class="nb">echo</code> <code class="s2">"new password copied to the system clipboard"</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p>Now the <code>mpass</code> function defaults to generate 12-character passwords by slicing the output, and then sends the contents of the generated string to<a data-primary="xclip" data-type="indexterm" id="idm46691333546328"/> <code>xclip</code> so that it gets copied to the clipboard for easy pasting.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p><code>xclip</code> is not installed by default in many distros, so you need to ensure that it is installed for the function to work properly. If <code>xclip</code> is not available, any other utility that can help manage the system clipboard will work fine.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Does My Module Exist?" data-type="sect2"><div class="sect2" id="idm46691333525784">&#13;
<h2>Does My Module Exist?</h2>&#13;
&#13;
<p><a data-primary="shells, Bash/ZSH" data-secondary="determining module existence and finding path to module" data-type="indexterm" id="idm46691333524616"/>Find out if a module exists, and if it does, get the path to that module. This is useful when reused for other functions that can take that output for processing:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">try<code class="o">()</code> <code class="o">{</code>&#13;
    python -c <code class="s2">"</code>&#13;
<code class="s2">exec('''</code>&#13;
<code class="s2">try:</code>&#13;
<code class="s2">    import </code><code class="si">${</code><code class="nv">1</code><code class="si">}</code><code class="s2"> as _</code>&#13;
<code class="s2">    print(_.__file__)</code>&#13;
<code class="s2">except Exception as e:</code>&#13;
<code class="s2">    print(e)</code>&#13;
<code class="s2">''')"</code>&#13;
<code class="o">}</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before less_space" data-pdf-bookmark="Changing Directories to a Module’s Path" data-type="sect2"><div class="sect2" id="idm46691334417800">&#13;
<h2>Changing Directories to a Module’s Path</h2>&#13;
&#13;
<p><a data-primary="shells, Bash/ZSH" data-secondary="changing directories to module's path" data-type="indexterm" id="idm46691334423336"/><em>“Where does this module live?”</em> is often asked when debugging libraries and dependencies, or even when poking around at the source of modules. Python’s way to install and distribute modules isn’t straightforward, and in different Linux distributions the paths are entirely different and have separate conventions. You can find out the path of a module if you import it and then use <code>print</code>:</p>&#13;
&#13;
<pre data-code-language="python3" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">1</code><code class="p">]:</code> <code class="kn">import</code> <code class="nn">os</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">2</code><code class="p">]:</code> <code class="nb">print</code><code class="p">(</code><code class="n">os</code><code class="p">)</code>&#13;
<code class="o">&lt;</code><code class="n">module</code> <code class="s1">'os'</code> <code class="kn">from</code> <code class="s1">'.virtualenvs/python-devops/lib/python3.6/os.py'</code><code class="o">&gt;</code></pre>&#13;
&#13;
<p>It isn’t convenient if all you want is the path so that you can change directories to it and look at the module. This function will try to import the module as an argument, print it out (this is shell, so <code>return</code> doesn’t do anything for us), and then change directory to it:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">cdp<code class="o">()</code> <code class="o">{</code>&#13;
    <code class="nv">MODULE_DIRECTORY</code><code class="o">=</code><code class="sb">`</code>python -c <code class="s2">"</code>&#13;
<code class="s2">exec('''</code>&#13;
<code class="s2">try:</code>&#13;
<code class="s2">    import os.path as _, </code><code class="si">${</code><code class="nv">module</code><code class="si">}</code><code class="s2"/>&#13;
<code class="s2">    print(_.dirname(_.realpath(</code><code class="si">${</code><code class="nv">module</code><code class="si">}</code><code class="s2">.__file__)))</code>&#13;
<code class="s2">except Exception as e:</code>&#13;
<code class="s2">    print(e)</code>&#13;
<code class="s2">''')"</code><code class="sb">`</code>&#13;
    <code class="k">if</code>  <code class="o">[[</code> -d <code class="nv">$MODULE_DIRECTORY</code> <code class="o">]]</code><code class="p">;</code> <code class="k">then</code>&#13;
        <code class="nb">cd</code> <code class="nv">$MODULE_DIRECTORY</code>&#13;
    <code class="k">else</code>&#13;
        <code class="nb">echo</code> <code class="s2">"Module </code><code class="si">${</code><code class="nv">1</code><code class="si">}</code><code class="s2"> not found or is not importable: </code><code class="nv">$MODULE_DIRECTORY</code><code class="s2">"</code>&#13;
    <code class="k">fi</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p>Let’s make it more robust, in case the package name has a dash and the module uses an underscore, by adding:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">    <code class="nv">module</code><code class="o">=</code><code class="k">$(</code>sed <code class="s1">'s/-/_/g'</code> <code class="o">&lt;&lt;&lt;</code> <code class="nv">$1</code><code class="k">)</code></pre>&#13;
&#13;
<p>If the input has a dash, the little function can solve this on the fly and get us to where we need to be:</p>&#13;
&#13;
<pre data-type="programlisting">$ cdp pkg-resources&#13;
$ pwd&#13;
/usr/lib/python2.7/dist-packages/pkg_resources</pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before less_space" data-pdf-bookmark="Converting a CSV File to JSON" data-type="sect2"><div class="sect2" id="idm46691334424552">&#13;
<h2>Converting a CSV File to JSON</h2>&#13;
&#13;
<p><a data-primary="CSV, JSON converted from" data-type="indexterm" id="idm46691333388920"/><a data-primary="JSON (Javascript Object Notation)" data-secondary="CSV converted to" data-type="indexterm" id="idm46691333388200"/><a data-primary="shells, Bash/ZSH" data-secondary="converting CSV file to JSON" data-type="indexterm" id="idm46691333387240"/>Python comes with a few built-ins that are surprising if you’ve never dealt with them. It can handle JSON natively, as well as CSV files. It only takes a couple of lines to load a CSV file and then <em>“dump”</em> its contents as JSON. Use the following CSV file (<em>addresses.csv</em>) to see the contents when JSON is dumped in the Python shell:</p>&#13;
&#13;
<pre data-type="programlisting">John,Doe,120 Main St.,Riverside, NJ, 08075&#13;
Jack,Jhonson,220 St. Vernardeen Av.,Phila, PA,09119&#13;
John,Howards,120 Monroe St.,Riverside, NJ,08075&#13;
Alfred, Reynolds, 271 Terrell Trace Dr., Marietta, GA, 30068&#13;
Jim, Harrison, 100 Sandy Plains Plc., Houston, TX, 77005</pre>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="o">&gt;&gt;&gt;</code> <code class="kn">import</code> <code class="nn">csv</code>&#13;
<code class="o">&gt;&gt;&gt;</code> <code class="kn">import</code> <code class="nn">json</code>&#13;
<code class="o">&gt;&gt;&gt;</code> <code class="n">contents</code> <code class="o">=</code> <code class="nb">open</code><code class="p">(</code><code class="s2">"addresses.csv"</code><code class="p">)</code><code class="o">.</code><code class="n">readlines</code><code class="p">()</code>&#13;
<code class="o">&gt;&gt;&gt;</code> <code class="n">json</code><code class="o">.</code><code class="n">dumps</code><code class="p">(</code><code class="nb">list</code><code class="p">(</code><code class="n">csv</code><code class="o">.</code><code class="n">reader</code><code class="p">(</code><code class="n">contents</code><code class="p">)))</code>&#13;
<code class="s1">'[["John", "Doe", "120 Main St.", "Riverside", " NJ", " 08075"],</code>&#13;
<code class="p">[</code><code class="s2">"Jack"</code><code class="p">,</code> <code class="s2">"Jhonson"</code><code class="p">,</code> <code class="s2">"220 St. Vernardeen Av."</code><code class="p">,</code> <code class="s2">"Phila"</code><code class="p">,</code> <code class="s2">" PA"</code><code class="p">,</code> <code class="s2">"09119"</code><code class="p">],</code>&#13;
<code class="p">[</code><code class="s2">"John"</code><code class="p">,</code> <code class="s2">"Howards"</code><code class="p">,</code> <code class="s2">"120 Monroe St."</code><code class="p">,</code> <code class="s2">"Riverside"</code><code class="p">,</code> <code class="s2">" NJ"</code><code class="p">,</code> <code class="s2">"08075"</code><code class="p">],</code>&#13;
<code class="p">[</code><code class="s2">"Alfred"</code><code class="p">,</code> <code class="s2">" Reynolds"</code><code class="p">,</code> <code class="s2">" 271 Terrell Trace Dr."</code><code class="p">,</code> <code class="s2">" Marietta"</code><code class="p">,</code> <code class="s2">" GA"</code><code class="p">,</code> <code class="s2">" 30068"</code><code class="p">],</code>&#13;
<code class="p">[</code><code class="s2">"Jim"</code><code class="p">,</code> <code class="s2">" Harrison"</code><code class="p">,</code> <code class="s2">" 100 Sandy Plains Plc."</code><code class="p">,</code> <code class="s2">" Houston"</code><code class="p">,</code> <code class="s2">" TX"</code><code class="p">,</code> <code class="s2">" 77005"</code><code class="p">]]</code><code class="s1">'</code></pre>&#13;
&#13;
<p>Port the interactive session to a function that can do this on the command line:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">csv2json <code class="o">()</code> <code class="o">{</code>&#13;
	python3 -c <code class="s2">"</code>&#13;
<code class="s2">exec('''</code>&#13;
<code class="s2">import csv,json</code>&#13;
<code class="s2">print(json.dumps(list(csv.reader(open(\'</code><code class="si">${</code><code class="nv">1</code><code class="si">}</code><code class="s2">\')))))</code>&#13;
<code class="s2">''')</code>&#13;
<code class="s2">"</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p>Use it in the shell, which is much simpler than remembering all the calls and <span class="keep-together">modules</span><a data-startref="ix_ch04-asciidoc19" data-type="indexterm" id="idm46691332913912"/><a data-startref="ix_ch04-asciidoc18" data-type="indexterm" id="idm46691332913304"/>:<a data-startref="ix_ch04-asciidoc17" data-type="indexterm" id="idm46691332912504"/><a data-startref="ix_ch04-asciidoc16" data-type="indexterm" id="idm46691332911800"/></p>&#13;
&#13;
<pre data-type="programlisting">$ csv2json addresses.csv&#13;
[["John", "Doe", "120 Main St.", "Riverside", " NJ", " 08075"],&#13;
["Jack", "Jhonson", "220 St. Vernardeen Av.", "Phila", " PA", "09119"],&#13;
["John", "Howards", "120 Monroe St.", "Riverside", " NJ", "08075"],&#13;
["Alfred", " Reynolds", " 271 Terrell Trace Dr.", " Marietta", " GA", " 30068"],&#13;
["Jim", " Harrison", " 100 Sandy Plains Plc.", " Houston", " TX", " 77005"]]</pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Python One-Liners" data-type="sect1"><div class="sect1" id="idm46691332910472">&#13;
<h1>Python One-Liners</h1>&#13;
&#13;
<p><a data-primary="Linux utilities" data-secondary="Python one-liners" data-type="indexterm" id="ix_ch04-asciidoc20"/><a data-primary="Python one-liners" data-type="indexterm" id="ix_ch04-asciidoc21"/>In general, writing a long, single line of Python is not considered good practice. The <a href="https://oreil.ly/3P_qQ">PEP 8</a> guide even frowns on compounding statements with a semicolon (it is possible to use semicolons in Python!). But quick debug statements and calls to a debugger are fine. They are, after all, temporary.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Debuggers" data-type="sect2"><div class="sect2" id="idm46691332895992">&#13;
<h2>Debuggers</h2>&#13;
&#13;
<p><a data-primary="Python one-liners" data-secondary="debuggers" data-type="indexterm" id="idm46691332894728"/>A few programmers out there swear by the<a data-primary="print()" data-type="indexterm" id="idm46691332893624"/> <code>print()</code> statement as the best strategy to debug running code. In some cases, that might work fine, but most of the time we use the Python debugger (with the <code>pdb</code> module) or <code>ipdb</code>, which uses IPython as a backend. By creating a break point, you can poke around at variables and go up and down the stack. These single-line statements are important enough that you should memorize them:</p>&#13;
&#13;
<p>Set a break point and drop to the Python debugger (<code>pdb</code>):</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">pdb</code><code class="p">;</code><code class="n">pdb</code><code class="o">.</code><code class="n">set_trace</code><code class="p">()</code></pre>&#13;
&#13;
<p>Set a break point and drop to a Python debugger based on IPython (<code>ipdb</code>):</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">ipdb</code><code class="p">;</code><code class="n">ipdb</code><code class="o">.</code><code class="n">set_trace</code><code class="p">()</code></pre>&#13;
&#13;
<p>Although not technically a debugger (you can’t move forward or backward in the stack), this one-liner allows you to start an IPython session when the execution gets to it:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">IPython</code><code class="p">;</code> <code class="n">IPython</code><code class="o">.</code><code class="n">embed</code><code class="p">()</code></pre>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Everyone seems to have a favorite debugger tool. We find <code>pdb</code> to be too rough (no auto-completion, no syntax highlighting), so we tend to like <code>ipdb</code> better. Don’t be surprised if someone comes along with a different debugger! In the end, it’s useful to know how <code>pdb</code> works, as it’s the base needed to be proficient regardless of the debugger. In systems you can’t control, use <code>pdb</code> directly because you can’t install dependencies; you may not like it, but you can still manage your way around.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="How Fast Is this Snippet?" data-type="sect2"><div class="sect2" id="idm46691332840600">&#13;
<h2>How Fast Is this Snippet?</h2>&#13;
&#13;
<p><a data-primary="Python one-liners" data-secondary="performance measurement" data-type="indexterm" id="idm46691332839352"/>Python has a module to run a piece of code several times over and get some performance metrics from it. Lots of users like to ask if there are efficient ways to handle a loop or update a dictionary, and there are lots of knowledgeable people that love the <a data-primary="timeit module" data-type="indexterm" id="idm46691332810216"/><code>timeit</code> module to prove performance.</p>&#13;
&#13;
<p>As you have probably seen, we are fans of <a href="https://ipython.org">IPython</a>, and its interactive shell comes with a <em>“magic”</em> special function for the <code>timeit</code> module. “Magic” functions are prefixed with the <code>%</code> character and perform a distinct operation within the shell. An all-time favorite regarding performance is whether list comprehension is faster than just appending to a list. The two examples below use the <code>timeit</code> module to find out:</p>&#13;
&#13;
<pre data-code-language="python3" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">1</code><code class="p">]:</code> <code class="k">def</code> <code class="nf">f</code><code class="p">(</code><code class="n">x</code><code class="p">):</code>&#13;
   <code class="o">...</code><code class="p">:</code>     <code class="k">return</code> <code class="n">x</code><code class="o">*</code><code class="n">x</code>&#13;
   <code class="o">...</code><code class="p">:</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">2</code><code class="p">]:</code> <code class="o">%</code><code class="n">timeit</code> <code class="k">for</code> <code class="n">x</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="mi">100</code><code class="p">):</code> <code class="n">f</code><code class="p">(</code><code class="n">x</code><code class="p">)</code>&#13;
<code class="mi">100000</code> <code class="n">loops</code><code class="p">,</code> <code class="n">best</code> <code class="n">of</code> <code class="mi">3</code><code class="p">:</code> <code class="mf">20.3</code> <code class="n">us</code> <code class="n">per</code> <code class="n">loop</code></pre>&#13;
&#13;
<p>In the standard Python shell (or interpreter), you import the module and access it directly. The invocation looks a bit different in this case:</p>&#13;
&#13;
<pre data-code-language="python3" data-type="programlisting"><code class="o">&gt;&gt;&gt;</code> <code class="n">array</code> <code class="o">=</code> <code class="p">[]</code>&#13;
<code class="o">&gt;&gt;&gt;</code> <code class="k">def</code> <code class="nf">appending</code><code class="p">():</code>&#13;
<code class="o">...</code>     <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="mi">100</code><code class="p">):</code>&#13;
<code class="o">...</code>         <code class="n">array</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">i</code><code class="p">)</code>&#13;
<code class="o">...</code>&#13;
<code class="o">&gt;&gt;&gt;</code> <code class="n">timeit</code><code class="o">.</code><code class="n">repeat</code><code class="p">(</code><code class="s2">"appending()"</code><code class="p">,</code> <code class="s2">"from __main__ import appending"</code><code class="p">)</code>&#13;
<code class="p">[</code><code class="mf">5.298534262983594</code><code class="p">,</code> <code class="mf">5.32031941099558</code><code class="p">,</code> <code class="mf">5.359099322988186</code><code class="p">]</code>&#13;
<code class="o">&gt;&gt;&gt;</code> <code class="n">timeit</code><code class="o">.</code><code class="n">repeat</code><code class="p">(</code><code class="s2">"[i for i in range(100)]"</code><code class="p">)</code>&#13;
<code class="p">[</code><code class="mf">2.2052824340062216</code><code class="p">,</code> <code class="mf">2.1648171059787273</code><code class="p">,</code> <code class="mf">2.1733458579983562</code><code class="p">]</code></pre>&#13;
&#13;
<p>The output is a bit odd, but that’s because it’s meant to be processed by another module or library, and is not meant for human readability. The averages favor the list comprehension. This is how it looks in IPython:</p>&#13;
&#13;
<pre data-code-language="python3" data-type="programlisting"><code class="n">In</code> <code class="p">[</code><code class="mi">1</code><code class="p">]:</code> <code class="k">def</code> <code class="nf">appending</code><code class="p">():</code>&#13;
   <code class="o">...</code><code class="p">:</code>     <code class="n">array</code> <code class="o">=</code> <code class="p">[]</code>&#13;
   <code class="o">...</code><code class="p">:</code>     <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="mi">100</code><code class="p">):</code>&#13;
   <code class="o">...</code><code class="p">:</code>         <code class="n">array</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">i</code><code class="p">)</code>&#13;
   <code class="o">...</code><code class="p">:</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">2</code><code class="p">]:</code> <code class="o">%</code><code class="n">timeit</code> <code class="n">appending</code><code class="p">()</code>&#13;
<code class="mf">5.39</code> <code class="n">µs</code> <code class="err">±</code> <code class="mf">95.1</code> <code class="n">ns</code> <code class="n">per</code> <code class="n">loop</code> <code class="p">(</code><code class="n">mean</code> <code class="err">±</code> <code class="n">std</code><code class="o">.</code> <code class="n">dev</code><code class="o">.</code> <code class="n">of</code> <code class="mi">7</code> <code class="n">runs</code><code class="p">,</code> <code class="mi">100000</code> <code class="n">loops</code> <code class="n">each</code><code class="p">)</code>&#13;
&#13;
<code class="n">In</code> <code class="p">[</code><code class="mi">3</code><code class="p">]:</code> <code class="o">%</code><code class="n">timeit</code> <code class="p">[</code><code class="n">i</code> <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="mi">100</code><code class="p">)]</code>&#13;
<code class="mf">2.1</code> <code class="n">µs</code> <code class="err">±</code> <code class="mf">15.2</code> <code class="n">ns</code> <code class="n">per</code> <code class="n">loop</code> <code class="p">(</code><code class="n">mean</code> <code class="err">±</code> <code class="n">std</code><code class="o">.</code> <code class="n">dev</code><code class="o">.</code> <code class="n">of</code> <code class="mi">7</code> <code class="n">runs</code><code class="p">,</code> <code class="mi">100000</code> <code class="n">loops</code> <code class="n">each</code><code class="p">)</code></pre>&#13;
&#13;
<p>Because IPython exposes <code>timeit</code> as a special command (notice the prefix with <code>%</code>), the output is human readable and more helpful to view, and it doesn’t require the weird import, as in the standard Python shell.<a data-startref="ix_ch04-asciidoc21" data-type="indexterm" id="idm46691332494904"/><a data-startref="ix_ch04-asciidoc20" data-type="indexterm" id="idm46691332494520"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="strace" data-type="sect1"><div class="sect1" id="idm46691332493592">&#13;
<h1>strace</h1>&#13;
&#13;
<p><a data-primary="Linux utilities" data-secondary="strace" data-type="indexterm" id="ix_ch04-asciidoc22"/><a data-primary="strace" data-type="indexterm" id="ix_ch04-asciidoc23"/>The ability to tell how a program is interacting with the operating system becomes crucial when applications aren’t logging the interesting parts or not logging at all. Output from <code>strace</code> can be rough, but with some understanding of the basics, it becomes easier to understand what is going on with a problematic application. One time, Alfredo was trying to understand why permission to access a file was being denied. This file was inside of a symlink that seemed to have all the right permissions. What was going on? It was difficult to tell by just looking at logs, since those weren’t particularly useful in displaying permissions as they tried to access files.</p>&#13;
&#13;
<p class="pagebreak-before"><code>strace</code> included these two lines in the output:</p>&#13;
&#13;
<pre data-type="programlisting">stat("/var/lib/ceph/osd/block.db", 0x7fd) = -1 EACCES (Permission denied)&#13;
lstat("/var/lib/ceph/osd/block.db", {st_mode=S_IFLNK|0777, st_size=22}) = 0</pre>&#13;
&#13;
<p>The program was setting ownership on the parent directory, which happened to be a link, and <em>block.db</em>, which in this case was also a link to a block device. The block device itself had the right permissions, so what was the problem? It turns out that the link in the directory had a <em>sticky bit</em> that prevented other links from changing the path—including the block device. The <a data-primary="chown tool" data-type="indexterm" id="idm46691332484712"/><code>chown</code> tool has a special flag (<code>-h</code> or <span class="keep-together"><code>--no-dereference</code></span>) to indicate that the change in ownership should also affect the links.</p>&#13;
&#13;
<p>This type of debugging would be difficult (if not impossible) without something like <code>strace</code>. To try it out, create a file called <em>follow.py</em> with the following contents:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">import</code> <code class="nn">subprocess</code>&#13;
&#13;
<code class="n">subprocess</code><code class="o">.</code><code class="n">call</code><code class="p">([</code><code class="s1">'ls'</code><code class="p">,</code> <code class="s1">'-alh'</code><code class="p">])</code></pre>&#13;
&#13;
<p>It imports the <code>subprocess</code> module to do a system call. It will output the contents of the system call to <code>ls</code>. Instead of a direct call with Python, prefix the command with <code>strace</code> to see what happens:</p>&#13;
&#13;
<pre data-type="programlisting">$ strace python follow.py</pre>&#13;
&#13;
<p>A lot of output should’ve filled the terminal, and probably most of it will look very foreign. Force yourself to go through each line, regardless of whether you understand what is going on. Some lines will be easier to tell apart than others. There are a lot of <code>read</code> and <code>fstat</code> calls; you’ll see actual system calls and what the process is doing at each step. There are also <code>open</code> and <code>close</code> operations on some files, and there is a particular section that should show up with a few <code>stat</code> calls:</p>&#13;
&#13;
<pre data-type="programlisting">stat("/home/alfredo/go/bin/python", 0x7ff) = -1 ENOENT (No such file)&#13;
stat("/usr/local/go/bin/python", 0x7ff) = -1 ENOENT (No such file)&#13;
stat("/usr/local/bin/python", 0x7ff) = -1 ENOENT (No such file)&#13;
stat("/home/alfredo/bin/python", 0x7ff) = -1 ENOENT (No such file)&#13;
stat("/usr/local/sbin/python", 0x7ff) = -1 ENOENT (No such file)&#13;
stat("/usr/local/bin/python", 0x7ff) = -1 ENOENT (No such file)&#13;
stat("/usr/sbin/python", 0x7ff) = -1 ENOENT (No such file)&#13;
stat("/usr/bin/python", {st_mode=S_IFREG|0755, st_size=3691008, ...}) = 0&#13;
readlink("/usr/bin/python", "python2", 4096) = 7&#13;
readlink("/usr/bin/python2", "python2.7", 4096) = 9&#13;
readlink("/usr/bin/python2.7", 0x7ff, 4096) = -1 EINVAL (Invalid argument)&#13;
stat("/usr/bin/Modules/Setup", 0x7ff) = -1 ENOENT (No such file)&#13;
stat("/usr/bin/lib/python2.7/os.py", 0x7ffd) = -1 ENOENT (No such file)&#13;
stat("/usr/bin/lib/python2.7/os.pyc", 0x7ff) = -1 ENOENT (No such file)&#13;
stat("/usr/lib/python2.7/os.py", {st_mode=S_IFREG|0644, ...}) = 0&#13;
stat("/usr/bin/pybuilddir.txt", 0x7ff) = -1 ENOENT (No such file)&#13;
stat("/usr/bin/lib/python2.7/lib-dynload", 0x7ff) = -1 ENOENT (No such file)&#13;
stat("/usr/lib/python2.7/lib-dynload", {st_mode=S_IFDIR|0755, ...}) = 0</pre>&#13;
&#13;
<p>This system is pretty old, and <code>python</code> in the output means <code>python2.7</code>, so it pokes around the filesystem to try and find the right executable. It goes through a few until it reaches <em>/usr/bin/python</em>, which is a link that points to <em>/usr/bin/python2</em>, which in turn is another link that sends the process to <em>/usr/bin/python2.7</em>. It then calls <code>stat</code> on <em>/usr/bin/Modules/Setup</em>, which we’ve never heard of as Python developers, only to continue to the <code>os</code> module.</p>&#13;
&#13;
<p>It continues to <em>pybuilddir.txt</em> and <em>lib-dynload</em>. What a trip. Without <code>strace</code> we would’ve probably tried to read the code that executes this to try and figure out where it goes next. But <code>strace</code> makes this tremendously easier, including all the interesting steps along the way, with useful information for each call.</p>&#13;
&#13;
<p>The tool has many flags that are worth looking into; for example, it can  <em>attach itself to a PID</em>. If you know the PID of a process, you can tell <code>strace</code> to produce output on what exactly is going on with it.</p>&#13;
&#13;
<p>One of those useful flags is <code>-f</code>; it will follow child processes as they are created by the initial program. In the example Python file, a call to <code>subprocess</code> is made, and it calls out to <code>ls</code>; if the command to <code>strace</code> is modified to use <code>-f</code>, the output becomes richer, with details about that call.</p>&#13;
&#13;
<p>When <em>follow.py</em> runs in the home directory, there are a quite a few differences with the <code>-f</code> flag. You can see calls to <code>lstat</code> and <code>readlink</code> for the dotfiles (some of which are symlinked):</p>&#13;
&#13;
<pre data-type="programlisting">[pid 30127] lstat(".vimrc", {st_mode=S_IFLNK|0777, st_size=29, ...}) = 0&#13;
[pid 30127] lgetxattr(".vimrc", "security.selinux", 0x55c5a36f4720, 255)&#13;
[pid 30127] readlink(".vimrc", "/home/alfredo/dotfiles/.vimrc", 30) = 29&#13;
[pid 30127] lstat(".config", {st_mode=S_IFDIR|0700, st_size=4096, ...}) = 0</pre>&#13;
&#13;
<p>Not only do the calls to these files show, but the PID is prefixed in the output, which helps identify which (child) process is doing what. A call to <code>strace</code> without the <code>-f</code> flag would not show a PID, for example.</p>&#13;
&#13;
<p>Finally, to analyze the output in detail, it can be helpful to save it to a file. This is possible with the <code>-o</code> flag:<a data-startref="ix_ch04-asciidoc23" data-type="indexterm" id="idm46691332459112"/><a data-startref="ix_ch04-asciidoc22" data-type="indexterm" id="idm46691332458376"/></p>&#13;
&#13;
<pre data-type="programlisting">$ strace -o output.txt python follow.py</pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before less_space" data-pdf-bookmark="Exercises" data-type="sect1"><div class="sect1" id="idm46691332492680">&#13;
<h1>Exercises</h1>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Define what IOPS is.</p>&#13;
</li>&#13;
<li>&#13;
<p>Explain what the difference is between throughput and IOPS.</p>&#13;
</li>&#13;
<li>&#13;
<p>Name a limitation with <code>fdisk</code> for creating partitions that <code>parted</code> doesn’t have.</p>&#13;
</li>&#13;
<li>&#13;
<p>Name three tools that can provide disk information.</p>&#13;
</li>&#13;
<li>&#13;
<p>What can an SSH tunnel do? When is it useful?</p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Case Study Question" data-type="sect1"><div class="sect1" id="idm46691332449784">&#13;
<h1>Case Study Question</h1>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Create a load test using the <code>molotov</code> tool that tests a <code>JSON</code> response from a server with an HTTP status of <code>200</code>.<a data-startref="ix_ch04-asciidoc0" data-type="indexterm" id="idm46691332367240"/></p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>