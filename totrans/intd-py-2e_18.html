<html><head></head><body><section data-pdf-bookmark="Chapter 16. Data in a Box: Persistent Storage" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch_databases">&#13;
<h1><span class="label">Chapter 16. </span>Data in a Box: Persistent Storage</h1>&#13;
&#13;
<blockquote>&#13;
<p><a data-primary="persistent storage" data-type="indexterm" id="ix_ch16-databases-asciidoc0"/>It is a capital mistake to theorize before one has data.</p>&#13;
<p data-type="attribution">Arthur Conan Doyle</p>&#13;
</blockquote>&#13;
&#13;
<p><a data-primary="RAM (Random Access Memory)" data-type="indexterm" id="idm45794978871592"/>An active program accesses data stored&#13;
in Random Access Memory, or RAM.&#13;
RAM is very fast,&#13;
but it is expensive and requires a constant supply of power;&#13;
if the power goes out, all the data in memory is lost.&#13;
Disk drives are slower than RAM but have more capacity,&#13;
cost less, and retain data even after someone trips over&#13;
the power cord.&#13;
Thus, a huge amount of effort in computer&#13;
systems has been devoted to making the best trade-offs&#13;
between storing data on disk and RAM.&#13;
<a data-primary="persistence (term)" data-type="indexterm" id="idm45794978870264"/>As programmers, we need <em>persistence</em>:&#13;
storing and retrieving&#13;
data using nonvolatile media such as disks.</p>&#13;
&#13;
<p>This chapter is all about the different flavors&#13;
of data storage, each optimized for different purposes:&#13;
flat files, structured files, and databases.&#13;
File operations other than input and output&#13;
are covered in <a data-type="xref" href="ch14.html#ch_files">Chapter 14</a>.</p>&#13;
&#13;
<p><a data-primary="record, defined" data-type="indexterm" id="idm45794978867320"/>A <em>record</em> is a term for one chunk of related data,&#13;
consisting of individual <em>fields</em>.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Flat Text Files" data-type="sect1"><div class="sect1" id="flat_txt_files">&#13;
<h1>Flat Text Files</h1>&#13;
&#13;
<p><a data-primary="flat file" data-type="indexterm" id="idm45794978863944"/><a data-primary="persistent storage" data-secondary="flat text files" data-type="indexterm" id="idm45794978863240"/><a data-primary="text files" data-secondary="flat" data-type="indexterm" id="idm45794978862296"/>The simplest persistence is a plain old flat file.&#13;
This works well if your data has a very simple structure&#13;
and you exchange all of it between disk and memory.&#13;
Plain text data might be suitable for this treatment.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Padded Text Files" data-type="sect1"><div class="sect1" id="padded_text_files">&#13;
<h1>Padded Text Files</h1>&#13;
&#13;
<p><a data-primary="padded text files" data-type="indexterm" id="idm45794978859304"/><a data-primary="persistent storage" data-secondary="padded text files" data-type="indexterm" id="idm45794978858600"/>In this format, each field in a record&#13;
has a fixed width, and is padded (usually with&#13;
space characters) to that width in the file,&#13;
giving each line (record) the same width.&#13;
<a data-primary="seek() function" data-type="indexterm" id="idm45794978857336"/>A programmer can use <code>seek()</code> to jump around the&#13;
file and only read and write the&#13;
records and fields that are needed.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Tabular Text Files" data-type="sect1"><div class="sect1" id="tabular_text_files">&#13;
<h1>Tabular Text Files</h1>&#13;
&#13;
<p><a data-primary="persistent storage" data-secondary="tabular text files" data-type="indexterm" id="ix_ch16-databases-asciidoc1"/><a data-primary="tabular text files" data-type="indexterm" id="ix_ch16-databases-asciidoc2"/><a data-primary="text files" data-secondary="tabular" data-type="indexterm" id="ix_ch16-databases-asciidoc3"/>With simple text files,&#13;
the only level of organization is the line.&#13;
Sometimes, you want more structure than that.&#13;
You might want to save data for your program to use later,&#13;
or send data to another program.</p>&#13;
&#13;
<p>There are many formats,&#13;
and here’s how you can distinguish them:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>A <em>separator</em>, or <em>delimiter</em>, character&#13;
like tab (<code>'\t'</code>),&#13;
comma (<code>','</code>), or vertical bar (<code>'|'</code>). This is an example of the&#13;
comma-separated values (CSV) format.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>'&lt;'</code> and <code>'&gt;'</code> around <em>tags</em>. Examples include XML and HTML.</p>&#13;
</li>&#13;
<li>&#13;
<p>Punctuation. An example is JavaScript Object Notation (JSON).</p>&#13;
</li>&#13;
<li>&#13;
<p>Indentation. An example is YAML (which is recursively defined as&#13;
“YAML Ain’t Markup Language”).</p>&#13;
</li>&#13;
<li>&#13;
<p>Miscellaneous, such as configuration files for programs.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Each of these structured file formats&#13;
can be read and written by at least one&#13;
Python module.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="CSV" data-type="sect2"><div class="sect2" id="csv">&#13;
<h2>CSV</h2>&#13;
&#13;
<p><a data-primary="CSV (comma-separated values) format" data-type="indexterm" id="ix_ch16-databases-asciidoc4"/><a data-primary="tabular text files" data-secondary="CSV" data-type="indexterm" id="ix_ch16-databases-asciidoc5"/><a data-primary="text files" data-secondary="CSV" data-type="indexterm" id="ix_ch16-databases-asciidoc6"/>Delimited files are often used as an exchange format&#13;
for spreadsheets and databases.&#13;
You could read CSV files manually,&#13;
a line at a time,&#13;
splitting each line into fields at comma separators,&#13;
and adding the results to data structures such as lists&#13;
and dictionaries.&#13;
But it’s better to use the standard <code>csv</code> module,&#13;
because parsing these files&#13;
can get more complicated than you think. Following are a few important characteristics to keep in mind when working with CSV:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Some have alternate delimiters besides a comma:&#13;
<code>'|'</code> and <code>'\t'</code> (tab) are <span class="keep-together">common.</span></p>&#13;
</li>&#13;
<li>&#13;
<p>Some have <em>escape sequences</em>.&#13;
If the delimiter character can occur within a field,&#13;
the entire field might be surrounded by quote characters&#13;
or preceded by some escape character.</p>&#13;
</li>&#13;
<li>&#13;
<p>Files have different line-ending characters.&#13;
Unix uses <code>'\n'</code>,&#13;
Microsoft uses <code>'\r\n'</code>,&#13;
and Apple used to use <code>'\r'</code> but now uses <code>'\n'</code>.</p>&#13;
</li>&#13;
<li>&#13;
<p>The first line may contain column names.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>First, we see how to read and write a list of rows,&#13;
each containing&#13;
a list of columns:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">csv</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">villains</code> <code class="o">=</code> <code class="p">[</code>&#13;
<code class="gp">... </code>    <code class="p">[</code><code class="s">'Doctor'</code><code class="p">,</code> <code class="s">'No'</code><code class="p">],</code>&#13;
<code class="gp">... </code>    <code class="p">[</code><code class="s">'Rosa'</code><code class="p">,</code> <code class="s">'Klebb'</code><code class="p">],</code>&#13;
<code class="gp">... </code>    <code class="p">[</code><code class="s">'Mister'</code><code class="p">,</code> <code class="s">'Big'</code><code class="p">],</code>&#13;
<code class="gp">... </code>    <code class="p">[</code><code class="s">'Auric'</code><code class="p">,</code> <code class="s">'Goldfinger'</code><code class="p">],</code>&#13;
<code class="gp">... </code>    <code class="p">[</code><code class="s">'Ernst'</code><code class="p">,</code> <code class="s">'Blofeld'</code><code class="p">],</code>&#13;
<code class="gp">... </code>    <code class="p">]</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="k">with</code> <code class="nb">open</code><code class="p">(</code><code class="s">'villains'</code><code class="p">,</code> <code class="s">'wt'</code><code class="p">)</code> <code class="k">as</code> <code class="n">fout</code><code class="p">:</code>  <code class="c"># a context manager</code>&#13;
<code class="gp">... </code>    <code class="n">csvout</code> <code class="o">=</code> <code class="n">csv</code><code class="o">.</code><code class="n">writer</code><code class="p">(</code><code class="n">fout</code><code class="p">)</code>&#13;
<code class="gp">... </code>    <code class="n">csvout</code><code class="o">.</code><code class="n">writerows</code><code class="p">(</code><code class="n">villains</code><code class="p">)</code></pre>&#13;
&#13;
<p>This creates the file <em>villains</em> with these lines:</p>&#13;
&#13;
<pre data-type="programlisting">Doctor,No&#13;
Rosa,Klebb&#13;
Mister,Big&#13;
Auric,Goldfinger&#13;
Ernst,Blofeld</pre>&#13;
&#13;
<p>Now, we try to read it back in:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">csv</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="k">with</code> <code class="nb">open</code><code class="p">(</code><code class="s">'villains'</code><code class="p">,</code> <code class="s">'rt'</code><code class="p">)</code> <code class="k">as</code> <code class="n">fin</code><code class="p">:</code>  <code class="c"># context manager</code>&#13;
<code class="gp">... </code>    <code class="n">cin</code> <code class="o">=</code> <code class="n">csv</code><code class="o">.</code><code class="n">reader</code><code class="p">(</code><code class="n">fin</code><code class="p">)</code>&#13;
<code class="gp">... </code>    <code class="n">villains</code> <code class="o">=</code> <code class="p">[</code><code class="n">row</code> <code class="k">for</code> <code class="n">row</code> <code class="ow">in</code> <code class="n">cin</code><code class="p">]</code>  <code class="c"># a list comprehension</code>&#13;
<code class="gp">...</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="k">print</code><code class="p">(</code><code class="n">villains</code><code class="p">)</code>&#13;
<code class="go">[['Doctor', 'No'], ['Rosa', 'Klebb'], ['Mister', 'Big'],</code>&#13;
<code class="go">['Auric', 'Goldfinger'], ['Ernst', 'Blofeld']]</code></pre>&#13;
&#13;
<p><a data-primary="reader() function" data-type="indexterm" id="idm45794978721000"/>We took advantage of&#13;
the structure created by the <code>reader()</code> function.&#13;
It created rows&#13;
in the <code>cin</code> object that we could extract in a <code>for</code> loop.</p>&#13;
&#13;
<p><a data-primary="writer() function" data-type="indexterm" id="idm45794978614392"/>Using <code>reader()</code> and <code>writer()</code> with their default options,&#13;
the columns are separated by commas&#13;
and the rows by line feeds.</p>&#13;
&#13;
<p>The data can be a list of dictionaries&#13;
rather than a list of lists.&#13;
<a data-primary="DictReader() function" data-type="indexterm" id="idm45794978612168"/>Let’s read the <em>villains</em> file again,&#13;
this time using the new <code>DictReader()</code>&#13;
function and specifying the column names:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">csv</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="k">with</code> <code class="nb">open</code><code class="p">(</code><code class="s">'villains'</code><code class="p">,</code> <code class="s">'rt'</code><code class="p">)</code> <code class="k">as</code> <code class="n">fin</code><code class="p">:</code>&#13;
<code class="gp">... </code>    <code class="n">cin</code> <code class="o">=</code> <code class="n">csv</code><code class="o">.</code><code class="n">DictReader</code><code class="p">(</code><code class="n">fin</code><code class="p">,</code> <code class="n">fieldnames</code><code class="o">=</code><code class="p">[</code><code class="s">'first'</code><code class="p">,</code> <code class="s">'last'</code><code class="p">])</code>&#13;
<code class="gp">... </code>    <code class="n">villains</code> <code class="o">=</code> <code class="p">[</code><code class="n">row</code> <code class="k">for</code> <code class="n">row</code> <code class="ow">in</code> <code class="n">cin</code><code class="p">]</code>&#13;
<code class="gp">...</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="k">print</code><code class="p">(</code><code class="n">villains</code><code class="p">)</code>&#13;
<code class="go">[OrderedDict([('first', 'Doctor'), ('last', 'No')]),</code>&#13;
<code class="go">OrderedDict([('first', 'Rosa'), ('last', 'Klebb')]),</code>&#13;
<code class="go">OrderedDict([('first', 'Mister'), ('last', 'Big')]),</code>&#13;
<code class="go">OrderedDict([('first', 'Auric'), ('last', 'Goldfinger')]),</code>&#13;
<code class="go">OrderedDict([('first', 'Ernst'), ('last', 'Blofeld')])]</code></pre>&#13;
&#13;
<p>That <code>OrderedDict</code> is there for compatibility with versions of&#13;
Python before 3.6, when dictionaries kept their order by default.</p>&#13;
&#13;
<p>Let’s rewrite the CSV file by using the new&#13;
<code>DictWriter()</code> function.&#13;
<a data-primary="writeheader() function" data-type="indexterm" id="idm45794978540808"/>We also call <code>writeheader()</code>&#13;
to write an initial line of column names&#13;
to the CSV file:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="go">import csv</code>&#13;
<code class="go">villains = [</code>&#13;
<code class="go">    {'first': 'Doctor', 'last': 'No'},</code>&#13;
<code class="go">    {'first': 'Rosa', 'last': 'Klebb'},</code>&#13;
<code class="go">    {'first': 'Mister', 'last': 'Big'},</code>&#13;
<code class="go">    {'first': 'Auric', 'last': 'Goldfinger'},</code>&#13;
<code class="go">    {'first': 'Ernst', 'last': 'Blofeld'},</code>&#13;
<code class="go">    ]</code>&#13;
<code class="go">with open('villains.txt', 'wt') as fout:</code>&#13;
<code class="go">    cout = csv.DictWriter(fout, ['first', 'last'])</code>&#13;
<code class="go">    cout.writeheader()</code>&#13;
<code class="go">    cout.writerows(villains)</code></pre>&#13;
&#13;
<p>That creates a <em>villains.csv</em> file with a header line (<a data-type="xref" href="#villains_csv">Example 16-1</a>).</p>&#13;
<div data-type="example" id="villains_csv">&#13;
<h5><span class="label">Example 16-1. </span>villains.csv</h5>&#13;
&#13;
<pre data-type="programlisting">first,last&#13;
Doctor,No&#13;
Rosa,Klebb&#13;
Mister,Big&#13;
Auric,Goldfinger&#13;
Ernst,Blofeld</pre></div>&#13;
&#13;
<p>Now, let’s read it back.&#13;
By omitting the <code>fieldnames</code> argument&#13;
in the <code>DictReader()</code> call, we tell it to&#13;
use the values in the first line of the file&#13;
(<code>first,last</code>)&#13;
as column labels and matching&#13;
dictionary keys:<a data-startref="ix_ch16-databases-asciidoc6" data-type="indexterm" id="idm45794978528120"/><a data-startref="ix_ch16-databases-asciidoc5" data-type="indexterm" id="idm45794978527352"/><a data-startref="ix_ch16-databases-asciidoc4" data-type="indexterm" id="idm45794978526664"/></p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">csv</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="k">with</code> <code class="nb">open</code><code class="p">(</code><code class="s">'villains.csv'</code><code class="p">,</code> <code class="s">'rt'</code><code class="p">)</code> <code class="k">as</code> <code class="n">fin</code><code class="p">:</code>&#13;
<code class="gp">... </code>    <code class="n">cin</code> <code class="o">=</code> <code class="n">csv</code><code class="o">.</code><code class="n">DictReader</code><code class="p">(</code><code class="n">fin</code><code class="p">)</code>&#13;
<code class="gp">... </code>    <code class="n">villains</code> <code class="o">=</code> <code class="p">[</code><code class="n">row</code> <code class="k">for</code> <code class="n">row</code> <code class="ow">in</code> <code class="n">cin</code><code class="p">]</code>&#13;
<code class="gp">...</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="k">print</code><code class="p">(</code><code class="n">villains</code><code class="p">)</code>&#13;
<code class="go">[OrderedDict([('first', 'Doctor'), ('last', 'No')]),</code>&#13;
<code class="go">OrderedDict([('first', 'Rosa'), ('last', 'Klebb')]),</code>&#13;
<code class="go">OrderedDict([('first', 'Mister'), ('last', 'Big')]),</code>&#13;
<code class="go">OrderedDict([('first', 'Auric'), ('last', 'Goldfinger')]),</code>&#13;
<code class="go">OrderedDict([('first', 'Ernst'), ('last', 'Blofeld')])]</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="XML" data-type="sect2"><div class="sect2" id="xml">&#13;
<h2>XML</h2>&#13;
&#13;
<p><a data-primary="tabular text files" data-secondary="XML" data-type="indexterm" id="ix_ch16-databases-asciidoc7"/><a data-primary="text files" data-secondary="XML" data-type="indexterm" id="ix_ch16-databases-asciidoc8"/><a data-primary="XML (Extensible Markup Language) format" data-type="indexterm" id="ix_ch16-databases-asciidoc9"/>Delimited files convey only two dimensions:&#13;
rows (lines) and columns (fields within a line).&#13;
If you want to exchange data structures among programs,&#13;
you need a way to encode hierarchies, sequences, sets,&#13;
and other structures as text.</p>&#13;
&#13;
<p>XML is a prominent <em>markup</em> format that does this.&#13;
It uses <em>tags</em> to delimit data,&#13;
as in this sample <em>menu.xml</em> file:</p>&#13;
&#13;
<pre data-type="programlisting">&lt;?xml version="1.0"?&gt;&#13;
&lt;menu&gt;&#13;
  &lt;breakfast hours="7-11"&gt;&#13;
    &lt;item price="$6.00"&gt;breakfast burritos&lt;/item&gt;&#13;
    &lt;item price="$4.00"&gt;pancakes&lt;/item&gt;&#13;
  &lt;/breakfast&gt;&#13;
  &lt;lunch hours="11-3"&gt;&#13;
    &lt;item price="$5.00"&gt;hamburger&lt;/item&gt;&#13;
  &lt;/lunch&gt;&#13;
  &lt;dinner hours="3-10"&gt;&#13;
    &lt;item price="8.00"&gt;spaghetti&lt;/item&gt;&#13;
  &lt;/dinner&gt;&#13;
&lt;/menu&gt;</pre>&#13;
&#13;
<p>Following are a few important characteristics of XML:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Tags begin with a <code>&lt;</code> character.&#13;
The tags in this sample were <code>menu</code>, <code>breakfast</code>,&#13;
<code>lunch</code>, <code>dinner</code>, and <code>item</code>.</p>&#13;
</li>&#13;
<li>&#13;
<p>Whitespace is ignored.</p>&#13;
</li>&#13;
<li>&#13;
<p>Usually a <em>start tag</em> such as <code>&lt;menu&gt;</code> is followed by&#13;
other content and then a final matching&#13;
<em>end tag</em> such as <code>&lt;/menu&gt;</code>.</p>&#13;
</li>&#13;
<li>&#13;
<p>Tags can <em>nest</em> within other tags to any level.&#13;
In this example, <code>item</code> tags are children of the <code>breakfast</code>, <code>lunch</code>,&#13;
and <code>dinner</code> tags;&#13;
they, in turn, are children of <code>menu</code>.</p>&#13;
</li>&#13;
<li>&#13;
<p>Optional <em>attributes</em> can occur within the start tag.&#13;
In this example, <code>price</code> is an attribute of <code>item</code>.</p>&#13;
</li>&#13;
<li>&#13;
<p>Tags can contain <em>values</em>.&#13;
In this example, each <code>item</code> has a value,&#13;
such as <code>pancakes</code> for the second breakfast item.</p>&#13;
</li>&#13;
<li>&#13;
<p>If a tag named <code>thing</code>&#13;
has no values or children,&#13;
it can be expressed as the single tag by&#13;
including a forward slash just before&#13;
the closing angle bracket, such as <code>&lt;thing/&gt;</code>,&#13;
rather than a start and end tag,&#13;
like&#13;
<code>&lt;thing&gt;&lt;/thing&gt;</code>.</p>&#13;
</li>&#13;
<li>&#13;
<p>The choice of where to put data—attributes, values,&#13;
child tags—is somewhat arbitrary.&#13;
For instance,&#13;
we could have written&#13;
the last <code>item</code> tag as&#13;
<code>&lt;item price="$8.00" food="spaghetti"/&gt;</code>.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>XML is often used for data <em>feeds</em> and <em>messages</em>&#13;
and has subformats like RSS and Atom.&#13;
Some industries have many specialized XML formats,&#13;
such as the&#13;
<a href="http://bit.ly/xml-finance">finance field</a>.</p>&#13;
&#13;
<p>XML’s über-flexibility has inspired&#13;
multiple Python libraries that differ in&#13;
approach and capabilities.</p>&#13;
&#13;
<p><a data-primary="ElementTree module" data-type="indexterm" id="idm45794978375224"/>The simplest way to parse XML&#13;
in Python is by using the standard <code>ElementTree</code> module.&#13;
Here’s a little program to parse&#13;
the <em>menu.xml</em> file and print&#13;
some tags and attributes:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">xml.etree.ElementTree</code> <code class="kn">as</code> <code class="nn">et</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">tree</code> <code class="o">=</code> <code class="n">et</code><code class="o">.</code><code class="n">ElementTree</code><code class="p">(</code><code class="nb">file</code><code class="o">=</code><code class="s">'menu.xml'</code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">root</code> <code class="o">=</code> <code class="n">tree</code><code class="o">.</code><code class="n">getroot</code><code class="p">()</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">root</code><code class="o">.</code><code class="n">tag</code>&#13;
<code class="go">'menu'</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="k">for</code> <code class="n">child</code> <code class="ow">in</code> <code class="n">root</code><code class="p">:</code>&#13;
<code class="gp">... </code>    <code class="k">print</code><code class="p">(</code><code class="s">'tag:'</code><code class="p">,</code> <code class="n">child</code><code class="o">.</code><code class="n">tag</code><code class="p">,</code> <code class="s">'attributes:'</code><code class="p">,</code> <code class="n">child</code><code class="o">.</code><code class="n">attrib</code><code class="p">)</code>&#13;
<code class="gp">... </code>    <code class="k">for</code> <code class="n">grandchild</code> <code class="ow">in</code> <code class="n">child</code><code class="p">:</code>&#13;
<code class="gp">... </code>        <code class="k">print</code><code class="p">(</code><code class="s">'</code><code class="se">\t</code><code class="s">tag:'</code><code class="p">,</code> <code class="n">grandchild</code><code class="o">.</code><code class="n">tag</code><code class="p">,</code> <code class="s">'attributes:'</code><code class="p">,</code> <code class="n">grandchild</code><code class="o">.</code><code class="n">attrib</code><code class="p">)</code>&#13;
<code class="gp">...</code>&#13;
<code class="go">tag: breakfast attributes: {'hours': '7-11'}</code>&#13;
<code class="go">    tag: item attributes: {'price': '$6.00'}</code>&#13;
<code class="go">    tag: item attributes: {'price': '$4.00'}</code>&#13;
<code class="go">tag: lunch attributes: {'hours': '11-3'}</code>&#13;
<code class="go">    tag: item attributes: {'price': '$5.00'}</code>&#13;
<code class="go">tag: dinner attributes: {'hours': '3-10'}</code>&#13;
<code class="go">    tag: item attributes: {'price': '8.00'}</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="nb">len</code><code class="p">(</code><code class="n">root</code><code class="p">)</code>     <code class="c"># number of menu sections</code>&#13;
<code class="go">3</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="nb">len</code><code class="p">(</code><code class="n">root</code><code class="p">[</code><code class="mi">0</code><code class="p">])</code>  <code class="c"># number of breakfast items</code>&#13;
<code class="go">2</code></pre>&#13;
&#13;
<p>For each element in the nested lists,&#13;
<code>tag</code> is the tag string&#13;
and <code>attrib</code> is a dictionary of its attributes.&#13;
<code>ElementTree</code> has many other ways of searching&#13;
XML-derived data,&#13;
modifying it,&#13;
and even writing XML files.&#13;
The <code>ElementTree</code>&#13;
<a href="http://bit.ly/elementtree">documentation</a>&#13;
has the details.</p>&#13;
&#13;
<p>Other standard Python XML libraries include the following:</p>&#13;
<dl>&#13;
<dt><code>xml.dom</code></dt>&#13;
<dd>&#13;
<p>The Document Object Model (DOM),&#13;
familiar to JavaScript developers, represents&#13;
web documents as hierarchical structures.&#13;
This module loads the entire XML file into&#13;
memory and lets you access all the pieces equally.</p>&#13;
</dd>&#13;
<dt><code>xml.sax</code></dt>&#13;
<dd>&#13;
<p>Simple API for XML, or SAX,&#13;
parses XML on the fly,&#13;
so it does not have to load everything into memory at once.&#13;
Therefore, it can be a good choice&#13;
if you need to process very large streams of XML.</p>&#13;
</dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="An XML Security Note" data-type="sect2"><div class="sect2" id="xml_security">&#13;
<h2>An XML Security Note</h2>&#13;
&#13;
<p><a data-primary="security issues" data-secondary="XML and" data-type="indexterm" id="idm45794978249336"/>You can use all the formats described in this chapter to save&#13;
objects to files and read them back again.&#13;
It’s possible to exploit this process&#13;
and cause security problems.</p>&#13;
&#13;
<p>For example, the following XML snippet from the billion laughs&#13;
Wikipedia page&#13;
defines 10 nested entities, each expanding&#13;
the lower level 10 times for a total expansion of&#13;
one billion:</p>&#13;
&#13;
<pre data-type="programlisting">&lt;?xml version="1.0"?&gt;&#13;
&lt;!DOCTYPE lolz [&#13;
 &lt;!ENTITY lol "lol"&gt;&#13;
 &lt;!ENTITY lol1 "&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;"&gt;&#13;
 &lt;!ENTITY lol2 "&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;"&gt;&#13;
 &lt;!ENTITY lol3 "&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;"&gt;&#13;
 &lt;!ENTITY lol4 "&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;"&gt;&#13;
 &lt;!ENTITY lol5 "&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;"&gt;&#13;
 &lt;!ENTITY lol6 "&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;"&gt;&#13;
 &lt;!ENTITY lol7 "&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;"&gt;&#13;
 &lt;!ENTITY lol8 "&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;"&gt;&#13;
 &lt;!ENTITY lol9 "&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;"&gt;&#13;
]&gt;&#13;
&lt;lolz&gt;&amp;lol9;&lt;/lolz&gt;</pre>&#13;
&#13;
<p>The bad news: billion laughs would&#13;
blow up all of the XML libraries&#13;
mentioned in the previous sections.&#13;
<a href="https://bitbucket.org/tiran/defusedxml">Defused XML</a>&#13;
lists this attack and others,&#13;
along with the vulnerability of Python libraries.</p>&#13;
&#13;
<p>The link shows how to change the settings&#13;
for many of the libraries to avoid these problems.&#13;
Also, you can use the <code>defusedxml</code> library as a security&#13;
frontend for the other libraries:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="c"># insecure:</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="kn">from</code> <code class="nn">xml.etree.ElementTree</code> <code class="kn">import</code> <code class="n">parse</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">et</code> <code class="o">=</code> <code class="n">parse</code><code class="p">(</code><code class="n">xmlfile</code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="c"># protected:</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="kn">from</code> <code class="nn">defusedxml.ElementTree</code> <code class="kn">import</code> <code class="n">parse</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">et</code> <code class="o">=</code> <code class="n">parse</code><code class="p">(</code><code class="n">xmlfile</code><code class="p">)</code></pre>&#13;
&#13;
<p>The standard Python site also has its own page on&#13;
<a href="https://oreil.ly/Rnsiw">XML vulnerabilities</a>.<a data-startref="ix_ch16-databases-asciidoc9" data-type="indexterm" id="idm45794978218760"/><a data-startref="ix_ch16-databases-asciidoc8" data-type="indexterm" id="idm45794978218152"/><a data-startref="ix_ch16-databases-asciidoc7" data-type="indexterm" id="idm45794978217544"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="HTML" data-type="sect2"><div class="sect2" id="html_files">&#13;
<h2>HTML</h2>&#13;
&#13;
<p><a data-primary="HTML (Hypertext Markup Language)" data-type="indexterm" id="idm45794978215336"/><a data-primary="tabular text files" data-secondary="HTML" data-type="indexterm" id="idm45794978214664"/><a data-primary="text files" data-secondary="HTML" data-type="indexterm" id="idm45794978213720"/>Gigagobs of data are saved as Hypertext Markup Language (HTML),&#13;
the basic document format of the web.&#13;
The problem is that much of it doesn’t follow the HTML rules,&#13;
which can make it difficult to parse.&#13;
HTML is a better display format than&#13;
a data interchange format.&#13;
Because this chapter is intended to describe&#13;
fairly well-defined data formats,&#13;
I’ve separated out the discussion about HTML to <a data-type="xref" href="ch18.html#ch_web">Chapter 18</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="JSON" data-type="sect2"><div class="sect2" id="json_files">&#13;
<h2>JSON</h2>&#13;
&#13;
<p><a data-primary="JSON (JavaScript Object Notation)" data-type="indexterm" id="ix_ch16-databases-asciidoc10"/><a data-primary="tabular text files" data-secondary="JSON" data-type="indexterm" id="ix_ch16-databases-asciidoc11"/><a data-primary="text files" data-secondary="JSON" data-type="indexterm" id="ix_ch16-databases-asciidoc12"/><a href="http://www.json.org">JavaScript Object Notation (JSON)</a>&#13;
has become a very&#13;
popular data interchange format,&#13;
beyond its JavaScript origins.&#13;
The JSON format is a subset of JavaScript,&#13;
and often legal Python syntax, as well.&#13;
Its close fit to Python&#13;
makes it a good choice for data&#13;
interchange among programs.&#13;
You’ll see many examples of JSON&#13;
for web development&#13;
in <a data-type="xref" href="ch18.html#ch_web">Chapter 18</a>.</p>&#13;
&#13;
<p>Unlike the variety of XML modules,&#13;
there’s one main JSON module,&#13;
with the unforgettable name <code>json</code>.&#13;
This program encodes (dumps) data to a JSON string&#13;
and decodes (loads) a JSON string back to data.&#13;
In this next example,&#13;
let’s build a Python data structure containing&#13;
the data from the earlier XML example:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">menu</code> <code class="o">=</code> \&#13;
<code class="gp">... </code><code class="p">{</code>&#13;
<code class="gp">... </code><code class="s">"breakfast"</code><code class="p">:</code> <code class="p">{</code>&#13;
<code class="gp">... </code>        <code class="s">"hours"</code><code class="p">:</code> <code class="s">"7-11"</code><code class="p">,</code>&#13;
<code class="gp">... </code>        <code class="s">"items"</code><code class="p">:</code> <code class="p">{</code>&#13;
<code class="gp">... </code>                <code class="s">"breakfast burritos"</code><code class="p">:</code> <code class="s">"$6.00"</code><code class="p">,</code>&#13;
<code class="gp">... </code>                <code class="s">"pancakes"</code><code class="p">:</code> <code class="s">"$4.00"</code>&#13;
<code class="gp">... </code>                <code class="p">}</code>&#13;
<code class="gp">... </code>        <code class="p">},</code>&#13;
<code class="gp">... </code><code class="s">"lunch"</code> <code class="p">:</code> <code class="p">{</code>&#13;
<code class="gp">... </code>        <code class="s">"hours"</code><code class="p">:</code> <code class="s">"11-3"</code><code class="p">,</code>&#13;
<code class="gp">... </code>        <code class="s">"items"</code><code class="p">:</code> <code class="p">{</code>&#13;
<code class="gp">... </code>                <code class="s">"hamburger"</code><code class="p">:</code> <code class="s">"$5.00"</code>&#13;
<code class="gp">... </code>                <code class="p">}</code>&#13;
<code class="gp">... </code>        <code class="p">},</code>&#13;
<code class="gp">... </code><code class="s">"dinner"</code><code class="p">:</code> <code class="p">{</code>&#13;
<code class="gp">... </code>        <code class="s">"hours"</code><code class="p">:</code> <code class="s">"3-10"</code><code class="p">,</code>&#13;
<code class="gp">... </code>        <code class="s">"items"</code><code class="p">:</code> <code class="p">{</code>&#13;
<code class="gp">... </code>                <code class="s">"spaghetti"</code><code class="p">:</code> <code class="s">"$8.00"</code>&#13;
<code class="gp">... </code>                <code class="p">}</code>&#13;
<code class="gp">... </code>        <code class="p">}</code>&#13;
<code class="gp">... </code><code class="p">}</code>&#13;
<code class="go">.</code></pre>&#13;
&#13;
<p>Next, encode the data structure (<code>menu</code>) to a JSON string&#13;
(<code>menu_json</code>) by using <code>dumps()</code>:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">json</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">menu_json</code> <code class="o">=</code> <code class="n">json</code><code class="o">.</code><code class="n">dumps</code><code class="p">(</code><code class="n">menu</code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">menu_json</code>&#13;
<code class="go">'{"dinner": {"items": {"spaghetti": "$8.00"}, "hours": "3-10"},</code>&#13;
<code class="go">"lunch": {"items": {"hamburger": "$5.00"}, "hours": "11-3"},</code>&#13;
<code class="go">"breakfast": {"items": {"breakfast burritos": "$6.00", "pancakes":</code>&#13;
<code class="go">"$4.00"}, "hours": "7-11"}}'</code></pre>&#13;
&#13;
<p>And now, let’s turn the JSON string <code>menu_json</code> back into a Python&#13;
data structure (<code>menu2</code>) by using <code>loads()</code>:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">menu2</code> <code class="o">=</code> <code class="n">json</code><code class="o">.</code><code class="n">loads</code><code class="p">(</code><code class="n">menu_json</code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">menu2</code>&#13;
<code class="go">{'breakfast': {'items': {'breakfast burritos': '$6.00', 'pancakes':</code>&#13;
<code class="go">'$4.00'}, 'hours': '7-11'}, 'lunch': {'items': {'hamburger': '$5.00'},</code>&#13;
<code class="go">'hours': '11-3'}, 'dinner': {'items': {'spaghetti': '$8.00'}, 'hours': '3-10'}}</code></pre>&#13;
&#13;
<p><code>menu</code> and <code>menu2</code> are both dictionaries&#13;
with the same keys and values.</p>&#13;
&#13;
<p><a data-primary="datetime object" data-type="indexterm" id="idm45794978000328"/>You might get an exception while trying to encode&#13;
or decode some objects, including objects such as <code>datetime</code>&#13;
(covered in detail in <a data-type="xref" href="ch13.html#ch_times">Chapter 13</a>), as demonstrated here:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">datetime</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">json</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">now</code> <code class="o">=</code> <code class="n">datetime</code><code class="o">.</code><code class="n">datetime</code><code class="o">.</code><code class="n">utcnow</code><code class="p">()</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">now</code>&#13;
<code class="go">datetime.datetime(2013, 2, 22, 3, 49, 27, 483336)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">json</code><code class="o">.</code><code class="n">dumps</code><code class="p">(</code><code class="n">now</code><code class="p">)</code>&#13;
<code class="gt">Traceback (most recent call last):</code>&#13;
<code class="err"># ... (deleted stack trace to save trees)</code>&#13;
<code class="go">TypeError: datetime.datetime(2013, 2, 22, 3, 49, 27, 483336)</code>&#13;
<code class="go">  is not JSON serializable</code>&#13;
<code class="go">&gt;&gt;&gt;</code></pre>&#13;
&#13;
<p>This can happen because the JSON standard does not define&#13;
date or time types; it expects you to define how to handle them.&#13;
You could convert the <code>datetime</code> to something&#13;
JSON understands, such as a string&#13;
or an <em>epoch</em> value (see <a data-type="xref" href="ch13.html#ch_times">Chapter 13</a>):</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">now_str</code> <code class="o">=</code> <code class="nb">str</code><code class="p">(</code><code class="n">now</code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">json</code><code class="o">.</code><code class="n">dumps</code><code class="p">(</code><code class="n">now_str</code><code class="p">)</code>&#13;
<code class="go">'"2013-02-22 03:49:27.483336"'</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="kn">from</code> <code class="nn">time</code> <code class="kn">import</code> <code class="n">mktime</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">now_epoch</code> <code class="o">=</code> <code class="nb">int</code><code class="p">(</code><code class="n">mktime</code><code class="p">(</code><code class="n">now</code><code class="o">.</code><code class="n">timetuple</code><code class="p">()))</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">json</code><code class="o">.</code><code class="n">dumps</code><code class="p">(</code><code class="n">now_epoch</code><code class="p">)</code>&#13;
<code class="go">'1361526567'</code></pre>&#13;
&#13;
<p>If the <code>datetime</code> value could occur in the middle&#13;
of normally converted data types,&#13;
it might be annoying to make these special&#13;
conversions.&#13;
You can modify how JSON is encoded&#13;
by using inheritance,&#13;
which is described in <a data-type="xref" href="ch10.html#ch_objects">Chapter 10</a>.&#13;
Python’s JSON <a href="http://bit.ly/json-docs">documentation</a>&#13;
gives an example of this for complex numbers,&#13;
which also makes JSON play dead.&#13;
Let’s modify it for <code>datetime</code>:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">datetime</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">now</code> <code class="o">=</code> <code class="n">datetime</code><code class="o">.</code><code class="n">datetime</code><code class="o">.</code><code class="n">utcnow</code><code class="p">()</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="k">class</code> <code class="nc">DTEncoder</code><code class="p">(</code><code class="n">json</code><code class="o">.</code><code class="n">JSONEncoder</code><code class="p">):</code>&#13;
<code class="gp">... </code>    <code class="k">def</code> <code class="nf">default</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">obj</code><code class="p">):</code>&#13;
<code class="gp">... </code>        <code class="c"># isinstance() checks the type of obj</code>&#13;
<code class="gp">... </code>        <code class="k">if</code> <code class="nb">isinstance</code><code class="p">(</code><code class="n">obj</code><code class="p">,</code> <code class="n">datetime</code><code class="o">.</code><code class="n">datetime</code><code class="p">):</code>&#13;
<code class="gp">... </code>            <code class="k">return</code> <code class="nb">int</code><code class="p">(</code><code class="n">mktime</code><code class="p">(</code><code class="n">obj</code><code class="o">.</code><code class="n">timetuple</code><code class="p">()))</code>&#13;
<code class="gp">... </code>        <code class="c"># else it's something the normal decoder knows:</code>&#13;
<code class="gp">... </code>        <code class="k">return</code> <code class="n">json</code><code class="o">.</code><code class="n">JSONEncoder</code><code class="o">.</code><code class="n">default</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">obj</code><code class="p">)</code>&#13;
<code class="gp">...</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">json</code><code class="o">.</code><code class="n">dumps</code><code class="p">(</code><code class="n">now</code><code class="p">,</code> <code class="n">cls</code><code class="o">=</code><code class="n">DTEncoder</code><code class="p">)</code>&#13;
<code class="go">'1361526567'</code></pre>&#13;
&#13;
<p>The new class <code>DTEncoder</code> is a subclass, or child class,&#13;
of <code>JSONEncoder</code>.&#13;
We need to override its only <code>default()</code> method&#13;
to add <code>datetime</code> handling.&#13;
Inheritance ensures that everything else will be&#13;
handled by the parent class.</p>&#13;
&#13;
<p>The <code>isinstance()</code> function checks whether the object <code>obj</code>&#13;
is of the class <code>datetime.datetime</code>.&#13;
Because everything in Python is an object,&#13;
<code>isinstance()</code> works everywhere:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">datetime</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">now</code> <code class="o">=</code> <code class="n">datetime</code><code class="o">.</code><code class="n">datetime</code><code class="o">.</code><code class="n">utcnow</code><code class="p">()</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="nb">type</code><code class="p">(</code><code class="n">now</code><code class="p">)</code>&#13;
<code class="go">&lt;class 'datetime.datetime'&gt;</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="nb">isinstance</code><code class="p">(</code><code class="n">now</code><code class="p">,</code> <code class="n">datetime</code><code class="o">.</code><code class="n">datetime</code><code class="p">)</code>&#13;
<code class="go">True</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="nb">type</code><code class="p">(</code><code class="mi">234</code><code class="p">)</code>&#13;
<code class="go">&lt;class 'int'&gt;</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="nb">isinstance</code><code class="p">(</code><code class="mi">234</code><code class="p">,</code> <code class="nb">int</code><code class="p">)</code>&#13;
<code class="go">True</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="nb">type</code><code class="p">(</code><code class="s">'hey'</code><code class="p">)</code>&#13;
<code class="go">&lt;class 'str'&gt;</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="nb">isinstance</code><code class="p">(</code><code class="s">'hey'</code><code class="p">,</code> <code class="nb">str</code><code class="p">)</code>&#13;
<code class="go">True</code></pre>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>For JSON and other structured  text formats,&#13;
you can load from a file into data structures&#13;
without knowing anything about the structures ahead of time.&#13;
Then, you can walk through the structures by&#13;
using <code>isinstance()</code> and type-appropriate methods&#13;
to examine their values.&#13;
For example, if one of the items is a dictionary,&#13;
you can extract contents through&#13;
<code>keys()</code>, <code>values()</code>, and <code>items()</code>.</p>&#13;
</div>&#13;
&#13;
<p>After making you do it the hard way,&#13;
it turns out that there’s an even easier way to convert&#13;
<code>datetime</code> objects to JSON:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">datetime</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">json</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">now</code> <code class="o">=</code> <code class="n">datetime</code><code class="o">.</code><code class="n">datetime</code><code class="o">.</code><code class="n">utcnow</code><code class="p">()</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">json</code><code class="o">.</code><code class="n">dumps</code><code class="p">(</code><code class="n">now</code><code class="p">,</code> <code class="n">default</code><code class="o">=</code><code class="nb">str</code><code class="p">)</code>&#13;
<code class="go">'"2019-04-17 21:54:43.617337"'</code></pre>&#13;
&#13;
<p>That <code>default=str</code> tells <code>json.dumps()</code> to apply the&#13;
<code>str()</code> conversion function for data types&#13;
that it doesn’t understand.&#13;
This works because the definition of the <code>datetime.datetime</code>&#13;
class includes a <code>__str__()</code> method.<a data-startref="ix_ch16-databases-asciidoc12" data-type="indexterm" id="idm45794977521432"/><a data-startref="ix_ch16-databases-asciidoc11" data-type="indexterm" id="idm45794977520728"/><a data-startref="ix_ch16-databases-asciidoc10" data-type="indexterm" id="idm45794977520088"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="YAML" data-type="sect2"><div class="sect2" id="yaml">&#13;
<h2>YAML</h2>&#13;
&#13;
<p><a data-primary="tabular text files" data-secondary="YAML" data-type="indexterm" id="ix_ch16-databases-asciidoc13"/><a data-primary="text files" data-secondary="YAML" data-type="indexterm" id="ix_ch16-databases-asciidoc14"/><a data-primary="YAML (YAML Aint Markup Language)" data-type="indexterm" id="ix_ch16-databases-asciidoc15"/>Similar to JSON, <a href="http://www.yaml.org">YAML</a> has keys and values,&#13;
but handles more data types such as dates and times.&#13;
The standard Python library does not yet include&#13;
YAML handling, so you need to install a third-party library named&#13;
<a href="http://pyyaml.org/wiki/PyYAML"><code>yaml</code></a>&#13;
to manipulate it.&#13;
<code>((("dump() function")))((("load() function")))load()</code> converts a YAML string to Python data,&#13;
whereas <code>dump()</code> does the opposite.</p>&#13;
&#13;
<p>The following YAML file, <em>mcintyre.yaml</em>, contains&#13;
information on the Canadian poet James McIntyre,&#13;
including two of his poems:</p>&#13;
&#13;
<pre data-type="programlisting">name:&#13;
  first: James&#13;
  last: McIntyre&#13;
dates:&#13;
  birth: 1828-05-25&#13;
  death: 1906-03-31&#13;
details:&#13;
  bearded: true&#13;
  themes: [cheese, Canada]&#13;
books:&#13;
  url: http://www.gutenberg.org/files/36068/36068-h/36068-h.htm&#13;
poems:&#13;
  - title: 'Motto'&#13;
    text: |&#13;
      Politeness, perseverance and pluck,&#13;
      To their possessor will bring good luck.&#13;
  - title: 'Canadian Charms'&#13;
    text: |&#13;
      Here industry is not in vain,&#13;
      For we have bounteous crops of grain,&#13;
      And you behold on every field&#13;
      Of grass and roots abundant yield,&#13;
      But after all the greatest charm&#13;
      Is the snug home upon the farm,&#13;
      And stone walls now keep cattle warm.</pre>&#13;
&#13;
<p>Values such as <code>true</code>, <code>false</code>, <code>on</code>, and <code>off</code>&#13;
are converted to Python booleans.&#13;
Integers and strings are converted to their&#13;
Python equivalents.&#13;
Other syntax creates lists and dictionaries:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">yaml</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="k">with</code> <code class="nb">open</code><code class="p">(</code><code class="s">'mcintyre.yaml'</code><code class="p">,</code> <code class="s">'rt'</code><code class="p">)</code> <code class="k">as</code> <code class="n">fin</code><code class="p">:</code>&#13;
<code class="gp">&gt;&gt;&gt; </code>    <code class="n">text</code> <code class="o">=</code> <code class="n">fin</code><code class="o">.</code><code class="n">read</code><code class="p">()</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">data</code> <code class="o">=</code> <code class="n">yaml</code><code class="o">.</code><code class="n">load</code><code class="p">(</code><code class="n">text</code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">data</code><code class="p">[</code><code class="s">'details'</code><code class="p">]</code>&#13;
<code class="go">{'themes': ['cheese', 'Canada'], 'bearded': True}</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="nb">len</code><code class="p">(</code><code class="n">data</code><code class="p">[</code><code class="s">'poems'</code><code class="p">])</code>&#13;
<code class="go">2</code></pre>&#13;
&#13;
<p>The data structures that are created match those&#13;
in the YAML file,&#13;
which in this case are more than one level deep in places.&#13;
You can get the title of the second poem with this&#13;
dict/list/dict reference:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">data</code><code class="p">[</code><code class="s">'poems'</code><code class="p">][</code><code class="mi">1</code><code class="p">][</code><code class="s">'title'</code><code class="p">]</code>&#13;
<code class="go">'Canadian Charms'</code></pre>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>PyYAML can load Python objects from strings,&#13;
and this is dangerous.&#13;
<a data-primary="load() function" data-type="indexterm" id="idm45794977412024"/><a data-primary="safe_load () function" data-type="indexterm" id="idm45794977411384"/>Use <code>safe_load()</code> instead of <code>load()</code> if you’re&#13;
importing YAML that you don’t trust.&#13;
Better yet, <em>always</em> use <code>safe_load()</code>.&#13;
Read Ned Batchelder’s blog post <a href="http://bit.ly/war-is-peace">“War is Peace”</a>&#13;
for a description of how unprotected YAML loading&#13;
compromised the Ruby on Rails platform.<a data-startref="ix_ch16-databases-asciidoc15" data-type="indexterm" id="idm45794977448280"/><a data-startref="ix_ch16-databases-asciidoc14" data-type="indexterm" id="idm45794977447608"/><a data-startref="ix_ch16-databases-asciidoc13" data-type="indexterm" id="idm45794977446968"/></p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Tablib" data-type="sect2"><div class="sect2" id="tablib">&#13;
<h2>Tablib</h2>&#13;
&#13;
<p><a data-primary="tablib" data-type="indexterm" id="idm45794977444888"/><a data-primary="tabular text files" data-secondary="tablib" data-type="indexterm" id="idm45794977443960"/><a data-primary="text files" data-secondary="tablib" data-type="indexterm" id="idm45794977443016"/>After reading all of the previous sections,&#13;
there’s one third-party package that lets you import, export,&#13;
and edit tabular data in&#13;
CSV, JSON, <em>or</em> YAML&#13;
format,<sup><a data-type="noteref" href="ch16.html#idm45794977436440" id="idm45794977436440-marker">1</a></sup>&#13;
as well as&#13;
Microsoft Excel,&#13;
Pandas DataFrame,&#13;
and a few others.&#13;
You install it with the familiar refrain&#13;
(<code>pip install tablib</code>),&#13;
and peek at the&#13;
<a href="http://docs.python-tablib.org">docs</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Pandas" data-type="sect2"><div class="sect2" id="pandas">&#13;
<h2>Pandas</h2>&#13;
&#13;
<p><a data-primary="pandas" data-type="indexterm" id="idm45794977432456"/><a data-primary="tabular text files" data-secondary="pandas" data-type="indexterm" id="idm45794977431752"/><a data-primary="text files" data-secondary="pandas" data-type="indexterm" id="idm45794977430808"/>This is as good place as any to introduce&#13;
<a href="https://pandas.pydata.org">pandas</a>—a Python library for structured data.&#13;
It’s an excellent tool for handling real-life data issues:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Read and write many text and binary file formats:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Text, with fields separated by commas (CSV), tabs (TSV),&#13;
or other characters</p>&#13;
</li>&#13;
<li>&#13;
<p>Fixed-width text</p>&#13;
</li>&#13;
<li>&#13;
<p>Excel</p>&#13;
</li>&#13;
<li>&#13;
<p>JSON</p>&#13;
</li>&#13;
<li>&#13;
<p>HTML tables</p>&#13;
</li>&#13;
<li>&#13;
<p>SQL</p>&#13;
</li>&#13;
<li>&#13;
<p>HDF5</p>&#13;
</li>&#13;
<li>&#13;
<p>and <a href="https://oreil.ly/EWlgS">others</a>.</p>&#13;
</li>&#13;
</ul>&#13;
</li>&#13;
<li>&#13;
<p>Group, split, merge, index, slice, sort, select, label</p>&#13;
</li>&#13;
<li>&#13;
<p>Convert data types</p>&#13;
</li>&#13;
<li>&#13;
<p>Change size or shape</p>&#13;
</li>&#13;
<li>&#13;
<p>Handle missing data</p>&#13;
</li>&#13;
<li>&#13;
<p>Generate random values</p>&#13;
</li>&#13;
<li>&#13;
<p>Manage time series</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The read functions return a&#13;
<a href="https://oreil.ly/zupYI"><code>DataFrame</code></a> object,&#13;
Pandas’ standard representation for two-dimensional data&#13;
(rows and columns).&#13;
It’s similar in some ways to a spreadsheet or&#13;
a relational database table.&#13;
Its one-dimensional little brother is a&#13;
<a href="https://oreil.ly/pISZT"><code>Series</code></a>.</p>&#13;
&#13;
<p><a data-type="xref" href="#pandas_csv_example">Example 16-2</a> demonstrates a simple application that&#13;
reads our <em>villains.csv</em> file from <a data-type="xref" href="#villains_csv">Example 16-1</a>.</p>&#13;
<div data-type="example" id="pandas_csv_example">&#13;
<h5><span class="label">Example 16-2. </span>Read CSV with Pandas</h5>&#13;
&#13;
<pre data-type="programlisting">&gt;&gt;&gt; import pandas&#13;
&gt;&gt;&gt;&#13;
&gt;&gt;&gt; data = pandas.read_csv('villains.csv')&#13;
&gt;&gt;&gt; print(data)&#13;
    first        last&#13;
0  Doctor          No&#13;
1    Rosa       Klebb&#13;
2  Mister         Big&#13;
3   Auric  Goldfinger&#13;
4   Ernst     Blofeld</pre></div>&#13;
&#13;
<p>The variable <code>data</code> just shown is a <code>DataFrame</code>.&#13;
which has&#13;
many more tricks&#13;
than a basic Python dictionary.&#13;
It’s especially useful for heavy numeric work with&#13;
NumPy, and data preparation for machine learning.</p>&#13;
&#13;
<p>Refer to the <a href="https://oreil.ly/VKSrZ">“Getting Started”</a> section of the documentation for Pandas’ features,&#13;
and&#13;
<a href="https://oreil.ly/CLoVg">“10 Minutes to Pandas”</a>&#13;
for working examples.</p>&#13;
&#13;
<p>Let’s use Pandas for a little calendar example—make a list of&#13;
the first day of the first three months in 2019:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">pandas</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">dates</code> <code class="o">=</code> <code class="n">pandas</code><code class="o">.</code><code class="n">date_range</code><code class="p">(</code><code class="s">'2019-01-01'</code><code class="p">,</code> <code class="n">periods</code><code class="o">=</code><code class="mi">3</code><code class="p">,</code> <code class="n">freq</code><code class="o">=</code><code class="s">'MS'</code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">dates</code>&#13;
<code class="go">DatetimeIndex(['2019-01-01', '2019-02-01', '2019-03-01'],</code>&#13;
<code class="go">  dtype='datetime64[ns]', freq='MS')</code></pre>&#13;
&#13;
<p>You could write something that does this,&#13;
using the time and date functions described in <a data-type="xref" href="ch13.html#ch_times">Chapter 13</a>,&#13;
but it would be a lot more work—especially debugging&#13;
(dates and times are frustrating).&#13;
Pandas also handles many special date/time&#13;
<a href="https://oreil.ly/vpeTP">details</a>,&#13;
like business months and years.</p>&#13;
&#13;
<p>Pandas will appear again later when I talk about&#13;
mapping (<a data-type="xref" href="ch21.html#geopandas">“Geopandas”</a>)&#13;
and scientific applications (<a data-type="xref" href="ch22.html#sci_pandas">“Pandas”</a>).</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Configuration Files" data-type="sect2"><div class="sect2" id="config_files">&#13;
<h2>Configuration Files</h2>&#13;
&#13;
<p><a data-primary="configuration files" data-type="indexterm" id="idm45794977317224"/><a data-primary="tabular text files" data-secondary="configuration files" data-type="indexterm" id="idm45794977316296"/><a data-primary="text files" data-secondary="configuration files" data-type="indexterm" id="idm45794977315352"/>Most programs offer various <em>options</em> or <em>settings</em>.&#13;
Dynamic ones can be provided as program arguments,&#13;
but long-lasting ones&#13;
need to be kept somewhere.&#13;
The temptation to define your own quick-and-dirty&#13;
<em>config file</em> format is strong—but resist it.&#13;
It often turns out to be dirty, but not so quick.&#13;
You need to maintain both the writer program&#13;
and the reader program (sometimes called a <em>parser</em>).&#13;
There are good alternatives that you can just drop into your program,&#13;
including those in the previous <span class="keep-together">sections.</span></p>&#13;
&#13;
<p><a data-primary="configparser module" data-type="indexterm" id="idm45794977311400"/>Here, we’ll use the standard <code>configparser</code> module,&#13;
which handles Windows-style <em>.ini</em> files.&#13;
Such files have sections&#13;
of <em>key</em> = <em>value</em> definitions.&#13;
Here’s a minimal <em>settings.cfg</em> file:</p>&#13;
&#13;
<pre data-type="programlisting">[english]&#13;
greeting = Hello&#13;
&#13;
[french]&#13;
greeting = Bonjour&#13;
&#13;
[files]&#13;
home = /usr/local&#13;
# simple interpolation:&#13;
bin = %(home)s/bin</pre>&#13;
&#13;
<p>Here’s the code to read it into Python data structures:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">configparser</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">cfg</code> <code class="o">=</code> <code class="n">configparser</code><code class="o">.</code><code class="n">ConfigParser</code><code class="p">()</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">cfg</code><code class="o">.</code><code class="n">read</code><code class="p">(</code><code class="s">'settings.cfg'</code><code class="p">)</code>&#13;
<code class="go">['settings.cfg']</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">cfg</code>&#13;
<code class="go">&lt;configparser.ConfigParser object at 0x1006be4d0&gt;</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">cfg</code><code class="p">[</code><code class="s">'french'</code><code class="p">]</code>&#13;
<code class="go">&lt;Section: french&gt;</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">cfg</code><code class="p">[</code><code class="s">'french'</code><code class="p">][</code><code class="s">'greeting'</code><code class="p">]</code>&#13;
<code class="go">'Bonjour'</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">cfg</code><code class="p">[</code><code class="s">'files'</code><code class="p">][</code><code class="s">'bin'</code><code class="p">]</code>&#13;
<code class="go">'/usr/local/bin'</code></pre>&#13;
&#13;
<p>Other options are available, including fancier interpolation.&#13;
See the <code>configparser</code>&#13;
<a href="http://bit.ly/configparser">documentation</a>.&#13;
If you need deeper nesting than two levels,&#13;
try YAML or JSON.<a data-startref="ix_ch16-databases-asciidoc3" data-type="indexterm" id="idm45794977240232"/><a data-startref="ix_ch16-databases-asciidoc2" data-type="indexterm" id="idm45794977239624"/><a data-startref="ix_ch16-databases-asciidoc1" data-type="indexterm" id="idm45794977238984"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before less_space" data-pdf-bookmark="Binary Files" data-type="sect1"><div class="sect1" id="binary_files">&#13;
<h1>Binary Files</h1>&#13;
&#13;
<p><a data-primary="binary files" data-type="indexterm" id="idm45794977236424"/><a data-primary="persistent storage" data-secondary="binary files" data-type="indexterm" id="idm45794977235720"/>Some file formats were designed to store&#13;
particular data structures&#13;
but are neither relational nor NoSQL databases.&#13;
The sections that follow present some of them.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Padded Binary Files and Memory Mapping" data-type="sect2"><div class="sect2" id="padded_binary_files">&#13;
<h2>Padded Binary Files and Memory Mapping</h2>&#13;
&#13;
<p><a data-primary="binary files" data-secondary="padded files and memory mapping" data-type="indexterm" id="idm45794977232936"/><a data-primary="memory mapping" data-type="indexterm" id="idm45794977231944"/><a data-primary="padded binary files" data-type="indexterm" id="idm45794977231272"/>These are similar to padded text files, but the&#13;
contents may be binary,&#13;
and the padding byte may be <code>\x00</code> instead of a space character.&#13;
Each record has a fixed size, as&#13;
does each field within a record.&#13;
This makes it simpler to <code>seek()</code> throughout&#13;
the file for the desired records and fields.&#13;
Every operation on the data is manual,&#13;
so this approach tends to be used only in very low-level&#13;
(e.g., close to the hardware) <span class="keep-together">situations.</span></p>&#13;
&#13;
<p>Data in this form can be <em>memory mapped</em> with the standard&#13;
<code>mmap</code> library.&#13;
See some&#13;
<a href="https://pymotw.com/3/mmap">examples</a>,&#13;
and the standard&#13;
<a href="https://oreil.ly/eI0mv">documentation</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Spreadsheets" data-type="sect2"><div class="sect2" id="idm45794977225624">&#13;
<h2>Spreadsheets</h2>&#13;
&#13;
<p><a data-primary="binary files" data-secondary="spreadsheets" data-type="indexterm" id="idm45794977224392"/><a data-primary="spreadsheets" data-type="indexterm" id="idm45794977223256"/>Spreadsheets, notably Microsoft Excel,&#13;
are widespread binary data formats.&#13;
If you can save your spreadsheet to a CSV file,&#13;
you can read it by using the standard <code>csv</code> module&#13;
that was described earlier.&#13;
This will work for a binary <code>xls</code> file,&#13;
<a href="https://oreil.ly/---YE"><code>xlrd</code></a>,&#13;
or&#13;
<code>tablib</code> (mentioned earlier at <a data-type="xref" href="#tablib">“Tablib”</a>).</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="HDF5" data-type="sect2"><div class="sect2" id="hdf5">&#13;
<h2>HDF5</h2>&#13;
&#13;
<p><a data-primary="binary files" data-secondary="HDF5" data-type="indexterm" id="idm45794977217544"/><a data-primary="HDF5" data-type="indexterm" id="idm45794977216568"/><a href="https://oreil.ly/QTT6x">HDF5</a>&#13;
is a binary data format for multidimensional&#13;
or hierarchical numeric data.&#13;
It’s used mainly in science,&#13;
where fast random access to&#13;
large datasets (gigabytes to terabytes)&#13;
is a common requirement.&#13;
Even though HDF5 could be a good alternative&#13;
to databases in some cases,&#13;
for some reason&#13;
HDF5 is almost unknown in the business world.&#13;
It’s best suited to <em>WORM</em> (write once/read many)&#13;
applications for which database protection&#13;
against conflicting writes is not needed.&#13;
Here are some modules that you might find useful:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><code>h5py</code> is a full-featured low-level interface.&#13;
Read the&#13;
<a href="http://www.h5py.org">documentation</a>&#13;
and&#13;
<a href="https://github.com/h5py/h5py">code</a>.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>PyTables</code> is a bit higher-level,&#13;
with database-like features.&#13;
Read the&#13;
<a href="http://www.pytables.org">documentation</a>&#13;
and&#13;
<a href="http://pytables.github.com">code</a>.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Both of these are discussed&#13;
in terms of scientific applications of Python&#13;
in <a data-type="xref" href="ch22.html#ch_science">Chapter 22</a>.&#13;
I’m mentioning HDF5 here in case you&#13;
have a need to store and retrieve large amounts of data&#13;
and are willing to consider something outside the box&#13;
as well as the usual database solutions.&#13;
A good example is the&#13;
<a href="http://millionsongdataset.com">Million Song dataset</a>,&#13;
which has downloadable song data in HDF5 and SQLite formats.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="TileDB" data-type="sect2"><div class="sect2" id="idm45794977206376">&#13;
<h2>TileDB</h2>&#13;
&#13;
<p><a data-primary="binary files" data-secondary="TileDB" data-type="indexterm" id="idm45794977205096"/><a data-primary="TileDB" data-type="indexterm" id="idm45794977204120"/>A recent successor to HDF5 for dense or spare array storage is&#13;
<a href="https://tiledb.io">TileDB</a>.&#13;
Install the&#13;
<a href="https://github.com/TileDB-Inc/TileDB-Py">Python interface</a>&#13;
(which includes the TileDB library itself)&#13;
by running&#13;
<code>pip install tiledb</code>.&#13;
This is aimed at scientific data and applications.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Relational Databases" data-type="sect1"><div class="sect1" id="rdbms">&#13;
<h1>Relational Databases</h1>&#13;
&#13;
<p><a data-primary="databases" data-secondary="relational" data-type="indexterm" id="ix_ch16-databases-asciidoc16"/><a data-primary="persistent storage" data-secondary="relational databases" data-type="indexterm" id="ix_ch16-databases-asciidoc17"/><a data-primary="relational databases" data-type="indexterm" id="ix_ch16-databases-asciidoc18"/>Relational databases are only about 40 years old&#13;
but are ubiquitous in the computing world.&#13;
You’ll almost certainly have to deal with them&#13;
at one time or another.&#13;
When you do, you’ll appreciate what they provide:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Access to data by multiple simultaneous users</p>&#13;
</li>&#13;
<li>&#13;
<p>Protection from corruption by those users</p>&#13;
</li>&#13;
<li>&#13;
<p>Efficient methods to store and retrieve the data</p>&#13;
</li>&#13;
<li>&#13;
<p>Data defined by <em>schemas</em> and limited by <em>constraints</em></p>&#13;
</li>&#13;
<li>&#13;
<p><em>Joins</em> to find relationships across diverse types of data</p>&#13;
</li>&#13;
<li>&#13;
<p>A declarative (rather than imperative) query language:&#13;
<em>SQL</em> (Structured Query Language)</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p><a data-primary="tables" data-type="indexterm" id="idm45794977158104"/>These are called <em>relational</em>  because they&#13;
show relationships among different kinds of data&#13;
in the form of rectangular <em>tables</em>.&#13;
For instance, in our menu example earlier, there is a&#13;
relationship between each item and its price.</p>&#13;
&#13;
<p><a data-primary="columns" data-type="indexterm" id="idm45794977155896"/><a data-primary="rows" data-type="indexterm" id="idm45794977154968"/>A table is a rectangular grid of&#13;
<em>columns</em> (data fields)&#13;
and <em>rows</em> (individual data records),&#13;
similar to a spreadsheet.&#13;
The intersection of a row and column is a table <em>cell</em>.&#13;
To create a table, name it and specify the order, names,&#13;
and types of its columns.&#13;
Each row has the same columns,&#13;
although a column may be defined to allow missing data&#13;
(called <em>nulls</em>) in cells.&#13;
In the menu example, you could create a table with one&#13;
row for each item being sold.&#13;
Each item has the same columns,&#13;
including one for the price.</p>&#13;
&#13;
<p><a data-primary="primary key" data-type="indexterm" id="idm45794977151896"/>A column or group of columns is usually the table’s&#13;
<em>primary key</em>; its values must be unique in the table.&#13;
This prevents adding the same data to the table more than once.&#13;
<a data-primary="index, in relational databases" data-type="indexterm" id="idm45794977150456"/>This key is <em>indexed</em> for fast lookups during queries.&#13;
An index works a little like a book index,&#13;
making it fast to find a&#13;
particular row.</p>&#13;
&#13;
<p>Each table lives within a parent <em>database</em>,&#13;
like a file within a directory.&#13;
Two levels of hierarchy help keep things organized a little better.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p><a data-primary="databases" data-secondary="terminology" data-type="indexterm" id="idm45794977147288"/>Yes, the word <em>database</em> is used in multiple ways:&#13;
as the server, the table container, and the data stored therein.&#13;
If you’ll be referring to all of them at the same time,&#13;
it might help to call them <em>database server</em>, <em>database</em>,&#13;
and <em>data</em>.</p>&#13;
</div>&#13;
&#13;
<p><a data-primary="secondary index" data-type="indexterm" id="idm45794977143816"/>If you want to find rows by some nonkey column value,&#13;
define a <em>secondary index</em> on that column.&#13;
Otherwise, the database server must&#13;
perform a <em>table scan</em>—a brute-force search of every row&#13;
for matching column values.</p>&#13;
&#13;
<p>Tables can be related to each other with <em>foreign keys</em>,&#13;
and column values can be constrained to these keys.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="SQL" data-type="sect2"><div class="sect2" id="sql">&#13;
<h2>SQL</h2>&#13;
&#13;
<p><a data-primary="relational databases" data-secondary="SQL" data-type="indexterm" id="ix_ch16-databases-asciidoc19"/><a data-primary="SQL (structured query language)" data-type="indexterm" id="ix_ch16-databases-asciidoc20"/>SQL&#13;
is not an API or a protocol,&#13;
but a declarative <em>language</em>:&#13;
you say <em>what</em> you want rather than <em>how</em> to do it.&#13;
It’s the universal language of relational databases.&#13;
SQL queries are text strings sent by a client to the database server, which in turn figures out what to do with them.</p>&#13;
&#13;
<p>There have been various SQL standard definitions,&#13;
and all database vendors have added their own tweaks and extensions,&#13;
resulting in many SQL <em>dialects</em>.&#13;
If you store your data in a relational database,&#13;
SQL gives you some portability.&#13;
Still, dialect and operational differences&#13;
can make it difficult to move your data to another type of database. There are two main categories of SQL statements:</p>&#13;
<dl>&#13;
<dt><a data-primary="DDL (data definition language)" data-type="indexterm" id="idm45794977133336"/>DDL (data definition language)</dt>&#13;
<dd>&#13;
<p>Handles creation, deletion, constraints,&#13;
and permissions for tables, databases, and users.</p>&#13;
</dd>&#13;
<dt><a data-primary="DML (data manipulation language)" data-type="indexterm" id="idm45794977131288"/>DML (data manipulation language)</dt>&#13;
<dd>&#13;
<p>Handles data insertions, selects, updates, and deletions.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p><a data-type="xref" href="#table_8-1">Table 16-1</a> lists the basic SQL DDL commands.</p>&#13;
<table id="table_8-1">&#13;
<caption><span class="label">Table 16-1. </span>Basic SQL DDL commands</caption>&#13;
<thead>&#13;
<tr>&#13;
<th>Operation</th>&#13;
<th>SQL pattern</th>&#13;
<th>SQL example</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p>Create a database</p></td>&#13;
<td><p><code>CREATE DATABASE</code> <em>dbname</em></p></td>&#13;
<td><p><code>CREATE DATABASE d</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>Select current database</p></td>&#13;
<td><p><code>USE</code> <em>dbname</em></p></td>&#13;
<td><p><code>USE d</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>Delete a database and its tables</p></td>&#13;
<td><p><code>DROP DATABASE</code> <em>dbname</em></p></td>&#13;
<td><p><code>DROP DATABASE d</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>Create a table</p></td>&#13;
<td><p><code>CREATE TABLE</code> <em>tbname</em> <code>(</code> <em>coldefs</em> <code>)</code></p></td>&#13;
<td><p><code>CREATE TABLE t (id INT, count INT)</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>Delete a table</p></td>&#13;
<td><p><code>DROP TABLE</code> <em>tbname</em></p></td>&#13;
<td><p><code>DROP TABLE t</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>Remove all rows from a table</p></td>&#13;
<td><p><code>TRUNCATE TABLE</code> <em>tbname</em></p></td>&#13;
<td><p><code>TRUNCATE TABLE t</code></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Why all the CAPITAL LETTERS?&#13;
SQL is case-insensitive,&#13;
but it’s a tradition&#13;
(don’t ask me why)&#13;
to SHOUT&#13;
its keywords in code examples to distinguish them&#13;
from column names.</p>&#13;
</div>&#13;
&#13;
<p><a data-primary="CRUD (Create-Read-Update-Delete)" data-type="indexterm" id="idm45794977104136"/>The main DML operations&#13;
of a relational database are often&#13;
known by the acronym CRUD:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><em>C</em>reate by using the SQL <code>INSERT</code> statement</p>&#13;
</li>&#13;
<li>&#13;
<p><em>R</em>ead by using <code>SELECT</code></p>&#13;
</li>&#13;
<li>&#13;
<p><em>U</em>pdate by using <code>UPDATE</code></p>&#13;
</li>&#13;
<li>&#13;
<p><em>D</em>elete by using <code>DELETE</code></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p><a data-type="xref" href="#sql_dml">Table 16-2</a> looks at the commands available for SQL DML.<a data-startref="ix_ch16-databases-asciidoc20" data-type="indexterm" id="idm45794977095656"/><a data-startref="ix_ch16-databases-asciidoc19" data-type="indexterm" id="idm45794977094968"/></p>&#13;
<table id="sql_dml">&#13;
<caption><span class="label">Table 16-2. </span>Basic SQL DML commands</caption>&#13;
<thead>&#13;
<tr>&#13;
<th>Operation</th>&#13;
<th>SQL pattern</th>&#13;
<th>SQL example</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p>Add a row</p></td>&#13;
<td><p><code>INSERT INTO</code> <em>tbname</em> <code>VALUES(</code> … <code>)</code></p></td>&#13;
<td><p><code>INSERT INTO t VALUES(7, 40)</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>Select all rows and columns</p></td>&#13;
<td><p><code>SELECT * FROM</code> <em>tbname</em></p></td>&#13;
<td><p><code>SELECT * FROM t</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>Select all rows, some columns</p></td>&#13;
<td><p><code>SELECT</code> <em>cols</em> <code>FROM</code> <em>tbname</em></p></td>&#13;
<td><p><code>SELECT id, count FROM t</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>Select some rows, some columns</p></td>&#13;
<td><p><code>SELECT</code> <em>cols</em> <code>FROM</code> <em>tbname</em> <code>WHERE</code> <em>condition</em></p></td>&#13;
<td><p><code>SELECT id, count from t WHERE count &gt; 5 AND id = 9</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>Change some rows in a column</p></td>&#13;
<td><p><code>UPDATE</code> <em>tbname</em> <code>SET</code> <em>col</em> <code>=</code> <em>value</em> <code>WHERE</code> <em>condition</em></p></td>&#13;
<td><p><code>UPDATE t SET count=3 WHERE id=5</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>Delete some rows</p></td>&#13;
<td><p><code>DELETE FROM</code> <em>tbname</em> <code>WHERE</code> <em>condition</em></p></td>&#13;
<td><p><code>DELETE FROM t WHERE count &lt;= 10 OR id = 16</code></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="DB-API" data-type="sect2"><div class="sect2" id="db_api">&#13;
<h2>DB-API</h2>&#13;
&#13;
<p><a data-primary="API (application programming interface)" data-type="indexterm" id="idm45794977064104"/><a data-primary="DB-API" data-type="indexterm" id="idm45794977063400"/><a data-primary="relational databases" data-secondary="DB-API" data-type="indexterm" id="idm45794977062728"/>An application programming interface (API)&#13;
is a set of functions that you can call to get access to some service.&#13;
<a href="http://bit.ly/db-api">DB-API</a>&#13;
is Python’s standard API&#13;
for accessing relational databases.&#13;
Using it, you can write a single program that works with multiple&#13;
kinds of relational databases&#13;
instead of writing a separate program for each one.&#13;
It’s similar to Java’s JDBC or Perl’s dbi.</p>&#13;
&#13;
<p>Its main functions are the following:</p>&#13;
<dl>&#13;
<dt><code>connect()</code></dt>&#13;
<dd>&#13;
<p>Make a connection to the database;&#13;
this can include arguments such as username, password,&#13;
server address, and others.</p>&#13;
</dd>&#13;
<dt><code>cursor()</code></dt>&#13;
<dd>&#13;
<p>Create a <em>cursor</em> object to manage queries.</p>&#13;
</dd>&#13;
<dt><code>execute()</code> and <code>executemany()</code></dt>&#13;
<dd>&#13;
<p>Run one or more SQL commands against the database.</p>&#13;
</dd>&#13;
<dt><code>fetchone()</code>, <code>fetchmany()</code>, and <code>fetchall()</code></dt>&#13;
<dd>&#13;
<p>Get the results from <code>execute()</code>.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>The Python database modules in the coming sections&#13;
conform to DB-API, often with&#13;
extensions and some differences in details.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="SQLite" data-type="sect2"><div class="sect2" id="sqlite">&#13;
<h2>SQLite</h2>&#13;
&#13;
<p><a data-primary="relational databases" data-secondary="SQLite" data-type="indexterm" id="ix_ch16-databases-asciidoc21"/><a data-primary="SQLite" data-type="indexterm" id="ix_ch16-databases-asciidoc22"/><a href="http://www.sqlite.org">SQLite</a>&#13;
is a good, light, open source relational database.&#13;
It’s implemented as a standard Python library,&#13;
and stores databases in normal files.&#13;
These files are portable across machines&#13;
and operating systems, making SQLite&#13;
a very portable solution for simple&#13;
relational database applications.&#13;
It isn’t as full featured as MySQL or&#13;
PostgreSQL, but it does support SQL,&#13;
and it manages multiple simultaneous users.&#13;
Web browsers, smartphones, and other applications&#13;
use SQLite as an embedded database.</p>&#13;
&#13;
<p>You begin with a <code>connect()</code> to the local SQLite database file that&#13;
you want to use or create.&#13;
This file is the equivalent of the directory-like&#13;
<em>database</em> that parents tables in other servers.&#13;
The special string <code>':memory:'</code> creates the database in&#13;
memory only; this is fast and useful for testing&#13;
but will lose data when your program terminates or&#13;
if your computer goes down.</p>&#13;
&#13;
<p>For the next example, let’s make a database called <code>enterprise.db</code>&#13;
and the table <code>zoo</code> to manage our&#13;
thriving roadside petting zoo business.&#13;
The table columns are as follows:</p>&#13;
<dl>&#13;
<dt><code>critter</code></dt>&#13;
<dd>&#13;
<p>A variable length string,&#13;
and our primary key.</p>&#13;
</dd>&#13;
<dt><code>count</code></dt>&#13;
<dd>&#13;
<p>An integer count of our current inventory&#13;
for this animal.</p>&#13;
</dd>&#13;
<dt><code>damages</code></dt>&#13;
<dd>&#13;
<p>The dollar amount of our current losses&#13;
from animal–human interactions.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">sqlite3</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code> <code class="o">=</code> <code class="n">sqlite3</code><code class="o">.</code><code class="n">connect</code><code class="p">(</code><code class="s">'enterprise.db'</code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">curs</code> <code class="o">=</code> <code class="n">conn</code><code class="o">.</code><code class="n">cursor</code><code class="p">()</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s">'''CREATE TABLE zoo</code>&#13;
<code class="go">    (critter VARCHAR(20) PRIMARY KEY,</code>&#13;
<code class="go">     count INT,</code>&#13;
<code class="go">     damages FLOAT)''')</code>&#13;
<code class="go">&lt;sqlite3.Cursor object at 0x1006a22d0&gt;</code></pre>&#13;
&#13;
<p>Python’s triple quotes are handy when creating long&#13;
strings such as SQL queries.</p>&#13;
&#13;
<p>Now, add some animals to the zoo:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s">'INSERT INTO zoo VALUES("duck", 5, 0.0)'</code><code class="p">)</code>&#13;
<code class="go">&lt;sqlite3.Cursor object at 0x1006a22d0&gt;</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s">'INSERT INTO zoo VALUES("bear", 2, 1000.0)'</code><code class="p">)</code>&#13;
<code class="go">&lt;sqlite3.Cursor object at 0x1006a22d0&gt;</code></pre>&#13;
&#13;
<p>There’s a safer way to insert data,&#13;
using a <em>placeholder</em>:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">ins</code> <code class="o">=</code> <code class="s">'INSERT INTO zoo (critter, count, damages) VALUES(?, ?, ?)'</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">ins</code><code class="p">,</code> <code class="p">(</code><code class="s">'weasel'</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mf">2000.0</code><code class="p">))</code>&#13;
<code class="go">&lt;sqlite3.Cursor object at 0x1006a22d0&gt;</code></pre>&#13;
&#13;
<p>This time, we used three question marks in the SQL&#13;
to indicate that we plan&#13;
to insert three values,&#13;
and then pass those three values as a tuple to&#13;
the <code>execute()</code> function.&#13;
<a data-primary="security issues" data-secondary="SQL injection" data-type="indexterm" id="idm45794976937432"/>Placeholders handle tedious details such as quoting.&#13;
They protect you against <em>SQL injection</em>, a kind of external attack that inserts malicious SQL commands into the system (and which is common on the web).</p>&#13;
&#13;
<p>Now, let’s see if we can get all our animals out again:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s">'SELECT * FROM zoo'</code><code class="p">)</code>&#13;
<code class="go">&lt;sqlite3.Cursor object at 0x1006a22d0&gt;</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">rows</code> <code class="o">=</code> <code class="n">curs</code><code class="o">.</code><code class="n">fetchall</code><code class="p">()</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="k">print</code><code class="p">(</code><code class="n">rows</code><code class="p">)</code>&#13;
<code class="go">[('duck', 5, 0.0), ('bear', 2, 1000.0), ('weasel', 1, 2000.0)]</code></pre>&#13;
&#13;
<p>Let’s get them again, but ordered by their counts:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s">'SELECT * from zoo ORDER BY count'</code><code class="p">)</code>&#13;
<code class="go">&lt;sqlite3.Cursor object at 0x1006a22d0&gt;</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">curs</code><code class="o">.</code><code class="n">fetchall</code><code class="p">()</code>&#13;
<code class="go">[('weasel', 1, 2000.0), ('bear', 2, 1000.0), ('duck', 5, 0.0)]</code></pre>&#13;
&#13;
<p>Hey, we wanted them in descending order:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s">'SELECT * from zoo ORDER BY count DESC'</code><code class="p">)</code>&#13;
<code class="go">&lt;sqlite3.Cursor object at 0x1006a22d0&gt;</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">curs</code><code class="o">.</code><code class="n">fetchall</code><code class="p">()</code>&#13;
<code class="go">[('duck', 5, 0.0), ('bear', 2, 1000.0), ('weasel', 1, 2000.0)]</code></pre>&#13;
&#13;
<p>Which type of animal is costing us the most?</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">curs</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s">'''SELECT * FROM zoo WHERE</code>&#13;
<code class="gp">... </code><code class="s">    damages = (SELECT MAX(damages) FROM zoo)'''</code><code class="p">)</code>&#13;
<code class="go">&lt;sqlite3.Cursor object at 0x1006a22d0&gt;</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">curs</code><code class="o">.</code><code class="n">fetchall</code><code class="p">()</code>&#13;
<code class="go">[('weasel', 1, 2000.0)]</code></pre>&#13;
&#13;
<p>You would have thought it was the bears.&#13;
It’s always best to check the actual data.</p>&#13;
&#13;
<p class="pagebreak-before">Before we leave SQLite, we need to clean up.&#13;
If we opened a connection and a cursor,&#13;
we need to close them when we’re done:<a data-startref="ix_ch16-databases-asciidoc22" data-type="indexterm" id="idm45794976805544"/><a data-startref="ix_ch16-databases-asciidoc21" data-type="indexterm" id="idm45794976804936"/></p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">curs</code><code class="o">.</code><code class="n">close</code><code class="p">()</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">close</code><code class="p">()</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="MySQL" data-type="sect2"><div class="sect2" id="mysql">&#13;
<h2>MySQL</h2>&#13;
&#13;
<p><a data-primary="MySQL" data-type="indexterm" id="idm45794976748408"/><a data-primary="relational databases" data-secondary="MySQL" data-type="indexterm" id="idm45794976747704"/><a href="http://www.mysql.com">MySQL</a>&#13;
is a very popular open source relational database.&#13;
Unlike SQLite, it’s an actual server,&#13;
so clients can access it from different devices across the network.</p>&#13;
&#13;
<p><a data-type="xref" href="#mysql_drivers">Table 16-3</a> lists the drivers you can use&#13;
to access MySQL from Python.&#13;
For more details on all Python MySQL drivers,&#13;
see the <em>python.org</em>&#13;
<a href="https://wiki.python.org/moin/MySQL">wiki</a>.</p>&#13;
<table id="mysql_drivers">&#13;
<caption><span class="label">Table 16-3. </span>MySQL drivers</caption>&#13;
<thead>&#13;
<tr>&#13;
<th>Name</th>&#13;
<th>Link</th>&#13;
<th>Pypi package</th>&#13;
<th>Import as</th>&#13;
<th>Notes</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p>mysqlclient</p></td>&#13;
<td><p><a class="orm:hideurl" href="https://mysqlclient.readthedocs.io/"><em>https://https://mysqlclient.readthedocs.io</em></a></p></td>&#13;
<td><p>mysql-connector-python</p></td>&#13;
<td><p><code>MySQLdb</code></p></td>&#13;
<td/>&#13;
</tr>&#13;
<tr>&#13;
<td><p>MySQL Connector</p></td>&#13;
<td><p><a class="orm:hideurl" href="http://bit.ly/mysql-cpdg"><em>http://bit.ly/mysql-cpdg</em></a></p></td>&#13;
<td><p>mysql-connector-python</p></td>&#13;
<td><p><code>mysql.connector</code></p></td>&#13;
<td/>&#13;
</tr>&#13;
<tr>&#13;
<td><p>PYMySQL</p></td>&#13;
<td><p><a class="orm:hideurl" href="https://github.com/petehunt/PyMySQL/"><em>https://github.com/petehunt/PyMySQL</em></a></p></td>&#13;
<td><p>pymysql</p></td>&#13;
<td><p><code>pymysql</code></p></td>&#13;
<td/>&#13;
</tr>&#13;
<tr>&#13;
<td><p>oursql</p></td>&#13;
<td><p><a class="orm:hideurl" href="http://pythonhosted.org/oursql/"><em>http://pythonhosted.org/oursql</em></a></p></td>&#13;
<td><p>oursql</p></td>&#13;
<td><p><code>oursql</code></p></td>&#13;
<td><p>Requires the MySQL C client libraries</p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="PostgreSQL" data-type="sect2"><div class="sect2" id="postgresql">&#13;
<h2>PostgreSQL</h2>&#13;
&#13;
<p><a data-primary="PostgreSQL" data-type="indexterm" id="idm45794976675752"/><a data-primary="relational databases" data-secondary="PostgreSQL" data-type="indexterm" id="idm45794976675112"/><a href="http://www.postgresql.org">PostgreSQL</a>&#13;
is a full-featured open source&#13;
relational database. Indeed in many ways, it’s more advanced than MySQL.&#13;
<a data-type="xref" href="#postgres_drivers">Table 16-4</a> presents the Python drivers&#13;
you can use to access it.</p>&#13;
<table id="postgres_drivers">&#13;
<caption><span class="label">Table 16-4. </span>PostgreSQL drivers</caption>&#13;
<thead>&#13;
<tr>&#13;
<th>Name</th>&#13;
<th>Link</th>&#13;
<th>Pypi package</th>&#13;
<th>Import as</th>&#13;
<th>Notes</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p>psycopg2</p></td>&#13;
<td><p><a class="orm:hideurl" href="http://initd.org/psycopg/"><em>http://initd.org/psycopg</em></a></p></td>&#13;
<td><p>psycopg2</p></td>&#13;
<td><p>psycopg2</p></td>&#13;
<td><p>Needs <code>pg_config</code> from PostgreSQL client tools</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>py-postgresql</p></td>&#13;
<td><p><a class="orm:hideurl" href="https://pypi.org/project/py-postgresql/"><em>https://pypi.org/project/py-postgresql</em></a></p></td>&#13;
<td><p>py-postgresql</p></td>&#13;
<td><p>postgresql</p></td>&#13;
<td/>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
&#13;
<p>The most popular driver is <code>psycopg2</code>,&#13;
but its installation requires the PostgreSQL client libraries.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="SQLAlchemy" data-type="sect2"><div class="sect2" id="sqlalchemy">&#13;
<h2>SQLAlchemy</h2>&#13;
&#13;
<p><a data-primary="relational databases" data-secondary="SQLAlchemy" data-type="indexterm" id="ix_ch16-databases-asciidoc23"/><a data-primary="SQLAlchemy" data-type="indexterm" id="ix_ch16-databases-asciidoc24"/>SQL is not quite the same for all relational databases,&#13;
and DB-API takes you only so far.&#13;
Each database implements a particular <em>dialect</em>&#13;
reflecting its features and philosophy.&#13;
Many libraries try to bridge these differences in one&#13;
way or another.&#13;
The most popular cross-database Python library&#13;
is <a href="http://www.sqlalchemy.org">SQLAlchemy</a>.</p>&#13;
&#13;
<p>It isn’t in the standard library,&#13;
but it’s well known and used by many people.&#13;
<a data-primary="installation" data-secondary="SQLAlchemy" data-type="indexterm" id="idm45794976652312"/><a data-primary="SQLAlchemy" data-secondary="installing" data-type="indexterm" id="idm45794976651336"/>You can install it on your system by using this command:</p>&#13;
<pre>$ <strong>pip install sqlalchemy</strong></pre>&#13;
&#13;
<p>You can use SQLAlchemy on several levels:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>The lowest level manages database connection <em>pools</em>,&#13;
executes SQL commands, and returns results. This is closest&#13;
to the DB-API.</p>&#13;
</li>&#13;
<li>&#13;
<p>Next up is the <em>SQL expression language</em>,&#13;
which lets you express queries in a more Python-oriented way.</p>&#13;
</li>&#13;
<li>&#13;
<p>Highest is the ORM (Object Relational Model) layer,&#13;
which uses the SQL Expression Language&#13;
and binds application code with relational data structures.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>As we go along, you’ll understand what the terms mean in those levels.&#13;
SQLAlchemy works with the database drivers documented&#13;
in the previous sections.&#13;
You don’t need to import the driver;&#13;
the initial connection string you provide to SQLAlchemy&#13;
will determine it.&#13;
That string looks like this:</p>&#13;
<pre><em><code>dialect</code></em> + <em><code>driver</code></em> :// <em><code>user</code></em> : <em><code>password</code></em> @ <em><code>host</code></em> : <em><code>port</code></em> / <em><code>dbname</code></em></pre>&#13;
&#13;
<p>The values you put in this string are as follows:</p>&#13;
<dl>&#13;
<dt><code>dialect</code></dt>&#13;
<dd>&#13;
<p>The database type</p>&#13;
</dd>&#13;
<dt><code>driver</code></dt>&#13;
<dd>&#13;
<p>The particular driver you want to use for that database</p>&#13;
</dd>&#13;
<dt><code>user</code> and <code>password</code></dt>&#13;
<dd>&#13;
<p>Your database authentication strings</p>&#13;
</dd>&#13;
<dt><code>host</code> and <code>port</code></dt>&#13;
<dd>&#13;
<p>The database server’s location&#13;
(<code>: port</code> is needed only if it’s not the standard one for this server)</p>&#13;
</dd>&#13;
<dt><code>dbname</code></dt>&#13;
<dd>&#13;
<p>The database to initially connect to on the server</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p class="pagebreak-before"><a data-type="xref" href="#sqlalchemy_dialects">Table 16-5</a> lists the dialects and drivers.</p>&#13;
<table id="sqlalchemy_dialects">&#13;
<caption><span class="label">Table 16-5. </span>SQLAlchemy connection</caption>&#13;
<thead>&#13;
<tr>&#13;
<th>dialect</th>&#13;
<th>driver</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><code>sqlite</code></p></td>&#13;
<td><p><code>pysqlite</code> (or omit)</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>mysql</code></p></td>&#13;
<td><p><code>mysqlconnector</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>mysql</code></p></td>&#13;
<td><p><code>pymysql</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>mysql</code></p></td>&#13;
<td><p><code>oursql</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>postgresql</code></p></td>&#13;
<td><p><code>psycopg2</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>postgresql</code></p></td>&#13;
<td><p><code>pypostgresql</code></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
&#13;
<p>See also the SQLAlchemy details on dialects for&#13;
<a href="https://oreil.ly/yVHy-">MySQL</a>,&#13;
<a href="https://oreil.ly/okP9v">SQLite</a>,&#13;
<a href="https://oreil.ly/eDddn">PostgreSQL</a>,&#13;
and&#13;
<a href="https://oreil.ly/kp5WS">other databases</a>.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The engine layer" data-type="sect3"><div class="sect3" id="sqlalchemy_engine">&#13;
<h3>The engine layer</h3>&#13;
&#13;
<p><a data-primary="SQLAlchemy" data-secondary="engine layer" data-type="indexterm" id="idm45794976608424"/>First, let’s try the lowest level of SQLAlchemy,&#13;
which does little more than the base DB-API functions.</p>&#13;
&#13;
<p>Let’s try it with SQLite, which is already built in to Python.&#13;
The connection string for SQLite&#13;
skips the <em><code>host</code></em>, <em><code>port</code></em>, <em><code>user</code></em>, and <em><code>password</code></em>.&#13;
The <em><code>dbname</code></em> tells SQLite what file to use&#13;
to store your database.&#13;
If you omit the <em><code>dbname</code></em>,&#13;
SQLite builds a database in memory.&#13;
If the <em><code>dbname</code></em> starts with a slash (/),&#13;
it’s an absolute&#13;
filename on your computer&#13;
(as in Linux and macOS;&#13;
for example, <code>C:\</code> on Windows).&#13;
Otherwise, it’s relative to your current&#13;
directory.</p>&#13;
&#13;
<p>The following segments are all part of one program,&#13;
separated here for explanation.</p>&#13;
&#13;
<p>To begin, you need to import what we need.&#13;
The following is an example of an <em>import alias</em>,&#13;
which lets us use the string <code>sa</code> to refer to SQLAlchemy methods.&#13;
I do this mainly because <code>sa</code> is a lot easier to type than&#13;
<code>sqlalchemy</code>:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">sqlalchemy</code> <code class="kn">as</code> <code class="nn">sa</code></pre>&#13;
&#13;
<p>Connect to the database&#13;
and create the storage&#13;
for it in memory (the argument string <code>'sqlite:///:memory:'</code>&#13;
also works):</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code> <code class="o">=</code> <code class="n">sa</code><code class="o">.</code><code class="n">create_engine</code><code class="p">(</code><code class="s">'sqlite://'</code><code class="p">)</code></pre>&#13;
&#13;
<p>Create a database table called <code>zoo</code> that comprises three columns:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s">'''CREATE TABLE zoo</code>&#13;
<code class="gp">... </code><code class="s">    (critter VARCHAR(20) PRIMARY KEY,</code>&#13;
<code class="gp">... </code><code class="s">     count INT,</code>&#13;
<code class="gp">... </code><code class="s">     damages FLOAT)'''</code><code class="p">)</code>&#13;
<code class="go">&lt;sqlalchemy.engine.result.ResultProxy object at 0x1017efb10&gt;</code></pre>&#13;
&#13;
<p>Running <code>conn.execute()</code> returns a SQLAlchemy object&#13;
called a <code>ResultProxy</code>.&#13;
You’ll soon see what to do with it.</p>&#13;
&#13;
<p>By the way, if you’ve never made a&#13;
database table before, congratulations.&#13;
Check that one off your bucket list.</p>&#13;
&#13;
<p>Now, insert three sets of data into your new empty table:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">ins</code> <code class="o">=</code> <code class="s">'INSERT INTO zoo (critter, count, damages) VALUES (?, ?, ?)'</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">ins</code><code class="p">,</code> <code class="s">'duck'</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mf">0.0</code><code class="p">)</code>&#13;
<code class="go">&lt;sqlalchemy.engine.result.ResultProxy object at 0x1017efb50&gt;</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">ins</code><code class="p">,</code> <code class="s">'bear'</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mf">1000.0</code><code class="p">)</code>&#13;
<code class="go">&lt;sqlalchemy.engine.result.ResultProxy object at 0x1017ef090&gt;</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">ins</code><code class="p">,</code> <code class="s">'weasel'</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mf">2000.0</code><code class="p">)</code>&#13;
<code class="go">&lt;sqlalchemy.engine.result.ResultProxy object at 0x1017ef450&gt;</code></pre>&#13;
&#13;
<p>Next, ask the database for everything that we just put in:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">rows</code> <code class="o">=</code> <code class="n">conn</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s">'SELECT * FROM zoo'</code><code class="p">)</code></pre>&#13;
&#13;
<p>In SQLAlchemy, <code>rows</code> is not a list;&#13;
it’s that special <code>ResultProxy</code> thing&#13;
that we can’t print directly:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="k">print</code><code class="p">(</code><code class="n">rows</code><code class="p">)</code>&#13;
<code class="go">&lt;sqlalchemy.engine.result.ResultProxy object at 0x1017ef9d0&gt;</code></pre>&#13;
&#13;
<p>However, you can iterate over it like a list,&#13;
so we can get a row at a time:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="k">for</code> <code class="n">row</code> <code class="ow">in</code> <code class="n">rows</code><code class="p">:</code>&#13;
<code class="gp">... </code>    <code class="k">print</code><code class="p">(</code><code class="n">row</code><code class="p">)</code>&#13;
<code class="gp">...</code>&#13;
<code class="go">('duck', 10, 0.0)</code>&#13;
<code class="go">('bear', 2, 1000.0)</code>&#13;
<code class="go">('weasel', 1, 2000.0)</code></pre>&#13;
&#13;
<p>That was almost the same as the SQLite DB-API example&#13;
that you saw earlier.&#13;
The one advantage is that we didn’t need to import the database&#13;
driver at the top;&#13;
SQLAlchemy figured that out from the connection string.&#13;
Just changing the connection string would&#13;
make this code portable to another type of database.&#13;
Another plus is SQLAlchemy’s&#13;
<em>connection pooling</em>,&#13;
which you can read about at its&#13;
<a href="http://bit.ly/conn-pooling">documentation site</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The SQL Expression Language" data-type="sect3"><div class="sect3" id="sqlalchemy_expression_language">&#13;
<h3>The SQL Expression Language</h3>&#13;
&#13;
<p><a data-primary="Expression Language (SQLAlchemy)" data-type="indexterm" id="idm45794976416600"/><a data-primary="SQLAlchemy" data-secondary="Expression Language" data-type="indexterm" id="idm45794976415832"/>The next level up is&#13;
SQLAlchemy’s SQL Expression Language.&#13;
It introduces functions to create the SQL&#13;
for various operations.&#13;
The Expression Language handles more of the SQL&#13;
dialect differences than the lower-level engine layer does.&#13;
It can be a handy middle-ground approach&#13;
for relational database applications.</p>&#13;
&#13;
<p>Here’s how to create and populate the <code>zoo</code> table.&#13;
Again, these are successive fragments of a single program.</p>&#13;
&#13;
<p>The import and connection are the same as before:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">sqlalchemy</code> <code class="kn">as</code> <code class="nn">sa</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code> <code class="o">=</code> <code class="n">sa</code><code class="o">.</code><code class="n">create_engine</code><code class="p">(</code><code class="s">'sqlite://'</code><code class="p">)</code></pre>&#13;
&#13;
<p>To define the <code>zoo</code> table,&#13;
we begin using some of the Expression Language&#13;
instead of SQL:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">meta</code> <code class="o">=</code> <code class="n">sa</code><code class="o">.</code><code class="n">MetaData</code><code class="p">()</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">zoo</code> <code class="o">=</code> <code class="n">sa</code><code class="o">.</code><code class="n">Table</code><code class="p">(</code><code class="s">'zoo'</code><code class="p">,</code> <code class="n">meta</code><code class="p">,</code>&#13;
<code class="gp">... </code>    <code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code><code class="s">'critter'</code><code class="p">,</code> <code class="n">sa</code><code class="o">.</code><code class="n">String</code><code class="p">,</code> <code class="n">primary_key</code><code class="o">=</code><code class="bp">True</code><code class="p">),</code>&#13;
<code class="gp">... </code>    <code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code><code class="s">'count'</code><code class="p">,</code> <code class="n">sa</code><code class="o">.</code><code class="n">Integer</code><code class="p">),</code>&#13;
<code class="gp">... </code>    <code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code><code class="s">'damages'</code><code class="p">,</code> <code class="n">sa</code><code class="o">.</code><code class="n">Float</code><code class="p">)</code>&#13;
<code class="gp">... </code>   <code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">meta</code><code class="o">.</code><code class="n">create_all</code><code class="p">(</code><code class="n">conn</code><code class="p">)</code></pre>&#13;
&#13;
<p>Check out the parentheses in that multiline call&#13;
in the preceding example.&#13;
The structure of the <code>Table()</code> method matches&#13;
the structure of the table.&#13;
Just as our table contains three columns,&#13;
there are three calls to <code>Column()</code> inside the&#13;
parentheses of the&#13;
<code>Table()</code> method call.</p>&#13;
&#13;
<p>Meanwhile, <code>zoo</code> is some magic object that&#13;
bridges the SQL database world&#13;
and the Python data structure world.</p>&#13;
&#13;
<p>Insert the data with more Expression Language functions:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">... </code><code class="n">conn</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">zoo</code><code class="o">.</code><code class="n">insert</code><code class="p">((</code><code class="s">'bear'</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mf">1000.0</code><code class="p">)))</code>&#13;
<code class="go">&lt;sqlalchemy.engine.result.ResultProxy object at 0x1017ea910&gt;</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">zoo</code><code class="o">.</code><code class="n">insert</code><code class="p">((</code><code class="s">'weasel'</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mf">2000.0</code><code class="p">)))</code>&#13;
<code class="go">&lt;sqlalchemy.engine.result.ResultProxy object at 0x1017eab10&gt;</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">zoo</code><code class="o">.</code><code class="n">insert</code><code class="p">((</code><code class="s">'duck'</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">0</code><code class="p">)))</code>&#13;
<code class="go">&lt;sqlalchemy.engine.result.ResultProxy object at 0x1017eac50&gt;</code></pre>&#13;
&#13;
<p>Next, create the SELECT statement&#13;
(<code>zoo.select()</code> selects everything from the table&#13;
represented by the <code>zoo</code> object,&#13;
such as <code>SELECT * FROM zoo</code> would do in plain SQL):</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">result</code> <code class="o">=</code> <code class="n">conn</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">zoo</code><code class="o">.</code><code class="n">select</code><code class="p">())</code></pre>&#13;
&#13;
<p>Finally, get the results:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">rows</code> <code class="o">=</code> <code class="n">result</code><code class="o">.</code><code class="n">fetchall</code><code class="p">()</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="k">print</code><code class="p">(</code><code class="n">rows</code><code class="p">)</code>&#13;
<code class="go">[('bear', 2, 1000.0), ('weasel', 1, 2000.0), ('duck', 10, 0.0)]</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The Object-Relational Mapper (ORM)" data-type="sect3"><div class="sect3" id="orms">&#13;
<h3>The Object-Relational Mapper (ORM)</h3>&#13;
&#13;
<p><a data-primary="ORM (Object-Relational Mapper)" data-type="indexterm" id="ix_ch16-databases-asciidoc25"/><a data-primary="SQLAlchemy" data-secondary="Object-Relational Mapper" data-type="indexterm" id="ix_ch16-databases-asciidoc26"/>In the previous section,&#13;
the <code>zoo</code> object was a mid-level connection between&#13;
SQL and Python.&#13;
At the top layer of SQLAlchemy,&#13;
the Object-Relational Mapper (ORM)&#13;
uses the SQL Expression Language&#13;
but tries to make the actual database&#13;
mechanisms invisible.&#13;
You define classes, and the ORM handles how&#13;
to get their data in and out of the database.&#13;
The basic idea behind that complicated phrase,&#13;
“object-relational <span class="keep-together">mapper,”</span> is that you can refer to&#13;
objects in your code and thus stay close to the way Python&#13;
likes to operate while still using a relational&#13;
database.</p>&#13;
&#13;
<p>We’ll define a <code>Zoo</code> class and hook it into the ORM.&#13;
This time, we make SQLite use the file <em>zoo.db</em>&#13;
so that we can confirm that the ORM worked.</p>&#13;
&#13;
<p>As in the previous two sections,&#13;
the snippets that follow are actually one program&#13;
separated by explanations.&#13;
Don’t worry if you don’t understand&#13;
some if it.&#13;
The SQLAlchemy documentation has all the details—and this stuff can get complex.&#13;
I just want you to get an idea of&#13;
how much work it is to do this,&#13;
so that you can decide which of the approaches&#13;
discussed in this chapter suits you.</p>&#13;
&#13;
<p>The initial import is the same,&#13;
but this time we need another something also:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">sqlalchemy</code> <code class="kn">as</code> <code class="nn">sa</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="kn">from</code> <code class="nn">sqlalchemy.ext.declarative</code> <code class="kn">import</code> <code class="n">declarative_base</code></pre>&#13;
&#13;
<p>Here, we make the connection:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code> <code class="o">=</code> <code class="n">sa</code><code class="o">.</code><code class="n">create_engine</code><code class="p">(</code><code class="s">'sqlite:///zoo.db'</code><code class="p">)</code></pre>&#13;
&#13;
<p>Now, we get into SQLAlchemy’s ORM.&#13;
We define the <code>Zoo</code> class and associate&#13;
its attributes with table columns:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">Base</code> <code class="o">=</code> <code class="n">declarative_base</code><code class="p">()</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="k">class</code> <code class="nc">Zoo</code><code class="p">(</code><code class="n">Base</code><code class="p">):</code>&#13;
<code class="gp">... </code>    <code class="n">__tablename__</code> <code class="o">=</code> <code class="s">'zoo'</code>&#13;
<code class="gp">... </code>    <code class="n">critter</code> <code class="o">=</code> <code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code><code class="s">'critter'</code><code class="p">,</code> <code class="n">sa</code><code class="o">.</code><code class="n">String</code><code class="p">,</code> <code class="n">primary_key</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>&#13;
<code class="gp">... </code>    <code class="n">count</code> <code class="o">=</code> <code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code><code class="s">'count'</code><code class="p">,</code> <code class="n">sa</code><code class="o">.</code><code class="n">Integer</code><code class="p">)</code>&#13;
<code class="gp">... </code>    <code class="n">damages</code> <code class="o">=</code> <code class="n">sa</code><code class="o">.</code><code class="n">Column</code><code class="p">(</code><code class="s">'damages'</code><code class="p">,</code> <code class="n">sa</code><code class="o">.</code><code class="n">Float</code><code class="p">)</code>&#13;
<code class="gp">... </code>    <code class="k">def</code> <code class="nf">__init__</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code> <code class="n">critter</code><code class="p">,</code> <code class="n">count</code><code class="p">,</code> <code class="n">damages</code><code class="p">):</code>&#13;
<code class="gp">... </code>        <code class="bp">self</code><code class="o">.</code><code class="n">critter</code> <code class="o">=</code> <code class="n">critter</code>&#13;
<code class="gp">... </code>        <code class="bp">self</code><code class="o">.</code><code class="n">count</code> <code class="o">=</code> <code class="n">count</code>&#13;
<code class="gp">... </code>        <code class="bp">self</code><code class="o">.</code><code class="n">damages</code> <code class="o">=</code> <code class="n">damages</code>&#13;
<code class="gp">... </code>    <code class="k">def</code> <code class="nf">__repr__</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>&#13;
<code class="gp">... </code>        <code class="k">return</code> <code class="s">"&lt;Zoo({}, {}, {})&gt;"</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="bp">self</code><code class="o">.</code><code class="n">critter</code><code class="p">,</code> <code class="bp">self</code><code class="o">.</code><code class="n">count</code><code class="p">,</code>&#13;
<code class="gp">... </code>          <code class="bp">self</code><code class="o">.</code><code class="n">damages</code><code class="p">)</code></pre>&#13;
&#13;
<p>The following line magically creates the database and table:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">Base</code><code class="o">.</code><code class="n">metadata</code><code class="o">.</code><code class="n">create_all</code><code class="p">(</code><code class="n">conn</code><code class="p">)</code></pre>&#13;
&#13;
<p>You can then insert data by creating Python objects.&#13;
The ORM manages these <span class="keep-together">internally:</span></p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">first</code> <code class="o">=</code> <code class="n">Zoo</code><code class="p">(</code><code class="s">'duck'</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mf">0.0</code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">second</code> <code class="o">=</code> <code class="n">Zoo</code><code class="p">(</code><code class="s">'bear'</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mf">1000.0</code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">third</code> <code class="o">=</code> <code class="n">Zoo</code><code class="p">(</code><code class="s">'weasel'</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mf">2000.0</code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">first</code>&#13;
<code class="go">&lt;Zoo(duck, 10, 0.0)&gt;</code></pre>&#13;
&#13;
<p class="pagebreak-before">Next, we get the ORM to take us to SQL land.&#13;
We create a session to talk to the <span class="keep-together">database:</span></p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">from</code> <code class="nn">sqlalchemy.orm</code> <code class="kn">import</code> <code class="n">sessionmaker</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">Session</code> <code class="o">=</code> <code class="n">sessionmaker</code><code class="p">(</code><code class="n">bind</code><code class="o">=</code><code class="n">conn</code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">session</code> <code class="o">=</code> <code class="n">Session</code><code class="p">()</code></pre>&#13;
&#13;
<p>Within the session, we write the three objects that we created&#13;
to the database.&#13;
<a data-primary="add() function" data-type="indexterm" id="idm45794975702744"/><a data-primary="add_all () function" data-type="indexterm" id="idm45794975702136"/>The <code>add()</code> function adds one object,&#13;
and <code>add_all()</code> adds a list:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">session</code><code class="o">.</code><code class="n">add</code><code class="p">(</code><code class="n">first</code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">session</code><code class="o">.</code><code class="n">add_all</code><code class="p">([</code><code class="n">second</code><code class="p">,</code> <code class="n">third</code><code class="p">])</code></pre>&#13;
&#13;
<p>Finally, we need to force everything to complete:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">session</code><code class="o">.</code><code class="n">commit</code><code class="p">()</code></pre>&#13;
&#13;
<p>Did it work?&#13;
Well, it created a <em>zoo.db</em> file&#13;
in the current directory.&#13;
You can use the command-line <code>sqlite3</code> program to check it:</p>&#13;
<pre>$ <strong>sqlite3 zoo.db</strong>&#13;
SQLite version 3.6.12&#13;
Enter ".help" for instructions&#13;
Enter SQL statements terminated with a ";"&#13;
sqlite&gt; <strong>.tables</strong>&#13;
zoo&#13;
sqlite&gt; <strong>select * from zoo;</strong>&#13;
duck|10|0.0&#13;
bear|2|1000.0&#13;
weasel|1|2000.0</pre>&#13;
&#13;
<p>The purpose of this section was to show what an ORM&#13;
is and how it works at a high level.&#13;
The author of SQLAlchemy has written a full&#13;
<a href="http://bit.ly/obj-rel-tutorial">tutorial</a>.&#13;
After reading this,&#13;
decide which of the following levels would best fit your needs:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Plain DB-API, as in the earlier SQLite section</p>&#13;
</li>&#13;
<li>&#13;
<p>The SQLAlchemy engine</p>&#13;
</li>&#13;
<li>&#13;
<p>The SQLAlchemy Expression Language</p>&#13;
</li>&#13;
<li>&#13;
<p>The SQLAlchemy ORM</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>It seems like a natural choice to use an ORM&#13;
to avoid the complexities of SQL.&#13;
Should you use one?&#13;
Some people think ORMs should be&#13;
<a href="http://bit.ly/obj-rel-map">avoided</a>,&#13;
but others think the criticism is&#13;
<a href="http://bit.ly/fowler-orm">overdone</a>.&#13;
Whoever’s right,&#13;
an ORM is an abstraction,&#13;
and all abstractions are&#13;
<a href="http://bit.ly/leaky-law">leaky</a>&#13;
and break down at some point.&#13;
When your ORM doesn’t do what you want,&#13;
you must figure out both how it&#13;
works and how to fix it in SQL.&#13;
To borrow an internet meme:</p>&#13;
<blockquote>&#13;
<p>Some people, when confronted with a problem, think,&#13;
“I know, I’ll use an ORM.” Now they have two problems.</p></blockquote>&#13;
&#13;
<p>Use ORMs for simple applications or applications that map data pretty directly to database tables.&#13;
If the application is that simple,&#13;
you may consider using straight SQL&#13;
or the SQL Expression Language<a data-startref="ix_ch16-databases-asciidoc26" data-type="indexterm" id="idm45794975626520"/><a data-startref="ix_ch16-databases-asciidoc25" data-type="indexterm" id="idm45794975625800"/>.<a data-startref="ix_ch16-databases-asciidoc24" data-type="indexterm" id="idm45794975624984"/><a data-startref="ix_ch16-databases-asciidoc23" data-type="indexterm" id="idm45794975624264"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Other Database Access Packages" data-type="sect2"><div class="sect2" id="idm45794976657704">&#13;
<h2>Other Database Access Packages</h2>&#13;
&#13;
<p>If you’re looking for Python tools that will&#13;
handle multiple databases,&#13;
with more features than the bare db-api&#13;
but less than SQLAlchemy,&#13;
these are worth a look:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://dataset.readthedocs.org"><code>dataset</code></a>&#13;
claims the goal “databases for lazy people”.&#13;
It’s built on SQLAlchemy and provides a simple&#13;
ORM for SQL, JSON, and CSV storage.</p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://pypi.org/project/records"><code>records</code></a>&#13;
bills itself as “SQL for Humans.”&#13;
It supports only SQL queries,&#13;
using SQLAlchemy internally to handle SQL dialect issues,&#13;
connection pooling, and other details.&#13;
Its integration with <code>tablib</code>&#13;
(mentioned at <a data-type="xref" href="#tablib">“Tablib”</a>)&#13;
lets you export data to CSV, JSON, and other <span class="keep-together">formats.</span><a data-startref="ix_ch16-databases-asciidoc18" data-type="indexterm" id="idm45794975573704"/><a data-startref="ix_ch16-databases-asciidoc17" data-type="indexterm" id="idm45794975572984"/><a data-startref="ix_ch16-databases-asciidoc16" data-type="indexterm" id="idm45794975572296"/></p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="NoSQL Data Stores" data-type="sect1"><div class="sect1" id="nosql">&#13;
<h1>NoSQL Data Stores</h1>&#13;
&#13;
<p><a data-primary="databases" data-secondary="NoSQL data stores" data-type="indexterm" id="ix_ch16-databases-asciidoc27"/><a data-primary="NoSQL data stores" data-type="indexterm" id="ix_ch16-databases-asciidoc28"/><a data-primary="persistent storage" data-secondary="NoSQL data stores" data-type="indexterm" id="ix_ch16-databases-asciidoc29"/>Relational tables are rectangular, but data come in&#13;
many shapes and may be very difficult to fit without&#13;
significant effort and contortion.&#13;
It’s a square peg/round hole problem.</p>&#13;
&#13;
<p>Some nonrelational databases&#13;
have been written to&#13;
allow more flexible data definitions as well as to&#13;
process very large data sets&#13;
or support custom data operations.&#13;
They’ve been collectively labeled <em>NoSQL</em>&#13;
(formerly meaning <em>no SQL</em>,&#13;
now the less confrontational <em>not only SQL</em>).</p>&#13;
&#13;
<p>The simplest type of NoSQL databases are&#13;
<em>key-value stores</em>.&#13;
One popularity&#13;
<a href="https://oreil.ly/_VCKq">ranking</a>&#13;
shows some that I cover in the following sections.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The dbm Family" data-type="sect2"><div class="sect2" id="dbm">&#13;
<h2>The dbm Family</h2>&#13;
&#13;
<p><a data-primary="dbm databases" data-type="indexterm" id="idm45794975560168"/><a data-primary="NoSQL data stores" data-secondary="dbm family" data-type="indexterm" id="idm45794975559464"/>The <code>dbm</code> formats were around long before&#13;
the <em>NoSQL</em> label was coined.&#13;
They’re simple key-value stores,&#13;
often embedded in applications such as web browsers&#13;
to maintain various settings.&#13;
A dbm database is like a Python dictionary in the following ways:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>You can assign a value to a key,&#13;
and it’s automatically saved to the database on disk.</p>&#13;
</li>&#13;
<li>&#13;
<p>You can query a key for its value.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The following is a quick example.&#13;
The second argument to the following <code>open()</code> method&#13;
is <code>'r'</code> to read, <code>'w'</code> to write,&#13;
and <code>'c'</code> for both, creating the file if it doesn’t exist:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">dbm</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">db</code> <code class="o">=</code> <code class="n">dbm</code><code class="o">.</code><code class="n">open</code><code class="p">(</code><code class="s">'definitions'</code><code class="p">,</code> <code class="s">'c'</code><code class="p">)</code></pre>&#13;
&#13;
<p>To create key-value pairs,&#13;
just assign a value to a key just as you would a dictionary:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">db</code><code class="p">[</code><code class="s">'mustard'</code><code class="p">]</code> <code class="o">=</code> <code class="s">'yellow'</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">db</code><code class="p">[</code><code class="s">'ketchup'</code><code class="p">]</code> <code class="o">=</code> <code class="s">'red'</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">db</code><code class="p">[</code><code class="s">'pesto'</code><code class="p">]</code> <code class="o">=</code> <code class="s">'green'</code></pre>&#13;
&#13;
<p>Let’s pause and check what we have so far:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="nb">len</code><code class="p">(</code><code class="n">db</code><code class="p">)</code>&#13;
<code class="go">3</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">db</code><code class="p">[</code><code class="s">'pesto'</code><code class="p">]</code>&#13;
<code class="go">b'green'</code></pre>&#13;
&#13;
<p>Now close, then reopen to see whether it actually saved what we gave it:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">db</code><code class="o">.</code><code class="n">close</code><code class="p">()</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">db</code> <code class="o">=</code> <code class="n">dbm</code><code class="o">.</code><code class="n">open</code><code class="p">(</code><code class="s">'definitions'</code><code class="p">,</code> <code class="s">'r'</code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">db</code><code class="p">[</code><code class="s">'mustard'</code><code class="p">]</code>&#13;
<code class="go">b'yellow'</code></pre>&#13;
&#13;
<p>Keys and values are stored as <code>bytes</code>.&#13;
You cannot iterate over the database object <code>db</code>,&#13;
but you can get the&#13;
number of keys by using <code>len()</code>.&#13;
<code>get()</code> and <code>setdefault()</code>&#13;
work as they do for dictionaries.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Memcached" data-type="sect2"><div class="sect2" id="memcached">&#13;
<h2>Memcached</h2>&#13;
&#13;
<p><a data-primary="memcached server" data-type="indexterm" id="idm45794975410152"/><a data-primary="NoSQL data stores" data-secondary="memcached" data-type="indexterm" id="idm45794975409448"/><a href="http://memcached.org"><code>memcached</code></a>&#13;
is a fast in-memory key-value <em>cache</em> server.&#13;
It’s often put in front of a database,&#13;
or used to store web server session data.</p>&#13;
&#13;
<p>You can download versions for&#13;
<a href="https://memcached.org/downloads">Linux and macOS</a> as well as <a href="http://bit.ly/memcache-win">Windows</a>.&#13;
If you want to try out this section,&#13;
you’ll need a running memcached server and Python driver.</p>&#13;
&#13;
<p>There are many Python drivers;&#13;
one that works with Python 3 is&#13;
<a href="https://oreil.ly/7FA3-"><code>python3-memcached</code></a>,&#13;
which you can install by using this command:</p>&#13;
<pre>$ <strong>pip install python-memcached</strong></pre>&#13;
&#13;
<p>To use it, connect to a memcached server,&#13;
after which you can do the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Set and get values for keys</p>&#13;
</li>&#13;
<li>&#13;
<p>Increment or decrement a value</p>&#13;
</li>&#13;
<li>&#13;
<p>Delete a key</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Data keys and values are <em>not</em> persistent,&#13;
and data that you wrote earlier might disappear.&#13;
This is inherent in memcached—it’s a cache server, not a database, and&#13;
it avoids running out of memory by discarding&#13;
old data.</p>&#13;
&#13;
<p>You can connect to multiple memcached servers at the same time.&#13;
In this next example,&#13;
we’re just talking to one on the same computer:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">memcache</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">db</code> <code class="o">=</code> <code class="n">memcache</code><code class="o">.</code><code class="n">Client</code><code class="p">([</code><code class="s">'127.0.0.1:11211'</code><code class="p">])</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">db</code><code class="o">.</code><code class="n">set</code><code class="p">(</code><code class="s">'marco'</code><code class="p">,</code> <code class="s">'polo'</code><code class="p">)</code>&#13;
<code class="go">True</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">db</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s">'marco'</code><code class="p">)</code>&#13;
<code class="go">'polo'</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">db</code><code class="o">.</code><code class="n">set</code><code class="p">(</code><code class="s">'ducks'</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code>&#13;
<code class="go">True</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">db</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s">'ducks'</code><code class="p">)</code>&#13;
<code class="go">0</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">db</code><code class="o">.</code><code class="n">incr</code><code class="p">(</code><code class="s">'ducks'</code><code class="p">,</code> <code class="mi">2</code><code class="p">)</code>&#13;
<code class="go">2</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">db</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s">'ducks'</code><code class="p">)</code>&#13;
<code class="go">2</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Redis" data-type="sect2"><div class="sect2" id="redis">&#13;
<h2>Redis</h2>&#13;
&#13;
<p><a data-primary="hashes" data-type="indexterm" id="ix_ch16-databases-asciidoc30"/><a data-primary="NoSQL data stores" data-secondary="Redis" data-type="indexterm" id="ix_ch16-databases-asciidoc31"/><a data-primary="Redis" data-type="indexterm" id="ix_ch16-databases-asciidoc32"/><a data-primary="time-to-live" data-type="indexterm" id="ix_ch16-databases-asciidoc33"/><a href="http://redis.io">Redis</a>&#13;
is a <em>data structure server</em>.&#13;
It handles keys and their values, but the values&#13;
are richer than those in other key-value stores.&#13;
Like memcached,&#13;
all of the data in a Redis server should fit in memory.&#13;
Unlike memcached, Redis can do the <span class="keep-together">following:</span></p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Save data to disk for reliability and restarts</p>&#13;
</li>&#13;
<li>&#13;
<p>Keep old data</p>&#13;
</li>&#13;
<li>&#13;
<p>Provide more data structures than simple strings</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The Redis data types are a close match to Python’s,&#13;
and a Redis server can be a useful intermediary for&#13;
one or more Python applications to share data.&#13;
I’ve found it so useful&#13;
that it’s worth a little extra coverage here.</p>&#13;
&#13;
<p>The Python driver <code>redis-py</code>&#13;
has its source code and tests on&#13;
<a href="https://oreil.ly/aZIbQ">GitHub</a>&#13;
as&#13;
well as <a href="http://bit.ly/redis-py-docs">documentation</a>.&#13;
You can install it by using this command:</p>&#13;
<pre>$ <strong>pip install redis</strong></pre>&#13;
&#13;
<p>The <a href="http://redis.io">Redis server</a> has good documentation.&#13;
If you install and start the Redis server&#13;
on your local computer&#13;
(with the network nickname <code>localhost</code>),&#13;
you can try the programs in the following sections.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Strings" data-type="sect3"><div class="sect3" id="redis_strings">&#13;
<h3>Strings</h3>&#13;
&#13;
<p><a data-primary="Redis" data-secondary="strings" data-type="indexterm" id="idm45794975288840"/><a data-primary="strings" data-secondary="in Redis" data-type="indexterm" id="idm45794975287976"/>A key with a single value is a Redis <em>string</em>.&#13;
Simple Python data types are automatically converted.&#13;
Connect to a Redis server at some host&#13;
(default is <code>localhost</code>)&#13;
and port (default is <code>6379</code>):</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">redis</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code> <code class="o">=</code> <code class="n">redis</code><code class="o">.</code><code class="n">Redis</code><code class="p">()</code></pre>&#13;
&#13;
<p>Connecting to <code>redis.Redis('localhost')</code>&#13;
or <code>redis.Redis('localhost', 6379)</code>&#13;
would have given the same result.</p>&#13;
&#13;
<p>List all keys (none so far):</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">keys</code><code class="p">(</code><code class="s">'*'</code><code class="p">)</code>&#13;
<code class="go">[]</code></pre>&#13;
&#13;
<p>Set a simple string (key <code>'secret'</code>),&#13;
integer (key <code>'carats'</code>),&#13;
and float (key <code>'fever'</code>):</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">set</code><code class="p">(</code><code class="s">'secret'</code><code class="p">,</code> <code class="s">'ni!'</code><code class="p">)</code>&#13;
<code class="go">True</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">set</code><code class="p">(</code><code class="s">'carats'</code><code class="p">,</code> <code class="mi">24</code><code class="p">)</code>&#13;
<code class="go">True</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">set</code><code class="p">(</code><code class="s">'fever'</code><code class="p">,</code> <code class="s">'101.5'</code><code class="p">)</code>&#13;
<code class="go">True</code></pre>&#13;
&#13;
<p>Get the values back (as Python <code>byte</code> values) by key:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s">'secret'</code><code class="p">)</code>&#13;
<code class="go">b'ni!'</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s">'carats'</code><code class="p">)</code>&#13;
<code class="go">b'24'</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s">'fever'</code><code class="p">)</code>&#13;
<code class="go">b'101.5'</code></pre>&#13;
&#13;
<p>Here, the <code>setnx()</code> method sets a value&#13;
only if the key does not exist:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">setnx</code><code class="p">(</code><code class="s">'secret'</code><code class="p">,</code> <code class="s">'icky-icky-icky-ptang-zoop-boing!'</code><code class="p">)</code>&#13;
<code class="go">False</code></pre>&#13;
&#13;
<p>It failed because we had already defined <code>'secret'</code>:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s">'secret'</code><code class="p">)</code>&#13;
<code class="go">b'ni!'</code></pre>&#13;
&#13;
<p>The <code>getset()</code> method&#13;
returns the old value and sets it to a new one at the same time:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">getset</code><code class="p">(</code><code class="s">'secret'</code><code class="p">,</code> <code class="s">'icky-icky-icky-ptang-zoop-boing!'</code><code class="p">)</code>&#13;
<code class="go">b'ni!'</code></pre>&#13;
&#13;
<p>Let’s not get too far ahead of ourselves. Did it work?</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s">'secret'</code><code class="p">)</code>&#13;
<code class="go">b'icky-icky-icky-ptang-zoop-boing!'</code></pre>&#13;
&#13;
<p>Now, get a substring by using <code>getrange()</code>&#13;
(as in Python, offset <code>0</code> means start, and <code>-1</code> means end):</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">getrange</code><code class="p">(</code><code class="s">'secret'</code><code class="p">,</code> <code class="o">-</code><code class="mi">6</code><code class="p">,</code> <code class="o">-</code><code class="mi">1</code><code class="p">)</code>&#13;
<code class="go">b'boing!'</code></pre>&#13;
&#13;
<p>Replace a substring&#13;
by using <code>setrange()</code>&#13;
(using a zero-based offset):</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">setrange</code><code class="p">(</code><code class="s">'secret'</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="s">'ICKY'</code><code class="p">)</code>&#13;
<code class="go">32</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s">'secret'</code><code class="p">)</code>&#13;
<code class="go">b'ICKY-icky-icky-ptang-zoop-boing!'</code></pre>&#13;
&#13;
<p>Next, set multiple keys at once by using <code>mset()</code>:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">mset</code><code class="p">({</code><code class="s">'pie'</code><code class="p">:</code> <code class="s">'cherry'</code><code class="p">,</code> <code class="s">'cordial'</code><code class="p">:</code> <code class="s">'sherry'</code><code class="p">})</code>&#13;
<code class="go">True</code></pre>&#13;
&#13;
<p>Get more than one value at once by using <code>mget()</code>:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">mget</code><code class="p">([</code><code class="s">'fever'</code><code class="p">,</code> <code class="s">'carats'</code><code class="p">])</code>&#13;
<code class="go">[b'101.5', b'24']</code></pre>&#13;
&#13;
<p>Delete a key by using <code>delete()</code>:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">delete</code><code class="p">(</code><code class="s">'fever'</code><code class="p">)</code>&#13;
<code class="go">True</code></pre>&#13;
&#13;
<p>Increment&#13;
by using the <code>incr()</code> or <code>incrbyfloat()</code> commands,&#13;
and decrement with <code>decr()</code>:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">incr</code><code class="p">(</code><code class="s">'carats'</code><code class="p">)</code>&#13;
<code class="go">25</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">incr</code><code class="p">(</code><code class="s">'carats'</code><code class="p">,</code> <code class="mi">10</code><code class="p">)</code>&#13;
<code class="go">35</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">decr</code><code class="p">(</code><code class="s">'carats'</code><code class="p">)</code>&#13;
<code class="go">34</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">decr</code><code class="p">(</code><code class="s">'carats'</code><code class="p">,</code> <code class="mi">15</code><code class="p">)</code>&#13;
<code class="go">19</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">set</code><code class="p">(</code><code class="s">'fever'</code><code class="p">,</code> <code class="s">'101.5'</code><code class="p">)</code>&#13;
<code class="go">True</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">incrbyfloat</code><code class="p">(</code><code class="s">'fever'</code><code class="p">)</code>&#13;
<code class="go">102.5</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">incrbyfloat</code><code class="p">(</code><code class="s">'fever'</code><code class="p">,</code> <code class="mf">0.5</code><code class="p">)</code>&#13;
<code class="go">103.0</code></pre>&#13;
&#13;
<p>There’s no <code>decrbyfloat()</code>.&#13;
Use a negative increment to reduce the fever:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">incrbyfloat</code><code class="p">(</code><code class="s">'fever'</code><code class="p">,</code> <code class="o">-</code><code class="mf">2.0</code><code class="p">)</code>&#13;
<code class="go">101.0</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before less_space" data-pdf-bookmark="Lists" data-type="sect3"><div class="sect3" id="redis_lists">&#13;
<h3>Lists</h3>&#13;
&#13;
<p><a data-primary="lists" data-secondary="in Redis" data-type="indexterm" id="idm45794974688808"/><a data-primary="Redis" data-secondary="lists" data-type="indexterm" id="idm45794974687832"/>Redis lists can contain only strings.&#13;
The list is created when you do your first insertion.&#13;
Insert at the beginning by using <code>lpush()</code>:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">lpush</code><code class="p">(</code><code class="s">'zoo'</code><code class="p">,</code> <code class="s">'bear'</code><code class="p">)</code>&#13;
<code class="go">1</code></pre>&#13;
&#13;
<p>Insert more than one item at the beginning:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">lpush</code><code class="p">(</code><code class="s">'zoo'</code><code class="p">,</code> <code class="s">'alligator'</code><code class="p">,</code> <code class="s">'duck'</code><code class="p">)</code>&#13;
<code class="go">3</code></pre>&#13;
&#13;
<p>Insert before or after a value by using <code>linsert()</code>:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">linsert</code><code class="p">(</code><code class="s">'zoo'</code><code class="p">,</code> <code class="s">'before'</code><code class="p">,</code> <code class="s">'bear'</code><code class="p">,</code> <code class="s">'beaver'</code><code class="p">)</code>&#13;
<code class="go">4</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">linsert</code><code class="p">(</code><code class="s">'zoo'</code><code class="p">,</code> <code class="s">'after'</code><code class="p">,</code> <code class="s">'bear'</code><code class="p">,</code> <code class="s">'cassowary'</code><code class="p">)</code>&#13;
<code class="go">5</code></pre>&#13;
&#13;
<p>Insert at an offset by using <code>lset()</code>&#13;
(the list must exist already):</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">lset</code><code class="p">(</code><code class="s">'zoo'</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="s">'marmoset'</code><code class="p">)</code>&#13;
<code class="go">True</code></pre>&#13;
&#13;
<p>Insert at the end by using <code>rpush()</code>:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">rpush</code><code class="p">(</code><code class="s">'zoo'</code><code class="p">,</code> <code class="s">'yak'</code><code class="p">)</code>&#13;
<code class="go">6</code></pre>&#13;
&#13;
<p>Get the value at an offset by using <code>lindex()</code>:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">lindex</code><code class="p">(</code><code class="s">'zoo'</code><code class="p">,</code> <code class="mi">3</code><code class="p">)</code>&#13;
<code class="go">b'bear'</code></pre>&#13;
&#13;
<p>Get the values in an offset range&#13;
by using <code>lrange()</code>&#13;
(0 to -1 for all):</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">lrange</code><code class="p">(</code><code class="s">'zoo'</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">2</code><code class="p">)</code>&#13;
<code class="go">[b'duck', b'alligator', b'marmoset']</code></pre>&#13;
&#13;
<p>Trim the list with <code>ltrim()</code>,&#13;
keeping only those in a range of offsets:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">ltrim</code><code class="p">(</code><code class="s">'zoo'</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">4</code><code class="p">)</code>&#13;
<code class="go">True</code></pre>&#13;
&#13;
<p>Get a range of values (use <code>0</code> to <code>-1</code> for all) by using <code>lrange()</code>:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">lrange</code><code class="p">(</code><code class="s">'zoo'</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="o">-</code><code class="mi">1</code><code class="p">)</code>&#13;
<code class="go">[b'alligator', b'marmoset', b'bear', b'cassowary']</code></pre>&#13;
&#13;
<p><a data-type="xref" href="ch15.html#ch_systems">Chapter 15</a> shows you how you can use&#13;
Redis lists&#13;
and <em>publish-subscribe</em>&#13;
to implement job queues.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Hashes" data-type="sect3"><div class="sect3" id="redis_hashes">&#13;
<h3>Hashes</h3>&#13;
&#13;
<p><a data-primary="Redis" data-secondary="hashes" data-type="indexterm" id="idm45794974367352"/>Redis <em>hashes</em> are similar to Python dictionaries&#13;
but can contain only strings.&#13;
Also, you can go only one level deep,&#13;
not make deep-nested structures.&#13;
Here are examples that create and play with&#13;
a Redis hash called <code>song</code>:</p>&#13;
&#13;
<p>Set the fields <code>do</code> and <code>re</code> in hash <code>song</code> at once&#13;
by using <code>hmset()</code>:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">hmset</code><code class="p">(</code><code class="s">'song'</code><code class="p">,</code> <code class="p">{</code><code class="s">'do'</code><code class="p">:</code> <code class="s">'a deer'</code><code class="p">,</code> <code class="s">'re'</code><code class="p">:</code> <code class="s">'about a deer'</code><code class="p">})</code>&#13;
<code class="go">True</code></pre>&#13;
&#13;
<p>Set a single field value in a hash by using <code>hset()</code>:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">hset</code><code class="p">(</code><code class="s">'song'</code><code class="p">,</code> <code class="s">'mi'</code><code class="p">,</code> <code class="s">'a note to follow re'</code><code class="p">)</code>&#13;
<code class="go">1</code></pre>&#13;
&#13;
<p>Get one field’s value by using <code>hget()</code>:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">hget</code><code class="p">(</code><code class="s">'song'</code><code class="p">,</code> <code class="s">'mi'</code><code class="p">)</code>&#13;
<code class="go">b'a note to follow re'</code></pre>&#13;
&#13;
<p>Get multiple field values by using <code>hmget()</code>:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">hmget</code><code class="p">(</code><code class="s">'song'</code><code class="p">,</code> <code class="s">'re'</code><code class="p">,</code> <code class="s">'do'</code><code class="p">)</code>&#13;
<code class="go">[b'about a deer', b'a deer']</code></pre>&#13;
&#13;
<p>Get all field keys for the hash by using <code>hkeys()</code>:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">hkeys</code><code class="p">(</code><code class="s">'song'</code><code class="p">)</code>&#13;
<code class="go">[b'do', b're', b'mi']</code></pre>&#13;
&#13;
<p>Get all field values for the hash by using <code>hvals()</code>:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">hvals</code><code class="p">(</code><code class="s">'song'</code><code class="p">)</code>&#13;
<code class="go">[b'a deer', b'about a deer', b'a note to follow re']</code></pre>&#13;
&#13;
<p>Get the number of fields in the hash by using <code>hlen()</code>:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">hlen</code><code class="p">(</code><code class="s">'song'</code><code class="p">)</code>&#13;
<code class="go">3</code></pre>&#13;
&#13;
<p>Get all field keys and values in the hash by using <code>hgetall()</code>:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">hgetall</code><code class="p">(</code><code class="s">'song'</code><code class="p">)</code>&#13;
<code class="go">{b'do': b'a deer', b're': b'about a deer', b'mi': b'a note to follow re'}</code></pre>&#13;
&#13;
<p>Set a field if its key doesn’t exist by using <code>hsetnx()</code>:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">hsetnx</code><code class="p">(</code><code class="s">'song'</code><code class="p">,</code> <code class="s">'fa'</code><code class="p">,</code> <code class="s">'a note that rhymes with la'</code><code class="p">)</code>&#13;
<code class="go">1</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Sets" data-type="sect3"><div class="sect3" id="redis_sets">&#13;
<h3>Sets</h3>&#13;
&#13;
<p><a data-primary="Redis" data-secondary="sets" data-type="indexterm" id="idm45794974026216"/><a data-primary="sets" data-secondary="in Redis" data-type="indexterm" id="idm45794974025208"/>Redis sets are similar to Python sets,&#13;
as you’ll see in the following examples.</p>&#13;
&#13;
<p class="pagebreak-before">Add one or more values to a set:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">sadd</code><code class="p">(</code><code class="s">'zoo'</code><code class="p">,</code> <code class="s">'duck'</code><code class="p">,</code> <code class="s">'goat'</code><code class="p">,</code> <code class="s">'turkey'</code><code class="p">)</code>&#13;
<code class="go">3</code></pre>&#13;
&#13;
<p>Get the number of values from the set:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">scard</code><code class="p">(</code><code class="s">'zoo'</code><code class="p">)</code>&#13;
<code class="go">3</code></pre>&#13;
&#13;
<p>Get all of the set’s values:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">smembers</code><code class="p">(</code><code class="s">'zoo'</code><code class="p">)</code>&#13;
<code class="go">{b'duck', b'goat', b'turkey'}</code></pre>&#13;
&#13;
<p>Remove a value from the set:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">srem</code><code class="p">(</code><code class="s">'zoo'</code><code class="p">,</code> <code class="s">'turkey'</code><code class="p">)</code>&#13;
<code class="go">True</code></pre>&#13;
&#13;
<p>Let’s make a second set to show some set operations:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">sadd</code><code class="p">(</code><code class="s">'better_zoo'</code><code class="p">,</code> <code class="s">'tiger'</code><code class="p">,</code> <code class="s">'wolf'</code><code class="p">,</code> <code class="s">'duck'</code><code class="p">)</code>&#13;
<code class="go">0</code></pre>&#13;
&#13;
<p>Intersect (get the common members of)&#13;
the <code>zoo</code> and <code>better_zoo</code> sets:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">sinter</code><code class="p">(</code><code class="s">'zoo'</code><code class="p">,</code> <code class="s">'better_zoo'</code><code class="p">)</code>&#13;
<code class="go">{b'duck'}</code></pre>&#13;
&#13;
<p>Get the intersection of <code>zoo</code> and <code>better_zoo</code>,&#13;
and store the result in the set <code>fowl_zoo</code>:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">sinterstore</code><code class="p">(</code><code class="s">'fowl_zoo'</code><code class="p">,</code> <code class="s">'zoo'</code><code class="p">,</code> <code class="s">'better_zoo'</code><code class="p">)</code>&#13;
<code class="go">1</code></pre>&#13;
&#13;
<p>Who’s in there?</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">smembers</code><code class="p">(</code><code class="s">'fowl_zoo'</code><code class="p">)</code>&#13;
<code class="go">{b'duck'}</code></pre>&#13;
&#13;
<p>Get the union (all members) of <code>zoo</code> and <code>better_zoo</code>:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">sunion</code><code class="p">(</code><code class="s">'zoo'</code><code class="p">,</code> <code class="s">'better_zoo'</code><code class="p">)</code>&#13;
<code class="go">{b'duck', b'goat', b'wolf', b'tiger'}</code></pre>&#13;
&#13;
<p>Store that union result in the set <code>fabulous_zoo</code>:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">sunionstore</code><code class="p">(</code><code class="s">'fabulous_zoo'</code><code class="p">,</code> <code class="s">'zoo'</code><code class="p">,</code> <code class="s">'better_zoo'</code><code class="p">)</code>&#13;
<code class="go">4</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">smembers</code><code class="p">(</code><code class="s">'fabulous_zoo'</code><code class="p">)</code>&#13;
<code class="go">{b'duck', b'goat', b'wolf', b'tiger'}</code></pre>&#13;
&#13;
<p>What does <code>zoo</code> have that <code>better_zoo</code> doesn’t?&#13;
Use <code>sdiff()</code> to get the set difference,&#13;
and <code>sdiffstore()</code> to save it in the <code>zoo_sale</code> set:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">sdiff</code><code class="p">(</code><code class="s">'zoo'</code><code class="p">,</code> <code class="s">'better_zoo'</code><code class="p">)</code>&#13;
<code class="go">{b'goat'}</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">sdiffstore</code><code class="p">(</code><code class="s">'zoo_sale'</code><code class="p">,</code> <code class="s">'zoo'</code><code class="p">,</code> <code class="s">'better_zoo'</code><code class="p">)</code>&#13;
<code class="go">1</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">smembers</code><code class="p">(</code><code class="s">'zoo_sale'</code><code class="p">)</code>&#13;
<code class="go">{b'goat'}</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Sorted sets" data-type="sect3"><div class="sect3" id="redis_zsets">&#13;
<h3>Sorted sets</h3>&#13;
&#13;
<p><a data-primary="Redis" data-secondary="sorted sets" data-type="indexterm" id="idm45794973656600"/><a data-primary="sets" data-secondary="sorted" data-type="indexterm" id="idm45794973655624"/><a data-primary="zsets (sorted sets)" data-type="indexterm" id="idm45794973654680"/>One of the most versatile&#13;
Redis data types is the <em>sorted set</em>,&#13;
or <em>zset</em>.&#13;
It’s a set of unique values,&#13;
but each value has&#13;
an associated floating-point <em>score</em>.&#13;
You can access each item by its value or score.&#13;
Sorted sets have many uses:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Leader boards</p>&#13;
</li>&#13;
<li>&#13;
<p>Secondary indexes</p>&#13;
</li>&#13;
<li>&#13;
<p>Timeseries, using timestamps as scores</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>We show the last use case,&#13;
tracking user logins via timestamps.&#13;
We’re using the Unix <em>epoch</em> value&#13;
(more on this in <a data-type="xref" href="ch15.html#ch_systems">Chapter 15</a>)&#13;
that’s returned by the Python <code>time()</code> <span class="keep-together">function:</span></p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">time</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">now</code> <code class="o">=</code> <code class="n">time</code><code class="o">.</code><code class="n">time</code><code class="p">()</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">now</code>&#13;
<code class="go">1361857057.576483</code></pre>&#13;
&#13;
<p>Let’s add our first guest, looking nervous:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">zadd</code><code class="p">(</code><code class="s">'logins'</code><code class="p">,</code> <code class="s">'smeagol'</code><code class="p">,</code> <code class="n">now</code><code class="p">)</code>&#13;
<code class="go">1</code></pre>&#13;
&#13;
<p>Five minutes later, another guest:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">zadd</code><code class="p">(</code><code class="s">'logins'</code><code class="p">,</code> <code class="s">'sauron'</code><code class="p">,</code> <code class="n">now</code><code class="o">+</code><code class="p">(</code><code class="mi">5</code><code class="o">*</code><code class="mi">60</code><code class="p">))</code>&#13;
<code class="go">1</code></pre>&#13;
&#13;
<p>Two hours later:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">zadd</code><code class="p">(</code><code class="s">'logins'</code><code class="p">,</code> <code class="s">'bilbo'</code><code class="p">,</code> <code class="n">now</code><code class="o">+</code><code class="p">(</code><code class="mi">2</code><code class="o">*</code><code class="mi">60</code><code class="o">*</code><code class="mi">60</code><code class="p">))</code>&#13;
<code class="go">1</code></pre>&#13;
&#13;
<p>One day later, not hasty:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">zadd</code><code class="p">(</code><code class="s">'logins'</code><code class="p">,</code> <code class="s">'treebeard'</code><code class="p">,</code> <code class="n">now</code><code class="o">+</code><code class="p">(</code><code class="mi">24</code><code class="o">*</code><code class="mi">60</code><code class="o">*</code><code class="mi">60</code><code class="p">))</code>&#13;
<code class="go">1</code></pre>&#13;
&#13;
<p>In what order did <code>bilbo</code> arrive?</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">zrank</code><code class="p">(</code><code class="s">'logins'</code><code class="p">,</code> <code class="s">'bilbo'</code><code class="p">)</code>&#13;
<code class="go">2</code></pre>&#13;
&#13;
<p>When was that?</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">zscore</code><code class="p">(</code><code class="s">'logins'</code><code class="p">,</code> <code class="s">'bilbo'</code><code class="p">)</code>&#13;
<code class="go">1361864257.576483</code></pre>&#13;
&#13;
<p class="pagebreak-before">Let’s see everyone in login order:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">zrange</code><code class="p">(</code><code class="s">'logins'</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="o">-</code><code class="mi">1</code><code class="p">)</code>&#13;
<code class="go">[b'smeagol', b'sauron', b'bilbo', b'treebeard']</code></pre>&#13;
&#13;
<p>With their times, please:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">zrange</code><code class="p">(</code><code class="s">'logins'</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="n">withscores</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>&#13;
<code class="go">[(b'smeagol', 1361857057.576483), (b'sauron', 1361857357.576483),</code>&#13;
<code class="go">(b'bilbo', 1361864257.576483), (b'treebeard', 1361943457.576483)]</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Caches and expiration" data-type="sect3"><div class="sect3" id="redis_expire">&#13;
<h3>Caches and expiration</h3>&#13;
&#13;
<p><a data-primary="caches, in Redis" data-type="indexterm" id="idm45794973342104"/><a data-primary="expiration dates" data-type="indexterm" id="idm45794973341512"/><a data-primary="Redis" data-secondary="caches/expiration" data-type="indexterm" id="idm45794973340840"/>All Redis keys have a time-to-live,&#13;
or <em>expiration date</em>.&#13;
By default, this is forever.&#13;
<a data-primary="expire() function" data-type="indexterm" id="idm45794973304536"/>We can use the <code>expire()</code> function to instruct Redis&#13;
how long to keep the key.&#13;
The value is a number of seconds:</p>&#13;
&#13;
<pre data-code-language="pycon" data-type="programlisting"><code class="gp">&gt;&gt;&gt; </code><code class="kn">import</code> <code class="nn">time</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">key</code> <code class="o">=</code> <code class="s">'now you see it'</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">set</code><code class="p">(</code><code class="n">key</code><code class="p">,</code> <code class="s">'but not for long'</code><code class="p">)</code>&#13;
<code class="go">True</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">expire</code><code class="p">(</code><code class="n">key</code><code class="p">,</code> <code class="mi">5</code><code class="p">)</code>&#13;
<code class="go">True</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">ttl</code><code class="p">(</code><code class="n">key</code><code class="p">)</code>&#13;
<code class="go">5</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">key</code><code class="p">)</code>&#13;
<code class="go">b'but not for long'</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mi">6</code><code class="p">)</code>&#13;
<code class="gp">&gt;&gt;&gt; </code><code class="n">conn</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="n">key</code><code class="p">)</code>&#13;
<code class="go">&gt;&gt;&gt;</code></pre>&#13;
&#13;
<p><a data-primary="expireat() function" data-type="indexterm" id="idm45794973252632"/>The <code>expireat()</code> command expires a key at&#13;
a given epoch time.&#13;
Key expiration is useful to keep caches fresh&#13;
and to limit login sessions.&#13;
An analogy:&#13;
in the refrigerated room behind the milk racks at your grocery store,&#13;
store employees yank those gallons as they reach&#13;
their freshness dates.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Document Databases" data-type="sect2"><div class="sect2" id="db_document">&#13;
<h2>Document Databases</h2>&#13;
&#13;
<p><a data-primary="databases" data-secondary="document databases" data-type="indexterm" id="idm45794973209304"/><a data-primary="document databases" data-type="indexterm" id="idm45794973208328"/><a data-primary="NoSQL data stores" data-secondary="document databases" data-type="indexterm" id="idm45794973207656"/>A <em>document database</em> is a&#13;
NoSQL database that&#13;
stores data with&#13;
varying fields.&#13;
Compared to a relational table&#13;
(rectangular, with the same columns in every row)&#13;
such data is “ragged,”&#13;
with varying fields (columns) per row,&#13;
and even nested fields.&#13;
You could handle data like this in memory with&#13;
Python dictionaries and lists,&#13;
or store it as JSON files.&#13;
To store such data in&#13;
a relational database table,&#13;
you would need to define every possible column&#13;
and use nulls for missing data.</p>&#13;
&#13;
<p><a data-primary="ODM (Object Data Manager/Object Document Mapper)" data-type="indexterm" id="idm45794973205400"/><em>ODM</em> can stand for&#13;
Object Data Manager or&#13;
Object Document Mapper&#13;
(at least they agree on the <em>O</em> part).&#13;
An ODM is the document database&#13;
counterpart of a relational database ORM.&#13;
Some&#13;
<a href="https://oreil.ly/5Zpxx">popular</a>&#13;
document databases&#13;
and tools&#13;
(drivers and ODMs) are listed in <a data-type="xref" href="#document_db_table">Table 16-6</a>.</p>&#13;
<table id="document_db_table">&#13;
<caption><span class="label">Table 16-6. </span>Document databases</caption>&#13;
<thead>&#13;
<tr>&#13;
<th>Database</th>&#13;
<th>Python API</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><a href="https://www.mongodb.com">Mongo</a></p></td>&#13;
<td><p><a href="https://api.mongodb.com/python/current/tools.html">tools</a></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><a href="https://aws.amazon.com/dynamodb">DynamoDB</a></p></td>&#13;
<td><p><a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/GettingStarted.Python.html"><code>boto3</code></a></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><a href="http://couchdb.apache.org">CouchDB</a></p></td>&#13;
<td><p><a href="https://couchdb-python.readthedocs.io/en/latest/index.html"><code>couchdb</code></a></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>PostgreSQL can do some of the things&#13;
that document databases do.&#13;
Some of its extensions allow it to escape relational orthodoxy&#13;
while keeping features like transactions, data validation,&#13;
and foreign keys:&#13;
1) multidimensional&#13;
<a href="https://oreil.ly/MkfLY"><em>arrays</em></a>—store more than one value in a table cell;&#13;
2) <a href="https://oreil.ly/K_VJg"><em>jsonb</em></a>—store JSON data in a cell, with full indexing and querying.<a data-startref="ix_ch16-databases-asciidoc33" data-type="indexterm" id="idm45794973188216"/><a data-startref="ix_ch16-databases-asciidoc32" data-type="indexterm" id="idm45794973187576"/><a data-startref="ix_ch16-databases-asciidoc31" data-type="indexterm" id="idm45794973186936"/><a data-startref="ix_ch16-databases-asciidoc30" data-type="indexterm" id="idm45794973186296"/></p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Time Series Databases" data-type="sect2"><div class="sect2" id="db_temporal">&#13;
<h2>Time Series Databases</h2>&#13;
&#13;
<p><a data-primary="databases" data-secondary="time series databases" data-type="indexterm" id="idm45794973183912"/><a data-primary="NoSQL data stores" data-secondary="time series databases" data-type="indexterm" id="idm45794973182712"/><a data-primary="time series databases" data-type="indexterm" id="idm45794973181768"/><em>Time series</em> data may be collected at fixed intervals&#13;
(such as computer performance metrics)&#13;
or at random times,&#13;
which has led to many storage methods.&#13;
Among&#13;
<a href="https://oreil.ly/CkjC0">many</a>&#13;
of&#13;
<a href="https://oreil.ly/IbOxQ">these</a>,&#13;
some with Python support are listed in <a data-type="xref" href="#temporal_db_table">Table 16-7</a>.</p>&#13;
<table id="temporal_db_table">&#13;
<caption><span class="label">Table 16-7. </span>Temporal databases</caption>&#13;
<thead>&#13;
<tr>&#13;
<th>Database</th>&#13;
<th>Python API</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><a href="https://www.influxdata.com">InfluxDB</a></p></td>&#13;
<td><p><a href="https://pypi.org/project/influx-client"><code>influx-client</code></a></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><a href="https://kx.com">kdb+</a></p></td>&#13;
<td><p><a href="https://code.kx.com/v2/interfaces/pyq/">PyQ</a></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><a href="https://prometheus.io">Prometheus</a></p></td>&#13;
<td><p><a href="https://github.com/prometheus/client_python/blob/master/README.md"><code>prometheus_client</code></a></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><a href="https://www.timescale.com">TimescaleDB</a></p></td>&#13;
<td><p>(PostgreSQL clients)</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><a href="http://opentsdb.net">OpenTSDB</a></p></td>&#13;
<td><p><a href="https://pypi.org/project/potsdb"><code>potsdb</code></a></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><a href="https://github.com/ranaroussi/pystore">PyStore</a></p></td>&#13;
<td><p><a href="https://pypi.org/project/PyStore"><code>PyStore</code></a></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Graph Databases" data-type="sect2"><div class="sect2" id="db_graph">&#13;
<h2>Graph Databases</h2>&#13;
&#13;
<p><a data-primary="databases" data-secondary="graph databases" data-type="indexterm" id="idm45794973141464"/><a data-primary="graph databases" data-type="indexterm" id="idm45794973140264"/><a data-primary="NoSQL data stores" data-secondary="graph databases" data-type="indexterm" id="idm45794973139592"/>For our last case of data that&#13;
need its own database category,&#13;
we have <em>graphs</em>:&#13;
<em>nodes</em> (data) connected by <em>edges</em> or <em>vertices</em>&#13;
(relationships).&#13;
An individual Twitter <em>user</em> could be a node,&#13;
with edges to other users&#13;
like <em>following</em> and <em>followed</em>.</p>&#13;
&#13;
<p>Graph data has become more visible with the growth&#13;
of social media, where the value is in the connections as much&#13;
as the content.&#13;
Some&#13;
<a href="https://oreil.ly/MAwMQ">popular</a>&#13;
graph databases are outlined in <a data-type="xref" href="#graph_db_table">Table 16-8</a>.</p>&#13;
<table id="graph_db_table">&#13;
<caption><span class="label">Table 16-8. </span>Graph databases</caption>&#13;
<thead>&#13;
<tr>&#13;
<th>Database</th>&#13;
<th>Python API</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><a href="https://neo4j.com">Neo4J</a></p></td>&#13;
<td><p><a href="https://py2neo.org/v3"><code>py2neo</code></a></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><a href="https://orientdb.com">OrientDB</a></p></td>&#13;
<td><p><a href="https://orientdb.com/docs/last/PyOrient.html"><code>pyorient</code></a></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><a href="https://www.arangodb.com">ArangoDB</a></p></td>&#13;
<td><p><a href="https://github.com/ArangoDB-Community/pyArango"><code>pyArango</code></a></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Other NoSQL" data-type="sect2"><div class="sect2" id="nosql_other">&#13;
<h2>Other NoSQL</h2>&#13;
&#13;
<p>The NoSQL servers listed here&#13;
handle data larger than memory,&#13;
and many of them use multiple computers.&#13;
<a data-type="xref" href="#nosql_table">Table 16-9</a> presents notable servers&#13;
and their Python <span class="keep-together">libraries.</span><a data-startref="ix_ch16-databases-asciidoc29" data-type="indexterm" id="idm45794973119144"/><a data-startref="ix_ch16-databases-asciidoc28" data-type="indexterm" id="idm45794973118472"/><a data-startref="ix_ch16-databases-asciidoc27" data-type="indexterm" id="idm45794973117784"/></p>&#13;
<table id="nosql_table">&#13;
<caption><span class="label">Table 16-9. </span>NoSQL databases</caption>&#13;
<thead>&#13;
<tr>&#13;
<th>Database</th>&#13;
<th>Python API</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><a href="http://cassandra.apache.org">Cassandra</a></p></td>&#13;
<td><p><a href="https://github.com/pycassa/pycassa"><code>pycassa</code></a></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><a href="http://couchdb.apache.org">CouchDB</a></p></td>&#13;
<td><p><a href="https://github.com/djc/couchdb-python"><code>couchdb-python</code></a></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><a href="http://hbase.apache.org">HBase</a></p></td>&#13;
<td><p><a href="https://github.com/wbolster/happybase"><code>happybase</code></a></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><a href="http://fallabs.com/kyotocabinet">Kyoto Cabinet</a></p></td>&#13;
<td><p><a href="http://bit.ly/kyotocabinet"><code>kyotocabinet</code></a></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><a href="http://www.mongodb.org">MongoDB</a></p></td>&#13;
<td><p><a href="http://api.mongodb.org/python/current"><code>mongodb</code></a></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><a href="https://www.pilosa.com">Pilosa</a></p></td>&#13;
<td><p><a href="https://github.com/pilosa/python-pilosa"><code>python-pilosa</code></a></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><a href="http://basho.com/riak">Riak</a></p></td>&#13;
<td><p><a href="https://github.com/basho/riak-python-client"><code>riak-python-client</code></a></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Full-Text Databases" data-type="sect1"><div class="sect1" id="full_text">&#13;
<h1>Full-Text Databases</h1>&#13;
&#13;
<p><a data-primary="databases" data-secondary="full-text" data-type="indexterm" id="idm45794973094200"/><a data-primary="full-text databases" data-type="indexterm" id="idm45794973093224"/><a data-primary="persistent storage" data-secondary="full-text databases" data-type="indexterm" id="idm45794973092552"/>Finally, there’s a special category of&#13;
databases for&#13;
<em>full-text</em> search.&#13;
They index everything,&#13;
so you can find that poem that&#13;
talks about windmills and giant wheels of cheese.&#13;
You can see some popular open source examples along with their Python APIs in <a data-type="xref" href="#full_text_table">Table 16-10</a>.</p>&#13;
<table id="full_text_table">&#13;
<caption><span class="label">Table 16-10. </span>Full-text databases</caption>&#13;
<thead>&#13;
<tr>&#13;
<th>Site</th>&#13;
<th>Python API</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><a href="http://lucene.apache.org">Lucene</a></p></td>&#13;
<td><p><a href="http://lucene.apache.org/pylucene"><code>pylucene</code></a></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><a href="http://lucene.apache.org/solr">Solr</a></p></td>&#13;
<td><p><a href="http://wiki.apache.org/solr/SolPython"><code>SolPython</code></a></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><a href="http://www.elasticsearch.org">ElasticSearch</a></p></td>&#13;
<td><p><a href="https://elasticsearch-py.readthedocs.io"><code>elasticsearch</code></a></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><a href="http://sphinxsearch.com">Sphinx</a></p></td>&#13;
<td><p><a href="http://bit.ly/sphinxapi"><code>sphinxapi</code></a></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><a href="http://xapian.org">Xapian</a></p></td>&#13;
<td><p><a href="https://code.google.com/p/xappy"><code>xappy</code></a></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><a href="http://bit.ly/mchaput-whoosh">Whoosh</a></p></td>&#13;
<td><p>(written in Python, includes an API)</p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Coming Up" data-type="sect1"><div class="sect1" id="idm45794973071624">&#13;
<h1>Coming Up</h1>&#13;
&#13;
<p>The previous chapter was about interleaving code in time&#13;
(<em>concurrency</em>).&#13;
The next one is about moving data through space&#13;
(<em>networking</em>),&#13;
which can be used for concurrency and other reasons.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Things to Do" data-type="sect1"><div class="sect1" id="idm45794973069144">&#13;
<h1>Things to Do</h1>&#13;
&#13;
<p>16.1&#13;
<a data-primary="persistent storage" data-secondary="practice exercises" data-type="indexterm" id="idm45794973067480"/>Save the following text lines to a file called <em>books.csv</em> (notice that if the fields are separated by commas,&#13;
you need to surround a field with quotes if it contains a comma):</p>&#13;
&#13;
<pre data-type="programlisting">author,book&#13;
J R R Tolkien,The Hobbit&#13;
Lynne Truss,"Eats, Shoots &amp; Leaves"</pre>&#13;
&#13;
<p>16.2&#13;
Use the <code>csv</code> module and its <code>DictReader</code> method&#13;
to read <em>books.csv</em> to the variable <code>books</code>.&#13;
Print the values in <code>books</code>.&#13;
Did <code>DictReader</code> handle the quotes and commas&#13;
in the second book’s title?</p>&#13;
&#13;
<p>16.3&#13;
Create a CSV file called <em>books2.csv</em> by using these lines:</p>&#13;
&#13;
<pre data-type="programlisting">title,author,year&#13;
The Weirdstone of Brisingamen,Alan Garner,1960&#13;
Perdido Street Station,China Miéville,2000&#13;
Thud!,Terry Pratchett,2005&#13;
The Spellman Files,Lisa Lutz,2007&#13;
Small Gods,Terry Pratchett,1992</pre>&#13;
&#13;
<p>16.4&#13;
Use the <code>sqlite3</code> module to create a SQLite database&#13;
called <em>books.db</em> and a table called <code>books</code> with these fields:&#13;
<code>title</code> (text), <code>author</code> (text), and <code>year</code> (integer).</p>&#13;
&#13;
<p>16.5&#13;
Read <em>books2.csv</em> and insert its data into the <code>book</code> table.</p>&#13;
&#13;
<p>16.6&#13;
Select and print the <code>title</code> column from&#13;
the <code>book</code> table in alphabetical order.</p>&#13;
&#13;
<p>16.7&#13;
Select and print all columns from&#13;
the <code>book</code> table in order of publication.</p>&#13;
&#13;
<p>16.8&#13;
Use the <code>sqlalchemy</code> module to connect to the&#13;
sqlite3 database <em>books.db</em> that you just made in exercise 16.4.&#13;
As in 16.6, select and print the <code>title</code> column from&#13;
the <code>book</code> table in alphabetical order.</p>&#13;
&#13;
<p>16.9&#13;
Install the Redis server and the Python <code>redis</code> library&#13;
(<code>pip install redis</code>) on your computer.&#13;
Create a Redis hash called <code>test</code> with the fields&#13;
<code>count</code> (<code>1</code>) and <code>name</code> (<code>'Fester Bestertester'</code>).&#13;
Print all the fields for <code>test</code>.</p>&#13;
&#13;
<p>16.10&#13;
Increment the <code>count</code> field of <code>test</code> and print it.<a data-startref="ix_ch16-databases-asciidoc0" data-type="indexterm" id="idm45794973045528"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<div data-type="footnotes"><p data-type="footnote" id="idm45794977436440"><sup><a href="ch16.html#idm45794977436440-marker">1</a></sup> Alas, not XML yet.</p></div></div></section></body></html>