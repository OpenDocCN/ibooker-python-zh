<html><head></head><body>
<div id="sbo-rt-content"><section data-nutshell-tab="Test, Debug, Optimize" data-pdf-bookmark="Chapter 17. Testing, Debugging, and Optimizing" data-type="chapter" epub:type="chapter"><div class="chapter" id="testingcomma_debuggingcomma_and_optimiz">
<h1><span class="label">Chapter 17. </span>Testing, Debugging, and Optimizing</h1>
<p>You’re not finished with a programming task when you’re done writing the code; you’re finished only when the code runs correctly and with acceptable performance. <em>Testing<a contenteditable="false" data-primary="testing" data-secondary="definition of term" data-type="indexterm" id="idm44924496570320"/></em> means verifying that code runs correctly by automatically exercising the code under known conditions and checking that the results are as expected. <em>Debugging<a contenteditable="false" data-primary="debugging" data-secondary="definition of term" data-type="indexterm" id="idm44924496568528"/></em> means discovering causes of incorrect behavior and repairing them (repair is often easy, once you figure out the causes).</p>
<p><em>Optimizing<a contenteditable="false" data-primary="optimization" data-secondary="definition of term" data-type="indexterm" id="idm44924496566448"/></em> is often used as an umbrella term for activities meant to ensure acceptable performance. Optimizing breaks down into <em>benchmarking</em> (measuring performance for given tasks to check that it’s within acceptable bounds), <em>profiling</em> (<em>instrumenting</em> the program with extra code to identify performance bottlenecks), and actual optimizing (removing bottlenecks to improve program performance). Clearly, you can’t remove performance bottlenecks until you’ve found out where they are (via profiling), which in turn requires knowing that there <em>are</em> performance problems (via benchmarking).</p>
<p>This chapter covers these subjects in the natural order in which they occur in development: testing first and foremost, debugging next, and optimizing last. Most programmers’ enthusiasm focuses on optimization: testing and debugging are often (wrongly!) perceived as being chores, while optimization is seen as being fun. Were you to read only one section of the chapter, we might suggest that section be <a data-type="xref" href="#developing_a_fast_enough_python_applica">“Developing a Fast-Enough Python Application”</a>, which summarizes the Pythonic approach to optimization—close to Jackson’s classic “<a href="https://oreil.ly/_dTA8">Rules of Optimization</a>: Rule 1. Don’t do it. Rule 2 (for experts only). Don’t do it <em>yet</em>.”</p>
<p class="pagebreak-before">All of these tasks are important; discussion of each could fill at least a book by itself. This chapter cannot even come close to exploring every related technique; rather, it focuses on Python-specific approaches and tools. Often, for best results, you should approach the issue from the higher-level viewpoint of<a contenteditable="false" data-primary="system analysis and design" data-type="indexterm" id="idm44924496559632"/> <em>system analysis and design</em>, rather than focusing only on implementation (in Python and/or any other mix of programming languages). Start by studying a good general book on the subject, such as <em>Systems Analysis and Design</em> by Alan Dennis, Barbara Wixom, and Roberta Roth (Wiley).</p>
<section data-pdf-bookmark="Testing" data-type="sect1"><div class="sect1" id="testing">
<h1>Testing</h1>
<p>In<a contenteditable="false" data-primary="testing" data-secondary="unit testing and system testing" data-type="indexterm" id="Tunitsys17"/><a contenteditable="false" data-primary="unit testing" data-type="indexterm" id="untest17"/><a contenteditable="false" data-primary="system testing" data-type="indexterm" id="systest17"/> this chapter, we distinguish between two different kinds of testing: <em>unit testing</em> and <em>system testing</em>. Testing is a rich, important field: many more distinctions could be drawn, but we focus on the issues that most matter to most software developers. Many developers are reluctant to spend time on testing, seeing it as time stolen from “real” development, but this is shortsighted: problems in code are easier to fix the earlier you find out about them. An extra hour spent developing tests will amply pay for itself as you find defects early, saving you many hours of debugging that would otherwise have been needed in later phases of the software development cycle.<sup><a data-type="noteref" href="ch17.xhtml#ch01fn125" id="ch01fn125-marker">1</a></sup></p>
<section data-pdf-bookmark="Unit Testing and System Testing" data-type="sect2"><div class="sect2" id="unit_testing_and_system_testing">
<h2>Unit Testing and System Testing</h2>
<p><em>Unit testing</em> means writing and running tests to exercise a single module, or an even smaller unit, such as a class or function. <em>System testing</em> (also known as<a contenteditable="false" data-primary="functional testing" data-type="indexterm" id="idm44924496544192"/><a contenteditable="false" data-primary="integration testing" data-type="indexterm" id="idm44924496543056"/><a contenteditable="false" data-primary=" end-to-end testing" data-type="indexterm" id="idm44924496541952"/> <em>functional</em>, <em>integration</em>, or <em>end-to-end</em> testing) involves running an entire program with known inputs. Some classic books on testing also draw the distinction between<a contenteditable="false" data-primary="white-box testing" data-type="indexterm" id="idm44924496539376"/> <em>white-box testing</em>, done with knowledge of a program’s internals, and<a contenteditable="false" data-primary="black-box testing" data-type="indexterm" id="idm44924496537632"/> <em>black-box testing</em>, done without such knowledge. This classic viewpoint parallels, but does not exactly duplicate, the modern one of unit versus system testing.</p>
<p>Unit and system testing serve different goals. Unit testing proceeds apace with development; you can and should test each unit as you’re developing it. One relatively modern approach (first proposed in 1971 in Gerald Weinberg’s immortal classic <em>The Psychology of Computer Programming</em> [Dorset House]) is known as<a contenteditable="false" data-primary="test-driven development (TDD)" data-type="indexterm" id="idm44924496535056"/><a contenteditable="false" data-primary="TDD (test-driven development)" data-type="indexterm" id="idm44924496533936"/> <em>test-driven development</em> (TDD): for each feature that your program must have, you first write unit tests, and only then do you proceed to write code that implements the feature and makes the tests pass. TDD may seem upside down, but it has advantages; for example, it ensures that you won’t omit unit tests for some feature. This approach is helpful because it urges you to focus first on exactly <em>what tasks</em> a certain function, class, or method should accomplish, dealing only afterward with <em>how</em> to implement that function, class, or method. An innovation along the lines of TDD is<a contenteditable="false" data-primary="behavior-driven development (BDD)" data-type="indexterm" id="idm44924496531408"/><a contenteditable="false" data-primary="BDD (behavior-driven development)" data-type="indexterm" id="idm44924496530288"/> <a href="http://behavior-driven.org"><em>behavior-driven development</em> (BDD)</a>.</p>
<p>To test a unit—which may depend on other units not yet fully developed—you often have to write<a contenteditable="false" data-primary="stubs" data-type="indexterm" id="idm44924496527328"/><a contenteditable="false" data-primary="mocks" data-type="indexterm" id="idm44924496526224"/> <em>stubs</em>, also known as <em>mocks</em>:<sup><a data-type="noteref" href="ch17.xhtml#ch01fn126" id="ch01fn126-marker">2</a></sup> fake implementations of various units’ interfaces giving known, correct responses in cases needed to test other units. The <span class="code">mock</span> module (part of Python’s standard library, in the package <a href="https://oreil.ly/iJJMn"><span class="code">unittest</span></a>) helps you implement such stubs.</p>
<p>System testing comes later, since it requires the system to exist, with at least some subset of system functionality believed (based on unit testing) to be working. System testing offers a soundness check: each module in the program works properly (passes unit tests), but does the <em>whole</em> program work? If each unit is OK but the system is not, there’s a problem in the integration between units—the way the units cooperate. For this reason, system testing is also known as integration testing.</p>
<p>System testing is similar to running the system in production use, except that you fix inputs in advance so that any problems you may find are easy to reproduce. The cost of failures in system testing is lower than in production use, since outputs from system testing are not used to make decisions, serve customers, control external systems, and so on. Rather, outputs from system testing are systematically compared with the outputs that the system <em>should</em> produce given the known inputs. The purpose is to find, in cheap and reproducible ways, discrepancies between what the program <em>should</em> do and what the program actually <em>does</em>.</p>
<p>Failures discovered by system testing (just like system failures in production use) may reveal defects in unit tests, as well as defects in the code. Unit testing may have been insufficient: a module’s unit tests may have failed to exercise all the needed functionality of the module. In that case, the unit tests need to be beefed up. Do that <em>before</em> you change your code to fix the problem, then run the newly enhanced unit tests to confirm that they now show the problem. Then fix the problem, and run the unit tests again to confirm that they no longer show it. Finally, rerun the system tests to confirm that the problem has indeed gone away.</p>
<div data-type="tip">
<h1>Bug-Fixing Best Practice</h1>
<p>This<a contenteditable="false" data-primary="bugs, fixing" data-type="indexterm" id="idm44924496513104"/> best practice is a specific application of test-driven design that we recommend without reservation: never fix a bug before having added unit tests that would have revealed the bug. This provides an excellent, cheap insurance against <a href="https://oreil.ly/msmPd">software regression bugs</a>.</p>
</div>
<p>Often, failures in system testing reveal communication problems within the development team:<sup><a data-type="noteref" href="ch17.xhtml#ch01fn127" id="ch01fn127-marker">3</a></sup> a module correctly implements a certain functionality, but another module expects different functionality. This kind of problem (an integration problem in the strict sense) is hard to pinpoint in unit testing. In good development practice, unit tests must run often, so it is crucial that they run fast. It’s therefore essential, in the unit testing phase, that each unit can assume other units are working correctly and as expected.</p>
<p>Unit tests run in reasonably late stages of development can reveal integration problems if the system architecture is hierarchical, a common and reasonable organization. In such an architecture, low-level modules depend on no others (except library modules, which you can typically assume to be correct), so the unit tests of such low-level modules, if complete, suffice to provide confidence of correctness. High-level modules depend on low-level ones, and thus also depend on correct understanding about what functionality each module expects and supplies. Running complete unit tests on high-level modules (using true low-level modules, not stubs) exercises interfaces between modules, as well as the high-level modules’ own code.</p>
<p>Unit tests for high-level modules are thus run in two ways. You run the tests with stubs for the low levels during the early stages of development, when the low-level modules are not yet ready or, later, when you only need to check the correctness of the high levels. During later stages of development, you also regularly run the high-level modules’ unit tests using the true low-level modules. In this way, you check the correctness of the whole subsystem, from the high levels downward. Even in this favorable case, you <em>still</em> need to run system tests to ensure that you have checked that all of the system’s functionality is exercised and you have neglected no interfaces between modules.</p>
<p>System testing is similar to running the program in normal ways. You need special support only to ensure supply of known inputs and capture of resulting outputs for comparison with expected outputs. This is easy for programs that perform I/O on files, and hard for programs whose I/O relies on a GUI, network, or other communication with external entities. To simulate such external entities and make them predictable and entirely observable, you generally need platform-dependent infrastructure. Another useful piece of supporting infrastructure for system testing is a<a contenteditable="false" data-primary="testing frameworks" data-type="indexterm" id="idm44924496506912"/> <em>testing framework</em> to automate the running of system tests, including logging of successes and failures. Such a framework can also help testers prepare sets of known inputs and corresponding expected outputs.</p>
<p>Both free and commercial programs for these purposes exist, and usually do not depend on which programming languages are used in the system under test. System testing is a close relative of what was classically known as black-box testing: testing that is independent from the implementation of the system under test (and thus, in particular, independent from the programming languages used for implementation). Instead, testing frameworks usually depend on the operating system platform on which they run, since the tasks they perform are platform dependent. These include:</p>
<ul>
<li>
<p>Running programs with given inputs</p>
</li>
<li>
<p>Capturing their outputs</p>
</li>
<li>
<p>Simulating/capturing GUI, network, and other interprocess communication I/O</p>
</li>
</ul>
<p>Since frameworks for system testing depend on the platform, not on programming languages, we do not cover them further in this book. For a thorough list of Python testing tools, see the Python <a href="https://oreil.ly/5RiTF">wiki</a>.<a contenteditable="false" data-primary="" data-startref="Tunitsys17" data-type="indexterm" id="idm44924496500592"/><a contenteditable="false" data-primary="" data-startref="untest17" data-type="indexterm" id="idm44924496499184"/><a contenteditable="false" data-primary="" data-startref="systest17" data-type="indexterm" id="idm44924496497808"/></p>
</div></section>
<section data-pdf-bookmark="The doctest Module" data-type="sect2"><div class="sect2" id="the_doctest_module">
<h2>The doctest Module</h2>
<p>The<a contenteditable="false" data-primary="testing" data-secondary="doctest module" data-type="indexterm" id="Tdoctest17"/><a contenteditable="false" data-primary="doctest module" data-type="indexterm" id="dtmod17"/><a contenteditable="false" data-primary="standard library modules" data-secondary="doctest" data-type="indexterm" id="idm44924496491152"/> <span class="code">doctest</span> module exists to let you create good examples in your code’s docstrings, checking that the examples do in fact produce the results that your docstrings show for them. <span class="code">doctest</span> recognizes such examples by looking within the docstring for the interactive Python prompt <span class="code">&gt;&gt;&gt;</span>, followed on the same line by a Python statement, and the statement’s expected output on the next line(s).</p>
<p>As you develop a module, keep the docstrings up-to-date and enrich them with examples. Each time a part of the module (e.g., a function) is ready, or partially ready, make it a habit to add examples to its docstring. Import the module into an interactive session, and use the parts you just developed to provide examples with a mix of typical cases, limit cases, and failing cases. For this specific purpose only, use <span class="code"><strong>from</strong></span> <span class="code"><em>module</em></span> <span class="code"><strong>import</strong></span> <span class="code">*</span> so that your examples don’t prefix <span class="code"><em>module</em></span><span class="code">.</span> to each name the module supplies. Copy and paste the interactive session into the docstring in an editor, adjust any glitches, and you’re almost done.</p>
<p>Your documentation is now enriched with examples, and readers will have an easier time following it (assuming you choose a good mix of examples, wisely seasoned with nonexample text). Make sure you have docstrings, with examples, for the module as a whole, and for each function, class, and method the module exports. You may choose to skip functions, classes, and methods whose names start with <span class="code">_</span>, since (as their names indicate) they’re private implementation details; <span class="code">doctest</span> by default ignores them, and so should readers of your module’s source code.</p>
<div data-type="tip">
<h1>Make Your Examples Match Reality</h1>
<p>Examples that don’t match the way your code works are worse than useless. Documentation and comments are useful only if they match reality; docs and comments that “lie” can be seriously damaging.</p>
</div>
<p>Docstrings and comments often get out of date as code changes, and thus become misinformation, hampering, rather than helping, any reader of the source. It’s better to have no comments and docstrings at all, poor as such a choice would be, than to have ones that lie. <span class="code">doctest</span> can help you by running and checking the examples in your docstrings. A failing <span class="code">doctest</span> run should prompt you to review the docstring that contains the failing example, thus reminding you to keep the whole docstring updated.</p>
<p>At the end of your module’s source, insert the following snippet:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="k">if</code></strong><code> </code><code class="vm">__name__</code><code> </code><code class="o">==</code><code> </code><code class="s1">'</code><code class="s1">__main__</code><code class="s1">'</code><code class="p">:</code><code>
</code><strong><code>   </code></strong><code> </code><strong><code class="kn">import</code></strong><code> </code><code class="nn">doctest</code><code>
</code><code>    </code><code class="n">doctest</code><code class="o">.</code><code class="n">testmod</code><code class="p">(</code><code class="p">)</code></pre>
<p>This code calls the function <span class="code">testmod</span> of the module <span class="code">doctest</span> when you run your module as the main program. <span class="code">testmod</span> examines docstrings (the module’s docstring, and the docstrings of all public functions, classes, and methods thereof). In each docstring, <span class="code">testmod</span> finds all examples (by looking for occurrences of the interpreter prompt <span class="code">&gt;&gt;&gt;</span>, possibly preceded by whitespace) and runs each example. <span class="code">testmod</span> checks that each example’s results match the output given in the docstring right after the example. In case of exceptions, <span class="code">testmod</span> ignores the traceback, and just checks that the expected and observed error messages are equal.</p>
<p>When everything goes right, <span class="code">testmod</span> terminates silently. Otherwise, it outputs detailed messages about the examples that failed, showing expected and actual output. <a data-type="xref" href="#example_onesix_onedot_using_doctest">Example 17-1</a> shows a typical example of <span class="code">doctest</span> at work on a module <em>mod.py</em>.</p>
<div data-type="example" id="example_onesix_onedot_using_doctest">
<h5><span class="label">Example 17-1. </span>Using <span class="code">doctest</span></h5>
<pre data-code-language="python" data-type="programlisting">
<em><code class="sd">"""</code></em><code class="sd">
</code><em><code class="sd">This module supplies a single function reverse_words that reverses</code></em><code class="sd">
</code><em><code class="sd">a string word by word.</code></em><code class="sd">

</code><em><code class="sd">&gt;&gt;&gt; reverse_words('four score and seven years')</code></em><code class="sd">
</code><em><code class="sd">'years seven and score four'</code></em><code class="sd">
</code><em><code class="sd">&gt;&gt;&gt; reverse_words('justoneword')</code></em><code class="sd">
</code><em><code class="sd">'justoneword'</code></em><code class="sd">
</code><em><code class="sd">&gt;&gt;&gt; reverse_words('')</code></em><code class="sd">
</code><em><code class="sd">''</code></em><code class="sd">

</code><em><code class="sd">You must call reverse_words with a single argument, a string:</code></em><code class="sd">

</code><em><code class="sd">&gt;&gt;&gt; reverse_words()</code></em><code class="sd">
</code><em><code class="sd">Traceback (most recent call last):</code></em><code class="sd">
</code><em><code class="sd">    ...</code></em><code class="sd">
</code><em><code class="sd">TypeError: reverse_words() missing 1 required positional argument: 'astring'</code></em><code class="sd">
</code><em><code class="sd">&gt;&gt;&gt; reverse_words('one', 'another')</code></em><code class="sd">
</code><em><code class="sd">Traceback (most recent call last):</code></em><code class="sd">
</code><em><code class="sd">    ...</code></em><code class="sd">
</code><em><code class="sd">TypeError: reverse_words() takes 1 positional argument but 2 were given</code></em><code class="sd">
</code><em><code class="sd">&gt;&gt;&gt; reverse_words(1)</code></em><code class="sd">
</code><em><code class="sd">Traceback (most recent call last):</code></em><code class="sd">
</code><em><code class="sd">    ...</code></em><code class="sd">
</code><em><code class="sd">AttributeError: 'int' object has no attribute 'split'</code></em><code class="sd">
</code><em><code class="sd">&gt;&gt;&gt; reverse_words('𝒰𝓷𝓲𝓬𝓸𝓭𝓮 is all right too')</code></em><code class="sd">
</code><em><code class="sd">'too right all is 𝒰𝓷𝓲𝓬𝓸𝓭𝓮'</code></em><code class="sd">

</code><em><code class="sd">As a side effect, reverse_words eliminates any redundant spacing:</code></em><code class="sd">

</code><em><code class="sd">&gt;&gt;&gt; reverse_words('with  redundant   spacing')</code></em><code class="sd">
</code><em><code class="sd">'spacing redundant with'</code></em><code class="sd">
</code><em><code class="sd">"""</code></em><code>
</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">reverse_words</code><code class="p">(</code><code class="n">astring</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">words</code><code> </code><code class="o">=</code><code> </code><code class="n">astring</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="n">words</code><code class="o">.</code><code class="n">reverse</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><strong><code class="k">return</code></strong><code> </code><code class="s1">'</code><code class="s1"> </code><code class="s1">'</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="n">words</code><code class="p">)</code><code>
</code><code>
</code><strong><code class="k">if</code></strong><code> </code><code class="vm">__name__</code><code> </code><code class="o">==</code><code> </code><code class="s1">'</code><code class="s1">__main__</code><code class="s1">'</code><code class="p">:</code><code>
</code><code>    </code><strong><code class="kn">import</code></strong><code> </code><code class="nn">doctest</code><code>
</code><code>    </code><code class="n">doctest</code><code class="o">.</code><code class="n">testmod</code><code class="p">(</code><code class="p">)</code></pre>
</div>
<p>In this module’s docstring, we snipped the tracebacks from the docstring and replaced them with ellipses (<span class="code">...</span>): this is good practice, since <span class="code">doctest</span> ignores tracebacks, which add nothing to the explanatory value of a failing case. Apart from this snipping, the docstring is the copy and paste of an interactive session, plus some explanatory text and empty lines for readability. Save this source as <em>mod.py</em>, and then run it with <span class="code"><strong>python mod.py</strong></span>. It produces no output, meaning that all the examples work right. Try <span class="code"><strong>python mod.py -v</strong></span> to get an account of all tests it tries, and a verbose summary at the end. Finally, alter the example results in the module docstring, making them incorrect, to see the messages <span class="code">doctest</span> provides for errant examples.</p>
<p>While <span class="code">doctest</span> is not meant for general-purpose unit testing, it can be tempting to use it for that purpose. The recommended way to do unit testing in Python is with a<a contenteditable="false" data-primary="test frameworks" data-type="indexterm" id="idm44924496309248"/> test framework such as <span class="code">unittest</span>, <span class="code">pytest</span>, or <span class="code">nose2</span> (covered in the following sections). However, unit testing with <span class="code">doctest</span> can be easier and faster to set up, since it requires little more than copying and pasting from an interactive session. If you need to maintain a module that lacks unit tests, retrofitting such tests into the module with <span class="code">doctest</span> is a reasonable short-term compromise, as a first step. It’s better to have just <span class="code">doctest</span>-based unit tests than not to have any unit tests at all, as might otherwise happen should you decide that setting up tests properly with <span class="code">unittest</span> from the start would take you too long.<sup><a data-type="noteref" href="ch17.xhtml#ch01fn128" id="ch01fn128-marker">4</a></sup></p>
<p>If you do decide to use <span class="code">doctest</span> for unit testing, don’t cram extra tests into your module’s docstrings. This would damage the docstrings by making them too long and hard to read. Keep in the docstrings the right amount and kind of examples, strictly for explanatory purposes, just as if unit testing were not in the picture. Instead, put the extra tests into a global variable of your module, a dictionary named <span class="code">__test__</span>. The keys in <span class="code">__test__</span> are strings to use as arbitrary test names; corresponding values are strings that <span class="code">doctest</span> picks up and uses just like it uses docstrings. The values in <span class="code">__test__</span> may also be function and class objects, in which case <span class="code">doctest</span> examines their docstrings for tests to run. This latter feature is a convenient way to run <span class="code">doctest</span> on objects with private names, which <span class="code">doctest</span> skips by default.</p>
<p>The <span class="code">doctest</span> module also supplies two functions that return instances of the <span class="code">unittest.TestSuite</span> class based on doctests, so that you can integrate such tests into testing frameworks based on <span class="code">unittest</span>. Full documentation for this advanced functionality is available <a href="https://oreil.ly/cbdu8">online</a>.<a contenteditable="false" data-primary="" data-startref="Tdoctest17" data-type="indexterm" id="idm44924496250080"/><a contenteditable="false" data-primary="" data-startref="dtmod17" data-type="indexterm" id="idm44924496248672"/></p>
</div></section>
<section data-pdf-bookmark="The unittest Module" data-type="sect2"><div class="sect2" id="the_unittest_module">
<h2>The unittest Module</h2>
<p>The<a contenteditable="false" data-primary="testing" data-secondary="unittest module" data-type="indexterm" id="Tunit17"/><a contenteditable="false" data-primary="unittest module" data-type="indexterm" id="unimod17"/><a contenteditable="false" data-primary="standard library modules" data-secondary="unittest" data-type="indexterm" id="idm44924496242208"/> <span class="code">unittest</span> module is the Python version of a unit testing framework originally developed by Kent Beck for Smalltalk. Similar, widespread versions of the framework also exist for many other programming languages (e.g., the <span class="code">JUnit</span> package for Java) and are often collectively referred to as <span class="code">xUnit</span>.</p>
<p>To use <span class="code">unittest</span>, don’t put your testing code in the same source file as the tested module: rather, write a separate test module for each module to test. A popular convention is to name the test module like the module being tested, with a prefix such as <span class="code">'test_'</span>, and put it in a subdirectory of the source’s directory named <em>test</em>. For example, the test module for <em>mod.py</em> can be <em>test/test_mod.py</em>. A simple, consistent naming convention helps you write and maintain auxiliary scripts that find and run all unit tests for a package.</p>
<p>Separation between a module’s source code and its unit testing code lets you refactor the module more easily, including possibly recoding some functionality in C without perturbing the unit testing code. Knowing that <em>test_mod.py</em> stays intact, whatever changes you make to <em>mod.py</em>, enhances your confidence that passing the tests in <em>test_mod.py</em> indicates that <em>mod.py</em> still works correctly after the changes.</p>
<p>A unit testing module defines one or more subclasses of <span class="code">unittest</span>’s<a contenteditable="false" data-primary="TestCase class (unittest module)" data-type="indexterm" id="idm44924496232096"/> <span class="code">TestCase</span> class. Each such subclass specifies one or more test cases by defining<a contenteditable="false" data-primary="test case methods" data-type="indexterm" id="idm44924496230144"/> <em>test case methods</em>: methods that are callable without arguments and whose names start with <span class="code">test</span>.</p>
<p>The subclass usually overrides <span class="code">setUp</span>, which the framework calls to prepare a new instance just before each test case, and often also<a contenteditable="false" data-primary="tearDown (unittest.TestCase class)" data-type="indexterm" id="idm44924496226368"/> <span class="code">tearDown</span>, which the framework calls to clean things up right after each test case; the entire setup/teardown arrangement is known as a<a contenteditable="false" data-primary="test fixtures" data-type="indexterm" id="idm44924496224448"/> <em>test fixture</em>.</p>
<p>Each test case calls, on <span class="code">self</span>, methods of the class <span class="code">TestCase</span> whose names start with <span class="code">assert</span> to express the conditions that the test must meet. <span class="code">unittest</span> runs the test case methods within a <span class="code">TestCase</span> subclass in arbitrary order, each on a new instance of the subclass, running <span class="code">setUp</span> just before each test case and <span class="code">tearDown</span> just after each test case.</p>
<div data-type="tip">
<h1>Have setUp Use addCleanup When Needed</h1>
<p>When <span class="code">setUp</span> propagates an exception, <span class="code">tearDown</span> does not execute. So, when <span class="code">setUp</span> prepares several things needing eventual cleanup, and some preparation steps might cause uncaught exceptions, it should not rely on <span class="code">tearDown</span> for the cleanup work. Instead, right after each preparation step succeeds, call <span class="code">self.addCleanup(<em>f</em>,</span> <span class="code"><em>*a</em></span><span class="code">,</span> <span class="code"><em>**k</em></span><span class="code">)</span>, passing a cleanup callable <span class="code"><em>f</em></span> (and optionally positional and named arguments for <span class="code"><em>f</em></span>). In this case, <span class="code"><em>f</em></span><span class="code">(*<em>a</em>,</span> <span class="code"><em>**k</em></span><span class="code">)</span> does get called after the test case (after <span class="code">tearDown</span> when <span class="code">setUp</span> propagates no exception, but, unconditionally, even when <span class="code">setUp</span> does propagate exceptions), so the necessary cleanup code always executes.</p>
</div>
<p><span class="code">unittest</span> provides other facilities, such as grouping test cases into test suites, per-class and per-module fixtures, test discovery, and other, even more advanced functionality. You do not need such extras unless you’re building a custom unit testing framework on top of <span class="code">unittest</span>, or, at the very least, structuring complex testing procedures for equally complex packages. In most cases, the concepts and details covered in this section are enough to perform effective and systematic unit testing. <a data-type="xref" href="#example_onesix_twodot_using_unittest">Example 17-2</a> shows how to use <span class="code">unittest</span> to provide unit tests for the module <em>mod.py</em> of <a data-type="xref" href="#example_onesix_onedot_using_doctest">Example 17-1</a>. This example, for purely demonstrative purposes, uses <span class="code">unittest</span> to perform exactly the same tests that <a data-type="xref" href="#example_onesix_onedot_using_doctest">Example 17-1</a> uses as examples in docstrings using <span class="code">doctest</span>.</p>
<div data-type="example" id="example_onesix_twodot_using_unittest">
<h5><span class="label">Example 17-2. </span>Using <span class="code">unittest</span></h5>
<pre data-code-language="python" data-type="programlisting">
<code class="sd">"""This module tests function reverse_words
provided by module mod.py."""</code><code>
</code><strong><code class="kn">import</code></strong><code> </code><code class="nn">unittest</code><code>
</code><strong><code class="kn">import</code></strong><code> </code><code class="nn">mod</code><code>
</code><code>
</code><strong><code class="k">class</code></strong><code> </code><code class="nc">ModTest</code><code class="p">(</code><code class="n">unittest</code><code class="o">.</code><code class="n">TestCase</code><code class="p">)</code><code class="p">:</code><code>
</code><code>
</code><code>    </code><strong><code class="k">def</code></strong><code> </code><code class="nf">testNormalCaseWorks</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">assertEqual</code><code class="p">(</code><code>
</code><code>            </code><code class="s1">'</code><code class="s1">years seven and score four</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>            </code><code class="n">mod</code><code class="o">.</code><code class="n">reverse_words</code><code class="p">(</code><code class="s1">'</code><code class="s1">four score and seven years</code><code class="s1">'</code><code class="p">)</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><strong><code class="k">def</code></strong><code> </code><code class="nf">testSingleWordIsNoop</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">assertEqual</code><code class="p">(</code><code>
</code><code>            </code><code class="s1">'</code><code class="s1">justoneword</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>            </code><code class="n">mod</code><code class="o">.</code><code class="n">reverse_words</code><code class="p">(</code><code class="s1">'</code><code class="s1">justoneword</code><code class="s1">'</code><code class="p">)</code><code class="p">)</code><code>
</code><code>            </code><code>
</code><code>    </code><strong><code class="k">def</code></strong><code> </code><code class="nf">testEmptyWorks</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">assertEqual</code><code class="p">(</code><code class="s1">'</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">mod</code><code class="o">.</code><code class="n">reverse_words</code><code class="p">(</code><code class="s1">'</code><code class="s1">'</code><code class="p">)</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><strong><code class="k">def</code></strong><code> </code><code class="nf">testRedundantSpacingGetsRemoved</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">assertEqual</code><code class="p">(</code><code>
</code><code>            </code><code class="s1">'</code><code class="s1">spacing redundant with</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>            </code><code class="n">mod</code><code class="o">.</code><code class="n">reverse_words</code><code class="p">(</code><code class="s1">'</code><code class="s1">with   redundant   spacing</code><code class="s1">'</code><code class="p">)</code><code class="p">)</code><code>
</code><code>            </code><code>
</code><code>    </code><strong><code class="k">def</code></strong><code> </code><code class="nf">testUnicodeWorks</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">assertEqual</code><code class="p">(</code><code>
</code><code>            </code><code class="s1">'</code><code class="s1">too right all is 𝒰𝓷𝓲𝓬𝓸𝓭𝓮</code><code class="s1">'</code><code>
</code><code>            </code><code class="n">mod</code><code class="o">.</code><code class="n">reverse_words</code><code class="p">(</code><code class="s1">'</code><code class="s1">𝒰𝓷𝓲𝓬𝓸𝓭𝓮 is all right too</code><code class="s1">'</code><code class="p">)</code><code class="p">)</code><code>
</code><code>            </code><code>
</code><code>    </code><strong><code class="k">def</code></strong><code> </code><code class="nf">testExactlyOneArgumentIsEnforced</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><strong><code class="k">with</code></strong><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">assertRaises</code><code class="p">(</code><code class="ne">TypeError</code><code class="p">)</code><code class="p">:</code><code>
</code><code>            </code><code class="n">mod</code><code class="o">.</code><code class="n">reverse_words</code><code class="p">(</code><code class="s1">'</code><code class="s1">one</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">another</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><strong><code class="k">def</code></strong><code> </code><code class="nf">testArgumentMustBeString</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><strong><code class="k">with</code></strong><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">assertRaises</code><code class="p">(</code><code class="p">(</code><code class="ne">AttributeError</code><code class="p">,</code><code> </code><code class="ne">TypeError</code><code class="p">)</code><code class="p">)</code><code class="p">:</code><code>
</code><code>            </code><code class="n">mod</code><code class="o">.</code><code class="n">reverse_words</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code>
</code><code>
</code><strong><code class="k">if</code></strong><code> </code><code class="vm">__name__</code><code class="o">==</code><code class="s1">'</code><code class="s1">__main__</code><code class="s1">'</code><code class="p">:</code><code>
</code><code>    </code><code class="n">unittest</code><code class="o">.</code><code class="n">main</code><code class="p">(</code><code class="p">)</code></pre>
</div>
<p>Running this script with <span class="code"><strong>python</strong></span> <span class="code"><strong>test/test_mod.py</strong></span> (or, equivalently, <span class="code"><strong>python</strong></span> <span class="code"><strong>-m test.test_mod</strong></span>) is just a bit more verbose than using <span class="code"><strong>python mod.py</strong></span> to run <span class="code">doctest</span>, as in <a data-type="xref" href="#example_onesix_onedot_using_doctest">Example 17-1</a>. <em>test_mod.py</em> outputs a <span class="code">.</span> (dot) for each test case it runs, then a separator line of dashes, and finally a summary line, such as “Ran 7 tests in 0.110s,” and a final line of “OK” if every test passed.</p>
<p>Each test case method makes one or more calls to methods whose names start with <span class="code">assert</span>. Here, no method has more than one such call; in more complicated cases, however, multiple calls to assert methods from a single test case method are common.</p>
<p>Even in a case as simple as this, one minor aspect shows that, for unit testing, <span class="code">unittest</span> is more powerful and flexible than <span class="code">doctest</span>. In the method <span class="code">testArgumentMustBeString</span>, we pass as the argument to <span class="code">assertRaises</span> a pair of exception classes, meaning we accept either kind of exception. <em>test_mod.py</em> therefore accepts these as valid multiple implementations of <em>mod.py</em>. It accepts the implementation in <a data-type="xref" href="#example_onesix_onedot_using_doctest">Example 17-1</a>, which tries calling the method <span class="code">split</span> on its argument, and therefore raises <span class="code">AttributeError</span> when called with an argument that is not a string. However, it also accepts a different hypothetical implementation, one that raises <span class="code">TypeError</span> instead when called with an argument of the wrong type. It is possible to code such checks with <span class="code">doctest</span>, but it would be awkward and nonobvious, while <span class="code">unittest</span> makes it simple and natural.</p>
<p>This kind of flexibility is crucial for real-life unit tests, which to some extent are executable specifications for their modules. You could, pessimistically, view the need for test flexibility as meaning the interface of the code you’re testing is not well-defined. However, it’s best to view the interface as being defined with a useful amount of flexibility for the implementer: under circumstance <span class="code"><em>X</em></span> (argument of invalid type passed to function <span class="code">reverse_words</span>, in this example), either of two things (raising <span class="code">AttributeError</span> or <span class="code">TypeError</span>) is allowed to happen.</p>
<p>Thus, implementations with either of the two behaviors are correct: the implementer can choose between them on the basis of such considerations as performance and clarity. Viewed in this way—as executable specifications for their modules (the modern view, and the basis of test-driven development), rather than as white-box tests strictly constrained to a specific implementation (as in some traditional taxonomies of testing)—unit tests become an even more vital component of the software development process.</p>
<section data-pdf-bookmark="The TestCase class" data-type="sect3"><div class="sect3" id="the_testcase_class">
<h3>The TestCase class</h3>
<p>With<a contenteditable="false" data-primary="TestCase class (unittest module)" data-type="indexterm" id="testcaseclass17"/> <span class="code">unittest</span>, you write test cases by extending <span class="code">TestCase</span>, adding methods, callable without arguments, whose names start with <span class="code">test</span>. These test case methods, in turn, call methods that your class inherits from <span class="code">TestCase</span>, whose names start with <span class="code">assert</span>, to indicate conditions that must hold for the tests to succeed.</p>
<p>The <span class="code">TestCase</span> class also defines two methods that your class can optionally override to group actions to perform right before and after each test case method runs. This doesn’t exhaust <span class="code">TestCase</span>’s functionality, but you won’t need the rest unless you’re developing testing frameworks or performing other advanced tasks. <a data-type="xref" href="#methods_of_an_instance_t_of_testcase">Table 17-1</a> lists the frequently called methods of a <span class="code">TestCase</span> instance <span class="code"><em>t</em></span>.</p>
<table class="border" id="methods_of_an_instance_t_of_testcase">
<caption><span class="label">Table 17-1. </span>Methods of an instance <span class="code">t</span> of <span class="code">TestCase</span></caption>
<tbody>
<tr>
<td class="width-20"><span class="code">a⁠s⁠s⁠e⁠r⁠t⁠A⁠l⁠m⁠o⁠s⁠t​E⁠q⁠u⁠a⁠l</span></td>
<td><span class="code">assertAlmostEqual(<em>first</em>,</span> <span class="code"><em>second</em></span><span class="code">, places=7, msg=<strong>None</strong>)</span><br/>
			Fails and outputs <span class="code">msg</span> when <span class="code"><em>first</em></span> <span class="code">!=</span> <span class="code"><em>second</em></span> to within <span class="code">places</span> decimal digits; otherwise, does nothing. This method is better than <span class="code">assertEqual</span> to compare <span class="code">float</span>s, since they are approximations that may differ in less significant decimal digits. When producing diagnostic messages if the test fails, <span class="code">unittest</span> will assume that <span class="code"><em>first</em></span> is the expected value and <span class="code"><em>second</em></span> is the observed value.</td>
</tr>
<tr>
<td><span class="code">assertEqual</span></td>
<td><span class="code">assertEqual(<em>first</em>,</span> <span class="code"><em>second</em></span><span class="code">, msg=<strong>None</strong>)</span><br/>
			Fails<a contenteditable="false" data-primary="assertEqual (unittest.TestCase class)" data-type="indexterm" id="idm44924495866160"/> and outputs <span class="code">msg</span> when <span class="code"><em>first</em></span> <span class="code">!=</span> <span class="code"><em>second</em></span>; otherwise, does nothing. When producing diagnostic messages if the test fails, <span class="code">unittest</span> will assume that <span class="code"><em>first</em></span> is the expected value and <span class="code"><em>second</em></span> is the observed value.</td>
</tr>
<tr>
<td><span class="code">assertFalse</span></td>
<td><span class="code">assertFalse(<em>condition</em>, msg=None)</span><br/>
			Fails and outputs <span class="code">msg</span> when <span class="code"><em>condition</em></span> is true; otherwise, does nothing.</td>
</tr>
<tr>
<td><span class="code">assertNotAlm⁠o⁠s⁠t​E⁠q⁠u⁠al</span></td>
<td><span class="code">assertNotAlmostEqual(<em>first</em>,</span> <span class="code"><em>second</em></span><span class="code">, places=7, msg=<strong>None</strong>)</span><br/>
			Fails and outputs <span class="code">msg</span> when <span class="code"><em>first</em></span> <span class="code">==</span> <span class="code"><em>second</em></span> to within <span class="code">places</span> decimal digits; otherwise, does nothing.</td>
</tr>
<tr>
<td><span class="code">assertNotEqual</span></td>
<td><span class="code">assertNotEqual(<em>first</em>,</span> <span class="code"><em>second</em></span><span class="code">, msg=<strong>None</strong>)</span><br/>
			Fails and outputs <span class="code">msg</span> when <span class="code"><em>first</em></span> <span class="code">==</span> <span class="code"><em>second</em></span>; otherwise, does nothing.</td>
</tr>
<tr>
<td><span class="code">assertRaises</span></td>
<td><span class="code">assertRaises(<em>exceptionSpec</em>,</span> <span class="code"><em>callable</em></span><span class="code">,</span> <span class="code"><em>*args</em></span><span class="code">,</span> <span class="code"><em>**kwargs</em></span><span class="code">)</span><br/>
			Calls<a contenteditable="false" data-primary="assertRaises (unittest.TestCase class)" data-type="indexterm" id="idm44924495830992"/> <span class="code"><em>callable</em></span><span class="code">(*<em>args</em>, **<em>kwargs</em>)</span>. Fails when the call doesn’t raise any exception. When the call raises an exception that does not meet <span class="code"><em>exceptionSpec</em></span>, <span class="code">assertRaises</span> propagates the exception. When the call raises an exception that meets <span class="code"><em>exceptionSpec</em></span>, <span class="code">assertRaises</span> does nothing. <span class="code"><em>exceptionSpec</em></span> can be an exception class or a tuple of classes, just like the first argument of the <span class="code"><strong>except</strong></span> clause in a <span class="code"><strong>try</strong></span><span class="code">/</span><span class="code"><strong>except</strong></span> statement.<br/>
			The preferred way to use <span class="code">assertRaises</span> is as a context manager—that is, in a <span class="code"><strong>with</strong></span> statement:
			<pre data-code-language="python" data-type="programlisting">
<strong><code class="k">with</code></strong><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">assertRaises</code><code class="p">(</code><em><code class="n">exceptionSpec</code></em><code class="p">)</code><code class="p">:</code><code>
</code><em><code>    </code><code class="c1"># ...a block of code...</code></em></pre>
Here, the block of code indented in the <span class="code"><strong>with</strong></span> statement executes, rather than just the <span class="code"><em>callable</em></span> being called with certain arguments. The expectation (which avoids the construct failing) is that the block of code raises an exception meeting the given exception specification (an exception class or a tuple of classes). This alternative approach is more general and readable than passing a callable.</td>
</tr>
<tr>
<td><span class="code">a⁠s⁠s⁠e⁠r⁠t⁠R⁠a⁠i⁠s⁠e⁠s​R⁠e⁠g⁠e⁠x</span></td>
<td><span class="code">assertRaisesRegex(<em>exceptionSpec</em>,</span> <span class="code"><em>expected_regex</em></span><span class="code">,</span> <span class="code"><em>callable</em></span><span class="code">,</span> <span class="code"><em>*args</em></span><span class="code">,</span> <span class="code"><em>**kwargs</em></span><span class="code">)</span><br/>
			Just like <span class="code">assertRaises</span>, but also checks that the exception’s error message matches <span class="code"><em>regex</em></span>; <span class="code"><em>regex</em></span> can be a regular expression object or a string pattern to compile into one, and the test (when the expected exception has been raised) checks the error message by calling <span class="code">search</span> on the RE object.<br/>
			Just like <span class="code">assertRaises</span>, <span class="code">assertRaisesRegex</span> is best used as a context manager—that is, in a <span class="code"><strong>with</strong></span> statement:
			<pre data-code-language="python" data-type="programlisting">
<strong><code class="k">with</code></strong><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">assertRaisesRegex</code><code class="p">(</code><em><code class="n">exceptionSpec</code><code class="p">,</code><code> </code><code class="n">regex</code></em><code class="p">)</code><code class="p">:</code><code>
</code><em><code>    </code><code class="c1"># ...a block of code...</code></em></pre></td>
</tr>
<tr>
<td><span class="code">enterContext</span></td>
<td><span class="code">enterContext(ctx_manager)</span><br/>
<span class="version">3.11+</span> Use this call in a <span class="code">TestCase.setup()</span> method. Returns the value from calling <span class="code">ctx_manager.__enter__</span>, and adds <span class="code">ctx_manager.__exit__</span> to the list of cleanup methods that the framework is to run during the <span class="code">TestCase</span>’s cleanup phase.</td>
</tr>
<tr>
<td><span class="code">fail</span></td>
<td><span class="code">fail(msg=<strong>None</strong>)</span><br/>
			Fails unconditionally and outputs <span class="code">msg</span>. An example snippet might be:
			<pre data-code-language="python" data-type="programlisting">
<strong><code class="k">if</code><code> </code><code class="ow">not</code></strong><code> </code><code class="n">complex_check_if_its_ok</code><code class="p">(</code><code class="n">some</code><code class="p">,</code><code> </code><code class="n">thing</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="bp">self</code><code class="o">.</code><code class="n">fail</code><code class="p">(</code><code>
</code><code>      </code><code class="s1">'</code><code class="s1">Complex checks failed on</code><code class="s1">'</code><code>
</code><code>      </code><code class="sa">f</code><code class="s1">'</code><code class="s1"> </code><code class="si">{</code><code class="n">some</code><code class="si">}</code><code class="s1">, </code><code class="si">{</code><code class="n">thing</code><code class="si">}</code><code class="s1">'</code><code>
</code><code>    </code><code class="p">)</code></pre></td>
</tr>
<tr>
<td><span class="code">setUp</span></td>
<td><span class="code">setUp()</span><br/>
			The<a contenteditable="false" data-primary="setUp (unittest.TestCase class)" data-type="indexterm" id="idm44924495697440"/> framework calls <span class="code"><em>t</em></span><span class="code">.setUp()</span> just before calling each test case method. <span class="code">setUp</span> in <span class="code">TestCase</span> does nothing; it exists only to let your class override the method when your class needs to perform some preparation for each test.</td>
</tr>
<tr>
<td><span class="code">subTest</span></td>
<td><span class="code">subTest(msg<em>=</em><strong>None</strong></span><span class="code">, **<em>k</em>)</span><br/>
			Returns a context manager that can define a portion of a test within a test method. Use <span class="code">subTest</span> when a test method runs the same test multiple times with varying parameters. Enclosing these parameterized tests in <span class="code">subTest</span> ensures that all the cases will be run, even if some of them fail or raise exceptions.</td>
</tr>
<tr>
<td><span class="code">tearDown</span></td>
<td><span class="code">tearDown()</span><br/>
			The<a contenteditable="false" data-primary="tearDown (unittest.TestCase class)" data-type="indexterm" id="idm44924495657936"/> framework calls <span class="code"><em>t</em></span><span class="code">.tearDown()</span> just after each test case method. <span class="code">tearDown</span> in the base <span class="code">TestCase</span> class does nothing; it exists only to let your class override the method when your class needs to perform some cleanup after each test.</td>
</tr>
</tbody>
</table>
<p>In addition, a <span class="code">TestCase</span> instance maintains a LIFO stack of <em>cleanup functions</em>. When code in one of your tests (or in <span class="code">setUp</span>) does something that requires cleanup, call <span class="code">self.addCleanup</span>, passing a cleanup callable <span class="code"><em>f</em></span> and optionally positional and named arguments for <span class="code"><em>f</em></span>. To perform the stacked cleanups, you may call <span class="code">doCleanups</span>; however, the framework itself calls <span class="code">doCleanups</span> after <span class="code">tearDown</span>. <a data-type="xref" href="#cleanup_methods_of_an_instance_t_of_tes">Table 17-2</a> lists the signatures of the two cleanup methods of a <span class="code">TestCase</span> instance <span class="code"><em>t</em></span>.</p>
<table class="border" id="cleanup_methods_of_an_instance_t_of_tes">
<caption><span class="label">Table 17-2. </span>Cleanup methods of an instance <span class="code">t</span> of <span class="code">TestCase</span></caption>
<tbody>
<tr>
<td class="width-15"><span class="code">addCleanup</span></td>
<td><span class="code">addCleanup(<em>func</em>,</span> <span class="code"><em>*a</em></span><span class="code">, **<em>k</em>)</span><br/>
			Appends<a contenteditable="false" data-primary="addCleanup (unittest.TestCase class)" data-type="indexterm" id="idm44924495636720"/> <span class="code">(<em>func</em>,</span> <span class="code"><em>a</em></span><span class="code">,</span> <span class="code"><em>k</em></span><span class="code">)</span> at the end of the cleanups list.</td>
</tr>
<tr>
<td><span class="code">doCleanups</span></td>
<td><span class="code">doCleanups()</span><br/>
			Performs all cleanups, if any are stacked. Substantially equivalent to:
			<pre data-code-language="python" data-type="programlisting">
<strong><code class="k">while</code></strong><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">list_of_cleanups</code><code class="p">:</code><code>
</code><code>    </code><code class="n">func</code><code class="p">,</code><code> </code><code class="n">a</code><code class="p">,</code><code> </code><code class="n">k</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">list_of_cleanups</code><code class="o">.</code><code class="n">pop</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><code class="n">func</code><code class="p">(</code><code class="o">*</code><code class="n">a</code><code class="p">,</code><code> </code><code class="o">*</code><code class="o">*</code><code class="n">k</code><code class="p">)</code></pre>
for a hypothetical stack <span class="code">self.list_of_cleanups</span>, plus, of course, error checking and reporting.<a contenteditable="false" data-startref="testcaseclass17" data-type="indexterm" id="idm44924495600656"/></td>
</tr>
</tbody>
</table>
</div></section>
<section data-pdf-bookmark="Unit tests dealing with large amounts of data" data-type="sect3"><div class="sect3" id="unit_tests_dealing_with_large_amounts_o">
<h3>Unit tests dealing with large amounts of data</h3>
<p>Unit tests must be fast, as you should run them often as you develop. So, when feasible, unit test each aspect of your modules on small amounts of data. This makes your unit tests faster, and lets you embed the data in the test’s source code. When you test a function that reads from or writes to a file object, use an instance of the class <span class="code">io.TextIO</span> for a text file (or <span class="code">io.BytesIO</span> for a binary file, as covered in <a data-type="xref" href="ch11.xhtml#in_memory_files_iodotstringio_and_iodot">“In-Memory Files: io.StringIO and io.BytesIO”</a>) to get a file with the data in memory: this approach is faster than writing to disk, and it requires no cleanup (removing disk files after the tests).</p>
<p>In rare cases, it may be impossible to exercise a module’s functionality without supplying and/or comparing data in quantities larger than can be reasonably embedded in a test’s source code. In such cases, your unit test must rely on auxiliary, external data files to hold the data to supply to the module it tests, and/or the data it needs to compare to the output. Even then, you’re generally better off using instances of the abovementioned <span class="code">io</span> classes, rather than directing the tested module to perform actual disk I/O. Even more importantly, we strongly suggest that you generally use stubs to unit test modules that interact with external entities, such as databases, GUIs, or other programs over a network. It’s easier to control all aspects of the test when using stubs rather than real external entities. Also, to reiterate, the speed at which you can run unit tests is important, and it’s faster to perform simulated operations with stubs than real operations.</p>
<div data-type="tip">
<h1>Make Test Randomness Reproducible by Supplying a Seed</h1>
<p>If your code uses<a contenteditable="false" data-primary="pseudorandom numbers" data-type="indexterm" id="idm44924495565696"/><a contenteditable="false" data-primary="seed (random module)" data-type="indexterm" id="idm44924495564720"/> pseudorandom numbers (e.g., as covered in <a data-type="xref" href="ch16.xhtml#the_random_module">“The random Module”</a>), you can make it easier to test by ensuring its “random” behavior is<a contenteditable="false" data-primary="reproducibility" data-type="indexterm" id="idm44924495562752"/> <em>reproducible</em>: specifically, ensure that it’s easy for your tests to call <span class="code">random.seed</span> with a known argument, so that the ensuing pseudorandom numbers are fully predictable. This also applies when you use pseudorandom numbers to set up your tests by generating inputs: such generation should default to a known seed, to be used in most testing, keeping the flexibility of changing seeds only for specific techniques such as<a contenteditable="false" data-primary="fuzzing" data-type="indexterm" id="idm44924495560384"/> <a href="https://oreil.ly/C17DL">fuzzing</a>.<a contenteditable="false" data-primary="" data-startref="Tunit17" data-type="indexterm" id="idm44924495558432"/><a contenteditable="false" data-primary="" data-startref="unimod17" data-type="indexterm" id="idm44924495557024"/></p>
</div>
</div></section>
</div></section>
<section data-pdf-bookmark="Testing with nose2" data-type="sect2"><div class="sect2" id="testing_with_nosetwo">
<h2>Testing with nose2</h2>
<p><span class="code">nose2</span><a contenteditable="false" data-primary="testing" data-secondary="nose2 utility and framework" data-type="indexterm" id="idm44924495553312"/><a contenteditable="false" data-primary="nose2 utility and framework" data-type="indexterm" id="idm44924495551968"/><a contenteditable="false" data-primary="testing frameworks" data-type="indexterm" id="testframe17"/> is a <span class="code">pip</span>-installable third-party test utility and framework that builds on top of <span class="code">unittest</span> to provide additional plug-ins, classes, and decorators to aid in writing and running your test suite. <span class="code">nose2</span> will “sniff out” test cases in your project, building its test suite by looking for <span class="code">unittest</span> test cases stored in files named <em>test*.py</em>.</p>
<p>Here is an example of using <span class="code">nose2</span>’s <span class="code">params</span> decorator to pass data parameters to a test function:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">unittest</code><code>
</code><strong><code class="kn">from</code></strong><code> </code><code class="nn">nose2</code><code class="nn">.</code><code class="nn">tools</code><code> </code><strong><code class="kn">import</code></strong><code> </code><code class="n">params</code><code>
</code><code>
</code><strong><code class="k">class</code></strong><code> </code><code class="nc">TestCase</code><code class="p">(</code><code class="n">unittest</code><code class="o">.</code><code class="n">TestCase</code><code class="p">)</code><code class="p">:</code><code>
</code><code>
</code><code>    </code><code class="nd">@params</code><code class="p">(</code><code class="p">(</code><code class="mi">5</code><code class="p">,</code><code> </code><code class="mi">5</code><code class="p">)</code><code class="p">,</code><code> </code><code class="p">(</code><code class="o">-</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">)</code><code class="p">,</code><code> </code><code class="p">(</code><code class="s1">'</code><code class="s1">a</code><code class="s1">'</code><code class="p">,</code><code> </code><strong><code class="kc">None</code></strong><code class="p">,</code><code> </code><code class="ne">TypeError</code><code class="p">)</code><code class="p">)</code><code>
</code><code>    </code><strong><code class="k">def</code></strong><code> </code><code class="nf">test_abs_value</code><code class="p">(</code><code class="bp">self</code><code class="p">,</code><code> </code><code class="n">x</code><code class="p">,</code><code> </code><code class="n">expected</code><code class="p">,</code><code> </code><code class="n">should_raise</code><code class="o">=</code><strong><code class="kc">None</code></strong><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><strong><code class="k">if</code></strong><code> </code><code class="n">should_raise</code><code> </code><strong><code class="ow">is</code><code> </code><code class="ow">not</code><code> </code><code class="kc">None</code></strong><code class="p">:</code><code>
</code><code>            </code><strong><code class="k">with</code></strong><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">assertRaises</code><code class="p">(</code><code class="n">should_raise</code><code class="p">)</code><code class="p">:</code><code>
</code><code>                </code><code class="nb">abs</code><code class="p">(</code><code class="n">x</code><code class="p">)</code><code>
</code><code>        </code><strong><code class="k">else</code></strong><code class="p">:</code><code>
</code><code>            </code><code class="k">assert</code><code> </code><code class="nb">abs</code><code class="p">(</code><code class="n">x</code><code class="p">)</code><code> </code><code class="o">==</code><code> </code><code class="n">expected</code></pre>
<p><span class="code">nose2</span> also includes additional decorators, the <span class="code">such</span> context manager to define groups of test functions, and a plug-in framework to provide testing metafunctions such as logging, debugging, and coverage reporting. For more information, see the <a href="https://oreil.ly/oFTIV">online docs</a>.</p>
</div></section>
<section class="pagebreak-before" data-pdf-bookmark="Testing with pytest" data-type="sect2"><div class="sect2" id="testing_with_pytest">
<h2 class="less_space">Testing with pytest</h2>
<p>The<a contenteditable="false" data-primary="pytest package" data-type="indexterm" id="idm44924495444816"/><a contenteditable="false" data-primary="testing" data-secondary="pytest package" data-type="indexterm" id="idm44924495443296"/> <span class="code">pytest</span> module is a <span class="code">pip</span>-installable third-party unit testing framework that introspects a project’s modules to find test cases in <em>test_*.py</em> or <em>*_test.py</em> files, with method names starting with <span class="code">test</span> at the module level, or in classes with names starting with <span class="code">Test</span>. Unlike the built-in <span class="code">unittest</span> framework, <span class="code">pytest</span> does not require that test cases extend any testing class hierarchy; it runs the discovered test methods, which use Python<a contenteditable="false" data-primary="assert statement" data-type="indexterm" id="idm44924495395680"/> <span class="code"><strong>assert</strong></span> statements to determine the success or failure of each test.<sup><a data-type="noteref" href="ch17.xhtml#ch01fn129" id="ch01fn129-marker">5</a></sup> If a test raises any exception other than <span class="code">AssertionError</span>, that indicates that there is an error in the test, rather than a simple test failure.</p>
<p>In place of a hierarchy of test case classes, <span class="code">pytest</span> provides a number of helper methods and decorators to simplify writing unit tests. The most common methods are listed in <a data-type="xref" href="#commonly_used_pytest_methods">Table 17-3</a>; consult the <a href="https://oreil.ly/a0WBi">online docs</a> for a more complete list of methods and optional arguments.</p>
<table class="border" id="commonly_used_pytest_methods">
<caption><span class="label">Table 17-3. </span>Commonly used <span class="code">pytest</span> methods</caption>
<tbody>
<tr>
<td><span class="code">approx</span></td>
<td><span class="code">approx(<em>float_value</em>)</span><br/>
			Used to support asserts that must compare floating-point values. <span class="code"><em>float_value</em></span> can be a single value or a sequence of values:
			<pre data-code-language="python" data-type="programlisting">
<strong><code class="k">assert</code></strong><code> </code><code class="mf">0.1</code><code> </code><code class="o">+</code><code> </code><code class="mf">0.2</code><code> </code><code class="o">==</code><code> </code><code class="n">approx</code><code class="p">(</code><code class="mf">0.3</code><code class="p">)</code><code>
</code><strong><code class="k">assert</code></strong><code> </code><code class="p">[</code><code class="mf">0.1</code><code class="p">,</code><code> </code><code class="mf">0.2</code><code class="p">,</code><code> </code><code class="mf">0.1</code><code class="o">+</code><code class="mf">0.2</code><code class="p">]</code><code> </code><code class="o">==</code><code> </code><code class="n">approx</code><code class="p">(</code><code class="p">[</code><code class="mf">0.1</code><code class="p">,</code><code> </code><code class="mf">0.2</code><code class="p">,</code><code> </code><code class="mf">0.3</code><code class="p">]</code><code class="p">)</code></pre></td>
</tr>
<tr>
<td><span class="code">fail</span></td>
<td><span class="code">fail(<em>failure_reason</em>)</span><br/>
			Forces failure of the current test. More explicit than injecting an <span class="code"><strong>assert False</strong></span> statement, but otherwise equivalent.</td>
</tr>
<tr>
<td><span class="code">raises</span></td>
<td><span class="code">raises(<em>expected_exception</em>, match=regex_match)</span><br/>
			A context manager that fails unless its context raises an exception <span class="code"><em>exc</em></span> such that <span class="code">isinstance(<em>exc</em>,</span> <span class="code"><em>expected_exception</em></span><span class="code">)</span> is true. When <span class="code">match</span> is given, the test fails unless <span class="code"><em>exc</em></span>’s <span class="code">str</span> representation also matches <span class="code">re.search(match, str(<em>exc</em>))</span>.</td>
</tr>
<tr>
<td><span class="code">skip</span></td>
<td><span class="code">skip(<em>skip_reason</em>)</span><br/>
			Forces skipping of the current test; use this, for example, when a test is dependent on a previous test that has already failed.</td>
</tr>
<tr>
<td><span class="code">warns</span></td>
<td><span class="code">warns(<em>expected_warning</em>, match<em>=regex_match</em>)</span><br/>
			Similar to <span class="code"><em>raises</em></span>; used to wrap code that tests that an expected warning is raised.</td>
</tr>
</tbody>
</table>
<p>The <span class="code">pytest.mark</span> subpackage includes decorators to “mark” test methods with additional test behavior, including the ones listed in <a data-type="xref" href="#decorators_in_the_pytestdotmark_subpack">Table 17-4</a>.</p>
<table class="border" id="decorators_in_the_pytestdotmark_subpack">
<caption><span class="label">Table 17-4. </span>Decorators in the <span class="code">pytest.mark</span> subpackage</caption>
<tbody>
<tr>
<td><span class="code">parametrize</span></td>
<td><span class="code">@parametrize(<em>args_string</em>,</span> <span class="code"><em>arg_test_values</em></span><span class="code">)</span><br/>
		Calls the decorated test method, setting the arguments named in the comma-separated list <span class="code"><em>args_string</em></span> to the values from each argument tuple in <span class="code"><em>arg_test_values</em></span>.<br/>
		The following code runs <span class="code">test_is_greater</span> twice, once with <span class="code">x=1</span>, <span class="code">y=0</span>, and <span class="code">expected=</span><span class="code"><strong>True</strong></span>; and once with <span class="code">x=0</span>, <span class="code">y=1</span>, and<a contenteditable="false" data-primary="" data-startref="testframe17" data-type="indexterm" id="idm44924495282384"/> <span class="code">expected=</span><span class="code"><strong>False</strong></span>.
		<pre data-code-language="python" data-type="programlisting">
<code class="nd">@pytest</code><code class="o">.</code><code class="n">mark</code><code class="o">.</code><code class="n">parametrize</code><code>
</code><code class="p">(</code><code class="s2">"</code><code class="s2">x,y,expected</code><code class="s2">"</code><code class="p">,</code><code> </code><code>
</code><code> </code><code class="p">[</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><strong><code class="kc">True</code></strong><code class="p">)</code><code class="p">,</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><strong><code class="kc">False</code></strong><code class="p">)</code><code class="p">]</code><code class="p">)</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">test_is_greater</code><code class="p">(</code><code class="n">x</code><code class="p">,</code><code> </code><code class="n">y</code><code class="p">,</code><code> </code><code class="n">expected</code><code class="p">)</code><code class="p">:</code><code>
</code><strong><code class="k">assert</code></strong><code> </code><code class="p">(</code><code class="n">x</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">y</code><code class="p">)</code><code> </code><code class="o">==</code><code> </code><code class="n">expected</code></pre></td>
</tr>
<tr>
<td class="width-15"><span class="code">skip</span>,<br/>
<span class="code">skipif</span></td>
<td><span class="code">@skip(<em>skip_reason</em>)</span>,<br/>
<span class="code">@skipif(<em>condition</em>,</span> <span class="code"><em>skip_reason</em></span><span class="code">)</span><br/>
			Skip a test method, optionally based on some global condition.</td>
</tr>
</tbody>
</table>
</div></section>
</div></section>
<section data-pdf-bookmark="Debugging" data-type="sect1"><div class="sect1" id="debugging">
<h1>Debugging</h1>
<p>Since<a contenteditable="false" data-primary="debugging" data-secondary="timing of" data-type="indexterm" id="idm44924495222368"/> Python’s development cycle is fast, the most effective way to debug is often to edit your code to output relevant information at key points. Python has many ways to let your code explore its own state to extract information that may be relevant for debugging. The <span class="code">inspect</span> and <span class="code">traceback</span> modules specifically support such exploration, which is also known as<a contenteditable="false" data-primary="reflection" data-type="indexterm" id="idm44924495187888"/><a contenteditable="false" data-primary="introspection" data-type="indexterm" id="idm44924495186880"/> <em>reflection</em> or <em>introspection</em>.</p>
<p>Once<a contenteditable="false" data-primary="debugging" data-secondary="printing versus logging information" data-type="indexterm" id="idm44924495184464"/><a contenteditable="false" data-primary="logging" data-secondary="debugging information" data-type="indexterm" id="idm44924495182704"/> you have debugging-relevant information, <span class="code">print</span> is often the natural way to display it (<span class="code">pprint</span>, covered in <a data-type="xref" href="ch09.xhtml#the_pprint_module">“The pprint Module”</a>, is also often a good choice). However, it’s frequently even better to <em>log</em> debugging information to files. Logging is useful for programs that run unattended (e.g., server programs). Displaying debugging information is just like displaying other information, as covered in <a data-type="xref" href="ch11.xhtml#file_and_text_operations">Chapter 11</a>. Logging such information is like writing to files (covered in the same chapter); however, Python’s standard library supplies a <span class="code">logging</span> module, covered in <a data-type="xref" href="ch06.xhtml#the_logging_module">“The logging module”</a>, to help with this frequent task. As covered in <a data-type="xref" href="ch08.xhtml#functions_and_attributes_of_the_sys_mod">Table 8-3</a>, rebinding <span class="code">excepthook</span> in the module <span class="code">sys</span> lets your program log error info just before terminating with a propagating exception.</p>
<p>Python also offers hooks to enable interactive debugging. The <span class="code">pdb</span> module supplies a simple text-mode interactive debugger. Other powerful interactive debuggers for Python are part of IDEs such as IDLE and various commercial offerings, as mentioned in <a data-type="xref" href="ch02.xhtml#python_development_environments">“Python Development Environments”</a>; we do not cover these advanced debuggers further in this book.</p>
<section class="pagebreak-before" data-pdf-bookmark="Before You Debug" data-type="sect2"><div class="sect2" id="before_you_debug">
<h2 class="less_space">Before You Debug</h2>
<p>Before<a contenteditable="false" data-primary="debugging" data-secondary="initial steps" data-type="indexterm" id="idm44924495169056"/> you embark on lengthy debugging explorations, make sure you have thoroughly checked your Python sources with the<a contenteditable="false" data-primary="programs" data-secondary="tools for checking" data-type="indexterm" id="idm44924495167392"/> tools mentioned in <a data-type="xref" href="ch02.xhtml#the_python_interpreter">Chapter 2</a>. Such tools catch only a subset of the bugs in your code, but they’re much faster than interactive debugging: their use amply pays for itself.</p>
<p>Moreover, again before starting a debugging session, make sure that all the code involved is well covered by unit tests, as described in <a data-type="xref" href="#the_unittest_module">“The unittest Module”</a>. As mentioned earlier in the chapter, once you have found a bug, <em>before</em> you fix it, add to your suite of unit tests (or, if need be, to the suite of system tests) a test or two that would have found the bug had they been present from the start, and run the tests again to confirm that they now reveal and isolate the bug; only once that is done should you proceed to fix the bug. Regularly following this procedure will help you learn to write better, more thorough tests, ensuring that you end up with a more robust test suite and have greater confidence in the overall, <em>enduring</em> correctness of your code.</p>
<p>Remember, even with all the facilities offered by Python, its standard library, and whatever IDE you fancy, debugging is still <em>hard</em>. Take this into account even before you start designing and coding: write and run plenty of unit tests, and keep your design and code <em>simple</em>, to reduce to the minimum the amount of debugging you will need! Brian Kernighan offers this classic advice: “Debugging is twice as hard as writing the code in the first place. Therefore, if you write the code as cleverly as you can, you are, by definition, not smart enough to debug it.” This is part of why “clever” is not a positive word when used to describe Python code, or a coder.</p>
</div></section>
<section data-pdf-bookmark="The inspect Module" data-type="sect2"><div class="sect2" id="the_inspect_module">
<h2>The inspect Module</h2>
<p>The<a contenteditable="false" data-primary="debugging" data-secondary="inspect module" data-type="indexterm" id="Dinspect17"/><a contenteditable="false" data-primary="inspect module" data-type="indexterm" id="insmod17"/><a contenteditable="false" data-primary="standard library modules" data-secondary="inspect" data-type="indexterm" id="idm44924495156016"/> <span class="code">inspect</span> module supplies functions to get information about all kinds of objects, including the Python call stack (which records all function calls currently executing) and source files. The most frequently used functions of <span class="code">inspect</span> are listed in <a data-type="xref" href="#useful_functions_of_the_inspect_module">Table 17-5</a>.</p>
<table class="border" id="useful_functions_of_the_inspect_module">
<caption><span class="label">Table 17-5. </span>Useful functions of the <span class="code">inspect</span> module</caption>
<tbody>
<tr>
<td class="width-20"><span class="code">currentframe</span></td>
<td><span class="code">currentframe()</span><br/>
			Returns<a contenteditable="false" data-primary="currentframe (inspect module)" data-type="indexterm" id="idm44924495147056"/> the frame object for the current function (the caller of <span class="code">currentframe</span>). <span class="code">formatargvalues(*getargvalues(currentframe()))</span>, for example, returns a string representing the arguments of the calling function.</td>
</tr>
<tr>
<td><span class="code">getargspec</span>,<br/>
<span class="code">formatargspec</span></td>
<td><span class="code">getargspec(<em>f</em>)</span><br/>
<span class="version">-3.11</span> Deprecated<a contenteditable="false" data-primary="getargspec (inspect module)" data-type="indexterm" id="idm44924495139536"/><a contenteditable="false" data-primary="formatargspec (inspect module)" data-type="indexterm" id="idm44924495138432"/> in Python 3.5, removed in Python 3.11. The forward-compatible way to introspect callables is to call <span class="code">inspect.signature(<em>f</em>)</span> and use the resulting instance of class <span class="code">inspect.Signature</span>, covered in the following subsection.</td>
</tr>
<tr>
<td><span class="code">get⁠a⁠r⁠g​v⁠a⁠l⁠ues</span>,<br/>
<span class="code">formatargvalues</span></td>
<td><span class="code">getargvalues(<em>f</em>)</span><br/>
<span class="code"><em>f</em></span> is<a contenteditable="false" data-primary="getargvalues (inspect module)" data-type="indexterm" id="idm44924495130000"/><a contenteditable="false" data-primary="formatargvalues (inspect module)" data-type="indexterm" id="idm44924495128928"/> a frame object—for example, the result of a call to the function <span class="code">_getframe</span> in the <span class="code">sys</span> module (covered in <a data-type="xref" href="ch14.xhtml#the_frame_type">“The Frame Type”</a>) or the function <span class="code">currentframe</span> in the <span class="code">inspect</span> module. <span class="code">getargvalues</span> returns a named tuple with four items: <span class="code">(<em>args</em>,</span> <span class="code"><em>varargs</em></span><span class="code">,</span> <span class="code"><em>keywords</em></span><span class="code">,</span> <span class="code"><em>locals</em></span><span class="code">).</span> <span class="code"><em>args</em></span> is the sequence of names of <span class="code"><em>f</em></span>’s function’s parameters. <span class="code"><em>varargs</em></span> is the name of the special parameter of form <span class="code"><em>*a</em></span>, or <span class="code"><strong>None</strong></span> when <span class="code"><em>f</em></span>’s function has no such parameter. <span class="code"><em>keywords</em></span> is the name of the special parameter of form <span class="code"><em>**k</em></span>, or <span class="code"><strong>None</strong></span> when <span class="code"><em>f</em></span>’s function has no such parameter. <span class="code"><em>locals</em></span> is the dictionary of local variables for <span class="code"><em>f</em></span>. Since arguments, in particular, are local variables, the value of each argument can be obtained from <span class="code"><em>locals</em></span> by indexing the <span class="code"><em>locals</em></span> dictionary with the argument’s corresponding parameter name.<br/>
<span class="code">formatargvalues</span> accepts one to four arguments that are the same as the items of the named tuple that <span class="code">getargvalues</span> returns, and returns a string with this information. <span class="code">formatargvalues(*getargvalues(<em>f</em>))</span> returns a string with <span class="code"><em>f</em></span>’s arguments in parentheses, in named form, as used in the call statement that created <span class="code"><em>f</em></span>. For example:
			<pre data-code-language="python" data-type="programlisting">
<strong><code class="k">def</code></strong><code> </code><code class="nf">f</code><code class="p">(</code><code class="n">x</code><code class="o">=</code><code class="mi">23</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><strong><code class="k">return</code></strong><code> </code><code class="n">inspect</code><code class="o">.</code><code class="n">currentframe</code><code class="p">(</code><code class="p">)</code><code>
</code><code class="nb">print</code><code class="p">(</code><code class="n">inspect</code><code class="o">.</code><code class="n">formatargvalues</code><code class="p">(</code><code>
</code><code>      </code><code class="o">*</code><code class="n">inspect</code><code class="o">.</code><code class="n">getargvalues</code><code class="p">(</code><code class="n">f</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code>
</code><em><code class="c1"># prints:</code></em><code class="c1"> </code><em><code class="c1">(x=23)</code></em></pre>
</td>
</tr>
<tr>
<td><span class="code">getdoc</span></td>
<td><span class="code">getdoc(<em>obj</em>)</span><br/>
			Returns<a contenteditable="false" data-primary="getdoc (inspect module)" data-type="indexterm" id="idm44924495064928"/> the docstring for <span class="code"><em>obj</em></span>, a multiline string with tabs expanded to spaces and redundant whitespace stripped from each line.</td>
</tr>
<tr>
<td><span class="code">getfile</span>,<br/>
<span class="code">getsourcefile</span></td>
<td><span class="code">getfile(<em>obj</em>)</span>,<br/>
<span class="code">getsourcefile(<em>obj</em>)</span><br/>
<span class="code">getfile</span> returns<a contenteditable="false" data-primary="getfile (inspect module)" data-type="indexterm" id="idm44924495027488"/><a contenteditable="false" data-primary="getsourcefile (inspect module)" data-type="indexterm" id="idm44924495026384"/> the name of the binary or source file that defined <span class="code"><em>obj</em></span>. Raises <span class="code">TypeError</span> when unable to determine the file (for example, when <span class="code"><em>obj</em></span> is a built-in). <span class="code">getsourcefile</span> returns the name of the source file that defined <span class="code">obj</span>; it raises <span class="code">TypeError</span> when all it can find is a binary file, not the corresponding source file.</td>
</tr>
<tr>
<td><span class="code">getmembers</span></td>
<td><span class="code">getmembers(<em>obj</em>, filter=<strong>None</strong>)</span><br/>
			Returns<a contenteditable="false" data-primary="getmembers (inspect module)" data-type="indexterm" id="idm44924495017328"/> all attributes (members), both data and methods (including special methods) of <span class="code"><em>obj</em></span>, as a sorted list of <span class="code">(<em>name</em>,</span> <span class="code"><em>value</em></span><span class="code">)</span> pairs. When <span class="code">filter</span> is not <span class="code"><strong>None</strong></span>, returns only attributes for which callable <span class="code">filter</span> returns a truthy result when called on the attribute’s <span class="code"><em>value</em></span>, equivalent to: 
			<pre data-code-language="python" data-type="programlisting">
<code class="p">(</code><code class="p">(</code><code class="n">n</code><code class="p">,</code><code> </code><code class="n">v</code><code class="p">)</code><code> </code><strong><code class="k">for</code></strong><code> </code><code class="n">n</code><code class="p">,</code><code> </code><code class="n">v</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">getmembers</code><code class="p">(</code><code class="n">obj</code><code class="p">)</code><code> </code><code>
</code><code>        </code><strong><code class="k">if</code></strong><code> </code><code class="nb">filter</code><code class="p">(</code><code class="n">v</code><code class="p">)</code><code class="p">)</code></pre>
</td>
</tr>
<tr>
<td><span class="code">getmodule</span></td>
<td><span class="code">getmodule(<em>obj</em>)</span><br/>
			Returns<a contenteditable="false" data-primary="getmodule (inspect module)" data-type="indexterm" id="idm44924494983312"/> the module that defined <span class="code"><em>obj</em></span>, or <span class="code"><strong>None</strong></span> when unable to determine it.</td>
</tr>
<tr>
<td><span class="code">getmro</span></td>
<td><span class="code">getmro(<em>c</em>)</span><br/>
			Returns<a contenteditable="false" data-primary="getmro (inspect module)" data-type="indexterm" id="idm44924494953344"/> a tuple of bases and ancestors of class <span class="code"><em>c</em></span> in method resolution order (discussed in <a data-type="xref" href="ch04.xhtml#inheritance">“Inheritance”</a>). <span class="code"><em>c</em></span> is the first item in the tuple, and each class appears only once in the tuple. For example: 
			<pre data-code-language="python" data-type="programlisting">
<strong><code class="k">class</code></strong><code> </code><code class="nc">A</code><code class="p">:</code><code> </code><strong><code class="k">pass</code></strong><code>
</code><strong><code class="k">class</code></strong><code> </code><code class="nc">B</code><code class="p">(</code><code class="n">A</code><code class="p">)</code><code class="p">:</code><code> </code><strong><code class="k">pass</code></strong><code>
</code><strong><code class="k">class</code></strong><code> </code><code class="nc">C</code><code class="p">(</code><code class="n">A</code><code class="p">)</code><code class="p">:</code><code> </code><strong><code class="k">pass</code></strong><code>
</code><strong><code class="k">class</code></strong><code> </code><code class="nc">D</code><code class="p">(</code><code class="n">B</code><code class="p">,</code><code> </code><code class="n">C</code><code class="p">)</code><code class="p">:</code><code> </code><strong><code class="k">pass</code></strong><code>
</code><strong><code class="k">for</code></strong><code> </code><code class="n">c</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">inspect</code><code class="o">.</code><code class="n">getmro</code><code class="p">(</code><code class="n">D</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="n">c</code><code class="o">.</code><code class="vm">__name__</code><code class="p">,</code><code> </code><code class="n">end</code><code class="o">=</code><code class="s1">'</code><code class="s1"> </code><code class="s1">'</code><code class="p">)</code><code>
</code><em><code class="c1"># prints: D B C A object</code></em></pre>
</td>
</tr>
<tr>
<td><span class="code">getsource</span>,<br/>
<span class="code">getsourcelines</span></td>
<td><span class="code">getsource(<em>obj</em>)</span>,<br/>
<span class="code">getsourcelines(<em>obj</em>)</span><br/>
<span class="code">getsource</span> returns<a contenteditable="false" data-primary="getsource (inspect module)" data-type="indexterm" id="idm44924494888048"/><a contenteditable="false" data-primary="getsourcelines (inspect module)" data-type="indexterm" id="idm44924494886944"/> a multiline string that is the source code for <span class="code"><em>obj</em></span>, and raises <span class="code">IOError</span> if it is unable to determine or fetch it. <span class="code">getsourcelines</span> returns a pair: the first item is the source code for <span class="code"><em>obj</em></span> (a list of lines), and the second item is the line number of the first line within its file.</td>
</tr>
<tr>
<td><span class="code">isbuiltin</span>, <span class="code">isclass</span>,<br/>
<span class="code">iscode</span>, <span class="code">isframe</span>,<br/>
<span class="code">isfunction</span>,<br/>
<span class="code">ismethod</span>,<br/>
<span class="code">ismodule</span>,<br/>
<span class="code">isroutine</span></td>
<td><span class="code">isbuiltin(<em>obj</em>)</span>, etc.<br/>
			Each of these functions accepts a single argument <span class="code"><em>obj</em></span> and returns <span class="code"><strong>True</strong></span> when <span class="code"><em>obj</em></span> is of the kind indicated in the function name. Accepted objects are, respectively: built-in (C-coded) functions, class objects, code objects, frame objects, Python-coded functions (including <span class="code"><strong>lambda</strong></span> expressions), methods, modules, and—for <span class="code">isroutine</span>—all methods or functions, either C-coded or Python-coded. These functions are often used as the <span class="code">filter</span> argument to <span class="code">getmembers</span>.</td>
</tr>
<tr>
<td><span class="code">stack</span></td>
<td><span class="code">stack(context=1)</span><br/>
			Returns<a contenteditable="false" data-primary="stack (inspect module)" data-type="indexterm" id="idm44924494833312"/> a list of six-item tuples. The first tuple is about <span class="code">stack</span>’s caller, the second about the caller’s caller, and so on. The items in each tuple are: frame object, filename, line number, function name, list of <span class="code">context</span> source lines around the current line, index of current line within the list.</td>
</tr>
</tbody>
</table>
<section data-pdf-bookmark="Introspecting callables" data-type="sect3"><div class="sect3" id="introspecting_callables">
<h3>Introspecting callables</h3>
<p>To introspect a callable’s signature, call <span class="code">inspect.signature(<em>f</em>)</span>, which returns an instance <span class="code"><em>s</em></span> of class <span class="code">inspect.Signature</span>.</p>
<p><span class="code"><em>s</em></span><span class="code">.parameters</span> is a <span class="code">dict</span> mapping parameter names to <span class="code">inspect.Parameter</span> instances. Call <span class="code"><em>s</em></span><span class="code">.bind(*<em>a</em>,</span> <span class="code"><em>**k</em></span><span class="code">)</span> to bind all parameters to the given positional and named arguments, or <span class="code"><em>s</em></span><span class="code">.bind_partial(<em>*a</em>,</span> <span class="code"><em>**k</em></span><span class="code">)</span> to bind a subset of them: each returns an instance <span class="code"><em>b</em></span> of <span class="code">inspect.BoundArguments</span>.</p>
<p>For detailed information and examples of how to introspect callables’ signatures through these classes and their methods, see <a href="https://oreil.ly/e2Sb_">PEP 362</a>.</p>
</div></section>
<section data-pdf-bookmark="An example of using inspect" data-type="sect3"><div class="sect3" id="an_example_of_using_inspect">
<h3>An example of using inspect</h3>
<p>Suppose that somewhere in your program you execute a statement such as:</p>
<pre data-code-language="python" data-type="programlisting">
<code class="n">x</code><code class="o">.</code><code class="n">f</code><code class="p">()</code></pre>
<p>and unexpectedly receive an <span class="code">AttributeError</span> informing you that object <span class="code">x</span> has no attribute named <span class="code">f</span>. This means that object <span class="code">x</span> is not as you expected, so you want to determine more about <span class="code">x</span> as a preliminary to ascertaining why <span class="code">x</span> is that way and what you should do about it. A simple first approach might be:</p>
<pre data-code-language="python" data-type="programlisting">
<code class="nb">print</code><code class="p">(</code><code class="nb">type</code><code class="p">(</code><code class="n">x</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">x</code><code class="p">)</code><code>
</code><em><code class="c1"># or, from v3.8, use an f-string with a trailing '=' to show repr(x)</code></em><code>
</code><em><code class="c1"># print(f'{x=}')</code></em><code>
</code><code class="n">x</code><code class="o">.</code><code class="n">f</code><code class="p">(</code><code class="p">)</code></pre>
<p>This will often provide sufficient information to go on; or you might change it to <span class="code">print(type(x), dir(x), x)</span> to see what <span class="code">x</span>’s methods and attributes are. But if this isn’t sufficient, change the statement to:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="k">try</code></strong><code class="p">:</code><code>
</code><code>    </code><code class="n">x</code><code class="o">.</code><code class="n">f</code><code class="p">(</code><code class="p">)</code><code>
</code><strong><code class="k">except</code></strong><code> </code><code class="ne">AttributeError</code><code class="p">:</code><code>
</code><strong><code>   </code></strong><code> </code><strong><code class="kn">import</code></strong><code> </code><code class="nn">sys</code><strong><code class="o">,</code></strong><code> </code><code class="nn">inspect</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s1">'</code><code class="s1">x is type </code><code class="si">{</code><code class="nb">type</code><code class="p">(</code><code class="n">x</code><code class="p">)</code><code class="o">.</code><code class="vm">__name__</code><code class="si">}</code><code class="s1">, (</code><code class="si">{</code><code class="n">x</code><code class="si">!r}</code><code class="s1">)</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="n">file</code><code class="o">=</code><code class="n">sys</code><code class="o">.</code><code class="n">stderr</code><code class="p">)</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="s2">"</code><code class="s2">x</code><code class="s2">'</code><code class="s2">s methods are:</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">file</code><code class="o">=</code><code class="n">sys</code><code class="o">.</code><code class="n">stderr</code><code class="p">,</code><code> </code><code class="n">end</code><code class="o">=</code><code class="s1">'</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>    </code><strong><code class="k">for</code></strong><code> </code><code class="n">n</code><code class="p">,</code><code> </code><code class="n">v</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">inspect</code><code class="o">.</code><code class="n">getmembers</code><code class="p">(</code><code class="n">x</code><code class="p">,</code><code> </code><code class="n">callable</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="nb">print</code><code class="p">(</code><code class="n">n</code><code class="p">,</code><code> </code><code class="n">file</code><code class="o">=</code><code class="n">sys</code><code class="o">.</code><code class="n">stderr</code><code class="p">,</code><code> </code><code class="n">end</code><code class="o">=</code><code class="s1">'</code><code class="s1"> </code><code class="s1">'</code><code class="p">)</code><code>
</code><code>    </code><code class="nb">print</code><code class="p">(</code><code class="n">file</code><code class="o">=</code><code class="n">sys</code><code class="o">.</code><code class="n">stderr</code><code class="p">)</code><code>
</code><strong><code>   </code></strong><code> </code><strong><code class="k">raise</code></strong></pre>
<p>This example properly uses <span class="code">sys.stderr</span> (covered in <a data-type="xref" href="ch08.xhtml#functions_and_attributes_of_the_sys_mod">Table 8-3</a>), since it displays information related to an error, not program results. The function <span class="code">getmembers</span> of the module <span class="code">inspect</span> obtains the names of all the methods available on <span class="code">x</span> in order to display them. If you often need this kind of diagnostic functionality, you can package it up into a separate function, such as:</p>
<pre data-code-language="python" data-type="programlisting">
<code class="kn">import</code><code> </code><code class="nn">sys</code><code class="o">,</code><code> </code><code class="nn">inspect</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">show_obj_methods</code><code class="p">(</code><code class="n">obj</code><code class="p">,</code><code> </code><code class="n">name</code><code class="p">,</code><code> </code><code class="n">show</code><code class="o">=</code><code class="n">sys</code><code class="o">.</code><code class="n">stderr</code><code class="o">.</code><code class="n">write</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">show</code><code class="p">(</code><code class="sa">f</code><code class="s1">'</code><code class="si">{</code><code class="n">name</code><code class="si">}</code><code class="s1"> is type </code><code class="si">{</code><code class="nb">type</code><code class="p">(</code><code class="n">obj</code><code class="p">)</code><code class="o">.</code><code class="vm">__name__</code><code class="si">}</code><code class="s1">(</code><code class="si">{</code><code class="n">obj</code><code class="si">!r}</code><code class="s1">)</code><code class="se">\n</code><code class="s1">'</code><code class="p">)</code><code>
</code><code>    </code><code class="n">show</code><code class="p">(</code><code class="sa">f</code><code class="s2">"</code><code class="si">{</code><code class="n">name</code><code class="si">}</code><code class="s2">'</code><code class="s2">s methods are: </code><code class="s2">"</code><code class="p">)</code><code>
</code><code>    </code><strong><code class="k">for</code></strong><code> </code><code class="n">n</code><code class="p">,</code><code> </code><code class="n">v</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">inspect</code><code class="o">.</code><code class="n">getmembers</code><code class="p">(</code><code class="n">obj</code><code class="p">,</code><code> </code><code class="n">callable</code><code class="p">)</code><code class="p">:</code><code>
</code><code>       </code><code class="n">show</code><code class="p">(</code><code class="sa">f</code><code class="s1">'</code><code class="si">{</code><code class="n">n</code><code class="si">}</code><code class="s1"> </code><code class="s1">'</code><code class="p">)</code><code>
</code><code>    </code><code class="n">show</code><code class="p">(</code><code class="s1">'</code><code class="se">\n</code><code class="s1">'</code><code class="p">)</code></pre>
<p>And then the example becomes just:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="k">try</code></strong><code class="p">:</code><code>
</code><code>    </code><code class="n">x</code><code class="o">.</code><code class="n">f</code><code class="p">(</code><code class="p">)</code><code>
</code><strong><code class="k">except</code></strong><code> </code><code class="ne">AttributeError</code><code class="p">:</code><code>
</code><code>    </code><code class="n">show_obj_methods</code><code class="p">(</code><code class="n">x</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">x</code><code class="s1">'</code><code class="p">)</code><code>
</code><strong><code>   </code></strong><code> </code><strong><code class="k">raise</code></strong></pre>
<p>Good program structure and organization are just as necessary in code intended for diagnostic and debugging purposes as they are in code that implements your program’s functionality. See also <a data-type="xref" href="ch06.xhtml#the_assert_statement">“The assert Statement”</a> for a good technique to use when defining diagnostic and debugging functions.<a contenteditable="false" data-primary="" data-startref="insmod17" data-type="indexterm" id="idm44924494448176"/><a contenteditable="false" data-primary="" data-startref="Dinspect17" data-type="indexterm" id="idm44924494446960"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="The traceback Module" data-type="sect2"><div class="sect2" id="the_traceback_module">
<h2>The traceback Module</h2>
<p>The<a contenteditable="false" data-primary="debugging" data-secondary="traceback module" data-type="indexterm" id="idm44924494444048"/><a contenteditable="false" data-primary="traceback module" data-type="indexterm" id="idm44924494442640"/> <span class="code">traceback</span> module lets you extract, format, and output information about tracebacks that uncaught exceptions normally produce. By default, this module reproduces the formatting Python uses for tracebacks. However, the <span class="code">traceback</span> module also lets you exert fine-grained control. The module supplies many functions, but in typical use you need only one of them:</p>
<table class="border">
<tbody>
<tr>
<td><span class="code">print_exc</span></td>
<td><span class="code">print_exc(limit=<strong>None</strong>, file=sys.stderr)</span><br/>
			Call <span class="code">print_exc</span> from an exception handler, or from a function called, directly or indirectly, by an exception handler. <span class="code">print_exc</span> outputs to file-like object <span class="code">file</span> the traceback that Python outputs to <span class="code">stderr</span> for uncaught exceptions. When <span class="code">limit</span> is an integer, <span class="code">print_exc</span> outputs only <span class="code">limit</span> traceback nesting levels. For example, when, in an exception handler, you want to cause a diagnostic message just as if the exception propagated, but stop the exception from propagating further (so that your program keeps running and no further handlers are involved), call <span class="code">traceback.print_exc()</span>.</td>
</tr>
</tbody>
</table>
</div></section>
<section data-pdf-bookmark="The pdb Module" data-type="sect2"><div class="sect2" id="the_pdb_module">
<h2>The pdb Module</h2>
<p>The<a contenteditable="false" data-primary="debugging" data-secondary="pdb module" data-type="indexterm" id="Dpdbmod17"/><a contenteditable="false" data-primary="pdb module" data-type="indexterm" id="pdbmod17"/><a contenteditable="false" data-primary="standard library modules" data-secondary="pdb" data-type="indexterm" id="idm44924494400800"/> <span class="code">pdb</span> module uses the Python interpreter’s debugging and tracing hooks to implement a simple command-line interactive debugger. <span class="code">pdb</span> lets you set breakpoints, single-step and jump to source code, examine stack frames, and so on.</p>
<p>To run code under <span class="code">pdb</span>’s control, import <span class="code">pdb</span>, then call <span class="code">pdb.run</span>, passing as the single argument a string of code to execute. To use <span class="code">pdb</span> for postmortem debugging (debugging of code that just terminated by propagating an exception at an interactive prompt), call <span class="code">pdb.pm()</span> without arguments. To trigger <span class="code">pdb</span> directly from your application code, use the built-in function <span class="code">breakpoint</span>.</p>
<p>When <span class="code">pdb</span> starts, it first reads text files named <em>.pdbrc</em> in your home directory and in the current directory. Such files can contain any <span class="code">pdb</span> commands, but most often you put <span class="code">alias</span> commands in them to define useful synonyms and abbreviations for other commands that you use often.</p>
<p>When <span class="code">pdb</span> is in control, it prompts with the string <span class="code">(Pdb)</span>, and you can enter <span class="code">pdb</span> commands. The command <span class="code">help</span> (which you can enter in the abbreviated form <span class="code">h</span>) lists the available commands. Call <span class="code">help</span> with an argument (separated by a space) to get help about any specific command. You can abbreviate most commands to the first one or two letters, but you must always enter commands in lowercase: <span class="code">pdb</span>, like Python itself, is case-sensitive. Entering an empty line repeats the previous command. The most frequently used <span class="code">pdb</span> commands are listed in <a data-type="xref" href="#commonly_used_pdb_commands">Table 17-6</a>.</p>
<table class="border pagebreak-before less_space" id="commonly_used_pdb_commands">
<caption><span class="label">Table 17-6. </span><em>Commonly used <span class="code">pdb</span> commands</em></caption>
<tbody>
<tr>
<td class="width-15"><span class="code">!</span></td>
<td><span class="code">!</span> <span class="code"><em>statement</em></span><br/>
			Executes Python statement <span class="code"><em>statement</em></span> with the currently selected stack frame (see the <span class="code">d</span> and <span class="code">u</span> commands later in this table) as the local namespace.</td>
</tr>
<tr>
<td><span class="code">alias</span>, <span class="code">unalias</span></td>
<td><span class="code">alias [<em>name</em></span> <span class="code">[</span><span class="code"><em>command</em>]]</span>,<br/>
<span class="code">unalias</span> <span class="code"><em>name</em></span><br/>
			Defines a short form of a frequently used command. <span class="code"><em>command</em></span> is any <span class="code">pdb</span> command, with arguments, and may contain <span class="code">%1</span>, <span class="code">%2</span>, and so on to refer to specific arguments passed to the new alias <span class="code"><em>name</em></span> being defined, or <span class="code">%*</span> to refer to all such arguments. <span class="code">alias</span> with no arguments lists currently defined aliases. <span class="code">alias</span> <span class="code"><em>name</em></span> outputs the current definition of alias <span class="code"><em>name</em></span>. <span class="code">unalias</span> <span class="code"><em>name</em></span> removes an alias.</td>
</tr>
<tr>
<td><span class="code">args</span>, <span class="code">a</span></td>
<td><span class="code">args</span><br/>
			Lists all arguments passed to the function you are currently debugging.</td>
</tr>
<tr>
<td><span class="code">break</span>, <span class="code">b</span></td>
<td><span class="code">break [<em>location</em>[,</span> <span class="code"><em>condition</em></span><span class="code">]]</span><br/>
			With<a contenteditable="false" data-primary="break (pdb module)" data-type="indexterm" id="idm44924494348656"/> no arguments, lists the currently defined breakpoints and the number of times each breakpoint has triggered. With an argument, <span class="code">break</span> sets a breakpoint at the given <span class="code"><em>location</em></span><em>.</em> <span class="code"><em>location</em></span> can be a line number or a function name, optionally preceded by <span class="code"><em>filename</em></span><span class="code">:</span> to set a breakpoint in a file that is not the current one or at the start of a function whose name is ambiguous (i.e., a function that exists in more than one file). When <span class="code"><em>condition</em></span> is present, it is an expression to evaluate (in the debugged context) each time the given line or function is about to execute; execution breaks only when the expression returns a truthy value. When setting a new breakpoint, <span class="code">break</span> returns a breakpoint number, which you can later use to refer to the new breakpoint in any other breakpoint-related <span class="code">pdb</span> command.</td>
</tr>
<tr>
<td><span class="code">clear</span>, <span class="code">cl</span></td>
<td><span class="code">clear [<em>breakpoint-numbers</em>]</span><br/>
			Clears (removes) one or more breakpoints. <span class="code">clear</span> with no arguments removes all breakpoints after asking for confirmation. To deactivate a breakpoint temporarily, without removing it, see <span class="code">disable</span>, covered below.</td>
</tr>
<tr>
<td><span class="code">condition</span></td>
<td><span class="code">condition</span> <span class="code"><em>breakpoint-number</em></span> <span class="code">[<em>expression</em>]</span><br/>
<span class="code">condition</span> <span class="code"><em>n expression</em></span> sets or changes the condition on breakpoint <span class="code"><em>n</em></span>. <span class="code">condition</span> <span class="code"><em>n</em></span>, without <span class="code"><em>expression</em></span>, makes breakpoint <span class="code"><em>n</em></span> unconditional.</td>
</tr>
<tr>
<td><span class="code">continue</span>, <span class="code">c</span>, <span class="code">cont</span></td>
<td><span class="code">continue</span><br/>
			Continues execution of the code being debugged, up to a breakpoint, if any.</td>
</tr>
<tr>
<td><span class="code">disable</span></td>
<td><span class="code">disable [<em>breakpoint-numbers</em>]</span><br/>
			Disables one or more breakpoints. <span class="code">disable</span> without arguments disables all breakpoints (after asking for confirmation). This differs from <span class="code">clear</span> in that the debugger remembers the breakpoint, and you can reactivate it via <span class="code">enable</span>.</td>
</tr>
<tr>
<td><span class="code">down</span>, <span class="code">d</span></td>
<td><span class="code">down</span><br/>
			Moves down one frame in the stack (i.e., toward the most recent function call). Normally, the current position in the stack is at the bottom (at the function that was called most recently and is now being debugged), so <span class="code">down</span> can’t go further down. However, <span class="code">down</span> is useful if you have previously executed the command <span class="code">up</span>, which moves the current position upward in the stack.</td>
</tr>
<tr>
<td><span class="code">enable</span></td>
<td><span class="code">enable [<em>breakpoint-numbers</em>]</span><br/>
			Enables one or more breakpoints. <span class="code">enable</span> without arguments enables all breakpoints after asking for confirmation.</td>
</tr>
<tr>
<td><span class="code">ignore</span></td>
<td><span class="code">ignore</span> <span class="code"><em>breakpoint-number</em></span> <span class="code">[<em>count</em>]</span><br/>
			Sets the breakpoint’s ignore count (to <span class="code">0</span> if <span class="code"><em>count</em></span> is omitted). Triggering a breakpoint whose ignore count is greater than <span class="code">0</span> just decrements the count. Execution stops, presenting you with an interactive <span class="code">pdb</span> prompt, only when you trigger a breakpoint whose ignore count is <span class="code">0</span>. For example, say that module <em>fob.py</em> contains the following code: 
			<pre data-code-language="python" data-type="programlisting">
<strong><code class="k">def</code></strong><code> </code><code class="nf">f</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><strong><code>    </code><code class="k">for</code></strong><code> </code><code class="n">i</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="nb">range</code><code class="p">(</code><code class="mi">1000</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="n">g</code><code class="p">(</code><code class="n">i</code><code class="p">)</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">g</code><code class="p">(</code><code class="n">i</code><code class="p">)</code><code class="p">:</code><code>
</code><strong><code>   </code></strong><code> </code><strong><code class="k">pass</code></strong></pre>
			 Now consider the following interactive <span class="code">pdb</span> session (minor formatting details may change depending on the Python version you’re running): 

			<pre data-code-language="python" data-type="programlisting">
<code class="o">&gt;&gt;</code><code class="o">&gt;</code><code> </code><strong><code class="kn">import</code></strong><code> </code><code class="nn">pdb</code><code>
</code><code class="o">&gt;&gt;</code><code class="o">&gt;</code><code> </code><strong><code class="kn">import</code></strong><code> </code><code class="nn">fob</code><code>
</code><code class="o">&gt;&gt;</code><code class="o">&gt;</code><code> </code><code class="n">pdb</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="s1">'</code><code class="s1">fob.f()</code><code class="s1">'</code><code class="p">)</code></pre>
<pre data-type="programlisting">
&gt; <strong>&lt;string&gt;(1)?()</strong>
(Pdb) break fob.g
<strong>Breakpoint 1 at C:\mydir\fob.py:5</strong>
(Pdb) ignore 1 500
<strong>Will ignore next 500 crossings of breakpoint 1.</strong>
(Pdb) continue
&gt; <strong>C:\mydir\fob.py(5)</strong>
<strong>g()</strong><strong>-&gt;</strong> <strong>pass</strong>
(Pdb) print(i)
<strong>500</strong></pre>
			The <span class="code">ignore</span> command, as <span class="code">pdb</span> says, tells <span class="code">pdb</span> to ignore the next <span class="code">500</span> hits on breakpoint <span class="code">1</span>, which we set at <span class="code">fob.g</span> in the previous <span class="code">break</span> statement. Therefore, when execution finally stops, the function g has already been called <span class="code">500</span> times, as we show by printing its argument <span class="code">i</span>, which indeed is now <span class="code">500</span>. The ignore count of breakpoint <span class="code">1</span> is now <span class="code">0</span>; if we execute another <span class="code">continue</span> and <span class="code">print</span> <span class="code">i</span>, <span class="code">i</span> shows as <span class="code">501</span>. In other words, once the ignore count decrements to <span class="code">0</span>, execution stops every time the breakpoint is hit. If we want to skip some more hits, we must give <span class="code">pdb</span> another <span class="code">ignore</span> command, setting the ignore count of breakpoint <span class="code">1</span> to some value greater than <span class="code">0</span> yet again.</td>
</tr>
<tr>
<td><span class="code">jump</span>, <span class="code">j</span></td>
<td><span class="code">jump</span> <span class="code"><em>line_number</em></span><br/>
			Sets the next line to execute to the given line number. You can use this to skip over some code by advancing to a line beyond it, or revisit some code that was already run by jumping to a previous line. (Note that a <span class="code">jump</span> to a previous source line is not an undo command: any changes to program state made after that line are retained.)<br/>
<span class="code">jump</span> does come with some limitations—for example, you can only jump within the bottom frame, and you cannot jump into a loop or out of a <span class="code"><strong>finally</strong></span> block—but it can still be an extremely useful command.</td>
</tr>
<tr>
<td><span class="code">list</span>, <span class="code">l</span></td>
<td><span class="code">list [<em>first</em></span> <span class="code">[,</span> <span class="code"><em>last</em>] ]</span><br/>
			Without arguments, lists <span class="code">11</span> (eleven) lines centered on the current one, or the next <span class="code">11</span> lines if the previous command was also a <span class="code">list</span>. Arguments to the <span class="code">list</span> command can optionally specify the first and last lines to list within the current file; use a dot (<span class="code">.</span>) to indicate the current debug line. The <span class="code">list</span> command lists physical lines, counting and including comments and empty lines, not logical lines. <span class="code">list</span>’s output marks the current line with <span class="code">-&gt;</span>; if the current line was reached in the course of handling an exception, the line that raised the exception is marked with <span class="code">&gt;&gt;</span>.</td>
</tr>
<tr>
<td><span class="code">ll</span></td>
<td><span class="code">ll</span><br/>
			Long version of <span class="code">list</span>, showing all lines in the current function or frame.</td>
</tr>
<tr>
<td><span class="code">next</span>, <span class="code">n</span></td>
<td><span class="code">next</span><br/>
			Executes the current line, without “stepping into” any function called from the current line. However, hitting breakpoints in functions called directly or indirectly from the current line does stop execution.</td>
</tr>
<tr>
<td><span class="code">print</span>, <span class="code">p</span></td>
<td><span class="code">print(<em>expression</em>)</span>,<br/>
<span class="code">p</span> <span class="code"><em>expression</em></span><br/>
			Evaluates <span class="code"><em>expression</em></span> in the current context and displays the result.</td>
</tr>
<tr>
<td><span class="code">quit</span>, <span class="code">q</span></td>
<td><span class="code">quit</span><br/>
			Immediately terminates both <span class="code">pdb</span> and the program being debugged.</td>
</tr>
<tr>
<td><span class="code">return</span>, <span class="code">r</span></td>
<td><span class="code">return</span><br/>
			Executes the rest of the current function, stopping only at breakpoints, if any.</td>
</tr>
<tr>
<td><span class="code">step</span>, <span class="code">s</span></td>
<td><span class="code">step</span><br/>
			Executes the current line, stepping into any function called from the current line.</td>
</tr>
<tr>
<td><span class="code">tbreak</span></td>
<td><span class="code">tbreak [<em>location</em>[,</span> <span class="code"><em>condition</em></span><span class="code">]]</span><br/>
			Like <span class="code">break</span>, but the breakpoint is temporary (i.e., <span class="code">pdb</span> automatically removes the breakpoint as soon as the breakpoint is triggered).</td>
</tr>
<tr>
<td><span class="code">up</span>, <span class="code">u</span></td>
<td><span class="code">up</span><br/>
			Moves up one frame in the stack (i.e., away from the most recent function call and toward the calling function).</td>
</tr>
<tr>
<td><span class="code">where</span>, <span class="code">w</span></td>
<td><span class="code">where</span><br/>
			Shows the stack of frames and indicates the current one (i.e., in which frame’s context the command <span class="code">!</span> executes statements, the command <span class="code">args</span> shows arguments, the command <span class="code">print</span> evaluates expressions, etc.).</td>
</tr>
</tbody>
</table>
<p>You can also enter a Python expression at the <span class="code">(Pdb)</span> prompt, and <span class="code">pdb</span> will evaluate it and display the result, just as if you were at the Python interpreter prompt. However, when you enter an expression whose first term coincides with a <span class="code">pdb</span> command, the <span class="code">pdb</span> command will execute. This is especially problematic when debugging code with single-letter variables like <span class="code"><em>p</em></span> and <span class="code"><em>q</em></span>. In these cases, you must begin the expression with <span class="code">!</span> or precede it with the <span class="code">print</span> or <span class="code">p</span> command.<a contenteditable="false" data-primary="" data-startref="pdbmod17" data-type="indexterm" id="idm44924494118688"/><a contenteditable="false" data-primary="" data-startref="Dpdbmod17" data-type="indexterm" id="idm44924494117280"/></p>
</div></section>
<section class="pagebreak-before" data-pdf-bookmark="Other Debugging Modules" data-type="sect2"><div class="sect2" id="other_debugging_modules">
<h2 class="less_space">Other Debugging Modules</h2>
<p>While<a contenteditable="false" data-primary="debugging" data-secondary="ipdb module" data-type="indexterm" id="idm44924494113808"/><a contenteditable="false" data-primary="" data-startref="ipdb module" data-type="indexterm" id="idm44924494112400"/> <span class="code">pdb</span> is built into Python, there are third-party packages that provide enhanced features for debugging.</p>
<section data-pdf-bookmark="ipdb" data-type="sect3"><div class="sect3" id="ipdb">
<h3>ipdb</h3>
<p>Just<a contenteditable="false" data-primary="ipdb debugger" data-type="indexterm" id="idm44924494107936"/> as <span class="code">ipython</span> extends the interactive interpreter provided by Python, <a href="https://oreil.ly/t8rV2"><span class="code">ipdb</span></a> adds the same inspection, tab completion, command-line editing, and history features (and magic commands) to <span class="code">pdb</span>. <a data-type="xref" href="#example_of_an_ipdb_session">Figure 17-1</a> shows an example interaction.</p>
<figure><div class="figure" id="example_of_an_ipdb_session"><em><img alt="Example of an ipdb session" height="395" src="assets/pns4_1701.png" width="600"/> </em>
<h6><span class="label">Figure 17-1. </span><em>Example of an <span class="code">ipdb</span> session</em></h6>
<em> </em></div></figure>
<p><span class="code">ipdb</span> also adds configuration and conditional expressions to its version of <span class="code">set_trace</span>, giving more control over when your program is to break out into the debugging session. (In this example, the breakpoint is conditional on <span class="code">i</span> being equal to <span class="code">2</span>.)</p>
</div></section>
<section data-pdf-bookmark="pudb" data-type="sect3"><div class="sect3" id="pudb">
<h3>pudb</h3>
<p><a href="https://oreil.ly/a5PJB"><span class="code">pudb</span></a> is<a contenteditable="false" data-primary="debugging" data-secondary="pudb module" data-type="indexterm" id="idm44924494093696"/><a contenteditable="false" data-primary="pudb debugger" data-type="indexterm" id="idm44924494092320"/> a lightweight “graphical-like” debugger that runs in a terminal console (see <a data-type="xref" href="#example_of_a_pudb_session">Figure 17-2</a>), utilizing the <a href="http://excess.org/urwid">urwid</a> console UI library. It is especially useful when connecting to remote Python environments using terminal sessions such as <span class="code">ssh</span>, where a windowed-GUI debugger is not easy to install or run.</p>
<figure><div class="figure" id="example_of_a_pudb_session"><em><img alt="Example of a pudb session" height="411" src="assets/pns4_1702.png" width="600"/> </em>
<h6><span class="label">Figure 17-2. </span><em>Example of a <span class="code">pudb</span> session</em></h6>
<em> </em></div></figure>
<p><span class="code">pudb</span> has its own set of debugging commands and interface, which take some practice to use; however, it makes a visual debugging environment handily available when working in tight computing spaces.</p>
</div></section>
</div></section>
</div></section>
<section data-pdf-bookmark="The warnings Module" data-type="sect1"><div class="sect1" id="the_warnings_module">
<h1>The warnings Module</h1>
<p>Warnings<a contenteditable="false" data-primary="warnings module" data-type="indexterm" id="warnmod17"/><a contenteditable="false" data-primary="standard library modules" data-secondary="warnings" data-type="indexterm" id="idm44924494081344"/> are messages about errors or anomalies that aren’t serious enough to disrupt the program’s control flow (as would happen by raising an exception). The <span class="code">warnings</span> module affords fine-grained control over which warnings are output and what happens to them. You can conditionally output a warning by calling the function <span class="code">warn</span> in the <span class="code">warnings</span> module. Other functions in the module let you control how warnings are formatted, set their destinations, and conditionally suppress some warnings or transform some warnings into exceptions.</p>
<section data-pdf-bookmark="Classes" data-type="sect2"><div class="sect2" id="classes">
<h2>Classes</h2>
<p>Exception classes that represent warnings are not supplied by <span class="code">warnings</span>: rather, they are built-ins. The class <span class="code">Warning</span> subclasses <span class="code">Exception</span> and is the base class for all warnings. You may define your own warning classes, which must subclass <span class="code">Warning</span>, either directly or via one of its other existing subclasses—these include:</p>
<dl>
<dt class="plain"><span class="code">DeprecationWarning</span></dt>
<dd>For<a contenteditable="false" data-primary="DeprecationWarning class" data-type="indexterm" id="idm44924494070880"/> use of deprecated features which are still supplied only for backward compatibility</dd>
<dt class="plain"><span class="code">RuntimeWarning</span></dt>
<dd>For<a contenteditable="false" data-primary="RuntimeWarning class" data-type="indexterm" id="idm44924494068016"/> use of features whose semantics are error prone</dd>
<dt class="plain"><span class="code">SyntaxWarning</span></dt>
<dd>For<a contenteditable="false" data-primary="SyntaxWarning class" data-type="indexterm" id="idm44924494065152"/> use of features whose syntax is error prone</dd>
<dt class="plain"><span class="code">UserWarning</span></dt>
<dd>For<a contenteditable="false" data-primary="UserWarning class" data-type="indexterm" id="idm44924494062288"/> other user-defined warnings that don’t fit any of the above cases</dd>
</dl>
</div></section>
<section data-pdf-bookmark="Objects" data-type="sect2"><div class="sect2" id="objects">
<h2>Objects</h2>
<p>Python supplies no concrete “warning objects.” Rather, a warning is made up of a <span class="code"><em>message</em></span> (a string), a <span class="code"><em>category</em></span> (a subclass of <span class="code">Warning</span>), and two pieces of information to identify where the warning was raised: <span class="code"><em>module</em></span> (the name of the module that raised the warning) and <span class="code"><em>lineno</em></span> (the number of the line in the source code that raised the warning). Conceptually, you may think of these as attributes of a warning object <span class="code"><em>w</em></span>: we use attribute notation later, strictly for clarity, but no specific object <span class="code"><em>w</em></span> actually exists.</p>
</div></section>
<section data-pdf-bookmark="Filters" data-type="sect2"><div class="sect2" id="filter">
<h2>Filters</h2>
<p>At any time, the <span class="code">warnings</span> module keeps a list of active filters for warnings. When you import <span class="code">warnings</span> for the first time in a run, the module examines <span class="code">sys.warnoptions</span> to determine the initial set of filters. You can run Python with the option <span class="code"><strong>-W</strong></span> to set <span class="code">sys.warnoptions</span> for a given run. Do not rely on the initial set of filters being held specifically in <span class="code">sys.warnoptions</span>, as this is an implementation detail that may change in future versions of Python.</p>
<p>As each warning <span class="code"><em>w</em></span> occurs, <span class="code">warnings</span> tests <span class="code"><em>w</em></span> against each filter until a filter matches. The first matching filter determines what happens to <span class="code"><em>w</em></span>. Each filter is a tuple of five items. The first item, <span class="code"><em>action</em></span>, is a string that defines what happens on a match. The other four items, <span class="code"><em>message</em></span><em>,</em> <span class="code"><em>category</em></span><em>,</em> <span class="code"><em>module</em></span>, and <span class="code"><em>lineno</em></span>, control what it means for <span class="code"><em>w</em></span> to match the filter: for a match, all conditions must be satisfied. Here are the meanings of these items (using attribute notation to indicate conceptual attributes of <span class="code"><em>w</em></span>):</p>
<dl>
<dt><em><span class="code">message</span></em></dt>
<dd>A regular expression pattern string; the match condition is <span class="code">re.match(<em>message</em></span>, <span class="code"><em>w</em>.message, re.I)</span> (the match is case insensitive)</dd>
<dt><em><span class="code">category</span></em></dt>
<dd><span class="code">Warning</span> or a subclass; the match condition is <span class="code">issubclass(<em>w</em>.category,</span> <span class="code keep-together"><em>category</em></span><span class="code">)</span></dd>
<dt><em><span class="code">module</span></em></dt>
<dd>A regular expression pattern string; the match condition is <span class="code">re.match(<em>module</em>,</span> <span class="code"><em>w</em></span><span class="code">.module)</span> (the match is case sensitive)</dd>
<dt><em><span class="code">lineno</span></em></dt>
<dd>An <span class="code">int</span>; the match condition is <span class="code"><em>lineno</em></span> <span class="code"><strong>in</strong></span> <span class="code">(<em>0</em></span>, <span class="code"><em>w</em>.lineno)</span>: that is, either <span class="code keep-together"><em>lineno</em></span> is <span class="code">0</span>, meaning <span class="code"><em>w</em></span><span class="code">.lineno</span> does not matter, or <span class="code"><em>w</em></span><span class="code">.lineno</span> must exactly equal <span class="code keep-together"><em>lineno</em></span></dd>
</dl>
<p>Upon a match, the first field of the filter, the <span class="code"><em>action</em></span>, determines what happens. It can have the following values:</p>
<dl>
<dt class="plain"><span class="code">'always'</span></dt>
<dd><span class="code"><em>w</em></span><span class="code">.message</span> is output whether or not <span class="code"><em>w</em></span> has already occurred.</dd>
<dt class="plain"><span class="code">'default'</span></dt>
<dd><span class="code"><em>w</em></span><span class="code">.message</span> is output if, and only if, this is the first time <span class="code"><em>w</em></span> has occurred from this specific location (i.e., this specific <span class="code">(<em>w</em>.module,</span> <span class="code"><em>w</em></span><span class="code">.location)</span> pair).</dd>
<dt class="plain"><span class="code">'error'</span></dt>
<dd><span class="code"><em>w</em></span><span class="code">.category(<em>w</em>.message)</span> is raised as an exception.</dd>
<dt class="plain"><span class="code">'ignore'</span></dt>
<dd><span class="code"><em>w</em></span> is ignored.</dd>
<dt class="plain"><span class="code">'module'</span></dt>
<dd><span class="code"><em>w</em></span><span class="code">.message</span> is output if, and only if, this is the first time <span class="code"><em>w</em></span> occurs from <span class="code"><em>w</em></span><span class="code keep-together">.module</span>.</dd>
<dt class="plain"><span class="code">'once'</span></dt>
<dd><span class="code"><em>w</em></span><span class="code">.message</span> is output if, and only if, this is the first time <span class="code"><em>w</em></span> occurs from any location.</dd>
</dl>
<p>When a module issues a warning, <span class="code">warnings</span> adds to that module’s global variables a <span class="code">dict</span> named <span class="code">__warningsgregistry__</span>, if that <span class="code">dict</span> is not already present. Each key in the <span class="code">dict</span> is a pair <span class="code">(<em>message</em>,</span> <span class="code"><em>category</em></span><span class="code">)</span>, or a tuple with three items <span class="code">(<em>message</em>,</span> <span class="code"><em>category</em></span><span class="code">,</span> <span class="code"><em>lineno</em></span><span class="code">)</span>; the corresponding value is <span class="code"><strong>True</strong></span> when further occurrences of that message are to be suppressed. Thus, for example, you can reset the suppression state of all warnings from a module <span class="code"><em>m</em></span> by executing <span class="code"><em>m</em></span><span class="code">.__warningsregistry__.clear()</span>: when you do that, all messages are allowed to get output again (once), even when, for example, they’ve previously triggered a filter with an <span class="code"><em>action</em></span> of <span class="code">'module'</span>.</p>
</div></section>
<section data-pdf-bookmark="Functions" data-type="sect2"><div class="sect2" id="functions">
<h2>Functions</h2>
<p>The <span class="code">warnings</span> module supplies the functions listed in <a data-type="xref" href="#functions_of_the_warnings_module">Table 17-7</a>.</p>
<table class="border" id="functions_of_the_warnings_module">
<caption><span class="label">Table 17-7. </span><em>Functions of the <span class="code">warnings</span> module</em></caption>
<tbody>
<tr>
<td class="width-15"><span class="code">fil⁠t⁠e⁠r​w⁠a⁠r⁠nings</span></td>
<td><span class="code">filterwarnings(<em>action</em>, message='.*', category=Warning,<br/> module='.*', lineno=0, append=<strong>False</strong>)</span><br/>
			Adds a filter to the list of active filters. When <span class="code">append</span> is <span class="code"><strong>True</strong></span>, <span class="code">filterwarnings</span> adds the filter after all other existing filters (i.e., appends the filter to the list of existing filters); otherwise, <span class="code">filterwarnings</span> inserts the filter before any other existing filter. All components, save <span class="code"><em>action</em></span>, have default values that mean “match everything.” As detailed above, <span class="code">message</span> and <span class="code">module</span> are pattern strings for regular expressions, <span class="code">category</span> is some subclass of <span class="code">Warning</span>, <span class="code">lineno</span> is an integer, and <span class="code"><em>action</em></span> is a string that determines what happens when a message matches this filter.</td>
</tr>
<tr>
<td><span class="code">for⁠m⁠a⁠t​w⁠a⁠r⁠ning</span></td>
<td><span class="code">formatwarning(<em>message</em>,</span> <span class="code"><em>category</em></span><span class="code">,</span> <span class="code"><em>filename</em></span><span class="code">,</span> <span class="code"><em>lineno</em></span><span class="code">)</span><br/>
			Returns a string that represents the given warning with standard formatting.</td>
</tr>
<tr>
<td><span class="code">re⁠s⁠e⁠t​w⁠a⁠r⁠nings</span></td>
<td><span class="code">resetwarnings()</span><br/>
			Removes all filters from the list of filters. <span class="code">resetwarnings</span> also discards any filters originally added with the <span class="code"><strong>-W</strong></span> command-line option.</td>
</tr>
<tr>
<td><span class="code">showwarning</span></td>
<td><span class="code">showwarning(<em>message</em>,</span> <span class="code"><em>category</em></span><span class="code">,</span> <span class="code"><em>filename</em></span><span class="code">,</span> <span class="code"><em>lineno</em></span><span class="code">, file=sys.stderr)</span><br/>
			Outputs the given warning to the given file object. Filter actions that output warnings call <span class="code">showwarning</span>, letting the argument <span class="code">file</span> default to <span class="code">sys.stderr</span>. To change what happens when filter actions output warnings, code your own function with this signature and bind it to <span class="code">warnings.showwarning</span>, thus overriding the default implementation.</td>
</tr>
<tr>
<td><span class="code">warn</span></td>
<td><span class="code">warn(<em>message</em>, category=UserWarning, stacklevel=1)</span><br/>
			Sends<a contenteditable="false" data-primary="warn (warnings module)" data-type="indexterm" id="idm44924493926688"/> a warning so that the filters examine and possibly output it. The location of the warning is the current function (caller of <span class="code">warn</span>) if <span class="code">stacklevel</span> is <span class="code">1</span>, or the caller of the current function if <span class="code">stacklevel</span> is <span class="code">2</span>. Thus, passing <span class="code">2</span> as the value of <span class="code">stacklevel</span> lets you write functions that send warnings on their caller’s behalf, such as: 
			<pre data-code-language="python" data-type="programlisting">
<strong><code class="k">def</code></strong><code> </code><code class="nf">to_unicode</code><code class="p">(</code><code class="n">bytestr</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><strong><code class="k">try</code></strong><code class="p">:</code><code>
</code><code>        </code><strong><code class="k">return</code></strong><code> </code><code class="n">bytestr</code><code class="o">.</code><code class="n">decode</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><strong><code class="k">except</code></strong><code> </code><code class="ne">UnicodeError</code><code class="p">:</code><code>
</code><code>        </code><code class="n">warnings</code><code class="o">.</code><code class="n">warn</code><code class="p">(</code><code class="sa">f</code><code class="s1">'</code><code class="s1">Invalid characters in </code><code>
</code><code>                      </code><code class="p">{</code><code class="n">bytestr</code><code class="err">!</code><code class="n">r</code><code class="p">}</code><code class="s1">'</code><code class="s1">,</code><code>
</code><code>                      </code><code class="n">stacklevel</code><code class="o">=</code><code class="mi">2</code><code class="p">)</code><code>
</code><code>        </code><strong><code class="k">return</code></strong><code> </code><code class="n">bytestr</code><code class="o">.</code><code class="n">decode</code><code class="p">(</code><code class="n">errors</code><code class="o">=</code><code class="s1">'</code><code class="s1">ignore</code><code class="s1">'</code><code class="p">)</code></pre>
			 Thanks to the parameter <span class="code">stacklevel=2</span>, the warning appears to come from the caller of <span class="code">to_unicode</span>, rather than from <span class="code">to_unicode</span> itself. This is very important when the <span class="code"><em>action</em></span> of the filter that matches this warning is <span class="code">'default'</span> or <span class="code">'module'</span>, since these actions output a warning only the first time the warning occurs from a given location or module.<a contenteditable="false" data-primary="" data-startref="UserWarning class" data-type="indexterm" id="idm44924493865824"/></td>
</tr>
</tbody>
</table>
</div></section>
</div></section>
<section data-pdf-bookmark="Optimization" data-type="sect1"><div class="sect1" id="optimization">
<h1>Optimization</h1>
<p>“First<a contenteditable="false" data-primary="optimization" data-secondary="avoiding premature" data-type="indexterm" id="idm44924493862192"/> make it work. Then make it right. Then make it fast.” This quotation, often with slight variations, is widely known as “the golden rule of programming.” As far as we’ve been able to ascertain, the source is Kent Beck, who credits his father with it. This principle is often quoted, but too rarely followed. A negative form, slightly exaggerated for emphasis, is a quotation by Don Knuth (who credits Sir Tony Hoare with it): “Premature optimization is the root of all evil in programming.”</p>
<p>Optimization is premature if your code is not working yet, or if you’re not sure what, precisely, your code should be doing (since then you cannot be sure if it’s working). First make it work: ensure that your code is correctly performing exactly the tasks it is <em>meant</em> to perform.</p>
<p>Optimization is also premature if your code is working but you are not satisfied with the overall architecture and design. Remedy structural flaws before worrying about optimization: first make it work, then make it right. These steps are not optional; working, well-architected code is <em>always</em> a must.<sup><a data-type="noteref" href="ch17.xhtml#ch01fn130" id="ch01fn130-marker">6</a></sup></p>
<p>Having a good test suite is key before attempting any optimization. After all, the purpose of optimization is to increase speed or reduce memory consumption—or both—without changing the code’s behavior.</p>
<p>In contrast, you don’t always need to make it fast. Benchmarks may show that your code’s performance is already acceptable after the first two steps. When performance is not acceptable, profiling often shows that all performance issues are in a small part of the code, with your program spending perhaps 80 or 90% of its time in 10 to 20% of the code.<sup><a data-type="noteref" href="ch17.xhtml#ch01fn131" id="ch01fn131-marker">7</a></sup> Such performance-crucial regions of your code are known<a contenteditable="false" data-primary="bottlenecks" data-type="indexterm" id="idm44924493823296"/><a contenteditable="false" data-primary="hot spots" data-type="indexterm" id="idm44924493822192"/> as <em>bottlenecks</em>, or <em>hot spots</em>. It’s a waste of effort to optimize large portions of code that account for, say, 10 percent of your program’s running time. Even if you made that part run 10 times as fast (a rare feat), your program’s overall runtime would only decrease by 9%,<sup><a data-type="noteref" href="ch17.xhtml#ch01fn132" id="ch01fn132-marker">8</a></sup> a speedup no user would likely even notice. If optimization is needed, focus your efforts where they matter: on bottlenecks. You can often optimize bottlenecks while keeping your code 100% pure Python, thus not preventing future porting to other Python implementations.</p>
<section data-pdf-bookmark="Developing a Fast-Enough Python Application" data-type="sect2"><div class="sect2" id="developing_a_fast_enough_python_applica">
<h2>Developing a Fast-Enough Python Application</h2>
<p>Start<a contenteditable="false" data-primary="optimization" data-secondary="fast-enough applications" data-type="indexterm" id="Ofast17"/> by designing, coding, and testing your application in Python, using available extension modules if they save you work. This takes much less time than it would with a classic compiled language. Then benchmark the application to find out if the resulting code is fast enough. Often it is, and you’re done—congratulations! Ship it!</p>
<p>Since much of Python itself is coded in highly optimized C (as are many of its standard library and extension modules), your application may even turn out to already be faster than typical C code. However, if the application is too slow, you need, first and foremost, to rethink your algorithms and data structures. Check for bottlenecks due to application architecture, network traffic, database access, and operating system interactions. For many applications, each of these factors is more likely than language choice, or coding details, to cause slowdowns. Tinkering with large-scale architectural aspects can often dramatically speed up an application, and Python is an excellent medium for such experimentation. If you’re using a version control system (and you ought to be!), it should be easy to create experimental branches or clones where you can try out different techniques to see which—if any—deliver significant improvements, all without jeopardizing your working code. You can then merge back any improvements that pass your tests.</p>
<p>If<a contenteditable="false" data-primary="profiling" data-type="indexterm" id="idm44924493812800"/> your program is still too slow, profile it: find out where the time is going! As we previously mentioned, applications often exhibit computational bottlenecks, with small areas of the source code accounting for the vast majority of the running time. Optimize the bottlenecks, applying the techniques suggested in the rest of this chapter.</p>
<p>If normal Python-level optimizations still leave some outstanding computational bottlenecks, you can recode those as Python extension modules, as covered in <a href="https://oreil.ly/python-nutshell-25">Chapter 25</a>. In the end, your application will run at roughly the same speed as if you had coded it all in C, C++, or FORTRAN—or faster, when large-scale experimentation has let you find a better architecture. Your overall programming productivity with this process will not be much lower than if you had coded everything in Python. Future changes and maintenance are easy, since you use Python to express the overall structure of the program, and lower-level, harder-to-maintain languages for only a few specific computational bottlenecks.</p>
<p>As you build applications in a given area following this process, you will accumulate a library of reusable Python extension modules. You will therefore become more and more productive at developing other fast-running Python applications in the same field.</p>
<p>Even if external constraints eventually force you to recode your whole application in a lower-level language, you’ll still be better off for having started in Python. Rapid prototyping<a contenteditable="false" data-primary="rapid prototyping" data-type="indexterm" id="idm44924493809920"/> has long been acknowledged as the best way to get software architecture right. A working prototype lets you check that you have identified the right problems and taken a good path to their solution. A prototype also affords the kind of large-scale architectural experimentation that can make a real difference in performance. You can migrate your code gradually to other languages by way of extension modules, if need be, and the application remains fully functional and testable at each stage. This ensures against the risk of compromising a design’s architectural integrity in the coding stage.</p>
<p>Even if you are required to use a low-level language for the entire application, it can often be more productive to write it in Python first (especially if you are new to the application’s domain). Once you have a working Python version, you can experiment with the user or network interface or library API, and with the architecture. Also, it is much easier to find and fix bugs and to make changes in Python code than in lower-level languages. At the end, you’ll know the code so well that porting to a lower-level language should be very fast and straightforward, safe in the knowledge that most of the design mistakes were made and fixed in the Python implementation.</p>
<p>The resulting software will be faster and more robust than if all of the coding had been lower-level from the start, and your productivity—while not quite as good as with a pure Python application—will still be higher than if you had been coding at a lower level throughout.<a contenteditable="false" data-primary="" data-startref="Ofast17" data-type="indexterm" id="idm44924493807888"/></p>
</div></section>
<section data-pdf-bookmark="Benchmarking" data-type="sect2"><div class="sect2" id="benchmarking">
<h2>Benchmarking</h2>
<p><em>Benchmarking<a contenteditable="false" data-primary="benchmarking" data-type="indexterm" id="idm44924493804640"/><a contenteditable="false" data-primary="load testing" data-type="indexterm" id="idm44924493803504"/><a contenteditable="false" data-primary="optimization" data-secondary="benchmarking" data-type="indexterm" id="idm44924493802400"/></em> (also known as <em>load testing</em>) is similar to system testing: both activities are much like running the program for production purposes. In both cases, you need to have at least some subset of the program’s intended functionality working, and you need to use known, reproducible inputs. For benchmarking, you don’t need to capture and check your program’s output: since you make it work and make it right before you make it fast, you’re already fully confident about your program’s correctness by the time you load test it. You do need inputs that are representative of typical system operation—ideally ones that are likely to pose the greatest challenges to your program’s performance. If your program performs several kinds of operations, make sure you run some benchmarks for each different kind of operation.</p>
<p>Elapsed time as measured by your wristwatch is probably precise enough to benchmark most programs. A 5 or 10% difference in performance, except in programs with very peculiar constraints, makes no practical difference to a program’s real-life usability. (Programs with hard real-time constraints are another matter, since they have needs very different from those of normal programs in most respects. )</p>
<p>When you benchmark “toy” programs or snippets in order to help you choose an algorithm or data structure, you may need more precision: the <span class="code">timeit</span> module of Python’s standard library (covered in <a data-type="xref" href="#the_timeit_module">“The timeit module”</a>) is quite suitable for such tasks. The benchmarking discussed in this section is of a different kind: it is an approximation of real-life program operation for the sole purpose of checking whether the program’s performance on each task is acceptable, before embarking on profiling and other optimization activities. For such “system” benchmarking, a situation that approximates the program’s normal operating conditions is best, and high accuracy in timing is not all that important.</p>
</div></section>
<section data-pdf-bookmark="Large-Scale Optimization" data-type="sect2"><div class="sect2" id="large_scale_optimization">
<h2>Large-Scale Optimization</h2>
<p>The<a contenteditable="false" data-primary="optimization" data-secondary="large-scale" data-type="indexterm" id="Olarge17"/> aspects of your program that are most important for performance are large-scale ones: your choice of overall architecture, algorithms, and data structures.</p>
<p>The performance issues that you must often take into account are those connected with the traditional<a contenteditable="false" data-primary="big-O notation" data-type="indexterm" id="bigonot17"/><a contenteditable="false" data-primary="algorithms" data-type="indexterm" id="algo17"/> big-O notation of computer science. Informally, if you call <span class="code"><em>N</em></span> the input size of an algorithm, big-O notation expresses algorithm performance, for large values of <span class="code"><em>N</em></span>, as proportional to some function of <span class="code"><em>N</em></span>. (In precise computer science lingo, this should be called big-Theta notation, but in real life, programmers always call it big-O, perhaps because an uppercase Theta looks a bit like an O with a dot in the center!)</p>
<p>An <span class="code">O(1)</span> algorithm<a contenteditable="false" data-primary="constant time performance (O(1))" data-type="indexterm" id="idm44924493786176"/> (also known as “constant time”) is one that takes a certain amount of time not growing with <span class="code"><em>N</em></span>. An <span class="code">O(<em>N</em>)</span> algorithm<a contenteditable="false" data-primary="linear time performance (O(N))" data-type="indexterm" id="idm44924493782848"/> (also known as “linear time”) is one where, for large enough <span class="code"><em>N</em></span>, handling twice as much data takes about twice as much time, three times as much data takes three times as much time, and so on, proportionally to <span class="code"><em>N</em></span>. An<a contenteditable="false" data-primary="quadratic time performance (O(N²))" data-type="indexterm" id="idm44924493779792"/> <span class="code">O(<em>N</em>²)</span> algorithm (also known as a “quadratic time” algorithm) is one where, for large enough <span class="code"><em>N</em></span>, handling twice as much data takes about four times as much time, three times as much data takes nine times as much time, and so on, growing proportionally to <span class="code"><em>N</em></span> squared. Identical concepts and notation are used to describe a program’s consumption of memory (“space”) rather than of time.</p>
<p>To find more information on big-O notation, and about algorithms and their complexity, any good book about algorithms and data structures can help; we recommend Magnus Lie Hetland’s excellent book <em>Python Algorithms: Mastering Basic Algorithms in the Python Language</em>, 2nd edition (Apress).</p>
<p>To understand the practical importance of big-O considerations in your programs, consider two different ways to accept all items from an input iterable and accumulate them into a list in reverse order:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="k">def</code></strong><code> </code><code class="nf">slow</code><code class="p">(</code><code class="n">it</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">result</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="p">]</code><code>
</code><code>    </code><strong><code class="k">for</code></strong><code> </code><code class="n">item</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">it</code><code class="p">:</code><code>
</code><code>        </code><code class="n">result</code><code class="o">.</code><code class="n">insert</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="n">item</code><code class="p">)</code><code>
</code><code>    </code><strong><code class="k">return</code></strong><code> </code><code class="n">result</code><code>
</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">fast</code><code class="p">(</code><code class="n">it</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">result</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="p">]</code><code>
</code><code>    </code><strong><code class="k">for</code></strong><code> </code><code class="n">item</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">it</code><code class="p">:</code><code>
</code><code>        </code><code class="n">result</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">item</code><code class="p">)</code><code>
</code><code>    </code><code class="n">result</code><code class="o">.</code><code class="n">reverse</code><code class="p">(</code><code class="p">)</code><code>
</code><code>    </code><strong><code class="k">return</code></strong><code> </code><code class="n">result</code></pre>
<p>We could express each of these functions more concisely, but the key difference is best appreciated by presenting the functions in these elementary terms. The function <span class="code">slow</span> builds the result list by inserting each input item <em>before</em> all previously received ones. The function <span class="code">fast</span> appends each input item <em>after</em> all previously received ones, then reverses the result list at the end. Intuitively, one might think that the final reversing represents extra work, and therefore <span class="code">slow</span> should be faster than <span class="code">fast</span>. But that’s not the way things work out.</p>
<p>Each call to <span class="code">result.append</span> takes roughly the same amount of time, independent of how many items are already in the list <span class="code">result</span>, since there is (nearly) always a free slot for an extra item at the end of the list (in pedantic terms, <span class="code">append</span> is <em>amortized</em> <span class="code">O(1)</span>, but we don’t cover amortization in this book). The <span class="code"><strong>for</strong></span> loop in the function <span class="code">fast</span> executes <span class="code"><em>N</em></span> times to receive <span class="code"><em>N</em></span> items. Since each iteration of the loop takes a constant time, overall loop time is <span class="code">O(<em>N</em>)</span>. <span class="code">result.reverse</span> also takes time <span class="code">O(<em>N</em>)</span>, as it is directly proportional to the total number of items. Thus, the total running time of <span class="code">fast</span> is <span class="code">O(<em>N</em>)</span>. (If you don’t understand why a sum of two quantities, each <span class="code">O(<em>N</em>)</span>, is also <span class="code">O(<em>N</em>)</span>, consider that the sum of any two linear functions of <span class="code"><em>N</em></span> is also a linear function of <span class="code"><em>N</em></span>—and “being <span class="code">O(<em>N</em>)</span>” has exactly the same meaning as “consuming an amount of time that is a linear function of <span class="code"><em>N</em></span>.”)</p>
<p>On the other hand, each call to <span class="code">result.insert</span> makes space at slot <span class="code">0</span> for the new item to insert, moving all items that are already in list <span class="code">result</span> forward one slot. This takes time proportional to the number of items already in the list. The overall amount of time to receive <span class="code"><em>N</em></span> items is therefore proportional to <span class="code">1+2+3+...<em>N</em>-1</span>, a sum whose value is <span class="code">O(<em>N</em>²)</span>. Therefore, the total running time of <span class="code">slow</span> is <span class="code">O(<em>N</em>²)</span>.</p>
<p>It’s almost always worth replacing an <span class="code">O(<em>N</em>²)</span> solution with an <span class="code">O(<em>N</em>)</span> one, unless you can somehow assign rigorous small limits to input size <span class="code"><em>N</em></span>. If <span class="code"><em>N</em></span> can grow without very strict bounds, the <span class="code">O(<em>N</em>²)</span> solution turns out to be disastrously slower than the <span class="code">O(<em>N</em>)</span> one for large values of <span class="code"><em>N</em></span>, no matter what the proportionality constants in each case may be (and no matter what profiling tells you). Unless you have other <span class="code">O(<em>N</em>²)</span> or even worse bottlenecks elsewhere that you can’t eliminate, a part of the program that is <span class="code">O(<em>N</em>²)</span> turns into the program’s bottleneck, dominating runtime for large values of <span class="code"><em>N</em></span>. Do yourself a favor and watch out for the big-O: all other performance issues, in comparison, are usually almost insignificant.</p>
<p>Incidentally, you can make the function <span class="code">fast</span> even faster by expressing it in more idiomatic Python. Just replace the first two lines with the following single statement:</p>
<pre data-code-language="python" data-type="programlisting">
<code class="n">result</code> <code class="o">=</code> <code class="nb">list</code><code class="p">(</code><code class="n">it</code><code class="p">)</code></pre>
<p>This change does not affect <span class="code">fast</span>’s big-O character (<span class="code">fast</span> is still <span class="code">O(<em>N</em>)</span> after the change), but does speed things up by a large constant factor.</p>
<div data-type="note" epub:type="note">
<h1>Simple Is Better than Complex, and Usually Faster!</h1>
<p>More often than not, in Python, the simplest, clearest, most direct and idiomatic way to express something is also the fastest.</p>
</div>
<p>Choosing algorithms with good big-O performance is roughly the same task in Python as in any other language. You just need a few hints about the big-O performance of Python’s elementary building blocks, and we provide them in the following sections.</p>
<section data-pdf-bookmark="List operations" data-type="sect3"><div class="sect3" id="list_operations">
<h3>List operations</h3>
<p>Python<a contenteditable="false" data-primary="lists" data-secondary="optimizing operations" data-type="indexterm" id="idm44924493606176"/><a contenteditable="false" data-primary="vectors" data-type="indexterm" id="idm44924493604880"/><a contenteditable="false" data-primary="dynamic arrays" data-type="indexterm" id="idm44924493603776"/> lists are internally implemented as <em>vectors</em> (also known as <em>dynamic arrays</em>), not as “<em>linked</em> lists.” This implementation choice determines the performance characteristics of Python lists, in big-O terms.</p>
<p>Chaining two lists <span class="code"><em>L1</em></span> and <span class="code"><em>L2</em></span>, of length <span class="code"><em>N1</em></span> and <span class="code"><em>N2</em></span> (i.e., <span class="code"><em>L1</em></span><span class="code">+<em>L2</em></span>) is <span class="code">O(</span><span class="code"><em>N1</em>+<em>N2</em>)</span>. Multiplying a list <span class="code"><em>L</em></span> of length <span class="code"><em>N</em></span> by integer <span class="code"><em>M</em></span> (i.e., <span class="code"><em>L</em></span><span class="code">*<em>M</em></span>) is <span class="code">O(</span><span class="code"><em>N</em>*<em>M</em>)</span>. Accessing or rebinding any list item is <span class="code">O(1)</span>. <span class="code">len()</span> on a list is also <span class="code">O(1)</span>. Accessing any slice of length <span class="code"><em>M</em></span> is <span class="code">O(<em>M</em>)</span>. Rebinding a slice of length <span class="code"><em>M</em></span> with one of identical length is also <span class="code">O(<em>M</em>)</span>. Rebinding a slice of length <span class="code"><em>M1</em></span> with one of different length <span class="code"><em>M2</em></span> is <span class="code">O(<em>M1</em>+<em>M2</em>+<em>N1</em>)</span>, where <span class="code"><em>N1</em></span> is the number of items <em>after</em> the slice in the target list (so, length-changing slice rebindings are relatively cheap when they occur at the <em>end</em> of a list, but costlier when they occur at the <em>beginning</em> or around the middle of a long list). If you need first-in, first-out operations, a list is probably not the fastest data structure for the purpose: instead, try the type <span class="code">collections.deque</span>, covered in <a data-type="xref" href="ch08.xhtml#deque">“deque”</a>.</p>
<p>Most list methods, as shown in <a data-type="xref" href="ch03.xhtml#list_object_methods">Table 3-5</a>, are equivalent to slice rebindings and have equivalent big-O performance. The methods <span class="code">count</span>, <span class="code">index</span>, <span class="code">remove</span>, and <span class="code">reverse</span>, and the operator <span class="code"><strong>in</strong></span>, are <span class="code">O(<em>N</em>)</span>. The method <span class="code">sort</span> is generally <span class="code">O(<em>N</em></span> <span class="code">log</span> <span class="code"><em>N</em>)</span>, but <span class="code">sort</span> is highly optimized<sup><a data-type="noteref" href="ch17.xhtml#ch01fn133" id="ch01fn133-marker">9</a></sup> to be <span class="code">O(<em>N</em>)</span> in some important special cases, such as when the list is already sorted or reverse-sorted except for a few items. <span class="code">range(a, b, c)</span> is <span class="code">O(1)</span>, but looping on all items of the result is <span class="code">O((b - a) // c)</span>.</p>
</div></section>
<section data-pdf-bookmark="String operations" data-type="sect3"><div class="sect3" id="string_operations">
<h3>String operations</h3>
<p>Most<a contenteditable="false" data-primary="strings" data-secondary="optimizing string operations" data-type="indexterm" id="idm44924493543392"/> methods on a string of length <span class="code"><em>N</em></span> (be it bytes or Unicode) are <span class="code">O(<em>N</em>)</span>. <span class="code">len(<em>astring</em>)</span> is <span class="code">O(1)</span>. The fastest way to produce a copy of a string with transliterations and/or removal of specified characters is the string’s method <span class="code">translate</span>. The single most practically important big-O consideration involving strings is covered in <a data-type="xref" href="#building_up_a_string_from_pieces">“Building up a string from pieces”</a>.</p>
</div></section>
<section data-pdf-bookmark="Dictionary operations" data-type="sect3"><div class="sect3" id="dictionary_operations">
<h3>Dictionary operations</h3>
<p>Python<a contenteditable="false" data-primary="dictionary operations" data-secondary="optimizing" data-type="indexterm" id="idm44924493534368"/><a contenteditable="false" data-primary="dictionary operations" data-type="indexterm" id="idm44924493532960"/> <span class="code">dict</span>s are implemented with hash tables. This implementation choice determines all the performance characteristics of Python dictionaries, in big-O terms.</p>
<p>Accessing, rebinding, adding, or removing a dictionary item is <span class="code">O(1)</span>, as are the methods <span class="code">get</span>, <span class="code">setdefault</span>, and <span class="code">popitem</span>, and the operator <span class="code"><strong>in</strong></span>. <span class="code"><em>d1</em></span><span class="code">.update(<em>d</em>2)</span> is <span class="code">O(len(<em>d</em>2))</span>. <span class="code">len(<em>adict</em>)</span> is <span class="code">O(1)</span>. The methods <span class="code">keys</span>, <span class="code">items</span>, and <span class="code">values</span> are <span class="code">O(1)</span>, but looping on all items of the iterators those methods return is <span class="code">O(<em>N</em>)</span>, as is looping directly on a <span class="code">dict</span>.</p>
<p>When the keys in a dictionary are instances of classes that define <span class="code">__hash__</span> and equality comparison methods, dictionary performance is of course affected by those methods. The performance indications presented in this section hold when hashing and equality comparison on keys are <span class="code">O(1)</span>.</p>
</div></section>
<section data-pdf-bookmark="Set operations" data-type="sect3"><div class="sect3" id="set_operations">
<h3>Set operations</h3>
<p>Python<a contenteditable="false" data-primary="set operations" data-secondary="optimizing" data-type="indexterm" id="idm44924493513664"/> sets, like <span class="code">dict</span>s, are implemented with hash tables. All performance characteristics of sets are, in big-O terms, the same as for dictionaries.</p>
<p>Adding or removing an item in a set is <span class="code">O(1)</span>, as is the operator <span class="code"><strong>in</strong></span>. <span class="code">len(<em>aset</em>)</span> is <span class="code">O(1)</span>. Looping on a set is <span class="code">O(<em>N</em>)</span>. When the items in a set are instances of classes that define <span class="code">__hash__</span> and equality comparison methods, set performance is of course affected by those methods. The performance hints presented in this section hold when hashing and equality comparison on items are <span class="code">O(1)</span>.</p>
</div></section>
<section data-pdf-bookmark="Summary of big-O times for operations on Python built-in types" data-type="sect3"><div class="sect3" id="summary_of_big_o_times_for_operations_o">
<h3>Summary of big-O times for operations on Python built-in types</h3>
<p>Let<a contenteditable="false" data-primary="big-O notation" data-secondary="operations on Python built-in types" data-type="indexterm" id="idm44924493502960"/> <span class="code"><em>L</em></span> be any list, <span class="code"><em>T</em></span> any string (<span class="code">str</span> or <span class="code">bytes</span>), <span class="code"><em>D</em></span> any <span class="code">dict</span>, <span class="code"><em>S</em></span> any <span class="code">set</span> (with, say, numbers as items, just for the purpose of ensuring <span class="code">O(1)</span> hashing and comparison), and <span class="code"><em>x</em></span> any number (ditto):</p>
<dl>
<dt class="plain"><span class="code">O(1)</span></dt>
<dd><span class="code">len(<em>L</em>)</span>, <span class="code">len(T)</span>, <span class="code">len(<em>D</em>)</span>, <span class="code">len(S)</span>, <span class="code"><em>L</em></span><span class="code">[i]</span>, <span class="code"><em>T</em></span><span class="code">[i]</span>, <span class="code"><em>D</em></span><span class="code">[i]</span>, <span class="code">del D[i]</span>, <span class="code"><strong>if</strong></span> <span class="code"><em>x</em></span> <span class="code"><strong>in</strong></span> <span class="code">D</span>, <span class="code"><strong>if</strong></span> <span class="code"><em>x</em></span> <span class="code"><strong>in</strong></span> <span class="code"><em>S</em></span>, <span class="code"><em>S</em></span><span class="code">.add(<em>x</em>)</span>, <span class="code"><em>S</em></span><span class="code">.remove(<em>x</em>)</span>, appends or removals to/from the very right end of <span class="code"><em>L</em></span></dd>
<dt class="plain"><span class="code">O(</span>N<span class="code">)</span></dt>
<dd>Loops on <span class="code"><em>L</em></span>, <span class="code"><em>T</em></span>, <span class="code"><em>D</em></span>, <span class="code"><em>S</em></span>, general appends or removals to/from <span class="code"><em>L</em></span> (except at the very right end), all methods on <span class="code"><em>T</em></span>, <span class="code"><strong>if</strong></span> <span class="code"><em>x</em></span> <span class="code"><strong>in</strong></span> <span class="code"><em>L</em></span>, <span class="code"><strong>if</strong></span> <span class="code"><em>x</em></span> <span class="code"><strong>in</strong></span> <span class="code"><em>T</em></span>, most methods on <span class="code"><em>L</em></span>, all shallow copies</dd>
<dt class="plain"><span class="code">O(</span>N <span class="code">log</span> N<span class="code">)</span></dt>
<dd><span class="code"><em>L</em></span><span class="code">.sort()</span>, mostly (but <span class="code">O(<em>N</em>)</span> if <span class="code"><em>L</em></span> is already nearly sorted or reverse sorted)<a contenteditable="false" data-primary="" data-startref="algo17" data-type="indexterm" id="idm44924493450384"/><a contenteditable="false" data-primary="" data-startref="bigonot17" data-type="indexterm" id="idm44924493449040"/><a contenteditable="false" data-primary="" data-startref="Olarge17" data-type="indexterm" id="idm44924493447664"/></dd>
</dl>
</div></section>
</div></section>
<section data-pdf-bookmark="Profiling" data-type="sect2"><div class="sect2" id="profiling">
<h2>Profiling</h2>
<p>As<a contenteditable="false" data-primary="optimization" data-secondary="profiling" data-type="indexterm" id="Oprofile17"/><a contenteditable="false" data-primary="profiling" data-type="indexterm" id="prof17"/> mentioned at the start of this section, most programs have <em>hot spots</em>: relatively small regions of source code that account for most of the time elapsed during a program run. Don’t try to guess where your program’s hot spots are: a programmer’s intuition is notoriously unreliable in this field. Instead, use the Python standard library module <span class="code">profile</span> to collect profile data over one or more runs of your program, with known inputs. Then use the module <span class="code">pstats</span> to collate, interpret, and display that profile data.</p>
<p>To gain accuracy, you can calibrate the Python profiler for your machine (i.e., determine what overhead profiling incurs on that machine). The <span class="code">profile</span> module can then subtract this overhead from the times it measures, making profile data you collect closer to reality. The standard library module<a contenteditable="false" data-primary="cProfile module" data-type="indexterm" id="idm44924493438000"/> <span class="code">cProfile</span> has similar functionality to <span class="code">profile</span>; <span class="code">cProfile</span> is preferable, since it’s faster, which means it imposes less overhead.</p>
<p>There are also many third-party profiling tools worth considering, such as <a href="https://oreil.ly/taMU6">pyinstrument</a> and <a href="https://oreil.ly/CCbtt">Eliot</a>; an <a href="https://oreil.ly/UWs_3">excellent article</a> by Itamar Turner-Trauring explains the basics and advantages of each of these tools.</p>
<section data-pdf-bookmark="The profile module" data-type="sect3"><div class="sect3" id="the_profile_module">
<h3>The profile module</h3>
<p>The<a contenteditable="false" data-primary="profile module" data-type="indexterm" id="idm44924493430496"/><a contenteditable="false" data-primary="standard library modules" data-secondary="profile" data-type="indexterm" id="idm44924493429264"/> <span class="code">profile</span> module supplies one often-used function:</p>
<table class="border">
<tbody>
<tr>
<td><span class="code">run</span></td>
<td><span class="code">run(<em>code</em>, filename=<strong>None</strong>)</span><br/>
<span class="code"><em>code</em></span> is a string that is usable with <span class="code">exec</span>, normally a call to the main function of the program you’re profiling. <span class="code">filename</span> is the path of a file that <span class="code">run</span> creates or rewrites with profile data. Usually, you call <span class="code">run</span> a few times, specifying different filenames and different arguments to your program’s main function, in order to exercise various program parts in proportion to your expectations about their use “in real life.” Then, you use the <span class="code">pstats</span> module to display collated results across the various runs.<br/>
			You may call <span class="code">run</span> without a <span class="code">filename</span> to get a summary report, similar to the one the <span class="code">pstats</span> module provides, on standard output. However, this approach gives you no control over the output format, nor any way to consolidate several runs into one report. In practice, you should rarely use this feature: it’s best to collect profile data into files, then use <span class="code">pstats</span>.<br/>
			The <span class="code">profile</span> module also supplies the class <span class="code">Profile</span> (discussed briefly in the next section). By instantiating <span class="code">Profile</span> directly, you can access advanced functionality, such as the ability to run a command in specified local and global dictionaries. We do not cover such advanced functionality of the class <span class="code">profile.Profile</span> further in this book.</td>
</tr>
</tbody>
</table>
</div></section>
<section data-pdf-bookmark="Calibration" data-type="sect3"><div class="sect3" id="calibration">
<h3>Calibration</h3>
<p>To calibrate <span class="code">profile</span> for your machine, use the class <span class="code">Profile</span>, which <span class="code">profile</span> supplies and internally uses in the function <span class="code">run</span>. An instance <span class="code"><em>p</em></span> of <span class="code">Profile</span> supplies one method you use for calibration:</p>
<table class="border">
<tbody>
<tr>
<td class="width-15"><span class="code">calibrate</span></td>
<td><span class="code"><em>p</em></span><span class="code">.calibrate(<em>N</em>)</span><br/>
			Loops <span class="code"><em>N</em></span> times, then returns a number that is the profiling overhead per call on your machine. <span class="code"><em>N</em></span> must be large if your machine is fast. Call <span class="code"><em>p</em></span><span class="code">.calibrate(10000)</span> a few times and check that the various numbers it returns are close to each other, then pick the smallest one of them. If the numbers vary a lot, try again with a larger value of <span class="code"><em>N</em></span>.<br/>
			The calibration procedure can be time-consuming. However, you need to perform it only once, repeating it only when you make changes that could alter your machine’s characteristics, such as applying patches to your operating system, adding memory, or changing your Python version. Once you know your machine’s overhead, you can tell <span class="code">profile</span> about it each time you import it, right before using <span class="code">profile.run</span>. The simplest way to do this is as follows: 
			<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">profile</code><code>
</code><code class="n">profile</code><code class="o">.</code><code class="n">Profile</code><code class="o">.</code><code class="n">bias</code><code> </code><code class="o">=</code><code> </code><em><code class="o">.</code><code class="o">.</code><code class="o">.</code><code class="n">the</code><code> </code><code class="n">overhead</code><code> </code><code class="n">you</code><code> </code><code class="n">measured</code><code class="o">.</code><code class="o">.</code><code class="o">.</code></em><code>
</code><code class="n">profile</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="s1">'</code><code class="s1">main()</code><code class="s1">'</code><code class="p">,</code><code> </code><code class="s1">'</code><code class="s1">somefile</code><code class="s1">'</code><code class="p">)</code></pre>
</td>
</tr>
</tbody>
</table>
</div></section>
<section data-pdf-bookmark="The pstats module" data-type="sect3"><div class="sect3" id="the_pstats_module">
<h3>The pstats module</h3>
<p>The<a contenteditable="false" data-primary="pstats module" data-type="indexterm" id="pstatmod17"/><a contenteditable="false" data-primary="standard library modules" data-secondary="pstats" data-type="indexterm" id="idm44924493357248"/> <span class="code">pstats</span> module supplies a single class, <span class="code">Stats</span>, to analyze, consolidate, and report on the profile data contained in one or more files written by the function <span class="code">profile.run</span>. Its constructor has the signature:</p>
<table class="border">
<tbody>
<tr>
<td><span class="code">Stats</span></td>
<td><span class="code"><strong>class</strong></span> <span class="code">Stats(<em>filename</em>, *<em>filenames</em>, stream<em>=sys.stdout</em>)</span><br/>
			Instantiates <span class="code">Stats</span> with one or more filenames of files of profile data written by the function <span class="code">profile.run</span>, with profiling output sent to <span class="code">stream</span>.</td>
</tr>
</tbody>
</table>
<p>An instance <span class="code"><em>s</em></span> of the class <span class="code">Stats</span> provides methods to add profile data and sort and output results. Each method returns <span class="code"><em>s</em></span>, so you can chain many calls in the same expression. <span class="code"><em>s</em></span>’s main methods are listed in <a data-type="xref" href="#methods_of_an_instance_s_of_class_stats">Table 17-8</a>.</p>
<table class="border" id="methods_of_an_instance_s_of_class_stats">
<caption><span class="label">Table 17-8. </span><em>Methods of an instance <span class="code">s</span> of class <span class="code">Stats</span></em></caption>
<tbody>
<tr>
<td class="width-15"><span class="code">add</span></td>
<td><span class="code">add(<em>filename</em>)</span><br/>
			Adds another file of profile data to the set that <span class="code"><em>s</em></span> is holding for analysis.</td>
</tr>
<tr>
<td><span class="code">pr⁠i⁠n⁠t⁠_​c⁠a⁠l⁠lees</span>,<br/>
<span class="code">pri⁠n⁠t⁠_​c⁠a⁠l⁠lers</span></td>
<td><span class="code">print_callees(<em>*restrictions</em>)</span>,<br/>
<span class="code">print_callers(<em>*restrictions</em>)</span><br/>
			Outputs the list of functions in <span class="code"><em>s</em></span>’s profile data, sorted according to the latest call to <span class="code"><em>s</em></span><span class="code">.sort_stats</span> and subject to given restrictions, if any. You can call each printing method with zero or more <span class="code"><em>restrictions</em></span>, to be applied one after the other, in order, to reduce the number of output lines. A restriction that is an <span class="code">int</span> <span class="code"><em>n</em></span> limits the output to the first <span class="code"><em>n</em></span> lines. A restriction that is a <span class="code">float</span> <span class="code"><em>f</em></span> between <span class="code">0.0</span> and <span class="code">1.0</span> limits the output to a fraction <span class="code"><em>f</em></span> of the lines. A restriction that is a string is compiled as a regular expression pattern (covered in <a data-type="xref" href="ch10.xhtml#regular_expressions_and_the_re_module">“Regular Expressions and the re Module”</a>); only lines that satisfy a <span class="code">search</span> method call on the regular expression are output. Restrictions are cumulative. For example, <span class="code"><em>s</em></span><span class="code">.print_callees(10, 0.5)</span> outputs the first 5 lines (half of 10). Restrictions apply only after the summary and header lines: the summary and header lines are output unconditionally.<br/>
			Each function <span class="code"><em>f</em></span> in the output is accompanied by the list of <span class="code"><em>f</em></span>’s callers (functions that called <span class="code"><em>f</em></span>) or <span class="code"><em>f</em></span>’s callees (functions that <span class="code"><em>f</em></span> called), according to the name of the method.</td>
</tr>
<tr>
<td><span class="code">print_stats</span></td>
<td><span class="code">print_stats(<em>*restrictions</em>)</span><br/>
			Outputs statistics about <span class="code"><em>s</em></span>’s profile data, sorted according to the latest call to <span class="code"><em>s</em></span><span class="code">.sort_stats</span> and subject to given restrictions, if any, as covered in <span class="code">print_callees</span> and <span class="code">print_callers</span>, above. After a few summary lines (date and time on which profile data was collected, number of function calls, and sort criteria used), the output—absent restrictions—is one line per function, with six fields per line, labeled in a header line. <span class="code">print_stats</span> outputs the following fields for each function <span class="code"><em>f</em></span>: 
			<ol>
<li>Total number of calls to <span class="code"><em>f</em></span></li>
<li>Total time spent in <span class="code"><em>f</em></span>, exclusive of other functions that <span class="code"><em>f</em></span> called</li>
<li>Total time per call to <span class="code"><em>f</em></span> (i.e., field 2 divided by field 1)</li>
<li>Cumulative time spent in <span class="code"><em>f</em></span>, and all functions directly or indirectly called from <span class="code"><em>f</em></span></li>
<li>Cumulative time per call to <span class="code"><em>f</em></span> (i.e., field 4 divided by field 1)</li>
<li>The name of function <span class="code"><em>f</em></span></li>
</ol>
</td>
</tr>
<tr>
<td><span class="code">sort_stats</span></td>
<td><span class="code">sort_stats(<em>*keys</em>)</span><br/>
			Gives one or more keys on which to sort future output. Each key is either a string or a member of the enum <span class="code">pstats.SortKey</span>. The sort is descending for keys that indicate times or numbers, and alphabetical for key <span class="code">'nfl'</span>. The most frequently used keys when calling <span class="code">sort_stats</span> are:
			<dl>
<dt class="plain"><span class="code">SortKey.CALLS</span> or <span class="code">'calls'</span></dt>
<dd>Number of calls to the function (like field 1 in the <span class="code">print_stats</span> output)</dd>
<dt class="plain"><span class="code">SortKey.CUMULATIVE</span> or <span class="code">'cumulative'</span></dt>
<dd>Cumulative time spent in the function and all functions it called (like field 4 in the <span class="code">print_stats</span> output)</dd>
<dt class="plain"><span class="code">SortKey.NFL</span> or <span class="code">'nfl'</span></dt>
<dd>Name of the function, its module, and the line number of the function in its file (like field 6 in the <span class="code">print_stats</span> output)</dd>
<dt class="plain"><span class="code">SortKey.TIME</span> or <span class="code">'time'</span></dt>
<dd>Total time spent in the function itself, exclusive of functions it called (like field 2 in the <span class="code">print_stats</span> output)</dd>
</dl>
</td>
</tr>
<tr>
<td><span class="code">strip_dirs</span></td>
<td><span class="code">strip_dirs()</span><br/>
			Alters <span class="code"><em>s</em></span> by stripping directory names from all module names to make future output more compact. <span class="code"><em>s</em></span> is unsorted after <span class="code"><em>s</em></span><span class="code">.strip_dirs</span>, and therefore you normally call <span class="code"><em>s</em></span><span class="code">.sort_stats</span> right after calling <span class="code"><em>s</em></span><span class="code">.strip_dirs</span>.<a contenteditable="false" data-startref="prof17" data-type="indexterm" id="idm44924493239184"/><a contenteditable="false" data-startref="Oprofile17" data-type="indexterm" id="idm44924493238048"/><a contenteditable="false" data-primary="" data-startref="pstatmod17" data-type="indexterm" id="idm44924493236944"/></td>
</tr>
</tbody>
</table>
</div></section>
</div></section>
<section data-pdf-bookmark="Small-Scale Optimization" data-type="sect2"><div class="sect2" id="small_scale_optimization">
<h2>Small-Scale Optimization</h2>
<p>Fine-tuning<a contenteditable="false" data-primary="optimization" data-secondary="small-scale" data-type="indexterm" id="Osmall17"/> of program operations is rarely important. It may make a small but meaningful difference in some particularly hot spot, but it is hardly ever a decisive factor. And yet, fine-tuning—in the pursuit of mostly irrelevant microefficiencies—is where a programmer’s instincts are likely to lead them. It is in good part because of this that most optimization is premature and best avoided. The most that can be said in favor of fine-tuning is that, if one idiom is <em>always</em> speedier than another when the difference is measurable, then it’s worth your while to get into the habit of always using the speedier way.<sup><a data-type="noteref" href="ch17.xhtml#ch01fn134" id="ch01fn134-marker">10</a></sup></p>
<p>In Python, if you do what comes naturally, choosing simplicity and elegance, you typically end up with code that has good performance and is clear and maintainable. In other words, <em>let Python do the work</em>: when Python provides a simple, direct way to perform a task, chances are that it’s also the fastest way. In a few cases, an approach that may not be intuitively preferable still offers performance advantages, as discussed in the rest of this section.</p>
<p>The simplest optimization is to run your Python programs using <span class="code"><strong>python -O</strong></span> or <span class="code"><strong>-OO</strong></span>. <span class="code"><strong>-OO</strong></span> makes little difference to performance compared to <span class="code"><strong>-O</strong></span> but may save some memory, as it removes docstrings from the bytecode, and memory is sometimes (indirectly) a performance bottleneck. The optimizer is not powerful in current releases of Python, but it may gain you performance advantages on the order of 5-10% (and potentially larger if you make use of <span class="code"><strong>assert</strong></span> statements and <span class="code"><strong>if</strong></span> <span class="code">__debug__:</span> guards, as suggested in <a data-type="xref" href="ch06.xhtml#the_assert_statement">“The assert Statement”</a>). The best aspect of <span class="code"><strong>-O</strong></span> is that it costs nothing—as long as your optimization isn’t premature, of course (don’t bother using <span class="code"><strong>-O</strong></span> on a program you’re still developing).</p>
<section data-pdf-bookmark="The timeit module" data-type="sect3"><div class="sect3" id="the_timeit_module">
<h3>The timeit module</h3>
<p>The<a contenteditable="false" data-primary="timeit module" data-type="indexterm" id="idm44924493217584"/><a contenteditable="false" data-primary="standard library modules" data-secondary="timeit" data-type="indexterm" id="idm44924493216448"/> standard library module <span class="code">timeit</span> is handy for measuring the precise performance of specific snippets of code. You can import <span class="code">timeit</span> to use <span class="code">timeit</span>’s functionality in your programs, but the simplest and most normal use is from the command line:</p>
<pre data-code-language="python" data-type="programlisting">
$ <strong>python -m timeit -s '</strong><strong><em>setup statement(s)</em></strong><strong>' '</strong><strong><em>statement(s) to be timed</em></strong><strong>'</strong></pre>
<p>The “setup statement” is executed only once, to set things up; the “statements to be timed” are executed repeatedly, to accurately measure the average time they take.</p>
<p>For example, say you’re wondering about the performance of <span class="code">x=x+1</span> versus <span class="code">x+=1</span>, where <span class="code">x</span> is an <span class="code">int</span>. At a command prompt, you can easily try:</p>
<pre data-code-language="python" data-type="programlisting"><code class="err">$</code> <code class="n">python</code> <code class="o">-</code><code class="n">m</code> <code class="n">timeit</code> <code class="o">-</code><code class="n">s</code> <code class="s1">'x=0'</code> <code class="s1">'x=x+1'</code></pre>
<pre data-type="programlisting"><strong>1000000 loops, best of 3: 0.0416 usec per loop</strong></pre>
<pre data-code-language="python" data-type="programlisting"><code class="err">$</code> <code class="n">python</code> <code class="o">-</code><code class="n">m</code> <code class="n">timeit</code> <code class="o">-</code><code class="n">s</code> <code class="s1">'x=0'</code> <code class="s1">'x+=1'</code></pre>
<pre data-type="programlisting"><strong>1000000 loops, best of 3: 0.0406 usec per loop</strong></pre>
<p>and find out that performance is, for all intents and purposes, the same in both cases (a tiny difference, such as the 2.5% in this case, is best regarded as “noise”).</p>
</div></section>
<section data-pdf-bookmark="Memoizing" data-type="sect3"><div class="sect3" id="memoizing">
<h3>Memoizing</h3>
<p><em>Memoizing<a contenteditable="false" data-primary="memoization" data-type="indexterm" id="memoiz17"/></em> is the technique of saving values returned from a function that is called repeatedly with the same argument values. When the function is called with arguments that have not been seen before, a memoizing function computes the result, and then saves the arguments used to call it and the corresponding result<a contenteditable="false" data-primary="caching" data-type="indexterm" id="idm44924493172352"/> in a cache. When the function is called again later with the same arguments, the function just looks up the computed value in the cache instead of rerunning the function calculation logic. In this way, the calculation is performed just once for any particular argument or arguments.</p>
<p>Here is an example of a function for calculating the sine of a value given in degrees:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">math</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">sin_degrees</code><code class="p">(</code><code class="n">x</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">math</code><code class="o">.</code><code class="n">sin</code><code class="p">(</code><code class="n">math</code><code class="o">.</code><code class="n">radians</code><code class="p">(</code><code class="n">x</code><code class="p">)</code><code class="p">)</code></pre>
<p>If we determined that <span class="code">sin_degrees</span> was a bottleneck, and was being repeatedly called with the same values for <span class="code">x</span> (such as the integer values from <span class="code">0</span> to <span class="code">360</span>, as you might use when displaying an analog clock), we could add a memoizing cache:</p>
<pre data-code-language="python" data-type="programlisting">
<code class="n">_cached_values</code><code> </code><code class="o">=</code><code> </code><code class="p">{</code><code class="p">}</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">sin_degrees</code><code class="p">(</code><code class="n">x</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><strong><code class="k">if</code></strong><code> </code><code class="n">x</code><code> </code><strong><code class="ow">not</code></strong><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">_cached_values</code><code class="p">:</code><code>
</code><code>        </code><code class="n">_cached_values</code><code class="p">[</code><code class="n">x</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">math</code><code class="o">.</code><code class="n">sin</code><code class="p">(</code><code class="n">math</code><code class="o">.</code><code class="n">radians</code><code class="p">(</code><code class="n">x</code><code class="p">)</code><code class="p">)</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">_cached_values</code><code class="p">[</code><code class="n">x</code><code class="p">]</code></pre>
<p>For functions that take multiple arguments, the tuple of argument values would be used for the cache key.</p>
<p>We defined <em><span class="code">_cached_values</span></em> outside the function, so that it is not reset each time we call the function. To explicitly associate the cache with the function, we can utilize Python’s object model, which allows us to treat functions as objects and assign attributes to them:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="k">def</code></strong><code> </code><code class="nf">sin_degrees</code><code class="p">(</code><code class="n">x</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">cache</code><code> </code><code class="o">=</code><code> </code><code class="n">sin_degrees</code><code class="o">.</code><code class="n">_cached_values</code><code>
</code><code>    </code><strong><code class="k">if</code></strong><code> </code><code class="n">x</code><code> </code><strong><code class="ow">not</code></strong><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">cache</code><code class="p">:</code><code>
</code><code>        </code><code class="n">cache</code><code class="p">[</code><code class="n">x</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">math</code><code class="o">.</code><code class="n">sin</code><code class="p">(</code><code class="n">math</code><code class="o">.</code><code class="n">radians</code><code class="p">(</code><code class="n">x</code><code class="p">)</code><code class="p">)</code><code>
</code><code>    </code><strong><code class="k">return</code></strong><code> </code><code class="n">cache</code><code class="p">[</code><code class="n">x</code><code class="p">]</code><code>
</code><code class="n">sin_degrees</code><code class="o">.</code><code class="n">_cached_values</code><code> </code><code class="o">=</code><code> </code><code class="p">{</code><code class="p">}</code></pre>
<p>Caching is a classic approach to gain performance at the expense of using memory (the<a contenteditable="false" data-primary="time–memory trade-off" data-type="indexterm" id="idm44924492953424"/> <em>time–memory trade-off</em>). The cache in this example is unbounded, so, as <span class="code">sin_degrees</span> is called with many different values of <span class="code">x</span>, the cache will continue to grow, consuming more and more program memory. Caches are often configured with an<a contenteditable="false" data-primary="eviction policies" data-type="indexterm" id="idm44924492962800"/> <em>eviction policy</em>, which determines when values can be removed from the cache. Removing the oldest cached value is a common eviction policy. Since Python keeps <span class="code">dict</span> entries in insertion order, the “oldest” key will be the first one found if we iterate over the <span class="code">dict</span>:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="k">def</code></strong><code> </code><code class="nf">sin_degrees</code><code class="p">(</code><code class="n">x</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">cache</code><code> </code><code class="o">=</code><code> </code><code class="n">sin_degrees</code><code class="o">.</code><code class="n">_cached_values</code><code>
</code><code>    </code><strong><code class="k">if</code></strong><code> </code><code class="n">x</code><code> </code><strong><code class="ow">not</code></strong><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">cache</code><code class="p">:</code><code>
</code><code>        </code><code class="n">cache</code><code class="p">[</code><code class="n">x</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">math</code><code class="o">.</code><code class="n">sin</code><code class="p">(</code><code class="n">math</code><code class="o">.</code><code class="n">radians</code><code class="p">(</code><code class="n">x</code><code class="p">)</code><code class="p">)</code><code>
</code><em><code>        </code><code class="c1"># remove oldest cache entry if exceed maxsize limit</code></em><code>
</code><code>        </code><strong><code class="k">if</code></strong><code> </code><code class="nb">len</code><code class="p">(</code><code class="n">cache</code><code class="p">)</code><code> </code><code class="o">&gt;</code><code> </code><code class="n">sin_degrees</code><code class="o">.</code><code class="n">_maxsize</code><code class="p">:</code><code>
</code><code>            </code><code class="n">oldest_key</code><code> </code><code class="o">=</code><code> </code><code class="nb">next</code><code class="p">(</code><code class="nb">iter</code><code class="p">(</code><code class="n">cache</code><code class="p">)</code><code class="p">)</code><code>
</code><code>            </code><code class="k">del</code><code> </code><code class="n">cache</code><code class="p">[</code><code class="n">oldest_key</code><code class="p">]</code><code>
</code><code>    </code><strong><code class="k">return</code></strong><code> </code><code class="n">cache</code><code class="p">[</code><code class="n">x</code><code class="p">]</code><code>
</code><code class="n">sin_degrees</code><code class="o">.</code><code class="n">_cached_values</code><code> </code><code class="o">=</code><code> </code><code class="p">{</code><code class="p">}</code><code>
</code><code class="n">sin_degrees</code><code class="o">.</code><code class="n">_maxsize</code><code> </code><code class="o">=</code><code> </code><code class="mi">512</code></pre>
<p>You can see that this starts to complicate the code, with the original logic for computing the sine of a value given in degrees hidden inside all the caching logic. The Python stdlib module <span class="code">functools</span> includes caching decorators <span class="code">lru_cache</span>, <span class="version">3.9+</span> <span class="code">cache</span>, and <span class="version">3.8+</span> <span class="code">cached_property</span> to perform memoization cleanly. For example:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">functools</code><code>
</code><code class="nd">@functools</code><code class="o">.</code><code class="n">lru_cache</code><code class="p">(</code><code class="n">maxsize</code><code class="o">=</code><code class="mi">512</code><code class="p">)</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">sin_degrees</code><code class="p">(</code><code class="n">x</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><strong><code class="k">return</code></strong><code> </code><code class="n">math</code><code class="o">.</code><code class="n">sin</code><code class="p">(</code><code class="n">math</code><code class="o">.</code><code class="n">radians</code><code class="p">(</code><code class="n">x</code><code class="p">)</code><code class="p">)</code></pre>
<p>The signatures for these decorators are described in detail in <a data-type="xref" href="ch08.xhtml#the_functools_module">“The functools Module”</a>.</p>
<div data-type="warning" epub:type="warning">
<h1>Caching Floating-Point Values Can Give Undesirable Behavior</h1>
<p>As<a contenteditable="false" data-primary="floating-point numbers" data-secondary="caching and" data-type="indexterm" id="idm44924492772368"/> was described in <a data-type="xref" href="ch16.xhtml#floating_point_values">“Floating-Point Values”</a>, comparing <span class="code">float</span> values for equality can return <span class="code"><strong>False</strong></span> when the values are actually within some expected tolerance for being considered equal. With an unbounded cache, a cache containing <span class="code">float</span> keys may grow unexpectedly large by caching multiple values that differ only in the 18th decimal place. For a bounded cache, many <span class="code">float</span> keys that are very nearly equal may cause the unwanted eviction of other values that are significantly different.</p>
<p>All the cache techniques listed here use equality matching, so code for memoizing a function with one or more <span class="code">float</span> arguments should take extra steps to cache rounded values, or use <span class="code">math.isclose</span> for matching.<a contenteditable="false" data-primary="" data-startref="Osmall17" data-type="indexterm" id="idm44924492737600"/><a contenteditable="false" data-primary="" data-startref="memoiz17" data-type="indexterm" id="idm44924492736384"/></p>
</div>
</div></section>
<section data-pdf-bookmark="Precomputing a lookup table" data-type="sect3"><div class="sect3" id="precomputing_a_lookup_table">
<h3>Precomputing a lookup table</h3>
<p>In<a contenteditable="false" data-primary="lookup tables" data-type="indexterm" id="idm44924492733264"/> some cases, you can predict all the values that your code will use when calling a particular function. This allows you to precompute the values and save them in a lookup table. For example, in our application that is going to compute the <span class="code">sin</span> function for the integer degree values <span class="code">0</span> to <span class="code">360</span>, we can perform this work just once at program startup and keep the results in a Python <span class="code">dict</span>:</p>
<pre data-code-language="python" data-type="programlisting">
<code class="n">_sin_degrees_lookup</code><code> </code><code class="o">=</code><code> </code><code class="p">{</code><code class="n">x</code><code class="p">:</code><code> </code><code class="n">math</code><code class="o">.</code><code class="n">sin</code><code class="p">(</code><code class="n">math</code><code class="o">.</code><code class="n">radians</code><code class="p">(</code><code class="n">x</code><code class="p">)</code><code class="p">)</code><code>
</code><code>                       </code><strong><code class="k">for</code></strong><code> </code><code class="n">x</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="nb">range</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">360</code><code class="o">+</code><code class="mi">1</code><code class="p">)</code><code class="p">}</code><code>
</code><code class="n">sin_degrees</code><code> </code><code class="o">=</code><code> </code><code class="n">_sin_degrees_lookup</code><code class="o">.</code><code class="n">get</code></pre>
<p>Binding <span class="code">sin_degrees</span> to the <span class="code">_sin_degrees_lookup</span> <span class="code">dict</span>’s <span class="code">get</span> method means the rest of our program can still call <span class="code">sin_degrees</span> as a function, but now the value retrieval occurs at the speed of a <span class="code">dict</span> lookup, with no additional function overhead.</p>
</div></section>
<section data-pdf-bookmark="Building up a string from pieces" data-type="sect3"><div class="sect3" id="building_up_a_string_from_pieces">
<h3>Building up a string from pieces</h3>
<p>The<a contenteditable="false" data-primary="strings" data-secondary="building from pieces" data-type="indexterm" id="idm44924492690864"/> single Python “anti-idiom” that is most likely to damage your program’s performance, to the point that you should <em>never</em> use it, is to build up a large string from pieces by looping on string concatenation statements such as <span class="code">big_string</span> <span class="code">+= piece</span>. Python strings are immutable, so each such concatenation means that Python must free the <em><span class="code">M</span></em> bytes previously allocated for <span class="code">big_string</span>, and allocate and fill <em><span class="code">M</span></em> <span class="code">+</span> <em><span class="code">K</span></em> bytes for the new version. Doing this repeatedly in a loop, you end up with roughly <span class="code">O(</span><em><span class="code">N</span></em><span class="code">²)</span> performance, where <em><span class="code">N</span></em> is the total number of characters. More often than not, getting <span class="code">O(</span><em><span class="code">N</span></em><span class="code">²)</span> performance where <span class="code">O(</span><em><span class="code">N</span></em><span class="code">)</span> is easily available is a disaster.<sup><a data-type="noteref" href="ch17.xhtml#ch01fn135" id="ch01fn135-marker">11</a></sup> On some platforms, things may be even bleaker due to memory fragmentation effects caused by freeing many areas of progressively larger sizes.</p>
<p>To achieve <span class="code">O(</span><em><span class="code">N</span></em><span class="code">)</span> performance, accumulate intermediate pieces in a list, rather than building up the string piece by piece. Lists, unlike strings, are mutable, so appending to a list is <span class="code">O(1)</span> (amortized). Change each occurrence of <span class="code">big_string</span> <span class="code">+= piece</span> into <span class="code">temp_list.append(piece)</span>. Then, when you’re done accumulating, use the following code to build your desired string result in <span class="code">O(</span><em><span class="code">N</span></em><span class="code">)</span> time:</p>
<pre data-code-language="python" data-type="programlisting">
<code class="n">big_string</code> <code class="o">=</code> <code class="s1">''</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="n">temp_list</code><code class="p">)</code></pre>
<p>Using a list comprehension, generator expression, or other direct means (such as a call to <span class="code">map</span>, or use of the standard library module <span class="code">itertools</span>) to build <span class="code">temp_list</span> may often offer further (substantial, but not big-O) optimization over repeated calls to <span class="code">temp_list.append</span>. Other <span class="code">O(</span><em><span class="code">N</span></em><span class="code">)</span> ways to build up big strings, which a few Python programmers find more readable, are to concatenate the pieces to an instance of <span class="code">array.array('u')</span> with the<a contenteditable="false" data-primary="extend method" data-secondary="array" data-type="indexterm" id="idm44924492614656"/> array’s <span class="code">extend</span> method, use a <span class="code">bytearray</span>, or write the pieces to an instance of <span class="code">io.TextIO</span> or <span class="code">io.BytesIO</span>.</p>
<p>In the special case where you want to output the resulting string, you may gain a further small slice of performance by using <span class="code">writelines</span> on <span class="code">temp_list</span> (never building <span class="code">big_string</span> in memory). When feasible (i.e., when you have the output file object open and available in the loop, and the file is buffered), it’s just as effective to perform a <span class="code">write</span> call for each <span class="code">piece</span>, without any accumulation.</p>
<p>Although not nearly as crucial as <span class="code">+=</span> on a big string in a loop, another case where removing string concatenation may give a slight performance improvement is when you’re concatenating several values in an expression:</p>
<pre data-code-language="python" data-type="programlisting">
<code class="n">oneway</code> <code class="o">=</code> <code class="nb">str</code><code class="p">(</code><code class="n">x</code><code class="p">)</code> <code class="o">+</code> <code class="s1">' eggs and '</code> <code class="o">+</code> <code class="nb">str</code><code class="p">(</code><code class="n">y</code><code class="p">)</code> <code class="o">+</code> <code class="s1">' slices of '</code> <code class="o">+</code> <code class="n">k</code> <code class="o">+</code> <code class="s1">' ham'</code>
<code class="n">another</code> <code class="o">=</code> <code class="s1">'</code><code class="si">{}</code><code class="s1"> eggs and </code><code class="si">{}</code><code class="s1"> slices of </code><code class="si">{}</code><code class="s1"> ham'</code><code class="o">.</code><code class="n">format</code><code class="p">(</code><code class="n">x</code><code class="p">,</code> <code class="n">y</code><code class="p">,</code> <code class="n">k</code><code class="p">)</code>
<code class="n">yetanother</code> <code class="o">=</code> <code class="sa">f</code><code class="s1">'</code><code class="si">{</code><code class="n">x</code><code class="si">}</code><code class="s1"> eggs and </code><code class="si">{</code><code class="n">y</code><code class="si">}</code><code class="s1"> slices of </code><code class="si">{</code><code class="n">k</code><code class="si">}</code><code class="s1"> ham'</code></pre>
<p>Formatting strings using the <span class="code">format</span> method or f-strings (discussed in <a data-type="xref" href="ch08.xhtml#core_built_ins_and_standard_library_mod">Chapter 8</a>) is often a good performance choice, as well as being more idiomatic and thereby clearer than concatenation approaches. On a sample run of the preceding example, the <span class="code">format</span> approach is more than twice as fast as the (perhaps more intuitive) concatenation, and the f-string approach is more than twice as fast as <span class="code">format</span>.</p>
</div></section>
<section class="pagebreak-before" data-pdf-bookmark="Searching and sorting" data-type="sect3"><div class="sect3" id="searching_and_sorting">
<h3 class="less_space">Searching and sorting</h3>
<p>The<a contenteditable="false" data-primary="searches, optimization of" data-type="indexterm" id="idm44924492548560"/><a contenteditable="false" data-primary="sorting, optimization of" data-type="indexterm" id="idm44924492546736"/><a contenteditable="false" data-primary="in keyword" data-secondary="searching and sorting" data-type="indexterm" id="idm44924492497744"/> operator <span class="code"><strong>in</strong></span>, the most natural tool for searching, is <span class="code">O(1)</span> when the righthand-side operand is a <span class="code">set</span> or <span class="code">dict</span>, but <span class="code">O(</span><em><span class="code">N</span></em><span class="code">)</span> when the righthand-side operand is a string, list, or <span class="code">tuple</span>. If you must perform many such checks on a container, you’re <em>much</em> better off using a <span class="code">set</span> or <span class="code">dict</span>, rather than a list or <span class="code">tuple</span>, as the container. Python <span class="code">set</span>s and <span class="code">dict</span>s are highly optimized for searching and fetching items by key. Building the <span class="code">set</span> or <span class="code">dict</span> from other containers, however, is <span class="code">O(</span><em><span class="code">N</span></em><span class="code">)</span>, so for this crucial optimization to be worthwhile, you must be able to hold on to the <span class="code">set</span> or <span class="code">dict</span> over several searches, possibly altering it apace as the underlying sequence changes.</p>
<p>The <span class="code">sort</span> method of Python lists is also a highly optimized and sophisticated tool. You can rely on <span class="code">sort</span>’s performance. Most functions and methods in the standard library that perform comparisons accept a <span class="code">key</span> argument to determine how, exactly, to compare items. You provide a <span class="code">key</span> function, which computes a key value for each element in the list. The list elements are sorted by their key values. For instance, you might write a key function for sorting objects based on an attribute <em><span class="code">attr</span></em> as <span class="code"><strong>lambda</strong></span> <span class="code">ob: ob.</span><em><span class="code">attr</span></em>, or one for sorting <span class="code">dict</span>s by <span class="code">dict</span> key <span class="code">'</span><em><span class="code">attr</span></em><span class="code">'</span> as <span class="code"><strong>lambda</strong></span> <span class="code">d: d['</span><em><span class="code">attr</span></em><span class="code">']</span>. (The <span class="code">attrgetter</span> and <span class="code">itemgetter</span> methods of the <span class="code">operator</span> module are useful alternatives to these simple key functions; they’re clearer and sharper than <span class="code"><strong>lambda</strong></span> and offer performance gains as well.)</p>
<p>Older versions of Python used a <span class="code">cmp</span> function, which would take list elements in pairs <span class="code">(<em>A</em>,</span> <span class="code"><em>B</em></span><span class="code">)</span> and return <span class="code">-1</span>, <span class="code">0</span>, or <span class="code">1</span> for each pair depending on which of <span class="code"><em>A</em></span> <span class="code">&lt;</span> <span class="code"><em>B</em></span>, <span class="code"><em>A</em></span> <span class="code">==</span> <span class="code"><em>B</em></span>, or <span class="code"><em>A</em></span> <span class="code">&gt;</span> <span class="code"><em>B</em></span> is true. Sorting using a <span class="code">cmp</span> function is very slow, as it may have to compare every element to every other element (potentially <span class="code">O(</span><span class="code"><em>N</em></span><sup><span class="code">2</span></sup><span class="code">)</span> performance). The <span class="code">sort</span> function in current Python versions no longer accepts a <span class="code">cmp</span> function argument. If you are migrating ancient code and only have a function suitable as a <span class="code">cmp</span> argument, you can use <span class="code">functools.cmp_to_key</span> to build from it a key function suitable to pass as the new <span class="code">key</span> argument.</p>
<p>However, several functions in the module <span class="code">heapq</span>, covered in <a data-type="xref" href="ch08.xhtml#the_heapq_module">“The heapq Module”</a>, do not accept a <span class="code">key</span> argument. In such cases, you can use the DSU idiom, covered in <a data-type="xref" href="ch08.xhtml#the_decorateen_dashsorten_dashundecorat">“The Decorate–Sort–Undecorate Idiom”</a>. (Heaps are well worth keeping in mind, since in some cases they can save you from having to perform sorting on all of your data.)</p>
</div></section>
<section data-pdf-bookmark="Avoid exec and from ... import *" data-type="sect3"><div class="sect3" id="avoid_exec_and_from_dotdotdot_import_as">
<h3>Avoid exec and from ... import *</h3>
<p>Code<a contenteditable="false" data-primary="exec (built-in function)" data-type="indexterm" id="idm44924492441440"/><a contenteditable="false" data-primary="from ... import" data-type="indexterm" id="idm44924492440272"/> in a function runs faster than code at the top level in a module, because access to a function’s local variables is faster than access to globals. If a function contains an <span class="code">exec</span> without explicit <span class="code">dict</span>s, however, the function slows down. The presence of such an <span class="code">exec</span> forces the Python compiler to avoid the modest but important optimization it normally performs regarding access to local variables, since the <span class="code">exec</span> might alter the function’s namespace. A <span class="code"><strong>from</strong></span> statement of the form:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="kn">from</code></strong><code> </code><em><code class="nn">my_module</code></em><code> </code><strong><code class="kn">import</code></strong><code> </code><code class="o">*</code></pre>
<p>wastes performance too, since it also can alter a function’s namespace unpredictably, and therefore inhibits Python’s local-variable optimization.</p>
<p><span class="code">exec</span> itself is also quite slow, and even more so if you apply it to a string of source code rather than to a code object. By far the best approach—for performance, for correctness, and for clarity—is to avoid <span class="code">exec</span> altogether. It’s most often possible to find better (faster, more robust, and clearer) solutions. If you <em>must</em> use <span class="code">exec</span>, <em>always</em> use it with explicit <span class="code">dict</span>s, although avoiding <span class="code">exec</span> altogether is <em>far</em> better, if at all feasible. If you need to <span class="code">exec</span> a dynamically obtained string more than once, <span class="code">compile</span> the string just once and then repeatedly <span class="code">exec</span> the resulting code object.</p>
<p><span class="code">eval</span> works on expressions, not on statements; therefore, while still slow, it avoids some of the worst performance impacts of <span class="code">exec</span>. With <span class="code">eval</span>, too, you’re best advised to use explicit <span class="code">dict</span>s. As with <span class="code">exec</span>, if you need multiple evaluations of the same dynamically obtained string, <span class="code">compile</span> the string once and then repeatedly <span class="code">eval</span> the resulting code object. Avoiding <span class="code">eval</span> altogether is even better.</p>
<p>See <a data-type="xref" href="ch14.xhtml#dynamic_execution_and_exec">“Dynamic Execution and exec”</a> for more details and advice about <span class="code">exec</span>, <span class="code">eval</span>, and <span class="code">compile</span>.</p>
</div></section>
<section data-pdf-bookmark="Short-circuiting of Boolean expressions" data-type="sect3"><div class="sect3" id="short_circuiting_of_boolean_expressions">
<h3>Short-circuiting of Boolean expressions</h3>
<p>Python<a contenteditable="false" data-primary="Boolean expressions" data-type="indexterm" id="idm44924491078560"/> evaluates Boolean expressions from left to right according to the precedence of the operations <span class="code"><strong>not</strong></span>, <span class="code"><strong>and</strong></span>, and <span class="code"><strong>or</strong></span>. When, from evaluating just the leading terms, Python can determine that the overall expression must be <span class="code"><strong>True</strong></span> or <span class="code"><strong>False</strong></span>, it skips the rest of the expression. This feature is known as <em>short-circuiting</em>, so called because Python bypasses unneeded processing the same way an electrical short bypasses parts of an electrical circuit.</p>
<p>In this example, both conditions must be <span class="code"><strong>True</strong></span> to continue:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="k">if</code></strong><code> </code><code class="n">slow_function</code><code class="p">(</code><code class="p">)</code><code> </code><strong><code class="ow">and</code></strong><code> </code><code class="n">fast_function</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><em><code>   </code></em><code> </code><em><code class="c1">#</code></em><code class="c1"> </code><em><code class="c1">...</code></em><code class="c1"> </code><em><code class="c1">proceed with processing</code></em><em><code class="c1"> ...</code></em></pre>
<p>When <span class="code">fast_function</span> is going to return <span class="code"><strong>False</strong></span>, it’s faster to evaluate it first, potentially avoiding the call to <span class="code">slow_function</span> altogether:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="k">if</code></strong><code> </code><code class="n">fast_function</code><code class="p">(</code><code class="p">)</code><code> </code><strong><code class="ow">and</code></strong><code> </code><code class="n">slow_function</code><code class="p">(</code><code class="p">)</code><code class="p">:</code><code>
</code><em><code>   </code></em><code> </code><em><code class="c1">#</code></em><code class="c1"> </code><em><code class="c1">...</code></em><code class="c1"> </code><em><code class="c1">proceed with processing</code></em><em><code class="c1"> ...</code></em></pre>
<p>This optimization also applies when the operator is <span class="code"><strong>or</strong></span>, when either case must be <span class="code"><strong>True</strong></span> to continue: when <span class="code">fast_function</span> returns <span class="code"><strong>True</strong></span>, Python skips <span class="code">slow_function</span> completely.</p>
<p>You can optimize these expressions by considering the order of the expressions’ operators and terms, and order them so that Python evaluates the faster subexpressions first.</p>
<div data-type="warning" epub:type="warning">
<h1>Short-Circuiting May Bypass Needed Functions</h1>
<p>In the preceding examples, when <span class="code">slow_function</span> performs some important “side effect” behavior (such as logging to an audit file, or notifying an administrator of a system condition), short-circuiting may unexpectedly skip that behavior. Take care when including necessary behavior as part of a Boolean expression, and do not overoptimize and remove important functionality.</p>
</div>
</div></section>
<section data-pdf-bookmark="Short-circuiting of iterators" data-type="sect3"><div class="sect3" id="short_circuiting_of_iterators">
<h3>Short-circuiting of iterators</h3>
<p>Similarly<a contenteditable="false" data-primary="iterators" data-type="indexterm" id="idm44924490978400"/> to short-circuiting in Boolean expressions, you can short-circuit the evaluation of values in an iterator. Python’s built-in functions <span class="code">all</span>, <span class="code">any</span>, and <span class="code">next</span> return after finding the first item in the iterator that meets the given condition, without generating further values:</p>
<pre data-code-language="python" data-type="programlisting">
<code class="nb">any</code><code class="p">(</code><code class="n">x</code><code class="o">*</code><code class="o">*</code><code class="mi">2</code><code> </code><code class="o">&gt;</code><code> </code><code class="mi">100</code><code> </code><strong><code class="k">for</code></strong><code> </code><code class="n">x</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="nb">range</code><code class="p">(</code><code class="mi">50</code><code class="p">)</code><code class="p">)</code><code> </code><code>
</code><em><code class="c1"># returns</code></em><code class="c1"> </code><em><code class="c1">True</code></em><code class="c1"> </code><em><code class="c1">once it reaches 10, skips the rest</code></em><code>
</code><code>
</code><code class="n">odd_numbers_greater_than_1</code><code> </code><code class="o">=</code><code> </code><code class="nb">range</code><code class="p">(</code><code class="mi">3</code><code class="p">,</code><code> </code><code class="mi">100</code><code class="p">,</code><code> </code><code class="mi">2</code><code class="p">)</code><code>
</code><code class="nb">all</code><code class="p">(</code><code class="n">is_prime</code><code class="p">(</code><code class="n">x</code><code class="p">)</code><code> </code><strong><code class="k">for</code></strong><code> </code><code class="n">x</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">odd_numbers_greater_than_1</code><code class="p">)</code><code> </code><code>
</code><em><code class="c1"># returns</code></em><code class="c1"> </code><em><code class="c1">False</code></em><em><code class="c1">: 3, 5, and 7 are prime but 9 is not</code></em><code>
</code><code>
</code><code class="nb">next</code><code class="p">(</code><code class="n">c</code><code> </code><strong><code class="k">for</code></strong><code> </code><code class="n">c</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">string</code><code class="o">.</code><code class="n">ascii_uppercase</code><code> </code><strong><code class="k">if</code></strong><code> </code><code class="n">c</code><code> </code><code class="ow">in</code><code> </code><code class="s2">"</code><code class="s2">AEIOU</code><code class="s2">"</code><code class="p">)</code><code>
</code><em><code class="c1"># returns 'A' without checking the remaining characters</code></em></pre>
<p>Your code gains an added advantage when the iterator is specifically a generator, as shown in all three of these cases. When the sequence of items is expensive to produce (as might be the case with records fetched from a database, for example), retrieving those items with a generator and short-circuiting to retrieve only the minimum needed can provide significant performance benefits.</p>
</div></section>
<section data-pdf-bookmark="Optimizing loops" data-type="sect3"><div class="sect3" id="optimizing_loops">
<h3>Optimizing loops</h3>
<p>Most<a contenteditable="false" data-primary="loops" data-secondary="optimizing" data-type="indexterm" id="loopcon17"/> of your program’s bottlenecks will be in loops, particularly nested loops, because loop bodies execute repeatedly. Python does not implicitly perform any<a contenteditable="false" data-primary="code hosting" data-type="indexterm" id="idm44924490897600"/> <em>code hoisting</em>: if you have any code inside a loop that you could execute just once by hoisting it out of the loop, and the loop is a bottleneck, hoist the code out yourself. Sometimes the presence of code to hoist may not be immediately obvious:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="k">def</code></strong><code> </code><code class="nf">slower</code><code class="p">(</code><code class="n">anobject</code><code class="p">,</code><code> </code><code class="n">ahugenumber</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><strong><code class="k">for</code></strong><code> </code><code class="n">i</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="nb">range</code><code class="p">(</code><code class="n">ahugenumber</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="n">anobject</code><code class="o">.</code><code class="n">amethod</code><code class="p">(</code><code class="n">i</code><code class="p">)</code><code>
</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">faster</code><code class="p">(</code><code class="n">anobject</code><code class="p">,</code><code> </code><code class="n">ahugenumber</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">themethod</code><code> </code><code class="o">=</code><code> </code><code class="n">anobject</code><code class="o">.</code><code class="n">amethod</code><code>
</code><code>    </code><strong><code class="k">for</code></strong><code> </code><code class="n">i</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="nb">range</code><code class="p">(</code><code class="n">ahugenumber</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="n">themethod</code><code class="p">(</code><code class="n">i</code><code class="p">)</code></pre>
<p class="pagebreak-before">In this case, the code that <span class="code">faster</span> hoists out of the loop is the attribute lookup <span class="code">anobject.amethod</span>. <span class="code">slower</span> repeats the lookup every time, while <span class="code">faster</span> performs it just once. The two functions are not 100% equivalent: it is (barely) conceivable that executing <span class="code">amethod</span> might cause such changes on <span class="code">anobject</span> that the next lookup for the same named attribute fetches a different method object. This is part of why Python doesn’t perform such optimizations itself. In practice, such subtle, obscure, and tricky cases happen very rarely; it’s almost invariably safe to perform such optimizations yourself, to squeeze the last drop of performance out of some bottleneck.</p>
<p>Python is faster with local variables than with global ones. If a loop repeatedly accesses a global whose value does not change between iterations, you can “cache” the value in a local variable, and access that instead. This also applies to built-ins:</p>
<pre data-code-language="python" data-type="programlisting">
<strong><code class="k">def</code></strong><code> </code><code class="nf">slightly_slower</code><code class="p">(</code><code class="n">asequence</code><code class="p">,</code><code> </code><code class="n">adict</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><strong><code class="k">for</code></strong><code> </code><code class="n">x</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">asequence</code><code class="p">:</code><code>
</code><code>        </code><code class="n">adict</code><code class="p">[</code><code class="n">x</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="nb">hex</code><code class="p">(</code><code class="n">x</code><code class="p">)</code><code>
</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">slightly_faster</code><code class="p">(</code><code class="n">asequence</code><code class="p">,</code><code> </code><code class="n">adict</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">myhex</code><code> </code><code class="o">=</code><code> </code><code class="nb">hex</code><code>
</code><code>    </code><strong><code class="k">for</code></strong><code> </code><code class="n">x</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">asequence</code><code class="p">:</code><code>
</code><code>        </code><code class="n">adict</code><code class="p">[</code><code class="n">x</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">myhex</code><code class="p">(</code><code class="n">x</code><code class="p">)</code></pre>
<p>Here, the speedup is very modest.</p>
<p>Do not cache <span class="code"><strong>None</strong></span>, <span class="code"><strong>True</strong></span>, or <span class="code"><strong>False</strong></span>. Those constants are keywords: no further optimization is needed.</p>
<p>List comprehensions and generator expressions can be faster than loops, and, sometimes, so can <span class="code">map</span> and <span class="code">filter</span>. For optimization purposes, try changing loops into list comprehensions, generator expressions, or perhaps <span class="code">map</span> and <span class="code">filter</span> calls, where feasible. The performance advantage of <span class="code">map</span> and <span class="code">filter</span> is nullified, and worse, if you have to use a <span class="code"><strong>lambda</strong></span> or an extra level of function call. Only when the argument to <span class="code">map</span> or <span class="code">filter</span> is a built-in function, or a function you’d have to call anyway even from an explicit loop, list comprehension, or generator expression, do you stand to gain some tiny speedup.</p>
<p>The loops that you can replace most naturally with list comprehensions, or <span class="code">map</span> and <span class="code">filter</span> calls, are ones that build up a list by repeatedly calling <span class="code">append</span> on the list. The following example shows this optimization in a microperformance benchmark script (the example includes a call to the the <span class="code">timeit</span> convenience function <span class="code">repeat</span>, which simply calls <span class="code">timeit.timeit</span> the specified number of times):</p>
<pre class="pagebreak-before" data-code-language="python" data-type="programlisting">
<strong><code class="kn">import</code></strong><code> </code><code class="nn">timeit</code><strong><code class="o">,</code></strong><code> </code><code class="nn">operator</code><code>
</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">slow</code><code class="p">(</code><code class="n">asequence</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">result</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code class="p">]</code><code>
</code><code>    </code><strong><code class="k">for</code></strong><code> </code><code class="n">x</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">asequence</code><code class="p">:</code><code>
</code><code>        </code><code class="n">result</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="o">-</code><code class="n">x</code><code class="p">)</code><code>
</code><code>    </code><strong><code class="k">return</code></strong><code> </code><code class="n">result</code><code>
</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">middling</code><code class="p">(</code><code class="n">asequence</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><strong><code class="k">return</code></strong><code> </code><code class="nb">list</code><code class="p">(</code><code class="nb">map</code><code class="p">(</code><code class="n">operator</code><code class="o">.</code><code class="n">neg</code><code class="p">,</code><code> </code><code class="n">asequence</code><code class="p">)</code><code class="p">)</code><code>
</code><code>
</code><strong><code class="k">def</code></strong><code> </code><code class="nf">fast</code><code class="p">(</code><code class="n">asequence</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><strong><code class="k">return</code></strong><code> </code><code class="p">[</code><code class="o">-</code><code class="n">x</code><code> </code><strong><code class="k">for</code></strong><code> </code><code class="n">x</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">asequence</code><code class="p">]</code><code>
</code><code>
</code><strong><code class="k">for</code></strong><code> </code><code class="n">afunc</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">slow</code><code class="p">,</code><code> </code><code class="n">middling</code><code class="p">,</code><code> </code><code class="n">fast</code><code class="p">:</code><code>
</code><code>    </code><code class="n">timing</code><code> </code><code class="o">=</code><code> </code><code class="n">timeit</code><code class="o">.</code><code class="n">repeat</code><code class="p">(</code><code class="s1">'</code><code class="s1">afunc(big_seq)</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>                           </code><code class="n">setup</code><code class="o">=</code><code class="s1">'</code><code class="s1">big_seq=range(500*1000)</code><code class="s1">'</code><code class="p">,</code><code>
</code><code>                           </code><code class="nb">globals</code><code class="o">=</code><code class="p">{</code><code class="s1">'</code><code class="s1">afunc</code><code class="s1">'</code><code class="p">:</code><code> </code><code class="n">afunc</code><code class="p">}</code><code class="p">,</code><code>
</code><code>                           </code><code class="n">repeat</code><code class="o">=</code><code class="mi">5</code><code class="p">,</code><code>
</code><code>                           </code><code class="n">number</code><code class="o">=</code><code class="mi">100</code><code class="p">)</code><code>
</code><code>    </code><strong><code class="k">for</code></strong><code> </code><code class="n">t</code><code> </code><strong><code class="ow">in</code></strong><code> </code><code class="n">timing</code><code class="p">:</code><code>
</code><code>        </code><code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s1">'</code><code class="si">{</code><code class="n">afunc</code><code class="o">.</code><code class="vm">__name__</code><code class="si">}</code><code class="s1">,</code><code class="si">{</code><code class="n">t</code><code class="si">}</code><code class="s1">'</code><code class="p">)</code></pre>
<p>As we reported in the previous edition of this book (using a different set of test parameters):</p>
<blockquote>
<p>Running this example in v2 on an old laptop shows that <span class="code">fast</span> takes about 0.36 seconds, <span class="code">middling</span> 0.43 seconds, and <span class="code">slow</span> 0.77 seconds. In other words, on that machine, <span class="code">slow</span> (the loop of <span class="code">append</span> method calls) is about 80 percent slower than <span class="code">middling</span> (the single <span class="code">map</span> call), and <span class="code">middling</span>, in turn, is about 20 percent slower than <span class="code">fast</span> (the list comprehension).</p>
<p>The list comprehension is the most direct way to express the task being microbenchmarked in this example, so, not surprisingly, it’s also fastest—about two times faster than the loop of <span class="code">append</span> method calls.</p>
</blockquote>
<p>At that time, using Python 2.7, there was a clear advantage to using the <span class="code">middling</span> function over <span class="code">slow</span>, and a modest speed increase resulted from using the <span class="code">fast</span> function over <span class="code">middling</span>. For the versions covered in this edition, the improvement of <span class="code">fast</span> over <span class="code">middling</span> is much less, if any. Of greater interest is that the <span class="code">slow</span> function is now starting to approach the performance of the optimized functions. Also, it is easy to see the progressive performance improvements in successive versions of Python, especially Python 3.11 (see <a data-type="xref" href="#performance_of_the_example_on_various_p">Figure 17-3</a>).</p>
<p>The clear lesson is that performance tuning and optimization measures should be revisited when upgrading to newer Python versions.<a contenteditable="false" data-primary="" data-startref="loopcon17" data-type="indexterm" id="idm44924490460400"/></p>
<figure><div class="figure" id="performance_of_the_example_on_various_p"><em><img alt="Performance of the example on various Python versions" height="427" src="assets/pns4_1703.png" width="600"/> </em>
<h6><span class="label">Figure 17-3. </span><em>Performance of the example on various Python versions</em></h6>
<em> </em></div></figure>
</div></section>
<section data-pdf-bookmark="Using multiprocessing for heavy CPU work" data-type="sect3"><div class="sect3" id="using_multiprocessing_for_heavy_cpu_wor">
<h3>Using multiprocessing for heavy CPU work</h3>
<p>If<a contenteditable="false" data-primary="CPU-bound programs" data-type="indexterm" id="idm44924490455552"/><a contenteditable="false" data-primary="threads and processes" data-secondary="using for optimization" data-type="indexterm" id="idm44924490454512"/> you have heavily CPU-bound processing that can be done in independent pieces, then one important way to optimize is to use multiprocessing, as described in <a data-type="xref" href="ch15.xhtml#concurrency_threads_and_processes">Chapter 15</a>. You should also consider whether using one of the numeric packages described in <a data-type="xref" href="ch16.xhtml#numeric_processing">Chapter 16</a>, capable of applying vector processing to large data sets, is applicable.</p>
</div></section>
<section data-pdf-bookmark="Optimizing I/O" data-type="sect3"><div class="sect3" id="optimizing_isoliduso">
<h3>Optimizing I/O</h3>
<p>If<a contenteditable="false" data-primary="I/O-bound programs" data-type="indexterm" id="idm44924490448944"/><a contenteditable="false" data-primary="programs" data-secondary="I/O-bound programs" data-type="indexterm" id="idm44924490447808"/> your program does substantial amounts of I/O, it’s quite likely that performance bottlenecks are due to I/O, rather than to computation. Such programs are said to be I/O-bound, rather than CPU-bound. Your operating system tries to optimize I/O performance, but you can help it in a couple of ways.</p>
<p>From the point of view of a program’s convenience and simplicity, the ideal amount of data to read or write at a time is often small (one character or one line) or very large (an entire file at a time). That’s often fine: Python and your operating system work behind the scenes to let your program use convenient logical chunks for I/O, while arranging for physical I/O operations to use chunk sizes more attuned to performance. Reading and writing a whole file at a time is quite likely to be OK for performance as long as the file is not <em>very</em> large. Specifically, file-at-a-time I/O is fine as long as the file’s data fits very comfortably in physical RAM, leaving ample memory available for your program and operating system to perform whatever other tasks they’re doing at the same time. The hard problems of I/O-bound performance come with huge files.</p>
<p>If performance is an issue, <em>never</em> use a file’s <span class="code">readline</span> method, which is limited in the amount of chunking and buffering it can perform. (Using <span class="code">writelines</span>, on the other hand, causes no performance problems when that method is convenient for your program.) When reading a text file, loop directly on the file object to get one line at a time with best performance. If the file isn’t too huge, and so can conveniently fit in memory, time two versions of your program: one looping directly on the file object, the other reading the whole file into memory. Either may prove faster by a little.</p>
<p>For binary files, particularly large binary files whose contents you need just a part of on each given run of your program, the module <span class="code">mmap</span> (covered in <a data-type="xref" href="ch15.xhtml#the_mmap_module">“The mmap Module”</a>) can sometimes help keep your program simple and boost performance.</p>
<p>Making an I/O-bound program multithreaded sometimes affords substantial performance gains, if you can arrange your architecture accordingly. Start a few worker threads devoted to I/O, have the computational threads request I/O operations from the I/O threads via <span class="code">Queue</span> instances, and post the request for each input operation as soon as you know you’ll eventually need that data. Performance increases only if there are other tasks your computational threads can perform while I/O threads are blocked waiting for data. You get better performance this way only if you can manage to overlap computation and waiting for data by having different threads do the computing and the waiting. (See <a data-type="xref" href="ch15.xhtml#threads_in_python">“Threads in Python”</a> for detailed coverage of Python threading and a suggested architecture.)</p>
<p>On the other hand, a possibly even faster and more scalable approach is to eschew threads in favor of asynchronous (event-driven) architectures, as mentioned in <a data-type="xref" href="ch15.xhtml#concurrency_threads_and_processes">Chapter 15</a>.</p>
</div></section>
</div></section>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="ch01fn125"><sup><a href="ch17.xhtml#ch01fn125-marker">1</a></sup> This issue is related to “technical debt” and other topics covered in the <a href="https://oreil.ly/LcncX">“‘Good enough’ is good enough”</a> tech talk by one of this book’s authors (that author’s favorite tech talk out of the many he delivered!), excellently summarized and discussed by Martin Michlmayr on <a href="https://oreil.ly/2REWD">LWN.net</a>.</p><p data-type="footnote" id="ch01fn126"><sup><a href="ch17.xhtml#ch01fn126-marker">2</a></sup> The language used in this area is confused and confusing: terms like <em>dummies</em>, <em>fakes</em>, <em>spies</em>, <em>mocks</em>, <em>stubs</em>, and <em>test doubles</em> are utilized by different people to mean slightly different things. For an authoritative approach to terminology and concepts (though not the exact one we use), see the essay <a href="https://oreil.ly/QaPs6">“Mocks Aren’t Stubs”</a> by Martin Fowler.</p><p data-type="footnote" id="ch01fn127"><sup><a href="ch17.xhtml#ch01fn127-marker">3</a></sup> That’s partly because the structure of the system tends to mirror the structure of the organization, per <a href="https://oreil.ly/7usV4">Conway’s law</a>.</p><p data-type="footnote" id="ch01fn128"><sup><a href="ch17.xhtml#ch01fn128-marker">4</a></sup> However, be sure you know exactly what you’re using <span class="code">doctest</span> for in any given case: to quote Peter Norvig, writing precisely on this subject: “Know what you’re aiming for; if you aim at two targets at once you usually miss them both.”</p><p data-type="footnote" id="ch01fn129"><sup><a href="ch17.xhtml#ch01fn129-marker">5</a></sup> When evaluating <span class="code">assert</span> <span class="code"><em>a</em></span> <span class="code">==</span> <span class="code"><em>b</em></span>, <span class="code">pytest</span> interprets <span class="code"><em>a</em></span> as the observed value and <span class="code"><em>b</em></span> as the expected value (the reverse of <span class="code">unittest</span>).</p><p data-type="footnote" id="ch01fn130"><sup><a href="ch17.xhtml#ch01fn130-marker">6</a></sup> “Oh, but I’ll only be running this code for a short time!” is <em>not</em> an excuse to get sloppy: the Russian proverb “nothing is more permanent than a temporary solution” is particularly applicable in software. All over the world, plenty of “temporary” code performing crucial tasks is over 50 years old.</p><p data-type="footnote" id="ch01fn131"><sup><a href="ch17.xhtml#ch01fn131-marker">7</a></sup> A typical case of the <a href="https://oreil.ly/iJVCX">Pareto principle</a> in action.</p><p data-type="footnote" id="ch01fn132"><sup><a href="ch17.xhtml#ch01fn132-marker">8</a></sup> Per <a href="https://oreil.ly/e6PEg">Amdahl’s law</a>.</p><p data-type="footnote" id="ch01fn133"><sup><a href="ch17.xhtml#ch01fn133-marker">9</a></sup> Using the invented-for-Python <a href="https://oreil.ly/BjZoM">adaptive sorting</a> algorithm <a href="https://oreil.ly/cFW7U">Timsort</a>.</p><p data-type="footnote" id="ch01fn134"><sup><a href="ch17.xhtml#ch01fn134-marker">10</a></sup> A once-slower idiom may be optimized in some future version of Python, so it’s worth redoing <span class="code">timeit</span> measurements to check for this when you upgrade to newer versions of Python.</p><p data-type="footnote" id="ch01fn135"><sup><a href="ch17.xhtml#ch01fn135-marker">11</a></sup> Even though current Python implementations bend over backward to help reduce the performance hit of this specific, terrible, but common anti-pattern, they can’t catch every occurrence, so don’t count on that!</p></div></div></section></div></body></html>