<html><head></head><body>
<div id="sbo-rt-content"><section data-pdf-bookmark="Chapter 4. What Are We Doing with All These Tests? (And, Refactoring)" data-type="chapter" epub:type="chapter"><div class="chapter" id="chapter_philosophy_and_refactoring">
<h1><span class="label">Chapter 4. </span>What Are We Doing with All These Tests? (And, Refactoring)</h1>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id258">
<h1>A Note for Early Release Readers</h1>
<p>With Early Release ebooks, you get books in their earliest form—the author’s raw and unedited content as they write—so you can take advantage of these technologies long before the official release of these titles.</p>
<p>This will be the 4th chapter of the final book. The GitHub repo is available at <a class="bare" href="https://github.com/hjwp/book-example"><em class="hyperlink">https://github.com/hjwp/book-example</em></a>.</p>
<p>If you have comments about how we might improve the content and/or examples in this book, or if you notice missing material within this chapter, please reach out to the author at <a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a>.</p>
</div></aside>
<p><a data-primary="Test-Driven Development (TDD)" data-secondary="need for" data-type="indexterm" id="TDDneed04"/>
Now that we’ve seen the basics of TDD in action,
it’s time to pause and talk about why we’re doing it.</p>
<p>I’m imagining several of you, dear readers, have been holding back
some seething frustration—​perhaps some of you have done a bit of unit testing before,
and perhaps some of you are just in a hurry.
You’ve been biting back questions like:</p>
<ul>
<li>
<p>Aren’t all these tests a bit excessive?</p>
</li>
<li>
<p>Surely some of them are redundant?
There’s duplication between the functional tests and the unit tests.</p>
</li>
<li>
<p>Those unit tests seemed way too trivial—​testing
a one-line function that returns a constant!
Isn’t that just a waste of time?
Shouldn’t we save our tests for more complex things?</p>
</li>
<li>
<p>What about all those tiny changes during the unit-test/code cycle?
Couldn’t we just skip to the end? I mean, <code>home_page = None</code>!?  Really?</p>
</li>
<li>
<p>You’re not telling me you <em>actually</em> code like this in real life?</p>
</li>
</ul>
<p>Ah, young grasshopper. I too was once full of questions like these.
But only because they’re perfectly good questions.
In fact, I still ask myself questions like these, all the time.
Does all this stuff really have value? Is this a bit of a cargo cult?</p>
<section data-pdf-bookmark="Programming Is Like Pulling a Bucket of Water Up &#10;from a Well" data-type="sect1"><div class="sect1" id="id23">
<h1>Programming Is Like Pulling a Bucket of Water Up 
<span class="keep-together">from a Well</span></h1>
<p><a data-primary="Test-Driven Development (TDD)" data-secondary="philosophy of" data-tertiary="bucket of water analogy" data-type="indexterm" id="id259"/>
Ultimately, programming is hard.  Often, we are smart, so we succeed.
TDD is there to help us out when we’re not so smart.
Kent Beck (who basically invented TDD) uses the metaphor
of lifting a bucket of water out of a well with a rope:
when the well isn’t too deep, and the bucket isn’t very full, it’s easy.
And even lifting a full bucket is pretty easy at first.
But after a while, you’re going to get tired.
TDD is like having a ratchet that lets you save your progress,
so you can take a break, and make sure you never slip backwards.</p>
<p>That way you don’t have to be smart <em>all</em> the time.</p>
<figure><div class="figure" id="figure4-1">
<img alt="Test ALL the things" height="181" src="assets/twp2_0401.png" width="250"/>
<h6><span class="label">Figure 4-1. </span>Test ALL the things (original illustration source: <a href="http://bit.ly/1iXxdYp">Allie Brosh, Hyperbole and a Half</a>)</h6>
</div></figure>
<p>OK, perhaps <em>in general</em>, you’re prepared to concede that TDD is a good
idea, but maybe you still think I’m overdoing it?  Testing the tiniest thing,
and taking ridiculously many small steps?</p>
<p>TDD is a <em>discipline</em>, and that means it’s not something that comes naturally;
because many of the payoffs aren’t immediate but only come in the longer term,
you have to force yourself to do it in the moment.
That’s what the image of the Testing Goat is supposed to represent—​you
need to be a bit bloody-minded about it.</p>
<aside class="pagebreak-before less_space" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id260">
<h1>On the Merits of Trivial Tests for Trivial Functions</h1>
<p>In the short term it may feel a bit silly to write tests for simple
functions and 
<span class="keep-together">constants</span>.</p>
<p>It’s perfectly possible to imagine still doing “mostly” TDD,
but following more relaxed rules where you don’t unit test <em>absolutely</em> everything.
But in this book my aim is to demonstrate full, rigorous TDD.
Like a kata in a martial art,
the idea is to learn the motions in a controlled context,
when there is no adversity,
so that the techniques are part of your muscle memory.
It seems trivial now, because we’ve started with a very simple example.
The problem comes when your application gets complex—​that’s when you really need your tests.
And the danger is that complexity tends to sneak up on you, gradually.
You may not notice it happening, but soon you’re a boiled frog.</p>
<p>There are two other things to say in favour of tiny, simple tests for simple functions.</p>
<p>Firstly, if they’re really trivial tests,
then they won’t take you that long to write them.
So stop moaning and just write them already.</p>
<p>Secondly, it’s always good to have a placeholder.
Having a test <em>there</em> for a simple function
means it’s that much less of a psychological barrier to overcome
when the simple function gets a tiny bit more complex—​perhaps
it grows an <code>if</code>.
Then a few weeks later it grows a <code>for</code> loop.
Before you know it, it’s a recursive metaclass-based polymorphic tree parser factory.
But because it’s had tests from the very beginning,
adding a new test each time has felt quite natural,
and it’s well tested.
The alternative involves trying to decide when a function becomes “complicated enough”,
which is highly subjective;
but worse, because there’s no placeholder
it feels like that much more effort to start,
and you’re tempted each time to put it off…​
Pretty soon—​frog soup!</p>
<p>Instead of trying to figure out some hand-wavy subjective rules
for when you should write tests,
and when you can get away with not bothering,
I suggest following the discipline for now—​as with any discipline,
you have to take the time to learn the rules before you can break them.</p>
</div></aside>
<p>Now, let us return to our muttons.
<a data-primary="" data-startref="TDDneed04" data-type="indexterm" id="id261"/></p>
</div></section>
<section class="pagebreak-before less_space" data-pdf-bookmark="Using Selenium to Test User Interactions" data-type="sect1"><div class="sect1" id="id24">
<h1>Using Selenium to Test User Interactions</h1>
<p><a data-primary="Selenium" data-secondary="testing user interactions with" data-type="indexterm" id="Suser04"/>
<a data-primary="user interactions" data-secondary="testing with Selenium" data-type="indexterm" id="UIselenium04"/>
Where were we at the end of the last chapter?
Let’s rerun the test and find out:</p>
<pre data-type="programlisting">$ <strong>python functional_tests.py</strong>
F
======================================================================
FAIL: test_can_start_a_todo_list
(__main__.NewVisitorTest.test_can_start_a_todo_list)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...goat-book/functional_tests.py", line 21, in
test_can_start_a_todo_list
    self.fail("Finish the test!")
AssertionError: Finish the test!

 ---------------------------------------------------------------------
Ran 1 test in 1.609s

FAILED (failures=1)</pre>
<p>Did you try it, and get an error saying <em>Problem loading page</em> or
<em>Unable to connect</em>?  So did I. It’s because we forgot to spin up the dev
server first using <code>manage.py runserver</code>.  Do that, and you’ll get the failure
message we’re after.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>One of the great things about TDD is that you never have to worry
    about forgetting what to do next—​just rerun your tests
    and they will tell you what you need to work on.</p>
</div>
<p>“Finish the test”, it says, so let’s do just that!  Open up
<em>functional_tests.py</em> and we’ll extend our FT:</p>
<div class="sourcecode" data-type="example">
<p>functional_tests.py (ch04l001)</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code><code> </code><code class="nn">selenium</code><code> </code><code class="kn">import</code><code> </code><code class="n">webdriver</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">selenium</code><code class="nn">.</code><code class="nn">webdriver</code><code class="nn">.</code><code class="nn">common</code><code class="nn">.</code><code class="nn">by</code><code> </code><code class="kn">import</code><code> </code><code class="n">By</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">selenium</code><code class="nn">.</code><code class="nn">webdriver</code><code class="nn">.</code><code class="nn">common</code><code class="nn">.</code><code class="nn">keys</code><code> </code><code class="kn">import</code><code> </code><code class="n">Keys</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">time</code><code>
</code><code class="kn">import</code><code> </code><code class="nn">unittest</code><code>
</code><code>
</code><code>
</code><code class="k">class</code><code> </code><code class="nc">NewVisitorTest</code><code class="p">(</code><code class="n">unittest</code><code class="o">.</code><code class="n">TestCase</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">setUp</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code> </code><code class="o">=</code><code> </code><code class="n">webdriver</code><code class="o">.</code><code class="n">Firefox</code><code class="p">(</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">tearDown</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code class="o">.</code><code class="n">quit</code><code class="p">(</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">test_can_start_a_todo_list</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="c1"># Edith has heard about a cool new online to-do app.</code><code>
</code><code>        </code><code class="c1"># She goes to check out its homepage</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"</code><code class="s2">http://localhost:8000</code><code class="s2">"</code><code class="p">)</code><code>
</code><code>
</code><code>        </code><code class="c1"># She notices the page title and header mention to-do lists</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">assertIn</code><code class="p">(</code><code class="s2">"</code><code class="s2">To-Do</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code class="o">.</code><code class="n">title</code><code class="p">)</code><code>
</code><code>        </code><code class="n">header_text</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code class="o">.</code><code class="n">find_element</code><code class="p">(</code><code class="n">By</code><code class="o">.</code><code class="n">TAG_NAME</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">h1</code><code class="s2">"</code><code class="p">)</code><code class="o">.</code><code class="n">text</code><code>  </code><a class="co" href="#callout_what_are_we_doing_with_all_these_tests___and__refactoring__CO1-1" id="co_what_are_we_doing_with_all_these_tests___and__refactoring__CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">assertIn</code><code class="p">(</code><code class="s2">"</code><code class="s2">To-Do</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">header_text</code><code class="p">)</code><code>
</code><code>
</code><code>        </code><code class="c1"># She is invited to enter a to-do item straight away</code><code>
</code><code>        </code><code class="n">inputbox</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code class="o">.</code><code class="n">find_element</code><code class="p">(</code><code class="n">By</code><code class="o">.</code><code class="n">ID</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">id_new_item</code><code class="s2">"</code><code class="p">)</code><code>  </code><a class="co" href="#callout_what_are_we_doing_with_all_these_tests___and__refactoring__CO1-1" id="co_what_are_we_doing_with_all_these_tests___and__refactoring__CO1-2"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">assertEqual</code><code class="p">(</code><code class="n">inputbox</code><code class="o">.</code><code class="n">get_attribute</code><code class="p">(</code><code class="s2">"</code><code class="s2">placeholder</code><code class="s2">"</code><code class="p">)</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">Enter a to-do item</code><code class="s2">"</code><code class="p">)</code><code>
</code><code>
</code><code>        </code><code class="c1"># She types "Buy peacock feathers" into a text box</code><code>
</code><code>        </code><code class="c1"># (Edith's hobby is tying fly-fishing lures)</code><code>
</code><code>        </code><code class="n">inputbox</code><code class="o">.</code><code class="n">send_keys</code><code class="p">(</code><code class="s2">"</code><code class="s2">Buy peacock feathers</code><code class="s2">"</code><code class="p">)</code><code>  </code><a class="co" href="#callout_what_are_we_doing_with_all_these_tests___and__refactoring__CO1-2" id="co_what_are_we_doing_with_all_these_tests___and__refactoring__CO1-3"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
</code><code>
</code><code>        </code><code class="c1"># When she hits enter, the page updates, and now the page lists</code><code>
</code><code>        </code><code class="c1"># "1: Buy peacock feathers" as an item in a to-do list table</code><code>
</code><code>        </code><code class="n">inputbox</code><code class="o">.</code><code class="n">send_keys</code><code class="p">(</code><code class="n">Keys</code><code class="o">.</code><code class="n">ENTER</code><code class="p">)</code><code>  </code><a class="co" href="#callout_what_are_we_doing_with_all_these_tests___and__refactoring__CO1-3" id="co_what_are_we_doing_with_all_these_tests___and__refactoring__CO1-4"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code>
</code><code>        </code><code class="n">time</code><code class="o">.</code><code class="n">sleep</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code>  </code><a class="co" href="#callout_what_are_we_doing_with_all_these_tests___and__refactoring__CO1-4" id="co_what_are_we_doing_with_all_these_tests___and__refactoring__CO1-5"><img alt="4" height="12" src="assets/4.png" width="12"/></a><code>
</code><code>
</code><code>        </code><code class="n">table</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">browser</code><code class="o">.</code><code class="n">find_element</code><code class="p">(</code><code class="n">By</code><code class="o">.</code><code class="n">ID</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">id_list_table</code><code class="s2">"</code><code class="p">)</code><code>
</code><code>        </code><code class="n">rows</code><code> </code><code class="o">=</code><code> </code><code class="n">table</code><code class="o">.</code><code class="n">find_elements</code><code class="p">(</code><code class="n">By</code><code class="o">.</code><code class="n">TAG_NAME</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">tr</code><code class="s2">"</code><code class="p">)</code><code>  </code><a class="co" href="#callout_what_are_we_doing_with_all_these_tests___and__refactoring__CO1-1" id="co_what_are_we_doing_with_all_these_tests___and__refactoring__CO1-6"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">assertTrue</code><code class="p">(</code><code class="nb">any</code><code class="p">(</code><code class="n">row</code><code class="o">.</code><code class="n">text</code><code> </code><code class="o">==</code><code> </code><code class="s2">"</code><code class="s2">1: Buy peacock feathers</code><code class="s2">"</code><code> </code><code class="k">for</code><code> </code><code class="n">row</code><code> </code><code class="ow">in</code><code> </code><code class="n">rows</code><code class="p">)</code><code class="p">)</code><code>
</code><code>
</code><code>        </code><code class="c1"># There is still a text box inviting her to add another item.</code><code>
</code><code>        </code><code class="c1"># She enters "Use peacock feathers to make a fly"</code><code>
</code><code>        </code><code class="c1"># (Edith is very methodical)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">fail</code><code class="p">(</code><code class="s2">"</code><code class="s2">Finish the test!</code><code class="s2">"</code><code class="p">)</code><code>
</code><code>
</code><code>        </code><code class="c1"># The page updates again, and now shows both items on her list</code><code>
</code><code>        </code><code class="p">[</code><code class="o">.</code><code class="o">.</code><code class="o">.</code><code class="p">]</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" href="#co_what_are_we_doing_with_all_these_tests___and__refactoring__CO1-1" id="callout_what_are_we_doing_with_all_these_tests___and__refactoring__CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>We’re using the two methods that Selenium provides to examine web pages:
<code>find_element</code> and <code>find_elements</code>
(notice the extra <code>s</code>,
which means it will return several elements rather than just one).
Each one is parameterized with a <code>By.SOMETHING</code>
which lets us search using different HTML properties and attributes.</p></dd>
<dt><a class="co" href="#co_what_are_we_doing_with_all_these_tests___and__refactoring__CO1-3" id="callout_what_are_we_doing_with_all_these_tests___and__refactoring__CO1-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>We also use <code>send_keys</code>,
which is Selenium’s way of typing into input elements.</p></dd>
<dt><a class="co" href="#co_what_are_we_doing_with_all_these_tests___and__refactoring__CO1-4" id="callout_what_are_we_doing_with_all_these_tests___and__refactoring__CO1-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>The <code>Keys</code> class (don’t forget to import it)
lets us send special keys like Enter.<sup><a data-type="noteref" href="ch04.xhtml#id262" id="id262-marker">1</a></sup></p></dd>
<dt><a class="co" href="#co_what_are_we_doing_with_all_these_tests___and__refactoring__CO1-5" id="callout_what_are_we_doing_with_all_these_tests___and__refactoring__CO1-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>When we hit Enter, the page will refresh.
The <code>time.sleep</code> is there to make sure the browser has finished loading
before we make any assertions about the new page.
This is called an “explicit wait”
(a very simple one; we’ll improve it in <a data-type="xref" href="ch06.xhtml#chapter_explicit_waits_1">Chapter 6</a>).</p></dd>
</dl>
<div data-type="tip"><h6>Tip</h6>
<p>Watch out for the difference between the Selenium <code>find_element()</code>
    and <code>find_elements()</code> functions.
    One returns an element and raises an exception if it can’t find it,
    whereas the other returns a list, which may be empty.</p>
</div>
<p>Also, just look at that <code>any()</code> function.
It’s a little-known Python built-in.
I don’t even need to explain it, do I?
Python is such a joy.<sup><a data-type="noteref" href="ch04.xhtml#id263" id="id263-marker">2</a></sup></p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>If you’re one of my readers who doesn’t know Python,
    what’s happening <em>inside</em> the <code>any()</code> may need some explaining.
    The basic syntax is that of a <em>list comprehension</em>,
    and if you haven’t learned about them, you should do so immediately!
    <a href="https://www.pythonmorsels.com/what-are-list-comprehensions/">Trey Hunner’s explanation is excellent.</a>
    In point of fact, because we’re omitting the square brackets,
    we’re actually using a <em>generator expression</em> rather than a list comprehension.
    It’s probably less important to understand the difference between those two,
    but if you’re curious, check out this
     <a href="http://python-history.blogspot.com/2010/06/from-list-comprehensions-to-generator.xhtml">blog post by Guido himself</a>
    explaining the difference.
    <a data-primary="generator expressions" data-type="indexterm" id="id264"/>
<a data-primary="list comprehensions" data-type="indexterm" id="id265"/></p>
</div>
<p>Let’s see how it gets on:</p>
<pre data-type="programlisting">$ <strong>python functional_tests.py</strong>
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: h1</pre>
<p>Decoding that,
the test is saying it can’t find an <code>&lt;h1&gt;</code> element on the page.
Let’s see what we can do to add that to the HTML of our home page.</p>
<p><a data-primary="" data-startref="Suser04" data-type="indexterm" id="id266"/>
<a data-primary="" data-startref="UIselenium04" data-type="indexterm" id="id267"/>
Big changes to a functional test are usually a good thing to commit on their own.
I failed to do so when I was first working out the code for this chapter,
and I regretted it later when I changed my mind
and had the change mixed up with a bunch of others.
The more atomic your commits, the better:</p>
<pre data-type="programlisting">$ <strong>git diff</strong>  # should show changes to functional_tests.py
$ <strong>git commit -am "Functional test now checks we can input a to-do item"</strong></pre>
</div></section>
<section data-pdf-bookmark="The “Don’t Test Constants” Rule, and Templates to the Rescue" data-type="sect1"><div class="sect1" id="id25">
<h1>The “Don’t Test Constants” Rule, and Templates to the Rescue</h1>
<p><a data-primary="“Don’t Test Constants” rule" data-primary-sortas="Don’t Test Constants rule" data-type="indexterm" id="id268"/>
<a data-primary="unit tests" data-secondary="“Don’t Test Constants” rule" data-secondary-sortas="Don’t Test Constants rule" data-type="indexterm" id="id269"/>
Let’s take a look at our unit tests, <em>lists/tests.py</em>.
Currently we’re looking for specific HTML strings,
but that’s not a particularly efficient way of testing HTML.
In general, one of the rules of unit testing is <em>Don’t test constants</em>,
and testing HTML as text is a lot like testing a constant.</p>
<p>In other words, if you have some code that says:</p>
<pre class="skipme" data-code-language="python" data-type="programlisting"><code class="n">wibble</code> <code class="o">=</code> <code class="mi">3</code></pre>
<p>There’s not much point in a test that says:</p>
<pre class="skipme" data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">myprogram</code> <code class="kn">import</code> <code class="n">wibble</code>
<code class="k">assert</code> <code class="n">wibble</code> <code class="o">==</code> <code class="mi">3</code></pre>
<p>Unit tests are really about testing logic, flow control, and configuration.
Making assertions about exactly what sequence of characters we have in our HTML strings isn’t doing that.</p>
<p>It’s not <em>quite</em> that simple, since HTML is code after all,
and we do want something to check that we’ve written code that works,
but that’s our FT’s job, not the unit tests’.</p>
<p>In any case, mangling raw strings in Python
really isn’t a great way of dealing with HTML.
There’s a much better solution, which is to use templates.
Quite apart from anything else,
if we can keep HTML to one side in a file whose name ends in <em>.xhtml</em>,
we’ll get better syntax highlighting!
There are lots of Python templating frameworks out there,
and Django has its own which works very well.
Let’s use that.</p>
<section data-pdf-bookmark="Refactoring to Use a Template" data-type="sect2"><div class="sect2" id="id26">
<h2>Refactoring to Use a Template</h2>
<p><a data-primary="unit tests" data-secondary="refactoring in" data-type="indexterm" id="UTrefactor04"/>
<a data-primary="refactoring" data-type="indexterm" id="refactor04"/>
What we want to do now is make our view function return exactly the same HTML,
but just using a different process.
That’s a refactor—​when we try to improve the code
<em>without changing its functionality</em>.</p>
<p>That last bit is really important.
If you try to add new functionality at the same time as refactoring,
you’re much more likely to run into trouble.
Refactoring is actually a whole discipline in itself,
and it even has a reference book:
Martin Fowler’s <a href="http://refactoring.com/"><em>Refactoring</em></a>.</p>
<p>The first rule is that you can’t refactor without tests.
Thankfully, we’re doing TDD, so we’re way ahead of the game.
Let’s check that our tests pass;
they will be what makes sure that our refactoring is behaviour-preserving:</p>
<pre data-type="programlisting">$ <strong>python manage.py test</strong>
[...]
OK</pre>
<p>Great! We’ll start by taking our HTML string and putting it into its own file.
Create a directory called <em>lists/templates</em> to keep templates in,
and then open a file at <em>lists/templates/home.xhtml</em>,
to which we’ll transfer our HTML:<sup><a data-type="noteref" href="ch04.xhtml#id270" id="id270-marker">3</a></sup></p>
<div class="sourcecode" data-type="example">
<p>lists/templates/home.xhtml (ch04l002)</p>
<pre data-code-language="html" data-type="programlisting"><code class="p">&lt;</code><code class="nt">html</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">title</code><code class="p">&gt;</code>To-Do lists<code class="p">&lt;/</code><code class="nt">title</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">html</code><code class="p">&gt;</code></pre></div>
<p>Mmmh, syntax-highlighted…​much nicer! Now to change our view function:</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch04l003)</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">django.shortcuts</code> <code class="kn">import</code> <code class="n">render</code>


<code class="k">def</code> <code class="nf">home_page</code><code class="p">(</code><code class="n">request</code><code class="p">):</code>
    <code class="k">return</code> <code class="n">render</code><code class="p">(</code><code class="n">request</code><code class="p">,</code> <code class="s2">"home.xhtml"</code><code class="p">)</code></pre></div>
<p>Instead of building our own <code>HttpResponse</code>, we now use the Django <code>render()</code>
function.  It takes the request as its first parameter (for reasons we’ll go
into later) and the name of the template to render.  Django will automatically
search folders called <em>templates</em> inside any of your apps’ directories.  Then
it builds an <code>HttpResponse</code> for you, based on the content of the template.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Templates are a very powerful feature of Django’s,
    and their main strength consists of substituting Python variables into HTML text.
    We’re not using this feature yet, but we will in future chapters.
    That’s why we use <code>render()</code> rather than, say,
    manually reading the file from disk with the built-in <code>open()</code>.</p>
</div>
<p>Let’s see if it works:</p>
<pre data-type="programlisting">$ <strong>python manage.py test</strong>
[...]
======================================================================
ERROR: test_home_page_returns_correct_html
(lists.tests.HomePageTest.test_home_page_returns_correct_html)  <a class="co" href="#callout_what_are_we_doing_with_all_these_tests___and__refactoring__CO2-2" id="co_what_are_we_doing_with_all_these_tests___and__refactoring__CO2-1"><img alt="2" height="12" src="assets/2.png" width="12"/></a>
----------------------------------------------------------------------
Traceback (most recent call last):
  File "...goat-book/lists/tests.py", line 7, in test_home_page_returns_correct_html
    response = self.client.get("/")  <a class="co" href="#callout_what_are_we_doing_with_all_these_tests___and__refactoring__CO2-3" id="co_what_are_we_doing_with_all_these_tests___and__refactoring__CO2-2"><img alt="3" height="12" src="assets/3.png" width="12"/></a>
               ^^^^^^^^^^^^^^^^^^^^
[...]
  File "...goat-book/lists/views.py", line 4, in home_page
    return render(request, "home.xhtml")  <a class="co" href="#callout_what_are_we_doing_with_all_these_tests___and__refactoring__CO2-4" id="co_what_are_we_doing_with_all_these_tests___and__refactoring__CO2-3"><img alt="4" height="12" src="assets/4.png" width="12"/></a>
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File ".../django/shortcuts.py", line 24, in render
    content = loader.render_to_string(template_name, context, request, using=using)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File ".../django/template/loader.py", line 61, in render_to_string
    template = get_template(template_name, using=using)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File ".../django/template/loader.py", line 19, in get_template
    raise TemplateDoesNotExist(template_name, chain=chain)
django.template.exceptions.TemplateDoesNotExist: home.xhtml  <a class="co" href="#callout_what_are_we_doing_with_all_these_tests___and__refactoring__CO2-1" id="co_what_are_we_doing_with_all_these_tests___and__refactoring__CO2-4"><img alt="1" height="12" src="assets/1.png" width="12"/></a>

----------------------------------------------------------------------
Ran 1 test in 0.074s</pre>
<p>Another chance to analyse a traceback:</p>
<dl class="calloutlist">
<dt><a class="co" href="#co_what_are_we_doing_with_all_these_tests___and__refactoring__CO2-4" id="callout_what_are_we_doing_with_all_these_tests___and__refactoring__CO2-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>We start with the error: it can’t find the template.</p></dd>
<dt><a class="co" href="#co_what_are_we_doing_with_all_these_tests___and__refactoring__CO2-1" id="callout_what_are_we_doing_with_all_these_tests___and__refactoring__CO2-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Then we double-check what test is failing: sure enough, it’s our test
of the view HTML.</p></dd>
<dt><a class="co" href="#co_what_are_we_doing_with_all_these_tests___and__refactoring__CO2-2" id="callout_what_are_we_doing_with_all_these_tests___and__refactoring__CO2-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Then we find the line in our tests that caused the failure: it’s when
we request the root URL (“/”).</p></dd>
<dt><a class="co" href="#co_what_are_we_doing_with_all_these_tests___and__refactoring__CO2-3" id="callout_what_are_we_doing_with_all_these_tests___and__refactoring__CO2-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>Finally, we look for the part of our own application code that caused the
failure: it’s when we try to call <code>render</code>.</p></dd>
</dl>
<p>So why can’t Django find the template?
It’s right where it’s supposed to be, in the <em>lists/templates</em> folder.</p>
<p>The thing is that we haven’t yet <em>officially</em> registered our lists app with Django.
Unfortunately, just running the <code>startapp</code> command
and having what is obviously an app in your project folder
isn’t quite enough.
You have to tell Django that you <em>really</em> mean it,
and add it to <em>settings.py</em> as well. Belt and braces.
Open it up and look for a variable called <code>INSTALLED_APPS</code>,
to which we’ll add <code>lists</code>:</p>
<div class="sourcecode" data-type="example">
<p>superlists/settings.py (ch04l004)</p>
<pre data-code-language="python" data-type="programlisting"><code class="c1"># Application definition</code>

<code class="n">INSTALLED_APPS</code> <code class="o">=</code> <code class="p">[</code>
    <code class="s2">"django.contrib.admin"</code><code class="p">,</code>
    <code class="s2">"django.contrib.auth"</code><code class="p">,</code>
    <code class="s2">"django.contrib.contenttypes"</code><code class="p">,</code>
    <code class="s2">"django.contrib.sessions"</code><code class="p">,</code>
    <code class="s2">"django.contrib.messages"</code><code class="p">,</code>
    <code class="s2">"django.contrib.staticfiles"</code><code class="p">,</code>
    <code class="s2">"lists"</code><code class="p">,</code>
<code class="p">]</code></pre></div>
<p>You can see there’s lots of apps already in there by default.
We just need to add ours to the bottom of the list.
Don’t forget the trailing comma—​it may not be required,
but one day you’ll be really annoyed when you forget it
and Python concatenates two strings on different lines…​</p>
<p>Now we can try running the tests again:</p>
<pre data-type="programlisting">$ <strong>python manage.py test</strong>
[...]
OK</pre>
<p>Our refactor of the code is now complete,
and the tests mean we’re happy that behaviour is preserved.
Now we can change the tests so that they’re no longer testing constants;
instead, they should just check that we’re rendering the right template.
<a data-primary="" data-startref="refactor04" data-type="indexterm" id="id271"/>
<a data-primary="" data-startref="UTrefactor04" data-type="indexterm" id="id272"/></p>
</div></section>
<section data-pdf-bookmark="Checking template rendering" data-type="sect2"><div class="sect2" id="id137">
<h2>Checking template rendering</h2>
<p>The Django test client has a method, <code>assertTemplateUsed</code>, which can do just what we want:</p>
<div class="sourcecode" data-type="example">
<p>lists/tests.py (ch04l005)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code><code> </code><code class="nf">test_home_page_returns_correct_html</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="n">response</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">client</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"</code><code class="s2">/</code><code class="s2">"</code><code class="p">)</code><code>
</code><code>    </code><code class="bp">self</code><code class="o">.</code><code class="n">assertContains</code><code class="p">(</code><code class="n">response</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">&lt;title&gt;To-Do lists&lt;/title&gt;</code><code class="s2">"</code><code class="p">)</code><code>  </code><a class="co" href="#callout_what_are_we_doing_with_all_these_tests___and__refactoring__CO3-1" id="co_what_are_we_doing_with_all_these_tests___and__refactoring__CO3-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code>    </code><code class="bp">self</code><code class="o">.</code><code class="n">assertContains</code><code class="p">(</code><code class="n">response</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">&lt;html&gt;</code><code class="s2">"</code><code class="p">)</code><code>
</code><code>    </code><code class="bp">self</code><code class="o">.</code><code class="n">assertContains</code><code class="p">(</code><code class="n">response</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">&lt;/html&gt;</code><code class="s2">"</code><code class="p">)</code><code>
</code><code>    </code><code class="bp">self</code><code class="o">.</code><code class="n">assertTemplateUsed</code><code class="p">(</code><code class="n">response</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">home.xhtml</code><code class="s2">"</code><code class="p">)</code><code>  </code><a class="co" href="#callout_what_are_we_doing_with_all_these_tests___and__refactoring__CO3-2" id="co_what_are_we_doing_with_all_these_tests___and__refactoring__CO3-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></pre></div>
<dl class="calloutlist">
<dt><a class="co" href="#co_what_are_we_doing_with_all_these_tests___and__refactoring__CO3-1" id="callout_what_are_we_doing_with_all_these_tests___and__refactoring__CO3-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>We’ll leave the old tests there for now,
just to make sure everything is working the way we think it is.</p></dd>
<dt><a class="co" href="#co_what_are_we_doing_with_all_these_tests___and__refactoring__CO3-2" id="callout_what_are_we_doing_with_all_these_tests___and__refactoring__CO3-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p><code>.assertTemplateUsed</code> lets us check what template was used to render a response
(NB: it will only work for responses that were retrieved by the test client).</p></dd>
</dl>
<p>And that test will still pass:</p>
<pre data-type="programlisting">Ran 1 tests in 0.016s

OK</pre>
<p>Just because I’m always suspicious of a test I haven’t seen fail, let’s
deliberately break it:</p>
<div class="sourcecode" data-type="example">
<p>lists/tests.py (ch04l006)</p>
<pre data-code-language="python" data-type="programlisting"><code class="bp">self</code><code class="o">.</code><code class="n">assertTemplateUsed</code><code class="p">(</code><code class="n">response</code><code class="p">,</code> <code class="s2">"wrong.xhtml"</code><code class="p">)</code></pre></div>
<p>That way we’ll also learn what its error messages look like:</p>
<pre data-type="programlisting">AssertionError: False is not true : Template 'wrong.xhtml' was not a template
used to render the response. Actual template(s) used: home.xhtml</pre>
<p>That’s very helpful!
Let’s change the assert back to the right thing.
While we’re at it, we can delete our old assertions,
and give the test method a more specific name:</p>
<div class="sourcecode" data-type="example">
<p>lists/tests.py (ch04l007)</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">django.test</code> <code class="kn">import</code> <code class="n">TestCase</code>


<code class="k">class</code> <code class="nc">HomePageTest</code><code class="p">(</code><code class="n">TestCase</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf">test_uses_home_template</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="n">response</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">client</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/"</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertTemplateUsed</code><code class="p">(</code><code class="n">response</code><code class="p">,</code> <code class="s2">"home.xhtml"</code><code class="p">)</code></pre></div>
<p>The main point, though, is that instead of testing constants
we’re testing our implementation.
Great!</p>
</div></section>
</div></section>
<section data-pdf-bookmark="On Refactoring" data-type="sect1"><div class="sect1" id="id27">
<h1>On Refactoring</h1>
<p><a data-primary="unit tests" data-secondary="refactoring in" data-type="indexterm" id="id273"/>
<a data-primary="refactoring" data-type="indexterm" id="id274"/>
That was an absolutely trivial example of refactoring.
But, as Kent Beck puts it in <em>Test-Driven Development: By Example</em>,
“Am I recommending that you actually work this way? No.
I’m recommending that you be <em>able</em> to work this way”.</p>
<p>In fact, as I was writing this my first instinct was to dive in
and change the test first—​make it
use the <code>assertTemplateUsed</code> function straight away;
delete the three superfluous assertions,
leaving just a check of the contents
against the expected render;
and then go ahead and make the code change.
But notice how that actually would have left space
for me to break things:
I could have defined the template as containing <em>any</em> arbitrary string,
instead of the string with the right <code>&lt;html&gt;</code> and <code>&lt;title&gt;</code> tags.</p>
<div data-type="tip"><h6>Tip</h6>
<p>When refactoring, work on either the code or the tests,
    but not both at once.</p>
</div>
<p>There’s always a tendency to skip ahead a couple of steps, to make a couple of
tweaks to the behaviour while you’re refactoring, but pretty soon you’ve got
changes to half a dozen different files, you’ve totally lost track of where you
are, and nothing works any more.  If you don’t want to end up like
<a href="http://bit.ly/1iXyRt4">Refactoring Cat</a> (<a data-type="xref" href="#RefactoringCat">Figure 4-2</a>), stick to small
steps; keep refactoring and functionality changes entirely separate.</p>
<figure><div class="figure" id="RefactoringCat">
<img alt="An adventurous cat, trying to refactor its way out of a slippery bathtub" height="562" src="assets/twp2_0402.png" width="644"/>
<h6><span class="label">Figure 4-2. </span>Refactoring Cat—​be sure to look up the full animated GIF (source: 4GIFs.com)</h6>
</div></figure>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>We’ll come across “Refactoring Cat” again during this book,
    as an example of what happens when we get carried away
    and want to change too many things at once.
    Think of it as the little cartoon demon counterpart to the Testing Goat,
    popping up over your other shoulder and giving you bad advice.</p>
</div>
<p>It’s a good idea to do a commit after any refactoring:</p>
<pre data-type="programlisting">$ <strong>git status</strong> # see tests.py, views.py, settings.py, + new templates folder
$ <strong>git add .</strong>  # will also add the untracked templates folder
$ <strong>git diff --staged</strong> # review the changes we're about to commit
$ <strong>git commit -m "Refactor home page view to use a template"</strong></pre>
</div></section>
<section data-pdf-bookmark="A Little More of Our Front Page" data-type="sect1"><div class="sect1" id="id138">
<h1>A Little More of Our Front Page</h1>
<p>In the meantime, our functional test is still failing.
Let’s now make an actual code change to get it passing.
Because our HTML is now in a template,
we can feel free to make changes to it,
without needing to write any extra unit tests.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>This is another distinction between FTs and unit tests;
    Because the FTs use a real web browser,
    we use them as the primary tool for testing our UI,
    and the HTML that implements it.</p>
</div>
<p>So, wanted an <code>&lt;h1&gt;</code>:</p>
<div class="sourcecode" data-type="example">
<p>lists/templates/home.xhtml (ch04l008)</p>
<pre data-code-language="html" data-type="programlisting"><code class="p">&lt;</code><code class="nt">html</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">head</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">title</code><code class="p">&gt;</code>To-Do lists<code class="p">&lt;/</code><code class="nt">title</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">head</code><code class="p">&gt;</code>
  <code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">h1</code><code class="p">&gt;</code>Your To-Do list<code class="p">&lt;/</code><code class="nt">h1</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">html</code><code class="p">&gt;</code></pre></div>
<p>Let’s see if our functional test likes it a little better:</p>
<pre data-type="programlisting">selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: [id="id_new_item"]</pre>
<p>OK, let’s add an input with that ID:</p>
<div class="sourcecode" data-type="example">
<p>lists/templates/home.xhtml (ch04l009)</p>
<pre data-code-language="html" data-type="programlisting">  [...]
  <code class="p">&lt;</code><code class="nt">body</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">h1</code><code class="p">&gt;</code>Your To-Do list<code class="p">&lt;/</code><code class="nt">h1</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">input</code> <code class="na">id</code><code class="o">=</code><code class="s">"id_new_item"</code> <code class="p">/&gt;</code>
  <code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code>
<code class="p">&lt;/</code><code class="nt">html</code><code class="p">&gt;</code></pre></div>
<p>And now what does the FT say?</p>
<pre data-type="programlisting">AssertionError: '' != 'Enter a to-do item'</pre>
<p>We add our placeholder text…​</p>
<div class="sourcecode" data-type="example">
<p>lists/templates/home.xhtml (ch04l010)</p>
<pre data-code-language="html" data-type="programlisting">    <code class="p">&lt;</code><code class="nt">input</code> <code class="na">id</code><code class="o">=</code><code class="s">"id_new_item"</code> <code class="na">placeholder</code><code class="o">=</code><code class="s">"Enter a to-do item"</code> <code class="p">/&gt;</code></pre></div>
<p>Which gives:</p>
<pre data-type="programlisting">selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: [id="id_list_table"]</pre>
<p>So we can go ahead and put the table onto the page. At this stage it’ll just be empty:</p>
<div class="sourcecode" data-type="example">
<p>lists/templates/home.xhtml (ch04l011)</p>
<pre data-code-language="html" data-type="programlisting">    <code class="p">&lt;</code><code class="nt">input</code> <code class="na">id</code><code class="o">=</code><code class="s">"id_new_item"</code> <code class="na">placeholder</code><code class="o">=</code><code class="s">"Enter a to-do item"</code> <code class="p">/&gt;</code>
    <code class="p">&lt;</code><code class="nt">table</code> <code class="na">id</code><code class="o">=</code><code class="s">"id_list_table"</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">table</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">body</code><code class="p">&gt;</code></pre></div>
<p>What does the FT think?</p>
<pre data-type="programlisting">  File "...goat-book/functional_tests.py", line 40, in
test_can_start_a_todo_list
    self.assertTrue(any(row.text == "1: Buy peacock feathers" for row in rows))
AssertionError: False is not true</pre>
<p>Slightly cryptic!
We can use the line number to track it down,
and it turns out it’s that <code>any()</code> function I was so smug about earlier—​or,
more precisely, the <code>assertTrue</code>, which doesn’t have a very explicit failure message.
We can pass a custom error message as an argument to most <code>assertX</code> methods in <code>unittest</code>:</p>
<div class="sourcecode" data-type="example">
<p>functional_tests.py (ch04l012)</p>
<pre data-code-language="python" data-type="programlisting">    <code class="bp">self</code><code class="o">.</code><code class="n">assertTrue</code><code class="p">(</code>
        <code class="nb">any</code><code class="p">(</code><code class="n">row</code><code class="o">.</code><code class="n">text</code> <code class="o">==</code> <code class="s2">"1: Buy peacock feathers"</code> <code class="k">for</code> <code class="n">row</code> <code class="ow">in</code> <code class="n">rows</code><code class="p">),</code>
        <code class="s2">"New to-do item did not appear in table"</code><code class="p">,</code>
    <code class="p">)</code></pre></div>
<p>If you run the FT again, you should see our helpful message:</p>
<pre data-type="programlisting">AssertionError: False is not true : New to-do item did not appear in table</pre>
<p>But now, to get this to pass, we will need to actually process the user’s form submission.
And that’s a topic for the next chapter.</p>
<p>For now let’s do a commit:</p>
<pre data-type="programlisting">$ <strong>git diff</strong>
$ <strong>git commit -am "Front page HTML now generated from a template"</strong></pre>
<p>Thanks to a bit of refactoring,
we’ve got our view set up to render a template,
we’ve stopped testing constants,
and we’re now well placed to start processing user input.</p>
</div></section>
<section data-pdf-bookmark="Recap: The TDD Process" data-type="sect1"><div class="sect1" id="id28">
<h1>Recap: The TDD Process</h1>
<p><a data-primary="Test-Driven Development (TDD)" data-secondary="concepts" data-tertiary="Red/Green/Refactor" data-type="indexterm" id="id275"/>
<a data-primary="Red/Green/Refactor" data-type="indexterm" id="id276"/>
<a data-primary="unit-test/code cycle" data-type="indexterm" id="id277"/>
<a data-primary="Test-Driven Development (TDD)" data-secondary="overall process of" data-type="indexterm" id="TDDprocess04"/>
We’ve now seen all the main aspects of the TDD process, in practice:</p>
<ul>
<li>
<p>Functional tests</p>
</li>
<li>
<p>Unit tests</p>
</li>
<li>
<p>The unit-test/code cycle</p>
</li>
<li>
<p>Refactoring</p>
</li>
</ul>
<p>It’s time for a little recap, and perhaps even some flowcharts
(forgive me, my years misspent as a management consultant have ruined me.
On the plus side, said flowcharts will feature recursion!)</p>
<p>What does the overall TDD process look like?</p>
<ul>
<li>
<p>We write a test.</p>
</li>
<li>
<p>We run the test and see it fail.</p>
</li>
<li>
<p>We write some minimal code to get it a little further.</p>
</li>
<li>
<p>We rerun the test and repeat until it passes (the unit test / code cycle)</p>
</li>
<li>
<p>Then, we look for opportunities to refactor our code,
using our tests to make sure we don’t break anything.</p>
</li>
<li>
<p>And start again from the top!</p>
</li>
</ul>
<p>See <a data-type="xref" href="#simple-tdd-diagram">Figure 4-3</a>.</p>
<figure><div class="figure" id="simple-tdd-diagram">
<img alt="A flowchart with boxes for tests, coding and refactoring, with yes/no labels showing when we move forwards or backwards" height="1127" src="assets/tdd-process-unit-tests-only-excalidraw.png" width="1673"/>
<h6><span class="label">Figure 4-3. </span>TDD process as a flowchart, including the unit test / code cycle</h6>
</div></figure>
<p>It’s very common to talk about this process using the three words
<em>Red, Green, Refactor</em>. See <a data-type="xref" href="#red-green-refactor">Figure 4-4</a>.</p>
<figure><div class="figure" id="red-green-refactor">
<img alt="Red, Green and Refactor as three nodes in a circle, with arrows flowing around." height="392" src="assets/red-green-refactor-excalidraw.png" width="488"/>
<h6><span class="label">Figure 4-4. </span>Red, Green, Refactor</h6>
</div></figure>
<ul>
<li>
<p>We write a test, and see it fail (“Red”).</p>
</li>
<li>
<p>We cycle between code and tests until the test passes: “Green”.</p>
</li>
<li>
<p>Then, we look for opportunities to refactor.</p>
</li>
<li>
<p>Repeat as required!</p>
</li>
</ul>
<section data-pdf-bookmark="Double-loop TDD" data-type="sect2"><div class="sect2" id="id29">
<h2>Double-loop TDD</h2>
<p><a data-primary="double-loop TDD" data-type="indexterm" id="id278"/></p>
<p>But how does this apply when we have functional tests <em>and</em> unit tests?
Well, you can think of the functional test as driving a higher-level version of the same cycle,
with an inner red/green/refactor loop being required to get an FT from Red to Green; see ee <a data-type="xref" href="#double-loop-tdd-diagram">Figure 4-5</a>.</p>
<figure><div class="figure" id="double-loop-tdd-diagram">
<img alt="An inner red/green/refactor loop surrounded by an outer red/green of FTs" height="2290" src="assets/double-loop-tdd-simpler.png" width="2761"/>
<h6><span class="label">Figure 4-5. </span>Double-Loop TDD: Inner and Outer Loops</h6>
</div></figure>
<p>When a new feature or business requirement comes along,
we write a new (failing) FT to capture a high level view of the requirement.
It may not cover every last edge case,
but it should be enough to reassure ourselves that things are working.</p>
<p>To get that functional test to green,
we then enter into the lower-level unit tests cycle,
where we put together all the moving parts required,
add tests for all the edge cases.
Any time we get to green &amp; refactored at the unit tests level,
we can pop back up to the FT level to guide us towards the
next thing we need to work.
Once both levels are green, we can do any extra refactoring
or work on edge cases.</p>
<p>We’ll explore all of the different parts of this workflow in more detail
over the coming chapters.
<a data-primary="" data-startref="TDDprocess04" data-type="indexterm" id="id279"/></p>
<aside class="pagebreak-before" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id280">
<h1>How to “Check” Your Code, or Skip Ahead (If You Must)</h1>
<p><a data-primary="GitHub" data-type="indexterm" id="id281"/>
<a data-primary="code examples, obtaining and using" data-type="indexterm" id="id282"/>
All of the code examples I’ve used in the book are available
in <a href="https://github.com/hjwp/book-example/">my repo on GitHub</a>.
So, if you ever want to compare your code against mine,
you can take a look at it there.</p>
<p>Each chapter has its own branch which is named after its short name.
The one for this chapter is
<a href="https://github.com/hjwp/book-example/tree/chapter_philosophy_and_refactoring">here</a>,
for example.
It is a snapshot of the code as it should be at the <em>end</em> of the chapter.</p>
<p>You can find a full list of them in [Link to Come], as well as
instructions on how to download them or use Git to compare your code to
mine.</p>
<p>Obviously I can’t possibly condone it,
but you can also use my repo to “skip ahead”
and check out the code to let you work on a later chapter
without having worked through all the earlier chapters yourself.
You’re only cheating yourself you know!</p>
</div></aside>
</div></section>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="id262"><sup><a href="ch04.xhtml#id262-marker">1</a></sup> You could also just use the string <code>"\n"</code>, but <code>Keys</code> also lets you send special keys like Ctrl so I thought I’d show it.</p><p data-type="footnote" id="id263"><sup><a href="ch04.xhtml#id263-marker">2</a></sup> Python <em>is</em> most definitely a joy, but if you think I’m being a bit smug here, I don’t blame you! Actually I wish I’d picked up on this feeling of self-satisfaction and seen it as a warning sign that I was being a little <em>too</em> clever. In the next chapter, you’ll see I get my comeuppance.</p><p data-type="footnote" id="id270"><sup><a href="ch04.xhtml#id270-marker">3</a></sup> Some people like to use another subfolder named after the app (i.e., <em>lists/templates/lists</em>) and then refer to the template as <em>lists/home.xhtml</em>. This is called “template namespacing”. I figured it was overcomplicated for this small project, but it may be worth it on larger projects. There’s more in the <a href="https://docs.djangoproject.com/en/4.2/intro/tutorial03/#write-views-that-actually-do-something">Django tutorial</a>.</p></div></div></section></div></body></html>