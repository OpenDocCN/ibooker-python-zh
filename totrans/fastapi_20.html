<html><head></head><body><section data-pdf-bookmark="Chapter 16. Forms and Templates" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch16">&#13;
<h1><span class="label">Chapter 16. </span>Forms and Templates</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Preview" data-type="sect1"><div class="sect1" id="id316">&#13;
<h1>Preview</h1>&#13;
&#13;
<p>Although the <em>API</em> in <em>FastAPI</em> is a hint of its main focus,&#13;
FastAPI can also handle traditional web content.&#13;
This chapter talks about standard HTML forms&#13;
and templates for inserting data into HTML.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Forms" data-type="sect1"><div class="sect1" id="id157">&#13;
<h1>Forms</h1>&#13;
&#13;
<p><a data-primary="forms" data-type="indexterm" id="icd083"/>As you’ve seen, FastAPI was mainly designed to build APIs,&#13;
and its default input is JSON.&#13;
But that doesn’t mean that&#13;
it can’t serve standard banana HTML,&#13;
forms, and friends.</p>&#13;
&#13;
<p>FastAPI supports data from HTML forms much as it does&#13;
from other sources like <code>Query</code> and <code>Path</code>,&#13;
using the <code>Form</code> dependency.</p>&#13;
&#13;
<p>You’ll need the package <a data-primary="Python-Multipart" data-type="indexterm" id="id965"/>Python-Multipart for any FastAPI&#13;
forms work, so run <code>pip install python-multipart</code> if you need to.&#13;
Also, the <em>static</em> directory from <a data-type="xref" href="ch15.html#ch15">Chapter 15</a> will be needed&#13;
to house the test forms in this chapter.</p>&#13;
&#13;
<p>Let’s redo <a data-type="xref" href="ch03.html#ex-3-11">Example 3-11</a>,&#13;
but provide the <code>who</code> value via a form&#13;
instead of a JSON string.&#13;
(Call this path function <code>greet2()</code> to avoid clobbering&#13;
the old <code>greet()</code> path function if it’s still around.)&#13;
Add <a data-type="xref" href="#ex-16-1">Example 16-1</a> to <em>main.py</em>.</p>&#13;
<div data-type="example" id="ex-16-1">&#13;
<h5><span class="label">Example 16-1. </span>Get a value from a<a data-primary="forms" data-secondary="GET forms" data-type="indexterm" id="icd085"/> <code>GET</code> form</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">FastAPI</code><code class="p">,</code> <code class="n">Form</code>&#13;
&#13;
<code class="n">app</code> <code class="o">=</code> <code class="n">FastAPI</code><code class="p">()</code>&#13;
&#13;
<code class="nd">@app</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/who2"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">greet2</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code> <code class="o">=</code> <code class="n">Form</code><code class="p">()):</code>&#13;
    <code class="k">return</code> <code class="sa">f</code><code class="s2">"Hello, </code><code class="si">{</code><code class="n">name</code><code class="si">}</code><code class="s2">?"</code></pre></div>&#13;
&#13;
<p>The main difference is that the value comes from <code>Form</code>&#13;
instead of <code>Path</code>, <code>Query</code>, and the others from <a data-type="xref" href="ch03.html#ch03">Chapter 3</a>.</p>&#13;
&#13;
<p>Try an initial form test with HTTPie in <a data-type="xref" href="#ex-16-2">Example 16-2</a>&#13;
(you need that <code>-f</code> to upload with form encoding&#13;
rather than as JSON).</p>&#13;
<div data-type="example" id="ex-16-2">&#13;
<h5><span class="label">Example 16-2. </span>Form <code>GET</code> request with HTTPie</h5>&#13;
&#13;
<pre data-type="programlisting">$ <strong>http -f -b GET localhost:8000/who2 name="Bob Frapples"</strong>&#13;
"Hello, Bob Frapples?"</pre></div>&#13;
&#13;
<p>You could also send a request from a standard HTML form file.&#13;
<a data-type="xref" href="ch15.html#ch15">Chapter 15</a> showed how to make a directory called <em>static</em>&#13;
(accessed under the URL <em>/static</em>)&#13;
that could house anything, including HTML files, so&#13;
in <a data-type="xref" href="#ex-16-3">Example 16-3</a>,&#13;
let’s put this file (<em>form1.html</em>) there.</p>&#13;
<div data-type="example" id="ex-16-3">&#13;
<h5><span class="label">Example 16-3. </span>Form <code>GET</code> request (<span class="plain">static/form1.html</span>)</h5>&#13;
&#13;
<pre data-type="programlisting">&lt;form action="http://localhost:8000/who2" method="get"&gt;&#13;
Say hello to my little friend:&#13;
&lt;input type="text" name="name" value="Bob Frapples"&gt;&#13;
&lt;input type="submit"&gt;&#13;
&lt;/form&gt;</pre></div>&#13;
&#13;
<p>If you ask your browser to load&#13;
<em>http://localhost:8000/static/form1.html</em>,&#13;
you’ll see a form.&#13;
If you fill in any test string,&#13;
you’ll get this back:</p>&#13;
&#13;
<pre data-type="programlisting">"detail":[{"loc":["body","name"],&#13;
           "msg":"field required",&#13;
           "type":"value_error.missing"}]}</pre>&#13;
&#13;
<p>Huh?</p>&#13;
&#13;
<p>Look at the window where Uvicorn&#13;
is running to see what its log says:</p>&#13;
&#13;
<pre data-type="programlisting">INFO:     127.0.0.1:63502 -&#13;
  "GET /who2?name=rr23r23 HTTP/1.1"&#13;
  422 Unprocessable Entity</pre>&#13;
&#13;
<p>Why did this form send <code>name</code> as a query parameter when we&#13;
had it in a form field?&#13;
That turns out to be an HTML weirdness, documented on the&#13;
<a href="https://oreil.ly/e6CJb">W3C website</a>.&#13;
Also, if you had any query parameters in your URL,&#13;
it will erase them and replace them with <code>name</code>.</p>&#13;
&#13;
<p>So, why did HTTPie handle it as expected?&#13;
I don’t know.&#13;
It’s an inconsistency to be aware of<a data-primary="forms" data-secondary="GET forms" data-startref="icd085" data-type="indexterm" id="id966"/>.</p>&#13;
&#13;
<p>The official HTML incantation is to change the action from a <code>GET</code>&#13;
to a <code>POST</code>.&#13;
So let’s add a <code>POST</code> endpoint for <em>/who2</em> to <em>main.py</em>&#13;
in <a data-type="xref" href="#ex-16-4">Example 16-4</a>.</p>&#13;
<div data-type="example" id="ex-16-4">&#13;
<h5><span class="label">Example 16-4. </span>Get a value from<a data-primary="forms" data-secondary="POST forms" data-type="indexterm" id="id967"/> a <code>POST</code> form</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">FastAPI</code><code class="p">,</code> <code class="n">Form</code>&#13;
&#13;
<code class="n">app</code> <code class="o">=</code> <code class="n">FastAPI</code><code class="p">()</code>&#13;
&#13;
<code class="nd">@app</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s2">"/who2"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">greet3</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="nb">str</code> <code class="o">=</code> <code class="n">Form</code><code class="p">()):</code>&#13;
    <code class="k">return</code> <code class="sa">f</code><code class="s2">"Hello, </code><code class="si">{</code><code class="n">name</code><code class="si">}</code><code class="s2">?"</code></pre></div>&#13;
&#13;
<p><a data-type="xref" href="#ex-16-5">Example 16-5</a> is <em>stuff/form2.html</em>,&#13;
with <code>get</code> changed to <code>post</code>.</p>&#13;
<div data-type="example" id="ex-16-5">&#13;
<h5><span class="label">Example 16-5. </span>Form <code>POST</code> request (<span class="plain">static/form2.html</span>)</h5>&#13;
&#13;
<pre data-type="programlisting">&lt;form action="http://localhost:8000/who2" method="post"&gt;&#13;
Say hello to my little friend:&#13;
&lt;input type="text" name="name"&gt;&#13;
&lt;input type="submit"&gt;&#13;
&lt;/form&gt;</pre></div>&#13;
&#13;
<p>Ask your browser to get off its digital haunches&#13;
and get this new form for you.&#13;
Fill in <code><strong>Bob Frapples</strong></code> and submit the form.&#13;
This time, you’ll get the result&#13;
that you got from HTTPie:</p>&#13;
&#13;
<pre data-type="programlisting">"Hello, Bob Frapples?"</pre>&#13;
&#13;
<p>So, if you’re submitting forms from HTML files,&#13;
use <code>POST</code><a data-primary="forms" data-startref="icd083" data-type="indexterm" id="id968"/>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Templates" data-type="sect1"><div class="sect1" id="id158">&#13;
<h1>Templates</h1>&#13;
&#13;
<p><a data-primary="templates" data-type="indexterm" id="icd084"/>You may have seen the word game <em>Mad Libs</em>.&#13;
You ask people to provide a sequence of words—nouns,&#13;
verbs, or something more specific—and you enter them into labeled places in a page of text.&#13;
Once you have all the words, you read the&#13;
text with the inserted values,&#13;
and hilarity ensues, sometimes with embarrassment.</p>&#13;
&#13;
<p>Well, a web <em>template</em> is similar,&#13;
though usually without the embarrassment.&#13;
A <span class="keep-together">template</span> contains&#13;
a bunch of text with slots for data to be inserted&#13;
by the server.&#13;
Its usual purpose is to generate HTML with variable content,&#13;
unlike the <em>static</em> HTML of <a data-type="xref" href="ch15.html#ch15">Chapter 15</a>.</p>&#13;
&#13;
<p>Users of Flask are very familiar with its&#13;
companion project, the template engine&#13;
<a href="https://jinja.palletsprojects.com">Jinja</a><a data-primary="Jinja" data-type="indexterm" id="id969"/>&#13;
(also often called <em>Jinja2</em>).&#13;
FastAPI supports Jinja, as well as other template engines.</p>&#13;
&#13;
<p>Make a directory called <em>template</em> alongside <em>main.py</em>&#13;
to house Jinja-enhanced HTML files.&#13;
Inside, make a file called <em>list.html</em>,&#13;
as in <a data-type="xref" href="#ex-16-6">Example 16-6</a>.</p>&#13;
<div data-type="example" id="ex-16-6">&#13;
<h5><span class="label">Example 16-6. </span>Define a template<a data-primary="templates" data-secondary="defining template files" data-type="indexterm" id="icd086"/> file (<span class="plain">template/list.html</span>)</h5>&#13;
&#13;
<pre data-type="programlisting">&lt;html&gt;&#13;
&lt;table bgcolor="#eeeeee"&gt;&#13;
  &lt;tr&gt;&#13;
    &lt;th colspan=3&gt;Creatures&lt;/th&gt;&#13;
  &lt;/tr&gt;&#13;
  &lt;tr&gt;&#13;
    &lt;th&gt;Name&lt;/th&gt;&#13;
    &lt;th&gt;Description&lt;/th&gt;&#13;
    &lt;th&gt;Country&lt;/th&gt;&#13;
    &lt;th&gt;Area&lt;/th&gt;&#13;
    &lt;th&gt;AKA&lt;/th&gt;&#13;
  &lt;/tr&gt;&#13;
{% for creature in creatures: %}&#13;
  &lt;tr&gt;&#13;
    &lt;td&gt;{{ creature.name }}&lt;/td&gt;&#13;
    &lt;td&gt;{{ creature.description }}&lt;/td&gt;&#13;
    &lt;td&gt;{{ creature.country }}&lt;/td&gt;&#13;
    &lt;td&gt;{{ creature.area }}&lt;/td&gt;&#13;
    &lt;td&gt;{{ creature.aka }}&lt;/td&gt;&#13;
  &lt;/tr&gt;&#13;
{% endfor %}&#13;
&lt;/table&gt;&#13;
&#13;
&lt;br&gt;&#13;
&#13;
&lt;table bgcolor="#dddddd"&gt;&#13;
  &lt;tr&gt;&#13;
    &lt;th colspan=2&gt;Explorers&lt;/th&gt;&#13;
  &lt;/tr&gt;&#13;
  &lt;tr&gt;&#13;
    &lt;th&gt;Name&lt;/th&gt;&#13;
    &lt;th&gt;Country&lt;/th&gt;&#13;
    &lt;th&gt;Description&lt;/th&gt;&#13;
  &lt;/tr&gt;&#13;
{% for explorer in explorers: %}&#13;
  &lt;tr&gt;&#13;
    &lt;td&gt;{{ explorer.name }}&lt;/td&gt;&#13;
    &lt;td&gt;{{ explorer.country }}&lt;/td&gt;&#13;
    &lt;td&gt;{{ explorer.description }}&lt;/td&gt;&#13;
  &lt;/tr&gt;&#13;
{% endfor %}&#13;
&lt;/table&gt;&#13;
&lt;/html&gt;</pre></div>&#13;
&#13;
<p>I don’t care how it looks, so there’s no CSS,&#13;
just the ancient pre-CSS <code>bgcolor</code> table attribute to&#13;
distinguish the two tables.</p>&#13;
&#13;
<p>Double curly braces enclose Python variables that should be&#13;
inserted, and <code>{%</code> and <code>%}</code> enclose <code>if</code> statements, <code>for</code> loops,&#13;
and other controls.&#13;
See the Jinja&#13;
<a href="https://jinja.palletsprojects.com">documentation</a>&#13;
for the syntax and examples.</p>&#13;
&#13;
<p>This template expects to be passed&#13;
Python variables called&#13;
<code>creatures</code> and <code>explorers</code>, which are lists of <code>Creature</code> and <code>Explorer</code> objects.</p>&#13;
&#13;
<p><a data-type="xref" href="#ex-16-7">Example 16-7</a> shows what to add to <em>main.py</em> to set up&#13;
templates and use the one from <a data-type="xref" href="#ex-16-6">Example 16-6</a>.&#13;
It feeds <code>creatures</code> and <code>explorers</code> to the template,&#13;
using modules under the <em>fake</em> directory from previous chapters,&#13;
which provided test data if the database was&#13;
empty or not connected<a data-primary="templates" data-secondary="defining template files" data-startref="icd086" data-type="indexterm" id="id970"/>.</p>&#13;
<div data-type="example" id="ex-16-7">&#13;
<h5><span class="label">Example 16-7. </span>Configure <a data-primary="templates" data-secondary="configuring and using" data-type="indexterm" id="id971"/>templates and use one (<span class="plain">main.py</span>)</h5>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">pathlib</code> <code class="kn">import</code> <code class="n">Path</code>&#13;
<code class="kn">from</code> <code class="nn">fastapi</code> <code class="kn">import</code> <code class="n">FastAPI</code><code class="p">,</code> <code class="n">Request</code>&#13;
<code class="kn">from</code> <code class="nn">fastapi.templating</code> <code class="kn">import</code> <code class="n">Jinja2Templates</code>&#13;
&#13;
<code class="n">app</code> <code class="o">=</code> <code class="n">FastAPI</code><code class="p">()</code>&#13;
&#13;
<code class="n">top</code> <code class="o">=</code> <code class="n">Path</code><code class="p">(</code><code class="vm">__file__</code><code class="p">)</code><code class="o">.</code><code class="n">resolve</code><code class="p">()</code><code class="o">.</code><code class="n">parent</code>&#13;
&#13;
<code class="n">template_obj</code> <code class="o">=</code> <code class="n">Jinja2Templates</code><code class="p">(</code><code class="n">directory</code><code class="o">=</code><code class="sa">f</code><code class="s2">"</code><code class="si">{</code><code class="n">top</code><code class="si">}</code><code class="s2">/template"</code><code class="p">)</code>&#13;
&#13;
<code class="c1"># Get some small predefined lists of our buddies:</code>&#13;
<code class="kn">from</code> <code class="nn">fake.creature</code> <code class="kn">import</code> <code class="n">fakes</code> <code class="k">as</code> <code class="n">fake_creatures</code>&#13;
<code class="kn">from</code> <code class="nn">fake.explorer</code> <code class="kn">import</code> <code class="n">fakes</code> <code class="k">as</code> <code class="n">fake_explorers</code>&#13;
&#13;
<code class="nd">@app</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/list"</code><code class="p">)</code>&#13;
<code class="k">def</code> <code class="nf">explorer_list</code><code class="p">(</code><code class="n">request</code><code class="p">:</code> <code class="n">Request</code><code class="p">):</code>&#13;
    <code class="k">return</code> <code class="n">template_obj</code><code class="o">.</code><code class="n">TemplateResponse</code><code class="p">(</code><code class="s2">"list.html"</code><code class="p">,</code>&#13;
        <code class="p">{</code><code class="s2">"request"</code><code class="p">:</code> <code class="n">request</code><code class="p">,</code>&#13;
        <code class="s2">"explorers"</code><code class="p">:</code> <code class="n">fake_explorers</code><code class="p">,</code>&#13;
        <code class="s2">"creatures"</code><code class="p">:</code> <code class="n">fake_creatures</code><code class="p">})</code></pre></div>&#13;
&#13;
<p>Ask your favorite browser<a data-primary="templates" data-startref="icd084" data-type="indexterm" id="id972"/>,&#13;
or even one that you don’t like very well,&#13;
for <em>http://localhost:8000/list</em>,&#13;
and you should get <a data-type="xref" href="#fig-output-from-list">Figure 16-1</a> back.</p>&#13;
&#13;
<figure><div class="figure" id="fig-output-from-list">&#13;
<img alt="fapi 1601" src="assets/fapi_1601.png"/>&#13;
<h6><span class="label">Figure 16-1. </span>Output from <span class="plain">/list</span></h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Review" data-type="sect1"><div class="sect1" id="id317">&#13;
<h1>Review</h1>&#13;
&#13;
<p>This chapter was a quick overview of how FastAPI&#13;
handles non-API topics like forms and templates. Along with the previous chapter on files, these are traditional bread-and-butter web tasks that you’ll encounter often.</p>&#13;
</div></section>&#13;
</div></section></body></html>