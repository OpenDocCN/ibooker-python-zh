<html><head></head><body><section data-pdf-bookmark="Chapter 13. Crawling Through Forms and Logins" data-type="chapter" epub:type="chapter"><div class="chapter" id="c-13">&#13;
<h1><span class="label">Chapter 13. </span>Crawling Through Forms and Logins</h1>&#13;
&#13;
<p>One of the first questions that comes up when you start to move beyond the basics of web scraping is: “How do I access information behind a login screen?” The web is increasingly moving toward interaction, social media, and user-generated content. Forms and logins are an integral part of these types of sites and almost impossible to avoid. Fortunately, they are also relatively easy to deal with.</p>&#13;
&#13;
<p>Until this point, most of our interactions with web servers in our example scrapers have consisted of using HTTP <code>GET</code> to request information. This chapter focuses on the <code>POST</code> method, which pushes information to a web server for storage and analysis.</p>&#13;
&#13;
<p>Forms basically give <a contenteditable="false" data-primary="POST method" data-type="indexterm" id="id688"/><a contenteditable="false" data-primary="HTTP (HyperText Transfer Protocol)" data-secondary="POST request" data-type="indexterm" id="id689"/><a contenteditable="false" data-primary="forms" data-secondary="HTTP POST request" data-type="indexterm" id="id690"/>users a way to submit a <code>POST</code> request that the web server can understand and use. Just as link tags on a website help users format <code>GET</code> requests, HTML forms help them format <code>POST</code> requests. Of course, with a little bit of coding, it is possible to create these requests ourselves and submit them with a scraper.</p>&#13;
&#13;
<section data-pdf-bookmark="Python Requests Library" data-type="sect1"><div class="sect1" id="id80">&#13;
<h1>Python Requests Library</h1>&#13;
&#13;
<p>Although it’s possible to navigate web <a contenteditable="false" data-primary="Requests library" data-type="indexterm" id="id691"/><a contenteditable="false" data-primary="libraries" data-secondary="Requests" data-type="indexterm" id="id692"/>forms by using only the Python core libraries, sometimes a little syntactic sugar makes life a lot sweeter. When you start to do more than a basic <code>GET</code> request with urllib, looking outside the Python core libraries can be helpful.</p>&#13;
&#13;
<p>The <a href="http://www.python-requests.org">Requests library</a> is excellent at handling complicated HTTP requests, cookies, headers, and much more. Here’s what Requests creator Kenneth Reitz has to say about Python’s core tools:</p>&#13;
&#13;
<blockquote class="pagebreak-before">Python’s standard urllib2 module <a contenteditable="false" data-primary="Requests library" data-secondary="urllib2 module" data-type="indexterm" id="id693"/><a contenteditable="false" data-primary="libraries" data-secondary="Requests" data-tertiary="urllib2 module" data-type="indexterm" id="id694"/><a contenteditable="false" data-primary="urllib2 module" data-type="indexterm" id="id695"/>provides most of the HTTP capabilities you need, but the API is thoroughly broken. It was built for a different time—and a different web. It requires an enormous amount of work (even method overrides) to perform the simplest of tasks.<br/>&#13;
<br/>&#13;
Things shouldn’t be this way. Not in Python.</blockquote>&#13;
&#13;
<p>As with any Python library, the Requests library can be installed with any third-party Python library manager, such as pip, or by downloading and installing the <a href="https://github.com/kennethreitz/requests/tarball/master">source file</a>.</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Submitting a Basic Form" data-type="sect1"><div class="sect1" id="id154">&#13;
<h1>Submitting a Basic Form</h1>&#13;
&#13;
<p>Most web forms consist of a few HTML fields, a <a contenteditable="false" data-primary="forms" data-secondary="submitting" data-type="indexterm" id="fmsbm"/><a contenteditable="false" data-primary="logins" data-secondary="forms, submitting" data-type="indexterm" id="id696"/><a contenteditable="false" data-primary="HTML (HyperText Markup Language)" data-secondary="forms submission" data-type="indexterm" id="yxkgfs"/>Submit button, and an action page, where the actual form processing is done. The HTML fields usually consist of text but might also contain a file upload or other nontext content.</p>&#13;
&#13;
<p>Most popular websites block access to their login forms in their <em>robots.txt</em> file (<a data-type="xref" href="ch02.html#c-2">Chapter 2</a> discusses the legality of scraping such forms), so to play it safe I’ve constructed a series of different types of forms and logins at <em>pythonscraping.com</em> that you can run your web scrapers against. <a href="http://pythonscraping.com/pages/files/form.html"><em>http://pythonscraping.com/pages/files/form.html</em></a> is the location of the most basic of these forms.</p>&#13;
&#13;
<p>The entirety of the HTML code for the form is as follows:</p>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting">&#13;
<code class="p">&lt;</code><code class="nt">form</code> <code class="na">method</code><code class="o">=</code><code class="s">"post"</code> <code class="na">action</code><code class="o">=</code><code class="s">"processing.php"</code><code class="p">&gt;</code>&#13;
First name: <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"text"</code> <code class="na">name</code><code class="o">=</code><code class="s">"firstname"</code><code class="p">&gt;&lt;</code><code class="nt">br</code><code class="p">&gt;</code>&#13;
Last name: <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"text"</code> <code class="na">name</code><code class="o">=</code><code class="s">"lastname"</code><code class="p">&gt;&lt;</code><code class="nt">br</code><code class="p">&gt;</code>&#13;
<code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"submit"</code> <code class="na">value</code><code class="o">=</code><code class="s">"Submit"</code><code class="p">&gt;</code>&#13;
<code class="p">&lt;/</code><code class="nt">form</code><code class="p">&gt;</code></pre>&#13;
&#13;
<p>A couple of things to notice here: first, the names of the two input fields are <code>firstname</code> and <code>lastname</code>. This is important. The names of these fields determine the names of the variable parameters that will be <code>POST</code>ed to the server when the form is submitted. If you want to mimic the action that the form will take when <code>POST</code>ing your own data, you need to make sure that your variable names match up.</p>&#13;
&#13;
<p>The second thing to note is that the action of the form is at <em>processing.php</em> (the absolute path is <a href="http://pythonscraping.com/pages/files/processing.php"><em>http://pythonscraping.com/pages/files/processing.php</em></a>). Any <code>POST</code> requests to the form should be made on <em>this</em> page, not on the page where the form itself resides. Remember: the purpose of HTML forms is only to help website visitors format proper requests to send to the page that does the real action. Unless you are doing research to format the request itself, you don’t need to bother much with the page that the form can be found on.</p>&#13;
&#13;
<p>Submitting a form with the Requests library can be done in four lines, including the import and the instruction to print the content (yes, it’s that easy):</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="kn">import</code> <code class="nn">requests</code>&#13;
&#13;
<code class="n">params</code> <code class="o">=</code> <code class="p">{</code><code class="s1">'firstname'</code><code class="p">:</code> <code class="s1">'Ryan'</code><code class="p">,</code> <code class="s1">'lastname'</code><code class="p">:</code> <code class="s1">'Mitchell'</code><code class="p">}</code>&#13;
<code class="n">r</code> <code class="o">=</code> <code class="n">requests</code><code class="o">.</code><code class="n">post</code><code class="p">(</code>&#13;
    <code class="s1">'http://pythonscraping.com/pages/files/processing.php'</code><code class="p">,</code>&#13;
    <code class="n">data</code><code class="o">=</code><code class="n">params</code>&#13;
<code class="p">)</code>&#13;
<code class="nb">print</code><code class="p">(</code><code class="n">r</code><code class="o">.</code><code class="n">text</code><code class="p">)</code></pre>&#13;
&#13;
<p>After the form is submitted, the script should return with the page’s content:</p>&#13;
&#13;
<pre data-code-language="text" data-type="programlisting">&#13;
Hello there, Ryan Mitchell!</pre>&#13;
&#13;
<p>This script can be applied to many simple forms encountered on the internet. The form to sign up for the “Web Scraping with Python” newsletter, for example, looks like this:</p>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting">&#13;
 <code class="p">&lt;</code><code class="nt">form</code> <code class="na">id</code><code class="o">=</code><code class="s">"eclg-form"</code><code class="p">&gt;</code>&#13;
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"input-field"</code><code class="p">&gt;</code>&#13;
    <code class="p">&lt;</code><code class="nt">label</code><code class="p">&gt;</code>First Name<code class="p">&lt;/</code><code class="nt">label</code><code class="p">&gt;</code>&#13;
    <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"text"</code> <code class="na">name</code><code class="o">=</code><code class="s">"first_name"</code> <code class="na">class</code><code class="o">=</code><code class="s">"eclg_firstname"</code><code class="p">&gt;</code>&#13;
  <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>&#13;
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"input-field"</code><code class="p">&gt;</code>&#13;
    <code class="p">&lt;</code><code class="nt">label</code><code class="p">&gt;</code>Last Name<code class="p">&lt;/</code><code class="nt">label</code><code class="p">&gt;</code>&#13;
    <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"text"</code> <code class="na">name</code><code class="o">=</code><code class="s">"last_name"</code> <code class="na">class</code><code class="o">=</code><code class="s">"eclg_lastname"</code><code class="p">&gt;</code>&#13;
  <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>&#13;
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"input-field"</code><code class="p">&gt;</code>&#13;
    <code class="p">&lt;</code><code class="nt">label</code><code class="p">&gt;</code>Email<code class="p">&lt;/</code><code class="nt">label</code><code class="p">&gt;</code>&#13;
    <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"text"</code> <code class="na">name</code><code class="o">=</code><code class="s">"email"</code> <code class="na">class</code><code class="o">=</code><code class="s">"eclg_email"</code><code class="p">&gt;</code>&#13;
  <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>&#13;
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"input-field input-submit"</code><code class="p">&gt;</code>&#13;
    <code class="p">&lt;</code><code class="nt">button</code> <code class="na">type</code><code class="o">=</code><code class="s">"button"</code> <code class="na">id</code><code class="o">=</code><code class="s">"eclg-submit-btn"</code><code class="p">&gt;</code>Send <code class="p">&lt;/</code><code class="nt">button</code><code class="p">&gt;</code>&#13;
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"eclg_ajax_loader"</code> <code class="na">style</code><code class="o">=</code><code class="s">"display: none;"</code><code class="p">&gt;</code>&#13;
<code class="p">&lt;</code><code class="nt">img</code> <code class="na">decoding</code><code class="o">=</code><code class="s">"async"</code> <code class="na">src</code><code class="o">=</code><code class="s">"https://pythonscraping.com/wp-content/</code>&#13;
<code class="s">plugins/email-capture-lead-generation//images/ajax_loader.gif"</code><code class="p">&gt;</code>&#13;
<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>&#13;
  <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>&#13;
  <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"eclg-message-container"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>&#13;
<code class="p">&lt;/</code><code class="nt">form</code><code class="p">&gt;</code>&#13;
&#13;
</pre>&#13;
&#13;
<p>Although it can look daunting at first, remember that in most cases (we’ll cover the exceptions later), you’re looking for only two things:</p>&#13;
&#13;
<ul>&#13;
	<li>The name of the field (or fields) you want to submit with the data. In this case, first name <code>first_name</code>, last name <code>last_name</code>, and email address <code>email</code>.</li>&#13;
	<li>The action attribute of the form itself; that is, the page that the form posts <span class="keep-together">data to.</span> </li>&#13;
</ul>&#13;
&#13;
<p>In this case, the action of the form isn’t obvious. Unlike a traditional HTML form, this page uses a JavaScript program that detects the form submission and submits it to the proper URL.</p>&#13;
&#13;
<p>In cases like this, using your browser’s network tools can come in handy. Simply open up the Network tab, fill out the form, hit the Submit button, and observe the values being sent over the network (<a data-type="xref" href="#fig1301">Figure 13-1</a>).</p>&#13;
&#13;
<figure><div class="figure" id="fig1301">&#13;
<img alt="" class="iimageswsp3_1301png" src="assets/wsp3_1301.png"/>&#13;
<h6><span class="label">Figure 13-1. </span>A request sent to the newsletter form at pythonscraping.com</h6>&#13;
</div></figure>&#13;
&#13;
&#13;
<p>Although you could wade through convoluted JavaScript and eventually arrive at the same answer, using the Network tab allows you to see trivially that the form contents are being submitted to <a href="https://pythonscraping.com/wp-admin/admin-ajax.php"><em class="hyperlink">https://pythonscraping.com/wp-admin/admin-ajax.php</em></a>.</p>&#13;
&#13;
<p>In addition, the Payload tab reveals a fourth form value sent to this endpoint: <code>action: eclg_add_newsletter</code>.</p>&#13;
&#13;
<p>With this, we can replicate the form submission in Python:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="kn">import</code> <code class="nn">requests</code>&#13;
<code class="n">params</code> <code class="o">=</code> <code class="p">{</code>&#13;
    <code class="s1">'firstname'</code><code class="p">:</code> <code class="s1">'Ryan'</code><code class="p">,</code>&#13;
    <code class="s1">'lastname'</code><code class="p">:</code> <code class="s1">'Mitchell'</code><code class="p">,</code>&#13;
    <code class="s1">'email'</code><code class="p">:</code> <code class="s1">'ryanemitchell@gmail.com'</code><code class="p">,</code>&#13;
    <code class="s1">'action'</code><code class="p">:</code> <code class="s1">'eclg_add_newsletter'</code>&#13;
<code class="p">}</code>&#13;
<code class="n">r</code> <code class="o">=</code> <code class="n">requests</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s1">'https://pythonscraping.com/wp-admin/admin-ajax.php'</code><code class="p">,</code>&#13;
                   <code class="n">data</code><code class="o">=</code><code class="n">params</code><code class="p">)</code>&#13;
<code class="nb">print</code><code class="p">(</code><code class="n">r</code><code class="o">.</code><code class="n">text</code><code class="p">)</code></pre>&#13;
&#13;
<p>In this case, the form <a contenteditable="false" data-primary="forms" data-secondary="submitting" data-startref="fmsbm" data-type="indexterm" id="id697"/><a contenteditable="false" data-primary="HTML (HyperText Markup Language)" data-secondary="forms submission" data-startref="yxkgfs" data-type="indexterm" id="id698"/>provides a JSON-formatted response:</p>&#13;
&#13;
<pre>&#13;
{"status":"1","errmsg":"You have subscribed successfully!."}&#13;
</pre>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Radio Buttons, Checkboxes, and Other Inputs" data-type="sect1"><div class="sect1" id="id81">&#13;
<h1>Radio Buttons, Checkboxes, and Other Inputs</h1>&#13;
&#13;
<p>Obviously, not all web forms are a <a contenteditable="false" data-primary="forms" data-secondary="input" data-type="indexterm" id="id699"/><a contenteditable="false" data-primary="radio buttons" data-type="indexterm" id="id700"/><a contenteditable="false" data-primary="checkboxes" data-type="indexterm" id="id701"/><a contenteditable="false" data-primary="HTML (HyperText Markup Language)" data-secondary="radio buttons" data-type="indexterm" id="id702"/><a contenteditable="false" data-primary="HTML (HyperText Markup Language)" data-secondary="checkboxes" data-type="indexterm" id="id703"/>collection of text fields followed by a Submit button. Standard HTML contains a wide variety of possible form input fields: radio buttons, checkboxes, and select boxes, to name a few. HTML5 adds sliders (range input fields), email, dates, and more. With custom JavaScript fields, the possibilities are endless, with color pickers, calendars, and whatever else the developers come up with next.</p>&#13;
&#13;
<p>Regardless of the seeming complexity of any <a contenteditable="false" data-primary="forms" data-secondary="fields" data-type="indexterm" id="id704"/>sort of form field, you need to worry about only two things: the name of the element and its value. The element’s name easily can be determined by looking at the source code and finding the <code>name</code> attribute. The value can sometimes be trickier, as it might be populated by JavaScript immediately before form submission. Color pickers, as an example of a fairly exotic form field, will likely have a value of something like <code>#F03030</code>.</p>&#13;
&#13;
<p>If you’re unsure of the format of an input field’s value, you can use various tools to track the <code>GET</code> and <code>POST</code> requests your browser is sending to and from sites. The best and perhaps most obvious way to track <code>GET</code> requests, as mentioned before, is to look at the URL of a site. If the URL is something like:</p>&#13;
&#13;
<blockquote>&#13;
<p><code>http://domainname.com?thing1=foo&amp;thing2=bar</code></p>&#13;
</blockquote>&#13;
&#13;
<p>you know that this corresponds to a form of this type:</p>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting">&#13;
<code class="p">&lt;</code><code class="nt">form</code> <code class="na">method</code><code class="o">=</code><code class="s">"GET"</code> <code class="na">action</code><code class="o">=</code><code class="s">"someProcessor.php"</code><code class="p">&gt;</code>&#13;
<code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"someCrazyInputType"</code> <code class="na">name</code><code class="o">=</code><code class="s">"thing1"</code> <code class="na">value</code><code class="o">=</code><code class="s">"foo"</code> <code class="p">/&gt;</code>&#13;
<code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"anotherCrazyInputType"</code> <code class="na">name</code><code class="o">=</code><code class="s">"thing2"</code> <code class="na">value</code><code class="o">=</code><code class="s">"bar"</code> <code class="p">/&gt;</code>&#13;
<code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"submit"</code> <code class="na">value</code><code class="o">=</code><code class="s">"Submit"</code> <code class="p">/&gt;</code>&#13;
<code class="p">&lt;/</code><code class="nt">form</code><code class="p">&gt;</code></pre>&#13;
&#13;
<p>which corresponds to the Python parameter object:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="p">{</code><code class="s1">'thing1'</code><code class="p">:</code><code class="s1">'foo'</code><code class="p">,</code> <code class="s1">'thing2'</code><code class="p">:</code><code class="s1">'bar'</code><code class="p">}</code></pre>&#13;
&#13;
<p>Again, if you’re stuck with a complicated-looking <code>POST</code> form, and you want to see exactly which parameters your browser is sending to the server, the easiest way is to use your browser’s inspector or developer tool to view them (see <a data-type="xref" href="#form_data_section">Figure 13-2</a>).</p>&#13;
&#13;
<figure><div class="figure" id="form_data_section"><img alt="Alt Text" class="iimageschromeinspectorpng" src="assets/wsp3_1302.png"/>&#13;
<h6><span class="label">Figure 13-2. </span>The Form Data section, highlighted in a box, shows the POST parameters “thing1” and “thing2” with their values “foo” and “bar”</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Submitting Files and Images" data-type="sect1"><div class="sect1" id="id155">&#13;
<h1>Submitting Files and Images</h1>&#13;
&#13;
<p>Although file uploads are common on <a contenteditable="false" data-primary="files" data-secondary="uploading" data-type="indexterm" id="flpld"/><a contenteditable="false" data-primary="images" data-secondary="uploading" data-type="indexterm" id="mgpld"/>the internet, file uploads are not something often used in web scraping. It is possible, however, that you might want to write a test for your own site that involves a file upload. At any rate, it’s a useful thing to know how to do.</p>&#13;
&#13;
<p>There is a practice file upload form at <em><a href="http://pythonscraping.com/pages/files/form2.html"><em class="hyperlink">http://pythonscraping.com/pages/files/form2.html</em></a></em>. The form on the page has the following markup:</p>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting">&#13;
<code class="p">&lt;</code><code class="nt">form</code> <code class="na">action</code><code class="o">=</code><code class="s">"processing2.php"</code> <code class="na">method</code><code class="o">=</code><code class="s">"post"</code> <code class="na">enctype</code><code class="o">=</code><code class="s">"multipart/form-data"</code><code class="p">&gt;</code>&#13;
  Submit a jpg, png, or gif: <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"file"</code> <code class="na">name</code><code class="o">=</code><code class="s">"uploadFile"</code><code class="p">&gt;&lt;</code><code class="nt">br</code><code class="p">&gt;</code>&#13;
  <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"submit"</code> <code class="na">value</code><code class="o">=</code><code class="s">"Upload File"</code><code class="p">&gt;</code>&#13;
<code class="p">&lt;/</code><code class="nt">form</code><code class="p">&gt;</code></pre>&#13;
&#13;
<p>Except for the <code>&lt;input&gt;</code> tag having the type attribute <code>file</code>, it looks essentially the same as the text-based forms used in the previous examples. Fortunately, the way the forms are used by the Python Requests library is also similar:</p>&#13;
&#13;
<pre data-code-language="python" data-type="programlisting">&#13;
<code class="kn">import</code> <code class="nn">requests</code>&#13;
&#13;
<code class="n">files</code> <code class="o">=</code> <code class="p">{</code><code class="s1">'uploadFile'</code><code class="p">:</code> <code class="nb">open</code><code class="p">(</code><code class="s1">'files/python.png'</code><code class="p">,</code> <code class="s1">'rb'</code><code class="p">)}</code>&#13;
<code class="n">r</code> <code class="o">=</code> <code class="n">requests</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s1">'http://pythonscraping.com/pages/files/processing2.php'</code><code class="p">,</code> &#13;
                  <code class="n">files</code><code class="o">=</code><code class="n">files</code><code class="p">)</code>&#13;
<code class="nb">print</code><code class="p">(</code><code class="n">r</code><code class="o">.</code><code class="n">text</code><code class="p">)</code></pre>&#13;
&#13;
<p class="pagebreak-before">Note that in lieu of a simple string, the value submitted to the form field (with the name <code>uploadFile</code>) is now a Python File object, as returned by the <code>open</code> function. In this example, you’re submitting an image file, stored on your local machine, at the path <em>../files/Python-logo.png</em>, relative to where the Python script is being <a contenteditable="false" data-primary="files" data-secondary="uploading" data-startref="flpld" data-type="indexterm" id="id705"/><a contenteditable="false" data-primary="images" data-secondary="uploading" data-startref="mgpld" data-type="indexterm" id="id706"/>run from.</p>&#13;
&#13;
<p>Yes, it’s really that easy!</p>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Handling Logins and Cookies" data-type="sect1"><div class="sect1" id="handling_logins_cookies">&#13;
<h1>Handling Logins and Cookies</h1>&#13;
&#13;
<p>So far, we’ve mostly discussed forms that allow you to submit information to a site or let you view needed <a contenteditable="false" data-primary="logins" data-secondary="cookies and" data-type="indexterm" id="lgnck"/><a contenteditable="false" data-primary="cookies" data-secondary="logins and" data-type="indexterm" id="cksgas"/>information on the page immediately after the form. How is this different from a login form, which lets you exist in a permanent “logged-in” state throughout your visit to the site?</p>&#13;
&#13;
<p>Most modern websites use cookies to keep track of who is logged in and who is not. After a site authenticates your login credentials, it stores them in your browser’s cookie, which usually contains a server-generated token, timeout, and tracking information. The site then uses this cookie as a sort of proof of authentication, which is shown to each page you visit during your time on the site. Before the widespread use of cookies in the mid-1990s, keeping users securely authenticated and tracking them was a huge problem for websites.</p>&#13;
&#13;
<p>Although cookies are a great solution for web developers, they can be problematic for web scrapers. You can submit a login form all day long, but if you don’t keep track of the cookie the form sends back to you afterward, the next page you visit will act as though you’ve never logged in at all.</p>&#13;
&#13;
<p>I’ve created a simple login form at <a href="http://pythonscraping.com/pages/cookies/login.html"><em>http://pythonscraping.com/pages/cookies/login.html</em></a> (the username can be anything, but the password must be “password”). This form is processed at <em><a href="http://pythonscraping.com/pages/cookies/welcome.php"><em class="hyperlink">http://pythonscraping.com/pages/cookies/welcome.php</em></a></em>, which contains a link to the main page, <em><a href="http://pythonscraping.com/pages/cookies/profile.php"><em class="hyperlink">http://pythonscraping.com/pages/cookies/profile.php</em></a></em>.</p>&#13;
&#13;
<p>If you attempt to access the welcome page or the profile page without logging in first, you’ll get an error message and instructions to log in first before continuing. On the profile page, a check is done on your browser’s cookies to see whether its cookie was set on the login page.</p>&#13;
&#13;
<p>Keeping track of cookies <a contenteditable="false" data-primary="Requests library" data-secondary="cookies" data-type="indexterm" id="id707"/><a contenteditable="false" data-primary="cookies" data-secondary="Requests library" data-type="indexterm" id="id708"/>is easy with the &gt;Requests library:</p>&#13;
&#13;
<pre data-code-language="python" data-executable="true" data-type="programlisting">&#13;
<code class="kn">import</code> <code class="nn">requests</code>&#13;
&#13;
<code class="n">params</code> <code class="o">=</code> <code class="p">{</code><code class="s1">'username'</code><code class="p">:</code> <code class="s1">'Ryan'</code><code class="p">,</code> <code class="s1">'password'</code><code class="p">:</code> <code class="s1">'password'</code><code class="p">}</code>&#13;
<code class="n">r</code> <code class="o">=</code> <code class="n">requests</code><code class="o">.</code><code class="n">post</code><code class="p">(</code>&#13;
    <code class="s1">'https://pythonscraping.com/pages/cookies/welcome.php'</code><code class="p">,</code>&#13;
    <code class="n">params</code><code class="p">)</code>&#13;
<code class="nb">print</code><code class="p">(</code><code class="n">r</code><code class="o">.</code><code class="n">text</code><code class="p">)</code>&#13;
&#13;
<code class="nb">print</code><code class="p">(</code><code class="s1">'Cookie is set to:'</code><code class="p">)</code>&#13;
<code class="nb">print</code><code class="p">(</code><code class="n">r</code><code class="o">.</code><code class="n">cookies</code><code class="o">.</code><code class="n">get_dict</code><code class="p">())</code>&#13;
<code class="nb">print</code><code class="p">(</code><code class="s1">'Going to profile page...'</code><code class="p">)</code>&#13;
<code class="n">r</code> <code class="o">=</code> <code class="n">requests</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s1">'https://pythonscraping.com/pages/cookies/profile.php'</code><code class="p">,</code> &#13;
                 <code class="n">cookies</code><code class="o">=</code><code class="n">r</code><code class="o">.</code><code class="n">cookies</code><code class="p">)</code>&#13;
<code class="nb">print</code><code class="p">(</code><code class="n">r</code><code class="o">.</code><code class="n">text</code><code class="p">)</code>&#13;
</pre>&#13;
&#13;
<p>Here you’re sending the login parameters to the welcome page, which acts as the processor for the login form. You retrieve the cookies from the results of the last request, print the result for verification, and then send them to the profile page by setting the <code>cookies</code> argument.</p>&#13;
&#13;
<p>This works well for simple situations, but what if you’re dealing with a more complicated site that frequently modifies cookies without warning, or if you’d rather not even think about the cookies to begin with? The Requests <code>session</code> function works perfectly in this case:</p>&#13;
&#13;
<pre data-code-language="python" data-executable="true" data-type="programlisting">&#13;
<code class="n">session</code> <code class="o">=</code> <code class="n">requests</code><code class="o">.</code><code class="n">Session</code><code class="p">()</code>&#13;
&#13;
<code class="n">params</code> <code class="o">=</code> <code class="p">{</code><code class="s1">'username'</code><code class="p">:</code> <code class="s1">'Ryan'</code><code class="p">,</code> <code class="s1">'password'</code><code class="p">:</code> <code class="s1">'password'</code><code class="p">}</code>&#13;
<code class="n">s</code> <code class="o">=</code> <code class="n">session</code><code class="o">.</code><code class="n">post</code><code class="p">(</code><code class="s1">'https://pythonscraping.com/pages/cookies/welcome.php'</code><code class="p">,</code> <code class="n">params</code><code class="p">)</code>&#13;
<code class="nb">print</code><code class="p">(</code><code class="s1">'Cookie is set to:'</code><code class="p">)</code>&#13;
<code class="nb">print</code><code class="p">(</code><code class="n">s</code><code class="o">.</code><code class="n">cookies</code><code class="o">.</code><code class="n">get_dict</code><code class="p">())</code>&#13;
<code class="nb">print</code><code class="p">(</code><code class="s1">'Going to profile page...'</code><code class="p">)</code>&#13;
<code class="n">s</code> <code class="o">=</code> <code class="n">session</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s1">'https://pythonscraping.com/pages/cookies/profile.php'</code><code class="p">)</code>&#13;
<code class="nb">print</code><code class="p">(</code><code class="n">s</code><code class="o">.</code><code class="n">text</code><code class="p">)</code>&#13;
</pre>&#13;
&#13;
<p>In this case, the session object (retrieved by calling <code>requests.Session()</code>) keeps track of session information, such as cookies, headers, and even information about protocols you might be running on top of HTTP, such as HTTPAdapters.</p>&#13;
&#13;
<p>Requests is a fantastic library, second perhaps only to Selenium (covered in <a data-type="xref" href="ch14.html#c-14">Chapter 14</a>) in the completeness of what it handles without programmers having to think about it or write the code themselves. Although it might be tempting to sit back and let the library do all the work, it’s extremely important always to be aware of what the cookies look like and what they are controlling when you are writing web scrapers. It could save many hours of painful debugging or figuring out why a website is behaving strangely!</p>&#13;
&#13;
<section data-pdf-bookmark="HTTP Basic Access Authentication" data-type="sect2"><div class="sect2" id="id82">&#13;
<h2>HTTP Basic Access Authentication</h2>&#13;
&#13;
<p>Before the advent of cookies, one <a contenteditable="false" data-primary="HTTP (HyperText Transfer Protocol)" data-secondary="basic access authentication" data-type="indexterm" id="yxfput"/><a contenteditable="false" data-primary="basic access authentication" data-type="indexterm" id="bsccstt"/><a contenteditable="false" data-primary="authentication, HTTP" data-type="indexterm" id="auuct"/>popular way to handle logins was with HTTP <em>basic access authentication</em>. You still see it from time to time, especially on high-security or corporate sites, and with some APIs. I’ve created a page at <a href="http://pythonscraping.com/pages/auth/login.php"><em>http://pythonscraping.com/pages/auth/login.php</em></a> that has this type of authentication (<a data-type="xref" href="#basic_access">Figure 13-3</a>).</p>&#13;
&#13;
<figure><div class="figure" id="basic_access"><img alt="Alt Text" class="iimagesbasicaccessauthenticationpng" src="assets/wsp3_1303.png"/>&#13;
<h6><span class="label">Figure 13-3. </span>The user must provide a username and password to get to the page protected by basic access authentication</h6>&#13;
</div></figure>&#13;
&#13;
<p>As usual with these examples, you can log in with any username, but the password must be “password.”</p>&#13;
&#13;
<p>The Requests package contains an <code>auth</code> module specifically designed to handle HTTP authentication:</p>&#13;
&#13;
<pre class="fse fs" data-code-language="python" data-type="programlisting">&#13;
<code class="kn">import</code> <code class="nn">requests</code>&#13;
<code class="kn">from</code> <code class="nn">requests.auth</code> <code class="kn">import</code> <code class="n">AuthBase</code>&#13;
<code class="kn">from</code> <code class="nn">requests.auth</code> <code class="kn">import</code> <code class="n">HTTPBasicAuth</code>&#13;
&#13;
<code class="n">auth</code> <code class="o">=</code> <code class="n">HTTPBasicAuth</code><code class="p">(</code><code class="s1">'ryan'</code><code class="p">,</code> <code class="s1">'password'</code><code class="p">)</code>&#13;
<code class="n">r</code> <code class="o">=</code> <code class="n">requests</code><code class="o">.</code><code class="n">post</code><code class="p">(</code>&#13;
    <code class="n">url</code><code class="o">=</code><code class="s1">'https://pythonscraping.com/pages/auth/login.php'</code><code class="p">,</code> <code class="n">auth</code><code class="o">=</code><code class="n">auth</code><code class="p">)</code>&#13;
<code class="nb">print</code><code class="p">(</code><code class="n">r</code><code class="o">.</code><code class="n">text</code><code class="p">)</code>&#13;
</pre>&#13;
&#13;
<p>Although this appears to be a normal <code>POST</code> request, an <code>HTTPBasicAuth</code> object is passed as the <code>auth</code> argument in the request. The resulting text will be the <a contenteditable="false" data-primary="logins" data-secondary="cookies and" data-startref="lgnck" data-type="indexterm" id="id709"/><a contenteditable="false" data-primary="cookies" data-secondary="logins and" data-startref="cksgas" data-type="indexterm" id="id710"/><a contenteditable="false" data-primary="HTTP (HyperText Transfer Protocol)" data-secondary="basic access authentication" data-startref="yxfput" data-type="indexterm" id="id711"/><a contenteditable="false" data-primary="basic access authentication" data-startref="bsccstt" data-type="indexterm" id="id712"/><a contenteditable="false" data-primary="authentication, HTTP" data-startref="auuct" data-type="indexterm" id="id713"/>page protected by the username and password (or an Access Denied page, if the request failed).</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
<section data-pdf-bookmark="Other Form Problems" data-type="sect1"><div class="sect1" id="id83">&#13;
<h1>Other Form Problems</h1>&#13;
&#13;
<p>Web forms are a hot point of <a contenteditable="false" data-primary="forms" data-secondary="bots and" data-type="indexterm" id="id714"/>entry for malicious bots. You don’t want bots creating user accounts, taking up valuable server processing time, or submitting spam comments on a blog. For this reason, security features often are incorporated into HTML forms on modern websites that might not be immediately apparent.</p>&#13;
&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>For help with CAPTCHAs, <a contenteditable="false" data-primary="CAPTCHAs" data-type="indexterm" id="id715"/><a contenteditable="false" data-primary="forms" data-secondary="CAPTCHAs" data-type="indexterm" id="id716"/>check out <a data-type="xref" href="ch16.html#c-16">Chapter 16</a>, which covers image processing and text recognition in Python.</p>&#13;
</div>&#13;
&#13;
<p>If you encounter a mysterious error, or the server is rejecting your form submission for an unknown reason, check out <a data-type="xref" href="ch17.html#c-17">Chapter 17</a>, which covers honeypots, hidden fields, and other security measures that websites take to protect their forms.</p>&#13;
</div></section>&#13;
</div></section></body></html>