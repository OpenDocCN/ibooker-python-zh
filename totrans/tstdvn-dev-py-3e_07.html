<html><head></head><body>
<div id="sbo-rt-content"><section data-pdf-bookmark="Chapter 3. Testing a Simple Home Page with &#10;Unit Tests" data-type="chapter" epub:type="chapter"><div class="chapter" id="chapter_unit_test_first_view">
<h1><span class="label">Chapter 3. </span>Testing a Simple Home Page with 
<span class="keep-together">Unit Tests</span></h1>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id233">
<h1>A Note for Early Release Readers</h1>
<p>With Early Release ebooks, you get books in their earliest form—the author’s raw and unedited content as they write—so you can take advantage of these technologies long before the official release of these titles.</p>
<p>This will be the 3rd chapter of the final book. The GitHub repo is available at <a class="bare" href="https://github.com/hjwp/book-example"><em class="hyperlink">https://github.com/hjwp/book-example</em></a>.</p>
<p>If you have comments about how we might improve the content and/or examples in this book, or if you notice missing material within this chapter, please reach out to the author at <a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a>.</p>
</div></aside>
<p>We finished the last chapter with a functional test failing,
telling us that it wanted the home page for our site to have “To-Do” in its title.
It’s time to start working on our application.
In this chapter, we’ll build our first HTML page, find out about URL handling,
and creating responses to HTTP requests with Django’s view functions.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id234">
<h1>Warning: Things Are About to Get Real</h1>
<p>The first two chapters were intentionally nice and light.  From now on, we
get into some more meaty coding.  Here’s a prediction:  at some point, things
are going to go wrong.  You’re going to see different results from what I say
you should see. This is a Good Thing, because it will be a genuine
character-building Learning Experience™.</p>
<p>One possibility is that I’ve given some ambiguous explanations, and you’ve
done something different from what I intended. Step back and have a think about
what we’re trying to achieve at this point in the book. Which file are we
editing, what do we want the user to be able to do, what are we testing and
why?  It may be that you’ve edited the wrong file or function, or are running
the wrong tests.  I reckon you’ll learn more about TDD from these “stop and think”
moments than you do from all the times when following instructions and
copy-pasting goes smoothly.</p>
<p>Or it may be a real bug. Be tenacious, read the error message carefully
(see <a data-type="xref" href="#reading_tracebacks">“Reading Tracebacks”</a> a little later on in the chapter),
and you’ll get to the bottom of it.
It’s probably just a missing comma,
or trailing slash, or maybe a missing <em>s</em> in one of the Selenium find methods.
But, as Zed Shaw memorably insisted in
<a href="https://learnpythonthehardway.org/">Learn Python The Hard Way</a>,
this kind of debugging is also an absolutely vital part of learning,
so do stick it out!</p>
<p><a data-primary="Test-Driven Development (TDD)" data-secondary="additional resources" data-type="indexterm" id="id235"/>
<a data-primary="getting help" data-type="indexterm" id="id236"/>
You can always drop me an email (or try the
<a href="https://groups.google.com/forum/#!forum/obey-the-testing-goat-book">Google
Group</a>) if you get really stuck.  Happy debugging!</p>
</div></aside>
<section data-pdf-bookmark="Our First Django App, and Our First Unit Test" data-type="sect1"><div class="sect1" id="id73">
<h1>Our First Django App, and Our First Unit Test</h1>
<p><a data-primary="Django framework" data-secondary="code structure in" data-type="indexterm" id="id237"/>
<a data-primary="Django framework" data-secondary="unit testing in" data-type="indexterm" id="DJFunit03"/>
Django encourages you to structure your code into <em>apps</em>: the theory is that
one project can have many apps, you can use third-party apps developed by other
people, and you might even reuse one of your own apps in a different
project…​although I admit I’ve never actually managed it myself!  Still, apps
are a good way to keep your code organised.</p>
<p>Let’s start an app for our to-do lists:</p>
<pre data-type="programlisting">$ <strong>python manage.py startapp lists</strong></pre>
<p>That will create a folder called <em>lists</em>, next to <em>manage.py</em> and the existing
<em>superlists</em> folder, and within it a number of placeholder files for things
like models, views, and, of immediate interest to us, tests:</p>
<pre data-type="programlisting">.
├── db.sqlite3
├── functional_tests.py
├── lists
│   ├── __init__.py
│   ├── admin.py
│   ├── apps.py
│   ├── migrations
│   │   └── __init__.py
│   ├── models.py
│   ├── tests.py
│   └── views.py
├── manage.py
└── superlists
    ├── __init__.py
    ├── asgi.py
    ├── settings.py
    ├── urls.py
    └── wsgi.py</pre>
</div></section>
<section data-pdf-bookmark="Unit Tests, and How They Differ from Functional Tests" data-type="sect1"><div class="sect1" id="id74">
<h1>Unit Tests, and How They Differ from Functional Tests</h1>
<p><a data-primary="unit tests" data-secondary="vs. functional tests" data-secondary-sortas="functional tests" data-type="indexterm" id="id238"/>
<a data-primary="functional tests (FTs)" data-secondary="vs. unit tests" data-secondary-sortas="unit tests" data-type="indexterm" id="id239"/>
As with so many of the labels we put on things,
the line between unit tests and functional tests can become a little blurry at times.
The basic distinction, though, is that
functional tests test the application from the outside, from the user’s point of view.
Unit tests test the application from the inside, from the programmer’s point of view.</p>
<p>The TDD approach I’m demonstrating uses both types of test
to drive the development of our application, and ensure its correctness.
Our workflow will look a bit like this:</p>
<ol>
<li>
<p>We start by writing a <em>functional test</em>, describing a typical
example of our new functionality from the user’s point of view.</p>
</li>
<li>
<p>Once we have a functional test that fails,
we start to think about how to write code that can get it to pass
(or at least to get past its current failure).
We now use one or more <em>unit tests</em> to define
how we want our code to behave—​the idea is that
each line of production code we write should be tested
by (at least) one of our unit tests.</p>
</li>
<li>
<p>Once we have a failing unit test,
we write the smallest amount of <em>application code</em> we can,
just enough to get the unit test to pass.
We may iterate between steps 2 and 3 a few times,
until we think the functional test will get a little further.</p>
</li>
<li>
<p>Now we can rerun our functional tests and see if they pass,
or get a little further.
That may prompt us to write some new unit tests,
and some new code, and so on.</p>
</li>
<li>
<p>Once we’re comfortable that the core functionality works end-to-end,
we can extend out to cover more permutations and edge cases,
using just unit tests now.</p>
</li>
</ol>
<p>You can see that, all the way through,
the functional tests are driving what development we do from a high level,
while the unit tests drive what we do at a low level.</p>
<p>The functional tests don’t aim to cover every single tiny detail of our
app’s behaviour, they are there to reassure us that everything is wired up correctly.
The unit tests are there to exhaustively check all the lower level details and corner cases.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Functional tests should help you build an application that actually works,
    and guarantee you never accidentally break it.
    Unit tests should help you to write code that’s clean and bug free.</p>
</div>
<p>Enough theory for now—let’s see how it looks in practice.</p>
<table id="fts_vs_unit_tests_table">
<caption><span class="label">Table 3-1. </span>FTs vs Unit Tests</caption>
<thead>
<tr>
<th>FTs</th>
<th>Unit Tests</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>One test per feature / user story</p></td>
<td><p>Many tests per feature</p></td>
</tr>
<tr>
<td><p>Test from the user’s point of view</p></td>
<td><p>Test the code, ie the programmer’s point of view</p></td>
</tr>
<tr>
<td><p>Can test that the UI “really” works</p></td>
<td><p>Tests the internals, individual functions or classes</p></td>
</tr>
<tr>
<td><p>Provides confidence that everything is wired together correctly, works end-to-end</p></td>
<td><p>Can exhaustively check permutations, details, edge cases</p></td>
</tr>
</tbody>
</table>
</div></section>
<section data-pdf-bookmark="Unit Testing in Django" data-type="sect1"><div class="sect1" id="id89">
<h1>Unit Testing in Django</h1>
<p><a data-primary="unit tests" data-secondary="in Django" data-secondary-sortas="Django" data-tertiary="writing basic" data-type="indexterm" id="UTdjango03"/>
Let’s see how to write a unit test for our home page view.
Open up the new file at <em>lists/tests.py</em>, and you’ll see something like this:</p>
<div class="sourcecode currentcontents" data-type="example">
<p>lists/tests.py</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">django.test</code> <code class="kn">import</code> <code class="n">TestCase</code>

<code class="c1"># Create your tests here.</code></pre></div>
<p>Django has helpfully suggested we use a special version of <code>TestCase</code>, which
it provides. It’s an augmented version of the standard <code>unittest.TestCase</code>,
with some additional Django-specific features, which we’ll discover over the
next few chapters.</p>
<p>You’ve already seen that the TDD cycle involves starting with a test that
fails, then writing code to get it to pass. Well, before we can even get that
far, we want to know that the unit test we’re writing will definitely be
run by our automated test runner, whatever it is.  In the case of
<em>functional_tests.py</em>, we’re running it directly, but this file made by Django
is a bit more like magic. So, just to make sure, let’s make a deliberately
silly failing test:</p>
<div class="sourcecode" data-type="example">
<p>lists/tests.py (ch03l002)</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">django.test</code> <code class="kn">import</code> <code class="n">TestCase</code>


<code class="k">class</code> <code class="nc">SmokeTest</code><code class="p">(</code><code class="n">TestCase</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf">test_bad_maths</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertEqual</code><code class="p">(</code><code class="mi">1</code> <code class="o">+</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">3</code><code class="p">)</code></pre></div>
<p>Now let’s invoke this mysterious Django test runner. As usual, it’s a
<em>manage.py</em>
<span class="keep-together">command</span>:</p>
<pre data-type="programlisting">$ <strong>python manage.py test</strong>
Creating test database for alias 'default'...
Found 1 test(s).
System check identified no issues (0 silenced).
F
======================================================================
FAIL: test_bad_maths (lists.tests.SmokeTest.test_bad_maths)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...goat-book/lists/tests.py", line 6, in test_bad_maths
    self.assertEqual(1 + 1, 3)
AssertionError: 2 != 3

 ---------------------------------------------------------------------
Ran 1 test in 0.001s

FAILED (failures=1)
Destroying test database for alias 'default'...</pre>
<p>Excellent.  The machinery seems to be working. This is a good point for a
commit:</p>
<pre data-type="programlisting">$ <strong>git status</strong>  # should show you lists/ is untracked
$ <strong>git add lists</strong>
$ <strong>git diff --staged</strong>  # will show you the diff that you're about to commit
$ <strong>git commit -m "Add app for lists, with deliberately failing unit test"</strong></pre>
<p>As you’ve no doubt guessed,
the <code>-m</code> flag lets you pass in a commit message at the command line,
so you don’t need to use an editor.
It’s up to you to pick the way you like to use the Git command line;
I’ll just show you the main ones I’ve seen used.
For me the main big of VCS hygiene is:
<em>make sure you always review what you’re about to commit before you do it</em>.</p>
</div></section>
<section data-pdf-bookmark="Django’s MVC, URLs, and View Functions" data-type="sect1"><div class="sect1" id="id18">
<h1>Django’s MVC, URLs, and View Functions</h1>
<p><a data-primary="Model-View-Controller (MVC) pattern" data-type="indexterm" id="id240"/>
Django is structured along a classic <em>Model-View-Controller</em> (MVC) pattern.
Well, <em>broadly</em>.
It definitely does have models,
but what Django calls views are really controllers,
and the view part is actually provided by the templates,
but you can see the general idea is there!</p>
<p>If you’re interested, you can look up the finer points of the discussion
<a href="https://docs.djangoproject.com/en/4.2/faq/general/#django-appears-to-be-a-mvc-framework-but-you-call-the-controller-the-view-and-the-view-the-template-how-come-you-don-t-use-the-standard-names">in the Django FAQs</a>.</p>
<p>Irrespective of any of that, as with any web server, Django’s main job is to
decide what to do when a user asks for a particular URL on our site.
Django’s workflow goes something like this:</p>
<ol>
<li>
<p>An HTTP <em>request</em> comes in for a particular <em>URL</em>.</p>
</li>
<li>
<p>Django uses some rules to decide which <em>view</em> function should deal with
the request (this is referred to as <em>resolving</em> the URL).</p>
</li>
<li>
<p>The view function processes the request and returns an HTTP <em>response</em>.</p>
</li>
</ol>
<p>So, we want to test two things:</p>
<ul>
<li>
<p>Can we make this view function return the HTML we need?</p>
</li>
<li>
<p>Can we tell Django to use this view function
when we make a request for the root of the site (“/”)?</p>
</li>
</ul>
<p>Let’s start with the first.</p>
</div></section>
<section data-pdf-bookmark="Unit Testing a View" data-type="sect1"><div class="sect1" id="id90">
<h1>Unit Testing a View</h1>
<p><a data-primary="unit tests" data-secondary="in Django" data-secondary-sortas="Django" data-tertiary="unit testing a view" data-type="indexterm" id="id241"/>
Open up <em>lists/tests.py</em>, and change our silly test to something like this:</p>
<div class="sourcecode" data-type="example">
<p>lists/tests.py (ch03l003)</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code><code> </code><code class="nn">django</code><code class="nn">.</code><code class="nn">test</code><code> </code><code class="kn">import</code><code> </code><code class="n">TestCase</code><code>
</code><code class="kn">from</code><code> </code><code class="nn">django</code><code class="nn">.</code><code class="nn">http</code><code> </code><code class="kn">import</code><code> </code><code class="n">HttpRequest</code><code>  </code><a class="co" href="#callout_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO1-1" id="co_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code class="kn">from</code><code> </code><code class="nn">lists</code><code class="nn">.</code><code class="nn">views</code><code> </code><code class="kn">import</code><code> </code><code class="n">home_page</code><code>
</code><code>
</code><code>
</code><code class="k">class</code><code> </code><code class="nc">HomePageTest</code><code class="p">(</code><code class="n">TestCase</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">test_home_page_returns_correct_html</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="n">request</code><code> </code><code class="o">=</code><code> </code><code class="n">HttpRequest</code><code class="p">(</code><code class="p">)</code><code>  </code><a class="co" href="#callout_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO1-1" id="co_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO1-2"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code>        </code><code class="n">response</code><code> </code><code class="o">=</code><code> </code><code class="n">home_page</code><code class="p">(</code><code class="n">request</code><code class="p">)</code><code>  </code><a class="co" href="#callout_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO1-2" id="co_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO1-3"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
</code><code>        </code><code class="n">html</code><code> </code><code class="o">=</code><code> </code><code class="n">response</code><code class="o">.</code><code class="n">content</code><code class="o">.</code><code class="n">decode</code><code class="p">(</code><code class="s2">"</code><code class="s2">utf8</code><code class="s2">"</code><code class="p">)</code><code>  </code><a class="co" href="#callout_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO1-3" id="co_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO1-4"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">assertIn</code><code class="p">(</code><code class="s2">"</code><code class="s2">&lt;title&gt;To-Do lists&lt;/title&gt;</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">html</code><code class="p">)</code><code>  </code><a class="co" href="#callout_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO1-4" id="co_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO1-5"><img alt="4" height="12" src="assets/4.png" width="12"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">assertTrue</code><code class="p">(</code><code class="n">html</code><code class="o">.</code><code class="n">startswith</code><code class="p">(</code><code class="s2">"</code><code class="s2">&lt;html&gt;</code><code class="s2">"</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO1-5" id="co_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO1-6"><img alt="5" height="12" src="assets/5.png" width="12"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">assertTrue</code><code class="p">(</code><code class="n">html</code><code class="o">.</code><code class="n">endswith</code><code class="p">(</code><code class="s2">"</code><code class="s2">&lt;/html&gt;</code><code class="s2">"</code><code class="p">)</code><code class="p">)</code><code>  </code><a class="co" href="#callout_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO1-5" id="co_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO1-7"><img alt="5" height="12" src="assets/5.png" width="12"/></a></pre></div>
<p>What’s going on in this new test?
Well, remember, a view function takes an HTTP request as input,
and produces an HTTP response.
So, to test that:</p>
<dl class="calloutlist">
<dt><a class="co" href="#co_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO1-1" id="callout_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>We import the <code>HttpRequest</code> class
so that we can then create a request object within our test.
This is the kind of object that Django will create when a user’s browser asks for a page.</p></dd>
<dt><a class="co" href="#co_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO1-3" id="callout_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO1-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>We pass the <code>HttpRequest</code> object to our <code>home_page</code> view,
which gives us a response.
You won’t be surprised to hear that the response is an instance
of a class called <code>HttpResponse</code>.</p></dd>
<dt><a class="co" href="#co_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO1-4" id="callout_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO1-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Then, we extract the <code>.content</code> of the response.
These are the raw bytes,
the ones and zeros that would be sent down the wire to the user’s browser.
We call <code>.decode()</code> to convert them into the string of HTML that’s being sent to the user.</p></dd>
<dt><a class="co" href="#co_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO1-5" id="callout_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO1-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>Now we can make some assertions: we know we want an html <code>&lt;title&gt;</code> tag somewhere in there,
with the words “To-Do lists” in it—​because
that’s what we specified in our functional test.</p></dd>
<dt><a class="co" href="#co_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO1-6" id="callout_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO1-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a></dt>
<dd><p>And we can do a vague sanity check that it’s valid html, by checking
that it starts with an <code>&lt;html&gt;</code> tag which gets closed at the end.</p></dd>
</dl>
<p>So, what do you think will happen when we run the tests?</p>
<pre data-type="programlisting">$ <strong>python manage.py test</strong>
Found 1 test(s).
System check identified no issues (0 silenced).
E
======================================================================
ERROR: lists.tests (unittest.loader._FailedTest.lists.tests)
 ---------------------------------------------------------------------
ImportError: Failed to import test module: lists.tests
Traceback (most recent call last):
[...]
  File "...goat-book/lists/tests.py", line 3, in &lt;module&gt;
    from lists.views import home_page
ImportError: cannot import name 'home_page' from 'lists.views'</pre>
<p>It’s a very predictable and uninteresting error: we tried to import something
we haven’t even written yet. But it’s still good news—​for the purposes of
TDD, an exception which was predicted counts as an expected failure.
Since we have both a failing functional test and a failing unit test, we have
the Testing Goat’s full blessing to code away.</p>
<section data-pdf-bookmark="At Last! We Actually Write Some Application Code!" data-type="sect2"><div class="sect2" id="id136">
<h2>At Last! We Actually Write Some Application Code!</h2>
<p>It is exciting, isn’t it?
Be warned, TDD means that long periods of anticipation are only defused very gradually,
and by tiny increments.
Especially since we’re learning and only just starting out,
we only allow ourselves to change (or add) one line of code at a time—​and each time,
we make just the minimal change required to address the current test failure.</p>
<p>I’m being deliberately extreme here, but what’s our current test failure?
We can’t import <code>home_page</code> from <code>lists.views</code>?
OK, let’s fix that—​and only that.
In <em>lists/views.py</em>:</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch03l004)</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">django.shortcuts</code> <code class="kn">import</code> <code class="n">render</code>

<code class="c1"># Create your views here.</code>
<code class="n">home_page</code> <code class="o">=</code> <code class="kc">None</code></pre></div>
<p><em>“You must be joking!”</em> I can hear you say.</p>
<p>I can hear you because it’s what I used to say (with feeling)
when my colleagues first demonstrated TDD to me.
Well, bear with me,
and we’ll talk about whether or not this is all taking it too far in a little while.
But for now, let yourself follow along, even if it’s with some exasperation,
and see if our tests can help us write the correct code,
one tiny step at a time.</p>
<p>Let’s run the tests again:</p>
<pre data-type="programlisting">[...]
  File "...goat-book/lists/tests.py", line 9, in
test_home_page_returns_correct_html
    response = home_page(request)
               ^^^^^^^^^^^^^^^^^^
TypeError: 'NoneType' object is not callable</pre>
<p>We still get an error, but it’s moved on a bit.
Instead of an import error,
our tests are telling us that our <code>home_page</code> “function” is not callable.
That gives us a justification for
changing it from being <code>None</code> to being an actual function. At the very smallest
level of detail, every single code change can be driven by the tests!</p>
<p>Back in <em>lists/views.py</em>:</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch03l005)</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">django.shortcuts</code> <code class="kn">import</code> <code class="n">render</code>


<code class="k">def</code> <code class="nf">home_page</code><code class="p">():</code>
    <code class="k">pass</code></pre></div>
<p>Again, we’re making the smallest, dumbest change we can possibly make,
that addresses precisely the current test failure.  Our tests wanted
something callable, so we gave them the simplest possible callable thing,
a function that takes no arguments and returns nothing.</p>
<p>Let’s run the tests again and see what they think:</p>
<pre data-type="programlisting">    response = home_page(request)
               ^^^^^^^^^^^^^^^^^^
TypeError: home_page() takes 0 positional arguments but 1 was given</pre>
<p>Once more, our error message has changed slightly,
and is guiding us towards fixing the next thing that’s wrong.</p>
</div></section>
<section data-pdf-bookmark="The Unit-Test/Code Cycle" data-type="sect2"><div class="sect2" id="id19">
<h2>The Unit-Test/Code Cycle</h2>
<p><a data-primary="unit tests" data-secondary="in Django" data-secondary-sortas="Django" data-tertiary="unit-test/code cycle" data-type="indexterm" id="id242"/>
<a data-primary="unit-test/code cycle" data-type="indexterm" id="id243"/>
<a data-primary="Test-Driven Development (TDD)" data-secondary="concepts" data-tertiary="unit-test/code cycle" data-type="indexterm" id="id244"/>
We can start to settle into the TDD <em>unit-test/code cycle</em> now:</p>
<ol>
<li>
<p>In the terminal, run the unit tests and see how they fail.</p>
</li>
<li>
<p>In the editor, make a minimal code change to address the current test failure.</p>
</li>
</ol>
<p>And repeat!</p>
<p>The more nervous we are about getting our code right, the smaller and more
minimal we make each code change—​the idea is to be absolutely sure that each
bit of code is justified by a test.</p>
<p>This may seem laborious, and at first, it will be.  But once you get into the
swing of things, you’ll find yourself coding quickly even if you take
microscopic steps—​this is how we write all of our production code at work.</p>
<p>Let’s see how fast we can get this cycle going:</p>
<ul>
<li>
<p>Minimal code change:</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch03l006)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">home_page</code><code class="p">(</code><code class="n">request</code><code class="p">):</code>
    <code class="k">pass</code></pre></div>
</li>
<li>
<p>Tests:</p>
<pre data-type="programlisting">    html = response.content.decode("utf8")
           ^^^^^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'content'</pre>
</li>
<li>
<p>Code—​we use <code>django.http.HttpResponse</code>, as predicted:</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch03l007)</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code> <code class="nn">django.http</code> <code class="kn">import</code> <code class="n">HttpResponse</code>


<code class="k">def</code> <code class="nf">home_page</code><code class="p">(</code><code class="n">request</code><code class="p">):</code>
    <code class="k">return</code> <code class="n">HttpResponse</code><code class="p">()</code></pre></div>
</li>
<li>
<p>Tests again:</p>
<pre data-type="programlisting">AssertionError: '&lt;title&gt;To-Do lists&lt;/title&gt;' not found in ''</pre>
</li>
<li>
<p>Code again:</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch03l008)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">home_page</code><code class="p">(</code><code class="n">request</code><code class="p">):</code>
    <code class="k">return</code> <code class="n">HttpResponse</code><code class="p">(</code><code class="s2">"&lt;title&gt;To-Do lists&lt;/title&gt;"</code><code class="p">)</code></pre></div>
</li>
<li>
<p>Tests yet again:</p>
<pre data-type="programlisting">    self.assertTrue(html.startswith("&lt;html&gt;"))
AssertionError: False is not true</pre>
</li>
<li>
<p>Code yet again:</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch03l009)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">home_page</code><code class="p">(</code><code class="n">request</code><code class="p">):</code>
    <code class="k">return</code> <code class="n">HttpResponse</code><code class="p">(</code><code class="s2">"&lt;html&gt;&lt;title&gt;To-Do lists&lt;/title&gt;"</code><code class="p">)</code></pre></div>
</li>
<li>
<p>Tests—​almost there?</p>
<pre data-type="programlisting">    self.assertTrue(html.endswith("&lt;/html&gt;"))
AssertionError: False is not true</pre>
</li>
<li>
<p>Come on, one last effort:</p>
<div class="sourcecode" data-type="example">
<p>lists/views.py (ch03l010)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">def</code> <code class="nf">home_page</code><code class="p">(</code><code class="n">request</code><code class="p">):</code>
    <code class="k">return</code> <code class="n">HttpResponse</code><code class="p">(</code><code class="s2">"&lt;html&gt;&lt;title&gt;To-Do lists&lt;/title&gt;&lt;/html&gt;"</code><code class="p">)</code></pre></div>
</li>
<li>
<p>Surely?</p>
<pre data-type="programlisting">$ <strong>python manage.py test</strong>
Creating test database for alias 'default'...
Found 1 test(s).
System check identified no issues (0 silenced).
.
 ---------------------------------------------------------------------
Ran 1 test in 0.001s

OK
Destroying test database for alias 'default'...</pre>
</li>
</ul>
<p>Hooray! Our first ever unit test pass!  That’s so momentous that I think it’s
worthy of a commit:</p>
<pre data-type="programlisting">$ <strong>git diff</strong>  # should show changes to tests.py, and views.py
$ <strong>git commit -am "First unit test and view function"</strong></pre>
<p>That was the last variation on <code>git commit</code> I’ll show, the <code>a</code> and <code>m</code> flags
together, which adds all changes to tracked files and uses the commit message
from the command line.</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p><code>git commit -am</code> is the quickest formulation, but also gives you the
    least feedback about what’s being committed, so make sure you’ve done a
    <code>git status</code> and a <code>git diff</code> beforehand, and are clear on what changes are
    about to go in.</p>
</div>
</div></section>
</div></section>
<section data-pdf-bookmark="Our functional tests tell us we’re not quite done yet." data-type="sect1"><div class="sect1" id="id20">
<h1>Our functional tests tell us we’re not quite done yet.</h1>
<p>We’ve got our unit test passing,
so let’s go back to running our functional tests to see if we’ve made progress.
Don’t forget to spin up the dev server again, if it’s not still running.</p>
<pre data-type="programlisting">$ <strong>python functional_tests.py</strong>
F
======================================================================
FAIL: test_can_start_a_todo_list
(__main__.NewVisitorTest.test_can_start_a_todo_list)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...goat-book/functional_tests.py", line 18, in
test_can_start_a_todo_list
    self.assertIn("To-Do", self.browser.title)
AssertionError: 'To-Do' not found in 'The install worked successfully!
Congratulations!'

 ---------------------------------------------------------------------
Ran 1 test in 1.609s

FAILED (failures=1)</pre>
<p>Looks like something isn’t quite right.  This is the reason we have functional
tests!</p>
<p>Do you remember at the beginning of the chapter, we said we needed to do two things,
firstly create a view function to produce responses for requests,
and secondly tell the server which functions should respond to which URLs?
Thanks to our FT, we have been reminded that we still need to do the second thing.</p>
<p><a data-primary="Django framework" data-secondary="Test Client" data-type="indexterm" id="DJFtestclient04"/>
<a data-primary="Test Client (Django)" data-type="indexterm" id="testclient04"/>
How can we write a test for URL resolution?
At the moment we just test the view function directly by importing it and calling it.
But we want to test more layers of the Django stack.
Django, like most web frameworks, supplies a tool for doing just that, called the
<a href="https://docs.djangoproject.com/en/4.2/topics/testing/tools/#the-test-client">Django Test Client</a>.</p>
<p>Let’s see how to use it by adding a second, alternative test to our unit tests:</p>
<div class="sourcecode" data-type="example">
<p>lists/tests.py (ch03l011)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">class</code><code> </code><code class="nc">HomePageTest</code><code class="p">(</code><code class="n">TestCase</code><code class="p">)</code><code class="p">:</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">test_home_page_returns_correct_html</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="n">request</code><code> </code><code class="o">=</code><code> </code><code class="n">HttpRequest</code><code class="p">(</code><code class="p">)</code><code>
</code><code>        </code><code class="n">response</code><code> </code><code class="o">=</code><code> </code><code class="n">home_page</code><code class="p">(</code><code class="n">request</code><code class="p">)</code><code>
</code><code>        </code><code class="n">html</code><code> </code><code class="o">=</code><code> </code><code class="n">response</code><code class="o">.</code><code class="n">content</code><code class="o">.</code><code class="n">decode</code><code class="p">(</code><code class="s2">"</code><code class="s2">utf8</code><code class="s2">"</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">assertIn</code><code class="p">(</code><code class="s2">"</code><code class="s2">&lt;title&gt;To-Do lists&lt;/title&gt;</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">html</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">assertTrue</code><code class="p">(</code><code class="n">html</code><code class="o">.</code><code class="n">startswith</code><code class="p">(</code><code class="s2">"</code><code class="s2">&lt;html&gt;</code><code class="s2">"</code><code class="p">)</code><code class="p">)</code><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">assertTrue</code><code class="p">(</code><code class="n">html</code><code class="o">.</code><code class="n">endswith</code><code class="p">(</code><code class="s2">"</code><code class="s2">&lt;/html&gt;</code><code class="s2">"</code><code class="p">)</code><code class="p">)</code><code>
</code><code>
</code><code>    </code><code class="k">def</code><code> </code><code class="nf">test_home_page_returns_correct_html_2</code><code class="p">(</code><code class="bp">self</code><code class="p">)</code><code class="p">:</code><code>
</code><code>        </code><code class="n">response</code><code> </code><code class="o">=</code><code> </code><code class="bp">self</code><code class="o">.</code><code class="n">client</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"</code><code class="s2">/</code><code class="s2">"</code><code class="p">)</code><code>  </code><a class="co" href="#callout_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO2-1" id="co_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO2-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code>        </code><code class="bp">self</code><code class="o">.</code><code class="n">assertContains</code><code class="p">(</code><code class="n">response</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">&lt;title&gt;To-Do lists&lt;/title&gt;</code><code class="s2">"</code><code class="p">)</code><code>  </code><a class="co" href="#callout_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO2-2" id="co_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO2-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></pre></div>
<dl class="calloutlist">
<dt><a class="co" href="#co_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO2-1" id="callout_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO2-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>We can access the tests client via <code>self.client</code>,
which is available on any test that uses <code>django.test.TestCase</code>.
It provides methods like <code>.get()</code> which simulate a browser making http requests,
and take a URL as their first parameter.
We use this instead of manually creating a request object
and calling the view function directly</p></dd>
<dt><a class="co" href="#co_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO2-2" id="callout_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO2-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Django also provides some assertion helpers like <code>assertContains</code>
that save us from having to manually extract and decode response content,
and have some other nice properties besides, as we’ll see.</p></dd>
</dl>
<p>Let’s see how that works:</p>
<pre data-type="programlisting">$ <strong>python manage.py test</strong>
Found 2 test(s).
Creating test database for alias 'default'...
System check identified no issues (0 silenced).
.F
======================================================================
FAIL: test_home_page_returns_correct_html_2
(lists.tests.HomePageTest.test_home_page_returns_correct_html_2)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...goat-book/lists/tests.py", line 17, in
test_home_page_returns_correct_html_2
    self.assertContains(response, "&lt;title&gt;To-Do lists&lt;/title&gt;")
[...]
AssertionError: 404 != 200 : Couldn't retrieve content: Response code was 404
(expected 200)

 ---------------------------------------------------------------------
Ran 2 tests in 0.004s

FAILED (failures=1)
Destroying test database for alias 'default'...</pre>
<p>Hmm, something about 404s?  Let’s dig into it.</p>
</div></section>
<section data-pdf-bookmark="Reading Tracebacks" data-type="sect1"><div class="sect1" id="reading_tracebacks">
<h1>Reading Tracebacks</h1>
<p><a data-primary="tracebacks" data-type="indexterm" id="id245"/>
Let’s spend a moment talking about how to read tracebacks, since it’s something
we have to do a lot in TDD. You soon learn to scan through them and pick up
relevant clues:</p>
<pre data-type="programlisting">======================================================================
FAIL: test_home_page_returns_correct_html_2  <a class="co" href="#callout_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO3-2" id="co_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO3-1"><img alt="2" height="12" src="assets/2.png" width="12"/></a>
(lists.tests.HomePageTest.test_home_page_returns_correct_html_2)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...goat-book/lists/tests.py", line 17, in
test_home_page_returns_correct_html_2
    self.assertContains(response, "&lt;title&gt;To-Do lists&lt;/title&gt;")  <a class="co" href="#callout_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO3-3" id="co_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO3-2"><img alt="3" height="12" src="assets/3.png" width="12"/></a>
  File ".../django/test/testcases.py", line 647, in assertContains
    text_repr, real_count, msg_prefix = self._assert_contains(
                                        ^^^^^^^^^^^^^^^^^^^^^^  <a class="co" href="#callout_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO3-4" id="co_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO3-3"><img alt="4" height="12" src="assets/4.png" width="12"/></a>
  File ".../django/test/testcases.py", line 610, in _assert_contains
    self.assertEqual(
AssertionError: 404 != 200 : Couldn't retrieve content: Response code was 404  <a class="co" href="#callout_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO3-1" id="co_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO3-4"><img alt="1" height="12" src="assets/1.png" width="12"/></a>
(expected 200)

 ---------------------------------------------------------------------
[...]</pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO3-4" id="callout_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO3-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>The first place you look is usually <em>the error itself</em>. Sometimes that’s
all you need to see, and it will let you identify the problem immediately.
But sometimes, like in this case, it’s not quite self-evident.</p></dd>
<dt><a class="co" href="#co_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO3-1" id="callout_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO3-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>The next thing to double-check is: <em>which test is failing?</em> Is it
definitely the one we expected—​that is, the one we just wrote?  In this case,
the answer is yes.</p></dd>
<dt><a class="co" href="#co_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO3-2" id="callout_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO3-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Then we look for the place in <em>our test code</em> that kicked off the failure.
We work our way down from the top of the traceback, looking for the
filename of the tests file, to check which test function, and what line of
code, the failure is coming from.
In this case it’s the line where we call the <code>assertContains</code> method.</p></dd>
<dt><a class="co" href="#co_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO3-3" id="callout_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO3-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>In Python 3.11 and later, you can also look out for the string of carets,
which try to tell you exactly where the exception came from.
This is more useful for unexpected exceptions than for assertion failures
like we have now.</p></dd>
</dl>
<p>There is ordinarily a fifth step, where we look further down for any
of <em>our own application code</em> which was involved with the problem.  In this
case it’s all Django code, but we’ll see plenty of examples of this fifth step
later in the book.</p>
<p>Pulling it all together, we interpret the traceback as telling us that,
when we tried to do our assertion on the content of the response,
Django’s test helpers failed saying that they could not do that, because
the response is an HTML 404 “Not Found” error instead of a normal 200 OK response.</p>
<p>In other words, Django isn’t yet configured to respond to requests for the
root URL (“/”) of our site.  Let’s make that happen now.</p>
</div></section>
<section data-pdf-bookmark="urls.py" data-type="sect1"><div class="sect1" id="id22">
<h1>urls.py</h1>
<p><a data-primary="URL mappings" data-type="indexterm" id="id246"/>
Django uses a file called <em>urls.py</em> to map URLs to view functions. This mapping is also called <em>routing</em>.
There’s a main <em>urls.py</em> for the whole site in the <em>superlists</em> folder.
Let’s go take a look:</p>
<div class="sourcecode currentcontents" data-type="example">
<p>superlists/urls.py</p>
<pre data-code-language="python" data-type="programlisting"><code class="sd">"""</code>
<code class="sd">URL configuration for superlists project.</code>

<code class="sd">The `urlpatterns` list routes URLs to views. For more information please see:</code>
<code class="sd">    https://docs.djangoproject.com/en/4.2/topics/http/urls/</code>
<code class="sd">Examples:</code>
<code class="sd">Function views</code>
<code class="sd">    1. Add an import:  from my_app import views</code>
<code class="sd">    2. Add a URL to urlpatterns:  path('', views.home, name='home')</code>
<code class="sd">Class-based views</code>
<code class="sd">    1. Add an import:  from other_app.views import Home</code>
<code class="sd">    2. Add a URL to urlpatterns:  path('', Home.as_view(), name='home')</code>
<code class="sd">Including another URLconf</code>
<code class="sd">    1. Import the include() function: from django.urls import include, path</code>
<code class="sd">    2. Add a URL to urlpatterns:  path('blog/', include('blog.urls'))</code>
<code class="sd">"""</code>
<code class="kn">from</code> <code class="nn">django.contrib</code> <code class="kn">import</code> <code class="n">admin</code>
<code class="kn">from</code> <code class="nn">django.urls</code> <code class="kn">import</code> <code class="n">path</code>

<code class="n">urlpatterns</code> <code class="o">=</code> <code class="p">[</code>
    <code class="n">path</code><code class="p">(</code><code class="s2">"admin/"</code><code class="p">,</code> <code class="n">admin</code><code class="o">.</code><code class="n">site</code><code class="o">.</code><code class="n">urls</code><code class="p">),</code>
<code class="p">]</code></pre></div>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>If your <em>urls.py</em> looks different or if it mentions a function called
    <code>url()</code> instead of <code>path()</code>, it’s because you’ve got the wrong version of
    Django.  This book is written for Django v4.  Take another look at
    the <a data-type="xref" href="preface02.xhtml#pre-requisites">Prerequisites and Assumptions</a> section and get the right version before you
    go any further.</p>
</div>
<p>As usual, lots of helpful comments and default suggestions from Django.
In fact, that very first example is pretty much exactly what we want!
Let’s use that, with some minor changes.</p>
<div class="sourcecode" data-type="example">
<p>superlists/urls.py (ch03l012)</p>
<pre data-code-language="python" data-type="programlisting"><code class="kn">from</code><code> </code><code class="nn">django</code><code class="nn">.</code><code class="nn">urls</code><code> </code><code class="kn">import</code><code> </code><code class="n">path</code><code>  </code><a class="co" href="#callout_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO4-1" id="co_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO4-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code class="kn">from</code><code> </code><code class="nn">lists</code><code class="nn">.</code><code class="nn">views</code><code> </code><code class="kn">import</code><code> </code><code class="n">home_page</code><code>  </code><a class="co" href="#callout_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO4-2" id="co_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO4-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
</code><code>
</code><code class="n">urlpatterns</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code>
</code><code>    </code><code class="n">path</code><code class="p">(</code><code class="s2">"</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">home_page</code><code class="p">,</code><code> </code><code class="n">name</code><code class="o">=</code><code class="s2">"</code><code class="s2">home</code><code class="s2">"</code><code class="p">)</code><code class="p">,</code><code>  </code><a class="co" href="#callout_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO4-3" id="co_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO4-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code>
</code><code class="p">]</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" href="#co_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO4-1" id="callout_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO4-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>No need to import <code>admin</code> from <code>django.contrib</code>. Django’s admin site is amazing,
but it’s a topic for another book.</p></dd>
<dt><a class="co" href="#co_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO4-2" id="callout_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO4-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>But we will import our home page view function.</p></dd>
<dt><a class="co" href="#co_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO4-3" id="callout_testing_a_simple_home_page_with___span_class__keep_together__unit_tests__span__CO4-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>And we wire it up here, as a <code>path()</code> entry in the <code>urlpatterns</code> global.
Django strips the leading slash from all urls,
so <code>"/url/path/to"</code> becomes <code>"url/path/to"</code>
and the base URL is just the empty string, <code>""</code>.  So this config
says, the “base url should point to our home page view”</p></dd>
</dl>
<p>Now we can run our unit tests again, with <strong><code>python manage.py test</code></strong>:</p>
<pre data-type="programlisting">[...]
..
 ---------------------------------------------------------------------
Ran 2 tests in 0.003s

OK</pre>
<p>Hooray!</p>
<p>Time for a little tidy-up.  We don’t need two separate tests,
let’s move everything out of our low-level test that calls the view
function directly, into the test that uses the Django test client:</p>
<div class="sourcecode" data-type="example">
<p>lists/tests.py (ch03l013)</p>
<pre data-code-language="python" data-type="programlisting"><code class="k">class</code> <code class="nc">HomePageTest</code><code class="p">(</code><code class="n">TestCase</code><code class="p">):</code>
    <code class="k">def</code> <code class="nf">test_home_page_returns_correct_html</code><code class="p">(</code><code class="bp">self</code><code class="p">):</code>
        <code class="n">response</code> <code class="o">=</code> <code class="bp">self</code><code class="o">.</code><code class="n">client</code><code class="o">.</code><code class="n">get</code><code class="p">(</code><code class="s2">"/"</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertContains</code><code class="p">(</code><code class="n">response</code><code class="p">,</code> <code class="s2">"&lt;title&gt;To-Do lists&lt;/title&gt;"</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertContains</code><code class="p">(</code><code class="n">response</code><code class="p">,</code> <code class="s2">"&lt;html&gt;"</code><code class="p">)</code>
        <code class="bp">self</code><code class="o">.</code><code class="n">assertContains</code><code class="p">(</code><code class="n">response</code><code class="p">,</code> <code class="s2">"&lt;/html&gt;"</code><code class="p">)</code></pre></div>
<aside class="pagebreak-before less_space" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id247">
<h1>Why Didn’t We Just Use the Django Test Client All Along?</h1>
<p>You may be asking yourself,
“Why didn’t we just use the Django Test Client from the very beginning?”
In real life, that’s what I would do.
But I wanted to show you the “manual” way of doing it first for a couple of reasons.
Firstly because it allowed me to introduce concepts one by one,
and keep the learning curve as shallow as possible.
Secondly, because you may not always be using Django to build your apps,
and testing tools may not always be available—​but
calling functions directly and examining their responses is always possible!</p>
<p>The Django Test Client does also have disadvantages;
later in the book (in [Link to Come])
we’ll discuss the difference
between fully isolated unit tests
and the “integrated” tests that the test client pushes us towards.
But for now, it’s very much the pragmatic choice.
<a data-primary="" data-startref="testclient04" data-type="indexterm" id="id248"/>
<a data-primary="" data-startref="DJFtestclient04" data-type="indexterm" id="id249"/></p>
</div></aside>
<p>But now the moment of truth, will our functional tests pass?</p>
<pre data-type="programlisting">$ <strong>python functional_tests.py</strong>
[...]
======================================================================
FAIL: test_can_start_a_todo_list
(__main__.NewVisitorTest.test_can_start_a_todo_list)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...goat-book/functional_tests.py", line 21, in
test_can_start_a_todo_list
    self.fail("Finish the test!")
AssertionError: Finish the test!</pre>
<p>Failed? What? Oh, it’s just our little reminder? Yes? Yes! We have a web page!</p>
<p>Ahem.  Well, <em>I</em> thought it was a thrilling end to the chapter. You may still
be a little baffled, perhaps keen to hear a justification for all these tests,
and don’t worry, all that will come, but I hope you felt just a tinge of
excitement near the end there.</p>
<p>Just a little commit to calm down, and reflect on what we’ve covered:</p>
<pre data-type="programlisting">$ <strong>git diff</strong>  # should show our modified test in tests.py, and the new config in urls.py
$ <strong>git commit -am "url config, map / to home_page view"</strong></pre>
<p><a data-primary="" data-startref="DJFunit03" data-type="indexterm" id="id250"/>
<a data-primary="" data-startref="UTdjango03" data-type="indexterm" id="id251"/>
That was quite a chapter! Why not try typing <code>git log</code>, possibly using the
<code>--oneline</code> flag, for a reminder of what we got up to:</p>
<pre data-type="programlisting">$ <strong>git log --oneline</strong>
a6e6cc9 url config, map / to home_page view
450c0f3 First unit test and view function
ea2b037 Add app for lists, with deliberately failing unit test
[...]</pre>
<p>Not bad—​we covered:</p>
<ul>
<li>
<p>Starting a Django app</p>
</li>
<li>
<p>The Django unit test runner</p>
</li>
<li>
<p>The difference between functional-, and unit tests</p>
</li>
<li>
<p>Django view functions, request and response objects</p>
</li>
<li>
<p>Django URL resolving and <em>urls.py</em></p>
</li>
<li>
<p>The Django Test Client</p>
</li>
<li>
<p>And returning basic HTML from a view.</p>
</li>
</ul>
<aside class="pagebreak-before less_space" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id252">
<h1>Useful Commands and Concepts</h1><dl>
<dt>Running the Django dev server</dt>
<dd>
<p><strong><code>python manage.py runserver</code></strong>
<a data-primary="Django framework" data-secondary="commands and concepts" data-tertiary="python manage.py runserver" data-type="indexterm" id="id253"/></p>
</dd>
<dt>Running the functional tests</dt>
<dd>
<p><strong><code>python functional_tests.py</code></strong>
<a data-primary="Django framework" data-secondary="commands and concepts" data-tertiary="python functional_tests.py" data-type="indexterm" id="id254"/></p>
</dd>
<dt>Running the unit tests</dt>
<dd>
<p><strong><code>python manage.py test</code></strong>
<a data-primary="Django framework" data-secondary="commands and concepts" data-tertiary="python manage.py test" data-type="indexterm" id="id255"/></p>
</dd>
<dt>The unit-test/code cycle</dt>
<dd>
<ol>
<li>
<p>Run the unit tests in the terminal.</p>
</li>
<li>
<p>Make a minimal code change in the editor.</p>
</li>
<li>
<p>Repeat!
<a data-primary="Django framework" data-secondary="commands and concepts" data-tertiary="unit-test/code cycle" data-type="indexterm" id="id256"/>
<a data-primary="unit-test/code cycle" data-type="indexterm" id="id257"/></p>
</li>
</ol>
</dd>
</dl>
</div></aside>
</div></section>
</div></section></div></body></html>